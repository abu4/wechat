# åŸºäºOdoo 19çš„å¾®ä¿¡æ”¯ä»˜ä¸ç”Ÿæ€ç³»ç»Ÿé›†æˆé¡¹ç›®å¼€å‘è®¡åˆ’

## é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ—¨åœ¨ä¸ºOdoo 19å¼€å‘ä¸€å¥—å®Œæ•´çš„æ”¯ä»˜ä¸å¾®ä¿¡ç”Ÿæ€ç³»ç»Ÿé›†æˆè§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬å¾®ä¿¡æ”¯ä»˜ã€æ”¯ä»˜å®æ”¯ä»˜ã€äº‘é—ªä»˜æ”¯ä»˜ã€å¾®ä¿¡å…¬ä¼—å·ç®¡ç†å¹³å°å’Œå¾®ä¿¡å°ç¨‹åºåç«¯ã€‚é¡¹ç›®é‡‡ç”¨åˆ†é˜¶æ®µã€æ¨¡å—åŒ–å¼€å‘ç­–ç•¥ï¼Œç¡®ä¿å„åŠŸèƒ½æ¨¡å—å¯ç‹¬ç«‹éƒ¨ç½²ã€æµ‹è¯•å’Œç»´æŠ¤ã€‚

---

## ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ”¯ä»˜æ¨¡å—å¼€å‘ï¼ˆ1-6å‘¨ï¼‰

### **é‡Œç¨‹ç¢‘1ï¼šé¡¹ç›®åŸºç¡€è®¾æ–½æ­å»ºï¼ˆç¬¬1å‘¨ï¼‰**
**ç›®æ ‡**ï¼šå»ºç«‹å¼€å‘ç¯å¢ƒã€é¡¹ç›®ç»“æ„å’ŒåŸºç¡€æ¡†æ¶

**ä»»åŠ¡**ï¼š
1. **å¼€å‘ç¯å¢ƒé…ç½®**
   - æ­å»ºOdoo 19å¼€å‘ç¯å¢ƒï¼ˆDockeræˆ–æºç ï¼‰
   - é…ç½®å¼€å‘å·¥å…·é“¾ï¼ˆPython 3.10+, VS Code/IDEï¼ŒGitï¼‰
   - è®¾ç½®æ•°æ®åº“ï¼ˆPostgreSQL 14+ï¼‰
   - åˆ›å»ºé¡¹ç›®ä»£ç ä»“åº“ï¼ˆGitLab/GitHubï¼‰

2. **æ¨¡å—ç»“æ„è®¾è®¡**
   ```bash
   odoo19-payment-wechat/
   â”œâ”€â”€ payment_wechat/           # å¾®ä¿¡æ”¯ä»˜æ ¸å¿ƒæ¨¡å—
   â”œâ”€â”€ payment_alipay/          # æ”¯ä»˜å®æ”¯ä»˜æ¨¡å—
   â”œâ”€â”€ payment_unionpay/        # äº‘é—ªä»˜æ”¯ä»˜æ¨¡å—
   â”œâ”€â”€ wechat_common/           # å¾®ä¿¡å…¬å…±å·¥å…·æ¨¡å—
   â”œâ”€â”€ docs/                    # æ–‡æ¡£
   â”œâ”€â”€ tests/                   # æµ‹è¯•ç”¨ä¾‹
   â””â”€â”€ scripts/                 # éƒ¨ç½²è„šæœ¬
   ```

3. **æŠ€æœ¯é€‰å‹ä¸ä¾èµ–ç®¡ç†**
   - ç¡®å®šä¾èµ–åŒ…ï¼š`requests`ã€`cryptography`ã€`xmltodict`ã€`wechatpy`ï¼ˆè¯„ä¼°ï¼‰
   - é…ç½®`requirements.txt`å’Œ`odoo-addons.conf`

**äº¤ä»˜ç‰©**ï¼š
- å®Œæ•´çš„å¼€å‘ç¯å¢ƒ
- é¡¹ç›®ä»£ç ä»“åº“
- æŠ€æœ¯æ¶æ„æ–‡æ¡£
- å¼€å‘è§„èŒƒæ–‡æ¡£

---

### **é‡Œç¨‹ç¢‘2ï¼šå¾®ä¿¡æ”¯ä»˜æ¨¡å—åŸºç¡€åŠŸèƒ½ï¼ˆç¬¬2-4å‘¨ï¼‰**
**ç›®æ ‡**ï¼šå®ç°å¾®ä¿¡æ”¯ä»˜æ‰«ç æ”¯ä»˜ï¼ˆNativeï¼‰åŸºæœ¬åŠŸèƒ½

**ä»»åŠ¡**ï¼š
1. **æ ¸å¿ƒæ¨¡å‹è®¾è®¡**
   - `payment.provider.wechat`ï¼šå¾®ä¿¡æ”¯ä»˜æä¾›å•†æ¨¡å‹
   - `wechat.payment.config`ï¼šæ”¯ä»˜é…ç½®æ¨¡å‹
   - `wechat.payment.transaction`ï¼šæ”¯ä»˜äº¤æ˜“æ‰©å±•æ¨¡å‹

2. **æ”¯ä»˜æµç¨‹å®ç°**
   - ç»Ÿä¸€ä¸‹å•æ¥å£è°ƒç”¨
   - ç”Ÿæˆæ”¯ä»˜äºŒç»´ç ï¼ˆOWLç»„ä»¶ï¼‰
   - æ”¯ä»˜ç»“æœè½®è¯¢æœºåˆ¶
   - å¼‚æ­¥å›è°ƒå¤„ç†

3. **å®‰å…¨æœºåˆ¶**
   - APIv3ç­¾åéªŒè¯
   - è¯ä¹¦ç®¡ç†ï¼ˆè‡ªåŠ¨æ›´æ–°ï¼‰
   - å›è°ƒå®‰å…¨éªŒè¯

**ä»£ç ç¤ºä¾‹**ï¼ˆéƒ¨åˆ†ï¼‰ï¼š
```python
# models/payment_wechat.py
class PaymentProviderWechat(models.Model):
    _inherit = 'payment.provider'
    
    # å¾®ä¿¡ç‰¹æœ‰å­—æ®µ
    wechat_app_id = fields.Char(string='å…¬ä¼—å·AppID', help='å¾®ä¿¡å…¬ä¼—å·æˆ–å°ç¨‹åºAppID')
    wechat_mch_id = fields.Char(string='å•†æˆ·å·', required=True)
    wechat_api_v3_key = fields.Char(string='APIv3å¯†é’¥', required=True, groups='base.group_system')
    wechat_cert_path = fields.Char(string='è¯ä¹¦è·¯å¾„')
    wechat_payment_methods = fields.Selection([
        ('native', 'æ‰«ç æ”¯ä»˜'),
        ('jsapi', 'JSAPIæ”¯ä»˜'),
        ('miniprogram', 'å°ç¨‹åºæ”¯ä»˜')
    ], string='æ”¯æŒçš„æ”¯ä»˜æ–¹å¼', default='native', required=True)
    
    # æ²™ç®±ç¯å¢ƒæ”¯æŒ
    wechat_sandbox = fields.Boolean(string='æ²™ç®±æ¨¡å¼', default=False)
    wechat_sandbox_key = fields.Char(string='æ²™ç®±å¯†é’¥')
```

**äº¤ä»˜ç‰©**ï¼š
- `payment_wechat`æ¨¡å—v0.1
- å¾®ä¿¡æ‰«ç æ”¯ä»˜å®Œæ•´æµç¨‹
- æ”¯ä»˜æµ‹è¯•ç”¨ä¾‹
- APIæ–‡æ¡£

---

### **é‡Œç¨‹ç¢‘3ï¼šæ”¯ä»˜å®æ”¯ä»˜æ¨¡å—ï¼ˆç¬¬5-6å‘¨ï¼‰**
**ç›®æ ‡**ï¼šå®ç°æ”¯ä»˜å®å¿«é€Ÿç»“è´¦åŠŸèƒ½

**ä»»åŠ¡**ï¼š
1. **æ”¯ä»˜å®æ”¯ä»˜æä¾›å•†**
   - ç»§æ‰¿`payment.provider`æ¨¡å‹
   - å®ç°æ”¯ä»˜å®æ”¯ä»˜æ¥å£
   - æ”¯æŒæ”¯ä»˜å®æ‰«ç æ”¯ä»˜å’Œç½‘é¡µæ”¯ä»˜

2. **æ”¯ä»˜æµç¨‹é›†æˆ**
   - è·³è½¬æ”¯ä»˜å®æ”¶é“¶å°
   - å¼‚æ­¥å›è°ƒéªŒè¯
   - æ”¯ä»˜çŠ¶æ€åŒæ­¥

3. **é…ç½®ç•Œé¢**
   - å•†æˆ·é…ç½®è¡¨å•
   - æµ‹è¯•/ç”Ÿäº§ç¯å¢ƒåˆ‡æ¢
   - æ—¥å¿—æŸ¥çœ‹ç•Œé¢

**äº¤ä»˜ç‰©**ï¼š
- `payment_alipay`æ¨¡å—v0.1
- æ”¯ä»˜å®æ”¯ä»˜å®Œæ•´æµç¨‹
- é…ç½®ç®¡ç†ç•Œé¢
- é›†æˆæµ‹è¯•æŠ¥å‘Š

---

## ç¬¬äºŒé˜¶æ®µï¼šPOSæ”¯ä»˜ä¸æ”¯ä»˜ä¼˜åŒ–ï¼ˆ7-10å‘¨ï¼‰

### **é‡Œç¨‹ç¢‘4ï¼šPOSç«¯å¾®ä¿¡æ”¯ä»˜é›†æˆï¼ˆç¬¬7-8å‘¨ï¼‰**
**ç›®æ ‡**ï¼šåœ¨Odoo POSä¸­é›†æˆå¾®ä¿¡æ”¯ä»˜

**ä»»åŠ¡**ï¼š
1. **POSæ”¯ä»˜ç»ˆç«¯å¼€å‘**
   - åˆ›å»º`pos_payment_wechat`æ¨¡å—
   - é›†æˆOdoo POSæ”¯ä»˜ç»ˆç«¯API
   - æ”¯æŒä¸»æ‰«ï¼ˆé¡¾å®¢æ‰«å•†å®¶ï¼‰å’Œè¢«æ‰«ï¼ˆå•†å®¶æ‰«é¡¾å®¢ï¼‰æ¨¡å¼

2. **POSç•Œé¢é€‚é…**
   - OWLç»„ä»¶å¼€å‘æ”¯ä»˜æŒ‰é’®
   - æ”¯ä»˜çŠ¶æ€æ˜¾ç¤º
   - å°ç¥¨æ‰“å°ï¼ˆåŒ…å«æ”¯ä»˜ä¿¡æ¯ï¼‰

3. **ç¡¬ä»¶é€‚é…**
   - æ‰«ç æªé›†æˆ
   - æ”¶é“¶æœºé€‚é…
   - å¤šå±å¹•æ”¯æŒ

**äº¤ä»˜ç‰©**ï¼š
- `pos_payment_wechat`æ¨¡å—
- POSæ”¯ä»˜å®Œæ•´æµç¨‹
- ç¡¬ä»¶é€‚é…æŒ‡å—

---

### **é‡Œç¨‹ç¢‘5ï¼šPOSç«¯æ”¯ä»˜å®æ”¯ä»˜é›†æˆï¼ˆç¬¬9å‘¨ï¼‰**
**ç›®æ ‡**ï¼šåœ¨Odoo POSä¸­é›†æˆæ”¯ä»˜å®æ”¯ä»˜

**ä»»åŠ¡**ï¼š
1. **æ”¯ä»˜å®POSæ”¯ä»˜**
   - åˆ›å»º`pos_payment_alipay`æ¨¡å—
   - é›†æˆæ”¯ä»˜å®å½“é¢ä»˜æ¥å£
   - æ”¯æŒæ¡ç æ”¯ä»˜ã€æ‰«ç æ”¯ä»˜

2. **ç»Ÿä¸€æ”¯ä»˜ç®¡ç†**
   - æ”¯ä»˜æ–¹å¼é…ç½®ç•Œé¢
   - äº¤æ˜“è®°å½•æŸ¥çœ‹
   - æ—¥ç»“å¯¹è´¦

**äº¤ä»˜ç‰©**ï¼š
- `pos_payment_alipay`æ¨¡å—
- POSå¤šæ”¯ä»˜æ–¹å¼æ”¯æŒ
- æ”¯ä»˜å¯¹è´¦åŠŸèƒ½

---

### **é‡Œç¨‹ç¢‘6ï¼šæ”¯ä»˜æ¨¡å—ä¼˜åŒ–ä¸å®‰å…¨åŠ å›ºï¼ˆç¬¬10å‘¨ï¼‰**
**ç›®æ ‡**ï¼šæå‡æ”¯ä»˜æ¨¡å—çš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§

**ä»»åŠ¡**ï¼š
1. **æ€§èƒ½ä¼˜åŒ–**
   - æ”¯ä»˜è¯·æ±‚ç¼“å­˜
   - å¹¶å‘å¤„ç†ä¼˜åŒ–
   - æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

2. **å®‰å…¨åŠ å›º**
   - é˜²é‡æ”¾æ”»å‡»æœºåˆ¶
   - æ”¯ä»˜é¢‘ç‡é™åˆ¶
   - æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨

3. **ç›‘æ§ä¸æ—¥å¿—**
   - æ”¯ä»˜æˆåŠŸç‡ç›‘æ§
   - å¼‚å¸¸äº¤æ˜“å‘Šè­¦
   - è¯¦ç»†æ“ä½œæ—¥å¿—

**äº¤ä»˜ç‰©**ï¼š
- æ”¯ä»˜æ¨¡å—ä¼˜åŒ–ç‰ˆæœ¬
- å®‰å…¨å®¡è®¡æŠ¥å‘Š
- ç›‘æ§ä»ªè¡¨æ¿

---

## ç¬¬ä¸‰é˜¶æ®µï¼šå¾®ä¿¡å…¬ä¼—å·ç®¡ç†å¹³å°ï¼ˆ11-14å‘¨ï¼‰

### **é‡Œç¨‹ç¢‘7ï¼šå¾®ä¿¡åŸºç¡€æ¡†æ¶ï¼ˆç¬¬11å‘¨ï¼‰**
**ç›®æ ‡**ï¼šæ­å»ºå¾®ä¿¡å…¬ä¼—å·ç®¡ç†åŸºç¡€æ¡†æ¶

**ä»»åŠ¡**ï¼š
1. **åˆ›å»º`wechat_common`æ¨¡å—**
   - å¾®ä¿¡APIå®¢æˆ·ç«¯å°è£…
   - Access Tokenç®¡ç†ï¼ˆè‡ªåŠ¨åˆ·æ–°ï¼‰
   - æ¶ˆæ¯åŠ è§£å¯†å·¥å…·
   - é€šç”¨å·¥å…·å‡½æ•°

2. **å…¬ä¼—å·é…ç½®ç®¡ç†**
   - `wechat.account`æ¨¡å‹è®¾è®¡
   - å…¬ä¼—å·è®¾ç½®ç•Œé¢
   - æƒé™ç®¡ç†

**ä»£ç ç¤ºä¾‹**ï¼š
```python
# models/wechat_account.py
class WechatAccount(models.Model):
    _name = 'wechat.account'
    _description = 'å¾®ä¿¡å…¬ä¼—å·è´¦å·'
    
    name = fields.Char(string='å…¬ä¼—å·åç§°', required=True)
    app_id = fields.Char(string='AppID', required=True)
    app_secret = fields.Char(string='AppSecret', required=True, groups='base.group_system')
    account_type = fields.Selection([
        ('service', 'æœåŠ¡å·'),
        ('subscription', 'è®¢é˜…å·'),
        ('enterprise', 'ä¼ä¸šå·')
    ], string='è´¦å·ç±»å‹', required=True)
    
    # Tokenç®¡ç†
    access_token = fields.Char(string='Access Token')
    token_expires_at = fields.Datetime(string='Tokenè¿‡æœŸæ—¶é—´')
    jsapi_ticket = fields.Char(string='JSAPI Ticket')
    
    # æœåŠ¡å™¨é…ç½®
    server_url = fields.Char(string='æœåŠ¡å™¨åœ°å€', compute='_compute_server_url')
    token = fields.Char(string='ä»¤ç‰Œ(Token)', default=lambda self: self._generate_token())
    encoding_aes_key = fields.Char(string='æ¶ˆæ¯åŠ è§£å¯†å¯†é’¥')
    
    # çŠ¶æ€
    is_valid = fields.Boolean(string='é…ç½®æœ‰æ•ˆ', compute='_compute_is_valid')
    last_sync_time = fields.Datetime(string='æœ€ååŒæ­¥æ—¶é—´')
```

**äº¤ä»˜ç‰©**ï¼š
- `wechat_common`æ¨¡å—v1.0
- å¾®ä¿¡å…¬ä¼—å·é…ç½®ç®¡ç†
- APIå®¢æˆ·ç«¯åº“

---

### **é‡Œç¨‹ç¢‘8ï¼šç²‰ä¸ç®¡ç†ä¸æ¶ˆæ¯å¤„ç†ï¼ˆç¬¬12-13å‘¨ï¼‰**
**ç›®æ ‡**ï¼šå®ç°å…¬ä¼—å·ç²‰ä¸ç®¡ç†å’Œæ¶ˆæ¯å›å¤åŠŸèƒ½

**ä»»åŠ¡**ï¼š
1. **ç²‰ä¸ç®¡ç†**
   - ç²‰ä¸æ¨¡å‹è®¾è®¡ï¼ˆ`wechat.user`ï¼‰
   - ç²‰ä¸åŒæ­¥ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
   - æ ‡ç­¾ç®¡ç†
   - ç²‰ä¸åˆ†ç»„

2. **æ¶ˆæ¯ç®¡ç†**
   - æ¥æ”¶å¾®ä¿¡æ¶ˆæ¯ï¼ˆæ–‡æœ¬ã€å›¾ç‰‡ã€äº‹ä»¶ç­‰ï¼‰
   - è‡ªåŠ¨å›å¤è§„åˆ™å¼•æ“
   - æ¶ˆæ¯æ¨¡æ¿ç®¡ç†
   - å®¢æœæ¶ˆæ¯è½¬å‘

3. **èœå•ç®¡ç†**
   - è‡ªå®šä¹‰èœå•åˆ›å»º/æ›´æ–°
   - èœå•åŒæ­¥åˆ°å¾®ä¿¡
   - èœå•ç‚¹å‡»äº‹ä»¶å¤„ç†

**äº¤ä»˜ç‰©**ï¼š
- `wechat_platform`æ¨¡å—v0.5
- ç²‰ä¸ç®¡ç†åŠŸèƒ½
- æ¶ˆæ¯å¤„ç†å¼•æ“
- è‡ªå®šä¹‰èœå•ç®¡ç†

---

### **é‡Œç¨‹ç¢‘9ï¼šé«˜çº§åŠŸèƒ½ä¸Odooé›†æˆï¼ˆç¬¬14å‘¨ï¼‰**
**ç›®æ ‡**ï¼šå®ç°å…¬ä¼—å·é«˜çº§åŠŸèƒ½å¹¶ä¸Odooä¸šåŠ¡æ¨¡å—é›†æˆ

**ä»»åŠ¡**ï¼š
1. **ç´ æç®¡ç†**
   - å›¾ç‰‡ã€è¯­éŸ³ã€è§†é¢‘ç´ æä¸Šä¼ 
   - å›¾æ–‡æ¶ˆæ¯ç¼–è¾‘
   - ç´ æåŒæ­¥

2. **ä¸Odoo CRMé›†æˆ**
   - ç²‰ä¸è½¬ä¸ºCRMè”ç³»äºº
   - æ ‡ç­¾åŒæ­¥
   - å®¢æˆ·åˆ†ç»„

3. **æ•°æ®ç»Ÿè®¡**
   - ç²‰ä¸å¢é•¿ç»Ÿè®¡
   - æ¶ˆæ¯é‡ç»Ÿè®¡
   - ç”¨æˆ·è¡Œä¸ºåˆ†æ

**äº¤ä»˜ç‰©**ï¼š
- `wechat_platform`æ¨¡å—v1.0
- å®Œæ•´å…¬ä¼—å·ç®¡ç†åŠŸèƒ½
- Odooé›†æˆæ–¹æ¡ˆ
- æ•°æ®åˆ†ææŠ¥è¡¨

---

## ç¬¬å››é˜¶æ®µï¼šå¾®ä¿¡å°ç¨‹åºåç«¯ï¼ˆ15-18å‘¨ï¼‰

### **é‡Œç¨‹ç¢‘10ï¼šå°ç¨‹åºåŸºç¡€æ¡†æ¶ï¼ˆç¬¬15å‘¨ï¼‰**
**ç›®æ ‡**ï¼šæ­å»ºå¾®ä¿¡å°ç¨‹åºåç«¯åŸºç¡€æ¡†æ¶

**ä»»åŠ¡**ï¼š
1. **åˆ›å»º`wechat_miniprogram`æ¨¡å—**
   - å°ç¨‹åºé…ç½®ç®¡ç†
   - ç”¨æˆ·è®¤è¯æµç¨‹è®¾è®¡
   - APIè·¯ç”±è®¾è®¡

2. **ç”¨æˆ·è®¤è¯ç³»ç»Ÿ**
   - å°ç¨‹åºç™»å½•ï¼ˆcodeæ¢openidï¼‰
   - ç”¨æˆ·ä¼šè¯ç®¡ç†
   - UnionIDå…³è”æœºåˆ¶

3. **APIå®‰å…¨è®¾è®¡**
   - JWT Tokenè®¤è¯
   - APIç­¾åéªŒè¯
   - è¯·æ±‚é¢‘ç‡é™åˆ¶

**äº¤ä»˜ç‰©**ï¼š
- `wechat_miniprogram`æ¨¡å—v0.1
- ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
- APIåŸºç¡€æ¡†æ¶

---

### **é‡Œç¨‹ç¢‘11ï¼šå•†å“ä¸è®¢å•æ¥å£ï¼ˆç¬¬16-17å‘¨ï¼‰**
**ç›®æ ‡**ï¼šå®ç°å°ç¨‹åºå•†å“å±•ç¤ºå’Œä¸‹å•åŠŸèƒ½

**ä»»åŠ¡**ï¼š
1. **å•†å“æ¥å£**
   - å•†å“åˆ—è¡¨æ¥å£ï¼ˆåˆ†é¡µã€ç­›é€‰ã€æ’åºï¼‰
   - å•†å“è¯¦æƒ…æ¥å£
   - åˆ†ç±»ç›®å½•æ¥å£
   - æœç´¢åŠŸèƒ½

2. **è´­ç‰©è½¦åŠŸèƒ½**
   - è´­ç‰©è½¦ç®¡ç†æ¥å£
   - å•†å“åº“å­˜æ£€æŸ¥
   - ä»·æ ¼è®¡ç®—

3. **è®¢å•æ¥å£**
   - åˆ›å»ºè®¢å•
   - è®¢å•åˆ—è¡¨æŸ¥è¯¢
   - è®¢å•è¯¦æƒ…
   - è®¢å•çŠ¶æ€æ›´æ–°

**äº¤ä»˜ç‰©**ï¼š
- å°ç¨‹åºå®Œæ•´å•†å“API
- è´­ç‰©è½¦åŠŸèƒ½
- è®¢å•ç®¡ç†æ¥å£

---

### **é‡Œç¨‹ç¢‘12ï¼šæ”¯ä»˜ä¸ç”¨æˆ·ä¸­å¿ƒï¼ˆç¬¬18å‘¨ï¼‰**
**ç›®æ ‡**ï¼šå®Œæˆå°ç¨‹åºæ”¯ä»˜å’Œç”¨æˆ·ä¸­å¿ƒåŠŸèƒ½

**ä»»åŠ¡**ï¼š
1. **å°ç¨‹åºæ”¯ä»˜**
   - è°ƒèµ·å¾®ä¿¡æ”¯ä»˜
   - æ”¯ä»˜ç»“æœé€šçŸ¥
   - é€€æ¬¾åŠŸèƒ½

2. **ç”¨æˆ·ä¸­å¿ƒ**
   - ç”¨æˆ·ä¿¡æ¯ç®¡ç†
   - åœ°å€ç®¡ç†
   - ä¼˜æƒ åˆ¸/ç§¯åˆ†

3. **å®¢æœä¸å”®å**
   - å®¢æœæ¶ˆæ¯æ¥å…¥
   - å”®åç”³è¯·
   - ç‰©æµæŸ¥è¯¢

**äº¤ä»˜ç‰©**ï¼š
- `wechat_miniprogram`æ¨¡å—v1.0
- å°ç¨‹åºå®Œæ•´åç«¯API
- APIæ–‡æ¡£ï¼ˆSwagger/OpenAPIï¼‰

---

## ç¬¬äº”é˜¶æ®µï¼šäº‘é—ªä»˜ä¸ç»Ÿä¸€æ”¯ä»˜ç®¡ç†ï¼ˆ19-20å‘¨ï¼‰

### **é‡Œç¨‹ç¢‘13ï¼šäº‘é—ªä»˜æ”¯ä»˜æ¨¡å—ï¼ˆç¬¬19å‘¨ï¼‰**
**ç›®æ ‡**ï¼šå®ç°äº‘é—ªä»˜æ”¯ä»˜åŠŸèƒ½

**ä»»åŠ¡**ï¼š
1. **äº‘é—ªä»˜æ”¯ä»˜æä¾›å•†**
   - åˆ›å»º`payment_unionpay`æ¨¡å—
   - é›†æˆé“¶è”äº‘é—ªä»˜API
   - æ”¯æŒAPPæ”¯ä»˜ã€æ‰«ç æ”¯ä»˜

2. **é…ç½®ç®¡ç†**
   - å•†æˆ·é…ç½®
   - è¯ä¹¦ç®¡ç†
   - äº¤æ˜“æŸ¥è¯¢

3. **POSç«¯é›†æˆ**
   - POSç•Œé¢é€‚é…
   - æ”¯ä»˜æµç¨‹é›†æˆ

**äº¤ä»˜ç‰©**ï¼š
- `payment_unionpay`æ¨¡å—v1.0
- äº‘é—ªä»˜å®Œæ•´æ”¯ä»˜æµç¨‹
- POSç«¯æ”¯æŒ

---

### **é‡Œç¨‹ç¢‘14ï¼šç»Ÿä¸€æ”¯ä»˜ç®¡ç†å¹³å°ï¼ˆç¬¬20å‘¨ï¼‰**
**ç›®æ ‡**ï¼šåˆ›å»ºç»Ÿä¸€çš„æ”¯ä»˜é…ç½®å’Œç®¡ç†ç•Œé¢

**ä»»åŠ¡**ï¼š
1. **æ”¯ä»˜é…ç½®ä¸­å¿ƒ**
   - ç»Ÿä¸€æä¾›å•†é…ç½®ç•Œé¢
   - æ”¯ä»˜æ–¹å¼ç®¡ç†
   - è´¹ç‡é…ç½®

2. **äº¤æ˜“ç®¡ç†**
   - äº¤æ˜“è®°å½•æŸ¥è¯¢
   - é€€æ¬¾ç®¡ç†
   - å¯¹è´¦åŠŸèƒ½

3. **æ•°æ®åˆ†æ**
   - æ”¯ä»˜æˆåŠŸç‡ç»Ÿè®¡
   - æ¸ é“åˆ†æ
   - æ”¶å…¥æŠ¥è¡¨

**äº¤ä»˜ç‰©**ï¼š
- ç»Ÿä¸€æ”¯ä»˜ç®¡ç†å¹³å°
- å¯¹è´¦åŠŸèƒ½
- æ•°æ®åˆ†ææŠ¥è¡¨

---

## ç¬¬å…­é˜¶æ®µï¼šæµ‹è¯•ã€æ–‡æ¡£ä¸éƒ¨ç½²ï¼ˆ21-22å‘¨ï¼‰

### **é‡Œç¨‹ç¢‘15ï¼šå…¨é¢æµ‹è¯•ï¼ˆç¬¬21å‘¨ï¼‰**
**ç›®æ ‡**ï¼šå®Œæˆæ‰€æœ‰æ¨¡å—çš„æµ‹è¯•å·¥ä½œ

**ä»»åŠ¡**ï¼š
1. **å•å…ƒæµ‹è¯•**
   - æ¨¡å‹æµ‹è¯•
   - APIæµ‹è¯•
   - å·¥å…·å‡½æ•°æµ‹è¯•

2. **é›†æˆæµ‹è¯•**
   - æ”¯ä»˜æµç¨‹æµ‹è¯•
   - å¾®ä¿¡æ¶ˆæ¯æµ‹è¯•
   - å°ç¨‹åºAPIæµ‹è¯•

3. **æ€§èƒ½æµ‹è¯•**
   - å¹¶å‘æ”¯ä»˜æµ‹è¯•
   - APIå“åº”æ—¶é—´
   - ç³»ç»Ÿè´Ÿè½½æµ‹è¯•

**äº¤ä»˜ç‰©**ï¼š
- å®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹
- æµ‹è¯•æŠ¥å‘Š
- æ€§èƒ½ä¼˜åŒ–å»ºè®®

---

### **é‡Œç¨‹ç¢‘16ï¼šæ–‡æ¡£ä¸éƒ¨ç½²ï¼ˆç¬¬22å‘¨ï¼‰**
**ç›®æ ‡**ï¼šå®Œæˆé¡¹ç›®æ–‡æ¡£å’Œéƒ¨ç½²å‡†å¤‡

**ä»»åŠ¡**ï¼š
1. **æ–‡æ¡£ç¼–å†™**
   - ç”¨æˆ·æ‰‹å†Œ
   - å¼€å‘è€…æ–‡æ¡£
   - APIæ–‡æ¡£
   - éƒ¨ç½²æŒ‡å—

2. **éƒ¨ç½²åŒ…åˆ¶ä½œ**
   - æ¨¡å—æ‰“åŒ…
   - ä¾èµ–æ£€æŸ¥
   - å®‰è£…è„šæœ¬

3. **åŸ¹è®­ææ–™**
   - æ“ä½œè§†é¢‘
   - å¸¸è§é—®é¢˜è§£ç­”
   - æ•…éšœæ’é™¤æŒ‡å—

**äº¤ä»˜ç‰©**ï¼š
- å®Œæ•´é¡¹ç›®æ–‡æ¡£
- éƒ¨ç½²åŒ…
- åŸ¹è®­ææ–™

---

## å¼€å‘å›¢é˜Ÿè§’è‰²ä¸èŒè´£

### **æ ¸å¿ƒå¼€å‘å›¢é˜Ÿï¼ˆå»ºè®®é…ç½®ï¼‰**
| è§’è‰² | äººæ•° | ä¸»è¦èŒè´£ | æŠ€èƒ½è¦æ±‚ |
|------|------|----------|----------|
| **Odooåç«¯å¼€å‘** | 2-3äºº | æ”¯ä»˜æ¨¡å—ã€Odooé›†æˆã€ä¸šåŠ¡é€»è¾‘ | Python, Odooæ¡†æ¶, PostgreSQL |
| **å‰ç«¯å¼€å‘** | 1-2äºº | OWLç»„ä»¶ã€POSç•Œé¢ã€å°ç¨‹åºå‰ç«¯ | JavaScript, OWL, Vue.js/å°ç¨‹åº |
| **å¾®ä¿¡å¼€å‘ä¸“å®¶** | 1äºº | å¾®ä¿¡APIé›†æˆã€æ¶ˆæ¯å¤„ç†ã€å°ç¨‹åº | å¾®ä¿¡ç”Ÿæ€å¼€å‘ç»éªŒ |
| **æµ‹è¯•å·¥ç¨‹å¸ˆ** | 1äºº | æµ‹è¯•ç”¨ä¾‹ã€è‡ªåŠ¨åŒ–æµ‹è¯•ã€æ€§èƒ½æµ‹è¯• | Python, Selenium, æ€§èƒ½æµ‹è¯•å·¥å…· |
| **DevOps** | 1äºº | éƒ¨ç½²ã€ç›‘æ§ã€CI/CD | Docker, Linux, ç›‘æ§å·¥å…· |

---

## é£é™©ç®¡ç†ä¸ç¼“è§£æªæ–½

### **æŠ€æœ¯é£é™©**
| é£é™© | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£æªæ–½ |
|------|--------|------|----------|
| å¾®ä¿¡/æ”¯ä»˜å®APIå˜æ›´ | ä¸­ | é«˜ | 1. ä½¿ç”¨å®˜æ–¹SDK<br>2. è®¾è®¡é€‚é…å±‚<br>3. å®šæœŸæ›´æ–°æ£€æŸ¥ |
| Odoo 19å…¼å®¹æ€§é—®é¢˜ | ä½ | ä¸­ | 1. ç´§è·ŸOdooç¤¾åŒº<br>2. å®šæœŸå‡çº§æµ‹è¯•<br>3. æ¨¡å—åŒ–è®¾è®¡ |
| æ”¯ä»˜å®‰å…¨æ¼æ´ | ä½ | æé«˜ | 1. å®‰å…¨ç¼–ç è§„èŒƒ<br>2. å®šæœŸå®‰å…¨å®¡è®¡<br>3. æ¸—é€æµ‹è¯• |

### **é¡¹ç›®é£é™©**
| é£é™© | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£æªæ–½ |
|------|--------|------|----------|
| éœ€æ±‚å˜æ›´ | é«˜ | ä¸­ | 1. æ•æ·å¼€å‘<br>2. å®šæœŸæ²Ÿé€š<br>3. éœ€æ±‚ä¼˜å…ˆçº§ç®¡ç† |
| å¼€å‘å»¶æœŸ | ä¸­ | ä¸­ | 1. ä¸¤å‘¨è¿­ä»£<br>2. æ¯æ—¥ç«™ä¼š<br>3. å…³é”®è·¯å¾„ç›‘æ§ |
| äººå‘˜å˜åŠ¨ | ä½ | é«˜ | 1. ä»£ç è§„èŒƒ<br>2. æ–‡æ¡£å®Œå–„<br>3. çŸ¥è¯†å…±äº« |

---

## è´¨é‡ä¿è¯æªæ–½

### **ä»£ç è´¨é‡**
1. **ä»£ç å®¡æŸ¥**ï¼šæ‰€æœ‰ä»£ç å¿…é¡»ç»è¿‡åŒè¡Œè¯„å®¡
2. **ç¼–ç è§„èŒƒ**ï¼šéµå¾ªOdooç¼–ç è§„èŒƒã€PEP8
3. **è‡ªåŠ¨åŒ–æµ‹è¯•**ï¼šå•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
4. **æŒç»­é›†æˆ**ï¼šGitLab CI/CDæµæ°´çº¿

### **æ–‡æ¡£æ ‡å‡†**
1. **å†…è”æ–‡æ¡£**ï¼šæ‰€æœ‰å…³é”®å‡½æ•°å¿…é¡»æœ‰æ–‡æ¡£å­—ç¬¦ä¸²
2. **APIæ–‡æ¡£**ï¼šä½¿ç”¨OpenAPI/Swaggerè§„èŒƒ
3. **ç”¨æˆ·æ‰‹å†Œ**ï¼šæ­¥éª¤æˆªå›¾ã€æ“ä½œè¯´æ˜
4. **éƒ¨ç½²æ–‡æ¡£**ï¼šè¯¦ç»†éƒ¨ç½²æ­¥éª¤

---

## äº¤ä»˜ç‰©æ¸…å•

### **å¼€å‘é˜¶æ®µäº¤ä»˜ç‰©**
1. æºä»£ç ï¼ˆGitä»“åº“ï¼‰
2. æ•°æ®åº“è¿ç§»è„šæœ¬
3. é…ç½®æ–‡ä»¶æ¨¡æ¿
4. æµ‹è¯•æ•°æ®å’Œç”¨ä¾‹
5. APIæ–‡æ¡£

### **æœ€ç»ˆäº¤ä»˜ç‰©**
1. **æŠ€æœ¯æ–‡æ¡£**
   - ç³»ç»Ÿæ¶æ„è®¾è®¡æ–‡æ¡£
   - æ•°æ®åº“è®¾è®¡æ–‡æ¡£
   - APIæ¥å£æ–‡æ¡£
   - éƒ¨ç½²è¿ç»´æ‰‹å†Œ

2. **ç”¨æˆ·æ–‡æ¡£**
   - ç³»ç»Ÿç®¡ç†å‘˜æ‰‹å†Œ
   - ç»ˆç«¯ç”¨æˆ·æ“ä½œæŒ‡å—
   - POSæ”¶é“¶å‘˜æ‰‹å†Œ
   - å°ç¨‹åºä½¿ç”¨è¯´æ˜

3. **åŸ¹è®­ææ–™**
   - åŸ¹è®­PPT
   - æ“ä½œè§†é¢‘
   - å¸¸è§é—®é¢˜è§£ç­”

---

## åç»­ç»´æŠ¤ä¸æ”¯æŒè®¡åˆ’

### **ç»´æŠ¤é˜¶æ®µï¼ˆé¡¹ç›®å®Œæˆåï¼‰**
1. **bugä¿®å¤**ï¼šå“åº”æ—¶é—´24å°æ—¶å†…
2. **åŠŸèƒ½æ›´æ–°**ï¼šæ¯æœˆå°ç‰ˆæœ¬æ›´æ–°
3. **å®‰å…¨æ›´æ–°**ï¼šå‘ç°æ¼æ´72å°æ—¶å†…ä¿®å¤
4. **æŠ€æœ¯æ”¯æŒ**ï¼šæä¾›6ä¸ªæœˆå…è´¹æŠ€æœ¯æ”¯æŒ

### **å‡çº§è®¡åˆ’**
1. **Odooç‰ˆæœ¬å‡çº§**ï¼šæ”¯æŒå‡çº§åˆ°Odoo 20ï¼ˆå¦‚æœ‰éœ€è¦ï¼‰
2. **å¾®ä¿¡APIå‡çº§**ï¼šè·Ÿéšå¾®ä¿¡å®˜æ–¹APIæ›´æ–°
3. **åŠŸèƒ½æ‰©å±•**ï¼šæ ¹æ®ç”¨æˆ·åé¦ˆæŒç»­ä¼˜åŒ–

---

## é¡¹ç›®æˆåŠŸæ ‡å‡†

### **æŠ€æœ¯æ ‡å‡†**
1. æ‰€æœ‰æ¨¡å—é€šè¿‡Odooåº”ç”¨å•†åº—è´¨é‡è®¤è¯
2. æ”¯ä»˜æˆåŠŸç‡ > 99.5%
3. APIå“åº”æ—¶é—´ < 500msï¼ˆ95% percentileï¼‰
4. ç³»ç»Ÿå¯ç”¨æ€§ > 99.9%

### **ä¸šåŠ¡æ ‡å‡†**
1. æ”¯æŒè‡³å°‘1000å®¶å•†æˆ·åŒæ—¶ä½¿ç”¨
2. æ—¥å‡äº¤æ˜“å¤„ç†èƒ½åŠ› > 10ä¸‡ç¬”
3. ç”¨æˆ·æ»¡æ„åº¦ > 90%
4. åŸ¹è®­ææ–™å®Œæ•´åº¦100%

---

## æ€»ç»“

æœ¬å¼€å‘è®¡åˆ’é‡‡ç”¨**åˆ†é˜¶æ®µã€æ¨¡å—åŒ–**çš„ç­–ç•¥ï¼Œå°†å¤æ‚é¡¹ç›®åˆ†è§£ä¸ºå¯ç®¡ç†çš„é‡Œç¨‹ç¢‘ã€‚æ¯ä¸ªé˜¶æ®µéƒ½æœ‰æ˜ç¡®çš„ç›®æ ‡ã€ä»»åŠ¡å’Œäº¤ä»˜ç‰©ï¼Œä¾¿äºè¿›åº¦è·Ÿè¸ªå’Œè´¨é‡æ§åˆ¶ã€‚é€šè¿‡**ä¸¤å‘¨ä¸€ä¸ªè¿­ä»£**çš„æ•æ·å¼€å‘æ¨¡å¼ï¼Œç¡®ä¿é¡¹ç›®èƒ½å¤Ÿå¿«é€Ÿå“åº”å˜åŒ–ï¼ŒåŠæ—¶äº¤ä»˜ä»·å€¼ã€‚

**å…³é”®æˆåŠŸå› ç´ **ï¼š
1. **æ¨¡å—åŒ–è®¾è®¡**ï¼šå„æ¨¡å—å¯ç‹¬ç«‹å¼€å‘ã€æµ‹è¯•ã€éƒ¨ç½²
2. **æ¸è¿›å¼å¼€å‘**ï¼šä»æ ¸å¿ƒåŠŸèƒ½å¼€å§‹ï¼Œé€æ­¥æ‰©å±•
3. **ä¸¥æ ¼æµ‹è¯•**ï¼šç¡®ä¿æ”¯ä»˜ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§
4. **æ–‡æ¡£å®Œæ•´**ï¼šä¾¿äºåç»­ç»´æŠ¤å’Œå›¢é˜Ÿåä½œ

**æ€»å¼€å‘å‘¨æœŸ**ï¼š22å‘¨ï¼ˆçº¦5.5ä¸ªæœˆï¼‰
**æ€»æŠ•å…¥å·¥æ—¶**ï¼šçº¦1000-1200äººå¤©
**é¢„æœŸäº¤ä»˜**ï¼šå®Œæ•´çš„ä¼ä¸šçº§æ”¯ä»˜ä¸å¾®ä¿¡ç”Ÿæ€é›†æˆè§£å†³æ–¹æ¡ˆ

è¿™ä¸ªè®¡åˆ’å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œè°ƒæ•´ï¼Œå»ºè®®æ¯ä¸¤å‘¨è¿›è¡Œä¸€æ¬¡é¡¹ç›®è¯„å®¡ï¼Œè¯„ä¼°è¿›åº¦å¹¶è°ƒæ•´åç»­è®¡åˆ’ã€‚

æˆ‘å°†ç»“åˆ**[Pythonä¸“å®¶]**ä¸**[ç½‘ç»œä¸“å®¶]**çš„è§†è§’ï¼Œä¸ºæ‚¨æä¾›ä¸€ä»½åŸºäºOdoo 19å¼€å‘æ”¯ä»˜ä¸å¾®ä¿¡ç”Ÿæ€é›†æˆçš„è“å›¾ã€‚è¿™ä»½è§„åˆ’å°†æ•´åˆOdoo 19çš„æ–°ç‰¹æ€§ã€æ”¯ä»˜æ¶æ„ä¸å›½å†…ä¸»æµå¹³å°çš„é›†æˆéœ€æ±‚ã€‚

---

## 1. Odoo 19 æ ¸å¿ƒç‰¹æ€§ä¸æ”¯ä»˜æ¶æ„åˆ†æ

### 1.1 Odoo 19 å…³é”®æ–°ç‰¹æ€§
Odoo 19 åœ¨æŠ€æœ¯æ¶æ„ã€UI/UX åŠæ ¸å¿ƒä¸šåŠ¡æ¨¡å—ä¸Šå‡æœ‰æ˜¾è‘—æå‡ï¼Œè¿™äº›ç‰¹æ€§ä¸ºå¼€å‘ç°ä»£æ”¯ä»˜é›†æˆæ¨¡å—æä¾›äº†åšå®åŸºç¡€ï¼š

| é¢†åŸŸ | å…³é”®ç‰¹æ€§ï¼ˆå¯¹æ”¯ä»˜/å¾®ä¿¡å¼€å‘çš„å½±å“ï¼‰ |
|------|-----------------------------------|
| **å‰ç«¯æŠ€æœ¯** | **OWL (Odoo Web Library) æˆä¸ºé»˜è®¤å‰ç«¯æ¡†æ¶**ã€‚è¿™æ„å‘³ç€æ–°çš„æ”¯ä»˜é¡µé¢ã€å¾®ä¿¡ç®¡ç†ç•Œé¢åº”å½“é‡‡ç”¨ OWL ç»„ä»¶å¼€å‘ï¼Œè·å¾—æ›´å¥½çš„å“åº”å¼ã€å¯ç»´æŠ¤æ€§å’Œæ€§èƒ½[reference:0]ã€‚ |
| **æ€§èƒ½ä¼˜åŒ–** | **ç¼“å­˜æ•°æ®ã€ç¼“å­˜ç¿»è¯‘**ï¼Œæµè§ˆæœŸé—´è¯»å–çš„æ•°æ®ä¼šç¼“å­˜ï¼Œæå‡æ•´ä½“æµè§ˆé€Ÿåº¦[reference:1]ã€‚è¿™å¯¹æ”¯ä»˜å›è°ƒé¡µé¢ã€å¾®ä¿¡é¡µé¢åŠ è½½ä½“éªŒæœ‰ç›´æ¥å¸®åŠ©ã€‚ |
| **UI/UX æ”¹è¿›** | **æµåŠ¨è£…ç½®æŒ‰é’®**ã€**å®¢æˆ·æ–‡ä»¶ç« èŠ‚åŒ–**ã€**ç”˜ç‰¹å›¾æ™ºèƒ½ç¼©æ”¾**ç­‰æ”¹è¿›ï¼Œä½¿å¾—åœ¨ç§»åŠ¨ç«¯ï¼ˆå¾®ä¿¡å†…ï¼‰çš„æ“ä½œæ›´åŠ å‹å¥½[reference:2]ã€‚ |
| **æ”¯ä»˜ç›¸å…³** | **Twilio æ•´åˆ**ï¼ˆçŸ­ä¿¡å‘é€ï¼‰ã€**è¿æ¥ Gmail/Outlook** ç­‰é€šä¿¡å¢å¼ºï¼Œå¯ç”¨äºæ”¯ä»˜é€šçŸ¥ã€å¾®ä¿¡æ¶ˆæ¯æ¨¡æ¿å‘é€ç­‰åœºæ™¯[reference:3]ã€‚ |
| **å¼€å‘ä½“éªŒ** | **å¤§æ‰¹ç¼–è¾‘å¢æ¸›æ•°å€¼**ã€**HTML å±æ€§å­—æ®µç±»å‹**ã€**å¯¼å…¥ä»»ä½•æ–‡ä»¶æ ¼å¼**ç­‰ï¼Œæ–¹ä¾¿åå°é…ç½®æ”¯ä»˜å‚æ•°ã€æ‰¹é‡å¤„ç†é€€æ¬¾ç­‰æ“ä½œ[reference:4]ã€‚ |

### 1.2 Odoo æ”¯ä»˜æ¶æ„æ¦‚è§ˆ
Odoo çš„åœ¨çº¿æ”¯ä»˜ä½“ç³»ä»¥ `payment` æ¨¡å—ä¸ºæ ¸å¿ƒï¼Œé‡‡ç”¨ **æ”¯ä»˜æä¾›å•† (Payment Provider)** æ’ä»¶åŒ–è®¾è®¡[reference:5]ã€‚å…³é”®è¦ç‚¹ï¼š
- **å®‰å…¨åˆè§„**ï¼šæ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚å¡å·ï¼‰ä¸ç”± Odoo å­˜å‚¨ï¼Œå…¨éƒ¨å§”æ‰˜ç»™è®¤è¯çš„æ”¯ä»˜æä¾›å•†ï¼Œé¿å… PCI DSS åˆè§„è´Ÿæ‹…[reference:6]ã€‚
- **æµç¨‹ç»Ÿä¸€**ï¼šæ”¯ä»˜æµç¨‹åŒ…æ‹¬ **ä¸‹å• â†’ è·³è½¬/é‡å®šå‘ â†’ å›è°ƒ â†’ å¯¹è´¦**ï¼Œæ‰€æœ‰æä¾›å•†å‡éœ€å®ç°åŒä¸€å¥—æ¥å£ï¼ˆ`payment.acquirer` æ¨¡å‹ï¼‰ã€‚
- **æ”¯æŒå¤šç§æ”¯ä»˜æ–¹å¼**ï¼šæ¯ä¸ªæä¾›å•†å¯å…³è”å¤šç§æ”¯ä»˜æ–¹æ³•ï¼ˆå¦‚å¾®ä¿¡æ‰«ç ã€å¾®ä¿¡å†…æ”¯ä»˜ã€äº‘é—ªä»˜ç­‰ï¼‰ï¼Œå¹¶å¯åœ¨é…ç½®ä¸­æ¿€æ´»/ç¦ç”¨[reference:7]ã€‚
- **æµ‹è¯•æ¨¡å¼**ï¼šæä¾› **Demo payment provider**ï¼Œæ–¹ä¾¿æµ‹è¯•ä¸šåŠ¡æµè€Œä¸å½±å“çœŸå®äº¤æ˜“[reference:8]ã€‚

> **é‡è¦**ï¼šOdoo 19 çš„æ”¯ä»˜ API åœ¨è¾ƒæ—©ç‰ˆæœ¬ï¼ˆçº¦ Odoo 16ï¼‰å·²è¿›è¡Œè¿‡é‡æ„ï¼Œç°æœ‰æ¶æ„ç¨³å®šï¼Œå¼€å‘æ—¶åº”ç›´æ¥åŸºäº `payment` æ¨¡å—çš„ **æ–° API** è¿›è¡Œæ‰©å±•[reference:9]ã€‚

---

## 2. éœ€æ±‚ä¸åŠŸèƒ½æ¢³ç†

### 2.1 æ”¯ä»˜æ¨¡å—éœ€æ±‚
| æ¨¡å— | æ ¸å¿ƒéœ€æ±‚ | åŠŸèƒ½ç‚¹ |
|------|----------|--------|
| **å¾®ä¿¡æ”¯ä»˜** | æ”¯æŒç½‘ç«™æ‰«ç æ”¯ä»˜ï¼ˆNativeï¼‰ã€å¾®ä¿¡å†…æ”¯ä»˜ï¼ˆJSAPIï¼‰ã€å°ç¨‹åºæ”¯ä»˜ | 1. é…ç½®å•†æˆ·å·ã€APIv3 å¯†é’¥ã€è¯ä¹¦<br>2. ç”Ÿæˆæ”¯ä»˜äºŒç»´ç ï¼ˆå‰ç«¯ OWL ç»„ä»¶ï¼‰<br>3. å¤„ç†å¾®ä¿¡æ”¯ä»˜å›è°ƒï¼ˆéªŒè¯ç­¾åã€æ›´æ–°è®¢å•çŠ¶æ€ï¼‰<br>4. æ”¯æŒé€€æ¬¾ã€æŸ¥è¯¢è®¢å•ã€å…³é—­è®¢å•ç­‰ API<br>5. åœ¨ POS ç«¯é›†æˆå¾®ä¿¡æ”¯ä»˜ï¼ˆéœ€é€‚é… Odoo POS æ”¯ä»˜ç»ˆç«¯ï¼‰[reference:10] |
| **æ”¯ä»˜å®æ”¯ä»˜** | æ”¯æŒå¿«é€Ÿç»“è´¦ã€è·¨å¢ƒæ”¯ä»˜ã€æ‰«ç æ”¯ä»˜ | 1. é…ç½®å•†æˆ·å·ã€MD5 ç­¾åå¯†é’¥ã€å–å®¶é‚®ç®±<br>2. è·³è½¬æ”¯ä»˜å®æ”¶é“¶å°æˆ–ç”Ÿæˆæ‰«ç æ”¯ä»˜é¡µé¢<br>3. å¼‚æ­¥å›è°ƒå¤„ç†<br>4. é€€æ¬¾ã€æŸ¥è¯¢æ¥å£<br>5. POS ç«¯é›†æˆï¼ˆå·²æœ‰éƒ¨åˆ†ç¤¾åŒºæ¨¡å—å¯å‚è€ƒï¼‰[reference:11] |
| **äº‘é—ªä»˜** | æ”¯æŒé“¶è”äº‘é—ªä»˜ APP æ”¯ä»˜ã€æ‰«ç æ”¯ä»˜ | 1. é…ç½®é“¶è”å•†æˆ·å·ã€è¯ä¹¦<br>2. ç”Ÿæˆäº‘é—ªä»˜æ”¯ä»˜é“¾æ¥æˆ–äºŒç»´ç <br>3. å›è°ƒå¤„ç†<br>4. ä¸å¾®ä¿¡æ”¯ä»˜å…±ç”¨éƒ¨åˆ†é…ç½®ï¼ˆå¾®ä¿¡å•†æˆ·ä¸­å¿ƒå¯å¼€å¯äº‘é—ªä»˜ï¼‰[reference:12] |
| **ç»Ÿä¸€æ”¯ä»˜ç®¡ç†** | æä¾›ä¸€è‡´çš„é…ç½®ç•Œé¢ã€æ—¥å¿—æŸ¥çœ‹ã€å¯¹è´¦æ–‡ä»¶ä¸‹è½½ | 1. åœ¨ **ä¼šè®¡ â†’ é…ç½® â†’ æ”¯ä»˜æä¾›å•†** ä¸­æ·»åŠ ä¸‰ä¸ªæ–°çš„æä¾›å•†<br>2. æ”¯æŒ **æµ‹è¯•æ¨¡å¼**ï¼ˆæ²™ç®±ç¯å¢ƒï¼‰<br>3. æ”¯ä»˜æ—¥å¿—ï¼ˆ`payment.transaction`ï¼‰è¯¦ç»†è®°å½•<br>4. è‡ªåŠ¨å¯¹è´¦ï¼ˆé€šè¿‡é“¶è¡Œå¯¹è´¦å•å¯¼å…¥åŒ¹é…ï¼‰ |

### 2.2 å¾®ä¿¡å…¬ä¼—å·/å°ç¨‹åºç®¡ç†å¹³å°éœ€æ±‚
| æ¨¡å— | æ ¸å¿ƒéœ€æ±‚ | åŠŸèƒ½ç‚¹ |
|------|----------|--------|
| **å¾®ä¿¡å…¬ä¼—å·ç®¡ç†** | å¯¹æ¥å¾®ä¿¡å…¬ä¼—å¹³å° APIï¼Œå®ç°èœå•ç®¡ç†ã€æ¶ˆæ¯å›å¤ã€ç”¨æˆ·ç®¡ç†ã€ç´ æç®¡ç†ç­‰ | 1. é…ç½®å…¬ä¼—å· APPIDã€Secretã€Token<br>2. è‡ªåŠ¨åŒæ­¥ç²‰ä¸åˆ—è¡¨ã€æ ‡ç­¾<br>3. å…³é”®è¯è‡ªåŠ¨å›å¤ã€æ¶ˆæ¯æ¨¡æ¿å‘é€<br>4. èœå•åˆ›å»º/æ›´æ–°<br>5. ä¸ Odoo **CRM**ï¼ˆè”ç³»äººï¼‰ã€**å®¢æœ**ï¼ˆèŠå¤©ï¼‰æ¨¡å—é›†æˆ |
| **å¾®ä¿¡å°ç¨‹åº** | æä¾›å°ç¨‹åºåç«¯ APIï¼Œæ”¯æŒå•†å“å±•ç¤ºã€ä¸‹å•ã€æ”¯ä»˜ã€è®¢å•æŸ¥è¯¢ç­‰ | 1. å°ç¨‹åºç™»å½•ï¼ˆè·å– openid/unionidï¼‰<br>2. å•†å“ç›®å½•åŒæ­¥ï¼ˆä» Odoo äº§å“æ¨¡å—ï¼‰<br>3. ä¸‹å•æ¥å£ï¼ˆåˆ›å»ºé”€å”®è®¢å•ï¼‰<br>4. è°ƒç”¨å¾®ä¿¡æ”¯ä»˜ï¼ˆä½¿ç”¨åŒä¸€æ”¯ä»˜æ¨¡å—ï¼‰<br>5. è®¢å•åˆ—è¡¨ã€è¯¦æƒ…ã€ç‰©æµè·Ÿè¸ª<br>6. å®¢æœæ¶ˆæ¯ï¼ˆé€šè¿‡å¾®ä¿¡å®¢æœæ¥å£ï¼‰ |
| **ç»Ÿä¸€å¾®ä¿¡ç”Ÿæ€é›†æˆ** | å°†å…¬ä¼—å·ã€å°ç¨‹åºã€ä¼ä¸šå¾®ä¿¡ç­‰å…¥å£ç»Ÿä¸€ç®¡ç†ï¼Œæ•°æ®äº’é€š | 1. ç”¨æˆ·èº«ä»½ç»Ÿä¸€ï¼ˆé€šè¿‡ unionid å…³è”ï¼‰<br>2. æ¶ˆæ¯äº’é€šï¼ˆå…¬ä¼—å·æ¶ˆæ¯å¯è½¬è‡³ Odoo èŠå¤©ï¼‰<br>3. æ•°æ®ç»Ÿè®¡ï¼ˆç²‰ä¸å¢é•¿ã€æ¶ˆæ¯é‡ã€æ”¯ä»˜è½¬åŒ–ï¼‰ |

---

## 3. æŠ€æœ¯è“å›¾ä¸æ¨¡å—è®¾è®¡

### 3.1 æ¨¡å—åˆ’åˆ†
å»ºè®®å°†æ•´ä¸ªé¡¹ç›®æ‹†åˆ†ä¸ºä»¥ä¸‹ **6 ä¸ªæ ¸å¿ƒæ¨¡å—**ï¼Œä¾¿äºå›¢é˜Ÿåˆ†å·¥ä¸åç»­ç»´æŠ¤ï¼š

| æ¨¡å—åç§° | ä¾èµ– | ä¸»è¦èŒè´£ |
|----------|------|----------|
| `payment_wechat` | `payment` | å¾®ä¿¡æ”¯ä»˜æä¾›å•†å®ç°ï¼ŒåŒ…å« Nativeã€JSAPIã€å°ç¨‹åºæ”¯ä»˜ä¸‰ç§æ–¹å¼ã€‚ |
| `payment_alipay` | `payment` | æ”¯ä»˜å®æ”¯ä»˜æä¾›å•†å®ç°ï¼Œæ”¯æŒå¿«é€Ÿç»“è´¦ã€æ‰«ç æ”¯ä»˜ã€‚ |
| `payment_unionpay` | `payment` | äº‘é—ªä»˜æ”¯ä»˜æä¾›å•†å®ç°ï¼Œå¯ä¸å¾®ä¿¡æ”¯ä»˜æ¨¡å—å…±äº«éƒ¨åˆ†é…ç½®ã€‚ |
| `wechat_platform` | `web`, `mail` | å¾®ä¿¡å…¬ä¼—å·ç®¡ç†æ ¸å¿ƒï¼Œæä¾›èœå•ã€æ¶ˆæ¯ã€ç”¨æˆ·ç®¡ç†ç­‰åå°åŠŸèƒ½ã€‚ |
| `wechat_miniprogram` | `website_sale`, `payment_wechat` | å°ç¨‹åºåç«¯ APIï¼Œæä¾›å•†å“ã€è®¢å•ã€æ”¯ä»˜ç­‰æ¥å£ã€‚ |
| `wechat_common` | æ—  | å…¬å…±å·¥å…·ç±»ï¼šå¾®ä¿¡ API å®¢æˆ·ç«¯ã€ç­¾åéªŒè¯ã€Token ç®¡ç†ç­‰ã€‚ |

### 3.2 æ”¯ä»˜æ¨¡å—æŠ€æœ¯è®¾è®¡
#### 3.2.1 ç»§æ‰¿ `payment.provider` æ¨¡å‹
æ¯ä¸ªæ”¯ä»˜æä¾›å•†éƒ½åº”ç»§æ‰¿ `payment.provider`ï¼Œå¹¶å®ç°ä»¥ä¸‹æ ¸å¿ƒæ–¹æ³•ï¼š

```python
class PaymentProviderWechat(models.Model):
    _inherit = 'payment.provider'

    code = fields.Char(default='wechat')
    _provider_type = 'wechat'

    # å¾®ä¿¡ç‰¹æœ‰é…ç½®å­—æ®µ
    wechat_merchant_id = fields.Char(string='å•†æˆ·å·')
    wechat_api_v3_key = fields.Char(string='APIv3å¯†é’¥')
    wechat_certificate = fields.Binary(string='å•†æˆ·è¯ä¹¦')
    wechat_private_key = fields.Binary(string='ç§é’¥')

    def _get_supported_payment_methods(self):
        return [('native', 'å¾®ä¿¡æ‰«ç æ”¯ä»˜'), ('jsapi', 'å¾®ä¿¡å†…æ”¯ä»˜'), ('miniprogram', 'å°ç¨‹åºæ”¯ä»˜')]

    def _create_transaction_request(self, values):
        # è°ƒç”¨å¾®ä¿¡æ”¯ä»˜ç»Ÿä¸€ä¸‹å• API
        # è¿”å› {'redirect_url': ...} æˆ– {'qr_code': ...}
        pass

    def _handle_notification_data(self, data):
        # éªŒè¯å¾®ä¿¡å›è°ƒç­¾åï¼Œæ›´æ–°äº¤æ˜“çŠ¶æ€
        pass
```

#### 3.2.2 å‰ç«¯æ”¯ä»˜ç»„ä»¶ï¼ˆOWLï¼‰
- **æ‰«ç æ”¯ä»˜ç»„ä»¶**ï¼šåœ¨ Odoo ç½‘ç«™é¡µé¢ä¸­åµŒå…¥ä¸€ä¸ª OWL ç»„ä»¶ï¼Œç”¨äºæ˜¾ç¤ºäºŒç»´ç ã€è½®è¯¢æ”¯ä»˜ç»“æœã€‚
- **å¾®ä¿¡å†…æ”¯ä»˜**ï¼šé€šè¿‡ JSAPI è°ƒèµ·å¾®ä¿¡æ”¯ä»˜ï¼Œéœ€åœ¨ Odoo ç½‘é¡µä¸­æ³¨å…¥å¾®ä¿¡ SDKã€‚
- **POS æ”¯ä»˜ç»ˆç«¯**ï¼šåœ¨ Odoo POS ç•Œé¢ä¸­æ–°å¢å¾®ä¿¡æ”¯ä»˜ã€æ”¯ä»˜å®æ”¯ä»˜æŒ‰é’®ï¼Œé€šè¿‡ Odoo POS æ”¯ä»˜ç»ˆç«¯ API ä¸åç«¯é€šä¿¡ã€‚

#### 3.2.3 å®‰å…¨ä¸åˆè§„
- **ç»ä¸å­˜å‚¨æ•æ„Ÿä¿¡æ¯**ï¼šéµå¾ª Odoo æ”¯ä»˜æ¶æ„åŸåˆ™ï¼Œæ‰€æœ‰æ”¯ä»˜å¯†é’¥ã€è¯ä¹¦ä»…ç”¨äºç­¾åå’Œé€šä¿¡ï¼Œä¸å­˜å‚¨å¡å·ç­‰æ•°æ®[reference:13]ã€‚
- **å›è°ƒéªŒè¯**ï¼šå¾®ä¿¡/æ”¯ä»˜å®/äº‘é—ªä»˜çš„å›è°ƒå¿…é¡»éªŒè¯ç­¾åï¼Œé˜²æ­¢ä¼ªé€ è¯·æ±‚ã€‚
- **æµ‹è¯•æ¨¡å¼**ï¼šæ¯ä¸ªæä¾›å•†éƒ½åº”æ”¯æŒæ²™ç®±ç¯å¢ƒï¼Œæ–¹ä¾¿å¼€å‘æµ‹è¯•ã€‚

### 3.3 å¾®ä¿¡å…¬ä¼—å·/å°ç¨‹åºæ¨¡å—æŠ€æœ¯è®¾è®¡
#### 3.3.1 å¾®ä¿¡å…¬ä¼—å·ç®¡ç†
- **æ¨¡å‹è®¾è®¡**ï¼š`wechat.account`ï¼ˆå…¬ä¼—å·é…ç½®ï¼‰ã€`wechat.user`ï¼ˆç²‰ä¸ï¼‰ã€`wechat.menu`ï¼ˆèœå•ï¼‰ã€`wechat.message`ï¼ˆæ¶ˆæ¯è®°å½•ï¼‰ã€‚
- **è‡ªåŠ¨åŒæ­¥**ï¼šé€šè¿‡å®šæ—¶ä»»åŠ¡åŒæ­¥ç²‰ä¸åˆ—è¡¨ã€æ ‡ç­¾ã€‚
- **æ¶ˆæ¯å¤„ç†**ï¼šä½¿ç”¨ Odoo çš„ `mail.thread` æœºåˆ¶å°†å¾®ä¿¡æ¶ˆæ¯è½¬ä¸º Odoo èŠå¤©æ¶ˆæ¯ï¼Œå®ç°å®¢æœåå¸­ç»Ÿä¸€å›å¤ã€‚

#### 3.3.2 å°ç¨‹åºåç«¯ API
- **é‡‡ç”¨ Odoo çš„ JSON-RPC API**ï¼šä¸ºå°ç¨‹åºæä¾›è½»é‡çº§çš„ RESTful æ¥å£ï¼ˆå¯å€ŸåŠ© `website_sale` æ¨¡å—çš„ç°æœ‰ API è¿›è¡Œæ‰©å±•ï¼‰ã€‚
- **èº«ä»½éªŒè¯**ï¼šé€šè¿‡ `wx.login` è·å– codeï¼Œåç«¯ä½¿ç”¨ code æ¢å– openid/unionidï¼Œå¹¶ä¸ Odoo åˆä½œä¼™ä¼´ï¼ˆ`res.partner`ï¼‰å…³è”ã€‚
- **æ”¯ä»˜æµç¨‹**ï¼šå°ç¨‹åºè°ƒèµ·å¾®ä¿¡æ”¯ä»˜æ—¶ï¼Œä½¿ç”¨ `payment_wechat` æ¨¡å—ç”Ÿæˆæ”¯ä»˜å‚æ•°ï¼Œå®Œæˆæ”¯ä»˜åå›è°ƒæ›´æ–°è®¢å•çŠ¶æ€ã€‚

#### 3.3.3 ç»Ÿä¸€ç”¨æˆ·èº«ä»½
- é€šè¿‡ `unionid` å°†å…¬ä¼—å·ç²‰ä¸ã€å°ç¨‹åºç”¨æˆ·ã€ä¼ä¸šå¾®ä¿¡æˆå‘˜å…³è”åˆ°åŒä¸€ä¸ª Odoo åˆä½œä¼™ä¼´ã€‚
- åœ¨ `res.partner` ä¸­æ·»åŠ å­—æ®µ `wechat_unionid`ã€`wechat_openid`ã€`wechat_mp_openid` ç­‰ã€‚

### 3.4 éƒ¨ç½²ä¸é›†æˆæ¶æ„
```
Odoo 19 (æ ¸å¿ƒ + è‡ªå®šä¹‰æ¨¡å—)
    â”œâ”€â”€ æ”¯ä»˜æ¨¡å—ï¼ˆå¾®ä¿¡ã€æ”¯ä»˜å®ã€äº‘é—ªä»˜ï¼‰
    â”œâ”€â”€ å¾®ä¿¡å…¬ä¼—å·ç®¡ç†å¹³å°
    â”œâ”€â”€ å¾®ä¿¡å°ç¨‹åºåç«¯ API
    â””â”€â”€ å‰ç«¯ï¼ˆç½‘ç«™ã€POSã€ç§»åŠ¨ç«¯ï¼‰é€šè¿‡ OWL ç»„ä»¶é›†æˆ

ä¸å¤–éƒ¨ç³»ç»Ÿäº¤äº’ï¼š
    â”œâ”€â”€ å¾®ä¿¡æ”¯ä»˜ APIï¼ˆhttps://api.mch.weixin.qq.comï¼‰
    â”œâ”€â”€ æ”¯ä»˜å®å¼€æ”¾å¹³å° API
    â”œâ”€â”€ é“¶è”äº‘é—ªä»˜ API
    â””â”€â”€ å¾®ä¿¡å…¬ä¼—å¹³å° API
```

---

## 4. å®æ–½è·¯çº¿å›¾ä¸å»ºè®®

### 4.1 é˜¶æ®µè§„åˆ’
| é˜¶æ®µ | ç›®æ ‡ | é¢„è®¡æ—¶é—´ |
|------|------|----------|
| **ç¬¬ä¸€é˜¶æ®µ**ï¼ˆåŸºç¡€æ”¯ä»˜ï¼‰ | å®ç° `payment_wechat`ï¼ˆæ‰«ç æ”¯ä»˜ï¼‰ã€`payment_alipay`ï¼ˆå¿«é€Ÿç»“è´¦ï¼‰ä¸¤ä¸ªæä¾›å•†ï¼Œæ”¯æŒç½‘ç«™æ”¯ä»˜æµç¨‹ã€‚ | 4â€‘6 å‘¨ |
| **ç¬¬äºŒé˜¶æ®µ**ï¼ˆPOS æ”¯ä»˜ï¼‰ | åœ¨ Odoo POS ä¸­é›†æˆå¾®ä¿¡ã€æ”¯ä»˜å®æ”¯ä»˜ï¼Œé€‚é…ç¡¬ä»¶æ‰«ç æªã€‚ | 2â€‘3 å‘¨ |
| **ç¬¬ä¸‰é˜¶æ®µ**ï¼ˆå¾®ä¿¡å…¬ä¼—å·ï¼‰ | å¼€å‘ `wechat_platform` æ¨¡å—ï¼Œå®ç°èœå•ç®¡ç†ã€æ¶ˆæ¯å›å¤ã€ç”¨æˆ·åŒæ­¥ã€‚ | 3â€‘4 å‘¨ |
| **ç¬¬å››é˜¶æ®µ**ï¼ˆå°ç¨‹åºï¼‰ | å¼€å‘ `wechat_miniprogram` æ¨¡å—ï¼Œæä¾›å•†å“ã€è®¢å•ã€æ”¯ä»˜ç­‰ APIã€‚ | 4â€‘5 å‘¨ |
| **ç¬¬äº”é˜¶æ®µ**ï¼ˆäº‘é—ªä»˜ä¸ä¼˜åŒ–ï¼‰ | å®ç° `payment_unionpay`ï¼Œç»Ÿä¸€æ”¯ä»˜é…ç½®ç•Œé¢ï¼Œå¢åŠ é«˜çº§åŠŸèƒ½ï¼ˆé€€æ¬¾ã€å¯¹è´¦ï¼‰ã€‚ | 2â€‘3 å‘¨ |

### 4.2 å…³é”®é£é™©ä¸ç¼“è§£
| é£é™© | ç¼“è§£æªæ–½ |
|------|----------|
| **å¾®ä¿¡/æ”¯ä»˜å® API å˜æ›´** | ä½¿ç”¨å®˜æ–¹æœ€æ–°çš„ SDKï¼Œå°è£…é€‚é…å±‚ï¼Œä¾¿äºåç»­å‡çº§ã€‚ |
| **æ”¯ä»˜å®‰å…¨æ€§** | ä¸¥æ ¼éµå¾ª Odoo æ”¯ä»˜æ¶æ„ï¼Œä¸å­˜å‚¨æ•æ„Ÿä¿¡æ¯ï¼›å›è°ƒå¿…é¡»ç­¾åéªŒè¯ã€‚ |
| **æ€§èƒ½ç“¶é¢ˆ** | åˆ©ç”¨ Odoo 19 çš„ç¼“å­˜æœºåˆ¶ï¼Œå¯¹é¢‘ç¹è°ƒç”¨çš„æ¥å£ï¼ˆå¦‚æ”¯ä»˜ç»“æœæŸ¥è¯¢ï¼‰è¿›è¡Œç¼“å­˜ã€‚ |
| **å¤šç‰ˆæœ¬å…¼å®¹** | ç¡®ä¿æ¨¡å—å…¼å®¹ Odoo 19ï¼ˆæœ€ä½ï¼‰ï¼Œå¹¶å®šæœŸæµ‹è¯•æ–°ç‰ˆæœ¬ã€‚ |

### 4.3 æ¨èå‚è€ƒèµ„æ–™
- **Odoo 19 å®˜æ–¹æ–‡æ¡£**ï¼šåœ¨çº¿æ”¯ä»˜[reference:14]ã€å¼€å‘è€…æŒ‡å—ï¼ˆOWLã€APIï¼‰ã€‚
- **å¾®ä¿¡æ”¯ä»˜å¼€å‘æ–‡æ¡£**ï¼šhttps://pay.weixin.qq.com/wiki/doc/apiv3/index.shtml
- **æ”¯ä»˜å®å¼€æ”¾å¹³å°**ï¼šhttps://open.alipay.com/platform/home.htm
- **OCA/bank-payment é¡¹ç›®**ï¼šå‚è€ƒå…¶æ¨¡å—ç»“æ„ä¸ä»£ç ç»„ç»‡[reference:15]ã€‚
- **ç°æœ‰ Odoo å¾®ä¿¡æ¨¡å—**ï¼šå¦‚ Oejia_wx[reference:16]å¯æä¾›éƒ¨åˆ†å®ç°å‚è€ƒã€‚

---

## æ€»ç»“
åŸºäº Odoo 19 å¼€å‘å¾®ä¿¡æ”¯ä»˜ã€æ”¯ä»˜å®ã€äº‘é—ªä»˜æ¨¡å—ä»¥åŠå¾®ä¿¡å…¬ä¼—å·/å°ç¨‹åºç®¡ç†å¹³å°ï¼Œæ˜¯ä¸€é¡¹ç³»ç»Ÿæ€§å·¥ç¨‹ã€‚å»ºè®®é‡‡ç”¨**åˆ†é˜¶æ®µã€æ¨¡å—åŒ–**çš„å¼€å‘ç­–ç•¥ï¼Œå……åˆ†åˆ©ç”¨ Odoo 19 çš„æ–°ç‰¹æ€§ï¼ˆå¦‚ OWLã€ç¼“å­˜ä¼˜åŒ–ï¼‰å’Œæˆç†Ÿçš„æ”¯ä»˜æ¶æ„ï¼Œç¡®ä¿é¡¹ç›®åœ¨**å®‰å…¨ã€æ€§èƒ½ã€å¯ç»´æŠ¤æ€§**æ–¹é¢è¾¾åˆ°ä¼ä¸šçº§æ ‡å‡†ã€‚

# Odoo 19æ”¯ä»˜ä¸å¾®ä¿¡ç”Ÿæ€é›†æˆé¡¹ç›®å¯åŠ¨è®¡åˆ’

## ğŸš€ é¡¹ç›®æ­£å¼å¯åŠ¨

ä½œä¸º**Pythonä¸“å®¶(Odooæ¶æ„å¸ˆ)**ï¼Œæˆ‘å°†è°ƒåº¦åç«¯å¼€å‘ã€å‰ç«¯å¼€å‘ã€å¾®ä¿¡å¼€å‘ä¸“å®¶å¼€å§‹ç¬¬ä¸€é˜¶æ®µå·¥ä½œï¼Œå®‰å…¨å®¡æŸ¥ä¸“å®¶è´Ÿè´£æµ‹è¯•å’ŒDevOpså·¥ä½œã€‚

---

## ğŸ“‹ ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ”¯ä»˜æ¨¡å—å¼€å‘ï¼ˆç¬¬1-6å‘¨ï¼‰

### **ç¬¬1å‘¨ï¼šé¡¹ç›®åŸºç¡€è®¾æ–½æ­å»º**

#### **Pythonä¸“å®¶ï¼ˆé¡¹ç›®æ¶æ„å¸ˆï¼‰ä»»åŠ¡ï¼š**
1. **åˆ¶å®šè¯¦ç»†æŠ€æœ¯è§„èŒƒ**
   - åˆ›å»ºé¡¹ç›®æ¶æ„è®¾è®¡æ–‡æ¡£
   - å®šä¹‰APIæ¥å£è§„èŒƒ
   - åˆ¶å®šæ•°æ®åº“è®¾è®¡è§„èŒƒ
   - ç¡®å®šä»£ç è§„èŒƒæ ‡å‡†

2. **é¡¹ç›®åˆå§‹åŒ–**
   ```bash
   # é¡¹ç›®ç»“æ„åˆ›å»ºå‘½ä»¤
   mkdir odoo19-wechat-payment
   cd odoo19-wechat-payment
   
   # åˆ›å»ºæ¨¡å—ç»“æ„
   mkdir -p {payment_wechat,payment_alipay,payment_unionpay,wechat_common}/{models,controllers,views,security,tests,data,wizards,static/src/{js,xml}}
   mkdir -p {docs/{api,deployment,user},scripts,logs}
   
   # åˆå§‹åŒ–Gitä»“åº“
   git init
   git branch develop
   git checkout develop
   ```

#### **åç«¯å¼€å‘ä»»åŠ¡ï¼š**
1. **ç¯å¢ƒæ­å»º**
   ```bash
   # 1. ä½¿ç”¨Dockeræ­å»ºOdoo 19å¼€å‘ç¯å¢ƒ
   docker-compose -f docker-compose.dev.yml up -d
   
   # 2. åˆ›å»ºPythonè™šæ‹Ÿç¯å¢ƒ
   python3.10 -m venv venv
   source venv/bin/activate
   
   # 3. å®‰è£…åŸºç¡€ä¾èµ–
   pip install -r requirements-dev.txt
   ```

2. **åˆ›å»ºåŸºç¡€æ¨¡å—**
   - ç¼–å†™`__manifest__.py`æ–‡ä»¶æ¨¡æ¿
   - åˆ›å»ºåŸºç¡€æ¨¡å‹ç±»æ¨¡æ¿
   - è®¾ç½®æ¨¡å—ä¾èµ–å…³ç³»

3. **æ•°æ®åº“è®¾è®¡**
   - è®¾è®¡æ ¸å¿ƒæ•°æ®è¡¨ç»“æ„
   - åˆ›å»ºåˆå§‹åŒ–è„šæœ¬

**äº¤ä»˜ç‰©æ£€æŸ¥æ¸…å•**ï¼š
- [ ] Odoo 19å¼€å‘ç¯å¢ƒè¿è¡Œæ­£å¸¸
- [ ] PostgreSQLæ•°æ®åº“å·²é…ç½®
- [ ] Gitä»“åº“å·²å»ºç«‹å¹¶é…ç½®.gitignore
- [ ] åŸºç¡€æ¨¡å—ç»“æ„å·²åˆ›å»º

#### **å‰ç«¯å¼€å‘ä»»åŠ¡ï¼š**
1. **å‰ç«¯ç¯å¢ƒé…ç½®**
   ```bash
   # å®‰è£…Node.jsç¯å¢ƒ
   nvm install 18
   nvm use 18
   
   # å®‰è£…OWLå¼€å‘å·¥å…·
   npm install -g @odoo/owl
   npm install -g @odoo/owl-devtools
   
   # åˆ›å»ºå‰ç«¯ç»„ä»¶åº“
   mkdir frontend
   cd frontend
   npm init -y
   npm install @odoo/owl webpack webpack-cli
   ```

2. **åˆ›å»ºåŸºç¡€OWLç»„ä»¶**
   - åˆ›å»ºæ”¯ä»˜æŒ‰é’®ç»„ä»¶
   - åˆ›å»ºäºŒç»´ç æ˜¾ç¤ºç»„ä»¶
   - åˆ›å»ºæ”¯ä»˜çŠ¶æ€ç»„ä»¶

3. **æ ·å¼è®¾è®¡**
   - è®¾è®¡æ”¯ä»˜é¡µé¢æ ·å¼
   - åˆ›å»ºå“åº”å¼å¸ƒå±€
   - é€‚é…ç§»åŠ¨ç«¯

**äº¤ä»˜ç‰©æ£€æŸ¥æ¸…å•**ï¼š
- [ ] Node.jsç¯å¢ƒé…ç½®å®Œæˆ
- [ ] OWLå¼€å‘å·¥å…·å®‰è£…å®Œæˆ
- [ ] åŸºç¡€ç»„ä»¶æ¨¡æ¿åˆ›å»ºå®Œæˆ

#### **å¾®ä¿¡å¼€å‘ä¸“å®¶ä»»åŠ¡ï¼š**
1. **APIç ”ç©¶**
   - ç ”ç©¶å¾®ä¿¡æ”¯ä»˜V3 API
   - ç ”ç©¶æ”¯ä»˜å®å¼€æ”¾å¹³å°API
   - æ•´ç†APIè°ƒç”¨æµç¨‹å’Œç­¾åæœºåˆ¶

2. **SDKå°è£…è®¾è®¡**
   ```python
   # è®¾è®¡å¾®ä¿¡æ”¯ä»˜å®¢æˆ·ç«¯
   class WechatPayClient:
       """å¾®ä¿¡æ”¯ä»˜V3å®¢æˆ·ç«¯"""
       
       def __init__(self, mch_id, merchant_serial_no, private_key):
           self.mch_id = mch_id
           self.merchant_serial_no = merchant_serial_no
           self.private_key = private_key
           
       def create_order(self, order_data):
           """åˆ›å»ºæ”¯ä»˜è®¢å•"""
           pass
           
       def query_order(self, transaction_id):
           """æŸ¥è¯¢è®¢å•çŠ¶æ€"""
           pass
   ```

3. **è¯ä¹¦ç®¡ç†æ–¹æ¡ˆ**
   - è®¾è®¡è¯ä¹¦å­˜å‚¨æ–¹æ¡ˆ
   - è®¾è®¡è¯ä¹¦è‡ªåŠ¨æ›´æ–°æœºåˆ¶
   - è®¾è®¡å¯†é’¥å®‰å…¨ç®¡ç†æ–¹æ¡ˆ

**äº¤ä»˜ç‰©æ£€æŸ¥æ¸…å•**ï¼š
- [ ] APIæ–‡æ¡£æ•´ç†å®Œæˆ
- [ ] SDKè®¾è®¡æ–‡æ¡£å®Œæˆ
- [ ] è¯ä¹¦ç®¡ç†æ–¹æ¡ˆè®¾è®¡å®Œæˆ

#### **å®‰å…¨å®¡æŸ¥ä¸“å®¶ï¼ˆæµ‹è¯•/DevOpsï¼‰ä»»åŠ¡ï¼š**
1. **CI/CDæµæ°´çº¿æ­å»º**
   ```yaml
   # .gitlab-ci.yml æ¨¡æ¿
   stages:
     - test
     - build
     - deploy
   
   unit_test:
     stage: test
     script:
       - python -m pytest tests/unit --cov=.
   
   security_scan:
     stage: test
     script:
       - bandit -r . -f json -o bandit-report.json
       - safety check --json > safety-report.json
   ```

2. **å®‰å…¨åŸºçº¿é…ç½®**
   - é…ç½®ä»£ç å®‰å…¨æ‰«æ
   - è®¾ç½®ä¾èµ–å®‰å…¨æ£€æŸ¥
   - é…ç½®æ•æ„Ÿä¿¡æ¯æ£€æµ‹

3. **æµ‹è¯•ç¯å¢ƒæ­å»º**
   - æ­å»ºæµ‹è¯•æ•°æ®åº“
   - é…ç½®æµ‹è¯•æ•°æ®
   - è®¾ç½®è‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶

**äº¤ä»˜ç‰©æ£€æŸ¥æ¸…å•**ï¼š
- [ ] CI/CDæµæ°´çº¿é…ç½®å®Œæˆ
- [ ] ä»£ç å®‰å…¨æ‰«æå·¥å…·é…ç½®å®Œæˆ
- [ ] æµ‹è¯•ç¯å¢ƒæ­å»ºå®Œæˆ

---

### **ç¬¬2-4å‘¨ï¼šå¾®ä¿¡æ”¯ä»˜æ¨¡å—åŸºç¡€åŠŸèƒ½**

#### **Pythonä¸“å®¶è°ƒåº¦æŒ‡ä»¤ï¼š**
```
æœ¬å‘¨é‡ç‚¹ï¼šå®ç°å¾®ä¿¡æ”¯ä»˜æ‰«ç æ”¯ä»˜ï¼ˆNativeï¼‰æ ¸å¿ƒåŠŸèƒ½
å¼€å‘é¡ºåºï¼šåç«¯API â†’ å¾®ä¿¡SDK â†’ å‰ç«¯ç»„ä»¶ â†’ å®‰å…¨æµ‹è¯•
```

#### **åç«¯å¼€å‘å…·ä½“ä»»åŠ¡ï¼š**
**ç¬¬2å‘¨ï¼šæ¨¡å‹å±‚å¼€å‘**
```python
# ä»»åŠ¡1ï¼šåˆ›å»ºæ”¯ä»˜æä¾›å•†æ¨¡å‹
# file: payment_wechat/models/payment_wechat.py

from odoo import models, fields, api
import logging

_logger = logging.getLogger(__name__)

class PaymentProviderWechat(models.Model):
    """å¾®ä¿¡æ”¯ä»˜æä¾›å•†"""
    _inherit = 'payment.provider'
    
    code = fields.Char(default='wechat')
    _provider_type = 'wechat'
    
    # å¾®ä¿¡æ”¯ä»˜é…ç½®å­—æ®µ
    wechat_mch_id = fields.Char(
        string='å•†æˆ·å·',
        required=True,
        help='å¾®ä¿¡æ”¯ä»˜å•†æˆ·å·'
    )
    
    wechat_app_id = fields.Char(
        string='AppID',
        required=True,
        help='å…¬ä¼—å·æˆ–å°ç¨‹åºçš„AppID'
    )
    
    wechat_api_v3_key = fields.Char(
        string='APIv3å¯†é’¥',
        required=True,
        groups='base.group_system',
        help='å¾®ä¿¡æ”¯ä»˜APIv3å¯†é’¥'
    )
    
    wechat_merchant_serial_no = fields.Char(
        string='å•†æˆ·è¯ä¹¦åºåˆ—å·',
        help='å¾®ä¿¡æ”¯ä»˜å•†æˆ·è¯ä¹¦åºåˆ—å·'
    )
    
    # æ”¯ä»˜æ–¹å¼é…ç½®
    wechat_payment_methods = fields.Selection(
        selection=[
            ('native', 'æ‰«ç æ”¯ä»˜'),
            ('jsapi', 'JSAPIæ”¯ä»˜'),
            ('miniprogram', 'å°ç¨‹åºæ”¯ä»˜'),
        ],
        string='æ”¯æŒçš„æ”¯ä»˜æ–¹å¼',
        default='native'
    )
```

**ç¬¬3å‘¨ï¼šä¸šåŠ¡é€»è¾‘å±‚å¼€å‘**
```python
# ä»»åŠ¡2ï¼šå®ç°æ”¯ä»˜æµç¨‹æ§åˆ¶å™¨
# file: payment_wechat/controllers/main.py

from odoo import http
from odoo.http import request
import json

class WechatPaymentController(http.Controller):
    
    @http.route('/wechat/payment/create', type='json', auth='public')
    def create_payment(self, **kwargs):
        """åˆ›å»ºå¾®ä¿¡æ”¯ä»˜è®¢å•"""
        try:
            # éªŒè¯å‚æ•°
            order_id = kwargs.get('order_id')
            amount = kwargs.get('amount')
            
            if not order_id or not amount:
                return {'success': False, 'message': 'å‚æ•°é”™è¯¯'}
            
            # è°ƒç”¨å¾®ä¿¡æ”¯ä»˜API
            payment_data = {
                'out_trade_no': order_id,
                'total_fee': int(amount * 100),  # è½¬æ¢ä¸ºåˆ†
                'body': 'è®¢å•æ”¯ä»˜',
                'notify_url': request.httprequest.host_url + 'wechat/payment/notify'
            }
            
            # åˆ›å»ºæ”¯ä»˜äº¤æ˜“è®°å½•
            transaction = request.env['payment.transaction'].sudo().create({
                'reference': order_id,
                'amount': amount,
                'currency_id': request.env.ref('base.CNY').id,
                'provider_id': self._get_wechat_provider().id,
                'partner_id': kwargs.get('partner_id')
            })
            
            return {
                'success': True,
                'transaction_id': transaction.id,
                'qr_code_url': self._generate_qr_code(payment_data)
            }
            
        except Exception as e:
            _logger.error(f'åˆ›å»ºæ”¯ä»˜å¤±è´¥: {str(e)}')
            return {'success': False, 'message': str(e)}
```

**ç¬¬4å‘¨ï¼šæ”¯ä»˜å›è°ƒå¤„ç†**
```python
# ä»»åŠ¡3ï¼šå®ç°æ”¯ä»˜å›è°ƒå¤„ç†
# file: payment_wechat/controllers/notify.py

from odoo import http
from odoo.http import request
import hashlib
import time

class WechatNotifyController(http.Controller):
    
    @http.route('/wechat/payment/notify', type='http', auth='none', methods=['POST'], csrf=False)
    def payment_notify(self, **post):
        """å¾®ä¿¡æ”¯ä»˜å›è°ƒæ¥å£"""
        try:
            # éªŒè¯ç­¾å
            if not self._verify_signature(post):
                _logger.warning('å¾®ä¿¡æ”¯ä»˜å›è°ƒç­¾åéªŒè¯å¤±è´¥')
                return '<xml><return_code><![CDATA[FAIL]]></return_code></xml>'
            
            # è·å–äº¤æ˜“ä¿¡æ¯
            out_trade_no = post.get('out_trade_no')
            transaction_id = post.get('transaction_id')
            total_fee = int(post.get('total_fee', 0)) / 100  # è½¬æ¢ä¸ºå…ƒ
            
            # æ›´æ–°äº¤æ˜“çŠ¶æ€
            transaction = request.env['payment.transaction'].sudo().search([
                ('reference', '=', out_trade_no)
            ], limit=1)
            
            if transaction:
                transaction.write({
                    'state': 'done',
                    'date_validate': fields.Datetime.now(),
                    'acquirer_reference': transaction_id
                })
                
                # è§¦å‘æ”¯ä»˜æˆåŠŸäº‹ä»¶
                transaction._post_process_after_done()
            
            return '<xml><return_code><![CDATA[SUCCESS]]></return_code></xml>'
            
        except Exception as e:
            _logger.error(f'æ”¯ä»˜å›è°ƒå¤„ç†å¤±è´¥: {str(e)}')
            return '<xml><return_code><![CDATA[FAIL]]></return_code></xml>'
```

#### **å‰ç«¯å¼€å‘å…·ä½“ä»»åŠ¡ï¼š**
**ç¬¬2å‘¨ï¼šæ”¯ä»˜ç»„ä»¶å¼€å‘**
```javascript
// ä»»åŠ¡1ï¼šåˆ›å»ºå¾®ä¿¡æ”¯ä»˜OWLç»„ä»¶
// file: payment_wechat/static/src/js/components/WechatPayment.js

import { Component, useState } from "@odoo/owl";

export class WechatPayment extends Component {
    static template = "payment_wechat.WechatPayment";
    
    setup() {
        this.state = useState({
            qrCodeUrl: '',
            paymentStatus: 'pending', // pending, success, failed
            countdown: 300, // 5åˆ†é’Ÿå€’è®¡æ—¶
            timer: null
        });
        
        this.pollingInterval = null;
    }
    
    // ç”Ÿæˆæ”¯ä»˜äºŒç»´ç 
    async generateQRCode() {
        try {
            const response = await this.rpc('/wechat/payment/create', {
                order_id: this.props.orderId,
                amount: this.props.amount
            });
            
            if (response.success) {
                this.state.qrCodeUrl = response.qr_code_url;
                this.startPolling(response.transaction_id);
                this.startCountdown();
            }
        } catch (error) {
            console.error('ç”Ÿæˆæ”¯ä»˜äºŒç»´ç å¤±è´¥:', error);
        }
    }
    
    // è½®è¯¢æ”¯ä»˜çŠ¶æ€
    startPolling(transactionId) {
        this.pollingInterval = setInterval(async () => {
            const status = await this.checkPaymentStatus(transactionId);
            if (status === 'success') {
                this.onPaymentSuccess();
            }
        }, 3000); // æ¯3ç§’è½®è¯¢ä¸€æ¬¡
    }
    
    // å¼€å§‹å€’è®¡æ—¶
    startCountdown() {
        this.state.timer = setInterval(() => {
            if (this.state.countdown > 0) {
                this.state.countdown--;
            } else {
                this.onPaymentTimeout();
            }
        }, 1000);
    }
}
```

**ç¬¬3å‘¨ï¼šæ”¯ä»˜é¡µé¢é›†æˆ**
```xml
<!-- ä»»åŠ¡2ï¼šåˆ›å»ºæ”¯ä»˜é¡µé¢æ¨¡æ¿ -->
<!-- file: payment_wechat/views/templates.xml -->

<template id="payment_wechat_page" name="å¾®ä¿¡æ”¯ä»˜é¡µé¢">
    <t t-call="web.layout">
        <div class="container mt-5">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="mb-0">å¾®ä¿¡æ”¯ä»˜</h4>
                        </div>
                        <div class="card-body text-center">
                            <!-- æ”¯ä»˜äºŒç»´ç åŒºåŸŸ -->
                            <div id="qrcode-container" class="mb-4">
                                <WechatPayment 
                                    orderId="order.id" 
                                    amount="order.amount_total"
                                />
                            </div>
                            
                            <!-- æ”¯ä»˜è¯´æ˜ -->
                            <div class="alert alert-info">
                                <h5>æ”¯ä»˜è¯´æ˜</h5>
                                <ol class="text-left">
                                    <li>æ‰“å¼€å¾®ä¿¡ï¼Œç‚¹å‡»"æ‰«ä¸€æ‰«"</li>
                                    <li>æ‰«æä¸Šæ–¹äºŒç»´ç å®Œæˆæ”¯ä»˜</li>
                                    <li>æ”¯ä»˜æˆåŠŸåé¡µé¢å°†è‡ªåŠ¨è·³è½¬</li>
                                </ol>
                            </div>
                            
                            <!-- å€’è®¡æ—¶æ˜¾ç¤º -->
                            <div class="countdown-display">
                                å‰©ä½™æ”¯ä»˜æ—¶é—´: <span t-esc="countdown_display"/>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </t>
</template>
```

**ç¬¬4å‘¨ï¼šå“åº”å¼è®¾è®¡**
```css
/* ä»»åŠ¡3ï¼šæ”¯ä»˜é¡µé¢æ ·å¼è®¾è®¡ */
/* file: payment_wechat/static/src/css/payment_page.css */

/* ç§»åŠ¨ç«¯é€‚é… */
@media (max-width: 768px) {
    .payment-container {
        padding: 15px;
    }
    
    .qrcode-wrapper {
        max-width: 250px;
        margin: 0 auto;
    }
    
    .payment-instructions {
        font-size: 14px;
    }
}

/* æ”¯ä»˜çŠ¶æ€åŠ¨ç”» */
.payment-success {
    animation: successFadeIn 0.5s ease-in;
}

.payment-failed {
    animation: shake 0.5s ease-in-out;
}

@keyframes successFadeIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
}
```

#### **å¾®ä¿¡å¼€å‘ä¸“å®¶å…·ä½“ä»»åŠ¡ï¼š**
**ç¬¬2å‘¨ï¼šå¾®ä¿¡æ”¯ä»˜SDKå°è£…**
```python
# ä»»åŠ¡1ï¼šå°è£…å¾®ä¿¡æ”¯ä»˜V3 APIå®¢æˆ·ç«¯
# file: wechat_common/lib/wechat_pay_v3.py

import hashlib
import hmac
import json
import time
import base64
from datetime import datetime
from cryptography.hazmat.primitives import serialization
from cryptography.hazmat.primitives.asymmetric import padding
from cryptography.hazmat.primitives.hashes import SHA256

class WechatPayV3Client:
    """å¾®ä¿¡æ”¯ä»˜V3 APIå®¢æˆ·ç«¯"""
    
    def __init__(self, mch_id, merchant_serial_no, private_key_path, api_v3_key):
        self.mch_id = mch_id
        self.merchant_serial_no = merchant_serial_no
        self.api_v3_key = api_v3_key
        
        # åŠ è½½ç§é’¥
        with open(private_key_path, 'rb') as key_file:
            self.private_key = serialization.load_pem_private_key(
                key_file.read(),
                password=None
            )
    
    def create_signature(self, method, url, body='', timestamp=None, nonce_str=None):
        """ç”Ÿæˆå¾®ä¿¡æ”¯ä»˜V3ç­¾å"""
        if timestamp is None:
            timestamp = int(time.time())
        if nonce_str is None:
            nonce_str = self.generate_nonce()
        
        # æ„é€ ç­¾åå­—ç¬¦ä¸²
        message = f"{method}\n{url}\n{timestamp}\n{nonce_str}\n{body}\n"
        
        # ä½¿ç”¨ç§é’¥ç­¾å
        signature = self.private_key.sign(
            message.encode('utf-8'),
            padding.PKCS1v15(),
            SHA256()
        )
        
        # Base64ç¼–ç 
        signature_base64 = base64.b64encode(signature).decode('utf-8')
        
        return {
            'mchid': self.mch_id,
            'serial_no': self.merchant_serial_no,
            'timestamp': str(timestamp),
            'nonce_str': nonce_str,
            'signature': signature_base64,
            'auth_type': 'WECHATPAY2-SHA256-RSA2048'
        }
    
    def generate_nonce(self):
        """ç”Ÿæˆéšæœºå­—ç¬¦ä¸²"""
        import random
        import string
        return ''.join(random.choices(string.ascii_letters + string.digits, k=32))
    
    def verify_notify_signature(self, headers, body):
        """éªŒè¯å›è°ƒç­¾å"""
        # è·å–ç­¾åå¤´ä¿¡æ¯
        signature = headers.get('Wechatpay-Signature')
        timestamp = headers.get('Wechatpay-Timestamp')
        nonce = headers.get('Wechatpay-Nonce')
        serial_no = headers.get('Wechatpay-Serial')
        
        # æ„é€ éªŒè¯å­—ç¬¦ä¸²
        message = f"{timestamp}\n{nonce}\n{body}\n"
        
        # ä½¿ç”¨APIv3å¯†é’¥éªŒè¯
        expected_signature = base64.b64encode(
            hmac.new(
                self.api_v3_key.encode('utf-8'),
                message.encode('utf-8'),
                hashlib.sha256
            ).digest()
        ).decode('utf-8')
        
        return signature == expected_signature
```

**ç¬¬3å‘¨ï¼šæ”¯ä»˜APIé›†æˆ**
```python
# ä»»åŠ¡2ï¼šå®ç°å¾®ä¿¡æ”¯ä»˜æ ¸å¿ƒæ¥å£
# file: wechat_common/lib/wechat_pay_api.py

import requests
from .wechat_pay_v3 import WechatPayV3Client

class WechatPayAPI:
    """å¾®ä¿¡æ”¯ä»˜APIæ¥å£å°è£…"""
    
    # APIç«¯ç‚¹
    API_BASE = {
        'sandbox': 'https://api.mch.weixin.qq.com/v3/sandboxnew',
        'production': 'https://api.mch.weixin.qq.com/v3'
    }
    
    def __init__(self, client, sandbox=False):
        self.client = client
        self.base_url = self.API_BASE['sandbox' if sandbox else 'production']
    
    def native_order(self, order_data):
        """åˆ›å»ºNativeæ”¯ä»˜è®¢å•"""
        url = f"{self.base_url}/pay/transactions/native"
        
        # æ„é€ è¯·æ±‚æ•°æ®
        data = {
            "mchid": self.client.mch_id,
            "appid": order_data.get('appid'),
            "description": order_data.get('description', 'å•†å“æè¿°'),
            "out_trade_no": order_data.get('out_trade_no'),
            "time_expire": self._get_expire_time(),
            "notify_url": order_data.get('notify_url'),
            "amount": {
                "total": order_data.get('total'),
                "currency": "CNY"
            }
        }
        
        # æ·»åŠ åœºæ™¯ä¿¡æ¯ï¼ˆH5æ”¯ä»˜éœ€è¦ï¼‰
        if order_data.get('scene_info'):
            data['scene_info'] = order_data['scene_info']
        
        # ç”Ÿæˆç­¾å
        headers = self._create_headers('POST', url, json.dumps(data))
        
        # å‘é€è¯·æ±‚
        response = requests.post(url, json=data, headers=headers)
        
        if response.status_code == 200:
            result = response.json()
            return {
                'success': True,
                'code_url': result.get('code_url'),
                'prepay_id': result.get('prepay_id')
            }
        else:
            return {
                'success': False,
                'error_code': response.status_code,
                'error_msg': response.text
            }
    
    def query_order(self, transaction_id=None, out_trade_no=None):
        """æŸ¥è¯¢è®¢å•çŠ¶æ€"""
        if transaction_id:
            url = f"{self.base_url}/pay/transactions/id/{transaction_id}"
        else:
            url = f"{self.base_url}/pay/transactions/out-trade-no/{out_trade_no}"
        
        url = f"{url}?mchid={self.client.mch_id}"
        
        headers = self._create_headers('GET', url)
        response = requests.get(url, headers=headers)
        
        return response.json()
    
    def _create_headers(self, method, url, body=''):
        """åˆ›å»ºè¯·æ±‚å¤´"""
        auth_info = self.client.create_signature(method, url, body)
        
        return {
            'Authorization': f'WECHATPAY2-SHA256-RSA2048 {auth_info}',
            'Accept': 'application/json',
            'Content-Type': 'application/json',
            'User-Agent': 'Odoo-Wechat-Payment/1.0'
        }
    
    def _get_expire_time(self):
        """è·å–è®¢å•è¿‡æœŸæ—¶é—´ï¼ˆ30åˆ†é’Ÿåï¼‰"""
        from datetime import datetime, timedelta
        expire_time = datetime.now() + timedelta(minutes=30)
        return expire_time.strftime('%Y-%m-%dT%H:%M:%S+08:00')
```

**ç¬¬4å‘¨ï¼šè¯ä¹¦ç®¡ç†**
```python
# ä»»åŠ¡3ï¼šå®ç°è¯ä¹¦è‡ªåŠ¨æ›´æ–°æœºåˆ¶
# file: wechat_common/lib/cert_manager.py

import os
import tempfile
import requests
from datetime import datetime, timedelta
from cryptography import x509
from cryptography.hazmat.backends import default_backend

class CertificateManager:
    """å¾®ä¿¡æ”¯ä»˜è¯ä¹¦ç®¡ç†å™¨"""
    
    def __init__(self, cache_dir=None):
        self.cache_dir = cache_dir or os.path.join(tempfile.gettempdir(), 'wechat_certs')
        os.makedirs(self.cache_dir, exist_ok=True)
    
    def get_certificate(self, serial_no, force_update=False):
        """è·å–è¯ä¹¦"""
        cert_path = os.path.join(self.cache_dir, f'{serial_no}.pem')
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
        if not os.path.exists(cert_path) or force_update or self._is_cert_expired(cert_path):
            self._download_certificate(serial_no, cert_path)
        
        return cert_path
    
    def _download_certificate(self, serial_no, cert_path):
        """ä»å¾®ä¿¡æœåŠ¡å™¨ä¸‹è½½è¯ä¹¦"""
        url = "https://api.mch.weixin.qq.com/v3/certificates"
        
        # TODO: è¿™é‡Œéœ€è¦å®ç°å¾®ä¿¡æ”¯ä»˜ç­¾å
        headers = {
            'Accept': 'application/json',
            'User-Agent': 'Odoo-Wechat-Payment/1.0'
        }
        
        try:
            response = requests.get(url, headers=headers)
            if response.status_code == 200:
                cert_data = response.json()
                
                # è§£æè¯ä¹¦æ•°æ®
                for cert in cert_data.get('data', []):
                    if cert.get('serial_no') == serial_no:
                        encrypt_cert = cert.get('encrypt_certificate', {})
                        
                        # è§£å¯†è¯ä¹¦ï¼ˆå¦‚æœéœ€è¦ï¼‰
                        cert_content = self._decrypt_certificate(encrypt_cert)
                        
                        # ä¿å­˜è¯ä¹¦
                        with open(cert_path, 'w') as f:
                            f.write(cert_content)
                        
                        return True
        
        except Exception as e:
            print(f"ä¸‹è½½è¯ä¹¦å¤±è´¥: {e}")
        
        return False
    
    def _is_cert_expired(self, cert_path):
        """æ£€æŸ¥è¯ä¹¦æ˜¯å¦è¿‡æœŸ"""
        try:
            with open(cert_path, 'rb') as f:
                cert_data = f.read()
            
            cert = x509.load_pem_x509_certificate(cert_data, default_backend())
            not_after = cert.not_valid_after
            
            # å¦‚æœè¯ä¹¦åœ¨7å¤©å†…è¿‡æœŸï¼Œåˆ™éœ€è¦æ›´æ–°
            return datetime.now() + timedelta(days=7) > not_after
            
        except Exception:
            return True
    
    def _decrypt_certificate(self, encrypt_cert):
        """è§£å¯†è¯ä¹¦"""
        # TODO: å®ç°è¯ä¹¦è§£å¯†é€»è¾‘
        # å¾®ä¿¡æ”¯ä»˜V3è¯ä¹¦ä½¿ç”¨AEAD_AES_256_GCMç®—æ³•åŠ å¯†
        return encrypt_cert.get('ciphertext', '')
```

#### **å®‰å…¨å®¡æŸ¥ä¸“å®¶å…·ä½“ä»»åŠ¡ï¼š**
**ç¬¬2å‘¨ï¼šå®‰å…¨æµ‹è¯•æ¡†æ¶æ­å»º**
```python
# ä»»åŠ¡1ï¼šåˆ›å»ºå®‰å…¨æµ‹è¯•ç”¨ä¾‹
# file: tests/security/test_payment_security.py

import pytest
from unittest.mock import Mock, patch
from odoo.tests.common import TransactionCase
from odoo.exceptions import ValidationError

class TestPaymentSecurity(TransactionCase):
    """æ”¯ä»˜å®‰å…¨æµ‹è¯•"""
    
    def setUp(self):
        super(TestPaymentSecurity, self).setUp()
        self.payment_provider = self.env['payment.provider'].create({
            'name': 'å¾®ä¿¡æ”¯ä»˜æµ‹è¯•',
            'code': 'wechat',
            'state': 'test'
        })
    
    def test_api_key_encryption(self):
        """æµ‹è¯•APIå¯†é’¥åŠ å¯†å­˜å‚¨"""
        # è®¾ç½®APIå¯†é’¥
        api_key = 'test_api_key_123456'
        self.payment_provider.wechat_api_v3_key = api_key
        
        # éªŒè¯å¯†é’¥æ˜¯å¦åŠ å¯†å­˜å‚¨
        db_value = self.env.cr.execute(
            "SELECT wechat_api_v3_key FROM payment_provider WHERE id = %s",
            (self.payment_provider.id,)
        ).fetchone()[0]
        
        # å¯†é’¥åº”è¯¥è¢«åŠ å¯†ï¼Œä¸èƒ½æ˜¯æ˜æ–‡
        assert db_value != api_key
        assert 'test_api_key' not in db_value
    
    def test_callback_signature_verification(self):
        """æµ‹è¯•å›è°ƒç­¾åéªŒè¯"""
        with patch('payment_wechat.controllers.notify.WechatNotifyController._verify_signature') as mock_verify:
            mock_verify.return_value = False
            
            # æ¨¡æ‹Ÿæ¶æ„å›è°ƒè¯·æ±‚
            test_data = {
                'out_trade_no': 'test123',
                'transaction_id': 'fake_transaction',
                'total_fee': '100',
                'sign': 'invalid_signature'
            }
            
            # åº”è¯¥æ‹’ç»æ— æ•ˆç­¾åçš„è¯·æ±‚
            with pytest.raises(ValidationError):
                self.env['payment.transaction'].process_wechat_callback(test_data)
    
    def test_sql_injection_prevention(self):
        """æµ‹è¯•SQLæ³¨å…¥é˜²æŠ¤"""
        malicious_input = "test' OR '1'='1"
        
        # å°è¯•ä½¿ç”¨æ¶æ„è¾“å…¥
        with self.assertRaises(Exception) as context:
            transactions = self.env['payment.transaction'].search([
                ('reference', '=', malicious_input)
            ])
        
        # éªŒè¯ORMé˜²æŠ¤äº†SQLæ³¨å…¥
        # Odooçš„ORMåº”è¯¥è‡ªåŠ¨å¤„ç†å‚æ•°åŒ–æŸ¥è¯¢
```

**ç¬¬3å‘¨ï¼šè‡ªåŠ¨åŒ–å®‰å…¨æ‰«æ**
```yaml
# ä»»åŠ¡2ï¼šé…ç½®GitLab CIå®‰å…¨æ‰«æ
# file: .gitlab-ci.yml (å®‰å…¨æ‰«æéƒ¨åˆ†)

security_scan:
  stage: test
  image: python:3.10
  script:
    # 1. ä¾èµ–å®‰å…¨æ£€æŸ¥
    - pip install safety
    - safety check --json > safety-report.json
    
    # 2. ä»£ç å®‰å…¨æ‰«æ
    - pip install bandit
    - bandit -r . -f json -o bandit-report.json
    
    # 3. å¯†é’¥æ³„éœ²æ‰«æ
    - pip install truffleHog
    - trufflehog --regex --entropy=False --max_depth 50 . > trufflehog-report.txt
    
    # 4. ä¾èµ–æ¼æ´æ‰«æ
    - pip install pip-audit
    - pip-audit --format json --output pip-audit-report.json
    
  artifacts:
    when: always
    paths:
      - safety-report.json
      - bandit-report.json
      - trufflehog-report.txt
      - pip-audit-report.json
    expire_in: 1 week
```

**ç¬¬4å‘¨ï¼šæ”¯ä»˜å®‰å…¨æµ‹è¯•**
```python
# ä»»åŠ¡3ï¼šæ”¯ä»˜æµç¨‹å®‰å…¨æµ‹è¯•
# file: tests/integration/test_payment_flow.py

import pytest
from odoo.tests import tagged, HttpCase
import json

@tagged('post_install', '-at_install', 'payment_security')
class TestPaymentFlowSecurity(HttpCase):
    """æ”¯ä»˜æµç¨‹å®‰å…¨æµ‹è¯•"""
    
    def test_payment_request_validation(self):
        """æµ‹è¯•æ”¯ä»˜è¯·æ±‚å‚æ•°éªŒè¯"""
        # æµ‹è¯•ç¼ºå°‘å¿…è¦å‚æ•°
        response = self.url_open('/wechat/payment/create', data=json.dumps({}))
        result = json.loads(response.content)
        assert result['success'] is False
        assert 'å‚æ•°é”™è¯¯' in result['message']
        
        # æµ‹è¯•é‡‘é¢ä¸ºè´Ÿæ•°
        response = self.url_open('/wechat/payment/create', data=json.dumps({
            'order_id': 'test123',
            'amount': -100
        }))
        result = json.loads(response.content)
        assert result['success'] is False
        
        # æµ‹è¯•é‡‘é¢è¿‡å¤§
        response = self.url_open('/wechat/payment/create', data=json.dumps({
            'order_id': 'test123',
            'amount': 1000000  # 100ä¸‡
        }))
        result = json.loads(response.content)
        # åº”è¯¥æœ‰é‡‘é¢é™åˆ¶éªŒè¯
    
    def test_payment_replay_attack(self):
        """æµ‹è¯•é‡æ”¾æ”»å‡»é˜²æŠ¤"""
        # æ¨¡æ‹Ÿé‡æ”¾æ”»å‡»
        payment_data = {
            'order_id': 'order_123',
            'amount': 100.00
        }
        
        # ç¬¬ä¸€æ¬¡è¯·æ±‚
        response1 = self.url_open('/wechat/payment/create', 
                                data=json.dumps(payment_data))
        result1 = json.loads(response1.content)
        
        # ç«‹å³é‡æ”¾ç›¸åŒçš„è¯·æ±‚
        response2 = self.url_open('/wechat/payment/create',
                                data=json.dumps(payment_data))
        result2 = json.loads(response2.content)
        
        # åº”è¯¥æ‹’ç»é‡æ”¾è¯·æ±‚æˆ–è¿”å›ç›¸åŒçš„äº¤æ˜“ID
        # è¿™å–å†³äºä¸šåŠ¡é€»è¾‘è®¾è®¡
    
    def test_xss_protection(self):
        """æµ‹è¯•XSSé˜²æŠ¤"""
        malicious_script = '<script>alert("xss")</script>'
        
        # å°è¯•æ³¨å…¥æ¶æ„è„šæœ¬
        response = self.url_open('/wechat/payment/create', data=json.dumps({
            'order_id': malicious_script,
            'amount': 100
        }))
        
        # éªŒè¯å“åº”ä¸­ä¸åŒ…å«æœªè½¬ä¹‰çš„è„šæœ¬
        content = response.content.decode('utf-8')
        assert '<script>' not in content
        assert '&lt;script&gt;' in content  # åº”è¯¥è¢«è½¬ä¹‰
```

---

### **ç¬¬5-6å‘¨ï¼šæ”¯ä»˜å®æ”¯ä»˜æ¨¡å—å¼€å‘**

#### **Pythonä¸“å®¶è°ƒåº¦æŒ‡ä»¤ï¼š**
```
æœ¬å‘¨é‡ç‚¹ï¼šå®ç°æ”¯ä»˜å®æ”¯ä»˜æ¨¡å—ï¼Œé‡ç‚¹å®Œæˆå¿«é€Ÿç»“è´¦å’Œæ‰«ç æ”¯ä»˜
æ³¨æ„ï¼šéœ€è¦å¤„ç†æ”¯ä»˜å®å›è°ƒçš„åŒæ­¥å’Œå¼‚æ­¥é€šçŸ¥
```

#### **åç«¯å¼€å‘å…·ä½“ä»»åŠ¡ï¼š**
```python
# ä»»åŠ¡ï¼šæ”¯ä»˜å®æ”¯ä»˜æä¾›å•†å®ç°
# file: payment_alipay/models/payment_alipay.py

from odoo import models, fields, api, _
import hashlib
import urllib.parse
import json
import time

class PaymentProviderAlipay(models.Model):
    """æ”¯ä»˜å®æ”¯ä»˜æä¾›å•†"""
    _inherit = 'payment.provider'
    
    code = fields.Char(default='alipay')
    _provider_type = 'alipay'
    
    # æ”¯ä»˜å®é…ç½®
    alipay_app_id = fields.Char(string='åº”ç”¨ID', required=True)
    alipay_merchant_id = fields.Char(string='å•†æˆ·å·')
    alipay_private_key = fields.Text(string='åº”ç”¨ç§é’¥', groups='base.group_system')
    alipay_public_key = fields.Text(string='æ”¯ä»˜å®å…¬é’¥', groups='base.group_system')
    
    # æ”¯ä»˜æ–¹å¼
    alipay_payment_method = fields.Selection([
        ('quickpay', 'å¿«é€Ÿç»“è´¦'),
        ('scan', 'æ‰«ç æ”¯ä»˜'),
        ('wap', 'æ‰‹æœºç½‘ç«™æ”¯ä»˜')
    ], string='æ”¯ä»˜æ–¹å¼', default='quickpay')
    
    def _get_alipay_client(self):
        """è·å–æ”¯ä»˜å®å®¢æˆ·ç«¯"""
        from alipay import AliPay
        
        alipay = AliPay(
            appid=self.alipay_app_id,
            app_notify_url=self._get_notify_url(),
            app_private_key_string=self.alipay_private_key,
            alipay_public_key_string=self.alipay_public_key,
            sign_type="RSA2",
            debug=self.state == 'test'  # æµ‹è¯•æ¨¡å¼
        )
        
        return alipay
    
    def _create_payment_data(self, transaction):
        """åˆ›å»ºæ”¯ä»˜æ•°æ®"""
        alipay = self._get_alipay_client()
        
        # æ„é€ è®¢å•æ•°æ®
        order_string = alipay.api_alipay_trade_page_pay(
            out_trade_no=transaction.reference,
            total_amount=str(transaction.amount),
            subject=f"è®¢å•æ”¯ä»˜-{transaction.reference}",
            return_url=self._get_return_url(transaction),
            notify_url=self._get_notify_url()
        )
        
        # ç”Ÿæˆæ”¯ä»˜URL
        if self.state == 'test':
            gateway = "https://openapi.alipaydev.com/gateway.do"
        else:
            gateway = "https://openapi.alipay.com/gateway.do"
        
        payment_url = f"{gateway}?{order_string}"
        
        return {
            'payment_url': payment_url,
            'method': 'redirect',
            'data': order_string
        }
    
    def _verify_notification(self, data):
        """éªŒè¯æ”¯ä»˜å®å›è°ƒ"""
        alipay = self._get_alipay_client()
        
        # éªŒè¯ç­¾å
        signature = data.pop('sign', None)
        sign_type = data.pop('sign_type', 'RSA2')
        
        return alipay.verify(data, signature)
```

---

## ğŸ“Š è¿›åº¦è·Ÿè¸ªä¸é£é™©ç®¡ç†

### **æ¯æ—¥ç«™ä¼šå®‰æ’**
```
æ—¶é—´ï¼šæ¯å¤©ä¸Šåˆ9:30
åœ°ç‚¹ï¼šTeamsä¼šè®®
æ—¶é•¿ï¼š15åˆ†é’Ÿ
è®®ç¨‹ï¼š
1. æ˜¨æ—¥å®Œæˆæƒ…å†µï¼ˆæ¯äºº1åˆ†é’Ÿï¼‰
2. ä»Šæ—¥è®¡åˆ’ï¼ˆæ¯äºº1åˆ†é’Ÿï¼‰
3. é‡åˆ°çš„é˜»ç¢ï¼ˆéœ€è¦åè°ƒçš„é—®é¢˜ï¼‰
4. Pythonä¸“å®¶åè°ƒä¸å»ºè®®
```

### **æ¯å‘¨è¿­ä»£ä¼šè®®**
```
æ—¶é—´ï¼šæ¯å‘¨äº”ä¸‹åˆ3:00
æ—¶é•¿ï¼š1å°æ—¶
è®®ç¨‹ï¼š
1. æœ¬å‘¨å·¥ä½œå›é¡¾ï¼ˆå„è§’è‰²æ±‡æŠ¥ï¼‰
2. æ¼”ç¤ºæœ¬å‘¨æˆæœ
3. ä¸‹å‘¨è®¡åˆ’å®‰æ’
4. é£é™©è¯†åˆ«ä¸åº”å¯¹
5. æŠ€æœ¯éš¾é¢˜è®¨è®º
```

### **é£é™©ç®¡ç†è¡¨**

| é£é™©ç±»åˆ« | å…·ä½“é£é™© | å½±å“ | æ¦‚ç‡ | åº”å¯¹æªæ–½ | è´Ÿè´£äºº |
|---------|----------|------|------|----------|--------|
| æŠ€æœ¯é£é™© | å¾®ä¿¡APIå˜æ›´ | é«˜ | ä¸­ | 1. ä½¿ç”¨å®˜æ–¹SDK 2. è®¾è®¡é€‚é…å±‚ 3. å®šæœŸæ£€æŸ¥æ›´æ–° | å¾®ä¿¡ä¸“å®¶ |
| å®‰å…¨é£é™© | æ”¯ä»˜å›è°ƒè¢«æ”»å‡» | æé«˜ | ä½ | 1. ä¸¥æ ¼ç­¾åéªŒè¯ 2. é˜²é‡æ”¾æœºåˆ¶ 3. ç›‘æ§å¼‚å¸¸è¯·æ±‚ | å®‰å…¨ä¸“å®¶ |
| è¿›åº¦é£é™© | æ¨¡å—ä¾èµ–å†²çª | ä¸­ | ä¸­ | 1. æ˜ç¡®æ¥å£è§„èŒƒ 2. å¹¶è¡Œå¼€å‘ 3. åŠæ—¶æ²Ÿé€š | Pythonä¸“å®¶ |
| è´¨é‡é£é™© | æµ‹è¯•è¦†ç›–ä¸è¶³ | ä¸­ | ä¸­ | 1. æµ‹è¯•é©±åŠ¨å¼€å‘ 2. è‡ªåŠ¨åŒ–æµ‹è¯• 3. ä»£ç å®¡æŸ¥ | å®‰å…¨ä¸“å®¶ |

---

## ğŸ“ˆ äº¤ä»˜ç‰©æ£€æŸ¥ç‚¹ï¼ˆç¬¬4å‘¨æœ«ï¼‰

### **åç«¯å¼€å‘äº¤ä»˜ç‰©æ£€æŸ¥**ï¼š
- [ ] `payment_wechat`æ¨¡å—åŸºç¡€åŠŸèƒ½å®Œæˆ
- [ ] å¾®ä¿¡æ”¯ä»˜æµç¨‹å®Œæ•´å®ç°
- [ ] å›è°ƒå¤„ç†å®‰å…¨éªŒè¯
- [ ] æ•°æ®åº“è¿ç§»è„šæœ¬
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 70%

### **å‰ç«¯å¼€å‘äº¤ä»˜ç‰©æ£€æŸ¥**ï¼š
- [ ] æ”¯ä»˜äºŒç»´ç OWLç»„ä»¶å®Œæˆ
- [ ] æ”¯ä»˜é¡µé¢å“åº”å¼è®¾è®¡
- [ ] å€’è®¡æ—¶åŠŸèƒ½å®ç°
- [ ] æ”¯ä»˜çŠ¶æ€è½®è¯¢æœºåˆ¶
- [ ] ç§»åŠ¨ç«¯é€‚é…å®Œæˆ

### **å¾®ä¿¡å¼€å‘ä¸“å®¶äº¤ä»˜ç‰©æ£€æŸ¥**ï¼š
- [ ] å¾®ä¿¡æ”¯ä»˜V3 SDKå°è£…å®Œæˆ
- [ ] APIè°ƒç”¨ç¤ºä¾‹æ–‡æ¡£
- [ ] è¯ä¹¦ç®¡ç†æœºåˆ¶
- [ ] é”™è¯¯å¤„ç†è§„èŒƒ

### **å®‰å…¨å®¡æŸ¥ä¸“å®¶äº¤ä»˜ç‰©æ£€æŸ¥**ï¼š
- [ ] å®‰å…¨æµ‹è¯•æ¡†æ¶æ­å»º
- [ ] CI/CDæµæ°´çº¿é…ç½®
- [ ] ä»£ç å®‰å…¨æ‰«æç»“æœ
- [ ] æ”¯ä»˜å®‰å…¨æµ‹è¯•ç”¨ä¾‹

---

## ğŸ”§ å¼€å‘å·¥å…·ä¸ç¯å¢ƒ

### **å¼€å‘ç¯å¢ƒè¦æ±‚**
```yaml
# æœ€å°ç¡¬ä»¶è¦æ±‚
CPU: 4æ ¸
å†…å­˜: 8GB
å­˜å‚¨: 50GB
ç½‘ç»œ: ç¨³å®šäº’è”ç½‘è¿æ¥

# è½¯ä»¶ç‰ˆæœ¬
Python: 3.10+
Odoo: 19.0
PostgreSQL: 14+
Node.js: 18+
Git: 2.30+
```

### **å¼€å‘è§„èŒƒ**
1. **ä»£ç è§„èŒƒ**
   - Python: PEP8 + Odooç¼–ç è§„èŒƒ
   - JavaScript: ESLint + Odooå‰ç«¯è§„èŒƒ
   - SQL: ä½¿ç”¨ORMï¼Œé¿å…åŸç”ŸSQL

2. **æäº¤è§„èŒƒ**
   ```
   feat: æ–°åŠŸèƒ½
   fix: ä¿®å¤bug
   docs: æ–‡æ¡£æ›´æ–°
   style: ä»£ç æ ¼å¼è°ƒæ•´
   refactor: ä»£ç é‡æ„
   test: æµ‹è¯•ç›¸å…³
   chore: æ„å»ºè¿‡ç¨‹æˆ–è¾…åŠ©å·¥å…·
   ```

3. **åˆ†æ”¯ç­–ç•¥**
   ```
   main: ç”Ÿäº§ç¯å¢ƒ
   develop: å¼€å‘åˆ†æ”¯
   feature/*: åŠŸèƒ½åˆ†æ”¯
   hotfix/*: çƒ­ä¿®å¤åˆ†æ”¯
   release/*: å‘å¸ƒåˆ†æ”¯
   ```

---

## ğŸš¨ ç´§æ€¥é—®é¢˜å¤„ç†æµç¨‹

### **é—®é¢˜åˆ†çº§**
1. **P0ï¼ˆç´§æ€¥ï¼‰**ï¼šç³»ç»Ÿå´©æºƒã€æ”¯ä»˜å¤±è´¥ã€å®‰å…¨æ¼æ´
   - å“åº”æ—¶é—´ï¼š30åˆ†é’Ÿå†…
   - å¤„ç†äººï¼šPythonä¸“å®¶ + ç›¸å…³å¼€å‘
   
2. **P1ï¼ˆé«˜ï¼‰**ï¼šåŠŸèƒ½å¼‚å¸¸ã€æ€§èƒ½é—®é¢˜
   - å“åº”æ—¶é—´ï¼š2å°æ—¶å†…
   - å¤„ç†äººï¼šç›¸å…³å¼€å‘ä¸“å®¶
   
3. **P2ï¼ˆä¸­ï¼‰**ï¼šéæ ¸å¿ƒåŠŸèƒ½é—®é¢˜
   - å“åº”æ—¶é—´ï¼š24å°æ—¶å†…
   - å¤„ç†äººï¼šå¯¹åº”å¼€å‘ä¸“å®¶
   
4. **P3ï¼ˆä½ï¼‰**ï¼šä¼˜åŒ–å»ºè®®ã€ç•Œé¢è°ƒæ•´
   - å“åº”æ—¶é—´ï¼šä¸‹ä¸€ä¸ªè¿­ä»£
   - å¤„ç†äººï¼šå‰ç«¯å¼€å‘

### **æ²Ÿé€šæ¸ é“**
- **ç´§æ€¥é—®é¢˜**ï¼šTeamsç´§æ€¥ç¾¤ç»„ + ç”µè¯
- **æŠ€æœ¯è®¨è®º**ï¼šTeamsæŠ€æœ¯é¢‘é“
- **è¿›åº¦è·Ÿè¸ª**ï¼šGitLab Issues + çœ‹æ¿
- **æ–‡æ¡£å…±äº«**ï¼šSharePoint/Confluence

---

## ğŸ¯ ç¬¬ä¸€é˜¶æ®µæˆåŠŸæ ‡å‡†

### **æŠ€æœ¯æŒ‡æ ‡**
1. å¾®ä¿¡æ”¯ä»˜æ‰«ç æ”¯ä»˜æˆåŠŸç‡ > 99%
2. APIå¹³å‡å“åº”æ—¶é—´ < 500ms
3. å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 70%
4. æ— P0/P1çº§åˆ«å®‰å…¨æ¼æ´

### **è¿›åº¦æŒ‡æ ‡**
1. æŒ‰è®¡åˆ’å®Œæˆç¬¬1-4å‘¨å¼€å‘ä»»åŠ¡
2. æ‰€æœ‰äº¤ä»˜ç‰©æŒ‰æ—¶æäº¤
3. æ¯æ—¥ç«™ä¼šå‡ºå‹¤ç‡ > 90%
4. ä»£ç å®¡æŸ¥é€šè¿‡ç‡ > 95%

### **è´¨é‡æŒ‡æ ‡**
1. ä»£ç è§„èŒƒç¬¦åˆç‡ > 95%
2. æ— é‡å¤§é€»è¾‘é”™è¯¯
3. æ–‡æ¡£å®Œæ•´åº¦ > 80%
4. æµ‹è¯•ç”¨ä¾‹é€šè¿‡ç‡ 100%

---

**é¡¹ç›®æ­£å¼å¯åŠ¨**ï¼è¯·å„ä¸“å®¶æŒ‰ç…§åˆ†é…çš„ä»»åŠ¡å¼€å§‹å·¥ä½œã€‚æœ‰ä»»ä½•æŠ€æœ¯é—®é¢˜æˆ–é˜»ç¢ï¼ŒåŠæ—¶åœ¨Teamsä¸­æå‡ºã€‚Pythonä¸“å®¶å°†æ¯æ—¥æ£€æŸ¥è¿›åº¦ï¼Œåè°ƒè§£å†³é—®é¢˜ã€‚

**ä»Šæ—¥é‡ç‚¹å·¥ä½œ**ï¼š
1. åç«¯å¼€å‘ï¼šæ­å»ºå¼€å‘ç¯å¢ƒï¼Œåˆ›å»ºåŸºç¡€æ¨¡å—
2. å‰ç«¯å¼€å‘ï¼šé…ç½®OWLå¼€å‘ç¯å¢ƒ
3. å¾®ä¿¡å¼€å‘ä¸“å®¶ï¼šç ”ç©¶å¾®ä¿¡æ”¯ä»˜APIæ–‡æ¡£
4. å®‰å…¨å®¡æŸ¥ä¸“å®¶ï¼šæ­å»ºCI/CDæµæ°´çº¿

**ä»Šæ—¥ç«™ä¼šæ—¶é—´**ï¼šä¸‹åˆ4:00ï¼Œè®¨è®ºä»Šæ—¥è¿›å±•å’Œæ˜æ—¥è®¡åˆ’ã€‚
# ğŸš€ ç¬¬äºŒé˜¶æ®µï¼šPOSæ”¯ä»˜ä¸æ”¯ä»˜ä¼˜åŒ–å¯åŠ¨è®¡åˆ’ï¼ˆç¬¬7-10å‘¨ï¼‰

## ğŸ“‹ ç¬¬äºŒé˜¶æ®µæ€»ä½“ç›®æ ‡

**æ ¸å¿ƒç›®æ ‡**ï¼šåœ¨Odoo POSä¸­é›†æˆå¾®ä¿¡æ”¯ä»˜å’Œæ”¯ä»˜å®æ”¯ä»˜ï¼Œå®Œæˆæ”¯ä»˜æ¨¡å—çš„æ€§èƒ½ä¼˜åŒ–ä¸å®‰å…¨åŠ å›º
**æ—¶é—´è·¨åº¦**ï¼šç¬¬7-10å‘¨ï¼ˆå…±4å‘¨ï¼‰
**å…³é”®é‡Œç¨‹ç¢‘**ï¼š
1. POSç«¯å¾®ä¿¡æ”¯ä»˜é›†æˆï¼ˆç¬¬7-8å‘¨ï¼‰
2. POSç«¯æ”¯ä»˜å®æ”¯ä»˜é›†æˆï¼ˆç¬¬9å‘¨ï¼‰
3. æ”¯ä»˜æ¨¡å—ä¼˜åŒ–ä¸å®‰å…¨åŠ å›ºï¼ˆç¬¬10å‘¨ï¼‰

---

## ğŸ“… ç¬¬7-8å‘¨ï¼šPOSç«¯å¾®ä¿¡æ”¯ä»˜é›†æˆ

### **Pythonä¸“å®¶è°ƒåº¦æŒ‡ä»¤ï¼š**
```
æœ¬å‘¨é‡ç‚¹ï¼šåœ¨Odoo POSä¸­å®ç°å¾®ä¿¡æ”¯ä»˜é›†æˆï¼Œæ”¯æŒä¸»æ‰«å’Œè¢«æ‰«ä¸¤ç§æ¨¡å¼
æŠ€æœ¯è¦ç‚¹ï¼š
1. æ‰©å±•Odoo POSæ”¯ä»˜ç»ˆç«¯API
2. å¼€å‘OWL POSæ”¯ä»˜ç»„ä»¶
3. é›†æˆæ‰«ç æªç­‰ç¡¬ä»¶è®¾å¤‡
4. å®ç°å°ç¥¨æ‰“å°çš„æ”¯ä»˜ä¿¡æ¯
å¼€å‘é¡ºåºï¼šPOSæ”¯ä»˜ç»ˆç«¯API â†’ å¾®ä¿¡POSæ¥å£ â†’ å‰ç«¯ç»„ä»¶ â†’ ç¡¬ä»¶é€‚é…
```

### **åç«¯å¼€å‘å…·ä½“ä»»åŠ¡ï¼š**

#### **ç¬¬7å‘¨ï¼šPOSæ”¯ä»˜ç»ˆç«¯APIå¼€å‘**

**ä»»åŠ¡1ï¼šåˆ›å»ºPOSå¾®ä¿¡æ”¯ä»˜æ¨¡å—ç»“æ„**
```bash
# åˆ›å»ºPOSå¾®ä¿¡æ”¯ä»˜æ¨¡å—
mkdir -p pos_payment_wechat/{models,controllers,views/static/src/{js,xml,css},data,security,tests}

# åˆ›å»º__manifest__.py
cat > pos_payment_wechat/__manifest__.py << 'EOF'
{
    'name': 'POSå¾®ä¿¡æ”¯ä»˜',
    'version': '1.0.0',
    'category': 'Point of Sale',
    'summary': 'åœ¨Odoo POSä¸­é›†æˆå¾®ä¿¡æ”¯ä»˜',
    'description': '''
        æ”¯æŒå¾®ä¿¡æ‰«ç æ”¯ä»˜ã€åˆ·å¡æ”¯ä»˜ã€é€€æ¬¾ç­‰åŠŸèƒ½
    ''',
    'depends': ['point_of_sale', 'payment_wechat'],
    'data': [
        'security/ir.model.access.csv',
        'views/pos_payment_method_views.xml',
        'views/pos_config_views.xml',
    ],
    'assets': {
        'point_of_sale.assets': [
            'pos_payment_wechat/static/src/js/**/*.js',
            'pos_payment_wechat/static/src/xml/**/*.xml',
            'pos_payment_wechat/static/src/css/**/*.css',
        ],
    },
    'installable': True,
    'application': True,
    'auto_install': False,
}
EOF
```

**ä»»åŠ¡2ï¼šæ‰©å±•POSæ”¯ä»˜æ–¹æ³•æ¨¡å‹**
```python
# file: pos_payment_wechat/models/pos_payment_method.py

from odoo import models, fields, api, _
import logging

_logger = logging.getLogger(__name__)

class PosPaymentMethod(models.Model):
    """æ‰©å±•POSæ”¯ä»˜æ–¹æ³•ä»¥æ”¯æŒå¾®ä¿¡æ”¯ä»˜"""
    _inherit = 'pos.payment.method'
    
    # æ”¯ä»˜ç±»å‹å¢åŠ å¾®ä¿¡æ”¯ä»˜
    @api.model
    def _get_payment_terminal_selection(self):
        selection = super()._get_payment_terminal_selection()
        selection.append(('wechat', 'å¾®ä¿¡æ”¯ä»˜'))
        return selection
    
    # å¾®ä¿¡æ”¯ä»˜ç‰¹æœ‰å­—æ®µ
    wechat_payment_type = fields.Selection([
        ('barcode', 'æ‰«ç æ”¯ä»˜ï¼ˆé¡¾å®¢æ‰«å•†å®¶ï¼‰'),
        ('qr_code', 'æ‰«ç æ”¯ä»˜ï¼ˆå•†å®¶æ‰«é¡¾å®¢ï¼‰'),
        ('face', 'åˆ·è„¸æ”¯ä»˜'),
    ], string='æ”¯ä»˜æ–¹å¼', default='barcode')
    
    wechat_terminal_id = fields.Char(string='ç»ˆç«¯ç¼–å·')
    wechat_store_id = fields.Char(string='é—¨åº—ç¼–å·')
    
    # é…ç½®å…³è”
    wechat_payment_provider_id = fields.Many2one(
        'payment.provider',
        string='å¾®ä¿¡æ”¯ä»˜æä¾›å•†',
        domain=[('code', '=', 'wechat')]
    )
    
    def _get_payment_terminal_wechat(self, payment):
        """å¤„ç†å¾®ä¿¡æ”¯ä»˜"""
        try:
            # è·å–æ”¯ä»˜æä¾›è€…
            provider = self.wechat_payment_provider_id
            
            if not provider:
                _logger.error("å¾®ä¿¡æ”¯ä»˜æä¾›å•†æœªé…ç½®")
                return {'error': 'æ”¯ä»˜æä¾›å•†æœªé…ç½®'}
            
            # æ„é€ æ”¯ä»˜è¯·æ±‚
            payment_data = {
                'out_trade_no': payment.pos_order_id.name,
                'total_fee': int(payment.amount * 100),  # è½¬æ¢ä¸ºåˆ†
                'body': f"POSè®¢å•-{payment.pos_order_id.name}",
                'device_info': self.wechat_terminal_id or 'DEFAULT',
                'auth_code': self._get_auth_code(payment),  # åˆ·å¡æ”¯ä»˜éœ€è¦
            }
            
            # æ ¹æ®æ”¯ä»˜ç±»å‹è°ƒç”¨ä¸åŒæ¥å£
            if self.wechat_payment_type == 'barcode':
                # é¡¾å®¢æ‰«å•†å®¶ï¼šç”Ÿæˆä»˜æ¬¾ç 
                result = provider._create_native_payment(payment_data)
                return {
                    'type': 'qrcode',
                    'qrcode_url': result.get('code_url'),
                    'order_id': result.get('prepay_id')
                }
                
            elif self.wechat_payment_type == 'qr_code':
                # å•†å®¶æ‰«é¡¾å®¢ï¼šå¤„ç†ä»˜æ¬¾ç 
                auth_code = payment_data.pop('auth_code')
                result = provider._create_micropay_payment(payment_data, auth_code)
                return {
                    'type': 'direct',
                    'transaction_id': result.get('transaction_id'),
                    'status': 'success' if result.get('result_code') == 'SUCCESS' else 'failed'
                }
            
        except Exception as e:
            _logger.error(f"å¾®ä¿¡æ”¯ä»˜å¤„ç†å¤±è´¥: {str(e)}")
            return {'error': str(e)}
    
    def _get_auth_code(self, payment):
        """ä»æ”¯ä»˜æ•°æ®ä¸­è·å–æˆæƒç ï¼ˆæ¨¡æ‹Ÿæ‰«ç æªè¾“å…¥ï¼‰"""
        # å®é™…ä¸­åº”è¯¥ä»æ‰«ç æªæˆ–ç”¨æˆ·è¾“å…¥è·å–
        return payment.get('auth_code') or ''
```

**ä»»åŠ¡3ï¼šåˆ›å»ºPOSæ”¯ä»˜æ§åˆ¶å™¨**
```python
# file: pos_payment_wechat/controllers/pos_payment.py

from odoo import http
from odoo.http import request
import json

class PosWechatPaymentController(http.Controller):
    """POSå¾®ä¿¡æ”¯ä»˜APIæ§åˆ¶å™¨"""
    
    @http.route('/pos/wechat/payment/create', type='json', auth='user')
    def create_pos_payment(self, order_data, **kwargs):
        """åˆ›å»ºPOSå¾®ä¿¡æ”¯ä»˜"""
        try:
            # éªŒè¯å‚æ•°
            order_id = order_data.get('order_id')
            amount = order_data.get('amount')
            payment_method_id = order_data.get('payment_method_id')
            
            if not all([order_id, amount, payment_method_id]):
                return {'success': False, 'message': 'å‚æ•°ä¸å®Œæ•´'}
            
            # è·å–æ”¯ä»˜æ–¹æ³•
            payment_method = request.env['pos.payment.method'].browse(payment_method_id)
            
            if payment_method.use_payment_terminal != 'wechat':
                return {'success': False, 'message': 'éå¾®ä¿¡æ”¯ä»˜æ–¹æ³•'}
            
            # åˆ›å»ºæ”¯ä»˜è®°å½•
            payment = request.env['pos.payment'].create({
                'pos_order_id': order_data.get('pos_order_id'),
                'payment_method_id': payment_method_id,
                'amount': amount,
                'payment_date': fields.Datetime.now(),
            })
            
            # è°ƒç”¨å¾®ä¿¡æ”¯ä»˜
            result = payment_method._get_payment_terminal_wechat(payment)
            
            if 'error' in result:
                return {'success': False, 'message': result['error']}
            
            # è®°å½•å¾®ä¿¡æ”¯ä»˜ä¿¡æ¯
            payment.write({
                'transaction_id': result.get('transaction_id'),
                'wechat_prepay_id': result.get('order_id'),
            })
            
            return {
                'success': True,
                'payment_id': payment.id,
                'payment_result': result
            }
            
        except Exception as e:
            _logger.error(f"POSå¾®ä¿¡æ”¯ä»˜åˆ›å»ºå¤±è´¥: {str(e)}")
            return {'success': False, 'message': str(e)}
    
    @http.route('/pos/wechat/payment/query', type='json', auth='user')
    def query_payment_status(self, payment_id, **kwargs):
        """æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€"""
        payment = request.env['pos.payment'].browse(payment_id)
        provider = payment.payment_method_id.wechat_payment_provider_id
        
        if not provider:
            return {'success': False, 'message': 'æ”¯ä»˜æä¾›å•†æœªé…ç½®'}
        
        # æŸ¥è¯¢å¾®ä¿¡æ”¯ä»˜çŠ¶æ€
        result = provider._query_order(
            out_trade_no=payment.pos_order_id.name
        )
        
        return {
            'success': True,
            'status': result.get('trade_state'),
            'transaction_id': result.get('transaction_id'),
            'payment_time': result.get('success_time'),
        }
    
    @http.route('/pos/wechat/payment/refund', type='json', auth='user')
    def refund_payment(self, payment_id, refund_amount, **kwargs):
        """é€€æ¬¾"""
        payment = request.env['pos.payment'].browse(payment_id)
        provider = payment.payment_method_id.wechat_payment_provider_id
        
        if not provider:
            return {'success': False, 'message': 'æ”¯ä»˜æä¾›å•†æœªé…ç½®'}
        
        # è°ƒç”¨å¾®ä¿¡é€€æ¬¾æ¥å£
        result = provider._refund_order(
            transaction_id=payment.transaction_id,
            refund_amount=int(refund_amount * 100),
            total_amount=int(payment.amount * 100),
            out_refund_no=f"REFUND_{payment.pos_order_id.name}"
        )
        
        if result.get('result_code') == 'SUCCESS':
            # åˆ›å»ºé€€æ¬¾è®°å½•
            refund = request.env['pos.payment.refund'].create({
                'payment_id': payment_id,
                'amount': refund_amount,
                'refund_reason': kwargs.get('reason', 'é¡¾å®¢é€€æ¬¾'),
                'refund_date': fields.Datetime.now(),
            })
            
            return {
                'success': True,
                'refund_id': refund.id,
                'refund_fee': result.get('refund_fee'),
            }
        
        return {'success': False, 'message': result.get('err_code_des', 'é€€æ¬¾å¤±è´¥')}
```

#### **ç¬¬8å‘¨ï¼šPOSç¡¬ä»¶é›†æˆä¸å°ç¥¨æ‰“å°**

**ä»»åŠ¡4ï¼šæ‰«ç æªé›†æˆ**
```python
# file: pos_payment_wechat/models/hardware_scanner.py

import serial
import threading
import time
from odoo import models, api

class HardwareScanner(models.Model):
    """ç¡¬ä»¶æ‰«ç æªç®¡ç†"""
    _name = 'hardware.scanner'
    _description = 'æ‰«ç æªç®¡ç†'
    
    name = fields.Char(string='è®¾å¤‡åç§°', required=True)
    device_type = fields.Selection([
        ('usb', 'USBæ‰«ç æª'),
        ('bluetooth', 'è“ç‰™æ‰«ç æª'),
        ('serial', 'ä¸²å£æ‰«ç æª'),
    ], string='è®¾å¤‡ç±»å‹', default='usb')
    
    port = fields.Char(string='ç«¯å£å·', help='å¦‚: COM3, /dev/ttyUSB0')
    baud_rate = fields.Integer(string='æ³¢ç‰¹ç‡', default=9600)
    
    status = fields.Selection([
        ('disconnected', 'æœªè¿æ¥'),
        ('connected', 'å·²è¿æ¥'),
        ('scanning', 'æ‰«æä¸­'),
        ('error', 'é”™è¯¯'),
    ], string='çŠ¶æ€', default='disconnected')
    
    last_scanned = fields.Char(string='æœ€åæ‰«æå†…å®¹')
    last_scan_time = fields.Datetime(string='æœ€åæ‰«ææ—¶é—´')
    
    @api.model
    def connect_scanner(self, scanner_id):
        """è¿æ¥æ‰«ç æª"""
        scanner = self.browse(scanner_id)
        
        try:
            if scanner.device_type == 'serial':
                # ä¸²å£è¿æ¥
                scanner.serial_conn = serial.Serial(
                    port=scanner.port,
                    baudrate=scanner.baud_rate,
                    timeout=1
                )
            elif scanner.device_type == 'usb':
                # USB HIDè®¾å¤‡
                import hid
                device = hid.device()
                # æ ¹æ®å‚å•†IDå’Œäº§å“IDæ‰“å¼€è®¾å¤‡
                device.open(0x1234, 0x5678)  # ç¤ºä¾‹ID
            
            scanner.status = 'connected'
            scanner.message_post(body='æ‰«ç æªè¿æ¥æˆåŠŸ')
            
            # å¯åŠ¨ç›‘å¬çº¿ç¨‹
            thread = threading.Thread(target=self._listen_scanner, args=(scanner.id,))
            thread.daemon = True
            thread.start()
            
            return True
            
        except Exception as e:
            _logger.error(f"æ‰«ç æªè¿æ¥å¤±è´¥: {str(e)}")
            scanner.status = 'error'
            return False
    
    def _listen_scanner(self, scanner_id):
        """ç›‘å¬æ‰«ç æªè¾“å…¥"""
        scanner = self.browse(scanner_id)
        
        while scanner.status == 'connected':
            try:
                if scanner.device_type == 'serial' and hasattr(scanner, 'serial_conn'):
                    # è¯»å–ä¸²å£æ•°æ®
                    if scanner.serial_conn.in_waiting > 0:
                        data = scanner.serial_conn.readline().decode('utf-8').strip()
                        if data:
                            self._process_scanned_data(scanner_id, data)
                
                time.sleep(0.1)
                
            except Exception as e:
                _logger.error(f"æ‰«ç æªç›‘å¬é”™è¯¯: {str(e)}")
                break
    
    def _process_scanned_data(self, scanner_id, data):
        """å¤„ç†æ‰«æåˆ°çš„æ•°æ®"""
        scanner = self.browse(scanner_id)
        
        # æ›´æ–°æ‰«æè®°å½•
        scanner.write({
            'last_scanned': data,
            'last_scan_time': fields.Datetime.now(),
        })
        
        # è§¦å‘æ‰«æäº‹ä»¶
        self.env['bus.bus'].sendone(
            f'scanner_{scanner.id}',
            {
                'type': 'scanner_data',
                'data': data,
                'scanner_id': scanner.id,
                'timestamp': fields.Datetime.now(),
            }
        )
        
        # åˆ¤æ–­æ˜¯å¦ä¸ºå¾®ä¿¡/æ”¯ä»˜å®ä»˜æ¬¾ç 
        if self._is_payment_code(data):
            # è§¦å‘æ”¯ä»˜å¤„ç†
            self.env['bus.bus'].sendone(
                'pos_payment',
                {
                    'type': 'payment_code_scanned',
                    'code': data,
                    'scanner_id': scanner.id,
                }
            )
    
    def _is_payment_code(self, code):
        """åˆ¤æ–­æ˜¯å¦ä¸ºæ”¯ä»˜ç """
        # å¾®ä¿¡æ”¯ä»˜ç ä»¥10ã€11ã€12ã€13ã€14ã€15å¼€å¤´
        # æ”¯ä»˜å®æ”¯ä»˜ç ä»¥25-30å¼€å¤´
        if len(code) >= 18:  # æ”¯ä»˜ç é€šå¸¸ä¸º18-24ä½
            prefix = code[:2]
            if prefix in ['10', '11', '12', '13', '14', '15']:
                return 'wechat'
            elif prefix in ['25', '26', '27', '28', '29', '30']:
                return 'alipay'
        return False
```

**ä»»åŠ¡5ï¼šå°ç¥¨æ‰“å°æ‰©å±•**
```python
# file: pos_payment_wechat/models/pos_order.py

from odoo import models, fields, api

class PosOrder(models.Model):
    """æ‰©å±•POSè®¢å•ä»¥æ”¯æŒå¾®ä¿¡æ”¯ä»˜å°ç¥¨æ‰“å°"""
    _inherit = 'pos.order'
    
    wechat_transaction_id = fields.Char(string='å¾®ä¿¡äº¤æ˜“å·')
    alipay_transaction_id = fields.Char(string='æ”¯ä»˜å®äº¤æ˜“å·')
    
    def _order_fields(self, ui_order):
        """å¤„ç†è®¢å•å­—æ®µï¼ŒåŒ…å«æ”¯ä»˜ä¿¡æ¯"""
        order_fields = super()._order_fields(ui_order)
        
        # æ·»åŠ æ”¯ä»˜äº¤æ˜“å·
        for payment in ui_order.get('payment_lines', []):
            if payment.get('payment_method', {}).get('use_payment_terminal') == 'wechat':
                order_fields['wechat_transaction_id'] = payment.get('transaction_id')
            elif payment.get('payment_method', {}).get('use_payment_terminal') == 'alipay':
                order_fields['alipay_transaction_id'] = payment.get('transaction_id')
        
        return order_fields
    
    def _receipt_data(self):
        """æ‰©å±•å°ç¥¨æ•°æ®"""
        receipt_data = super()._receipt_data()
        
        # æ·»åŠ æ”¯ä»˜ä¿¡æ¯
        payment_info = []
        for payment in self.payment_ids:
            if payment.payment_method_id.use_payment_terminal == 'wechat':
                payment_info.append({
                    'method': 'å¾®ä¿¡æ”¯ä»˜',
                    'amount': payment.amount,
                    'transaction_id': payment.transaction_id,
                    'time': payment.payment_date,
                })
            elif payment.payment_method_id.use_payment_terminal == 'alipay':
                payment_info.append({
                    'method': 'æ”¯ä»˜å®æ”¯ä»˜',
                    'amount': payment.amount,
                    'transaction_id': payment.transaction_id,
                    'time': payment.payment_date,
                })
        
        receipt_data['payment_info'] = payment_info
        return receipt_data
```

### **å‰ç«¯å¼€å‘å…·ä½“ä»»åŠ¡ï¼š**

#### **ç¬¬7å‘¨ï¼šPOSæ”¯ä»˜ç•Œé¢å¼€å‘**

**ä»»åŠ¡1ï¼šåˆ›å»ºPOSå¾®ä¿¡æ”¯ä»˜ç»„ä»¶**
```javascript
// file: pos_payment_wechat/static/src/js/WechatPaymentScreen.js

import { Component } from "@odoo/owl";
import { useService } from "@web/core/utils/hooks";

export class WechatPaymentScreen extends Component {
    static template = "pos_payment_wechat.WechatPaymentScreen";
    
    setup() {
        super.setup();
        this.orm = useService("orm");
        this.notification = useService("notification");
        this.state = useState({
            paymentType: 'barcode', // barcode, qrcode, face
            qrCodeUrl: '',
            status: 'initial', // initial, scanning, success, failed
            countdown: 300,
            scannedCode: '',
            amount: this.props.amount,
        });
    }
    
    // ç”Ÿæˆæ”¯ä»˜äºŒç»´ç 
    async generatePayment() {
        this.state.status = 'scanning';
        
        try {
            const result = await this.orm.call(
                'pos.payment.method',
                'create_wechat_payment',
                [this.props.paymentMethodId, {
                    order_id: this.props.orderId,
                    amount: this.state.amount,
                    payment_type: this.state.paymentType,
                }]
            );
            
            if (result.success) {
                if (this.state.paymentType === 'barcode') {
                    // æ˜¾ç¤ºä»˜æ¬¾ç 
                    this.state.qrCodeUrl = result.qr_code_url;
                    this.startPaymentPolling(result.payment_id);
                } else if (this.state.paymentType === 'qrcode') {
                    // ç­‰å¾…æ‰«ç 
                    this.startScannerListening();
                }
                
                this.startCountdown();
            } else {
                this.notification.add(result.message, { type: 'danger' });
                this.state.status = 'failed';
            }
        } catch (error) {
            console.error('æ”¯ä»˜åˆ›å»ºå¤±è´¥:', error);
            this.state.status = 'failed';
        }
    }
    
    // å¼€å§‹æ”¯ä»˜çŠ¶æ€è½®è¯¢
    startPaymentPolling(paymentId) {
        this.pollingInterval = setInterval(async () => {
            const status = await this.orm.call(
                'pos.payment',
                'check_payment_status',
                [paymentId]
            );
            
            if (status === 'SUCCESS') {
                this.onPaymentSuccess(paymentId);
            } else if (status === 'CLOSED' || status === 'REVOKED') {
                this.onPaymentFailed('æ”¯ä»˜å·²å…³é—­');
            }
        }, 2000);
    }
    
    // ç›‘å¬æ‰«ç æª
    startScannerListening() {
        this.bus = this.env.services.bus_service;
        this.bus.addEventListener('scanner_data', (event) => {
            const data = event.detail;
            if (data.type === 'payment_code_scanned') {
                this.processScannedCode(data.code);
            }
        });
    }
    
    // å¤„ç†æ‰«æåˆ°çš„æ”¯ä»˜ç 
    async processScannedCode(code) {
        this.state.scannedCode = code;
        
        try {
            const result = await this.orm.call(
                'pos.payment.method',
                'process_payment_code',
                [this.props.paymentMethodId, {
                    order_id: this.props.orderId,
                    amount: this.state.amount,
                    auth_code: code,
                }]
            );
            
            if (result.success) {
                this.onPaymentSuccess(result.payment_id);
            } else {
                this.onPaymentFailed(result.message);
            }
        } catch (error) {
            console.error('æ”¯ä»˜å¤„ç†å¤±è´¥:', error);
            this.onPaymentFailed('æ”¯ä»˜å¤„ç†å¤±è´¥');
        }
    }
    
    // æ”¯ä»˜æˆåŠŸå¤„ç†
    onPaymentSuccess(paymentId) {
        clearInterval(this.pollingInterval);
        this.state.status = 'success';
        
        // é€šçŸ¥POSç•Œé¢
        this.props.onPaymentSuccess({
            paymentId: paymentId,
            amount: this.state.amount,
            method: 'wechat',
        });
        
        // 3ç§’åè‡ªåŠ¨å…³é—­
        setTimeout(() => {
            this.props.close();
        }, 3000);
    }
}
```

**ä»»åŠ¡2ï¼šæ”¯ä»˜æŒ‰é’®ç»„ä»¶**
```xml
<!-- file: pos_payment_wechat/static/src/xml/WechatPaymentButton.xml -->

<templates id="template" xml:space="preserve">
    <!-- POSæ”¯ä»˜é€‰æ‹©æŒ‰é’® -->
    <t t-name="pos_payment_wechat.WechatPaymentButton" owl="1">
        <div class="wechat-payment-button">
            <button 
                t-if="props.paymentMethod.use_payment_terminal === 'wechat'"
                class="btn btn-wechat"
                t-on-click="onWechatPayment"
            >
                <i class="fa fa-weixin"></i>
                å¾®ä¿¡æ”¯ä»˜
            </button>
            
            <button 
                t-if="props.paymentMethod.use_payment_terminal === 'alipay'"
                class="btn btn-alipay"
                t-on-click="onAlipayPayment"
            >
                <i class="fa fa-alipay"></i>
                æ”¯ä»˜å®æ”¯ä»˜
            </button>
        </div>
    </t>
    
    <!-- æ”¯ä»˜ç•Œé¢ -->
    <t t-name="pos_payment_wechat.WechatPaymentScreen" owl="1">
        <div class="wechat-payment-screen">
            <div class="header">
                <h3>å¾®ä¿¡æ”¯ä»˜</h3>
                <button class="btn-close" t-on-click="props.close">Ã—</button>
            </div>
            
            <div class="payment-content">
                <!-- é‡‘é¢æ˜¾ç¤º -->
                <div class="amount-display">
                    <div class="label">æ”¯ä»˜é‡‘é¢</div>
                    <div class="amount">Â¥ <t t-esc="state.amount.toFixed(2)"/></div>
                </div>
                
                <!-- äºŒç»´ç åŒºåŸŸ -->
                <t t-if="state.paymentType === 'barcode' and state.qrCodeUrl">
                    <div class="qrcode-container">
                        <div class="qrcode-wrapper">
                            <img t-att-src="state.qrCodeUrl" alt="æ”¯ä»˜äºŒç»´ç " />
                        </div>
                        <div class="instructions">
                            <p>è¯·ä½¿ç”¨å¾®ä¿¡æ‰«ä¸€æ‰«</p>
                            <p>æ‰«æä¸Šæ–¹äºŒç»´ç å®Œæˆæ”¯ä»˜</p>
                        </div>
                    </div>
                </t>
                
                <!-- æ‰«ç æªæ¨¡å¼ -->
                <t t-if="state.paymentType === 'qrcode'">
                    <div class="scanner-mode">
                        <div class="scanner-icon">
                            <i class="fa fa-barcode"></i>
                        </div>
                        <div class="instructions">
                            <p>è¯·ä½¿ç”¨æ‰«ç æªæ‰«æ</p>
                            <p>é¡¾å®¢çš„å¾®ä¿¡/æ”¯ä»˜å®ä»˜æ¬¾ç </p>
                        </div>
                        <div t-if="state.scannedCode" class="scanned-code">
                            å·²æ‰«æ: <span t-esc="state.scannedCode.substring(0, 8)"/>...
                        </div>
                    </div>
                </t>
                
                <!-- æ”¯ä»˜çŠ¶æ€ -->
                <div class="payment-status" t-att-class="'status-' + state.status">
                    <t t-if="state.status === 'scanning'">
                        <div class="spinner"></div>
                        <p>ç­‰å¾…æ”¯ä»˜...</p>
                    </t>
                    <t t-elif="state.status === 'success'">
                        <div class="success-icon">âœ“</div>
                        <p>æ”¯ä»˜æˆåŠŸï¼</p>
                    </t>
                    <t t-elif="state.status === 'failed'">
                        <div class="error-icon">âœ—</div>
                        <p>æ”¯ä»˜å¤±è´¥ï¼Œè¯·é‡è¯•</p>
                    </t>
                </div>
                
                <!-- å€’è®¡æ—¶ -->
                <div class="countdown">
                    å‰©ä½™æ—¶é—´: <span t-esc="formatTime(state.countdown)"/>
                </div>
            </div>
            
            <!-- æ“ä½œæŒ‰é’® -->
            <div class="action-buttons">
                <button class="btn btn-secondary" t-on-click="onCancel">
                    å–æ¶ˆæ”¯ä»˜
                </button>
                <button class="btn btn-primary" t-on-click="onRetry" 
                        t-if="state.status === 'failed'">
                    é‡æ–°æ”¯ä»˜
                </button>
            </div>
        </div>
    </t>
</templates>
```

**ä»»åŠ¡3ï¼šæ ·å¼è®¾è®¡**
```css
/* file: pos_payment_wechat/static/src/css/pos_payment.css */

/* æ”¯ä»˜æŒ‰é’®æ ·å¼ */
.btn-wechat {
    background: #07C160 !important;
    color: white !important;
    border: none !important;
    padding: 10px 20px !important;
    border-radius: 4px !important;
    font-size: 14px !important;
    margin: 5px !important;
}

.btn-wechat:hover {
    background: #06AD56 !important;
}

.btn-alipay {
    background: #1677FF !important;
    color: white !important;
    border: none !important;
    padding: 10px 20px !important;
    border-radius: 4px !important;
    font-size: 14px !important;
    margin: 5px !important;
}

.btn-alipay:hover {
    background: #0D5FD9 !important;
}

/* æ”¯ä»˜ç•Œé¢æ ·å¼ */
.wechat-payment-screen {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    width: 400px;
    max-width: 90vw;
    z-index: 1000;
}

.wechat-payment-screen .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #eee;
}

.wechat-payment-screen .header h3 {
    margin: 0;
    font-size: 18px;
}

.wechat-payment-screen .btn-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #999;
}

.wechat-payment-screen .btn-close:hover {
    color: #333;
}

/* æ”¯ä»˜å†…å®¹åŒºåŸŸ */
.payment-content {
    padding: 20px;
}

.amount-display {
    text-align: center;
    margin-bottom: 20px;
}

.amount-display .label {
    font-size: 14px;
    color: #666;
    margin-bottom: 5px;
}

.amount-display .amount {
    font-size: 32px;
    font-weight: bold;
    color: #FF6B00;
}

/* äºŒç»´ç åŒºåŸŸ */
.qrcode-container {
    text-align: center;
    margin: 20px 0;
}

.qrcode-wrapper {
    display: inline-block;
    padding: 15px;
    background: white;
    border: 1px solid #eee;
    border-radius: 4px;
    margin-bottom: 15px;
}

.qrcode-wrapper img {
    width: 200px;
    height: 200px;
}

.instructions {
    font-size: 14px;
    color: #666;
    line-height: 1.5;
}

/* æ‰«ç æªæ¨¡å¼ */
.scanner-mode {
    text-align: center;
    padding: 30px 0;
}

.scanner-icon {
    font-size: 60px;
    color: #07C160;
    margin-bottom: 15px;
}

.scanned-code {
    margin-top: 15px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 4px;
    font-family: monospace;
    font-size: 14px;
}

/* æ”¯ä»˜çŠ¶æ€ */
.payment-status {
    text-align: center;
    padding: 20px 0;
}

.spinner {
    display: inline-block;
    width: 40px;
    height: 40px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #07C160;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.success-icon {
    display: inline-block;
    width: 40px;
    height: 40px;
    background: #07C160;
    color: white;
    border-radius: 50%;
    line-height: 40px;
    font-size: 24px;
    margin-bottom: 10px;
}

.error-icon {
    display: inline-block;
    width: 40px;
    height: 40px;
    background: #FF4D4F;
    color: white;
    border-radius: 50%;
    line-height: 40px;
    font-size: 24px;
    margin-bottom: 10px;
}

/* å€’è®¡æ—¶ */
.countdown {
    text-align: center;
    font-size: 14px;
    color: #FF6B00;
    margin: 15px 0;
}

/* æ“ä½œæŒ‰é’® */
.action-buttons {
    display: flex;
    justify-content: space-between;
    padding: 15px 20px;
    border-top: 1px solid #eee;
}

.action-buttons .btn {
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.action-buttons .btn-secondary {
    background: #f8f9fa;
    border: 1px solid #ddd;
    color: #333;
}

.action-buttons .btn-primary {
    background: #07C160;
    border: none;
    color: white;
}
```

#### **ç¬¬8å‘¨ï¼šç¡¬ä»¶é€‚é…ä¸å¤šå±å¹•æ”¯æŒ**

**ä»»åŠ¡4ï¼šå¤šå±å¹•é€‚é…**
```javascript
// file: pos_payment_wechat/static/src/js/MultiScreenAdapter.js

export class MultiScreenAdapter {
    constructor(env) {
        this.env = env;
        this.screens = [];
        this.currentScreen = null;
    }
    
    // æ£€æµ‹å¯ç”¨å±å¹•
    detectScreens() {
        if (window.screen && window.screen.orientation) {
            // å¤šå±å¹•æ£€æµ‹
            if (window.screen.isExtended) {
                // æ‰©å±•å±å¹•æ”¯æŒ
                const screens = window.screen.getScreens();
                this.screens = screens.filter(screen => screen.isPrimary === false);
                
                if (this.screens.length > 0) {
                    // ä½¿ç”¨ç¬¬ä¸€ä¸ªæ‰©å±•å±å¹•æ˜¾ç¤ºæ”¯ä»˜äºŒç»´ç 
                    this.currentScreen = this.screens[0];
                    return true;
                }
            }
        }
        return false;
    }
    
    // åœ¨æ‰©å±•å±å¹•ä¸Šæ˜¾ç¤ºæ”¯ä»˜ç•Œé¢
    showOnExternalScreen(content, options = {}) {
        if (!this.currentScreen) {
            if (!this.detectScreens()) {
                console.warn('æœªæ£€æµ‹åˆ°æ‰©å±•å±å¹•');
                return false;
            }
        }
        
        try {
            // åˆ›å»ºæ–°çª—å£æ˜¾ç¤ºæ”¯ä»˜ç•Œé¢
            const features = `
                left=${this.currentScreen.availLeft},
                top=${this.currentScreen.availTop},
                width=${options.width || 400},
                height=${options.height || 600},
                menubar=no,
                toolbar=no,
                location=no,
                status=no,
                resizable=no
            `;
            
            this.externalWindow = window.open('', 'PaymentScreen', features);
            
            if (this.externalWindow) {
                this.externalWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>æ”¯ä»˜ç•Œé¢</title>
                        <meta charset="utf-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1">
                        <style>
                            body {
                                margin: 0;
                                padding: 20px;
                                font-family: Arial, sans-serif;
                                background: #f5f5f5;
                            }
                            .payment-container {
                                max-width: 400px;
                                margin: 0 auto;
                                background: white;
                                border-radius: 8px;
                                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                                overflow: hidden;
                            }
                        </style>
                    </head>
                    <body>
                        <div id="payment-container"></div>
                    </body>
                    </html>
                `);
                
                const container = this.externalWindow.document.getElementById('payment-container');
                container.innerHTML = content;
                
                return true;
            }
        } catch (error) {
            console.error('æ‰©å±•å±å¹•æ˜¾ç¤ºå¤±è´¥:', error);
        }
        
        return false;
    }
    
    // æ›´æ–°æ‰©å±•å±å¹•å†…å®¹
    updateExternalScreen(content) {
        if (this.externalWindow && !this.externalWindow.closed) {
            const container = this.externalWindow.document.getElementById('payment-container');
            if (container) {
                container.innerHTML = content;
                return true;
            }
        }
        return false;
    }
    
    // å…³é—­æ‰©å±•å±å¹•
    closeExternalScreen() {
        if (this.externalWindow && !this.externalWindow.closed) {
            this.externalWindow.close();
            this.externalWindow = null;
            return true;
        }
        return false;
    }
    
    // æ£€æµ‹å±å¹•æ–¹å‘å˜åŒ–
    setupOrientationListener(callback) {
        if (window.screen.orientation) {
            window.screen.orientation.addEventListener('change', () => {
                if (callback) {
                    callback(window.screen.orientation.type);
                }
            });
        }
    }
    
    // è·å–æœ€ä½³æ˜¾ç¤ºå°ºå¯¸
    getOptimalSize() {
        if (this.currentScreen) {
            const { availWidth, availHeight } = this.currentScreen;
            
            // æ ¹æ®å±å¹•å°ºå¯¸è®¡ç®—æœ€ä½³æ˜¾ç¤ºå¤§å°
            if (availWidth >= 800 && availHeight >= 600) {
                return { width: 400, height: 600 }; // å¤§å±å¹•
            } else {
                return { width: 300, height: 450 }; // å°å±å¹•
            }
        }
        return { width: 300, height: 450 }; // é»˜è®¤å°ºå¯¸
    }
}
```

**ä»»åŠ¡5ï¼šå°ç¥¨æ¨¡æ¿æ‰©å±•**
```xml
<!-- file: pos_payment_wechat/static/src/xml/ReceiptTemplate.xml -->

<templates id="template" xml:space="preserve">
    <!-- æ‰©å±•å°ç¥¨æ¨¡æ¿ -->
    <t t-name="pos_payment_wechat.ReceiptTemplate" owl="1">
        <div class="receipt">
            <!-- å¤´éƒ¨ -->
            <div class="receipt-header">
                <div class="store-name">
                    <t t-esc="props.receipt.company.name"/>
                </div>
                <div class="store-address">
                    <t t-esc="props.receipt.company.street"/>
                </div>
                <div class="store-phone">
                    ç”µè¯: <t t-esc="props.receipt.company.phone"/>
                </div>
            </div>
            
            <!-- è®¢å•ä¿¡æ¯ -->
            <div class="order-info">
                <div class="line">
                    <span>è®¢å•å·:</span>
                    <span t-esc="props.receipt.order.name"/>
                </div>
                <div class="line">
                    <span>æ”¶é“¶å‘˜:</span>
                    <span t-esc="props.receipt.order.user.name"/>
                </div>
                <div class="line">
                    <span>æ—¶é—´:</span>
                    <span t-esc="formatDate(props.receipt.order.date)"/>
                </div>
            </div>
            
            <!-- å•†å“åˆ—è¡¨ -->
            <div class="items">
                <div class="header">
                    <span>å•†å“</span>
                    <span>æ•°é‡</span>
                    <span>å•ä»·</span>
                    <span>é‡‘é¢</span>
                </div>
                <t t-foreach="props.receipt.order.items" t-as="item">
                    <div class="item">
                        <span class="name" t-esc="item.name"/>
                        <span t-esc="item.quantity"/>
                        <span t-esc="formatCurrency(item.price)"/>
                        <span t-esc="formatCurrency(item.total)"/>
                    </div>
                </t>
            </div>
            
            <!-- æ”¯ä»˜ä¿¡æ¯ -->
            <div class="payment-info" t-if="props.receipt.payment_info">
                <div class="section-title">æ”¯ä»˜ä¿¡æ¯</div>
                <t t-foreach="props.receipt.payment_info" t-as="payment">
                    <div class="payment-line">
                        <span t-esc="payment.method"/>
                        <span t-esc="formatCurrency(payment.amount)"/>
                    </div>
                    <t t-if="payment.transaction_id">
                        <div class="transaction-id">
                            äº¤æ˜“å·: <span t-esc="payment.transaction_id"/>
                        </div>
                    </t>
                    <t t-if="payment.time">
                        <div class="payment-time">
                            æ—¶é—´: <span t-esc="formatDate(payment.time)"/>
                        </div>
                    </t>
                </t>
            </div>
            
            <!-- æ€»è®¡ -->
            <div class="total">
                <div class="line">
                    <span>æ€»è®¡:</span>
                    <span t-esc="formatCurrency(props.receipt.order.total)"/>
                </div>
                <div class="line">
                    <span>å®æ”¶:</span>
                    <span t-esc="formatCurrency(props.receipt.order.paid)"/>
                </div>
                <t t-if="props.receipt.order.change > 0">
                    <div class="line">
                        <span>æ‰¾é›¶:</span>
                        <span t-esc="formatCurrency(props.receipt.order.change)"/>
                    </div>
                </t>
            </div>
            
            <!-- åº•éƒ¨ä¿¡æ¯ -->
            <div class="footer">
                <div class="thank-you">æ„Ÿè°¢æƒ é¡¾ï¼Œæ¬¢è¿å†æ¬¡å…‰ä¸´ï¼</div>
                <div class="qr-code">
                    <!-- æ‰“å°åº—é“ºäºŒç»´ç  -->
                    <t t-if="props.receipt.company.qr_code">
                        <img t-att-src="props.receipt.company.qr_code" 
                             alt="åº—é“ºäºŒç»´ç "
                             style="width: 60px; height: 60px;"/>
                        <div>æ‰«ç å…³æ³¨</div>
                    </t>
                </div>
            </div>
        </div>
    </t>
</templates>
```

### **å¾®ä¿¡å¼€å‘ä¸“å®¶å…·ä½“ä»»åŠ¡ï¼š**

#### **ç¬¬7å‘¨ï¼šå¾®ä¿¡POSæ”¯ä»˜APIå°è£…**

**ä»»åŠ¡1ï¼šå¾®ä¿¡æ”¯ä»˜POSæ¥å£**
```python
# file: wechat_common/lib/wechat_pos_api.py

import time
import hashlib
from .wechat_pay_v3 import WechatPayV3Client

class WechatPosAPI:
    """å¾®ä¿¡æ”¯ä»˜POSä¸“ç”¨æ¥å£"""
    
    def __init__(self, client):
        self.client = client
    
    def create_micropay(self, payment_data):
        """æäº¤ä»˜æ¬¾ç æ”¯ä»˜ï¼ˆè¢«æ‰«æ”¯ä»˜ï¼‰
        
        Args:
            payment_data: æ”¯ä»˜æ•°æ®
                - out_trade_no: å•†æˆ·è®¢å•å·
                - total_fee: æ€»é‡‘é¢ï¼ˆåˆ†ï¼‰
                - auth_code: ä»˜æ¬¾ç 
                - body: å•†å“æè¿°
                - device_info: ç»ˆç«¯è®¾å¤‡å·
        """
        url = f"{self.client.base_url}/pay/micropay"
        
        # æ„é€ è¯·æ±‚æ•°æ®
        data = {
            "mchid": self.client.mch_id,
            "appid": payment_data.get('appid'),
            "description": payment_data.get('body', 'POSæ”¯ä»˜'),
            "out_trade_no": payment_data.get('out_trade_no'),
            "amount": {
                "total": payment_data.get('total_fee'),
                "currency": "CNY"
            },
            "scene_info": {
                "device_id": payment_data.get('device_info', 'DEFAULT_POS'),
                "store_info": {
                    "id": payment_data.get('store_id', 'DEFAULT_STORE'),
                    "name": payment_data.get('store_name', 'é»˜è®¤é—¨åº—'),
                    "area_code": payment_data.get('area_code', '440000'),
                    "address": payment_data.get('address', '')
                }
            },
            "auth_code": payment_data.get('auth_code')
        }
        
        # ç”Ÿæˆç­¾å
        headers = self.client._create_headers('POST', url, data)
        
        # å‘é€è¯·æ±‚
        response = self.client._request('POST', url, json=data, headers=headers)
        
        if response.status_code == 200:
            result = response.json()
            
            # æ£€æŸ¥æ”¯ä»˜ç»“æœ
            if result.get('trade_state') == 'SUCCESS':
                return {
                    'success': True,
                    'transaction_id': result.get('transaction_id'),
                    'total_fee': result.get('amount', {}).get('total'),
                    'payer_openid': result.get('payer', {}).get('openid'),
                    'time_end': result.get('success_time'),
                }
            else:
                return {
                    'success': False,
                    'err_code': result.get('err_code'),
                    'err_code_des': result.get('err_code_des'),
                    'trade_state': result.get('trade_state')
                }
        
        return {
            'success': False,
            'error_code': response.status_code,
            'error_msg': response.text
        }
    
    def reverse_order(self, transaction_id=None, out_trade_no=None):
        """æ’¤é”€è®¢å•ï¼ˆç”¨äºä»˜æ¬¾ç æ”¯ä»˜å¤±è´¥ï¼‰
        
        æ³¨æ„ï¼šæ’¤é”€è®¢å•åªèƒ½æ’¤é”€å½“å¤©æœªæ”¯ä»˜çš„è®¢å•
        """
        if transaction_id:
            url = f"{self.client.base_url}/secapi/pay/reverse"
            data = {"transaction_id": transaction_id}
        else:
            url = f"{self.client.base_url}/secapi/pay/reverse"
            data = {"out_trade_no": out_trade_no}
        
        headers = self.client._create_headers('POST', url, data)
        
        # æ’¤é”€è®¢å•éœ€è¦ä½¿ç”¨è¯ä¹¦
        response = self.client._request_with_cert('POST', url, json=data, headers=headers)
        
        return response.json()
    
    def batch_query(self, start_time, end_time, offset=0, limit=100):
        """æ‰¹é‡æŸ¥è¯¢è®¢å•ï¼ˆç”¨äºå¯¹è´¦ï¼‰
        
        Args:
            start_time: å¼€å§‹æ—¶é—´ï¼Œæ ¼å¼ï¼šYYYY-MM-DDTHH:mm:ss+TIMEZONE
            end_time: ç»“æŸæ—¶é—´
            offset: åç§»é‡
            limit: æ¯é¡µå¤§å°
        """
        url = f"{self.client.base_url}/bill/tradebill"
        
        params = {
            "bill_date": start_time[:10],  # è´¦å•æ—¥æœŸ
            "bill_type": "ALL",  # è´¦å•ç±»å‹
            "tar_type": "GZIP",  # å‹ç¼©ç±»å‹
        }
        
        if offset > 0:
            params['offset'] = offset
        if limit != 100:
            params['limit'] = limit
        
        headers = self.client._create_headers('GET', url, '')
        response = self.client._request('GET', url, params=params, headers=headers)
        
        if response.status_code == 200:
            # è¿”å›ä¸‹è½½é“¾æ¥
            result = response.json()
            return {
                'success': True,
                'download_url': result.get('download_url'),
                'hash_type': result.get('hash_type'),
                'hash_value': result.get('hash_value')
            }
        
        return {
            'success': False,
            'error_code': response.status_code,
            'error_msg': response.text
        }
    
    def download_bill(self, download_url):
        """ä¸‹è½½å¯¹è´¦å•"""
        headers = self.client._create_headers('GET', download_url, '')
        response = self.client._request('GET', download_url, headers=headers)
        
        if response.status_code == 200:
            return {
                'success': True,
                'content': response.content,
                'content_type': response.headers.get('Content-Type')
            }
        
        return {
            'success': False,
            'error_code': response.status_code
        }
```

**ä»»åŠ¡2ï¼šæ”¯ä»˜çŠ¶æ€è½®è¯¢ä¼˜åŒ–**
```python
# file: wechat_common/lib/payment_poller.py

import asyncio
import aiohttp
import json
import time
from datetime import datetime
from typing import Dict, List, Optional, Callable

class PaymentPoller:
    """æ”¯ä»˜çŠ¶æ€è½®è¯¢å™¨"""
    
    def __init__(self, client, interval=2, timeout=300):
        self.client = client
        self.interval = interval  # è½®è¯¢é—´éš”ï¼ˆç§’ï¼‰
        self.timeout = timeout    # è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
        self.tasks = {}           # ä»»åŠ¡å­—å…¸
        self.callbacks = {}       # å›è°ƒå‡½æ•°
        
    async def poll_payment(self, out_trade_no: str, callback: Optional[Callable] = None):
        """è½®è¯¢æ”¯ä»˜çŠ¶æ€"""
        start_time = time.time()
        poll_count = 0
        
        while time.time() - start_time < self.timeout:
            try:
                # æŸ¥è¯¢è®¢å•çŠ¶æ€
                result = await self._query_order_async(out_trade_no)
                
                if result['success']:
                    trade_state = result.get('trade_state')
                    
                    # æ”¯ä»˜æˆåŠŸ
                    if trade_state == 'SUCCESS':
                        if callback:
                            await callback({
                                'status': 'success',
                                'data': result,
                                'poll_count': poll_count
                            })
                        return {'status': 'success', 'data': result}
                    
                    # æ”¯ä»˜å¤±è´¥
                    elif trade_state in ['CLOSED', 'REVOKED', 'PAYERROR']:
                        if callback:
                            await callback({
                                'status': 'failed',
                                'data': result,
                                'poll_count': poll_count
                            })
                        return {'status': 'failed', 'data': result}
                    
                    # æ”¯ä»˜ä¸­ï¼Œç»§ç»­è½®è¯¢
                    elif trade_state == 'USERPAYING':
                        poll_count += 1
                        if callback:
                            await callback({
                                'status': 'polling',
                                'data': result,
                                'poll_count': poll_count
                            })
                    else:
                        # å…¶ä»–çŠ¶æ€
                        poll_count += 1
                
                await asyncio.sleep(self.interval)
                
            except Exception as e:
                print(f"è½®è¯¢å¼‚å¸¸: {e}")
                await asyncio.sleep(self.interval)
        
        # è¶…æ—¶å¤„ç†
        if callback:
            await callback({
                'status': 'timeout',
                'poll_count': poll_count
            })
        
        return {'status': 'timeout', 'poll_count': poll_count}
    
    async def _query_order_async(self, out_trade_no: str):
        """å¼‚æ­¥æŸ¥è¯¢è®¢å•çŠ¶æ€"""
        async with aiohttp.ClientSession() as session:
            url = f"{self.client.base_url}/pay/transactions/out-trade-no/{out_trade_no}"
            url = f"{url}?mchid={self.client.mch_id}"
            
            headers = self.client._create_headers('GET', url, '')
            
            async with session.get(url, headers=headers) as response:
                if response.status == 200:
                    data = await response.json()
                    return {
                        'success': True,
                        'trade_state': data.get('trade_state'),
                        'transaction_id': data.get('transaction_id'),
                        'amount': data.get('amount', {}).get('total'),
                        'payer': data.get('payer'),
                        'success_time': data.get('success_time')
                    }
                else:
                    return {
                        'success': False,
                        'error_code': response.status,
                        'error_msg': await response.text()
                    }
    
    def start_polling(self, out_trade_no: str, callback: Optional[Callable] = None):
        """å¯åŠ¨è½®è¯¢ä»»åŠ¡"""
        if out_trade_no in self.tasks:
            return self.tasks[out_trade_no]
        
        # åˆ›å»ºå¼‚æ­¥ä»»åŠ¡
        task = asyncio.create_task(self.poll_payment(out_trade_no, callback))
        self.tasks[out_trade_no] = task
        
        # è®¾ç½®ä»»åŠ¡å®Œæˆå›è°ƒ
        task.add_done_callback(lambda t: self._task_done(out_trade_no))
        
        return task
    
    def _task_done(self, out_trade_no: str):
        """ä»»åŠ¡å®Œæˆå¤„ç†"""
        if out_trade_no in self.tasks:
            del self.tasks[out_trade_no]
    
    def stop_polling(self, out_trade_no: str):
        """åœæ­¢è½®è¯¢"""
        if out_trade_no in self.tasks:
            self.tasks[out_trade_no].cancel()
            del self.tasks[out_trade_no]
            return True
        return False
    
    def stop_all(self):
        """åœæ­¢æ‰€æœ‰è½®è¯¢"""
        for out_trade_no in list(self.tasks.keys()):
            self.stop_polling(out_trade_no)
```

#### **ç¬¬8å‘¨ï¼šç¡¬ä»¶é€šä¿¡åè®®**

**ä»»åŠ¡3ï¼šæ‰«ç æªé€šä¿¡åè®®**
```python
# file: wechat_common/lib/scanner_protocol.py

import serial
import threading
import queue
import time
from enum import Enum
from typing import Optional, Dict, Any

class ScannerType(Enum):
    """æ‰«ç æªç±»å‹"""
    USB_HID = "usb_hid"      # USB HIDè®¾å¤‡
    SERIAL_COM = "serial"    # ä¸²å£è®¾å¤‡
    BLUETOOTH = "bluetooth"  # è“ç‰™è®¾å¤‡
    NETWORK = "network"      # ç½‘ç»œæ‰«ç æª

class ScannerProtocol:
    """æ‰«ç æªé€šä¿¡åè®®åŸºç±»"""
    
    def __init__(self, scanner_type: ScannerType, config: Dict[str, Any]):
        self.scanner_type = scanner_type
        self.config = config
        self.connected = False
        self.data_queue = queue.Queue()
        self.listener_thread = None
        self.callbacks = []
        
    def connect(self) -> bool:
        """è¿æ¥æ‰«ç æª"""
        raise NotImplementedError
        
    def disconnect(self) -> bool:
        """æ–­å¼€è¿æ¥"""
        raise NotImplementedError
        
    def read_data(self, timeout: Optional[float] = None) -> Optional[str]:
        """è¯»å–æ•°æ®"""
        try:
            return self.data_queue.get(timeout=timeout)
        except queue.Empty:
            return None
            
    def add_callback(self, callback):
        """æ·»åŠ æ•°æ®å›è°ƒ"""
        self.callbacks.append(callback)
        
    def _notify_callbacks(self, data: str):
        """é€šçŸ¥å›è°ƒå‡½æ•°"""
        for callback in self.callbacks:
            try:
                callback(data)
            except Exception as e:
                print(f"å›è°ƒæ‰§è¡Œå¤±è´¥: {e}")

class SerialScanner(ScannerProtocol):
    """ä¸²å£æ‰«ç æª"""
    
    def __init__(self, port: str, baudrate: int = 9600, **kwargs):
        config = {
            'port': port,
            'baudrate': baudrate,
            'bytesize': serial.EIGHTBITS,
            'parity': serial.PARITY_NONE,
            'stopbits': serial.STOPBITS_ONE,
            'timeout': 1,
            **kwargs
        }
        super().__init__(ScannerType.SERIAL_COM, config)
        self.serial_conn = None
        
    def connect(self) -> bool:
        """è¿æ¥ä¸²å£æ‰«ç æª"""
        try:
            self.serial_conn = serial.Serial(**self.config)
            self.connected = True
            
            # å¯åŠ¨ç›‘å¬çº¿ç¨‹
            self.listener_thread = threading.Thread(
                target=self._listen_serial,
                daemon=True
            )
            self.listener_thread.start()
            
            print(f"ä¸²å£æ‰«ç æªå·²è¿æ¥: {self.config['port']}")
            return True
            
        except serial.SerialException as e:
            print(f"ä¸²å£è¿æ¥å¤±è´¥: {e}")
            return False
            
    def disconnect(self) -> bool:
        """æ–­å¼€è¿æ¥"""
        if self.serial_conn and self.serial_conn.is_open:
            self.serial_conn.close()
        self.connected = False
        return True
        
    def _listen_serial(self):
        """ç›‘å¬ä¸²å£æ•°æ®"""
        while self.connected and self.serial_conn.is_open:
            try:
                if self.serial_conn.in_waiting > 0:
                    # è¯»å–æ•°æ®
                    data = self.serial_conn.readline()
                    if data:
                        # è§£ç å¹¶æ¸…ç†æ•°æ®
                        decoded_data = data.decode('utf-8', errors='ignore').strip()
                        
                        # è¿‡æ»¤æ— æ•ˆæ•°æ®
                        if self._is_valid_data(decoded_data):
                            self.data_queue.put(decoded_data)
                            self._notify_callbacks(decoded_data)
                            
                time.sleep(0.01)
                
            except Exception as e:
                print(f"ä¸²å£ç›‘å¬é”™è¯¯: {e}")
                break
                
    def _is_valid_data(self, data: str) -> bool:
        """éªŒè¯æ•°æ®æœ‰æ•ˆæ€§"""
        # è¿‡æ»¤ç©ºæ•°æ®
        if not data:
            return False
            
        # è¿‡æ»¤æ§åˆ¶å­—ç¬¦
        if any(ord(c) < 32 for c in data):
            return False
            
        # æ ¹æ®æ‰«ç æªç±»å‹éªŒè¯æ•°æ®æ ¼å¼
        # è¿™é‡Œå¯ä»¥æ·»åŠ ç‰¹å®šçš„éªŒè¯é€»è¾‘
        return True

class USBHIDScanner(ScannerProtocol):
    """USB HIDæ‰«ç æª"""
    
    def __init__(self, vendor_id: int = 0x1234, product_id: int = 0x5678, **kwargs):
        config = {
            'vendor_id': vendor_id,
            'product_id': product_id,
            **kwargs
        }
        super().__init__(ScannerType.USB_HID, config)
        self.device = None
        
    def connect(self) -> bool:
        """è¿æ¥USB HIDè®¾å¤‡"""
        try:
            import hid
            self.device = hid.device()
            self.device.open(self.config['vendor_id'], self.config['product_id'])
            
            # è®¾ç½®éé˜»å¡æ¨¡å¼
            self.device.set_nonblocking(1)
            self.connected = True
            
            # å¯åŠ¨ç›‘å¬çº¿ç¨‹
            self.listener_thread = threading.Thread(
                target=self._listen_hid,
                daemon=True
            )
            self.listener_thread.start()
            
            print(f"USB HIDæ‰«ç æªå·²è¿æ¥")
            return True
            
        except Exception as e:
            print(f"USB HIDè¿æ¥å¤±è´¥: {e}")
            return False
            
    def disconnect(self) -> bool:
        """æ–­å¼€è¿æ¥"""
        if self.device:
            self.device.close()
        self.connected = False
        return True
        
    def _listen_hid(self):
        """ç›‘å¬HIDæ•°æ®"""
        while self.connected:
            try:
                # è¯»å–HIDæ•°æ®
                data = self.device.read(64, timeout_ms=100)
                if data:
                    # è§£ç é”®ç›˜è¾“å…¥
                    decoded_data = self._decode_hid_data(data)
                    if decoded_data:
                        self.data_queue.put(decoded_data)
                        self._notify_callbacks(decoded_data)
                        
                time.sleep(0.01)
                
            except Exception as e:
                print(f"HIDç›‘å¬é”™è¯¯: {e}")
                break
                
    def _decode_hid_data(self, data: list) -> Optional[str]:
        """è§£ç HIDé”®ç›˜æ•°æ®"""
        # HIDé”®ç›˜æ‰«æç æ˜ å°„è¡¨
        keymap = {
            4: 'a', 5: 'b', 6: 'c', 7: 'd', 8: 'e', 9: 'f',
            10: 'g', 11: 'h', 12: 'i', 13: 'j', 14: 'k', 15: 'l',
            16: 'm', 17: 'n', 18: 'o', 19: 'p', 20: 'q', 21: 'r',
            22: 's', 23: 't', 24: 'u', 25: 'v', 26: 'w', 27: 'x',
            28: 'y', 29: 'z', 30: '1', 31: '2', 32: '3', 33: '4',
            34: '5', 35: '6', 36: '7', 37: '8', 38: '9', 39: '0',
            40: '\n', 44: ' ', 45: '-', 46: '=', 47: '[', 48: ']',
            55: '*', 56: '/', 85: '*', 86: '+', 87: '1', 88: '2',
            89: '3', 90: '4', 91: '5', 92: '6', 93: '7', 94: '8',
            95: '9', 96: '0', 100: '/'
        }
        
        # è§£æHIDæŠ¥å‘Š
        if len(data) >= 8:
            # æ£€æŸ¥ä¿®é¥°é”®ä½
            modifiers = data[0]
            # å¿½ç•¥ä¿®é¥°é”®ï¼Œåªå¤„ç†æ™®é€šæŒ‰é”®
            result = []
            for keycode in data[2:8]:
                if keycode and keycode in keymap:
                    char = keymap[keycode]
                    # å¤„ç†Shiftä¿®é¥°
                    if modifiers & 0x22:  # Left or Right Shift
                        char = char.upper()
                    result.append(char)
            
            if result:
                return ''.join(result)
        
        return None

class ScannerManager:
    """æ‰«ç æªç®¡ç†å™¨"""
    
    def __init__(self):
        self.scanners = {}
        self.active_scanner = None
        
    def add_scanner(self, scanner_id: str, scanner: ScannerProtocol) -> bool:
        """æ·»åŠ æ‰«ç æª"""
        if scanner.connect():
            self.scanners[scanner_id] = scanner
            return True
        return False
        
    def remove_scanner(self, scanner_id: str) -> bool:
        """ç§»é™¤æ‰«ç æª"""
        if scanner_id in self.scanners:
            self.scanners[scanner_id].disconnect()
            del self.scanners[scanner_id]
            
            if self.active_scanner == scanner_id:
                self.active_scanner = None
            return True
        return False
        
    def set_active_scanner(self, scanner_id: str) -> bool:
        """è®¾ç½®æ´»åŠ¨æ‰«ç æª"""
        if scanner_id in self.scanners:
            self.active_scanner = scanner_id
            return True
        return False
        
    def get_scanned_data(self, scanner_id: Optional[str] = None, timeout: float = 1.0) -> Optional[str]:
        """è·å–æ‰«ææ•°æ®"""
        target_id = scanner_id or self.active_scanner
        if target_id and target_id in self.scanners:
            return self.scanners[target_id].read_data(timeout)
        return None
        
    def register_callback(self, scanner_id: str, callback) -> bool:
        """æ³¨å†Œæ•°æ®å›è°ƒ"""
        if scanner_id in self.scanners:
            self.scanners[scanner_id].add_callback(callback)
            return True
        return False
        
    def detect_available_scanners(self) -> list:
        """æ£€æµ‹å¯ç”¨æ‰«ç æª"""
        available = []
        
        # æ£€æµ‹ä¸²å£è®¾å¤‡
        import serial.tools.list_ports
        ports = serial.tools.list_ports.comports()
        for port in ports:
            if "USB" in port.description or "Serial" in port.description:
                scanner = SerialScanner(port.device)
                if scanner.connect():
                    available.append({
                        'id': f"serial_{port.device}",
                        'type': 'serial',
                        'name': port.description,
                        'device': port.device,
                        'scanner': scanner
                    })
        
        # æ£€æµ‹USB HIDè®¾å¤‡ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
        try:
            import hid
            devices = hid.enumerate()
            for device in devices:
                if device['usage_page'] == 0x01 and device['usage'] == 0x06:  # é”®ç›˜è®¾å¤‡
                    scanner = USBHIDScanner(device['vendor_id'], device['product_id'])
                    if scanner.connect():
                        available.append({
                            'id': f"usb_{device['vendor_id']}_{device['product_id']}",
                            'type': 'usb_hid',
                            'name': device['product_string'],
                            'vendor_id': device['vendor_id'],
                            'product_id': device['product_id'],
                            'scanner': scanner
                        })
        except ImportError:
            pass  # hidæ¨¡å—æœªå®‰è£…
            
        return available
```

### **å®‰å…¨å®¡æŸ¥ä¸“å®¶å…·ä½“ä»»åŠ¡ï¼š**

#### **ç¬¬7å‘¨ï¼šPOSæ”¯ä»˜å®‰å…¨æµ‹è¯•**

**ä»»åŠ¡1ï¼šPOSæ”¯ä»˜å®‰å…¨æµ‹è¯•ç”¨ä¾‹**
```python
# file: tests/pos_security/test_pos_payment_security.py

import pytest
from unittest.mock import Mock, patch, MagicMock
from odoo.tests.common import TransactionCase, tagged
from odoo.exceptions import ValidationError, UserError

@tagged('pos_security', 'post_install', '-at_install')
class TestPosPaymentSecurity(TransactionCase):
    """POSæ”¯ä»˜å®‰å…¨æµ‹è¯•"""
    
    def setUp(self):
        super(TestPosPaymentSecurity, self).setUp()
        
        # åˆ›å»ºæµ‹è¯•æ•°æ®
        self.pos_config = self.env['pos.config'].create({
            'name': 'Test POS Config'
        })
        
        self.wechat_provider = self.env['payment.provider'].create({
            'name': 'å¾®ä¿¡æ”¯ä»˜æµ‹è¯•',
            'code': 'wechat',
            'state': 'test',
            'wechat_mch_id': 'test_mch_id',
            'wechat_app_id': 'test_app_id',
            'wechat_api_v3_key': 'test_api_key'
        })
        
        self.wechat_payment_method = self.env['pos.payment.method'].create({
            'name': 'å¾®ä¿¡æ”¯ä»˜',
            'use_payment_terminal': 'wechat',
            'wechat_payment_provider_id': self.wechat_provider.id,
            'wechat_payment_type': 'barcode',
            'wechat_terminal_id': 'TEST_TERMINAL',
            'config_ids': [(4, self.pos_config.id)]
        })
        
    def test_payment_amount_validation(self):
        """æµ‹è¯•æ”¯ä»˜é‡‘é¢éªŒè¯"""
        # æµ‹è¯•è´Ÿé‡‘é¢
        with self.assertRaises(ValidationError):
            self.env['pos.payment'].create({
                'pos_order_id': None,  # ç®€åŒ–æµ‹è¯•
                'payment_method_id': self.wechat_payment_method.id,
                'amount': -100,
                'payment_date': fields.Datetime.now(),
            })
        
        # æµ‹è¯•é›¶é‡‘é¢
        with self.assertRaises(ValidationError):
            self.env['pos.payment'].create({
                'pos_order_id': None,
                'payment_method_id': self.wechat_payment_method.id,
                'amount': 0,
                'payment_date': fields.Datetime.now(),
            })
        
        # æµ‹è¯•è¶…å¤§é‡‘é¢
        with self.assertRaises(ValidationError):
            self.env['pos.payment'].create({
                'pos_order_id': None,
                'payment_method_id': self.wechat_payment_method.id,
                'amount': 1000000,  # 100ä¸‡
                'payment_date': fields.Datetime.now(),
            })
    
    def test_payment_code_validation(self):
        """æµ‹è¯•æ”¯ä»˜ç éªŒè¯"""
        scanner_manager = self.env['hardware.scanner'].create({
            'name': 'æµ‹è¯•æ‰«ç æª',
            'device_type': 'serial',
            'port': 'COM3'
        })
        
        # æµ‹è¯•æ— æ•ˆæ”¯ä»˜ç 
        invalid_codes = [
            '123456',  # å¤ªçŸ­
            '123456789012345678901234567890',  # å¤ªé•¿
            'ABCDEFGHIJKLMNOPQR',  # éæ•°å­—
            '12345678ABCDEFGHIJ',  # æ··åˆæ— æ•ˆå­—ç¬¦
        ]
        
        for code in invalid_codes:
            self.assertFalse(
                scanner_manager._is_payment_code(code),
                f"æ— æ•ˆæ”¯ä»˜ç åº”è¯¥è¢«æ‹’ç»: {code}"
            )
        
        # æµ‹è¯•æœ‰æ•ˆæ”¯ä»˜ç 
        valid_codes = [
            '134567890123456789',  # å¾®ä¿¡æ”¯ä»˜ç 
            '281234567890123456',  # æ”¯ä»˜å®æ”¯ä»˜ç 
        ]
        
        for code in valid_codes:
            result = scanner_manager._is_payment_code(code)
            self.assertTrue(
                result in ['wechat', 'alipay'],
                f"æœ‰æ•ˆæ”¯ä»˜ç åº”è¯¥è¢«è¯†åˆ«: {code}"
            )
    
    def test_payment_replay_protection(self):
        """æµ‹è¯•æ”¯ä»˜é‡æ”¾æ”»å‡»é˜²æŠ¤"""
        # åˆ›å»ºåŸå§‹æ”¯ä»˜
        original_payment = self.env['pos.payment'].create({
            'pos_order_id': None,
            'payment_method_id': self.wechat_payment_method.id,
            'amount': 100,
            'payment_date': fields.Datetime.now(),
            'transaction_id': 'ORIGINAL_TRANSACTION'
        })
        
        # æ¨¡æ‹Ÿé‡æ”¾æ”»å‡»ï¼šä½¿ç”¨ç›¸åŒçš„äº¤æ˜“ID
        with patch('payment_wechat.models.payment_wechat.WechatPayAPI.query_order') as mock_query:
            mock_query.return_value = {
                'trade_state': 'SUCCESS',
                'transaction_id': 'ORIGINAL_TRANSACTION'
            }
            
            # å°è¯•é‡å¤æ”¯ä»˜
            with self.assertRaises(ValidationError) as context:
                self.env['pos.payment'].create({
                    'pos_order_id': None,
                    'payment_method_id': self.wechat_payment_method.id,
                    'amount': 100,
                    'payment_date': fields.Datetime.now(),
                    'transaction_id': 'ORIGINAL_TRANSACTION'  # ç›¸åŒçš„äº¤æ˜“ID
                })
            
            self.assertIn('é‡å¤äº¤æ˜“', str(context.exception))
    
    def test_refund_security(self):
        """æµ‹è¯•é€€æ¬¾å®‰å…¨æ§åˆ¶"""
        # åˆ›å»ºæµ‹è¯•æ”¯ä»˜
        payment = self.env['pos.payment'].create({
            'pos_order_id': None,
            'payment_method_id': self.wechat_payment_method.id,
            'amount': 100,
            'payment_date': fields.Datetime.now(),
            'transaction_id': 'TEST_TRANSACTION'
        })
        
        # æµ‹è¯•è¶…æ—¶é€€æ¬¾ï¼ˆè¶…è¿‡24å°æ—¶ï¼‰
        old_date = fields.Datetime.to_string(
            fields.Datetime.from_string(payment.payment_date) - 
            timedelta(hours=25)
        )
        payment.payment_date = old_date
        
        with self.assertRaises(UserError) as context:
            payment.refund(100, 'æµ‹è¯•é€€æ¬¾')
        
        self.assertIn('è¶…è¿‡é€€æ¬¾æ—¶é—´', str(context.exception))
        
        # æµ‹è¯•è¶…é¢é€€æ¬¾
        with self.assertRaises(ValidationError) as context:
            payment.refund(200, 'æµ‹è¯•é€€æ¬¾')  # é€€æ¬¾é‡‘é¢è¶…è¿‡æ”¯ä»˜é‡‘é¢
        
        self.assertIn('é€€æ¬¾é‡‘é¢ä¸èƒ½è¶…è¿‡æ”¯ä»˜é‡‘é¢', str(context.exception))
    
    def test_api_rate_limiting(self):
        """æµ‹è¯•APIé¢‘ç‡é™åˆ¶"""
        from unittest.mock import Mock
        
        # æ¨¡æ‹Ÿé¢‘ç¹çš„APIè°ƒç”¨
        api_calls = []
        
        def mock_api_call():
            current_time = time.time()
            # ç§»é™¤60ç§’å‰çš„è°ƒç”¨è®°å½•
            api_calls[:] = [t for t in api_calls if current_time - t < 60]
            
            # æ£€æŸ¥é¢‘ç‡é™åˆ¶ï¼ˆæ¯åˆ†é’Ÿæœ€å¤š60æ¬¡ï¼‰
            if len(api_calls) >= 60:
                raise ValidationError('APIè°ƒç”¨é¢‘ç‡è¶…é™')
            
            api_calls.append(current_time)
            return {'success': True}
        
        # æµ‹è¯•æ­£å¸¸é¢‘ç‡
        for i in range(30):
            mock_api_call()  # åº”è¯¥æˆåŠŸ
        
        # æµ‹è¯•è¶…é¢‘ç‡
        with self.assertRaises(ValidationError) as context:
            for i in range(40):  # æ€»å…±ä¼šè¾¾åˆ°70æ¬¡
                mock_api_call()
        
        self.assertIn('APIè°ƒç”¨é¢‘ç‡è¶…é™', str(context.exception))
```

**ä»»åŠ¡2ï¼šPCI DSSåˆè§„æ£€æŸ¥**
```python
# file: security/pci_dss_checker.py

import re
import hashlib
import base64
from typing import Dict, List, Tuple
from cryptography.fernet import Fernet

class PCIDSSChecker:
    """PCI DSSåˆè§„æ£€æŸ¥å™¨"""
    
    def __init__(self):
        self.requirements = self._load_pci_requirements()
        
    def _load_pci_requirements(self) -> Dict:
        """åŠ è½½PCI DSSè¦æ±‚"""
        return {
            '3.2': 'ä¸è¦å­˜å‚¨æ•æ„Ÿçš„éªŒè¯æ•°æ®',
            '3.3': 'å±è”½PANï¼ˆä¸»è´¦å·ï¼‰æ˜¾ç¤º',
            '3.4': 'æ¸²æŸ“PANä¸å¯è¯»',
            '4.1': 'åœ¨å¼€æ”¾ç½‘ç»œä¸ŠåŠ å¯†ä¼ è¾“æŒå¡äººæ•°æ®',
            '6.5': 'è§£å†³å¸¸è§ç¼–ç æ¼æ´',
            '8.2': 'éªŒè¯ç”¨æˆ·èº«ä»½',
            '10.1': 'å®æ–½å®¡è®¡è·Ÿè¸ª',
        }
    
    def check_sensitive_data_storage(self, code_content: str) -> List[Tuple[str, str]]:
        """æ£€æŸ¥æ•æ„Ÿæ•°æ®å­˜å‚¨"""
        violations = []
        
        # PANï¼ˆä¿¡ç”¨å¡å·ï¼‰æ¨¡å¼
        pan_patterns = [
            r'\b\d{13,19}\b',  # ä¿¡ç”¨å¡å·
            r'card_?number\s*[:=]\s*["\']?\d+["\']?',
            r'credit_?card\s*[:=]\s*["\']?\d+["\']?',
        ]
        
        # CVVæ¨¡å¼
        cvv_patterns = [
            r'\b\d{3,4}\b',  # CVV/CVC
            r'cvv\s*[:=]\s*["\']?\d+["\']?',
            r'security_?code\s*[:=]\s*["\']?\d+["\']?',
        ]
        
        # è¿‡æœŸæ—¥æœŸæ¨¡å¼
        expiry_patterns = [
            r'expir(?:y|ation)\s*[:=]\s*["\']?\d{2}[/-]\d{2,4}["\']?',
            r'valid_?thru\s*[:=]\s*["\']?\d+["\']?',
        ]
        
        # æ£€æŸ¥PAN
        for pattern in pan_patterns:
            matches = re.finditer(pattern, code_content, re.IGNORECASE)
            for match in matches:
                if self._is_valid_pan(match.group()):
                    violations.append((
                        '3.2',
                        f'å‘ç°æ½œåœ¨çš„PANå­˜å‚¨: {match.group()} (è¡Œ: {self._get_line_number(code_content, match.start())})'
                    ))
        
        # æ£€æŸ¥CVV
        for pattern in cvv_patterns:
            matches = re.finditer(pattern, code_content, re.IGNORECASE)
            for match in matches:
                violations.append((
                    '3.2',
                    f'å‘ç°CVVå­˜å‚¨: {match.group()} (è¡Œ: {self._get_line_number(code_content, match.start())})'
                ))
        
        return violations
    
    def _is_valid_pan(self, number: str) -> bool:
        """ä½¿ç”¨Luhnç®—æ³•éªŒè¯å¡å·"""
        def luhn_checksum(card_number):
            def digits_of(n):
                return [int(d) for d in str(n)]
            digits = digits_of(card_number)
            odd_digits = digits[-1::-2]
            even_digits = digits[-2::-2]
            checksum = sum(odd_digits)
            for d in even_digits:
                checksum += sum(digits_of(d*2))
            return checksum % 10
        
        # æå–æ•°å­—
        digits = re.sub(r'\D', '', number)
        
        if len(digits) < 13 or len(digits) > 19:
            return False
        
        return luhn_checksum(digits) == 0
    
    def _get_line_number(self, content: str, position: int) -> int:
        """è·å–æŒ‡å®šä½ç½®çš„è¡Œå·"""
        return content[:position].count('\n') + 1
    
    def check_encryption(self, config: Dict) -> List[Tuple[str, str]]:
        """æ£€æŸ¥åŠ å¯†é…ç½®"""
        violations = []
        
        # æ£€æŸ¥HTTPSé…ç½®
        if not config.get('https_enabled', False):
            violations.append(('4.1', 'æœªå¯ç”¨HTTPS'))
        
        # æ£€æŸ¥TLSç‰ˆæœ¬
        tls_version = config.get('tls_version', '')
        if tls_version and tls_version < '1.2':
            violations.append(('4.1', f'TLSç‰ˆæœ¬è¿‡ä½: {tls_version}ï¼Œåº”ä½¿ç”¨TLS 1.2+'))
        
        # æ£€æŸ¥åŠ å¯†ç®—æ³•
        if config.get('weak_ciphers', False):
            violations.append(('4.1', 'æ£€æµ‹åˆ°å¼±åŠ å¯†ç®—æ³•'))
        
        return violations
    
    def check_authentication(self, auth_config: Dict) -> List[Tuple[str, str]]:
        """æ£€æŸ¥èº«ä»½éªŒè¯"""
        violations = []
        
        # æ£€æŸ¥å¯†ç ç­–ç•¥
        password_policy = auth_config.get('password_policy', {})
        
        if password_policy.get('min_length', 0) < 8:
            violations.append(('8.2', 'å¯†ç æœ€å°é•¿åº¦åº”è‡³å°‘ä¸º8ä¸ªå­—ç¬¦'))
        
        if not password_policy.get('require_complexity', False):
            violations.append(('8.2', 'å¯†ç åº”è¦æ±‚å¤æ‚æ€§ï¼ˆå¤§å°å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦ï¼‰'))
        
        if password_policy.get('max_age', 0) > 90:
            violations.append(('8.2', 'å¯†ç æœ€é•¿ä½¿ç”¨æœŸé™ä¸åº”è¶…è¿‡90å¤©'))
        
        # æ£€æŸ¥å¤šå› ç´ è®¤è¯
        if not auth_config.get('multi_factor_auth', False):
            violations.append(('8.2', 'å»ºè®®å®æ–½å¤šå› ç´ è®¤è¯'))
        
        # æ£€æŸ¥ä¼šè¯ç®¡ç†
        session_config = auth_config.get('session', {})
        if session_config.get('timeout', 0) > 900:  # 15åˆ†é’Ÿ
            violations.append(('8.2', 'ä¼šè¯è¶…æ—¶æ—¶é—´ä¸åº”è¶…è¿‡15åˆ†é’Ÿ'))
        
        return violations
    
    def check_logging(self, logging_config: Dict) -> List[Tuple[str, str]]:
        """æ£€æŸ¥å®¡è®¡æ—¥å¿—"""
        violations = []
        
        required_events = [
            'user_login',
            'user_logout',
            'payment_created',
            'payment_refunded',
            'sensitive_data_access',
        ]
        
        logged_events = logging_config.get('events', [])
        
        for event in required_events:
            if event not in logged_events:
                violations.append(('10.1', f'ç¼ºå°‘å¿…è¦çš„äº‹ä»¶æ—¥å¿—: {event}'))
        
        # æ£€æŸ¥æ—¥å¿—ä¿ç•™
        retention_days = logging_config.get('retention_days', 0)
        if retention_days < 365:
            violations.append(('10.1', f'æ—¥å¿—ä¿ç•™æ—¶é—´ä¸è¶³365å¤©ï¼Œå½“å‰: {retention_days}å¤©'))
        
        return violations
    
    def generate_compliance_report(self, code_files: List[str], config: Dict) -> Dict:
        """ç”Ÿæˆåˆè§„æŠ¥å‘Š"""
        report = {
            'requirements': self.requirements,
            'violations': [],
            'recommendations': [],
            'compliance_score': 0,
        }
        
        total_violations = 0
        
        # æ£€æŸ¥ä»£ç æ–‡ä»¶
        for file_path in code_files:
            try:
                with open(file_path, 'r', encoding='utf-8') as f:
                    content = f.read()
                
                # æ£€æŸ¥æ•æ„Ÿæ•°æ®å­˜å‚¨
                violations = self.check_sensitive_data_storage(content)
                if violations:
                    report['violations'].extend(violations)
                    total_violations += len(violations)
                    
            except Exception as e:
                report['violations'].append((
                    'GENERAL',
                    f'æ— æ³•æ£€æŸ¥æ–‡ä»¶ {file_path}: {str(e)}'
                ))
        
        # æ£€æŸ¥é…ç½®
        encryption_violations = self.check_encryption(config.get('encryption', {}))
        auth_violations = self.check_authentication(config.get('authentication', {}))
        logging_violations = self.check_logging(config.get('logging', {}))
        
        all_violations = encryption_violations + auth_violations + logging_violations
        report['violations'].extend(all_violations)
        total_violations += len(all_violations)
        
        # è®¡ç®—åˆè§„åˆ†æ•°
        total_requirements = len(self.requirements)
        if total_requirements > 0:
            report['compliance_score'] = max(0, 100 - (total_violations * 100 / total_requirements))
        
        # ç”Ÿæˆå»ºè®®
        if total_violations > 0:
            report['recommendations'] = [
                'å®æ–½æ•°æ®è„±æ•å’Œå±è”½',
                'ç¡®ä¿æ‰€æœ‰æ•æ„Ÿæ•°æ®ä¼ è¾“éƒ½ä½¿ç”¨TLS 1.2+',
                'å®æ–½å¼ºå¯†ç ç­–ç•¥å’Œå¤šå› ç´ è®¤è¯',
                'ç¡®ä¿å®¡è®¡æ—¥å¿—åŒ…å«æ‰€æœ‰å¿…è¦äº‹ä»¶å¹¶ä¿ç•™è‡³å°‘ä¸€å¹´',
                'å®šæœŸè¿›è¡Œå®‰å…¨ä»£ç å®¡æŸ¥',
            ]
        
        return report
```

#### **ç¬¬8å‘¨ï¼šæ€§èƒ½ä¸å‹åŠ›æµ‹è¯•**

**ä»»åŠ¡3ï¼šPOSæ”¯ä»˜æ€§èƒ½æµ‹è¯•**
```python
# file: tests/performance/test_pos_performance.py

import pytest
import time
import statistics
import asyncio
from datetime import datetime, timedelta
from odoo.tests.common import TransactionCase, tagged

@tagged('performance', 'pos', 'post_install', '-at_install')
class TestPosPerformance(TransactionCase):
    """POSæ”¯ä»˜æ€§èƒ½æµ‹è¯•"""
    
    def setUp(self):
        super(TestPosPerformance, self).setUp()
        
        # åˆ›å»ºæµ‹è¯•æ•°æ®
        self.num_test_payments = 100
        self.payments = []
        
        # åˆ›å»ºæ”¯ä»˜æ–¹æ³•
        self.wechat_method = self.env['pos.payment.method'].create({
            'name': 'å¾®ä¿¡æ”¯ä»˜æ€§èƒ½æµ‹è¯•',
            'use_payment_terminal': 'wechat',
            'wechat_payment_type': 'barcode',
        })
        
    def test_payment_creation_performance(self):
        """æµ‹è¯•æ”¯ä»˜åˆ›å»ºæ€§èƒ½"""
        creation_times = []
        
        for i in range(self.num_test_payments):
            start_time = time.time()
            
            payment = self.env['pos.payment'].create({
                'pos_order_id': None,
                'payment_method_id': self.wechat_method.id,
                'amount': 100.00,
                'payment_date': fields.Datetime.now(),
            })
            
            end_time = time.time()
            creation_times.append(end_time - start_time)
            
            self.payments.append(payment)
        
        # è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
        avg_time = statistics.mean(creation_times)
        max_time = max(creation_times)
        min_time = min(creation_times)
        
        print(f"\næ”¯ä»˜åˆ›å»ºæ€§èƒ½æµ‹è¯• (n={self.num_test_payments}):")
        print(f"å¹³å‡æ—¶é—´: {avg_time:.4f}ç§’")
        print(f"æœ€é•¿æ—¶é—´: {max_time:.4f}ç§’")
        print(f"æœ€çŸ­æ—¶é—´: {min_time:.4f}ç§’")
        
        # æ€§èƒ½æ–­è¨€
        assert avg_time < 0.1, f"æ”¯ä»˜åˆ›å»ºå¹³å‡æ—¶é—´è¿‡é•¿: {avg_time:.4f}ç§’"
        assert max_time < 0.5, f"æ”¯ä»˜åˆ›å»ºæœ€é•¿æ—¶é—´è¿‡é•¿: {max_time:.4f}ç§’"
    
    def test_concurrent_payments(self):
        """æµ‹è¯•å¹¶å‘æ”¯ä»˜å¤„ç†"""
        import threading
        
        results = []
        errors = []
        lock = threading.Lock()
        
        def create_payment(payment_id):
            try:
                start_time = time.time()
                
                with self.env.cr.savepoint():
                    payment = self.env['pos.payment'].create({
                        'pos_order_id': None,
                        'payment_method_id': self.wechat_method.id,
                        'amount': 100.00,
                        'payment_date': fields.Datetime.now(),
                    })
                
                end_time = time.time()
                
                with lock:
                    results.append({
                        'payment_id': payment_id,
                        'time': end_time - start_time,
                        'success': True
                    })
                    
            except Exception as e:
                with lock:
                    errors.append({
                        'payment_id': payment_id,
                        'error': str(e)
                    })
        
        # åˆ›å»ºå¹¶å‘çº¿ç¨‹
        threads = []
        for i in range(10):  # 10ä¸ªå¹¶å‘çº¿ç¨‹
            thread = threading.Thread(target=create_payment, args=(i,))
            threads.append(thread)
        
        # å¯åŠ¨æ‰€æœ‰çº¿ç¨‹
        start_total = time.time()
        for thread in threads:
            thread.start()
        
        # ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
        for thread in threads:
            thread.join()
        end_total = time.time()
        
        total_time = end_total - start_total
        
        print(f"\nå¹¶å‘æ”¯ä»˜æµ‹è¯•:")
        print(f"æ€»æ—¶é—´: {total_time:.2f}ç§’")
        print(f"æˆåŠŸæ”¯ä»˜: {len(results)}")
        print(f"å¤±è´¥æ”¯ä»˜: {len(errors)}")
        
        if results:
            times = [r['time'] for r in results]
            print(f"å¹³å‡æ”¯ä»˜æ—¶é—´: {statistics.mean(times):.4f}ç§’")
            print(f"TPS (æ¯ç§’äº¤æ˜“æ•°): {len(results) / total_time:.2f}")
        
        assert len(errors) == 0, f"å¹¶å‘æ”¯ä»˜å‡ºç°é”™è¯¯: {errors}"
        assert total_time < 5, f"å¹¶å‘æ”¯ä»˜æ€»æ—¶é—´è¿‡é•¿: {total_time:.2f}ç§’"
    
    def test_database_query_performance(self):
        """æµ‹è¯•æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½"""
        # é¦–å…ˆåˆ›å»ºä¸€äº›æµ‹è¯•æ•°æ®
        test_payments = []
        for i in range(1000):
            payment = self.env['pos.payment'].create({
                'pos_order_id': None,
                'payment_method_id': self.wechat_method.id,
                'amount': (i % 100) + 1,  # 1-100
                'payment_date': fields.Datetime.now() - timedelta(hours=i),
            })
            test_payments.append(payment)
        
        self.env.cr.commit()
        
        # æµ‹è¯•ç®€å•æŸ¥è¯¢
        start_time = time.time()
        payments = self.env['pos.payment'].search([], limit=100)
        simple_query_time = time.time() - start_time
        
        # æµ‹è¯•æ¡ä»¶æŸ¥è¯¢
        start_time = time.time()
        payments = self.env['pos.payment'].search([
            ('amount', '>', 50),
            ('payment_date', '>=', fields.Datetime.to_string(datetime.now() - timedelta(days=7)))
        ])
        filtered_query_time = time.time() - start_time
        
        # æµ‹è¯•èšåˆæŸ¥è¯¢
        start_time = time.time()
        self.env.cr.execute("""
            SELECT 
                payment_method_id,
                COUNT(*) as count,
                SUM(amount) as total
            FROM pos_payment
            WHERE payment_date >= %s
            GROUP BY payment_method_id
        """, (fields.Datetime.to_string(datetime.now() - timedelta(days=30)),))
        results = self.env.cr.fetchall()
        aggregate_query_time = time.time() - start_time
        
        print(f"\næ•°æ®åº“æŸ¥è¯¢æ€§èƒ½:")
        print(f"ç®€å•æŸ¥è¯¢ (100æ¡): {simple_query_time:.4f}ç§’")
        print(f"æ¡ä»¶æŸ¥è¯¢: {filtered_query_time:.4f}ç§’")
        print(f"èšåˆæŸ¥è¯¢: {aggregate_query_time:.4f}ç§’")
        
        assert simple_query_time < 0.1, f"ç®€å•æŸ¥è¯¢æ—¶é—´è¿‡é•¿: {simple_query_time:.4f}ç§’"
        assert filtered_query_time < 0.2, f"æ¡ä»¶æŸ¥è¯¢æ—¶é—´è¿‡é•¿: {filtered_query_time:.4f}ç§’"
        assert aggregate_query_time < 0.3, f"èšåˆæŸ¥è¯¢æ—¶é—´è¿‡é•¿: {aggregate_query_time:.4f}ç§’"
    
    def test_memory_usage(self):
        """æµ‹è¯•å†…å­˜ä½¿ç”¨æƒ…å†µ"""
        import psutil
        import os
        
        process = psutil.Process(os.getpid())
        
        # è®°å½•åˆå§‹å†…å­˜
        initial_memory = process.memory_info().rss / 1024 / 1024  # MB
        
        # åˆ›å»ºå¤§é‡æ”¯ä»˜å¯¹è±¡
        payments = []
        for i in range(1000):
            payment = self.env['pos.payment'].create({
                'pos_order_id': None,
                'payment_method_id': self.wechat_method.id,
                'amount': 100.00,
                'payment_date': fields.Datetime.now(),
            })
            payments.append(payment)
            
            # å®šæœŸæ£€æŸ¥å†…å­˜
            if i % 100 == 0:
                current_memory = process.memory_info().rss / 1024 / 1024
                print(f"åˆ›å»º {i} ä¸ªæ”¯ä»˜åå†…å­˜: {current_memory:.2f} MB")
        
        # æœ€ç»ˆå†…å­˜
        final_memory = process.memory_info().rss / 1024 / 1024
        memory_increase = final_memory - initial_memory
        
        print(f"\nå†…å­˜ä½¿ç”¨æµ‹è¯•:")
        print(f"åˆå§‹å†…å­˜: {initial_memory:.2f} MB")
        print(f"æœ€ç»ˆå†…å­˜: {final_memory:.2f} MB")
        print(f"å†…å­˜å¢é•¿: {memory_increase:.2f} MB")
        print(f"æ¯ä¸ªæ”¯ä»˜å¹³å‡å†…å­˜: {memory_increase / len(payments):.4f} MB")
        
        # æ¸…ç†
        self.env.cr.rollback()
        
        assert memory_increase < 50, f"å†…å­˜å¢é•¿è¿‡å¤§: {memory_increase:.2f} MB"
```

---

## ğŸ“Š ç¬¬7-8å‘¨è¿›åº¦è·Ÿè¸ª

### **æ¯æ—¥ç«™ä¼šé‡ç‚¹**ï¼š
```
ç¬¬7å‘¨é‡ç‚¹ï¼š
å‘¨ä¸€ï¼šPOSæ”¯ä»˜ç»ˆç«¯APIè®¾è®¡è¯„å®¡
å‘¨äºŒï¼šå¾®ä¿¡POSæ¥å£å®ç°
å‘¨ä¸‰ï¼šå‰ç«¯POSç»„ä»¶å¼€å‘
å‘¨å››ï¼šæ‰«ç æªé›†æˆæ–¹æ¡ˆ
å‘¨äº”ï¼šç¬¬ä¸€é˜¶æ®µæˆæœæ¼”ç¤ºä¸è¯„å®¡

ç¬¬8å‘¨é‡ç‚¹ï¼š
å‘¨ä¸€ï¼šå¤šå±å¹•é€‚é…æ–¹æ¡ˆ
å‘¨äºŒï¼šå°ç¥¨æ‰“å°æ‰©å±•
å‘¨ä¸‰ï¼šæ€§èƒ½ä¸å®‰å…¨æµ‹è¯•
å‘¨å››ï¼šé›†æˆæµ‹è¯•
å‘¨äº”ï¼šç¬¬äºŒé˜¶æ®µä¸­æœŸè¯„å®¡
```

### **å…³é”®äº¤ä»˜ç‰©æ£€æŸ¥ç‚¹ï¼ˆç¬¬8å‘¨æœ«ï¼‰**ï¼š

#### **åç«¯å¼€å‘äº¤ä»˜ç‰©**ï¼š
- [ ] `pos_payment_wechat`æ¨¡å—å®Œæ•´å®ç°
- [ ] POSæ”¯ä»˜ç»ˆç«¯API
- [ ] æ‰«ç æªç¡¬ä»¶é›†æˆ
- [ ] å°ç¥¨æ‰“å°æ‰©å±•
- [ ] æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–

#### **å‰ç«¯å¼€å‘äº¤ä»˜ç‰©**ï¼š
- [ ] POSå¾®ä¿¡æ”¯ä»˜OWLç»„ä»¶
- [ ] æ”¯ä»˜ç•Œé¢å“åº”å¼è®¾è®¡
- [ ] å¤šå±å¹•é€‚é…æ–¹æ¡ˆ
- [ ] å°ç¥¨æ¨¡æ¿æ‰©å±•

#### **å¾®ä¿¡å¼€å‘ä¸“å®¶äº¤ä»˜ç‰©**ï¼š
- [ ] å¾®ä¿¡POSæ”¯ä»˜APIå°è£…
- [ ] æ”¯ä»˜çŠ¶æ€è½®è¯¢ä¼˜åŒ–
- [ ] ç¡¬ä»¶é€šä¿¡åè®®
- [ ] æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

#### **å®‰å…¨å®¡æŸ¥ä¸“å®¶äº¤ä»˜ç‰©**ï¼š
- [ ] POSæ”¯ä»˜å®‰å…¨æµ‹è¯•ç”¨ä¾‹
- [ ] PCI DSSåˆè§„æ£€æŸ¥æŠ¥å‘Š
- [ ] æ€§èƒ½å‹åŠ›æµ‹è¯•æŠ¥å‘Š
- [ ] å®‰å…¨å®¡è®¡æŠ¥å‘Š

---

## ğŸ”§ å¼€å‘ç¯å¢ƒé…ç½®æ›´æ–°

### **POSæµ‹è¯•ç¯å¢ƒè¦æ±‚**ï¼š
```yaml
# ç¡¬ä»¶è®¾å¤‡
æ‰«ç æª: USB/ä¸²å£æ‰«ç æªè‡³å°‘1å°
æ‰“å°æœº: çƒ­æ•æ‰“å°æœºï¼ˆæ”¯æŒESC/POSæŒ‡ä»¤ï¼‰
æ”¶é“¶æœº: è§¦æ‘¸å±è®¾å¤‡ï¼Œåˆ†è¾¨ç‡è‡³å°‘1280x800
ç½‘ç»œ: ç¨³å®šçš„WiFiæˆ–ä»¥å¤ªç½‘è¿æ¥

# æµ‹è¯•æ•°æ®
æµ‹è¯•å•†æˆ·å·: å¾®ä¿¡/æ”¯ä»˜å®æ²™ç®±å•†æˆ·å·
æµ‹è¯•è¯ä¹¦: å¾®ä¿¡æ”¯ä»˜APIè¯ä¹¦
æµ‹è¯•å¡å·: å¾®ä¿¡/æ”¯ä»˜å®æµ‹è¯•ä»˜æ¬¾ç 
```

### **æµ‹è¯•æ•°æ®å‡†å¤‡**ï¼š
```python
# æµ‹è¯•æ•°æ®ç”Ÿæˆè„šæœ¬
python scripts/generate_test_data.py \
    --payments 1000 \
    --methods wechat,alipay \
    --amount-range 1-1000 \
    --date-range "2024-01-01 to 2024-01-31"
```

---

## ğŸš¨ ç¬¬äºŒé˜¶æ®µé£é™©ç®¡ç†

### **æ–°å¢é£é™©**ï¼š
| é£é™© | å½±å“ | æ¦‚ç‡ | åº”å¯¹æªæ–½ | è´Ÿè´£äºº |
|------|------|------|----------|--------|
| ç¡¬ä»¶å…¼å®¹æ€§é—®é¢˜ | é«˜ | ä¸­ | 1. å¤šè®¾å¤‡æµ‹è¯• 2. å¤‡ç”¨æ–¹æ¡ˆ 3. é€šç”¨åè®® | åç«¯å¼€å‘ |
| POSæ€§èƒ½ç“¶é¢ˆ | ä¸­ | ä¸­ | 1. æ€§èƒ½æµ‹è¯• 2. ä»£ç ä¼˜åŒ– 3. ç¼“å­˜ç­–ç•¥ | å®‰å…¨ä¸“å®¶ |
| ç¦»çº¿æ”¯ä»˜å¤„ç† | é«˜ | ä½ | 1. æœ¬åœ°ç¼“å­˜ 2. åŒæ­¥æœºåˆ¶ 3. å†²çªè§£å†³ | å¾®ä¿¡ä¸“å®¶ |

### **æŠ€æœ¯éš¾ç‚¹**ï¼š
1. **æ‰«ç æªå¤šè®¾å¤‡å…¼å®¹**ï¼šå®ç°ç»Ÿä¸€çš„è®¾å¤‡æ¥å£å±‚
2. **ç¦»çº¿äº¤æ˜“å¤„ç†**ï¼šè®¾è®¡å¯é çš„æ•°æ®åŒæ­¥æœºåˆ¶
3. **æ‰“å°æ ¼å¼é€‚é…**ï¼šæ”¯æŒå¤šç§æ‰“å°æœºå‹å·

---

## ğŸ“ˆ è´¨é‡æŒ‡æ ‡ï¼ˆç¬¬8å‘¨æœ«ï¼‰

### **æ€§èƒ½æŒ‡æ ‡**ï¼š
1. POSæ”¯ä»˜åˆ›å»ºæ—¶é—´ < 100ms
2. å¹¶å‘æ”¯ä»˜å¤„ç†èƒ½åŠ› > 50 TPS
3. å†…å­˜å¢é•¿ < 50MB/1000ç¬”æ”¯ä»˜
4. æ•°æ®åº“æŸ¥è¯¢æ—¶é—´ < 200ms

### **å®‰å…¨æŒ‡æ ‡**ï¼š
1. é€šè¿‡æ‰€æœ‰PCI DSSæ£€æŸ¥é¡¹
2. æ— é«˜å±å®‰å…¨æ¼æ´
3. æ”¯ä»˜é‡æ”¾æ”»å‡»é˜²æŠ¤100%
4. æ•æ„Ÿæ•°æ®æ³„éœ²é˜²æŠ¤

### **åŠŸèƒ½æŒ‡æ ‡**ï¼š
1. æ”¯æŒä¸»æ‰«/è¢«æ‰«ä¸¤ç§æ¨¡å¼
2. æ”¯æŒå¤šå±å¹•æ˜¾ç¤º
3. å®Œæ•´çš„å°ç¥¨æ‰“å°
4. ç¡¬ä»¶è®¾å¤‡å…¼å®¹æ€§ > 90%

---

## ğŸ¯ ç¬¬7-8å‘¨æˆåŠŸæ ‡å‡†

1. **åŠŸèƒ½å®Œæ•´æ€§**ï¼šPOSå¾®ä¿¡æ”¯ä»˜å…¨æµç¨‹è·‘é€š
2. **æ€§èƒ½è¾¾æ ‡**ï¼šæ»¡è¶³æ‰€æœ‰æ€§èƒ½æŒ‡æ ‡
3. **å®‰å…¨åˆè§„**ï¼šé€šè¿‡å®‰å…¨å®¡è®¡
4. **ç”¨æˆ·ä½“éªŒ**ï¼šç•Œé¢æµç•…ï¼Œæ“ä½œä¾¿æ·
5. **æ–‡æ¡£å®Œæ•´**ï¼šå¼€å‘æ–‡æ¡£ã€APIæ–‡æ¡£ã€ç”¨æˆ·æ‰‹å†Œ

---

**ç¬¬äºŒé˜¶æ®µå·¥ä½œæ­£å¼å¯åŠ¨ï¼** å„ä¸“å®¶æŒ‰ç…§åˆ†é…çš„ä»»åŠ¡å¼€å§‹ç¬¬7-8å‘¨çš„å·¥ä½œã€‚POSæ”¯ä»˜æ˜¯çº¿ä¸‹æ”¯ä»˜çš„æ ¸å¿ƒåœºæ™¯ï¼Œéœ€è¦ç‰¹åˆ«æ³¨é‡ç¨³å®šæ€§å’Œç”¨æˆ·ä½“éªŒã€‚

**æœ¬å‘¨é‡ç‚¹æé†’**ï¼š
1. ç¡¬ä»¶é›†æˆè¦è€ƒè™‘å¤šè®¾å¤‡å…¼å®¹æ€§
2. ç¦»çº¿åœºæ™¯ä¸‹çš„æ”¯ä»˜å¤„ç†
3. æ€§èƒ½æµ‹è¯•è¦æ¨¡æ‹ŸçœŸå®å‹åŠ›åœºæ™¯
4. å®‰å…¨æµ‹è¯•è¦è¦†ç›–æ‰€æœ‰æ”¯ä»˜æµç¨‹

**ä»Šæ—¥é‡ç‚¹å·¥ä½œ**ï¼š
1. åç«¯å¼€å‘ï¼šè®¾è®¡POSæ”¯ä»˜ç»ˆç«¯API
2. å‰ç«¯å¼€å‘ï¼šåˆ›å»ºPOSæ”¯ä»˜ç»„ä»¶æ¡†æ¶
3. å¾®ä¿¡å¼€å‘ä¸“å®¶ï¼šå°è£…å¾®ä¿¡POSæ”¯ä»˜æ¥å£
4. å®‰å…¨å®¡æŸ¥ä¸“å®¶ï¼šåˆ¶å®šPOSå®‰å…¨æµ‹è¯•æ–¹æ¡ˆ

**ä»Šæ—¥ç«™ä¼šæ—¶é—´**ï¼šä¸‹åˆ4:00ï¼Œè®¨è®ºPOSæ”¯ä»˜æ¶æ„è®¾è®¡ã€‚
# ğŸš€ ç¬¬ä¸‰é˜¶æ®µï¼šå¾®ä¿¡å…¬ä¼—å·ç®¡ç†å¹³å°å¯åŠ¨è®¡åˆ’ï¼ˆç¬¬11-14å‘¨ï¼‰

## ğŸ“‹ ç¬¬ä¸‰é˜¶æ®µæ€»ä½“ç›®æ ‡

**æ ¸å¿ƒç›®æ ‡**ï¼šå®ç°å®Œæ•´çš„å¾®ä¿¡å…¬ä¼—å·ç®¡ç†å¹³å°ï¼ŒåŒ…æ‹¬ç²‰ä¸ç®¡ç†ã€æ¶ˆæ¯å¤„ç†ã€èœå•ç®¡ç†ã€ç´ æç®¡ç†ç­‰åŠŸèƒ½ï¼Œå¹¶ä¸Odoo CRMæ¨¡å—æ·±åº¦é›†æˆ
**æ—¶é—´è·¨åº¦**ï¼šç¬¬11-14å‘¨ï¼ˆå…±4å‘¨ï¼‰
**å…³é”®é‡Œç¨‹ç¢‘**ï¼š
1. å¾®ä¿¡åŸºç¡€æ¡†æ¶æ­å»ºï¼ˆç¬¬11å‘¨ï¼‰
2. ç²‰ä¸ç®¡ç†ä¸æ¶ˆæ¯å¤„ç†ï¼ˆç¬¬12-13å‘¨ï¼‰
3. é«˜çº§åŠŸèƒ½ä¸Odooé›†æˆï¼ˆç¬¬14å‘¨ï¼‰

---

## ğŸ“… ç¬¬11å‘¨ï¼šå¾®ä¿¡åŸºç¡€æ¡†æ¶æ­å»º

### **Pythonä¸“å®¶è°ƒåº¦æŒ‡ä»¤ï¼š**
```
æœ¬å‘¨é‡ç‚¹ï¼šæ­å»ºå¾®ä¿¡å…¬ä¼—å·ç®¡ç†åŸºç¡€æ¡†æ¶ï¼Œå®ç°æ ¸å¿ƒçš„å¾®ä¿¡APIå®¢æˆ·ç«¯å’Œå…¬ä¼—å·é…ç½®ç®¡ç†
æŠ€æœ¯è¦ç‚¹ï¼š
1. åˆ›å»ºwechat_commonæ¨¡å—ï¼Œå°è£…å¾®ä¿¡APIå®¢æˆ·ç«¯
2. å®ç°Access Tokenè‡ªåŠ¨ç®¡ç†æœºåˆ¶
3. è®¾è®¡å…¬ä¼—å·é…ç½®ç®¡ç†æ¨¡å‹
4. å®ç°å¾®ä¿¡æœåŠ¡å™¨éªŒè¯å’Œæ¶ˆæ¯åŠ è§£å¯†
å¼€å‘é¡ºåºï¼šå¾®ä¿¡APIå®¢æˆ·ç«¯ â†’ Tokenç®¡ç† â†’ å…¬ä¼—å·é…ç½® â†’ æ¶ˆæ¯åŠ è§£å¯†
```

### **åç«¯å¼€å‘å…·ä½“ä»»åŠ¡ï¼š**

#### **ä»»åŠ¡1ï¼šåˆ›å»ºwechat_commonæ¨¡å—ç»“æ„**
```bash
# åˆ›å»ºwechat_commonåŸºç¡€æ¨¡å—
mkdir -p wechat_common/{models,controllers,views,security,wizards,data,tests,lib,static/src/{js,xml,css}}

# åˆ›å»º__manifest__.py
cat > wechat_common/__manifest__.py << 'EOF'
{
    'name': 'å¾®ä¿¡é€šç”¨å·¥å…·åº“',
    'version': '1.0.0',
    'category': 'WeChat',
    'summary': 'å¾®ä¿¡ç”Ÿæ€é›†æˆé€šç”¨å·¥å…·åº“',
    'description': '''
        æä¾›å¾®ä¿¡APIå®¢æˆ·ç«¯ã€Tokenç®¡ç†ã€æ¶ˆæ¯åŠ è§£å¯†ç­‰é€šç”¨åŠŸèƒ½
    ''',
    'depends': ['base', 'web'],
    'data': [
        'security/ir.model.access.csv',
        'views/res_config_settings_views.xml',
    ],
    'assets': {
        'web.assets_backend': [
            'wechat_common/static/src/js/wechat_common.js',
        ],
    },
    'external_dependencies': {
        'python': ['cryptography', 'requests', 'xmltodict'],
    },
    'installable': True,
    'application': False,
    'auto_install': False,
}
EOF
```

#### **ä»»åŠ¡2ï¼šå®ç°å¾®ä¿¡APIå®¢æˆ·ç«¯æ ¸å¿ƒ**
```python
# file: wechat_common/lib/wechat_api_client.py

import requests
import json
import time
import hashlib
import hmac
import base64
from typing import Dict, Optional, List, Any
from datetime import datetime, timedelta
from urllib.parse import urljoin
import logging

_logger = logging.getLogger(__name__)

class WechatAPIError(Exception):
    """å¾®ä¿¡APIå¼‚å¸¸"""
    pass

class WechatAPIClient:
    """å¾®ä¿¡å…¬ä¼—å¹³å°APIå®¢æˆ·ç«¯"""
    
    # APIåŸºç¡€URL
    API_BASE_URL = "https://api.weixin.qq.com"
    
    def __init__(self, app_id: str, app_secret: str, 
                 access_token: Optional[str] = None,
                 token_expires_at: Optional[datetime] = None):
        self.app_id = app_id
        self.app_secret = app_secret
        self._access_token = access_token
        self._token_expires_at = token_expires_at
        self._session = requests.Session()
        self._session.headers.update({
            'User-Agent': 'Odoo-Wechat-Platform/1.0',
            'Content-Type': 'application/json'
        })
    
    def _request(self, method: str, endpoint: str, 
                 params: Optional[Dict] = None,
                 data: Optional[Dict] = None,
                 files: Optional[Dict] = None,
                 require_token: bool = True) -> Dict:
        """å‘é€HTTPè¯·æ±‚"""
        # å¦‚æœéœ€è¦Tokenï¼Œè‡ªåŠ¨è·å–
        if require_token:
            if not self._is_token_valid():
                self._refresh_access_token()
            params = params or {}
            params['access_token'] = self._access_token
        
        url = urljoin(self.API_BASE_URL, endpoint)
        
        try:
            if method.upper() == 'GET':
                response = self._session.get(url, params=params, timeout=10)
            elif method.upper() == 'POST':
                if files:
                    response = self._session.post(url, data=data, files=files, timeout=30)
                else:
                    response = self._session.post(url, params=params, json=data, timeout=10)
            elif method.upper() == 'PUT':
                response = self._session.put(url, params=params, json=data, timeout=10)
            elif method.upper() == 'DELETE':
                response = self._session.delete(url, params=params, timeout=10)
            else:
                raise ValueError(f"Unsupported HTTP method: {method}")
            
            response.raise_for_status()
            result = response.json()
            
            # æ£€æŸ¥å¾®ä¿¡APIé”™è¯¯
            if 'errcode' in result and result['errcode'] != 0:
                error_msg = self._get_error_message(result['errcode'])
                _logger.error(f"WeChat API Error {result['errcode']}: {error_msg}")
                raise WechatAPIError(f"{error_msg} (code: {result['errcode']})")
            
            return result
            
        except requests.exceptions.RequestException as e:
            _logger.error(f"HTTPè¯·æ±‚å¤±è´¥: {str(e)}")
            raise WechatAPIError(f"HTTPè¯·æ±‚å¤±è´¥: {str(e)}")
        except json.JSONDecodeError as e:
            _logger.error(f"JSONè§£æå¤±è´¥: {str(e)}")
            raise WechatAPIError(f"å“åº”è§£æå¤±è´¥: {str(e)}")
    
    def _is_token_valid(self) -> bool:
        """æ£€æŸ¥Tokenæ˜¯å¦æœ‰æ•ˆ"""
        if not self._access_token or not self._token_expires_at:
            return False
        
        # æå‰5åˆ†é’Ÿè¿‡æœŸï¼Œé¿å…ä¸´ç•ŒçŠ¶æ€
        return datetime.now() + timedelta(minutes=5) < self._token_expires_at
    
    def _refresh_access_token(self) -> None:
        """åˆ·æ–°Access Token"""
        url = f"{self.API_BASE_URL}/cgi-bin/token"
        params = {
            'grant_type': 'client_credential',
            'appid': self.app_id,
            'secret': self.app_secret
        }
        
        try:
            response = self._session.get(url, params=params, timeout=10)
            response.raise_for_status()
            result = response.json()
            
            if 'errcode' in result:
                raise WechatAPIError(f"è·å–Tokenå¤±è´¥: {result.get('errmsg')}")
            
            self._access_token = result['access_token']
            # å¾®ä¿¡Tokenæœ‰æ•ˆæœŸä¸º7200ç§’ï¼Œæˆ‘ä»¬è®¾ç½®ä¸º7100ç§’ä»¥æå‰åˆ·æ–°
            self._token_expires_at = datetime.now() + timedelta(seconds=7100)
            
            _logger.info(f"Access Tokenåˆ·æ–°æˆåŠŸï¼Œè¿‡æœŸæ—¶é—´: {self._token_expires_at}")
            
        except Exception as e:
            _logger.error(f"åˆ·æ–°Access Tokenå¤±è´¥: {str(e)}")
            raise WechatAPIError(f"åˆ·æ–°Access Tokenå¤±è´¥: {str(e)}")
    
    def _get_error_message(self, error_code: int) -> str:
        """è·å–é”™è¯¯ç å¯¹åº”çš„é”™è¯¯ä¿¡æ¯"""
        error_messages = {
            -1: 'ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨å€™å†è¯•',
            40001: 'è·å–access_tokenæ—¶AppSecreté”™è¯¯ï¼Œæˆ–è€…access_tokenæ— æ•ˆ',
            40002: 'ä¸åˆæ³•çš„å‡­è¯ç±»å‹',
            40003: 'ä¸åˆæ³•çš„OpenID',
            40004: 'ä¸åˆæ³•çš„åª’ä½“æ–‡ä»¶ç±»å‹',
            40005: 'ä¸åˆæ³•çš„æ–‡ä»¶ç±»å‹',
            40006: 'ä¸åˆæ³•çš„æ–‡ä»¶å¤§å°',
            40007: 'ä¸åˆæ³•çš„åª’ä½“æ–‡ä»¶id',
            40008: 'ä¸åˆæ³•çš„æ¶ˆæ¯ç±»å‹',
            40009: 'ä¸åˆæ³•çš„å›¾ç‰‡æ–‡ä»¶å¤§å°',
            40010: 'ä¸åˆæ³•çš„è¯­éŸ³æ–‡ä»¶å¤§å°',
            40011: 'ä¸åˆæ³•çš„è§†é¢‘æ–‡ä»¶å¤§å°',
            40012: 'ä¸åˆæ³•çš„ç¼©ç•¥å›¾æ–‡ä»¶å¤§å°',
            40013: 'ä¸åˆæ³•çš„AppID',
            40014: 'ä¸åˆæ³•çš„access_token',
            40015: 'ä¸åˆæ³•çš„èœå•ç±»å‹',
            40016: 'ä¸åˆæ³•çš„æŒ‰é’®ä¸ªæ•°',
            40017: 'ä¸åˆæ³•çš„æŒ‰é’®ç±»å‹',
            40018: 'ä¸åˆæ³•çš„æŒ‰é’®åå­—é•¿åº¦',
            40019: 'ä¸åˆæ³•çš„æŒ‰é’®KEYé•¿åº¦',
            40020: 'ä¸åˆæ³•çš„æŒ‰é’®URLé•¿åº¦',
            40021: 'ä¸åˆæ³•çš„èœå•ç‰ˆæœ¬å·',
            40022: 'ä¸åˆæ³•çš„å­èœå•çº§æ•°',
            40023: 'ä¸åˆæ³•çš„å­èœå•æŒ‰é’®ä¸ªæ•°',
            40024: 'ä¸åˆæ³•çš„å­èœå•æŒ‰é’®ç±»å‹',
            40025: 'ä¸åˆæ³•çš„å­èœå•æŒ‰é’®åå­—é•¿åº¦',
            40026: 'ä¸åˆæ³•çš„å­èœå•æŒ‰é’®KEYé•¿åº¦',
            40027: 'ä¸åˆæ³•çš„å­èœå•æŒ‰é’®URLé•¿åº¦',
            40028: 'ä¸åˆæ³•çš„è‡ªå®šä¹‰èœå•ä½¿ç”¨ç”¨æˆ·',
            40029: 'ä¸åˆæ³•çš„oauth_code',
            40030: 'ä¸åˆæ³•çš„refresh_token',
            40031: 'ä¸åˆæ³•çš„openidåˆ—è¡¨',
            40032: 'ä¸åˆæ³•çš„openidåˆ—è¡¨é•¿åº¦',
            40033: 'ä¸åˆæ³•çš„è¯·æ±‚å­—ç¬¦ï¼Œä¸èƒ½åŒ…å«\\uxxxxæ ¼å¼çš„å­—ç¬¦',
            40035: 'ä¸åˆæ³•çš„å‚æ•°',
            40038: 'ä¸åˆæ³•çš„è¯·æ±‚æ ¼å¼',
            40039: 'ä¸åˆæ³•çš„URLé•¿åº¦',
            40050: 'ä¸åˆæ³•çš„åˆ†ç»„id',
            40051: 'åˆ†ç»„åå­—ä¸åˆæ³•',
            40060: 'åˆ é™¤å•ç¯‡å›¾æ–‡æ—¶ï¼ŒæŒ‡å®šçš„ article_idx ä¸åˆæ³•',
            40117: 'åˆ†ç»„åå­—ä¸åˆæ³•',
            40118: 'media_idå¤§å°ä¸åˆæ³•',
            40119: 'buttonç±»å‹é”™è¯¯',
            40120: 'buttonç±»å‹é”™è¯¯',
            40121: 'ä¸åˆæ³•çš„media_idç±»å‹',
            40132: 'ä¸åˆæ³•çš„å¾®ä¿¡å·',
            40137: 'ä¸æ”¯æŒçš„å›¾ç‰‡æ ¼å¼',
            40155: 'è¯·å‹¿æ·»åŠ å…¶ä»–å…¬ä¼—å·çš„ä¸»é¡µé“¾æ¥',
            41001: 'ç¼ºå°‘access_tokenå‚æ•°',
            41002: 'ç¼ºå°‘appidå‚æ•°',
            41003: 'ç¼ºå°‘refresh_tokenå‚æ•°',
            41004: 'ç¼ºå°‘secretå‚æ•°',
            41005: 'ç¼ºå°‘å¤šåª’ä½“æ–‡ä»¶æ•°æ®',
            41006: 'ç¼ºå°‘media_idå‚æ•°',
            41007: 'ç¼ºå°‘å­èœå•æ•°æ®',
            41008: 'ç¼ºå°‘oauth code',
            41009: 'ç¼ºå°‘openid',
            42001: 'access_tokenè¶…æ—¶',
            42002: 'refresh_tokenè¶…æ—¶',
            42003: 'oauth_codeè¶…æ—¶',
            42007: 'ç”¨æˆ·ä¿®æ”¹å¾®ä¿¡å¯†ç ï¼Œaccesstokenå’Œrefreshtokenå¤±æ•ˆï¼Œéœ€è¦é‡æ–°æˆæƒ',
            43001: 'éœ€è¦GETè¯·æ±‚',
            43002: 'éœ€è¦POSTè¯·æ±‚',
            43003: 'éœ€è¦HTTPSè¯·æ±‚',
            43004: 'éœ€è¦æ¥æ”¶è€…å…³æ³¨',
            43005: 'éœ€è¦å¥½å‹å…³ç³»',
            43019: 'éœ€è¦å°†æ¥æ”¶è€…ä»é»‘åå•ä¸­ç§»é™¤',
            44001: 'å¤šåª’ä½“æ–‡ä»¶ä¸ºç©º',
            44002: 'POSTçš„æ•°æ®åŒ…ä¸ºç©º',
            44003: 'å›¾æ–‡æ¶ˆæ¯å†…å®¹ä¸ºç©º',
            44004: 'æ–‡æœ¬æ¶ˆæ¯å†…å®¹ä¸ºç©º',
            45001: 'å¤šåª’ä½“æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶',
            45002: 'æ¶ˆæ¯å†…å®¹è¶…è¿‡é™åˆ¶',
            45003: 'æ ‡é¢˜å­—æ®µè¶…è¿‡é™åˆ¶',
            45004: 'æè¿°å­—æ®µè¶…è¿‡é™åˆ¶',
            45005: 'é“¾æ¥å­—æ®µè¶…è¿‡é™åˆ¶',
            45006: 'å›¾ç‰‡é“¾æ¥å­—æ®µè¶…è¿‡é™åˆ¶',
            45007: 'è¯­éŸ³æ’­æ”¾æ—¶é—´è¶…è¿‡é™åˆ¶',
            45008: 'å›¾æ–‡æ¶ˆæ¯è¶…è¿‡é™åˆ¶',
            45009: 'æ¥å£è°ƒç”¨è¶…è¿‡é™åˆ¶',
            45010: 'åˆ›å»ºèœå•ä¸ªæ•°è¶…è¿‡é™åˆ¶',
            45011: 'APIè°ƒç”¨å¤ªé¢‘ç¹ï¼Œè¯·ç¨å€™å†è¯•',
            45015: 'å›å¤æ—¶é—´è¶…è¿‡é™åˆ¶',
            45016: 'ç³»ç»Ÿåˆ†ç»„ï¼Œä¸å…è®¸ä¿®æ”¹',
            45017: 'åˆ†ç»„åå­—è¿‡é•¿',
            45018: 'åˆ†ç»„æ•°é‡è¶…è¿‡ä¸Šé™',
            45047: 'å®¢æœæ¥å£ä¸‹è¡Œæ¡æ•°è¶…è¿‡ä¸Šé™',
            46001: 'ä¸å­˜åœ¨åª’ä½“æ•°æ®',
            46002: 'ä¸å­˜åœ¨çš„èœå•ç‰ˆæœ¬',
            46003: 'ä¸å­˜åœ¨çš„èœå•æ•°æ®',
            46004: 'ä¸å­˜åœ¨çš„ç”¨æˆ·',
            47001: 'è§£æJSON/XMLå†…å®¹é”™è¯¯',
            48001: 'apiåŠŸèƒ½æœªæˆæƒ',
            48002: 'ç²‰ä¸æ‹’æ”¶æ¶ˆæ¯',
            48004: 'apiæ¥å£è¢«å°ç¦',
            48005: 'apiç¦æ­¢åˆ é™¤è¢«è‡ªåŠ¨å›å¤å’Œè‡ªå®šä¹‰èœå•å¼•ç”¨çš„ç´ æ',
            48006: 'apiç¦æ­¢æ¸…é›¶è°ƒç”¨æ¬¡æ•°ï¼Œå› ä¸ºæ¸…é›¶æ¬¡æ•°è¾¾åˆ°ä¸Šé™',
            48008: 'æ²¡æœ‰è¯¥ç±»å‹æ¶ˆæ¯çš„å‘é€æƒé™',
            50001: 'ç”¨æˆ·æœªæˆæƒè¯¥api',
            50002: 'ç”¨æˆ·å—é™ï¼Œå¯èƒ½æ˜¯è¿è§„åæ¥å£è¢«å°ç¦',
            61451: 'å‚æ•°é”™è¯¯',
            61452: 'æ— æ•ˆå®¢æœè´¦å·',
            61453: 'å®¢æœå¸å·å·²å­˜åœ¨',
            61454: 'å®¢æœå¸å·åé•¿åº¦è¶…è¿‡é™åˆ¶',
            61455: 'å®¢æœå¸å·ååŒ…å«éæ³•å­—ç¬¦',
            61456: 'å®¢æœå¸å·ä¸ªæ•°è¶…è¿‡é™åˆ¶',
            61457: 'æ— æ•ˆå¤´åƒæ–‡ä»¶ç±»å‹',
            61450: 'ç³»ç»Ÿé”™è¯¯',
            61500: 'æ—¥æœŸæ ¼å¼é”™è¯¯',
            65301: 'ä¸å­˜åœ¨æ­¤menuidå¯¹åº”çš„ä¸ªæ€§åŒ–èœå•',
            65302: 'æ²¡æœ‰ç›¸åº”çš„ç”¨æˆ·',
            65303: 'æ²¡æœ‰é»˜è®¤èœå•ï¼Œä¸èƒ½åˆ›å»ºä¸ªæ€§åŒ–èœå•',
            65304: 'MatchRuleä¿¡æ¯ä¸ºç©º',
            65305: 'ä¸ªæ€§åŒ–èœå•æ•°é‡å—é™',
            65306: 'ä¸æ”¯æŒä¸ªæ€§åŒ–èœå•çš„å¸å·',
            65307: 'ä¸ªæ€§åŒ–èœå•ä¿¡æ¯ä¸ºç©º',
            65308: 'åŒ…å«æ²¡æœ‰å“åº”ç±»å‹çš„button',
            65309: 'ä¸ªæ€§åŒ–èœå•å¼€å…³å¤„äºå…³é—­çŠ¶æ€',
            65310: 'å¡«å†™äº†çœä»½æˆ–åŸå¸‚ä¿¡æ¯ï¼Œå›½å®¶ä¿¡æ¯ä¸èƒ½ä¸ºç©º',
            65311: 'å¡«å†™äº†åŸå¸‚ä¿¡æ¯ï¼Œçœä»½ä¿¡æ¯ä¸èƒ½ä¸ºç©º',
            65312: 'ä¸åˆæ³•çš„å›½å®¶ä¿¡æ¯',
            65313: 'ä¸åˆæ³•çš„çœä»½ä¿¡æ¯',
            65314: 'ä¸åˆæ³•çš„åŸå¸‚ä¿¡æ¯',
            65316: 'è¯¥å…¬ä¼—å·çš„èœå•è®¾ç½®äº†è¿‡å¤šçš„åŸŸåå¤–è·³è½¬',
            65317: 'ä¸åˆæ³•çš„URL',
            9001001: 'POSTæ•°æ®å‚æ•°ä¸åˆæ³•',
            9001002: 'è¿œç«¯æœåŠ¡ä¸å¯ç”¨',
            9001003: 'Ticketä¸åˆæ³•',
            9001004: 'è·å–æ‘‡å‘¨è¾¹ç”¨æˆ·ä¿¡æ¯å¤±è´¥',
            9001005: 'è·å–å•†æˆ·ä¿¡æ¯å¤±è´¥',
            9001006: 'è·å–OpenIDå¤±è´¥',
            9001007: 'ä¸Šä¼ æ–‡ä»¶ç¼ºå¤±',
            9001008: 'ä¸Šä¼ ç´ æçš„æ–‡ä»¶ç±»å‹ä¸åˆæ³•',
            9001009: 'ä¸Šä¼ ç´ æçš„æ–‡ä»¶å°ºå¯¸ä¸åˆæ³•',
            9001010: 'ä¸Šä¼ å¤±è´¥',
            9001020: 'å¸å·ä¸åˆæ³•',
            9001021: 'å·²æœ‰è®¾å¤‡æ¿€æ´»ç‡ä½äº50%ï¼Œä¸èƒ½æ–°å¢è®¾å¤‡',
            9001022: 'è®¾å¤‡ç”³è¯·æ•°ä¸åˆæ³•ï¼Œå¿…é¡»ä¸ºå¤§äº0çš„æ•°å­—',
            9001023: 'å·²å­˜åœ¨å®¡æ ¸ä¸­çš„è®¾å¤‡IDç”³è¯·',
            9001024: 'ä¸€æ¬¡æŸ¥è¯¢è®¾å¤‡IDæ•°é‡ä¸èƒ½è¶…è¿‡50',
            9001025: 'è®¾å¤‡IDä¸åˆæ³•',
            9001026: 'é¡µé¢IDä¸åˆæ³•',
            9001027: 'é¡µé¢å‚æ•°ä¸åˆæ³•',
            9001028: 'ä¸€æ¬¡åˆ é™¤é¡µé¢IDæ•°é‡ä¸èƒ½è¶…è¿‡10',
            9001029: 'é¡µé¢å·²åº”ç”¨åœ¨è®¾å¤‡ä¸­ï¼Œè¯·å…ˆè§£é™¤åº”ç”¨å…³ç³»å†åˆ é™¤',
            9001030: 'ä¸€æ¬¡æŸ¥è¯¢é¡µé¢IDæ•°é‡ä¸èƒ½è¶…è¿‡50',
            9001031: 'æ—¶é—´åŒºé—´ä¸åˆæ³•',
            9001032: 'ä¿å­˜è®¾å¤‡ä¸é¡µé¢çš„ç»‘å®šå…³ç³»å‚æ•°é”™è¯¯',
            9001033: 'é—¨åº—IDä¸åˆæ³•',
            9001034: 'è®¾å¤‡å¤‡æ³¨ä¿¡æ¯è¿‡é•¿',
            9001035: 'è®¾å¤‡ç”³è¯·å‚æ•°ä¸åˆæ³•',
            9001036: 'æŸ¥è¯¢èµ·å§‹å€¼beginä¸åˆæ³•',
        }
        
        return error_messages.get(error_code, f"æœªçŸ¥é”™è¯¯ (code: {error_code})")
    
    # ========== ç”¨æˆ·ç®¡ç†ç›¸å…³API ==========
    
    def get_user_info(self, openid: str) -> Dict:
        """è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯"""
        endpoint = f"/cgi-bin/user/info"
        params = {'openid': openid}
        return self._request('GET', endpoint, params=params)
    
    def batch_get_user_info(self, openids: List[str]) -> Dict:
        """æ‰¹é‡è·å–ç”¨æˆ·ä¿¡æ¯"""
        endpoint = "/cgi-bin/user/info/batchget"
        data = {
            'user_list': [{'openid': openid} for openid in openids]
        }
        return self._request('POST', endpoint, data=data)
    
    def get_user_list(self, next_openid: Optional[str] = None) -> Dict:
        """è·å–ç”¨æˆ·åˆ—è¡¨"""
        endpoint = "/cgi-bin/user/get"
        params = {}
        if next_openid:
            params['next_openid'] = next_openid
        return self._request('GET', endpoint, params=params)
    
    def update_user_remark(self, openid: str, remark: str) -> Dict:
        """è®¾ç½®ç”¨æˆ·å¤‡æ³¨å"""
        endpoint = "/cgi-bin/user/info/updateremark"
        data = {
            'openid': openid,
            'remark': remark
        }
        return self._request('POST', endpoint, data=data)
    
    # ========== æ¶ˆæ¯ç®¡ç†ç›¸å…³API ==========
    
    def send_text_message(self, openid: str, content: str) -> Dict:
        """å‘é€æ–‡æœ¬æ¶ˆæ¯"""
        endpoint = "/cgi-bin/message/custom/send"
        data = {
            'touser': openid,
            'msgtype': 'text',
            'text': {'content': content}
        }
        return self._request('POST', endpoint, data=data)
    
    def send_template_message(self, template_data: Dict) -> Dict:
        """å‘é€æ¨¡æ¿æ¶ˆæ¯"""
        endpoint = "/cgi-bin/message/template/send"
        return self._request('POST', endpoint, data=template_data)
    
    def get_private_templates(self) -> Dict:
        """è·å–æ¨¡æ¿åˆ—è¡¨"""
        endpoint = "/cgi-bin/template/get_all_private_template"
        return self._request('GET', endpoint)
    
    # ========== èœå•ç®¡ç†ç›¸å…³API ==========
    
    def create_menu(self, menu_data: Dict) -> Dict:
        """åˆ›å»ºè‡ªå®šä¹‰èœå•"""
        endpoint = "/cgi-bin/menu/create"
        return self._request('POST', endpoint, data=menu_data)
    
    def get_menu(self) -> Dict:
        """æŸ¥è¯¢è‡ªå®šä¹‰èœå•"""
        endpoint = "/cgi-bin/menu/get"
        return self._request('GET', endpoint)
    
    def delete_menu(self) -> Dict:
        """åˆ é™¤è‡ªå®šä¹‰èœå•"""
        endpoint = "/cgi-bin/menu/delete"
        return self._request('GET', endpoint)
    
    # ========== ç´ æç®¡ç†ç›¸å…³API ==========
    
    def upload_media(self, media_type: str, file_path: str, title: Optional[str] = None, 
                    introduction: Optional[str] = None) -> Dict:
        """ä¸Šä¼ ä¸´æ—¶ç´ æ"""
        endpoint = "/cgi-bin/media/upload"
        params = {'type': media_type}
        
        with open(file_path, 'rb') as f:
            files = {'media': f}
            return self._request('POST', endpoint, params=params, files=files)
    
    def get_media(self, media_id: str) -> bytes:
        """è·å–ä¸´æ—¶ç´ æ"""
        endpoint = "/cgi-bin/media/get"
        params = {'media_id': media_id}
        
        response = self._session.get(
            urljoin(self.API_BASE_URL, endpoint),
            params=params,
            stream=True
        )
        response.raise_for_status()
        return response.content
    
    # ========== å…¶ä»–API ==========
    
    def get_jsapi_ticket(self) -> Dict:
        """è·å–JS-SDKçš„ticket"""
        endpoint = "/cgi-bin/ticket/getticket"
        params = {'type': 'jsapi'}
        return self._request('GET', endpoint, params=params)
    
    def generate_jsapi_signature(self, url: str, noncestr: str, timestamp: int) -> str:
        """ç”ŸæˆJS-SDKç­¾å"""
        jsapi_ticket = self.get_jsapi_ticket().get('ticket')
        
        string = f"jsapi_ticket={jsapi_ticket}&noncestr={noncestr}&timestamp={timestamp}&url={url}"
        
        signature = hashlib.sha1(string.encode('utf-8')).hexdigest()
        return signature
```

#### **ä»»åŠ¡3ï¼šå®ç°Access Tokenç®¡ç†æ¨¡å‹**
```python
# file: wechat_common/models/wechat_token.py

from odoo import models, fields, api, _
from odoo.exceptions import ValidationError
import logging
import json
from datetime import datetime, timedelta

_logger = logging.getLogger(__name__)

class WechatAccessToken(models.Model):
    """å¾®ä¿¡Access Tokenç®¡ç†"""
    _name = 'wechat.access.token'
    _description = 'å¾®ä¿¡Access Token'
    _rec_name = 'app_id'
    _order = 'write_date desc'
    
    # åŸºæœ¬å­—æ®µ
    app_id = fields.Char(string='AppID', required=True, index=True)
    app_secret = fields.Char(string='AppSecret', required=True, groups='base.group_system')
    account_type = fields.Selection([
        ('service', 'æœåŠ¡å·'),
        ('subscription', 'è®¢é˜…å·'),
        ('enterprise', 'ä¼ä¸šå·'),
        ('miniprogram', 'å°ç¨‹åº'),
    ], string='è´¦å·ç±»å‹', required=True)
    
    # Tokenå­—æ®µ
    access_token = fields.Char(string='Access Token', readonly=True)
    token_expires_at = fields.Datetime(string='Tokenè¿‡æœŸæ—¶é—´', readonly=True)
    jsapi_ticket = fields.Char(string='JSAPI Ticket', readonly=True)
    ticket_expires_at = fields.Datetime(string='Ticketè¿‡æœŸæ—¶é—´', readonly=True)
    
    # çŠ¶æ€å­—æ®µ
    is_valid = fields.Boolean(string='é…ç½®æœ‰æ•ˆ', compute='_compute_is_valid', store=True)
    last_sync_time = fields.Datetime(string='æœ€ååŒæ­¥æ—¶é—´', readonly=True)
    error_count = fields.Integer(string='é”™è¯¯è®¡æ•°', default=0)
    last_error = fields.Char(string='æœ€åé”™è¯¯ä¿¡æ¯', readonly=True)
    
    # ç»Ÿè®¡å­—æ®µ
    api_call_count = fields.Integer(string='APIè°ƒç”¨æ¬¡æ•°', default=0)
    last_api_call = fields.Datetime(string='æœ€åAPIè°ƒç”¨æ—¶é—´', readonly=True)
    
    # çº¦æŸ
    _sql_constraints = [
        ('app_id_unique', 'UNIQUE(app_id)', 'AppIDå¿…é¡»å”¯ä¸€')
    ]
    
    @api.depends('access_token', 'token_expires_at')
    def _compute_is_valid(self):
        """è®¡ç®—é…ç½®æ˜¯å¦æœ‰æ•ˆ"""
        for record in self:
            if not record.access_token or not record.token_expires_at:
                record.is_valid = False
                continue
            
            # æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸï¼ˆæå‰5åˆ†é’Ÿè§†ä¸ºè¿‡æœŸï¼‰
            now = fields.Datetime.now()
            expires_at = fields.Datetime.from_string(record.token_expires_at)
            record.is_valid = now < expires_at - timedelta(minutes=5)
    
    @api.model
    def create(self, vals):
        """åˆ›å»ºæ—¶éªŒè¯å¹¶åˆå§‹åŒ–"""
        # éªŒè¯AppIDæ ¼å¼
        app_id = vals.get('app_id', '')
        if not app_id or len(app_id) < 5:
            raise ValidationError(_('AppIDæ ¼å¼ä¸æ­£ç¡®'))
        
        # éªŒè¯AppSecretæ ¼å¼
        app_secret = vals.get('app_secret', '')
        if not app_secret or len(app_secret) < 10:
            raise ValidationError(_('AppSecretæ ¼å¼ä¸æ­£ç¡®'))
        
        record = super().create(vals)
        
        # å°è¯•è·å–åˆå§‹Token
        try:
            record._refresh_token()
        except Exception as e:
            _logger.warning(f"åˆå§‹åŒ–Tokenå¤±è´¥: {str(e)}")
        
        return record
    
    def write(self, vals):
        """å†™å…¥æ—¶å¤„ç†æ•æ„Ÿæ•°æ®"""
        # å¦‚æœæ›´æ–°äº†AppSecretï¼Œéœ€è¦é‡æ–°è·å–Token
        if 'app_secret' in vals:
            vals['access_token'] = False
            vals['token_expires_at'] = False
            vals['jsapi_ticket'] = False
            vals['ticket_expires_at'] = False
        
        result = super().write(vals)
        
        # å¦‚æœAppSecretè¢«æ›´æ–°ï¼Œå°è¯•åˆ·æ–°Token
        if 'app_secret' in vals:
            for record in self:
                try:
                    record._refresh_token()
                except Exception as e:
                    _logger.warning(f"åˆ·æ–°Tokenå¤±è´¥: {str(e)}")
        
        return result
    
    def _refresh_token(self):
        """åˆ·æ–°Access Token"""
        from .wechat_api_client import WechatAPIClient
        
        for record in self:
            try:
                # åˆ›å»ºAPIå®¢æˆ·ç«¯
                client = WechatAPIClient(
                    app_id=record.app_id,
                    app_secret=record.app_secret
                )
                
                # åˆ·æ–°Token
                client._refresh_access_token()
                
                # è·å–JSAPI Ticket
                ticket_result = client.get_jsapi_ticket()
                
                # æ›´æ–°è®°å½•
                record.write({
                    'access_token': client._access_token,
                    'token_expires_at': client._token_expires_at,
                    'jsapi_ticket': ticket_result.get('ticket'),
                    'ticket_expires_at': fields.Datetime.now() + timedelta(seconds=ticket_result.get('expires_in', 7200)),
                    'last_sync_time': fields.Datetime.now(),
                    'error_count': 0,
                    'last_error': False,
                })
                
                _logger.info(f"Tokenåˆ·æ–°æˆåŠŸ: {record.app_id}")
                
            except Exception as e:
                error_msg = str(e)
                record.write({
                    'error_count': record.error_count + 1,
                    'last_error': error_msg,
                })
                _logger.error(f"Tokenåˆ·æ–°å¤±è´¥ {record.app_id}: {error_msg}")
                raise
    
    def get_valid_token(self):
        """è·å–æœ‰æ•ˆçš„Tokenï¼Œå¦‚æœè¿‡æœŸåˆ™è‡ªåŠ¨åˆ·æ–°"""
        self.ensure_one()
        
        # æ£€æŸ¥Tokenæ˜¯å¦å³å°†è¿‡æœŸ
        now = fields.Datetime.now()
        expires_at = fields.Datetime.from_string(self.token_expires_at) if self.token_expires_at else now
        
        # å¦‚æœTokenå·²è¿‡æœŸæˆ–å³å°†è¿‡æœŸï¼ˆ5åˆ†é’Ÿå†…ï¼‰ï¼Œåˆ™åˆ·æ–°
        if not self.access_token or now >= expires_at - timedelta(minutes=5):
            self._refresh_token()
        
        return self.access_token
    
    def get_api_client(self):
        """è·å–APIå®¢æˆ·ç«¯å®ä¾‹"""
        self.ensure_one()
        
        from .wechat_api_client import WechatAPIClient
        
        # ç¡®ä¿Tokenæœ‰æ•ˆ
        token = self.get_valid_token()
        
        return WechatAPIClient(
            app_id=self.app_id,
            app_secret=self.app_secret,
            access_token=token,
            token_expires_at=fields.Datetime.from_string(self.token_expires_at) if self.token_expires_at else None
        )
    
    def increment_api_call(self):
        """å¢åŠ APIè°ƒç”¨è®¡æ•°"""
        self.ensure_one()
        self.write({
            'api_call_count': self.api_call_count + 1,
            'last_api_call': fields.Datetime.now(),
        })
    
    @api.model
    def cron_refresh_expiring_tokens(self):
        """å®šæ—¶ä»»åŠ¡ï¼šåˆ·æ–°å³å°†è¿‡æœŸçš„Token"""
        now = fields.Datetime.now()
        
        # æŸ¥æ‰¾æ‰€æœ‰å³å°†è¿‡æœŸçš„Tokenï¼ˆ5åˆ†é’Ÿå†…è¿‡æœŸï¼‰
        domain = [
            ('token_expires_at', '!=', False),
            ('token_expires_at', '<', fields.Datetime.to_string(now + timedelta(minutes=5))),
            ('is_valid', '=', True),  # åªåˆ·æ–°å½“å‰æœ‰æ•ˆçš„Token
        ]
        
        expiring_tokens = self.search(domain)
        
        _logger.info(f"æ‰¾åˆ° {len(expiring_tokens)} ä¸ªå³å°†è¿‡æœŸçš„Tokenéœ€è¦åˆ·æ–°")
        
        for token in expiring_tokens:
            try:
                token._refresh_token()
            except Exception as e:
                _logger.error(f"å®šæ—¶åˆ·æ–°Tokenå¤±è´¥ {token.app_id}: {str(e)}")
        
        return len(expiring_tokens)
    
    @api.model
    def cron_cleanup_invalid_tokens(self):
        """å®šæ—¶ä»»åŠ¡ï¼šæ¸…ç†æ— æ•ˆçš„Token"""
        # æ¸…ç†30å¤©å‰çš„é”™è¯¯è®°å½•
        thirty_days_ago = fields.Datetime.to_string(
            fields.Datetime.from_string(fields.Datetime.now()) - timedelta(days=30)
        )
        
        invalid_tokens = self.search([
            ('is_valid', '=', False),
            ('write_date', '<', thirty_days_ago),
            ('error_count', '>', 10),  # é”™è¯¯æ¬¡æ•°è¿‡å¤š
        ])
        
        deleted_count = len(invalid_tokens)
        invalid_tokens.unlink()
        
        _logger.info(f"æ¸…ç†äº† {deleted_count} ä¸ªæ— æ•ˆTokenè®°å½•")
        return deleted_count
```

#### **ä»»åŠ¡4ï¼šå®ç°æ¶ˆæ¯åŠ è§£å¯†å·¥å…·**
```python
# file: wechat_common/lib/wechat_crypto.py

import base64
import hashlib
import struct
import random
import string
from typing import Optional, Tuple
from datetime import datetime
import xml.etree.ElementTree as ET
from cryptography.hazmat.primitives.ciphers import Cipher, algorithms, modes
from cryptography.hazmat.backends import default_backend
import logging

_logger = logging.getLogger(__name__)

class WechatCrypto:
    """å¾®ä¿¡æ¶ˆæ¯åŠ è§£å¯†å·¥å…·"""
    
    def __init__(self, token: str, encoding_aes_key: str, app_id: str):
        """
        åˆå§‹åŒ–åŠ è§£å¯†å·¥å…·
        
        Args:
            token: å¾®ä¿¡æœåŠ¡å™¨é…ç½®çš„Token
            encoding_aes_key: æ¶ˆæ¯åŠ è§£å¯†å¯†é’¥ï¼ˆ43ä½ï¼‰
            app_id: å…¬ä¼—å·çš„AppID
        """
        self.token = token
        self.app_id = app_id
        
        # éªŒè¯å¹¶å¤„ç†AES Key
        if len(encoding_aes_key) != 43:
            raise ValueError("EncodingAESKeyé•¿åº¦å¿…é¡»ä¸º43ä½")
        
        # æ·»åŠ '='ä½¿Base64è§£ç 
        aes_key = encoding_aes_key + '='
        self.aes_key = base64.b64decode(aes_key)
        
        # åˆå§‹åŒ–AESå¯†ç 
        self.iv = self.aes_key[:16]
    
    def verify_signature(self, signature: str, timestamp: str, 
                        nonce: str, echostr: str) -> bool:
        """
        éªŒè¯å¾®ä¿¡æœåŠ¡å™¨ç­¾å
        
        ç”¨äºé¦–æ¬¡URLéªŒè¯
        """
        # å°†tokenã€timestampã€nonceä¸‰ä¸ªå‚æ•°è¿›è¡Œå­—å…¸åºæ’åº
        data = sorted([self.token, timestamp, nonce])
        # æ‹¼æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²
        data_str = ''.join(data)
        # è¿›è¡Œsha1åŠ å¯†
        sha1 = hashlib.sha1()
        sha1.update(data_str.encode('utf-8'))
        hashcode = sha1.hexdigest()
        
        return hashcode == signature
    
    def encrypt(self, text: str) -> Tuple[str, str, str, str]:
        """
        åŠ å¯†æ¶ˆæ¯
        
        Args:
            text: è¦åŠ å¯†çš„æ˜æ–‡
            
        Returns:
            Tuple[encrypt_text, signature, timestamp, nonce]
        """
        try:
            # éšæœºç”Ÿæˆ16ä½å­—ç¬¦ä¸²
            nonce = self._generate_random_str(16)
            
            # æ·»åŠ éšæœºå­—ç¬¦ä¸²å’ŒAppID
            text = self._encode_text(text)
            
            # ä½¿ç”¨AES-CBCåŠ å¯†
            cipher = Cipher(
                algorithms.AES(self.aes_key),
                modes.CBC(self.iv),
                backend=default_backend()
            )
            encryptor = cipher.encryptor()
            
            # å¯¹æ–‡æœ¬è¿›è¡ŒPKCS7å¡«å……
            padded_text = self._pkcs7_padding(text.encode('utf-8'))
            
            # åŠ å¯†
            ciphertext = encryptor.update(padded_text) + encryptor.finalize()
            
            # Base64ç¼–ç 
            encrypt_text = base64.b64encode(ciphertext).decode('utf-8')
            
            # ç”Ÿæˆç­¾å
            timestamp = str(int(datetime.now().timestamp()))
            signature = self._generate_signature(encrypt_text, timestamp, nonce)
            
            return encrypt_text, signature, timestamp, nonce
            
        except Exception as e:
            _logger.error(f"åŠ å¯†æ¶ˆæ¯å¤±è´¥: {str(e)}")
            raise
    
    def decrypt(self, encrypt_text: str, signature: str, 
                timestamp: str, nonce: str) -> str:
        """
        è§£å¯†æ¶ˆæ¯
        
        Args:
            encrypt_text: åŠ å¯†çš„æ¶ˆæ¯æ–‡æœ¬
            signature: ç­¾å
            timestamp: æ—¶é—´æˆ³
            nonce: éšæœºæ•°
            
        Returns:
            è§£å¯†åçš„æ˜æ–‡
        """
        try:
            # éªŒè¯ç­¾å
            expected_signature = self._generate_signature(encrypt_text, timestamp, nonce)
            if expected_signature != signature:
                raise ValueError("ç­¾åéªŒè¯å¤±è´¥")
            
            # Base64è§£ç 
            ciphertext = base64.b64decode(encrypt_text)
            
            # ä½¿ç”¨AES-CBCè§£å¯†
            cipher = Cipher(
                algorithms.AES(self.aes_key),
                modes.CBC(self.iv),
                backend=default_backend()
            )
            decryptor = cipher.decryptor()
            
            # è§£å¯†
            padded_text = decryptor.update(ciphertext) + decryptor.finalize()
            
            # å»é™¤PKCS7å¡«å……
            text_bytes = self._pkcs7_unpadding(padded_text)
            
            # è§£ææ¶ˆæ¯ç»“æ„
            text = text_bytes.decode('utf-8')
            return self._decode_text(text)
            
        except Exception as e:
            _logger.error(f"è§£å¯†æ¶ˆæ¯å¤±è´¥: {str(e)}")
            raise
    
    def parse_message(self, xml_data: str) -> dict:
        """è§£æå¾®ä¿¡æ¶ˆæ¯XML"""
        try:
            root = ET.fromstring(xml_data)
            message = {}
            
            for child in root:
                message[child.tag] = child.text
            
            return message
            
        except Exception as e:
            _logger.error(f"è§£æXMLæ¶ˆæ¯å¤±è´¥: {str(e)}")
            raise
    
    def generate_reply(self, to_user: str, from_user: str, 
                      content: str, msg_type: str = "text") -> str:
        """ç”Ÿæˆå›å¤æ¶ˆæ¯XML"""
        create_time = str(int(datetime.now().timestamp()))
        
        if msg_type == "text":
            xml_template = f"""
            <xml>
                <ToUserName><![CDATA[{to_user}]]></ToUserName>
                <FromUserName><![CDATA[{from_user}]]></FromUserName>
                <CreateTime>{create_time}</CreateTime>
                <MsgType><![CDATA[text]]></MsgType>
                <Content><![CDATA[{content}]]></Content>
            </xml>
            """
        else:
            # å¯ä»¥æ‰©å±•å…¶ä»–æ¶ˆæ¯ç±»å‹
            raise ValueError(f"ä¸æ”¯æŒçš„å›å¤æ¶ˆæ¯ç±»å‹: {msg_type}")
        
        return xml_template.strip()
    
    def _encode_text(self, text: str) -> str:
        """ç¼–ç æ–‡æœ¬ï¼Œæ·»åŠ éšæœºå­—ç¬¦ä¸²å’ŒAppID"""
        # ç”Ÿæˆ16ä½éšæœºå­—ç¬¦ä¸²
        random_str = self._generate_random_str(16)
        
        # æ¶ˆæ¯ç»“æ„: random(16å­—èŠ‚) + text_len(4å­—èŠ‚) + text + app_id
        text_len = len(text.encode('utf-8'))
        
        # ä½¿ç”¨ç½‘ç»œå­—èŠ‚åºï¼ˆå¤§ç«¯ï¼‰æ‰“åŒ…é•¿åº¦
        length_bytes = struct.pack('!I', text_len)
        
        # æ‹¼æ¥æ‰€æœ‰éƒ¨åˆ†
        encoded = random_str.encode('utf-8') + length_bytes + text.encode('utf-8') + self.app_id.encode('utf-8')
        
        return encoded.decode('utf-8', errors='ignore')
    
    def _decode_text(self, encoded_text: str) -> str:
        """è§£ç æ–‡æœ¬ï¼Œæå–åŸå§‹æ¶ˆæ¯"""
        encoded_bytes = encoded_text.encode('utf-8')
        
        # æå–å„éƒ¨åˆ†
        # 16å­—èŠ‚éšæœºå­—ç¬¦ä¸²
        random_str = encoded_bytes[:16]
        # 4å­—èŠ‚é•¿åº¦
        text_len_bytes = encoded_bytes[16:20]
        # æ¶ˆæ¯é•¿åº¦
        text_len = struct.unpack('!I', text_len_bytes)[0]
        # æ¶ˆæ¯å†…å®¹
        text = encoded_bytes[20:20+text_len].decode('utf-8')
        # AppIDï¼ˆåº”è¯¥ä¸å½“å‰AppIDåŒ¹é…ï¼‰
        app_id = encoded_bytes[20+text_len:].decode('utf-8')
        
        if app_id != self.app_id:
            raise ValueError("AppIDä¸åŒ¹é…")
        
        return text
    
    def _generate_random_str(self, length: int) -> str:
        """ç”ŸæˆæŒ‡å®šé•¿åº¦çš„éšæœºå­—ç¬¦ä¸²"""
        chars = string.ascii_letters + string.digits
        return ''.join(random.choice(chars) for _ in range(length))
    
    def _generate_signature(self, encrypt_text: str, 
                           timestamp: str, nonce: str) -> str:
        """ç”Ÿæˆæ¶ˆæ¯ç­¾å"""
        # å°†tokenã€timestampã€nonceã€encrypt_textè¿›è¡Œå­—å…¸åºæ’åº
        data = sorted([self.token, timestamp, nonce, encrypt_text])
        # æ‹¼æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²
        data_str = ''.join(data)
        # è¿›è¡Œsha1åŠ å¯†
        sha1 = hashlib.sha1()
        sha1.update(data_str.encode('utf-8'))
        return sha1.hexdigest()
    
    def _pkcs7_padding(self, data: bytes, block_size: int = 32) -> bytes:
        """PKCS7å¡«å……"""
        padding_len = block_size - len(data) % block_size
        padding = bytes([padding_len]) * padding_len
        return data + padding
    
    def _pkcs7_unpadding(self, data: bytes) -> bytes:
        """å»é™¤PKCS7å¡«å……"""
        padding_len = data[-1]
        return data[:-padding_len]
```

### **å‰ç«¯å¼€å‘å…·ä½“ä»»åŠ¡ï¼š**

#### **ä»»åŠ¡1ï¼šå…¬ä¼—å·é…ç½®ç®¡ç†ç•Œé¢**
```javascript
// file: wechat_common/static/src/js/wechat_config.js

odoo.define('wechat_common.WechatConfig', function (require) {
    "use strict";

    const { Component, useState, onWillStart } = owl;
    const { useService } = require("@web/core/utils/hooks");
    
    class WechatConfig extends Component {
        static template = "wechat_common.WechatConfig";
        
        setup() {
            super.setup();
            this.orm = useService("orm");
            this.notification = useService("notification");
            
            this.state = useState({
                appId: '',
                appSecret: '',
                accountType: 'service',
                token: this._generateToken(),
                encodingAesKey: this._generateEncodingAESKey(),
                serverUrl: '',
                isTesting: false,
                isLoading: false,
            });
            
            onWillStart(async () => {
                await this.loadExistingConfig();
            });
        }
        
        // åŠ è½½ç°æœ‰é…ç½®
        async loadExistingConfig() {
            try {
                const config = await this.orm.call(
                    'wechat.access.token',
                    'get_config',
                    []
                );
                
                if (config) {
                    this.state.appId = config.app_id || '';
                    this.state.appSecret = config.app_secret || '';
                    this.state.accountType = config.account_type || 'service';
                    this.state.token = config.token || this.state.token;
                    this.state.encodingAesKey = config.encoding_aes_key || this.state.encodingAesKey;
                    this.state.serverUrl = config.server_url || this._generateServerUrl();
                } else {
                    this.state.serverUrl = this._generateServerUrl();
                }
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
            }
        }
        
        // ç”ŸæˆéšæœºToken
        _generateToken() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let token = '';
            for (let i = 0; i < 32; i++) {
                token += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return token;
        }
        
        // ç”ŸæˆEncodingAESKey
        _generateEncodingAESKey() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';
            let key = '';
            for (let i = 0; i < 43; i++) {  // å¾®ä¿¡è¦æ±‚43ä½
                key += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return key;
        }
        
        // ç”ŸæˆæœåŠ¡å™¨URL
        _generateServerUrl() {
            const protocol = window.location.protocol;
            const host = window.location.host;
            return `${protocol}//${host}/wechat/callback`;
        }
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        async copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                this.notification.add("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿", { type: 'success' });
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                this.notification.add("å¤åˆ¶å¤±è´¥", { type: 'danger' });
            }
        }
        
        // éªŒè¯é…ç½®
        async verifyConfig() {
            if (!this.state.appId || !this.state.appSecret) {
                this.notification.add("è¯·å¡«å†™AppIDå’ŒAppSecret", { type: 'danger' });
                return false;
            }
            
            this.state.isLoading = true;
            this.state.isTesting = true;
            
            try {
                const result = await this.orm.call(
                    'wechat.access.token',
                    'verify_config',
                    [{
                        app_id: this.state.appId,
                        app_secret: this.state.appSecret,
                        account_type: this.state.accountType,
                    }]
                );
                
                if (result.success) {
                    this.notification.add("é…ç½®éªŒè¯æˆåŠŸ", { type: 'success' });
                    return true;
                } else {
                    this.notification.add(`éªŒè¯å¤±è´¥: ${result.message}`, { type: 'danger' });
                    return false;
                }
            } catch (error) {
                console.error('éªŒè¯é…ç½®å¤±è´¥:', error);
                this.notification.add("éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥", { type: 'danger' });
                return false;
            } finally {
                this.state.isLoading = false;
            }
        }
        
        // ä¿å­˜é…ç½®
        async saveConfig() {
            // å…ˆéªŒè¯é…ç½®
            const isValid = await this.verifyConfig();
            if (!isValid) {
                return;
            }
            
            this.state.isLoading = true;
            
            try {
                const result = await this.orm.call(
                    'wechat.access.token',
                    'save_config',
                    [{
                        app_id: this.state.appId,
                        app_secret: this.state.appSecret,
                        account_type: this.state.accountType,
                        token: this.state.token,
                        encoding_aes_key: this.state.encodingAesKey,
                        server_url: this.state.serverUrl,
                    }]
                );
                
                if (result.success) {
                    this.notification.add("é…ç½®ä¿å­˜æˆåŠŸ", { type: 'success' });
                } else {
                    this.notification.add(`ä¿å­˜å¤±è´¥: ${result.message}`, { type: 'danger' });
                }
            } catch (error) {
                console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                this.notification.add("ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•", { type: 'danger' });
            } finally {
                this.state.isLoading = false;
            }
        }
        
        // æ‰“å¼€å¾®ä¿¡å…¬ä¼—å¹³å°
        openWechatPlatform() {
            window.open('https://mp.weixin.qq.com/', '_blank');
        }
    }
    
    return WechatConfig;
});
```

#### **ä»»åŠ¡2ï¼šé…ç½®ç•Œé¢æ¨¡æ¿**
```xml
<!-- file: wechat_common/views/wechat_config_templates.xml -->

<odoo>
    <data>
        <!-- å¾®ä¿¡é…ç½®ç•Œé¢ -->
        <template id="wechat_config_view" inherit_id="web.layout">
            <xpath expr="//div[hasclass('o_content')]" position="inside">
                <div class="wechat-config-container">
                    <div class="container mt-4">
                        <div class="row justify-content-center">
                            <div class="col-lg-8">
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="mb-0">
                                            <i class="fa fa-weixin me-2"></i>
                                            å¾®ä¿¡å…¬ä¼—å·é…ç½®
                                        </h3>
                                    </div>
                                    <div class="card-body">
                                        <!-- é…ç½®è¡¨å• -->
                                        <form class="wechat-config-form">
                                            <!-- è´¦å·ç±»å‹ -->
                                            <div class="mb-4">
                                                <label class="form-label fw-bold">è´¦å·ç±»å‹</label>
                                                <div class="row">
                                                    <div class="col-md-3">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio" 
                                                                   t-att-checked="state.accountType === 'service'"
                                                                   t-on-click="() => state.accountType = 'service'"
                                                                   id="accountTypeService">
                                                            <label class="form-check-label" for="accountTypeService">
                                                                <i class="fa fa-check-circle text-success me-1"></i>
                                                                æœåŠ¡å·
                                                            </label>
                                                            <small class="d-block text-muted">æ¯æœˆå¯ç¾¤å‘4æ¡æ¶ˆæ¯</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio" 
                                                                   t-att-checked="state.accountType === 'subscription'"
                                                                   t-on-click="() => state.accountType = 'subscription'"
                                                                   id="accountTypeSubscription">
                                                            <label class="form-check-label" for="accountTypeSubscription">
                                                                <i class="fa fa-newspaper text-info me-1"></i>
                                                                è®¢é˜…å·
                                                            </label>
                                                            <small class="d-block text-muted">æ¯å¤©å¯ç¾¤å‘1æ¡æ¶ˆæ¯</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio" 
                                                                   t-att-checked="state.accountType === 'enterprise'"
                                                                   t-on-click="() => state.accountType = 'enterprise'"
                                                                   id="accountTypeEnterprise">
                                                            <label class="form-check-label" for="accountTypeEnterprise">
                                                                <i class="fa fa-building text-warning me-1"></i>
                                                                ä¼ä¸šå·
                                                            </label>
                                                            <small class="d-block text-muted">ä¼ä¸šå†…éƒ¨ä½¿ç”¨</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- AppIDå’ŒAppSecret -->
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label for="appId" class="form-label">
                                                            AppID
                                                            <span class="text-danger">*</span>
                                                        </label>
                                                        <div class="input-group">
                                                            <input type="text" class="form-control" id="appId"
                                                                   t-att-value="state.appId"
                                                                   t-on-input="(ev) => state.appId = ev.target.value"
                                                                   placeholder="wx1234567890abcdef">
                                                            <button class="btn btn-outline-secondary" type="button"
                                                                    t-on-click="() => copyToClipboard(state.appId)">
                                                                <i class="fa fa-copy"></i>
                                                            </button>
                                                        </div>
                                                        <small class="text-muted">å¾®ä¿¡å…¬ä¼—å·çš„å”¯ä¸€æ ‡è¯†</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label for="appSecret" class="form-label">
                                                            AppSecret
                                                            <span class="text-danger">*</span>
                                                        </label>
                                                        <div class="input-group">
                                                            <input type="password" class="form-control" id="appSecret"
                                                                   t-att-value="state.appSecret"
                                                                   t-on-input="(ev) => state.appSecret = ev.target.value"
                                                                   placeholder="32ä½å¯†é’¥">
                                                            <button class="btn btn-outline-secondary" type="button"
                                                                    t-on-click="() => state.appSecret = ''; copyToClipboard(state.appSecret)">
                                                                <i class="fa fa-eye"></i>
                                                            </button>
                                                        </div>
                                                        <small class="text-muted">å…¬ä¼—å·çš„å¯†é’¥ï¼Œç”¨äºè·å–access_token</small>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- æœåŠ¡å™¨é…ç½® -->
                                            <div class="mb-4">
                                                <h5 class="border-bottom pb-2 mb-3">
                                                    <i class="fa fa-server me-2"></i>
                                                    æœåŠ¡å™¨é…ç½®
                                                </h5>
                                                
                                                <!-- Token -->
                                                <div class="form-group mb-3">
                                                    <label for="token" class="form-label">
                                                        ä»¤ç‰Œ(Token)
                                                    </label>
                                                    <div class="input-group">
                                                        <input type="text" class="form-control" id="token"
                                                               t-att-value="state.token"
                                                               readonly>
                                                        <button class="btn btn-outline-secondary" type="button"
                                                                t-on-click="() => copyToClipboard(state.token)">
                                                            <i class="fa fa-copy"></i>
                                                        </button>
                                                        <button class="btn btn-outline-secondary" type="button"
                                                                t-on-click="() => state.token = _generateToken()">
                                                            <i class="fa fa-refresh"></i>
                                                        </button>
                                                    </div>
                                                    <small class="text-muted">å¿…é¡»ä¸ºè‹±æ–‡æˆ–æ•°å­—ï¼Œé•¿åº¦3-32å­—ç¬¦</small>
                                                </div>
                                                
                                                <!-- EncodingAESKey -->
                                                <div class="form-group mb-3">
                                                    <label for="encodingAesKey" class="form-label">
                                                        æ¶ˆæ¯åŠ è§£å¯†å¯†é’¥
                                                    </label>
                                                    <div class="input-group">
                                                        <input type="text" class="form-control" id="encodingAesKey"
                                                               t-att-value="state.encodingAesKey"
                                                               readonly>
                                                        <button class="btn btn-outline-secondary" type="button"
                                                                t-on-click="() => copyToClipboard(state.encodingAesKey)">
                                                            <i class="fa fa-copy"></i>
                                                        </button>
                                                        <button class="btn btn-outline-secondary" type="button"
                                                                t-on-click="() => state.encodingAesKey = _generateEncodingAESKey()">
                                                            <i class="fa fa-refresh"></i>
                                                        </button>
                                                    </div>
                                                    <small class="text-muted">é•¿åº¦å›ºå®šä¸º43ä½ï¼Œç”±è‹±æ–‡å¤§å°å†™å­—æ¯ã€æ•°å­—å’ŒåŠ å·æ–œçº¿ç»„æˆ</small>
                                                </div>
                                                
                                                <!-- æœåŠ¡å™¨åœ°å€ -->
                                                <div class="form-group mb-3">
                                                    <label for="serverUrl" class="form-label">
                                                        æœåŠ¡å™¨åœ°å€(URL)
                                                    </label>
                                                    <div class="input-group">
                                                        <input type="text" class="form-control" id="serverUrl"
                                                               t-att-value="state.serverUrl"
                                                               readonly>
                                                        <button class="btn btn-outline-secondary" type="button"
                                                                t-on-click="() => copyToClipboard(state.serverUrl)">
                                                            <i class="fa fa-copy"></i>
                                                        </button>
                                                    </div>
                                                    <small class="text-muted">
                                                        å°†æ­¤URLå¡«å†™åˆ°å¾®ä¿¡å…¬ä¼—å¹³å°-å¼€å‘-åŸºæœ¬é…ç½®-æœåŠ¡å™¨é…ç½®ä¸­
                                                    </small>
                                                </div>
                                            </div>
                                            
                                            <!-- æ“ä½œæŒ‰é’® -->
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <button type="button" class="btn btn-outline-info"
                                                            t-on-click="openWechatPlatform">
                                                        <i class="fa fa-external-link me-1"></i>
                                                        å‰å¾€å¾®ä¿¡å…¬ä¼—å¹³å°
                                                    </button>
                                                </div>
                                                <div>
                                                    <button type="button" class="btn btn-secondary me-2"
                                                            t-on-click="verifyConfig"
                                                            t-att-disabled="state.isLoading">
                                                        <t t-if="state.isLoading">
                                                            <i class="fa fa-spinner fa-spin me-1"></i>
                                                            éªŒè¯ä¸­...
                                                        </t>
                                                        <t t-else="">
                                                            <i class="fa fa-check-circle me-1"></i>
                                                            éªŒè¯é…ç½®
                                                        </t>
                                                    </button>
                                                    <button type="button" class="btn btn-primary"
                                                            t-on-click="saveConfig"
                                                            t-att-disabled="state.isLoading">
                                                        <t t-if="state.isLoading">
                                                            <i class="fa fa-spinner fa-spin me-1"></i>
                                                            ä¿å­˜ä¸­...
                                                        </t>
                                                        <t t-else="">
                                                            <i class="fa fa-save me-1"></i>
                                                            ä¿å­˜é…ç½®
                                                        </t>
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                        
                                        <!-- éªŒè¯çŠ¶æ€ -->
                                        <t t-if="state.isTesting">
                                            <div class="mt-4">
                                                <div class="alert alert-info">
                                                    <h5 class="alert-heading">
                                                        <i class="fa fa-info-circle me-2"></i>
                                                        é…ç½®è¯´æ˜
                                                    </h5>
                                                    <ol class="mb-0">
                                                        <li>ç™»å½•<a href="https://mp.weixin.qq.com/" target="_blank">å¾®ä¿¡å…¬ä¼—å¹³å°</a></li>
                                                        <li>è¿›å…¥ã€Œå¼€å‘ã€-ã€ŒåŸºæœ¬é…ç½®ã€</li>
                                                        <li>å°†ä¸Šè¿°é…ç½®ä¿¡æ¯å¡«å…¥å¾®ä¿¡å…¬ä¼—å¹³å°</li>
                                                        <li>åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°ç‚¹å‡»ã€Œæäº¤ã€è¿›è¡ŒéªŒè¯</li>
                                                        <li>éªŒè¯æˆåŠŸåè¿”å›æ­¤å¤„ç‚¹å‡»ã€Œä¿å­˜é…ç½®ã€</li>
                                                    </ol>
                                                </div>
                                                
                                                <div class="alert alert-warning">
                                                    <h5 class="alert-heading">
                                                        <i class="fa fa-exclamation-triangle me-2"></i>
                                                        æ³¨æ„äº‹é¡¹
                                                    </h5>
                                                    <ul class="mb-0">
                                                        <li>ç¡®ä¿æœåŠ¡å™¨å·²æ­£ç¡®éƒ¨ç½²ä¸”å¯é€šè¿‡å…¬ç½‘è®¿é—®</li>
                                                        <li>æœåŠ¡å™¨åœ°å€(URL)å¿…é¡»åŒ…å«åè®®å¤´ï¼ˆhttp:// æˆ– https://ï¼‰</li>
                                                        <li>Tokenå’ŒEncodingAESKeyä¸€æ—¦åœ¨å¾®ä¿¡å¹³å°è®¾ç½®ï¼Œè¯·å‹¿éšæ„ä¿®æ”¹</li>
                                                        <li>AppSecretæ˜¯æ•æ„Ÿä¿¡æ¯ï¼Œè¯·å¦¥å–„ä¿ç®¡</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </t>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </xpath>
        </template>
        
        <!-- å¾®ä¿¡é…ç½®èœå•é¡¹ -->
        <menuitem id="menu_wechat_config" 
                  name="å¾®ä¿¡é…ç½®"
                  parent="base.menu_config"
                  action="wechat_common.action_wechat_config"
                  sequence="100"/>
    </data>
</odoo>
```

#### **ä»»åŠ¡3ï¼šæ ·å¼è®¾è®¡**
```css
/* file: wechat_common/static/src/css/wechat_config.css */

.wechat-config-container {
    min-height: calc(100vh - 150px);
}

.wechat-config-form .form-label {
    font-weight: 500;
    color: #333;
}

.wechat-config-form .form-check {
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 6px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.wechat-config-form .form-check:hover {
    border-color: #07C160;
    background-color: rgba(7, 193, 96, 0.05);
}

.wechat-config-form .form-check-input:checked + .form-check-label {
    color: #07C160;
    font-weight: 600;
}

.wechat-config-form .form-check-input:checked ~ small {
    color: #07C160;
}

.wechat-config-form .input-group .btn-outline-secondary {
    border-color: #ced4da;
}

.wechat-config-form .input-group .btn-outline-secondary:hover {
    background-color: #f8f9fa;
    border-color: #07C160;
    color: #07C160;
}

/* éªŒè¯çŠ¶æ€æ ·å¼ */
.wechat-config-container .alert {
    border-left: 4px solid;
}

.wechat-config-container .alert-info {
    border-left-color: #17a2b8;
}

.wechat-config-container .alert-warning {
    border-left-color: #ffc107;
}

.wechat-config-container .alert-heading {
    font-size: 16px;
    margin-bottom: 10px;
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
    .wechat-config-container .card-body {
        padding: 1rem;
    }
    
    .wechat-config-form .row {
        margin-left: -0.5rem;
        margin-right: -0.5rem;
    }
    
    .wechat-config-form .col-md-6,
    .wechat-config-form .col-md-3 {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
    }
}
```

### **å¾®ä¿¡å¼€å‘ä¸“å®¶å…·ä½“ä»»åŠ¡ï¼š**

#### **ä»»åŠ¡1ï¼šå¾®ä¿¡APIæ¥å£è§„èŒƒè®¾è®¡**
```python
# file: wechat_common/docs/api_specification.md

# å¾®ä¿¡å…¬ä¼—å·APIæ¥å£è§„èŒƒ

## 1. åŸºç¡€çº¦å®š

### 1.1 è¯·æ±‚æ ¼å¼
- æ‰€æœ‰APIè¯·æ±‚ä½¿ç”¨HTTPSåè®®
- è¯·æ±‚æ–¹æ³•ï¼šGET/POSTï¼ˆæ ¹æ®å…·ä½“APIï¼‰
- è¯·æ±‚ç¼–ç ï¼šUTF-8
- å“åº”æ ¼å¼ï¼šJSON

### 1.2 é”™è¯¯ç å¤„ç†
```json
{
    "errcode": 0,        // 0è¡¨ç¤ºæˆåŠŸï¼Œå…¶ä»–è¡¨ç¤ºå¤±è´¥
    "errmsg": "ok",      // é”™è¯¯ä¿¡æ¯
    "data": {}           // ä¸šåŠ¡æ•°æ®ï¼ˆæˆåŠŸæ—¶è¿”å›ï¼‰
}
```

### 1.3 Access Tokenç®¡ç†
- Tokenæœ‰æ•ˆæœŸï¼š7200ç§’
- è·å–é¢‘ç‡é™åˆ¶ï¼š2000æ¬¡/å¤©
- å­˜å‚¨è¦æ±‚ï¼šRedisæˆ–æ•°æ®åº“ç¼“å­˜
- åˆ·æ–°ç­–ç•¥ï¼šæå‰300ç§’åˆ·æ–°

## 2. æ ¸å¿ƒAPIæ¥å£

### 2.1 ç”¨æˆ·ç®¡ç†æ¥å£

#### è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
```python
GET /cgi-bin/user/info
å‚æ•°ï¼š
    access_token: è°ƒç”¨æ¥å£å‡­è¯
    openid: ç”¨æˆ·çš„OpenID
    lang: è¿”å›å›½å®¶åœ°åŒºè¯­è¨€ç‰ˆæœ¬ï¼ˆzh_CN ç®€ä½“ï¼Œzh_TW ç¹ä½“ï¼Œen è‹±è¯­ï¼‰
```

#### è·å–ç”¨æˆ·åˆ—è¡¨
```python
GET /cgi-bin/user/get
å‚æ•°ï¼š
    access_token: è°ƒç”¨æ¥å£å‡­è¯
    next_openid: ç¬¬ä¸€ä¸ªæ‹‰å–çš„OPENIDï¼Œä¸å¡«é»˜è®¤ä»å¤´å¼€å§‹æ‹‰å–
```

#### è®¾ç½®ç”¨æˆ·å¤‡æ³¨å
```python
POST /cgi-bin/user/info/updateremark
å‚æ•°ï¼š
{
    "openid": "oDF3iY9ffA-hqb2vVvbr7qxf6A0Q",
    "remark": "VIPç”¨æˆ·"
}
```

### 2.2 æ¶ˆæ¯ç®¡ç†æ¥å£

#### å‘é€å®¢æœæ¶ˆæ¯
```python
POST /cgi-bin/message/custom/send
å‚æ•°ï¼š
{
    "touser": "OPENID",
    "msgtype": "text",
    "text": {
        "content": "Hello World"
    }
}
```

#### å‘é€æ¨¡æ¿æ¶ˆæ¯
```python
POST /cgi-bin/message/template/send
å‚æ•°ï¼š
{
    "touser": "OPENID",
    "template_id": "ngqIpbwh8bUfcSsECmogfXcV14J0tQlEpBO27izEYtY",
    "url": "http://weixin.qq.com/download",
    "data": {
        "first": {
            "value": "æ­å–œä½ è´­ä¹°æˆåŠŸï¼",
            "color": "#173177"
        },
        "keyword1": {
            "value": "å·§å…‹åŠ›",
            "color": "#173177"
        },
        "keyword2": {
            "value": "39.8å…ƒ",
            "color": "#173177"
        },
        "remark": {
            "value": "æ¬¢è¿å†æ¬¡è´­ä¹°ï¼",
            "color": "#173177"
        }
    }
}
```

### 2.3 èœå•ç®¡ç†æ¥å£

#### åˆ›å»ºè‡ªå®šä¹‰èœå•
```python
POST /cgi-bin/menu/create
å‚æ•°ï¼š
{
    "button": [
        {
            "type": "click",
            "name": "ä»Šæ—¥æ­Œæ›²",
            "key": "V1001_TODAY_MUSIC"
        },
        {
            "name": "èœå•",
            "sub_button": [
                {
                    "type": "view",
                    "name": "æœç´¢",
                    "url": "http://www.soso.com/"
                },
                {
                    "type": "click",
                    "name": "èµä¸€ä¸‹æˆ‘ä»¬",
                    "key": "V1001_GOOD"
                }
            ]
        }
    ]
}
```

### 2.4 ç´ æç®¡ç†æ¥å£

#### ä¸Šä¼ ä¸´æ—¶ç´ æ
```python
POST /cgi-bin/media/upload
å‚æ•°ï¼š
    access_token: è°ƒç”¨æ¥å£å‡­è¯
    type: åª’ä½“æ–‡ä»¶ç±»å‹ï¼ˆimage, voice, video, thumbï¼‰
    media: åª’ä½“æ–‡ä»¶ï¼ˆform-dataï¼‰
```

#### ä¸Šä¼ æ°¸ä¹…ç´ æ
```python
POST /cgi-bin/material/add_material
å‚æ•°ï¼š
    access_token: è°ƒç”¨æ¥å£å‡­è¯
    type: åª’ä½“æ–‡ä»¶ç±»å‹ï¼ˆimage, voice, video, thumbï¼‰
    media: åª’ä½“æ–‡ä»¶ï¼ˆform-dataï¼‰
    description: è§†é¢‘ç´ æçš„æè¿°ä¿¡æ¯ï¼ˆä»…è§†é¢‘éœ€è¦ï¼‰
```

## 3. æ¶ˆæ¯åŠ è§£å¯†è§„èŒƒ

### 3.1 å®‰å…¨æ¨¡å¼é€‰æ‹©
- æ˜æ–‡æ¨¡å¼ï¼šä¸åŠ å¯†ï¼Œä¸æ¨è
- å…¼å®¹æ¨¡å¼ï¼šæ˜æ–‡å’Œå¯†æ–‡å…±å­˜ï¼Œç”¨äºè¿‡æ¸¡
- å®‰å…¨æ¨¡å¼ï¼šå®Œå…¨åŠ å¯†ï¼Œæ¨è

### 3.2 åŠ è§£å¯†æµç¨‹
1. æ¥æ”¶æ¶ˆæ¯ï¼šéªŒè¯ç­¾å â†’ è§£å¯†æ¶ˆæ¯ â†’ å¤„ç†ä¸šåŠ¡ â†’ åŠ å¯†å›å¤ â†’ è¿”å›
2. å‘é€æ¶ˆæ¯ï¼šåŠ å¯†æ¶ˆæ¯ â†’ ç”Ÿæˆç­¾å â†’ å‘é€

### 3.3 æ¶ˆæ¯æ ¼å¼
```xml
<!-- åŠ å¯†æ¶ˆæ¯æ ¼å¼ -->
<xml>
    <ToUserName><![CDATA[toUser]]></ToUserName>
    <Encrypt><![CDATA[msg_encrypt]]></Encrypt>
</xml>

<!-- æ™®é€šæ¶ˆæ¯æ ¼å¼ -->
<xml>
    <ToUserName><![CDATA[toUser]]></ToUserName>
    <FromUserName><![CDATA[fromUser]]></FromUserName>
    <CreateTime>1348831860</CreateTime>
    <MsgType><![CDATA[text]]></MsgType>
    <Content><![CDATA[this is a test]]></Content>
    <MsgId>1234567890123456</MsgId>
</xml>
```

## 4. æœ€ä½³å®è·µ

### 4.1 é”™è¯¯å¤„ç†
- å®ç°é‡è¯•æœºåˆ¶ï¼ˆå¯¹äºå¯é‡è¯•é”™è¯¯ï¼‰
- è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
- å®ç°ç†”æ–­æœºåˆ¶

### 4.2 æ€§èƒ½ä¼˜åŒ–
- ä½¿ç”¨è¿æ¥æ± ç®¡ç†HTTPè¿æ¥
- å®ç°è¯·æ±‚ç¼“å­˜ï¼ˆåˆé€‚çš„åœºæ™¯ï¼‰
- æ‰¹é‡å¤„ç†ç”¨æˆ·è¯·æ±‚
- å¼‚æ­¥å¤„ç†è€—æ—¶æ“ä½œ

### 4.3 å®‰å…¨æ€§
- å®šæœŸæ›´æ¢AppSecret
- ä½¿ç”¨HTTPSä¼ è¾“æ•æ„Ÿæ•°æ®
- å®ç°IPç™½åå•æœºåˆ¶
- è®°å½•æ‰€æœ‰APIè°ƒç”¨æ—¥å¿—

## 5. é¢‘ç‡é™åˆ¶

### 5.1 æ¥å£è°ƒç”¨é¢‘ç‡é™åˆ¶
| æ¥å£ç±»åˆ« | é¢‘ç‡é™åˆ¶ |
|---------|---------|
| è·å–Access Token | 2000æ¬¡/å¤© |
| å‘é€å®¢æœæ¶ˆæ¯ | 500000æ¬¡/å¤© |
| è·å–ç”¨æˆ·ä¿¡æ¯ | 5000000æ¬¡/åˆ†é’Ÿ |
| èœå•æ“ä½œ | 1000æ¬¡/å¤© |

### 5.2 æœ€ä½³å®è·µ
- é¿å…åœ¨å¾ªç¯ä¸­é¢‘ç¹è°ƒç”¨åŒä¸€æ¥å£
- ä½¿ç”¨æ‰¹é‡æ¥å£æ›¿ä»£å•ä¸ªæ¥å£
- å®ç°æœ¬åœ°ç¼“å­˜å‡å°‘APIè°ƒç”¨
- ç›‘æ§APIä½¿ç”¨é‡é¿å…è¶…é™
```

#### **ä»»åŠ¡2ï¼šAccess Tokenç¼“å­˜ç­–ç•¥**
```python
# file: wechat_common/lib/token_cache.py

import redis
import json
import pickle
from datetime import datetime, timedelta
from typing import Optional, Dict, Any
import logging

_logger = logging.getLogger(__name__)

class TokenCache:
    """Tokenç¼“å­˜ç®¡ç†å™¨ï¼ˆæ”¯æŒRediså’Œå†…å­˜ç¼“å­˜ï¼‰"""
    
    def __init__(self, use_redis: bool = True, redis_config: Optional[Dict] = None):
        """
        åˆå§‹åŒ–ç¼“å­˜ç®¡ç†å™¨
        
        Args:
            use_redis: æ˜¯å¦ä½¿ç”¨Redisç¼“å­˜
            redis_config: Redisé…ç½®
        """
        self.use_redis = use_redis
        self.memory_cache = {}  # å†…å­˜ç¼“å­˜
        
        if use_redis:
            redis_config = redis_config or {
                'host': 'localhost',
                'port': 6379,
                'db': 0,
                'password': None,
                'decode_responses': False,
            }
            
            try:
                self.redis_client = redis.Redis(**redis_config)
                # æµ‹è¯•è¿æ¥
                self.redis_client.ping()
                _logger.info("Redisç¼“å­˜è¿æ¥æˆåŠŸ")
            except Exception as e:
                _logger.error(f"Redisè¿æ¥å¤±è´¥ï¼Œé™çº§ä¸ºå†…å­˜ç¼“å­˜: {str(e)}")
                self.use_redis = False
    
    def get(self, key: str) -> Optional[Any]:
        """è·å–ç¼“å­˜å€¼"""
        try:
            if self.use_redis:
                # Redisç¼“å­˜
                data = self.redis_client.get(key)
                if data:
                    return pickle.loads(data)
            else:
                # å†…å­˜ç¼“å­˜
                if key in self.memory_cache:
                    cache_item = self.memory_cache[key]
                    # æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
                    if datetime.now() < cache_item['expires_at']:
                        return cache_item['data']
                    else:
                        # æ¸…ç†è¿‡æœŸç¼“å­˜
                        del self.memory_cache[key]
        except Exception as e:
            _logger.error(f"è·å–ç¼“å­˜å¤±è´¥ {key}: {str(e)}")
        
        return None
    
    def set(self, key: str, value: Any, expires_in: int = 7100) -> bool:
        """è®¾ç½®ç¼“å­˜å€¼"""
        try:
            expires_at = datetime.now() + timedelta(seconds=expires_in)
            
            if self.use_redis:
                # Redisç¼“å­˜
                data = pickle.dumps(value)
                # è®¾ç½®è¿‡æœŸæ—¶é—´
                self.redis_client.setex(key, expires_in, data)
            else:
                # å†…å­˜ç¼“å­˜
                self.memory_cache[key] = {
                    'data': value,
                    'expires_at': expires_at,
                    'created_at': datetime.now(),
                }
            
            return True
        except Exception as e:
            _logger.error(f"è®¾ç½®ç¼“å­˜å¤±è´¥ {key}: {str(e)}")
            return False
    
    def delete(self, key: str) -> bool:
        """åˆ é™¤ç¼“å­˜"""
        try:
            if self.use_redis:
                self.redis_client.delete(key)
            elif key in self.memory_cache:
                del self.memory_cache[key]
            
            return True
        except Exception as e:
            _logger.error(f"åˆ é™¤ç¼“å­˜å¤±è´¥ {key}: {str(e)}")
            return False
    
    def exists(self, key: str) -> bool:
        """æ£€æŸ¥ç¼“å­˜æ˜¯å¦å­˜åœ¨"""
        try:
            if self.use_redis:
                return self.redis_client.exists(key) > 0
            else:
                if key in self.memory_cache:
                    # æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
                    cache_item = self.memory_cache[key]
                    if datetime.now() < cache_item['expires_at']:
                        return True
                    else:
                        del self.memory_cache[key]
                return False
        except Exception as e:
            _logger.error(f"æ£€æŸ¥ç¼“å­˜å¤±è´¥ {key}: {str(e)}")
            return False
    
    def clear_expired(self) -> int:
        """æ¸…ç†è¿‡æœŸç¼“å­˜ï¼ˆä»…å†…å­˜ç¼“å­˜éœ€è¦ï¼‰"""
        if self.use_redis:
            # Redisè‡ªåŠ¨å¤„ç†è¿‡æœŸ
            return 0
        
        now = datetime.now()
        expired_keys = []
        
        for key, cache_item in self.memory_cache.items():
            if now >= cache_item['expires_at']:
                expired_keys.append(key)
        
        for key in expired_keys:
            del self.memory_cache[key]
        
        return len(expired_keys)
    
    def get_stats(self) -> Dict[str, Any]:
        """è·å–ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯"""
        try:
            if self.use_redis:
                info = self.redis_client.info()
                return {
                    'type': 'redis',
                    'connected_clients': info.get('connected_clients', 0),
                    'used_memory': info.get('used_memory_human', '0'),
                    'keyspace_hits': info.get('keyspace_hits', 0),
                    'keyspace_misses': info.get('keyspace_misses', 0),
                }
            else:
                return {
                    'type': 'memory',
                    'total_keys': len(self.memory_cache),
                    'expired_keys': self.clear_expired(),
                    'memory_usage': 'N/A',
                }
        except Exception as e:
            _logger.error(f"è·å–ç¼“å­˜ç»Ÿè®¡å¤±è´¥: {str(e)}")
            return {'type': 'unknown', 'error': str(e)}


class DistributedTokenCache(TokenCache):
    """åˆ†å¸ƒå¼Tokenç¼“å­˜ï¼ˆæ”¯æŒå¤šèŠ‚ç‚¹éƒ¨ç½²ï¼‰"""
    
    def __init__(self, use_redis: bool = True, redis_config: Optional[Dict] = None):
        super().__init__(use_redis, redis_config)
        
        # åˆ†å¸ƒå¼é”ç›¸å…³
        self.lock_timeout = 30  # é”è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
        self.retry_delay = 0.1  # é‡è¯•å»¶è¿Ÿï¼ˆç§’ï¼‰
        self.max_retries = 3    # æœ€å¤§é‡è¯•æ¬¡æ•°
    
    def acquire_lock(self, lock_key: str, timeout: Optional[int] = None) -> bool:
        """è·å–åˆ†å¸ƒå¼é”"""
        if not self.use_redis:
            # éRedisç¯å¢ƒä½¿ç”¨çº¿ç¨‹é”ï¼ˆç®€åŒ–å¤„ç†ï¼‰
            return True
        
        timeout = timeout or self.lock_timeout
        lock_identifier = f"lock:{lock_key}"
        
        for i in range(self.max_retries):
            try:
                # å°è¯•è·å–é”
                acquired = self.redis_client.set(
                    lock_identifier, 
                    str(datetime.now()), 
                    nx=True, 
                    ex=timeout
                )
                
                if acquired:
                    return True
                
                # ç­‰å¾…åé‡è¯•
                import time
                time.sleep(self.retry_delay)
                
            except Exception as e:
                _logger.error(f"è·å–é”å¤±è´¥ {lock_key}: {str(e)}")
                break
        
        return False
    
    def release_lock(self, lock_key: str) -> bool:
        """é‡Šæ”¾åˆ†å¸ƒå¼é”"""
        if not self.use_redis:
            return True
        
        lock_identifier = f"lock:{lock_key}"
        
        try:
            self.redis_client.delete(lock_identifier)
            return True
        except Exception as e:
            _logger.error(f"é‡Šæ”¾é”å¤±è´¥ {lock_key}: {str(e)}")
            return False
    
    def get_token_with_lock(self, app_id: str) -> Optional[str]:
        """ä½¿ç”¨åˆ†å¸ƒå¼é”å®‰å…¨è·å–Token"""
        token_key = f"wechat:token:{app_id}"
        
        # 1. å°è¯•ä»ç¼“å­˜è·å–
        cached_token = self.get(token_key)
        if cached_token:
            return cached_token
        
        # 2. è·å–åˆ†å¸ƒå¼é”
        lock_key = f"token_refresh:{app_id}"
        if not self.acquire_lock(lock_key):
            _logger.warning(f"è·å–Tokenåˆ·æ–°é”å¤±è´¥: {app_id}")
            return None
        
        try:
            # 3. å†æ¬¡æ£€æŸ¥ç¼“å­˜ï¼ˆé˜²æ­¢é‡å¤åˆ·æ–°ï¼‰
            cached_token = self.get(token_key)
            if cached_token:
                return cached_token
            
            # 4. è¿™é‡Œåº”è¯¥è°ƒç”¨å¾®ä¿¡APIè·å–æ–°Token
            # åœ¨å®é™…å®ç°ä¸­ï¼Œè¿™é‡Œä¼šè°ƒç”¨å¾®ä¿¡API
            # ä¸ºç®€åŒ–ç¤ºä¾‹ï¼Œæˆ‘ä»¬è¿”å›None
            
            return None
            
        finally:
            # 5. é‡Šæ”¾é”
            self.release_lock(lock_key)
    
    def refresh_token_distributed(self, app_id: str, app_secret: str) -> Optional[Dict]:
        """åˆ†å¸ƒå¼Tokenåˆ·æ–°"""
        lock_key = f"token_refresh:{app_id}"
        
        # è·å–é”
        if not self.acquire_lock(lock_key, timeout=60):  # 1åˆ†é’Ÿè¶…æ—¶
            _logger.warning(f"è·å–Tokenåˆ·æ–°é”å¤±è´¥: {app_id}")
            return None
        
        try:
            # æ¨¡æ‹Ÿè°ƒç”¨å¾®ä¿¡APIè·å–Token
            # å®é™…å®ç°ä¸­åº”è¯¥è°ƒç”¨å¾®ä¿¡API
            import time
            import random
            
            # æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
            time.sleep(0.5)
            
            # ç”Ÿæˆæ¨¡æ‹ŸToken
            new_token = {
                'access_token': f"mock_token_{app_id}_{int(time.time())}",
                'expires_in': 7200,
                'timestamp': datetime.now(),
            }
            
            # ç¼“å­˜Token
            token_key = f"wechat:token:{app_id}"
            self.set(token_key, new_token['access_token'], new_token['expires_in'] - 100)
            
            # ç¼“å­˜å®Œæ•´Tokenä¿¡æ¯ï¼ˆç”¨äºç›‘æ§ï¼‰
            token_info_key = f"wechat:token_info:{app_id}"
            self.set(token_info_key, new_token, new_token['expires_in'] - 100)
            
            return new_token
            
        except Exception as e:
            _logger.error(f"åˆ†å¸ƒå¼åˆ·æ–°Tokenå¤±è´¥ {app_id}: {str(e)}")
            return None
        finally:
            self.release_lock(lock_key)
```

### **å®‰å…¨å®¡æŸ¥ä¸“å®¶å…·ä½“ä»»åŠ¡ï¼š**

#### **ä»»åŠ¡1ï¼šå¾®ä¿¡APIå®‰å…¨å®¡æŸ¥**
```python
# file: security/wechat_api_security.py

import re
import json
import hashlib
import hmac
from typing import Dict, List, Optional, Tuple
from datetime import datetime, timedelta
import logging

_logger = logging.getLogger(__name__)

class WechatAPISecurityAuditor:
    """å¾®ä¿¡APIå®‰å…¨å®¡æŸ¥å™¨"""
    
    def __init__(self):
        self.security_rules = self._load_security_rules()
        
    def _load_security_rules(self) -> Dict:
        """åŠ è½½å®‰å…¨è§„åˆ™"""
        return {
            'access_token': {
                'max_age': 7100,  # æœ€å¤§å¹´é¾„ï¼ˆç§’ï¼‰
                'refresh_before': 300,  # æå‰åˆ·æ–°æ—¶é—´ï¼ˆç§’ï¼‰
                'storage_encryption': True,  # å­˜å‚¨åŠ å¯†
                'log_access': True,  # è®°å½•è®¿é—®æ—¥å¿—
            },
            'api_rate_limits': {
                'token_refresh': {'daily': 2000, 'minutely': 10},
                'user_info': {'minutely': 5000000, 'daily': 5000000},
                'message_send': {'daily': 500000},
                'menu_operation': {'daily': 1000},
            },
            'input_validation': {
                'openid_pattern': r'^[a-zA-Z0-9_-]{28}$',
                'appid_pattern': r'^wx[0-9a-f]{16}$',
                'url_pattern': r'^https?://[^\s]+$',
                'content_max_length': 2048,
            },
            'crypto_requirements': {
                'min_key_length': 128,
                'required_algorithms': ['AES-256-CBC', 'SHA-256', 'HMAC-SHA256'],
                'salt_required': True,
            }
        }
    
    def audit_access_token_management(self, token_config: Dict) -> List[Tuple[str, str]]:
        """å®¡è®¡Access Tokenç®¡ç†"""
        findings = []
        
        # æ£€æŸ¥Tokenå­˜å‚¨å®‰å…¨
        if not token_config.get('encrypted_storage', False):
            findings.append(('HIGH', 'Access TokenæœªåŠ å¯†å­˜å‚¨'))
        
        # æ£€æŸ¥Tokenåˆ·æ–°ç­–ç•¥
        refresh_threshold = token_config.get('refresh_threshold', 0)
        if refresh_threshold < 300:
            findings.append(('MEDIUM', f'Tokenåˆ·æ–°é˜ˆå€¼è¿‡ä½: {refresh_threshold}ç§’ï¼Œå»ºè®®è‡³å°‘300ç§’'))
        
        # æ£€æŸ¥Tokenæœ‰æ•ˆæœŸç›‘æ§
        if not token_config.get('expiry_monitoring', False):
            findings.append(('MEDIUM', 'ç¼ºå°‘Tokenæœ‰æ•ˆæœŸç›‘æ§'))
        
        # æ£€æŸ¥Tokenè®¿é—®æ—¥å¿—
        if not token_config.get('access_logging', False):
            findings.append(('LOW', 'ç¼ºå°‘Tokenè®¿é—®æ—¥å¿—è®°å½•'))
        
        return findings
    
    def audit_api_rate_limiting(self, api_logs: List[Dict]) -> List[Tuple[str, str]]:
        """å®¡è®¡APIé¢‘ç‡é™åˆ¶"""
        findings = []
        
        # æŒ‰æ¥å£ç±»å‹ç»Ÿè®¡è°ƒç”¨æ¬¡æ•°
        api_counts = {}
        for log in api_logs:
            api_type = log.get('api_type', 'unknown')
            api_counts[api_type] = api_counts.get(api_type, 0) + 1
        
        # æ£€æŸ¥æ˜¯å¦è¶…è¿‡é™åˆ¶
        rate_limits = self.security_rules['api_rate_limits']
        
        for api_type, count in api_counts.items():
            limits = rate_limits.get(api_type, {})
            
            # æ£€æŸ¥åˆ†é’Ÿçº§é™åˆ¶
            minutely_limit = limits.get('minutely')
            if minutely_limit and count > minutely_limit:
                findings.append((
                    'HIGH',
                    f'APIè°ƒç”¨é¢‘ç‡è¶…é™: {api_type} æ¯åˆ†é’Ÿè°ƒç”¨{count}æ¬¡ï¼Œé™åˆ¶{minutely_limit}æ¬¡'
                ))
            
            # æ£€æŸ¥å¤©çº§é™åˆ¶ï¼ˆéœ€è¦æŒ‰å¤©ç»Ÿè®¡ï¼‰
            daily_limit = limits.get('daily')
            if daily_limit:
                # è¿™é‡Œéœ€è¦å®é™…çš„æŒ‰å¤©ç»Ÿè®¡é€»è¾‘
                pass
        
        return findings
    
    def audit_input_validation(self, validation_config: Dict) -> List[Tuple[str, str]]:
        """å®¡è®¡è¾“å…¥éªŒè¯"""
        findings = []
        
        validation_rules = self.security_rules['input_validation']
        
        # æ£€æŸ¥OpenIDéªŒè¯
        if not validation_config.get('openid_validation', False):
            findings.append(('HIGH', 'ç¼ºå°‘OpenIDæ ¼å¼éªŒè¯'))
        
        # æ£€æŸ¥AppIDéªŒè¯
        if not validation_config.get('appid_validation', False):
            findings.append(('HIGH', 'ç¼ºå°‘AppIDæ ¼å¼éªŒè¯'))
        
        # æ£€æŸ¥URLéªŒè¯
        if not validation_config.get('url_validation', False):
            findings.append(('MEDIUM', 'ç¼ºå°‘URLæ ¼å¼éªŒè¯'))
        
        # æ£€æŸ¥å†…å®¹é•¿åº¦é™åˆ¶
        max_length = validation_config.get('content_max_length', 0)
        if max_length < validation_rules['content_max_length']:
            findings.append((
                'MEDIUM',
                f'å†…å®¹é•¿åº¦é™åˆ¶è¿‡ä½: {max_length}ï¼Œå»ºè®®è‡³å°‘{validation_rules["content_max_length"]}'
            ))
        
        return findings
    
    def audit_cryptography(self, crypto_config: Dict) -> List[Tuple[str, str]]:
        """å®¡è®¡åŠ å¯†å®ç°"""
        findings = []
        
        crypto_rules = self.security_rules['crypto_requirements']
        
        # æ£€æŸ¥å¯†é’¥é•¿åº¦
        key_length = crypto_config.get('key_length', 0)
        if key_length < crypto_rules['min_key_length']:
            findings.append((
                'HIGH',
                f'åŠ å¯†å¯†é’¥é•¿åº¦ä¸è¶³: {key_length}ä½ï¼Œå»ºè®®è‡³å°‘{crypto_rules["min_key_length"]}ä½'
            ))
        
        # æ£€æŸ¥åŠ å¯†ç®—æ³•
        algorithms = crypto_config.get('algorithms', [])
        required_algorithms = crypto_rules['required_algorithms']
        
        for required_alg in required_algorithms:
            if required_alg not in algorithms:
                findings.append((
                    'HIGH',
                    f'ç¼ºå°‘å¿…è¦çš„åŠ å¯†ç®—æ³•: {required_alg}'
                ))
        
        # æ£€æŸ¥ç›å€¼ä½¿ç”¨
        if not crypto_config.get('use_salt', False):
            findings.append(('MEDIUM', 'åŠ å¯†æœªä½¿ç”¨ç›å€¼ï¼Œå®¹æ˜“å—åˆ°å½©è™¹è¡¨æ”»å‡»'))
        
        # æ£€æŸ¥IVä½¿ç”¨
        if not crypto_config.get('use_iv', False):
            findings.append(('HIGH', 'åŠ å¯†æœªä½¿ç”¨åˆå§‹åŒ–å‘é‡(IV)'))
        
        return findings
    
    def audit_message_handling(self, message_config: Dict) -> List[Tuple[str, str]]:
        """å®¡è®¡æ¶ˆæ¯å¤„ç†å®‰å…¨"""
        findings = []
        
        # æ£€æŸ¥æ¶ˆæ¯ç­¾åéªŒè¯
        if not message_config.get('signature_verification', False):
            findings.append(('CRITICAL', 'ç¼ºå°‘æ¶ˆæ¯ç­¾åéªŒè¯'))
        
        # æ£€æŸ¥æ¶ˆæ¯é‡æ”¾æ”»å‡»é˜²æŠ¤
        if not message_config.get('replay_protection', False):
            findings.append(('HIGH', 'ç¼ºå°‘æ¶ˆæ¯é‡æ”¾æ”»å‡»é˜²æŠ¤'))
        
        # æ£€æŸ¥æ¶ˆæ¯æ—¶æ•ˆæ€§éªŒè¯
        timestamp_validation = message_config.get('timestamp_validation', {})
        max_age = timestamp_validation.get('max_age', 0)
        if max_age > 300:  # 5åˆ†é’Ÿ
            findings.append((
                'MEDIUM',
                f'æ¶ˆæ¯æ—¶é—´æˆ³éªŒè¯çª—å£è¿‡å¤§: {max_age}ç§’ï¼Œå»ºè®®ä¸è¶…è¿‡300ç§’'
            ))
        
        # æ£€æŸ¥æ•æ„Ÿä¿¡æ¯è¿‡æ»¤
        if not message_config.get('sensitive_data_filtering', False):
            findings.append(('MEDIUM', 'ç¼ºå°‘æ•æ„Ÿä¿¡æ¯è¿‡æ»¤'))
        
        return findings
    
    def audit_configuration_security(self, config: Dict) -> List[Tuple[str, str]]:
        """å®¡è®¡é…ç½®å®‰å…¨"""
        findings = []
        
        # æ£€æŸ¥æ•æ„Ÿé…ç½®å­˜å‚¨
        sensitive_fields = ['app_secret', 'encoding_aes_key', 'private_key']
        
        for field in sensitive_fields:
            if field in config and not config.get(f'{field}_encrypted', False):
                findings.append((
                    'HIGH',
                    f'æ•æ„Ÿé…ç½®å­—æ®µæœªåŠ å¯†å­˜å‚¨: {field}'
                ))
        
        # æ£€æŸ¥é…ç½®è®¿é—®æ§åˆ¶
        if not config.get('config_access_control', False):
            findings.append(('MEDIUM', 'ç¼ºå°‘é…ç½®è®¿é—®æ§åˆ¶'))
        
        # æ£€æŸ¥é…ç½®å˜æ›´å®¡è®¡
        if not config.get('config_change_audit', False):
            findings.append(('MEDIUM', 'ç¼ºå°‘é…ç½®å˜æ›´å®¡è®¡æ—¥å¿—'))
        
        # æ£€æŸ¥é»˜è®¤é…ç½®å®‰å…¨
        default_config = config.get('default_config', {})
        if default_config.get('debug_mode', False):
            findings.append(('LOW', 'ç”Ÿäº§ç¯å¢ƒå¯ç”¨è°ƒè¯•æ¨¡å¼'))
        
        return findings
    
    def generate_security_report(self, audit_data: Dict) -> Dict:
        """ç”Ÿæˆå®‰å…¨å®¡è®¡æŠ¥å‘Š"""
        report = {
            'timestamp': datetime.now().isoformat(),
            'summary': {
                'critical': 0,
                'high': 0,
                'medium': 0,
                'low': 0,
                'total': 0,
            },
            'findings': [],
            'recommendations': [],
            'score': 100,  # åˆå§‹åˆ†æ•°
        }
        
        # æ‰§è¡Œå„é¡¹å®¡è®¡
        all_findings = []
        
        # Access Tokenç®¡ç†å®¡è®¡
        token_findings = self.audit_access_token_management(
            audit_data.get('access_token_config', {})
        )
        all_findings.extend(token_findings)
        
        # APIé¢‘ç‡é™åˆ¶å®¡è®¡
        api_findings = self.audit_api_rate_limiting(
            audit_data.get('api_logs', [])
        )
        all_findings.extend(api_findings)
        
        # è¾“å…¥éªŒè¯å®¡è®¡
        validation_findings = self.audit_input_validation(
            audit_data.get('validation_config', {})
        )
        all_findings.extend(validation_findings)
        
        # åŠ å¯†å®ç°å®¡è®¡
        crypto_findings = self.audit_cryptography(
            audit_data.get('crypto_config', {})
        )
        all_findings.extend(crypto_findings)
        
        # æ¶ˆæ¯å¤„ç†å®¡è®¡
        message_findings = self.audit_message_handling(
            audit_data.get('message_config', {})
        )
        all_findings.extend(message_findings)
        
        # é…ç½®å®‰å…¨å®¡è®¡
        config_findings = self.audit_configuration_security(
            audit_data.get('config_security', {})
        )
        all_findings.extend(config_findings)
        
        # ç»Ÿè®¡å‘ç°é¡¹
        severity_weights = {
            'CRITICAL': 10,
            'HIGH': 5,
            'MEDIUM': 3,
            'LOW': 1,
        }
        
        for severity, description in all_findings:
            report['findings'].append({
                'severity': severity,
                'description': description,
                'timestamp': datetime.now().isoformat(),
            })
            
            # æ›´æ–°ç»Ÿè®¡
            report['summary'][severity.lower()] += 1
            report['summary']['total'] += 1
            
            # è®¡ç®—å®‰å…¨åˆ†æ•°
            report['score'] -= severity_weights.get(severity, 1)
        
        # ç”Ÿæˆå»ºè®®
        if report['summary']['critical'] > 0:
            report['recommendations'].append('ç«‹å³ä¿®å¤æ‰€æœ‰å…³é”®å®‰å…¨é—®é¢˜')
        
        if report['summary']['high'] > 0:
            report['recommendations'].append('ä¼˜å…ˆä¿®å¤é«˜é£é™©å®‰å…¨é—®é¢˜')
        
        if report['score'] < 80:
            report['recommendations'].append('å®æ–½å…¨é¢çš„å®‰å…¨åŠ å›ºæªæ–½')
        
        # é€šç”¨å»ºè®®
        report['recommendations'].extend([
            'å®šæœŸè¿›è¡Œå®‰å…¨å®¡è®¡',
            'å®æ–½å®‰å…¨å¼€å‘æµç¨‹',
            'åŠ å¼ºå‘˜å·¥å®‰å…¨æ„è¯†åŸ¹è®­',
            'å»ºç«‹å®‰å…¨äº‹ä»¶å“åº”æœºåˆ¶',
        ])
        
        # ç¡®ä¿åˆ†æ•°ä¸ä½äº0
        report['score'] = max(0, report['score'])
        
        return report
    
    def check_wechat_message_security(self, message: Dict, 
                                     app_secret: str, 
                                     received_signature: str) -> Tuple[bool, str]:
        """éªŒè¯å¾®ä¿¡æ¶ˆæ¯å®‰å…¨æ€§"""
        try:
            # æå–å‚æ•°
            timestamp = message.get('timestamp', '')
            nonce = message.get('nonce', '')
            echostr = message.get('echostr', '')
            
            # éªŒè¯ç­¾å
            data = sorted([app_secret, timestamp, nonce])
            data_str = ''.join(data)
            
            expected_signature = hashlib.sha1(data_str.encode('utf-8')).hexdigest()
            
            if expected_signature != received_signature:
                return False, 'ç­¾åéªŒè¯å¤±è´¥'
            
            # éªŒè¯æ—¶é—´æˆ³ï¼ˆé˜²æ­¢é‡æ”¾æ”»å‡»ï¼‰
            if timestamp:
                message_time = datetime.fromtimestamp(int(timestamp))
                current_time = datetime.now()
                
                # å…è®¸5åˆ†é’Ÿçš„æ—¶é—´å·®
                if abs((current_time - message_time).total_seconds()) > 300:
                    return False, 'æ¶ˆæ¯æ—¶é—´æˆ³è¶…å‡ºå…è®¸èŒƒå›´'
            
            # éªŒè¯æ¶ˆæ¯æ ¼å¼
            if 'openid' in message:
                openid = message['openid']
                if not re.match(self.security_rules['input_validation']['openid_pattern'], openid):
                    return False, 'OpenIDæ ¼å¼æ— æ•ˆ'
            
            return True, 'éªŒè¯é€šè¿‡'
            
        except Exception as e:
            _logger.error(f"æ¶ˆæ¯å®‰å…¨éªŒè¯å¤±è´¥: {str(e)}")
            return False, f'éªŒè¯å¼‚å¸¸: {str(e)}'
```

#### **ä»»åŠ¡2ï¼šè‡ªåŠ¨åŒ–å®‰å…¨æ‰«æè„šæœ¬**
```python
# file: scripts/wechat_security_scan.py

#!/usr/bin/env python3
"""
å¾®ä¿¡å…¬ä¼—å·å®‰å…¨æ‰«æè„šæœ¬
ç”¨äºè‡ªåŠ¨åŒ–æ‰«æå¾®ä¿¡ç›¸å…³ä»£ç å’Œé…ç½®çš„å®‰å…¨é—®é¢˜
"""

import os
import sys
import json
import argparse
import re
from pathlib import Path
from typing import List, Dict, Tuple
import logging

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°Pythonè·¯å¾„
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from security.wechat_api_security import WechatAPISecurityAuditor

_logger = logging.getLogger(__name__)

class WechatSecurityScanner:
    """å¾®ä¿¡å…¬ä¼—å·å®‰å…¨æ‰«æå™¨"""
    
    def __init__(self, project_path: str):
        self.project_path = Path(project_path)
        self.auditor = WechatAPISecurityAuditor()
        
        # å®šä¹‰å®‰å…¨æ¨¡å¼
        self.security_patterns = {
            'hardcoded_secrets': [
                r'app_secret\s*[:=]\s*["\'][^"\']{10,}["\']',
                r'appid\s*[:=]\s*["\']wx[0-9a-f]{16}["\']',
                r'encoding_aes_key\s*[:=]\s*["\'][^"\']{43}["\']',
                r'access_token\s*[:=]\s*["\'][^"\']{30,}["\']',
            ],
            'insecure_crypto': [
                r'cryptography\.hazmat\.primitives\.cipher\.(?!AES)',
                r'cryptography\.hazmat\.primitives\.cipher\.modes\.(ECB|OFB|CFB)',
                r'hashlib\.(md5|sha1)\(',
                r'base64\.(b64encode|b64decode)\(',
            ],
            'sql_injection': [
                r'execute\s*\([^)]*\%s[^)]*\)',
                r'SELECT.*FROM.*WHERE.*\+',
                r'f"SELECT.*{.*}',
            ],
            'xss_vulnerabilities': [
                r'response\.write\(.*request\.GET',
                r'render_template.*request\.args',
                r'<script>.*</script>',
            ],
            'rate_limit_bypass': [
                r'sleep\s*\([^)]*\)',
                r'time\.sleep\s*\([^)]*\)',
                r'while.*True.*:',
            ],
        }
    
    def scan_directory(self, directory: str, extensions: List[str] = None) -> List[Dict]:
        """æ‰«æç›®å½•ä¸­çš„æ–‡ä»¶"""
        if extensions is None:
            extensions = ['.py', '.js', '.xml', '.html']
        
        findings = []
        dir_path = Path(directory)
        
        for ext in extensions:
            for file_path in dir_path.rglob(f'*{ext}'):
                if self._should_skip_file(file_path):
                    continue
                
                file_findings = self.scan_file(file_path)
                if file_findings:
                    findings.extend(file_findings)
        
        return findings
    
    def _should_skip_file(self, file_path: Path) -> bool:
        """åˆ¤æ–­æ˜¯å¦åº”è¯¥è·³è¿‡æ–‡ä»¶"""
        skip_patterns = [
            '__pycache__',
            '.git',
            '.idea',
            'venv',
            'node_modules',
            'test_',
            '__init__.py',
        ]
        
        file_str = str(file_path)
        return any(pattern in file_str for pattern in skip_patterns)
    
    def scan_file(self, file_path: Path) -> List[Dict]:
        """æ‰«æå•ä¸ªæ–‡ä»¶"""
        findings = []
        
        try:
            content = file_path.read_text(encoding='utf-8', errors='ignore')
            
            for category, patterns in self.security_patterns.items():
                for pattern in patterns:
                    matches = re.finditer(pattern, content, re.IGNORECASE)
                    
                    for match in matches:
                        # è·å–è¡Œå·å’Œä¸Šä¸‹æ–‡
                        line_number = self._get_line_number(content, match.start())
                        line_content = self._get_line_content(content, line_number)
                        
                        finding = {
                            'file': str(file_path.relative_to(self.project_path)),
                            'line': line_number,
                            'category': category,
                            'pattern': pattern,
                            'match': match.group()[:100],  # æˆªæ–­åŒ¹é…å†…å®¹
                            'line_content': line_content.strip(),
                            'severity': self._get_severity(category),
                        }
                        
                        findings.append(finding)
            
        except Exception as e:
            _logger.error(f"æ‰«ææ–‡ä»¶å¤±è´¥ {file_path}: {str(e)}")
        
        return findings
    
    def _get_line_number(self, content: str, position: int) -> int:
        """è·å–æŒ‡å®šä½ç½®çš„è¡Œå·"""
        return content[:position].count('\n') + 1
    
    def _get_line_content(self, content: str, line_number: int) -> str:
        """è·å–æŒ‡å®šè¡Œçš„å†…å®¹"""
        lines = content.split('\n')
        if 1 <= line_number <= len(lines):
            return lines[line_number - 1]
        return ''
    
    def _get_severity(self, category: str) -> str:
        """è·å–é—®é¢˜ä¸¥é‡æ€§"""
        severity_map = {
            'hardcoded_secrets': 'CRITICAL',
            'insecure_crypto': 'HIGH',
            'sql_injection': 'HIGH',
            'xss_vulnerabilities': 'MEDIUM',
            'rate_limit_bypass': 'MEDIUM',
        }
        return severity_map.get(category, 'LOW')
    
    def scan_config_files(self) -> List[Dict]:
        """æ‰«æé…ç½®æ–‡ä»¶"""
        findings = []
        config_patterns = {
            'database': r'(password|passwd|pwd)\s*[:=]\s*["\'][^"\']+["\']',
            'redis': r'(password|auth)\s*[:=]\s*["\'][^"\']+["\']',
            'api_keys': r'(api[_-]?key|secret[_-]?key)\s*[:=]\s*["\'][^"\']+["\']',
        }
        
        config_files = [
            'odoo.conf',
            'production.conf',
            '.env',
            'config.json',
            'settings.py',
        ]
        
        for config_file in config_files:
            file_path = self.project_path / config_file
            if file_path.exists():
                try:
                    content = file_path.read_text(encoding='utf-8', errors='ignore')
                    
                    for category, pattern in config_patterns.items():
                        matches = re.finditer(pattern, content, re.IGNORECASE)
                        
                        for match in matches:
                            line_number = self._get_line_number(content, match.start())
                            line_content = self._get_line_content(content, line_number)
                            
                            finding = {
                                'file': config_file,
                                'line': line_number,
                                'category': 'config_secret',
                                'pattern': pattern,
                                'match': match.group(),
                                'line_content': line_content.strip(),
                                'severity': 'HIGH',
                            }
                            
                            findings.append(finding)
                            
                except Exception as e:
                    _logger.error(f"æ‰«æé…ç½®æ–‡ä»¶å¤±è´¥ {config_file}: {str(e)}")
        
        return findings
    
    def check_dependencies(self) -> List[Dict]:
        """æ£€æŸ¥ä¾èµ–åŒ…å®‰å…¨æ€§"""
        findings = []
        
        # æ£€æŸ¥requirements.txt
        requirements_file = self.project_path / 'requirements.txt'
        if requirements_file.exists():
            try:
                content = requirements_file.read_text(encoding='utf-8')
                lines = content.split('\n')
                
                # å·²çŸ¥çš„ä¸å®‰å…¨åŒ…
                insecure_packages = {
                    'Django': '<2.2.0',
                    'Flask': '<1.0.0',
                    'requests': '<2.20.0',
                    'cryptography': '<2.7',
                    'paramiko': '<2.4.0',
                }
                
                for line_num, line in enumerate(lines, 1):
                    line = line.strip()
                    if line and not line.startswith('#'):
                        for package, min_version in insecure_packages.items():
                            if package.lower() in line.lower():
                                finding = {
                                    'file': 'requirements.txt',
                                    'line': line_num,
                                    'category': 'insecure_dependency',
                                    'pattern': package,
                                    'match': line,
                                    'line_content': line,
                                    'severity': 'MEDIUM',
                                    'recommendation': f'å‡çº§ {package} åˆ° {min_version} æˆ–æ›´é«˜ç‰ˆæœ¬',
                                }
                                findings.append(finding)
                                
            except Exception as e:
                _logger.error(f"æ£€æŸ¥ä¾èµ–å¤±è´¥: {str(e)}")
        
        return findings
    
    def generate_report(self, findings: List[Dict]) -> Dict:
        """ç”Ÿæˆæ‰«ææŠ¥å‘Š"""
        report = {
            'scan_time': datetime.now().isoformat(),
            'project_path': str(self.project_path),
            'summary': {
                'critical': 0,
                'high': 0,
                'medium': 0,
                'low': 0,
                'total': len(findings),
            },
            'findings_by_category': {},
            'findings_by_file': {},
            'detailed_findings': findings,
        }
        
        # ç»Ÿè®¡ä¸¥é‡æ€§
        for finding in findings:
            severity = finding['severity'].lower()
            report['summary'][severity] += 1
            
            # æŒ‰ç±»åˆ«ç»Ÿè®¡
            category = finding['category']
            report['findings_by_category'][category] = report['findings_by_category'].get(category, 0) + 1
            
            # æŒ‰æ–‡ä»¶ç»Ÿè®¡
            file = finding['file']
            report['findings_by_file'][file] = report['findings_by_file'].get(file, 0) + 1
        
        return report
    
    def run_comprehensive_scan(self) -> Dict:
        """è¿è¡Œå…¨é¢æ‰«æ"""
        _logger.info("å¼€å§‹å®‰å…¨æ‰«æ...")
        
        all_findings = []
        
        # 1. æ‰«æä»£ç æ–‡ä»¶
        _logger.info("æ‰«æä»£ç æ–‡ä»¶...")
        code_findings = self.scan_directory(str(self.project_path))
        all_findings.extend(code_findings)
        
        # 2. æ‰«æé…ç½®æ–‡ä»¶
        _logger.info("æ‰«æé…ç½®æ–‡ä»¶...")
        config_findings = self.scan_config_files()
        all_findings.extend(config_findings)
        
        # 3. æ£€æŸ¥ä¾èµ–
        _logger.info("æ£€æŸ¥ä¾èµ–åŒ…...")
        dependency_findings = self.check_dependencies()
        all_findings.extend(dependency_findings)
        
        # 4. ç”ŸæˆæŠ¥å‘Š
        _logger.info("ç”Ÿæˆæ‰«ææŠ¥å‘Š...")
        report = self.generate_report(all_findings)
        
        # 5. è¾“å‡ºæ‘˜è¦
        summary = report['summary']
        _logger.info(f"æ‰«æå®Œæˆï¼å‘ç° {summary['total']} ä¸ªé—®é¢˜:")
        _logger.info(f"  ä¸¥é‡: {summary['critical']}")
        _logger.info(f"  é«˜: {summary['high']}")
        _logger.info(f"  ä¸­: {summary['medium']}")
        _logger.info(f"  ä½: {summary['low']}")
        
        return report

def main():
    """ä¸»å‡½æ•°"""
    parser = argparse.ArgumentParser(description='å¾®ä¿¡å…¬ä¼—å·å®‰å…¨æ‰«æå·¥å…·')
    parser.add_argument('project_path', help='é¡¹ç›®æ ¹ç›®å½•è·¯å¾„')
    parser.add_argument('--output', '-o', default='security_report.json', 
                       help='è¾“å‡ºæŠ¥å‘Šæ–‡ä»¶è·¯å¾„')
    parser.add_argument('--verbose', '-v', action='store_true', 
                       help='æ˜¾ç¤ºè¯¦ç»†è¾“å‡º')
    
    args = parser.parse_args()
    
    # é…ç½®æ—¥å¿—
    log_level = logging.DEBUG if args.verbose else logging.INFO
    logging.basicConfig(
        level=log_level,
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )
    
    # æ£€æŸ¥é¡¹ç›®è·¯å¾„
    project_path = Path(args.project_path)
    if not project_path.exists():
        _logger.error(f"é¡¹ç›®è·¯å¾„ä¸å­˜åœ¨: {project_path}")
        sys.exit(1)
    
    # è¿è¡Œæ‰«æ
    scanner = WechatSecurityScanner(str(project_path))
    report = scanner.run_comprehensive_scan()
    
    # ä¿å­˜æŠ¥å‘Š
    output_path = Path(args.output)
    with open(output_path, 'w', encoding='utf-8') as f:
        json.dump(report, f, ensure_ascii=False, indent=2)
    
    _logger.info(f"æŠ¥å‘Šå·²ä¿å­˜åˆ°: {output_path}")
    
    # å¦‚æœæœ‰ä¸¥é‡é—®é¢˜ï¼Œè¿”å›éé›¶é€€å‡ºç 
    if report['summary']['critical'] > 0:
        _logger.error("å‘ç°ä¸¥é‡å®‰å…¨é—®é¢˜ï¼Œè¯·ç«‹å³ä¿®å¤ï¼")
        sys.exit(1)

if __name__ == '__main__':
    main()
```

---

## ğŸ“Š ç¬¬11å‘¨è¿›åº¦è·Ÿè¸ª

### **æ¯æ—¥ç«™ä¼šé‡ç‚¹**ï¼š
```
å‘¨ä¸€ï¼šå¾®ä¿¡APIå®¢æˆ·ç«¯æ¶æ„è®¾è®¡è¯„å®¡
å‘¨äºŒï¼šAccess Tokenç®¡ç†æœºåˆ¶å®ç°
å‘¨ä¸‰ï¼šæ¶ˆæ¯åŠ è§£å¯†å·¥å…·å¼€å‘
å‘¨å››ï¼šé…ç½®ç®¡ç†ç•Œé¢å¼€å‘
å‘¨äº”ï¼šå®‰å…¨å®¡æŸ¥å’Œç¬¬ä¸€å‘¨æˆæœæ¼”ç¤º
```

### **å…³é”®äº¤ä»˜ç‰©æ£€æŸ¥ç‚¹ï¼ˆç¬¬11å‘¨æœ«ï¼‰**ï¼š

#### **åç«¯å¼€å‘äº¤ä»˜ç‰©**ï¼š
- [ ] `wechat_common`æ¨¡å—å®Œæ•´å®ç°
- [ ] å¾®ä¿¡APIå®¢æˆ·ç«¯ï¼ˆæ”¯æŒç”¨æˆ·ã€æ¶ˆæ¯ã€èœå•ã€ç´ æç­‰æ¥å£ï¼‰
- [ ] Access Tokenè‡ªåŠ¨ç®¡ç†æœºåˆ¶
- [ ] æ¶ˆæ¯åŠ è§£å¯†å·¥å…·
- [ ] å®šæ—¶ä»»åŠ¡ï¼ˆTokenåˆ·æ–°ã€æ¸…ç†ï¼‰

#### **å‰ç«¯å¼€å‘äº¤ä»˜ç‰©**ï¼š
- [ ] å…¬ä¼—å·é…ç½®ç®¡ç†ç•Œé¢
- [ ] é…ç½®éªŒè¯åŠŸèƒ½
- [ ] å¤åˆ¶åˆ°å‰ªè´´æ¿åŠŸèƒ½
- [ ] å“åº”å¼è®¾è®¡

#### **å¾®ä¿¡å¼€å‘ä¸“å®¶äº¤ä»˜ç‰©**ï¼š
- [ ] å¾®ä¿¡APIæ¥å£è§„èŒƒæ–‡æ¡£
- [ ] Access Tokenåˆ†å¸ƒå¼ç¼“å­˜ç­–ç•¥
- [ ] é¢‘ç‡é™åˆ¶æœ€ä½³å®è·µæŒ‡å—
- [ ] é”™è¯¯å¤„ç†è§„èŒƒ

#### **å®‰å…¨å®¡æŸ¥ä¸“å®¶äº¤ä»˜ç‰©**ï¼š
- [ ] å¾®ä¿¡APIå®‰å…¨å®¡æŸ¥æŠ¥å‘Š
- [ ] è‡ªåŠ¨åŒ–å®‰å…¨æ‰«æè„šæœ¬
- [ ] å®‰å…¨é…ç½®æ£€æŸ¥æ¸…å•
- [ ] åŠ å¯†å®ç°å®¡è®¡æŠ¥å‘Š

---

## ğŸ”§ å¼€å‘ç¯å¢ƒé…ç½®æ›´æ–°

### **å¾®ä¿¡å…¬ä¼—å·æµ‹è¯•ç¯å¢ƒè¦æ±‚**ï¼š
```yaml
# å¾®ä¿¡å…¬ä¼—å·æµ‹è¯•å·
å¾®ä¿¡æµ‹è¯•å·: é€šè¿‡å¾®ä¿¡å…¬ä¼—å¹³å°ç”³è¯·
AppID: æµ‹è¯•å·ä¸“ç”¨AppID
AppSecret: æµ‹è¯•å·ä¸“ç”¨AppSecret
ç™½åå•IP: æœåŠ¡å™¨å…¬ç½‘IP
å›è°ƒåŸŸå: å·²å¤‡æ¡ˆçš„åŸŸå

# æµ‹è¯•å·¥å…·
å¾®ä¿¡å¼€å‘è€…å·¥å…·: æœ€æ–°ç‰ˆæœ¬
Postman/Insomnia: APIæµ‹è¯•å·¥å…·
Charles/Fiddler: æŠ“åŒ…è°ƒè¯•å·¥å…·
```

### **æµ‹è¯•æ•°æ®å‡†å¤‡**ï¼š
```python
# å¾®ä¿¡å…¬ä¼—å·æµ‹è¯•æ•°æ®ç”Ÿæˆ
python scripts/generate_wechat_test_data.py \
    --users 100 \
    --messages 500 \
    --menus 3 \
    --materials 20
```

---

## ğŸš¨ ç¬¬ä¸‰é˜¶æ®µé£é™©ç®¡ç†

### **æ–°å¢é£é™©**ï¼š
| é£é™© | å½±å“ | æ¦‚ç‡ | åº”å¯¹æªæ–½ | è´Ÿè´£äºº |
|------|------|------|----------|--------|
| å¾®ä¿¡APIé¢‘ç‡é™åˆ¶ | é«˜ | ä¸­ | 1. å®ç°è¯·æ±‚é˜Ÿåˆ— 2. ç¼“å­˜æœºåˆ¶ 3. ç›‘æ§å‘Šè­¦ | å¾®ä¿¡ä¸“å®¶ |
| æ¶ˆæ¯åŠ è§£å¯†å…¼å®¹æ€§ | ä¸­ | ä¸­ | 1. å¤šæ¨¡å¼æ”¯æŒ 2. å…¼å®¹æ€§æµ‹è¯• 3. é™çº§æ–¹æ¡ˆ | åç«¯å¼€å‘ |
| é…ç½®åŒæ­¥é—®é¢˜ | ä¸­ | ä½ | 1. ç‰ˆæœ¬æ§åˆ¶ 2. é…ç½®éªŒè¯ 3. å›æ»šæœºåˆ¶ | å®‰å…¨ä¸“å®¶ |

### **æŠ€æœ¯éš¾ç‚¹**ï¼š
1. **Access Tokenåˆ†å¸ƒå¼ç®¡ç†**ï¼šå¤šèŠ‚ç‚¹éƒ¨ç½²æ—¶çš„TokenåŒæ­¥
2. **æ¶ˆæ¯åŠ è§£å¯†æ€§èƒ½**ï¼šå¤§é‡æ¶ˆæ¯å¹¶å‘æ—¶çš„æ€§èƒ½ä¼˜åŒ–
3. **é…ç½®éªŒè¯æµç¨‹**ï¼šå¾®ä¿¡æœåŠ¡å™¨çš„åŒå‘éªŒè¯

---

## ğŸ“ˆ è´¨é‡æŒ‡æ ‡ï¼ˆç¬¬11å‘¨æœ«ï¼‰

### **åŠŸèƒ½æŒ‡æ ‡**ï¼š
1. å¾®ä¿¡APIå®¢æˆ·ç«¯è¦†ç›–åº¦ > 80%
2. Tokenè‡ªåŠ¨åˆ·æ–°æˆåŠŸç‡ > 99%
3. æ¶ˆæ¯åŠ è§£å¯†æ­£ç¡®ç‡ 100%
4. é…ç½®ç®¡ç†ç•Œé¢å®Œæ•´åº¦ 100%

### **æ€§èƒ½æŒ‡æ ‡**ï¼š
1. APIè¯·æ±‚å¹³å‡å“åº”æ—¶é—´ < 500ms
2. åŠ è§£å¯†æ“ä½œæ—¶é—´ < 100ms/æ¶ˆæ¯
3. Tokenåˆ·æ–°æ—¶é—´ < 2ç§’
4. å†…å­˜å ç”¨ < 100MB

### **å®‰å…¨æŒ‡æ ‡**ï¼š
1. é€šè¿‡æ‰€æœ‰å®‰å…¨å®¡è®¡é¡¹
2. æ— ç¡¬ç¼–ç å¯†é’¥
3. å®ç°å®Œæ•´çš„è¾“å…¥éªŒè¯
4. åŠ å¯†å®ç°ç¬¦åˆæœ€ä½³å®è·µ

---

## ğŸ¯ ç¬¬11å‘¨æˆåŠŸæ ‡å‡†

1. **åŸºç¡€æ¡†æ¶å®Œæˆ**ï¼š`wechat_common`æ¨¡å—å¯ç”¨
2. **APIå®¢æˆ·ç«¯ç¨³å®š**ï¼šæ”¯æŒæ ¸å¿ƒå¾®ä¿¡API
3. **é…ç½®ç®¡ç†å®Œå–„**ï¼šå®Œæ•´çš„é…ç½®ç•Œé¢å’ŒéªŒè¯æµç¨‹
4. **å®‰å…¨å®¡æŸ¥é€šè¿‡**ï¼šæ— é«˜å±å®‰å…¨é—®é¢˜
5. **æ–‡æ¡£å®Œæ•´**ï¼šAPIæ–‡æ¡£ã€å¼€å‘æŒ‡å—ã€éƒ¨ç½²æ‰‹å†Œ

---

**ç¬¬ä¸‰é˜¶æ®µå·¥ä½œæ­£å¼å¯åŠ¨ï¼** å¾®ä¿¡å…¬ä¼—å·ç®¡ç†å¹³å°æ˜¯æ•´ä¸ªå¾®ä¿¡ç”Ÿæ€é›†æˆçš„æ ¸å¿ƒï¼Œéœ€è¦ç‰¹åˆ«æ³¨é‡ç¨³å®šæ€§å’Œå®‰å…¨æ€§ã€‚

**æœ¬å‘¨é‡ç‚¹æé†’**ï¼š
1. Access Tokenç®¡ç†è¦è€ƒè™‘åˆ†å¸ƒå¼éƒ¨ç½²åœºæ™¯
2. æ¶ˆæ¯åŠ è§£å¯†è¦å…¼å®¹å¾®ä¿¡çš„ä¸‰ç§å®‰å…¨æ¨¡å¼
3. é…ç½®éªŒè¯æµç¨‹è¦å®Œæ•´è¦†ç›–å¾®ä¿¡çš„éªŒè¯æœºåˆ¶
4. å®‰å…¨å®¡è®¡è¦è¦†ç›–æ‰€æœ‰æ•æ„Ÿæ“ä½œ

**ä»Šæ—¥é‡ç‚¹å·¥ä½œ**ï¼š
1. åç«¯å¼€å‘ï¼šè®¾è®¡å¾®ä¿¡APIå®¢æˆ·ç«¯æ¶æ„
2. å‰ç«¯å¼€å‘ï¼šåˆ›å»ºé…ç½®ç®¡ç†ç•Œé¢æ¡†æ¶
3. å¾®ä¿¡å¼€å‘ä¸“å®¶ï¼šåˆ¶å®šAPIæ¥å£è§„èŒƒ
4. å®‰å…¨å®¡æŸ¥ä¸“å®¶ï¼šåˆ¶å®šå®‰å…¨å®¡æŸ¥æ ‡å‡†

**ä»Šæ—¥ç«™ä¼šæ—¶é—´**ï¼šä¸‹åˆ4:00ï¼Œè®¨è®ºå¾®ä¿¡å…¬ä¼—å·åŸºç¡€æ¡†æ¶è®¾è®¡ã€‚å¾®ä¿¡å¼€å‘ä¸“å®¶è¯·å‡†å¤‡å¾®ä¿¡APIçš„æœ€ä½³å®è·µåˆ†äº«ã€‚

# ğŸš€ ç¬¬ä¸‰é˜¶æ®µï¼šå¾®ä¿¡å…¬ä¼—å·ç®¡ç†å¹³å°ç»§ç»­æ¨è¿›ï¼ˆç¬¬12-13å‘¨ï¼‰

## ğŸ“‹ æœ¬å‘¨æ ¸å¿ƒç›®æ ‡

**æœ¬å‘¨é‡ç‚¹**ï¼šå®ç°å®Œæ•´çš„ç²‰ä¸ç®¡ç†ä¸æ¶ˆæ¯å¤„ç†ç³»ç»Ÿ
**æŠ€æœ¯è¦ç‚¹**ï¼š
1. è®¾è®¡ç²‰ä¸æ•°æ®æ¨¡å‹å’ŒåŒæ­¥æœºåˆ¶
2. å®ç°å¾®ä¿¡æ¶ˆæ¯æ¥æ”¶å’Œè‡ªåŠ¨å›å¤
3. åˆ›å»ºæ¶ˆæ¯ç®¡ç†ç•Œé¢å’Œå…³é”®è¯è§„åˆ™å¼•æ“
4. ä¸Odoo CRMæ¨¡å—æ·±åº¦é›†æˆ
**æ—¶é—´**ï¼šç¬¬12-13å‘¨ï¼ˆå…±2å‘¨ï¼‰

---

## ğŸ“… ç¬¬12å‘¨ï¼šç²‰ä¸ç®¡ç†ä¸æ¶ˆæ¯å¤„ç†åŸºç¡€

### **Pythonä¸“å®¶è°ƒåº¦æŒ‡ä»¤ï¼š**
```
æœ¬å‘¨é‡ç‚¹ï¼šå®ç°ç²‰ä¸æ•°æ®ç®¡ç†å’Œå¾®ä¿¡æ¶ˆæ¯åŸºç¡€å¤„ç†èƒ½åŠ›
å¼€å‘é¡ºåºï¼šç²‰ä¸æ¨¡å‹è®¾è®¡ â†’ æ¶ˆæ¯æ¨¡å‹è®¾è®¡ â†’ åŒæ­¥æœºåˆ¶ â†’ æ¶ˆæ¯å¤„ç†å™¨ â†’ å‰ç«¯ç•Œé¢

æ³¨æ„ç‚¹ï¼š
1. ç²‰ä¸æ•°æ®éœ€è¦è€ƒè™‘å¢é‡åŒæ­¥å’Œå»é‡
2. æ¶ˆæ¯å¤„ç†è¦æ”¯æŒåŠ å¯†/è§£å¯†ä¸¤ç§æ¨¡å¼
3. åŒæ­¥æœºåˆ¶è¦è€ƒè™‘å¾®ä¿¡APIé¢‘ç‡é™åˆ¶
4. æ¶ˆæ¯å†å²éœ€è¦å®Œæ•´å­˜å‚¨ä¾›åç»­åˆ†æ
```

### **åç«¯å¼€å‘å…·ä½“ä»»åŠ¡ï¼š**

#### **ä»»åŠ¡1ï¼šåˆ›å»ºwechat_platformæ¨¡å—ç»“æ„**
```bash
# åˆ›å»ºå¾®ä¿¡å…¬ä¼—å·ç®¡ç†å¹³å°æ¨¡å—
mkdir -p wechat_platform/{models,controllers,views,wizards,security,data,tests,static/src/{js,xml,css},reports,templates}

# åˆ›å»º__manifest__.py
cat > wechat_platform/__manifest__.py << 'EOF'
{
    'name': 'å¾®ä¿¡å…¬ä¼—å·ç®¡ç†å¹³å°',
    'version': '1.0.0',
    'category': 'WeChat',
    'summary': 'å®Œæ•´çš„å¾®ä¿¡å…¬ä¼—å·ç®¡ç†è§£å†³æ–¹æ¡ˆ',
    'description': '''
        æä¾›ç²‰ä¸ç®¡ç†ã€æ¶ˆæ¯å¤„ç†ã€èœå•ç®¡ç†ã€ç´ æç®¡ç†ç­‰åŠŸèƒ½ï¼Œ
        å¹¶ä¸Odoo CRMæ·±åº¦é›†æˆã€‚
    ''',
    'depends': ['base', 'wechat_common', 'crm', 'mail'],
    'data': [
        'security/wechat_security.xml',
        'security/ir.model.access.csv',
        
        'views/wechat_account_views.xml',
        'views/wechat_user_views.xml',
        'views/wechat_menu_views.xml',
        'views/wechat_message_views.xml',
        'views/wechat_auto_reply_views.xml',
        'views/wechat_material_views.xml',
        'views/crm_lead_views.xml',
        'views/res_partner_views.xml',
        'views/wechat_dashboard_views.xml',
        
        'data/wechat_data.xml',
        'data/cron_data.xml',
        
        'wizards/wechat_sync_wizard_views.xml',
        'wizards/wechat_broadcast_wizard_views.xml',
        
        'reports/wechat_report_views.xml',
    ],
    'assets': {
        'web.assets_backend': [
            'wechat_platform/static/src/js/wechat_dashboard.js',
            'wechat_platform/static/src/js/wechat_user.js',
            'wechat_platform/static/src/js/wechat_message.js',
            'wechat_platform/static/src/css/wechat_platform.css',
        ],
        'web.assets_qweb': [
            'wechat_platform/static/src/xml/*.xml',
        ],
    },
    'demo': [
        'demo/wechat_demo.xml',
    ],
    'installable': True,
    'application': True,
    'auto_install': False,
}
EOF
```

#### **ä»»åŠ¡2ï¼šç²‰ä¸æ•°æ®æ¨¡å‹è®¾è®¡**
```python
# file: wechat_platform/models/wechat_user.py

from odoo import models, fields, api, _
from odoo.exceptions import ValidationError, UserError
from datetime import datetime, timedelta
import logging
import json

_logger = logging.getLogger(__name__)

class WechatUser(models.Model):
    """å¾®ä¿¡å…¬ä¼—å·ç²‰ä¸"""
    _name = 'wechat.user'
    _description = 'å¾®ä¿¡å…¬ä¼—å·ç²‰ä¸'
    _rec_name = 'nickname'
    _order = 'subscribe_time desc'
    
    # åŸºç¡€ä¿¡æ¯
    openid = fields.Char(string='OpenID', required=True, index=True, readonly=True)
    unionid = fields.Char(string='UnionID', index=True, readonly=True)
    account_id = fields.Many2one('wechat.account', string='æ‰€å±å…¬ä¼—å·', required=True, readonly=True)
    
    # ç²‰ä¸ä¿¡æ¯ï¼ˆä»å¾®ä¿¡åŒæ­¥ï¼‰
    nickname = fields.Char(string='æ˜µç§°', readonly=True)
    sex = fields.Selection([
        ('0', 'æœªçŸ¥'),
        ('1', 'ç”·æ€§'),
        ('2', 'å¥³æ€§'),
    ], string='æ€§åˆ«', readonly=True)
    
    country = fields.Char(string='å›½å®¶', readonly=True)
    province = fields.Char(string='çœä»½', readonly=True)
    city = fields.Char(string='åŸå¸‚', readonly=True)
    
    language = fields.Char(string='è¯­è¨€', readonly=True)
    headimgurl = fields.Char(string='å¤´åƒURL', readonly=True)
    
    # å…³æ³¨çŠ¶æ€
    subscribe = fields.Boolean(string='å·²å…³æ³¨', default=True, readonly=True)
    subscribe_time = fields.Datetime(string='å…³æ³¨æ—¶é—´', readonly=True)
    subscribe_scene = fields.Selection([
        ('ADD_SCENE_SEARCH', 'å…¬ä¼—å·æœç´¢'),
        ('ADD_SCENE_ACCOUNT_MIGRATION', 'å…¬ä¼—å·è¿ç§»'),
        ('ADD_SCENE_PROFILE_CARD', 'åç‰‡åˆ†äº«'),
        ('ADD_SCENE_QR_CODE', 'æ‰«æäºŒç»´ç '),
        ('ADD_SCENE_PROFILE_LINK', 'å›¾æ–‡é¡µå†…åç§°ç‚¹å‡»'),
        ('ADD_SCENE_PROFILE_ITEM', 'å›¾æ–‡é¡µå³ä¸Šè§’èœå•'),
        ('ADD_SCENE_PAID', 'æ”¯ä»˜åå…³æ³¨'),
        ('ADD_SCENE_OTHERS', 'å…¶ä»–'),
    ], string='å…³æ³¨æ¥æº', readonly=True)
    
    qr_scene = fields.Char(string='äºŒç»´ç åœºæ™¯å€¼', readonly=True)
    qr_scene_str = fields.Char(string='äºŒç»´ç åœºæ™¯å­—ç¬¦ä¸²', readonly=True)
    
    remark = fields.Char(string='å¤‡æ³¨å', readonly=True)
    group_id = fields.Integer(string='åˆ†ç»„ID', readonly=True)
    tagid_list = fields.Char(string='æ ‡ç­¾åˆ—è¡¨', readonly=True,
                           help='JSONæ ¼å¼çš„æ ‡ç­¾IDåˆ—è¡¨')
    
    # ç»Ÿè®¡ä¿¡æ¯
    message_count = fields.Integer(string='æ¶ˆæ¯æ•°é‡', compute='_compute_message_count', store=True)
    last_message_time = fields.Datetime(string='æœ€åæ¶ˆæ¯æ—¶é—´', readonly=True)
    
    # ä¸Odooå…³è”
    partner_id = fields.Many2one('res.partner', string='å…³è”å®¢æˆ·', 
                                domain="[('is_company', '=', False)]")
    lead_id = fields.Many2one('crm.lead', string='å…³è”å•†æœº')
    
    # çŠ¶æ€æ ‡è®°
    is_synced = fields.Boolean(string='å·²åŒæ­¥', default=False, readonly=True)
    sync_date = fields.Datetime(string='æœ€ååŒæ­¥æ—¶é—´', readonly=True)
    need_update = fields.Boolean(string='éœ€è¦æ›´æ–°', default=False)
    
    # çº¦æŸ
    _sql_constraints = [
        ('openid_account_unique', 'UNIQUE(openid, account_id)', 'åŒä¸€ä¸ªå…¬ä¼—å·ä¸‹OpenIDå¿…é¡»å”¯ä¸€')
    ]
    
    @api.depends('openid')
    def _compute_message_count(self):
        """è®¡ç®—ç²‰ä¸çš„æ¶ˆæ¯æ•°é‡"""
        for user in self:
            user.message_count = self.env['wechat.message'].search_count([
                ('from_user_name', '=', user.openid),
                ('account_id', '=', user.account_id.id)
            ])
    
    @api.model
    def create_from_wechat(self, account_id, user_data):
        """ä»å¾®ä¿¡APIæ•°æ®åˆ›å»ºç²‰ä¸"""
        account = self.env['wechat.account'].browse(account_id)
        
        # æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨
        existing_user = self.search([
            ('openid', '=', user_data.get('openid')),
            ('account_id', '=', account_id)
        ])
        
        if existing_user:
            # æ›´æ–°ç°æœ‰è®°å½•
            existing_user._update_from_wechat_data(user_data)
            return existing_user
        
        # åˆ›å»ºæ–°è®°å½•
        values = self._prepare_user_values(account_id, user_data)
        return self.create(values)
    
    def _prepare_user_values(self, account_id, user_data):
        """å‡†å¤‡ç²‰ä¸æ•°æ®"""
        subscribe_time = datetime.fromtimestamp(int(user_data.get('subscribe_time', 0)))
        
        return {
            'openid': user_data.get('openid'),
            'unionid': user_data.get('unionid'),
            'account_id': account_id,
            'nickname': user_data.get('nickname', ''),
            'sex': str(user_data.get('sex', 0)),
            'country': user_data.get('country', ''),
            'province': user_data.get('province', ''),
            'city': user_data.get('city', ''),
            'language': user_data.get('language', ''),
            'headimgurl': user_data.get('headimgurl', ''),
            'subscribe': user_data.get('subscribe', 0) == 1,
            'subscribe_time': subscribe_time,
            'subscribe_scene': user_data.get('subscribe_scene', 'ADD_SCENE_OTHERS'),
            'qr_scene': str(user_data.get('qr_scene', '')),
            'qr_scene_str': user_data.get('qr_scene_str', ''),
            'remark': user_data.get('remark', ''),
            'group_id': user_data.get('groupid', 0),
            'tagid_list': json.dumps(user_data.get('tagid_list', [])),
            'is_synced': True,
            'sync_date': fields.Datetime.now(),
            'need_update': False,
        }
    
    def _update_from_wechat_data(self, user_data):
        """æ›´æ–°ç²‰ä¸æ•°æ®"""
        self.ensure_one()
        
        subscribe_time = datetime.fromtimestamp(int(user_data.get('subscribe_time', 0)))
        
        update_values = {
            'nickname': user_data.get('nickname', self.nickname),
            'sex': str(user_data.get('sex', self.sex)),
            'country': user_data.get('country', self.country),
            'province': user_data.get('province', self.province),
            'city': user_data.get('city', self.city),
            'headimgurl': user_data.get('headimgurl', self.headimgurl),
            'subscribe': user_data.get('subscribe', 0) == 1,
            'subscribe_time': subscribe_time if user_data.get('subscribe_time') else self.subscribe_time,
            'remark': user_data.get('remark', self.remark),
            'group_id': user_data.get('groupid', self.group_id),
            'tagid_list': json.dumps(user_data.get('tagid_list', [])),
            'is_synced': True,
            'sync_date': fields.Datetime.now(),
            'need_update': False,
        }
        
        # å¦‚æœå–æ¶ˆå…³æ³¨ï¼Œæ›´æ–°æœ€åæ¶ˆæ¯æ—¶é—´
        if not update_values['subscribe'] and self.subscribe:
            update_values['last_message_time'] = fields.Datetime.now()
        
        return self.write(update_values)
    
    def sync_with_wechat(self):
        """åŒæ­¥ç²‰ä¸ä¿¡æ¯ï¼ˆå•ä¸ªï¼‰"""
        self.ensure_one()
        
        try:
            client = self.account_id.get_api_client()
            user_info = client.get_user_info(self.openid)
            
            self._update_from_wechat_data(user_info)
            _logger.info(f"åŒæ­¥ç²‰ä¸ä¿¡æ¯æˆåŠŸ: {self.nickname} ({self.openid})")
            
        except Exception as e:
            _logger.error(f"åŒæ­¥ç²‰ä¸ä¿¡æ¯å¤±è´¥ {self.openid}: {str(e)}")
            raise UserError(f"åŒæ­¥å¤±è´¥: {str(e)}")
    
    def link_to_partner(self, partner_id=None):
        """å…³è”åˆ°Odooå®¢æˆ·"""
        self.ensure_one()
        
        if partner_id:
            partner = self.env['res.partner'].browse(partner_id)
        else:
            # è‡ªåŠ¨åˆ›å»ºå®¢æˆ·
            partner = self.env['res.partner'].create({
                'name': self.nickname or f'å¾®ä¿¡ç”¨æˆ·_{self.openid[-8:]}',
                'email': self._generate_email(),
                'phone': False,
                'wechat_openid': self.openid,
                'wechat_unionid': self.unionid,
                'image_1920': self._download_avatar() if self.headimgurl else False,
            })
        
        self.write({
            'partner_id': partner.id,
        })
        
        # åˆ›å»ºæˆ–æ›´æ–°å•†æœº
        self._create_or_update_lead(partner)
        
        return partner
    
    def _generate_email(self):
        """ä¸ºç²‰ä¸ç”Ÿæˆé»˜è®¤é‚®ç®±"""
        import hashlib
        
        if not self.openid:
            return f"{self.id}@wechat.user"
        
        # ä½¿ç”¨OpenIDç”Ÿæˆå”¯ä¸€é‚®ç®±
        hash_obj = hashlib.md5(self.openid.encode())
        hash_str = hash_obj.hexdigest()[:8]
        return f"wechat_{hash_str}@wechat.user"
    
    def _download_avatar(self):
        """ä¸‹è½½å¤´åƒ"""
        import requests
        import base64
        
        try:
            response = requests.get(self.headimgurl, timeout=10)
            response.raise_for_status()
            
            # è½¬æ¢ä¸ºbase64
            avatar_base64 = base64.b64encode(response.content).decode('ascii')
            return avatar_base64
            
        except Exception as e:
            _logger.warning(f"ä¸‹è½½å¤´åƒå¤±è´¥ {self.headimgurl}: {str(e)}")
            return False
    
    def _create_or_update_lead(self, partner):
        """åˆ›å»ºæˆ–æ›´æ–°å•†æœº"""
        existing_lead = self.env['crm.lead'].search([
            ('partner_id', '=', partner.id),
            ('type', '=', 'opportunity'),
        ], limit=1)
        
        if existing_lead:
            # æ›´æ–°ç°æœ‰å•†æœº
            existing_lead.write({
                'description': f"å¾®ä¿¡ç²‰ä¸è‡ªåŠ¨å…³è”\næ˜µç§°: {self.nickname}\nå…³æ³¨æ—¶é—´: {self.subscribe_time}",
            })
            self.lead_id = existing_lead.id
        else:
            # åˆ›å»ºæ–°å•†æœº
            lead = self.env['crm.lead'].create({
                'name': f"{self.nickname} - å¾®ä¿¡ç²‰ä¸å’¨è¯¢",
                'partner_id': partner.id,
                'type': 'opportunity',
                'stage_id': self.env.ref('crm.stage_lead1').id,
                'description': f"å¾®ä¿¡ç²‰ä¸è‡ªåŠ¨åˆ›å»º\næ˜µç§°: {self.nickname}\nå…³æ³¨æ—¶é—´: {self.subscribe_time}\næ¥æº: å¾®ä¿¡å…¬ä¼—å·",
                'wechat_user_id': self.id,
            })
            self.lead_id = lead.id
        
        return self.lead_id
    
    @api.model
    def cron_sync_users(self):
        """å®šæ—¶ä»»åŠ¡ï¼šåŒæ­¥ç²‰ä¸åˆ—è¡¨"""
        accounts = self.env['wechat.account'].search([('is_valid', '=', True)])
        
        total_synced = 0
        for account in accounts:
            try:
                synced_count = account.sync_users()
                total_synced += synced_count
                _logger.info(f"å…¬ä¼—å· {account.name} åŒæ­¥äº† {synced_count} ä¸ªç²‰ä¸")
            except Exception as e:
                _logger.error(f"åŒæ­¥ç²‰ä¸å¤±è´¥ {account.name}: {str(e)}")
        
        return total_synced
    
    def action_view_messages(self):
        """æŸ¥çœ‹ç²‰ä¸çš„æ¶ˆæ¯å†å²"""
        self.ensure_one()
        
        return {
            'type': 'ir.actions.act_window',
            'name': f'{self.nickname} çš„æ¶ˆæ¯å†å²',
            'res_model': 'wechat.message',
            'view_mode': 'tree,form',
            'domain': [('from_user_name', '=', self.openid)],
            'context': {
                'default_from_user_name': self.openid,
                'default_account_id': self.account_id.id,
            },
        }
    
    def action_send_message(self):
        """ç»™ç²‰ä¸å‘é€æ¶ˆæ¯"""
        self.ensure_one()
        
        return {
            'type': 'ir.actions.act_window',
            'name': f'å‘é€æ¶ˆæ¯ç»™ {self.nickname}',
            'res_model': 'wechat.message.wizard',
            'view_mode': 'form',
            'target': 'new',
            'context': {
                'default_to_user': self.openid,
                'default_account_id': self.account_id.id,
            },
        }
```

#### **ä»»åŠ¡3ï¼šå¾®ä¿¡æ¶ˆæ¯æ¨¡å‹è®¾è®¡**
```python
# file: wechat_platform/models/wechat_message.py

from odoo import models, fields, api, _
from odoo.exceptions import ValidationError
import logging
import json
import xml.etree.ElementTree as ET
from datetime import datetime

_logger = logging.getLogger(__name__)

class WechatMessage(models.Model):
    """å¾®ä¿¡æ¶ˆæ¯è®°å½•"""
    _name = 'wechat.message'
    _description = 'å¾®ä¿¡æ¶ˆæ¯'
    _order = 'create_time desc'
    _rec_name = 'msg_id'
    
    # æ¶ˆæ¯åŸºæœ¬ä¿¡æ¯
    msg_id = fields.Char(string='æ¶ˆæ¯ID', readonly=True, index=True)
    msg_type = fields.Selection([
        ('text', 'æ–‡æœ¬æ¶ˆæ¯'),
        ('image', 'å›¾ç‰‡æ¶ˆæ¯'),
        ('voice', 'è¯­éŸ³æ¶ˆæ¯'),
        ('video', 'è§†é¢‘æ¶ˆæ¯'),
        ('shortvideo', 'å°è§†é¢‘æ¶ˆæ¯'),
        ('location', 'åœ°ç†ä½ç½®æ¶ˆæ¯'),
        ('link', 'é“¾æ¥æ¶ˆæ¯'),
        ('event', 'äº‹ä»¶æ¶ˆæ¯'),
    ], string='æ¶ˆæ¯ç±»å‹', required=True, readonly=True)
    
    # å‚ä¸æ–¹ä¿¡æ¯
    from_user_name = fields.Char(string='å‘é€æ–¹', required=True, readonly=True)
    to_user_name = fields.Char(string='æ¥æ”¶æ–¹', required=True, readonly=True)
    account_id = fields.Many2one('wechat.account', string='æ‰€å±å…¬ä¼—å·', required=True, readonly=True)
    
    # æ—¶é—´ä¿¡æ¯
    create_time = fields.Datetime(string='åˆ›å»ºæ—¶é—´', readonly=True)
    receive_time = fields.Datetime(string='æ¥æ”¶æ—¶é—´', default=fields.Datetime.now, readonly=True)
    
    # æ¶ˆæ¯å†…å®¹ï¼ˆæ ¹æ®ç±»å‹å­˜å‚¨ä¸åŒå­—æ®µï¼‰
    content = fields.Text(string='æ–‡æœ¬å†…å®¹', readonly=True)
    pic_url = fields.Char(string='å›¾ç‰‡é“¾æ¥', readonly=True)
    media_id = fields.Char(string='åª’ä½“ID', readonly=True)
    format = fields.Char(string='è¯­éŸ³æ ¼å¼', readonly=True)
    recognition = fields.Char(string='è¯­éŸ³è¯†åˆ«ç»“æœ', readonly=True)
    thumb_media_id = fields.Char(string='ç¼©ç•¥å›¾åª’ä½“ID', readonly=True)
    
    # åœ°ç†ä½ç½®
    location_x = fields.Float(string='çº¬åº¦', readonly=True)
    location_y = fields.Float(string='ç»åº¦', readonly=True)
    scale = fields.Integer(string='åœ°å›¾ç¼©æ”¾å¤§å°', readonly=True)
    label = fields.Char(string='åœ°ç†ä½ç½®ä¿¡æ¯', readonly=True)
    
    # é“¾æ¥æ¶ˆæ¯
    title = fields.Char(string='æ¶ˆæ¯æ ‡é¢˜', readonly=True)
    description = fields.Char(string='æ¶ˆæ¯æè¿°', readonly=True)
    url = fields.Char(string='æ¶ˆæ¯é“¾æ¥', readonly=True)
    
    # äº‹ä»¶æ¶ˆæ¯
    event = fields.Selection([
        ('subscribe', 'å…³æ³¨äº‹ä»¶'),
        ('unsubscribe', 'å–æ¶ˆå…³æ³¨'),
        ('SCAN', 'æ‰«æäºŒç»´ç '),
        ('LOCATION', 'ä¸ŠæŠ¥åœ°ç†ä½ç½®'),
        ('CLICK', 'ç‚¹å‡»èœå•'),
        ('VIEW', 'è·³è½¬é“¾æ¥'),
        ('scancode_push', 'æ‰«ç æ¨äº‹ä»¶'),
        ('scancode_waitmsg', 'æ‰«ç æ¨äº‹ä»¶ä¸”å¼¹å‡º"æ¶ˆæ¯æ¥æ”¶ä¸­"æç¤ºæ¡†'),
        ('pic_sysphoto', 'å¼¹å‡ºç³»ç»Ÿæ‹ç…§å‘å›¾'),
        ('pic_photo_or_album', 'å¼¹å‡ºæ‹ç…§æˆ–è€…ç›¸å†Œå‘å›¾'),
        ('pic_weixin', 'å¼¹å‡ºå¾®ä¿¡ç›¸å†Œå‘å›¾å™¨'),
        ('location_select', 'å¼¹å‡ºåœ°ç†ä½ç½®é€‰æ‹©å™¨'),
        ('view_miniprogram', 'è·³è½¬å°ç¨‹åº'),
        ('TEMPLATESENDJOBFINISH', 'æ¨¡æ¿æ¶ˆæ¯å‘é€å®Œæˆ'),
    ], string='äº‹ä»¶ç±»å‹', readonly=True)
    
    event_key = fields.Char(string='äº‹ä»¶KEYå€¼', readonly=True)
    ticket = fields.Char(string='äºŒç»´ç ticket', readonly=True)
    latitude = fields.Float(string='åœ°ç†ä½ç½®çº¬åº¦', readonly=True)
    longitude = fields.Float(string='åœ°ç†ä½ç½®ç»åº¦', readonly=True)
    precision = fields.Float(string='åœ°ç†ä½ç½®ç²¾åº¦', readonly=True)
    
    # æ¶ˆæ¯çŠ¶æ€
    direction = fields.Selection([
        ('in', 'æ¥æ”¶'),
        ('out', 'å‘é€'),
    ], string='æ–¹å‘', required=True, default='in')
    
    status = fields.Selection([
        ('received', 'å·²æ¥æ”¶'),
        ('processed', 'å·²å¤„ç†'),
        ('replied', 'å·²å›å¤'),
        ('failed', 'å¤„ç†å¤±è´¥'),
    ], string='çŠ¶æ€', default='received')
    
    reply_id = fields.Many2one('wechat.message', string='å›å¤æ¶ˆæ¯', readonly=True)
    reply_content = fields.Text(string='å›å¤å†…å®¹', readonly=True)
    
    # å¤„ç†ä¿¡æ¯
    processed_by = fields.Many2one('res.users', string='å¤„ç†äºº', readonly=True)
    process_time = fields.Datetime(string='å¤„ç†æ—¶é—´', readonly=True)
    auto_reply = fields.Boolean(string='è‡ªåŠ¨å›å¤', default=False, readonly=True)
    
    # å…³è”ä¿¡æ¯
    wechat_user_id = fields.Many2one('wechat.user', string='å…³è”ç²‰ä¸', 
                                    compute='_compute_wechat_user', store=True)
    partner_id = fields.Many2one('res.partner', string='å…³è”å®¢æˆ·', 
                                related='wechat_user_id.partner_id', store=True)
    
    # åŸå§‹æ•°æ®
    raw_data = fields.Text(string='åŸå§‹æ•°æ®', readonly=True,
                          help='XMLæ ¼å¼çš„åŸå§‹æ¶ˆæ¯æ•°æ®')
    
    @api.depends('from_user_name', 'account_id')
    def _compute_wechat_user(self):
        """è®¡ç®—å…³è”çš„ç²‰ä¸"""
        for message in self:
            if message.direction == 'in':
                user = self.env['wechat.user'].search([
                    ('openid', '=', message.from_user_name),
                    ('account_id', '=', message.account_id.id)
                ], limit=1)
                message.wechat_user_id = user.id if user else False
            else:
                message.wechat_user_id = False
    
    @api.model
    def create_from_xml(self, account_id, xml_data):
        """ä»XMLæ•°æ®åˆ›å»ºæ¶ˆæ¯è®°å½•"""
        try:
            # è§£æXML
            root = ET.fromstring(xml_data)
            msg_data = {child.tag: child.text for child in root}
            
            # è½¬æ¢åˆ›å»ºæ—¶é—´
            create_timestamp = int(msg_data.get('CreateTime', 0))
            create_time = datetime.fromtimestamp(create_timestamp)
            
            # å‡†å¤‡æ¶ˆæ¯æ•°æ®
            msg_type = msg_data.get('MsgType', 'text')
            values = {
                'account_id': account_id,
                'msg_type': msg_type,
                'from_user_name': msg_data.get('FromUserName', ''),
                'to_user_name': msg_data.get('ToUserName', ''),
                'create_time': create_time,
                'direction': 'in',
                'status': 'received',
                'raw_data': xml_data,
            }
            
            # æ ¹æ®æ¶ˆæ¯ç±»å‹å¡«å……ä¸åŒå­—æ®µ
            if msg_type == 'text':
                values.update({
                    'content': msg_data.get('Content', ''),
                    'msg_id': msg_data.get('MsgId', ''),
                })
            elif msg_type == 'image':
                values.update({
                    'pic_url': msg_data.get('PicUrl', ''),
                    'media_id': msg_data.get('MediaId', ''),
                    'msg_id': msg_data.get('MsgId', ''),
                })
            elif msg_type == 'voice':
                values.update({
                    'media_id': msg_data.get('MediaId', ''),
                    'format': msg_data.get('Format', ''),
                    'recognition': msg_data.get('Recognition', ''),
                    'msg_id': msg_data.get('MsgId', ''),
                })
            elif msg_type == 'video' or msg_type == 'shortvideo':
                values.update({
                    'media_id': msg_data.get('MediaId', ''),
                    'thumb_media_id': msg_data.get('ThumbMediaId', ''),
                    'msg_id': msg_data.get('MsgId', ''),
                })
            elif msg_type == 'location':
                values.update({
                    'location_x': float(msg_data.get('Location_X', 0)),
                    'location_y': float(msg_data.get('Location_Y', 0)),
                    'scale': int(msg_data.get('Scale', 0)),
                    'label': msg_data.get('Label', ''),
                    'msg_id': msg_data.get('MsgId', ''),
                })
            elif msg_type == 'link':
                values.update({
                    'title': msg_data.get('Title', ''),
                    'description': msg_data.get('Description', ''),
                    'url': msg_data.get('Url', ''),
                    'msg_id': msg_data.get('MsgId', ''),
                })
            elif msg_type == 'event':
                values.update({
                    'event': msg_data.get('Event', '').lower(),
                    'event_key': msg_data.get('EventKey', ''),
                    'ticket': msg_data.get('Ticket', ''),
                })
                
                # å¤„ç†ä¸åŒçš„äº‹ä»¶ç±»å‹
                if values['event'] == 'location':
                    values.update({
                        'latitude': float(msg_data.get('Latitude', 0)),
                        'longitude': float(msg_data.get('Longitude', 0)),
                        'precision': float(msg_data.get('Precision', 0)),
                    })
            
            # åˆ›å»ºæ¶ˆæ¯è®°å½•
            message = self.create(values)
            
            # æ›´æ–°ç²‰ä¸çš„æœ€åæ¶ˆæ¯æ—¶é—´
            self._update_user_last_message(message)
            
            # è‡ªåŠ¨å¤„ç†æ¶ˆæ¯
            message.auto_process()
            
            return message
            
        except Exception as e:
            _logger.error(f"è§£æå¾®ä¿¡æ¶ˆæ¯å¤±è´¥: {str(e)}\nXML: {xml_data}")
            raise ValidationError(f"æ¶ˆæ¯è§£æå¤±è´¥: {str(e)}")
    
    def _update_user_last_message(self, message):
        """æ›´æ–°ç²‰ä¸çš„æœ€åæ¶ˆæ¯æ—¶é—´"""
        if message.direction == 'in':
            user = self.env['wechat.user'].search([
                ('openid', '=', message.from_user_name),
                ('account_id', '=', message.account_id.id)
            ], limit=1)
            
            if user:
                user.write({
                    'last_message_time': message.create_time or fields.Datetime.now(),
                })
    
    def auto_process(self):
        """è‡ªåŠ¨å¤„ç†æ¶ˆæ¯"""
        self.ensure_one()
        
        # äº‹ä»¶æ¶ˆæ¯å¤„ç†
        if self.msg_type == 'event':
            self._process_event()
        # æ–‡æœ¬æ¶ˆæ¯è‡ªåŠ¨å›å¤
        elif self.msg_type == 'text' and self.content:
            self._auto_reply_text()
        
        self.write({
            'status': 'processed',
            'process_time': fields.Datetime.now(),
            'auto_reply': True,
        })
    
    def _process_event(self):
        """å¤„ç†äº‹ä»¶æ¶ˆæ¯"""
        if self.event == 'subscribe':
            # å…³æ³¨äº‹ä»¶ï¼šåŒæ­¥ç²‰ä¸ä¿¡æ¯
            self._handle_subscribe_event()
        elif self.event == 'unsubscribe':
            # å–æ¶ˆå…³æ³¨ï¼šæ›´æ–°ç²‰ä¸çŠ¶æ€
            self._handle_unsubscribe_event()
        elif self.event == 'CLICK':
            # èœå•ç‚¹å‡»äº‹ä»¶
            self._handle_menu_click()
    
    def _handle_subscribe_event(self):
        """å¤„ç†å…³æ³¨äº‹ä»¶"""
        try:
            account = self.account_id
            client = account.get_api_client()
            
            # è·å–ç²‰ä¸ä¿¡æ¯
            user_info = client.get_user_info(self.from_user_name)
            
            # åˆ›å»ºæˆ–æ›´æ–°ç²‰ä¸è®°å½•
            self.env['wechat.user'].create_from_wechat(account.id, user_info)
            
            # å‘é€æ¬¢è¿æ¶ˆæ¯
            self._send_welcome_message()
            
        except Exception as e:
            _logger.error(f"å¤„ç†å…³æ³¨äº‹ä»¶å¤±è´¥: {str(e)}")
    
    def _handle_unsubscribe_event(self):
        """å¤„ç†å–æ¶ˆå…³æ³¨äº‹ä»¶"""
        user = self.env['wechat.user'].search([
            ('openid', '=', self.from_user_name),
            ('account_id', '=', self.account_id.id)
        ], limit=1)
        
        if user:
            user.write({
                'subscribe': False,
                'last_message_time': fields.Datetime.now(),
            })
    
    def _handle_menu_click(self):
        """å¤„ç†èœå•ç‚¹å‡»äº‹ä»¶"""
        # æŸ¥æ‰¾å¯¹åº”çš„èœå•é¡¹
        menu_item = self.env['wechat.menu.item'].search([
            ('key', '=', self.event_key),
            ('account_id', '=', self.account_id.id)
        ], limit=1)
        
        if menu_item:
            # è®°å½•èœå•ç‚¹å‡»ç»Ÿè®¡
            self.env['wechat.menu.stat'].create({
                'menu_item_id': menu_item.id,
                'click_time': fields.Datetime.now(),
                'openid': self.from_user_name,
                'message_id': self.id,
            })
            
            # æ‰§è¡Œèœå•åŠ¨ä½œ
            if menu_item.action == 'reply':
                self._reply_to_user(menu_item.reply_content)
            elif menu_item.action == 'url':
                # è®°å½•è·³è½¬ï¼Œå®é™…è·³è½¬ç”±å¾®ä¿¡å®¢æˆ·ç«¯å¤„ç†
                pass
    
    def _auto_reply_text(self):
        """è‡ªåŠ¨å›å¤æ–‡æœ¬æ¶ˆæ¯"""
        # æŸ¥æ‰¾åŒ¹é…çš„å…³é”®è¯å›å¤è§„åˆ™
        rule = self.env['wechat.auto_reply'].search([
            ('account_id', '=', self.account_id.id),
            ('active', '=', True),
            ('rule_type', '=', 'keyword'),
            ('keyword', 'ilike', self.content),
        ], limit=1)
        
        if rule:
            self._reply_to_user(rule.reply_content)
            return
        
        # é»˜è®¤å›å¤
        default_reply = self.env['wechat.auto_reply'].search([
            ('account_id', '=', self.account_id.id),
            ('active', '=', True),
            ('rule_type', '=', 'default'),
        ], limit=1)
        
        if default_reply:
            self._reply_to_user(default_reply.reply_content)
    
    def _send_welcome_message(self):
        """å‘é€æ¬¢è¿æ¶ˆæ¯"""
        welcome_reply = self.env['wechat.auto_reply'].search([
            ('account_id', '=', self.account_id.id),
            ('active', '=', True),
            ('rule_type', '=', 'subscribe'),
        ], limit=1)
        
        if welcome_reply:
            self._reply_to_user(welcome_reply.reply_content)
    
    def _reply_to_user(self, content):
        """å›å¤ç”¨æˆ·æ¶ˆæ¯"""
        try:
            account = self.account_id
            client = account.get_api_client()
            
            # å‘é€å›å¤
            result = client.send_text_message(
                openid=self.from_user_name,
                content=content
            )
            
            # è®°å½•å‘é€çš„æ¶ˆæ¯
            reply_message = self.create({
                'account_id': self.account_id.id,
                'msg_type': 'text',
                'from_user_name': self.to_user_name,  # å…¬ä¼—å·
                'to_user_name': self.from_user_name,   # ç”¨æˆ·
                'create_time': fields.Datetime.now(),
                'direction': 'out',
                'status': 'replied',
                'content': content,
                'reply_id': self.id,
                'reply_content': content,
            })
            
            # æ›´æ–°åŸæ¶ˆæ¯çŠ¶æ€
            self.write({
                'status': 'replied',
                'reply_id': reply_message.id,
                'reply_content': content,
            })
            
            return reply_message
            
        except Exception as e:
            _logger.error(f"å›å¤æ¶ˆæ¯å¤±è´¥: {str(e)}")
            self.write({'status': 'failed'})
            return False
    
    def action_reply(self):
        """æ‰‹åŠ¨å›å¤æ¶ˆæ¯"""
        self.ensure_one()
        
        return {
            'type': 'ir.actions.act_window',
            'name': f'å›å¤æ¶ˆæ¯',
            'res_model': 'wechat.message.wizard',
            'view_mode': 'form',
            'target': 'new',
            'context': {
                'default_message_id': self.id,
                'default_to_user': self.from_user_name,
                'default_account_id': self.account_id.id,
            },
        }
    
    def action_view_user(self):
        """æŸ¥çœ‹å‘é€æ¶ˆæ¯çš„ç²‰ä¸"""
        self.ensure_one()
        
        user = self.env['wechat.user'].search([
            ('openid', '=', self.from_user_name),
            ('account_id', '=', self.account_id.id)
        ], limit=1)
        
        if user:
            return {
                'type': 'ir.actions.act_window',
                'name': user.nickname,
                'res_model': 'wechat.user',
                'view_mode': 'form',
                'res_id': user.id,
                'target': 'current',
            }
        
        return False
```

### **å‰ç«¯å¼€å‘å…·ä½“ä»»åŠ¡ï¼š**

#### **ä»»åŠ¡1ï¼šç²‰ä¸ç®¡ç†ç•Œé¢**
```javascript
// file: wechat_platform/static/src/js/wechat_user.js

odoo.define('wechat_platform.WechatUserList', function (require) {
    "use strict";

    const { Component, useState, onWillStart } = owl;
    const { useService } = require("@web/core/utils/hooks");
    
    class WechatUserList extends Component {
        static template = "wechat_platform.WechatUserList";
        static components = {};
        
        setup() {
            super.setup();
            this.orm = useService("orm");
            this.action = useService("action");
            this.notification = useService("notification");
            
            this.state = useState({
                users: [],
                selectedUsers: [],
                filters: {
                    subscribe: 'all',
                    sex: 'all',
                    country: '',
                    province: '',
                    city: '',
                    keyword: '',
                },
                pagination: {
                    page: 1,
                    pageSize: 50,
                    total: 0,
                    totalPages: 0,
                },
                loading: false,
                syncing: false,
                showFilterPanel: false,
            });
            
            onWillStart(async () => {
                await this.loadUsers();
            });
        }
        
        // åŠ è½½ç²‰ä¸åˆ—è¡¨
        async loadUsers() {
            this.state.loading = true;
            
            try {
                const offset = (this.state.pagination.page - 1) * this.state.pagination.pageSize;
                const limit = this.state.pagination.pageSize;
                
                const result = await this.orm.call(
                    'wechat.user',
                    'search_read',
                    [],
                    {
                        domain: this._buildDomain(),
                        offset: offset,
                        limit: limit,
                        fields: [
                            'id', 'nickname', 'openid', 'sex', 'country', 
                            'province', 'city', 'subscribe', 'subscribe_time',
                            'headimgurl', 'message_count', 'last_message_time',
                            'partner_id', 'remark'
                        ],
                        order: 'subscribe_time desc',
                    }
                );
                
                this.state.users = result;
                
                // è·å–æ€»æ•°
                const count = await this.orm.call(
                    'wechat.user',
                    'search_count',
                    [this._buildDomain()]
                );
                
                this.state.pagination.total = count;
                this.state.pagination.totalPages = Math.ceil(count / this.state.pagination.pageSize);
                
            } catch (error) {
                console.error('åŠ è½½ç²‰ä¸åˆ—è¡¨å¤±è´¥:', error);
                this.notification.add("åŠ è½½å¤±è´¥", { type: 'danger' });
            } finally {
                this.state.loading = false;
            }
        }
        
        // æ„å»ºæŸ¥è¯¢æ¡ä»¶
        _buildDomain() {
            const domain = [];
            
            // å…³æ³¨çŠ¶æ€ç­›é€‰
            if (this.state.filters.subscribe !== 'all') {
                domain.push(['subscribe', '=', this.state.filters.subscribe === 'subscribed']);
            }
            
            // æ€§åˆ«ç­›é€‰
            if (this.state.filters.sex !== 'all') {
                domain.push(['sex', '=', this.state.filters.sex]);
            }
            
            // åœ°åŒºç­›é€‰
            if (this.state.filters.country) {
                domain.push(['country', 'ilike', this.state.filters.country]);
            }
            if (this.state.filters.province) {
                domain.push(['province', 'ilike', this.state.filters.province]);
            }
            if (this.state.filters.city) {
                domain.push(['city', 'ilike', this.state.filters.city]);
            }
            
            // å…³é”®è¯æœç´¢
            if (this.state.filters.keyword) {
                domain.push(['|', 'nickname', 'ilike', this.state.filters.keyword]);
            }
            
            return domain;
        }
        
        // åŒæ­¥ç²‰ä¸
        async syncUsers() {
            this.state.syncing = true;
            
            try {
                const result = await this.orm.call(
                    'wechat.user',
                    'cron_sync_users',
                    []
                );
                
                this.notification.add(`åŒæ­¥å®Œæˆï¼Œæ›´æ–°äº† ${result} ä¸ªç²‰ä¸`, { type: 'success' });
                await this.loadUsers();
                
            } catch (error) {
                console.error('åŒæ­¥ç²‰ä¸å¤±è´¥:', error);
                this.notification.add("åŒæ­¥å¤±è´¥", { type: 'danger' });
            } finally {
                this.state.syncing = false;
            }
        }
        
        // æŸ¥çœ‹ç²‰ä¸è¯¦æƒ…
        viewUserDetail(userId) {
            this.action.doAction({
                type: 'ir.actions.act_window',
                name: 'ç²‰ä¸è¯¦æƒ…',
                res_model: 'wechat.user',
                views: [[false, 'form']],
                res_id: userId,
                target: 'current',
            });
        }
        
        // å‘é€æ¶ˆæ¯ç»™ç²‰ä¸
        sendMessageToUser(openid, nickname) {
            this.action.doAction({
                type: 'ir.actions.act_window',
                name: `å‘é€æ¶ˆæ¯ç»™ ${nickname}`,
                res_model: 'wechat.message.wizard',
                view_mode: 'form',
                target: 'new',
                context: {
                    default_to_user: openid,
                },
            });
        }
        
        // å…³è”åˆ°å®¢æˆ·
        async linkToPartner(userId) {
            try {
                await this.orm.call(
                    'wechat.user',
                    'link_to_partner',
                    [userId]
                );
                
                this.notification.add("å…³è”æˆåŠŸ", { type: 'success' });
                await this.loadUsers();
                
            } catch (error) {
                console.error('å…³è”å®¢æˆ·å¤±è´¥:', error);
                this.notification.add("å…³è”å¤±è´¥", { type: 'danger' });
            }
        }
        
        // æ‰¹é‡æ“ä½œ
        async batchAction(action) {
            if (this.state.selectedUsers.length === 0) {
                this.notification.add("è¯·å…ˆé€‰æ‹©ç²‰ä¸", { type: 'warning' });
                return;
            }
            
            try {
                if (action === 'sync') {
                    // æ‰¹é‡åŒæ­¥
                    await this.orm.call(
                        'wechat.user',
                        'sync_with_wechat',
                        [this.state.selectedUsers]
                    );
                    this.notification.add("åŒæ­¥æˆåŠŸ", { type: 'success' });
                    
                } else if (action === 'tag') {
                    // æ‰¹é‡æ‰“æ ‡ç­¾
                    // TODO: å®ç°æ ‡ç­¾ç®¡ç†
                    this.notification.add("åŠŸèƒ½å¼€å‘ä¸­", { type: 'info' });
                }
                
                await this.loadUsers();
                
            } catch (error) {
                console.error('æ‰¹é‡æ“ä½œå¤±è´¥:', error);
                this.notification.add("æ“ä½œå¤±è´¥", { type: 'danger' });
            }
        }
        
        // åˆ†é¡µæ§åˆ¶
        goToPage(page) {
            if (page >= 1 && page <= this.state.pagination.totalPages) {
                this.state.pagination.page = page;
                this.loadUsers();
            }
        }
        
        // æ”¹å˜æ¯é¡µæ˜¾ç¤ºæ•°é‡
        changePageSize(size) {
            this.state.pagination.pageSize = size;
            this.state.pagination.page = 1;
            this.loadUsers();
        }
        
        // å¯¼å‡ºç²‰ä¸æ•°æ®
        async exportUsers() {
            try {
                const result = await this.orm.call(
                    'wechat.user',
                    'export_users',
                    [this._buildDomain()]
                );
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const blob = new Blob([result], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `wechat_users_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                this.notification.add("å¯¼å‡ºå¤±è´¥", { type: 'danger' });
            }
        }
    }
    
    return WechatUserList;
});
```

#### **ä»»åŠ¡2ï¼šæ¶ˆæ¯ç®¡ç†ç•Œé¢**
```xml
<!-- file: wechat_platform/static/src/xml/wechat_message.xml -->

<templates id="template" xml:space="preserve">
    
    <!-- æ¶ˆæ¯åˆ—è¡¨ç•Œé¢ -->
    <t t-name="wechat_platform.WechatMessageList" owl="1">
        <div class="wechat-message-container">
            <!-- å·¥å…·æ  -->
            <div class="message-toolbar mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="mb-0">
                            <i class="fa fa-comments me-2"></i>
                            å¾®ä¿¡æ¶ˆæ¯ç®¡ç†
                        </h2>
                        <small class="text-muted">å®æ—¶æ¥æ”¶å’Œå¤„ç†ç²‰ä¸æ¶ˆæ¯</small>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary" 
                                t-on-click="toggleAutoRefresh">
                            <t t-if="state.autoRefreshEnabled">
                                <i class="fa fa-pause me-1"></i>
                                æš‚åœåˆ·æ–°
                            </t>
                            <t t-else="">
                                <i class="fa fa-play me-1"></i>
                                è‡ªåŠ¨åˆ·æ–°
                            </t>
                        </button>
                        <button class="btn btn-outline-secondary" 
                                t-on-click="refreshMessages">
                            <i class="fa fa-refresh me-1"></i>
                            åˆ·æ–°
                        </button>
                    </div>
                </div>
                
                <!-- è¿‡æ»¤å™¨ -->
                <div class="row mt-3">
                    <div class="col-md-3">
                        <select class="form-select" t-model="state.filters.direction">
                            <option value="all">å…¨éƒ¨æ¶ˆæ¯</option>
                            <option value="in">æ¥æ”¶æ¶ˆæ¯</option>
                            <option value="out">å‘é€æ¶ˆæ¯</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" t-model="state.filters.msgType">
                            <option value="all">å…¨éƒ¨ç±»å‹</option>
                            <option value="text">æ–‡æœ¬æ¶ˆæ¯</option>
                            <option value="image">å›¾ç‰‡æ¶ˆæ¯</option>
                            <option value="voice">è¯­éŸ³æ¶ˆæ¯</option>
                            <option value="event">äº‹ä»¶æ¶ˆæ¯</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" t-model="state.filters.status">
                            <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="received">æœªå¤„ç†</option>
                            <option value="processed">å·²å¤„ç†</option>
                            <option value="replied">å·²å›å¤</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <input type="text" class="form-control" 
                                   placeholder="æœç´¢å†…å®¹..."
                                   t-model="state.filters.keyword"
                                   t-on-keyup="debouncedSearch"/>
                            <button class="btn btn-outline-secondary" type="button">
                                <i class="fa fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ¶ˆæ¯åˆ—è¡¨ -->
            <div class="message-list-container">
                <t t-if="state.loading">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                        <p class="mt-2">åŠ è½½æ¶ˆæ¯ä¸­...</p>
                    </div>
                </t>
                
                <t t-elif="state.messages.length === 0">
                    <div class="text-center py-5">
                        <i class="fa fa-comment-slash fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">æš‚æ— æ¶ˆæ¯</h4>
                        <p class="text-muted">å½“ç²‰ä¸å‘é€æ¶ˆæ¯æ—¶ï¼Œä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                    </div>
                </t>
                
                <t t-else="">
                    <div class="list-group">
                        <t t-foreach="state.messages" t-as="message">
                            <div class="list-group-item message-item" 
                                 t-att-class="'message-direction-' + message.direction">
                                
                                <!-- æ¶ˆæ¯å¤´éƒ¨ -->
                                <div class="message-header d-flex justify-content-between align-items-center mb-2">
                                    <div class="d-flex align-items-center">
                                        <!-- ç”¨æˆ·å¤´åƒ -->
                                        <div class="user-avatar me-2">
                                            <t t-if="message.wechat_user_id and message.wechat_user_id.headimgurl">
                                                <img t-att-src="message.wechat_user_id.headimgurl" 
                                                     class="rounded-circle" 
                                                     style="width: 32px; height: 32px;"/>
                                            </t>
                                            <t t-else="">
                                                <div class="avatar-placeholder rounded-circle bg-secondary d-flex align-items-center justify-content-center" 
                                                     style="width: 32px; height: 32px;">
                                                    <i class="fa fa-user text-white"></i>
                                                </div>
                                            </t>
                                        </div>
                                        
                                        <!-- ç”¨æˆ·ä¿¡æ¯ -->
                                        <div>
                                            <h6 class="mb-0">
                                                <span t-esc="message.wechat_user_id.nickname or 'æœªçŸ¥ç”¨æˆ·'"/>
                                                <small class="text-muted ms-2">
                                                    (<span t-esc="message.from_user_name.substring(0, 8)"/>...)
                                                </small>
                                            </h6>
                                            <small class="text-muted">
                                                <i class="fa fa-clock me-1"></i>
                                                <span t-esc="formatTime(message.create_time)"/>
                                            </small>
                                        </div>
                                    </div>
                                    
                                    <!-- æ¶ˆæ¯çŠ¶æ€ -->
                                    <div class="message-status">
                                        <span t-att-class="'badge bg-' + getStatusColor(message.status)">
                                            <t t-switch="message.status">
                                                <t t-case="'received'">æœªå¤„ç†</t>
                                                <t t-case="'processed'">å·²å¤„ç†</t>
                                                <t t-case="'replied'">å·²å›å¤</t>
                                                <t t-case="'failed'">å¤±è´¥</t>
                                            </t>
                                        </span>
                                        
                                        <span t-att-class="'badge bg-' + getDirectionColor(message.direction)">
                                            <t t-if="message.direction === 'in'">æ¥æ”¶</t>
                                            <t t-else="">å‘é€</t>
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- æ¶ˆæ¯å†…å®¹ -->
                                <div class="message-body">
                                    <t t-switch="message.msg_type">
                                        
                                        <!-- æ–‡æœ¬æ¶ˆæ¯ -->
                                        <t t-case="'text'">
                                            <div class="text-message">
                                                <div class="message-bubble">
                                                    <p class="mb-0" t-esc="message.content"/>
                                                </div>
                                                <t t-if="message.recognition">
                                                    <div class="recognition-text mt-1">
                                                        <small class="text-muted">
                                                            <i class="fa fa-microphone me-1"></i>
                                                            è¯­éŸ³è¯†åˆ«: <span t-esc="message.recognition"/>
                                                        </small>
                                                    </div>
                                                </t>
                                            </div>
                                        </t>
                                        
                                        <!-- å›¾ç‰‡æ¶ˆæ¯ -->
                                        <t t-case="'image'">
                                            <div class="image-message">
                                                <div class="message-bubble">
                                                    <img t-att-src="message.pic_url" 
                                                         class="img-thumbnail" 
                                                         style="max-width: 200px;"/>
                                                    <div class="mt-2">
                                                        <small class="text-muted">
                                                            <i class="fa fa-image me-1"></i>
                                                            å›¾ç‰‡æ¶ˆæ¯
                                                        </small>
                                                    </div>
                                                </div>
                                            </div>
                                        </t>
                                        
                                        <!-- äº‹ä»¶æ¶ˆæ¯ -->
                                        <t t-case="'event'">
                                            <div class="event-message">
                                                <div class="message-bubble">
                                                    <div class="d-flex align-items-center">
                                                        <i class="fa fa-calendar-check text-primary me-2"></i>
                                                        <div>
                                                            <strong>
                                                                <t t-switch="message.event">
                                                                    <t t-case="'subscribe'">å…³æ³¨å…¬ä¼—å·</t>
                                                                    <t t-case="'unsubscribe'">å–æ¶ˆå…³æ³¨</t>
                                                                    <t t-case="'CLICK'">èœå•ç‚¹å‡»</t>
                                                                    <t t-case="'VIEW'">èœå•è·³è½¬</t>
                                                                    <t t-case="'SCAN'">æ‰«æäºŒç»´ç </t>
                                                                    <t t-else="">å…¶ä»–äº‹ä»¶</t>
                                                                </t>
                                                            </strong>
                                                            <t t-if="message.event_key">
                                                                <div class="mt-1">
                                                                    <small class="text-muted">
                                                                        äº‹ä»¶KEY: <span t-esc="message.event_key"/>
                                                                    </small>
                                                                </div>
                                                            </t>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </t>
                                        
                                        <!-- é»˜è®¤æ˜¾ç¤º -->
                                        <t t-case="default">
                                            <div class="other-message">
                                                <div class="message-bubble">
                                                    <div class="d-flex align-items-center">
                                                        <i class="fa fa-info-circle text-secondary me-2"></i>
                                                        <div>
                                                            <strong>
                                                                <span t-esc="message.msg_type"/>
                                                                æ¶ˆæ¯
                                                            </strong>
                                                            <div class="mt-1">
                                                                <small class="text-muted">
                                                                    æ¶ˆæ¯ID: <span t-esc="message.msg_id or 'N/A'"/>
                                                                </small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </t>
                                        
                                    </t>
                                </div>
                                
                                <!-- å›å¤å†…å®¹ï¼ˆå¦‚æœæœ‰ï¼‰ -->
                                <t t-if="message.reply_content">
                                    <div class="reply-section mt-3">
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="flex-grow-1">
                                                <div class="d-flex align-items-center">
                                                    <i class="fa fa-reply text-success me-2"></i>
                                                    <strong>å·²å›å¤</strong>
                                                    <small class="text-muted ms-2">
                                                        <span t-esc="formatTime(message.process_time)"/>
                                                    </small>
                                                </div>
                                            </div>
                                            <div>
                                                <small class="text-muted" 
                                                       t-if="message.auto_reply">
                                                    <i class="fa fa-robot me-1"></i>è‡ªåŠ¨å›å¤
                                                </small>
                                            </div>
                                        </div>
                                        <div class="reply-content">
                                            <div class="reply-bubble">
                                                <p class="mb-0" t-esc="message.reply_content"/>
                                            </div>
                                        </div>
                                    </div>
                                </t>
                                
                                <!-- æ“ä½œæŒ‰é’® -->
                                <div class="message-actions mt-3">
                                    <div class="btn-group btn-group-sm">
                                        <t t-if="message.direction === 'in' and message.status !== 'replied'">
                                            <button class="btn btn-outline-primary"
                                                    t-on-click="() => replyToMessage(message.id)">
                                                <i class="fa fa-reply me-1"></i>
                                                å›å¤
                                            </button>
                                        </t>
                                        <button class="btn btn-outline-secondary"
                                                t-on-click="() => viewUserDetail(message.wechat_user_id.id)"
                                                t-att-disabled="!message.wechat_user_id">
                                            <i class="fa fa-user me-1"></i>
                                            æŸ¥çœ‹ç²‰ä¸
                                        </button>
                                        <button class="btn btn-outline-info"
                                                t-on-click="() => viewMessageDetail(message.id)">
                                            <i class="fa fa-info-circle me-1"></i>
                                            è¯¦æƒ…
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </div>
                    
                    <!-- åˆ†é¡µ -->
                    <t t-if="state.pagination.totalPages > 1">
                        <div class="d-flex justify-content-center mt-4">
                            <nav>
                                <ul class="pagination">
                                    <li class="page-item" t-att-class="state.pagination.page === 1 ? 'disabled' : ''">
                                        <button class="page-link" 
                                                t-on-click="() => goToPage(state.pagination.page - 1)">
                                            ä¸Šä¸€é¡µ
                                        </button>
                                    </li>
                                    
                                    <t t-foreach="getPageNumbers()" t-as="pageNum">
                                        <li class="page-item" t-att-class="state.pagination.page === pageNum ? 'active' : ''">
                                            <button class="page-link" 
                                                    t-on-click="() => goToPage(pageNum)">
                                                <span t-esc="pageNum"/>
                                            </button>
                                        </li>
                                    </t>
                                    
                                    <li class="page-item" t-att-class="state.pagination.page === state.pagination.totalPages ? 'disabled' : ''">
                                        <button class="page-link" 
                                                t-on-click="() => goToPage(state.pagination.page + 1)">
                                            ä¸‹ä¸€é¡µ
                                        </button>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </t>
                </t>
            </div>
            
            <!-- æœªè¯»æ¶ˆæ¯æç¤º -->
            <t t-if="state.unreadCount > 0">
                <div class="position-fixed bottom-0 end-0 m-3">
                    <div class="alert alert-info alert-dismissible fade show" role="alert">
                        <div class="d-flex align-items-center">
                            <i class="fa fa-bell me-2"></i>
                            <div>
                                <strong>æœ‰ <span t-esc="state.unreadCount"/> æ¡æ–°æ¶ˆæ¯</strong>
                                <button type="button" class="btn btn-sm btn-outline-info ms-2"
                                        t-on-click="loadNewMessages">
                                    æŸ¥çœ‹
                                </button>
                            </div>
                            <button type="button" class="btn-close ms-3" 
                                    data-bs-dismiss="alert" aria-label="Close"
                                    t-on-click="dismissNewMessages"></button>
                        </div>
                    </div>
                </div>
            </t>
        </div>
    </t>
    
    <!-- æ¶ˆæ¯æ ·å¼ -->
    <style>
        .wechat-message-container {
            background: #f8f9fa;
            min-height: 100vh;
            padding: 20px;
        }
        
        .message-item {
            border-left: 4px solid transparent;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .message-direction-in {
            border-left-color: #28a745;
            background: rgba(40, 167, 69, 0.05);
        }
        
        .message-direction-out {
            border-left-color: #007bff;
            background: rgba(0, 123, 255, 0.05);
        }
        
        .message-header {
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .user-avatar img {
            object-fit: cover;
        }
        
        .avatar-placeholder {
            width: 32px;
            height: 32px;
            font-size: 14px;
        }
        
        .message-bubble {
            background: white;
            padding: 12px 16px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 80%;
            margin: 8px 0;
        }
        
        .message-direction-out .message-bubble {
            background: #e3f2fd;
            margin-left: auto;
        }
        
        .reply-bubble {
            background: #f1f8e9;
            padding: 10px 14px;
            border-radius: 10px;
            border-left: 3px solid #8bc34a;
        }
        
        .recognition-text {
            font-style: italic;
            color: #666;
            padding-left: 10px;
            border-left: 2px solid #ff9800;
        }
        
        .badge {
            font-size: 11px;
            padding: 4px 8px;
            margin-left: 5px;
        }
        
        .bg-received { background: #ffc107; }
        .bg-processed { background: #17a2b8; }
        .bg-replied { background: #28a745; }
        .bg-failed { background: #dc3545; }
        
        .bg-in { background: #28a745; }
        .bg-out { background: #007bff; }
        
        .message-actions {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .message-item:hover .message-actions {
            opacity: 1;
        }
        
        @media (max-width: 768px) {
            .wechat-message-container {
                padding: 10px;
            }
            
            .message-bubble {
                max-width: 90%;
            }
            
            .message-actions {
                opacity: 1;
            }
        }
    </style>
</templates>
```

#### **ä»»åŠ¡3ï¼šæ ·å¼è®¾è®¡**
```css
/* file: wechat_platform/static/src/css/wechat_platform.css */

/* å…¨å±€æ ·å¼ */
.wechat-platform {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}

/* ç²‰ä¸ç®¡ç†é¡µé¢ */
.wechat-user-container {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow: hidden;
}

.user-list-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
}

.user-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.stat-card {
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    text-align: center;
}

.stat-card .stat-value {
    font-size: 24px;
    font-weight: bold;
    color: #333;
    margin-bottom: 5px;
}

.stat-card .stat-label {
    font-size: 12px;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.user-card {
    border: 1px solid #eaeaea;
    border-radius: 8px;
    overflow: hidden;
    transition: all 0.3s ease;
    cursor: pointer;
}

.user-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.user-avatar {
    width: 100%;
    height: 160px;
    overflow: hidden;
    background: #f5f5f5;
}

.user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.user-card:hover .user-avatar img {
    transform: scale(1.05);
}

.user-info {
    padding: 15px;
}

.user-name {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 5px;
    color: #333;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.user-meta {
    font-size: 12px;
    color: #666;
    margin-bottom: 10px;
}

.user-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-bottom: 10px;
}

.user-tag {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 10px;
    background: #f0f0f0;
    color: #666;
}

.user-actions {
    display: flex;
    gap: 8px;
}

/* æ¶ˆæ¯ç•Œé¢æ ·å¼ */
.message-container {
    max-width: 800px;
    margin: 0 auto;
    background: #fff;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
}

.message-sidebar {
    background: #2c3e50;
    color: white;
    height: 100%;
}

.conversation-list {
    height: calc(100vh - 200px);
    overflow-y: auto;
}

.conversation-item {
    padding: 12px 15px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    cursor: pointer;
    transition: background 0.3s ease;
}

.conversation-item:hover {
    background: rgba(255,255,255,0.1);
}

.conversation-item.active {
    background: rgba(255,255,255,0.2);
}

.conversation-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    overflow: hidden;
    margin-right: 10px;
}

.conversation-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.conversation-info h6 {
    margin-bottom: 2px;
    font-size: 14px;
}

.conversation-info p {
    font-size: 12px;
    opacity: 0.8;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 0;
}

.message-area {
    height: calc(100vh - 150px);
    overflow-y: auto;
    padding: 20px;
    background: #f8f9fa;
}

.message-input-area {
    border-top: 1px solid #eaeaea;
    padding: 15px;
    background: white;
}

.message-bubble {
    max-width: 70%;
    margin-bottom: 15px;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.message-bubble.received {
    margin-right: auto;
}

.message-bubble.received .bubble-content {
    background: white;
    border: 1px solid #eaeaea;
    border-radius: 18px 18px 18px 4px;
}

.message-bubble.sent {
    margin-left: auto;
}

.message-bubble.sent .bubble-content {
    background: #007bff;
    color: white;
    border-radius: 18px 18px 4px 18px;
}

.bubble-content {
    padding: 12px 16px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.bubble-time {
    font-size: 11px;
    color: #999;
    margin-top: 4px;
    text-align: right;
}

.message-input-tools {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}

.tool-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: none;
    background: #f8f9fa;
    color: #666;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.tool-btn:hover {
    background: #e9ecef;
    color: #007bff;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .user-stats {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .message-container {
        border-radius: 0;
    }
    
    .message-bubble {
        max-width: 85%;
    }
}

@media (max-width: 576px) {
    .user-stats {
        grid-template-columns: 1fr;
    }
    
    .message-bubble {
        max-width: 90%;
    }
}

/* åŠ¨ç”»æ•ˆæœ */
.fade-enter {
    opacity: 0;
}

.fade-enter-active {
    opacity: 1;
    transition: opacity 300ms ease-in;
}

.fade-exit {
    opacity: 1;
}

.fade-exit-active {
    opacity: 0;
    transition: opacity 300ms ease-out;
}

/* åŠ è½½åŠ¨ç”» */
.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* çŠ¶æ€æŒ‡ç¤ºå™¨ */
.status-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 5px;
}

.status-online {
    background: #2ecc71;
    box-shadow: 0 0 0 2px rgba(46, 204, 113, 0.3);
}

.status-offline {
    background: #95a5a6;
}

.status-away {
    background: #f39c12;
}

/* å·¥å…·æç¤º */
.custom-tooltip {
    position: relative;
}

.custom-tooltip .tooltip-text {
    visibility: hidden;
    background: #333;
    color: white;
    text-align: center;
    padding: 5px 10px;
    border-radius: 4px;
    position: absolute;
    z-index: 1;
    bottom: 125%;
    left: 50%;
    transform: translateX(-50%);
    white-space: nowrap;
    font-size: 12px;
    opacity: 0;
    transition: opacity 0.3s;
}

.custom-tooltip:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
}

/* æ»šåŠ¨æ¡ç¾åŒ– */
::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
```

### **å¾®ä¿¡å¼€å‘ä¸“å®¶å…·ä½“ä»»åŠ¡ï¼š**

#### **ä»»åŠ¡1ï¼šç²‰ä¸åŒæ­¥æœºåˆ¶å®ç°**
```python
# file: wechat_platform/lib/user_sync_manager.py

import time
import logging
from typing import List, Dict, Optional, Tuple
from datetime import datetime, timedelta
from queue import Queue
from threading import Thread, Lock
import json

_logger = logging.getLogger(__name__)

class UserSyncManager:
    """ç²‰ä¸åŒæ­¥ç®¡ç†å™¨"""
    
    def __init__(self, account_id: int, batch_size: int = 10000):
        self.account_id = account_id
        self.batch_size = batch_size
        self.sync_queue = Queue()
        self.results = []
        self.lock = Lock()
        self.is_running = False
        self.worker_threads = []
        
    def start_sync(self, full_sync: bool = False) -> Dict:
        """å¼€å§‹åŒæ­¥ç²‰ä¸
        
        Args:
            full_sync: æ˜¯å¦å…¨é‡åŒæ­¥ï¼ˆé»˜è®¤å¢é‡åŒæ­¥ï¼‰
            
        Returns:
            åŒæ­¥ç»“æœç»Ÿè®¡
        """
        try:
            account = self.env['wechat.account'].browse(self.account_id)
            client = account.get_api_client()
            
            # è·å–å½“å‰å·²åŒæ­¥çš„æœ€å¤§OpenID
            last_openid = None if full_sync else self._get_last_synced_openid()
            
            # è·å–ç²‰ä¸åˆ—è¡¨
            total_synced = 0
            while True:
                user_list_data = client.get_user_list(next_openid=last_openid)
                
                if not user_list_data or 'data' not in user_list_data:
                    break
                
                openids = user_list_data['data'].get('openid', [])
                total_count = user_list_data.get('total', 0)
                
                _logger.info(f"è·å–åˆ° {len(openids)} ä¸ªOpenIDï¼Œæ€»è®¡ {total_count} ç²‰ä¸")
                
                # åˆ†æ‰¹å¤„ç†
                for i in range(0, len(openids), self.batch_size):
                    batch = openids[i:i + self.batch_size]
                    self._sync_user_batch(client, batch, account.id)
                    total_synced += len(batch)
                
                # æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤š
                next_openid = user_list_data.get('next_openid')
                if not next_openid or next_openid == last_openid:
                    break
                
                last_openid = next_openid
                
                # é˜²æ­¢è§¦å‘é¢‘ç‡é™åˆ¶
                time.sleep(0.5)
            
            return {
                'success': True,
                'total_synced': total_synced,
                'full_sync': full_sync,
                'sync_time': datetime.now().isoformat(),
            }
            
        except Exception as e:
            _logger.error(f"ç²‰ä¸åŒæ­¥å¤±è´¥: {str(e)}")
            return {
                'success': False,
                'error': str(e),
                'total_synced': 0,
            }
    
    def _get_last_synced_openid(self) -> Optional[str]:
        """è·å–æœ€ååŒæ­¥çš„OpenID"""
        last_user = self.env['wechat.user'].search([
            ('account_id', '=', self.account_id),
            ('is_synced', '=', True),
        ], order='sync_date desc', limit=1)
        
        return last_user.openid if last_user else None
    
    def _sync_user_batch(self, client, openids: List[str], account_id: int):
        """åŒæ­¥ä¸€æ‰¹ç²‰ä¸"""
        try:
            # æ‰¹é‡è·å–ç”¨æˆ·ä¿¡æ¯
            user_list = [{'openid': openid} for openid in openids]
            batch_result = client.batch_get_user_info(user_list)
            
            if batch_result and 'user_info_list' in batch_result:
                for user_info in batch_result['user_info_list']:
                    try:
                        self.env['wechat.user'].create_from_wechat(account_id, user_info)
                    except Exception as e:
                        _logger.warning(f"åˆ›å»ºç²‰ä¸å¤±è´¥ {user_info.get('openid')}: {str(e)}")
                        
        except Exception as e:
            _logger.error(f"æ‰¹é‡åŒæ­¥å¤±è´¥: {str(e)}")
    
    def start_concurrent_sync(self, thread_count: int = 5):
        """å¯åŠ¨å¹¶å‘åŒæ­¥"""
        if self.is_running:
            return {'status': 'already_running'}
        
        self.is_running = True
        self.results = []
        
        # å¯åŠ¨å·¥ä½œçº¿ç¨‹
        for i in range(thread_count):
            thread = Thread(target=self._sync_worker, daemon=True)
            thread.start()
            self.worker_threads.append(thread)
        
        # è·å–æ‰€æœ‰éœ€è¦åŒæ­¥çš„OpenID
        self._enqueue_openids()
        
        return {'status': 'started', 'threads': thread_count}
    
    def _enqueue_openids(self):
        """å°†OpenIDåŠ å…¥é˜Ÿåˆ—"""
        account = self.env['wechat.account'].browse(self.account_id)
        client = account.get_api_client()
        
        last_openid = None
        while True:
            try:
                user_list_data = client.get_user_list(next_openid=last_openid)
                
                if not user_list_data or 'data' not in user_list_data:
                    break
                
                openids = user_list_data['data'].get('openid', [])
                
                # åŠ å…¥é˜Ÿåˆ—
                for openid in openids:
                    self.sync_queue.put(openid)
                
                # æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤š
                next_openid = user_list_data.get('next_openid')
                if not next_openid or next_openid == last_openid:
                    break
                
                last_openid = next_openid
                
                # é˜²æ­¢è§¦å‘é¢‘ç‡é™åˆ¶
                time.sleep(0.3)
                
            except Exception as e:
                _logger.error(f"è·å–OpenIDåˆ—è¡¨å¤±è´¥: {str(e)}")
                break
        
        # æ·»åŠ ç»“æŸæ ‡è®°
        for _ in range(len(self.worker_threads)):
            self.sync_queue.put(None)
    
    def _sync_worker(self):
        """åŒæ­¥å·¥ä½œçº¿ç¨‹"""
        while True:
            openid = self.sync_queue.get()
            
            if openid is None:  # ç»“æŸæ ‡è®°
                break
            
            try:
                account = self.env['wechat.account'].browse(self.account_id)
                client = account.get_api_client()
                
                # è·å–ç”¨æˆ·ä¿¡æ¯
                user_info = client.get_user_info(openid)
                
                # åˆ›å»ºæˆ–æ›´æ–°ç²‰ä¸è®°å½•
                self.env['wechat.user'].create_from_wechat(self.account_id, user_info)
                
                with self.lock:
                    self.results.append({
                        'openid': openid,
                        'success': True,
                        'timestamp': datetime.now().isoformat(),
                    })
                
            except Exception as e:
                _logger.error(f"åŒæ­¥ç²‰ä¸å¤±è´¥ {openid}: {str(e)}")
                
                with self.lock:
                    self.results.append({
                        'openid': openid,
                        'success': False,
                        'error': str(e),
                        'timestamp': datetime.now().isoformat(),
                    })
            
            finally:
                self.sync_queue.task_done()
                time.sleep(0.1)  # æ§åˆ¶è¯·æ±‚é¢‘ç‡
    
    def get_sync_progress(self) -> Dict:
        """è·å–åŒæ­¥è¿›åº¦"""
        queue_size = self.sync_queue.qsize()
        completed = len([r for r in self.results if r['success']])
        failed = len([r for r in self.results if not r['success']])
        
        return {
            'queue_size': queue_size,
            'completed': completed,
            'failed': failed,
            'total': queue_size + completed + failed,
            'is_running': self.is_running,
        }
    
    def stop_sync(self):
        """åœæ­¢åŒæ­¥"""
        self.is_running = False
        
        # æ¸…ç©ºé˜Ÿåˆ—
        while not self.sync_queue.empty():
            try:
                self.sync_queue.get_nowait()
            except:
                break
        
        # ç­‰å¾…çº¿ç¨‹ç»“æŸ
        for thread in self.worker_threads:
            thread.join(timeout=5)
        
        self.worker_threads = []
        
        return {'status': 'stopped', 'results': self.results}


class UserTagManager:
    """ç²‰ä¸æ ‡ç­¾ç®¡ç†å™¨"""
    
    def __init__(self, account_id: int):
        self.account_id = account_id
        self.account = self.env['wechat.account'].browse(account_id)
        self.client = self.account.get_api_client()
    
    def sync_tags_from_wechat(self) -> List[Dict]:
        """ä»å¾®ä¿¡åŒæ­¥æ ‡ç­¾"""
        try:
            # è¿™é‡Œåº”è¯¥è°ƒç”¨å¾®ä¿¡çš„æ ‡ç­¾API
            # ä¸ºç®€åŒ–ç¤ºä¾‹ï¼Œæˆ‘ä»¬æ¨¡æ‹Ÿä¸€äº›æ ‡ç­¾æ•°æ®
            mock_tags = [
                {'id': 101, 'name': 'VIPå®¢æˆ·', 'count': 50},
                {'id': 102, 'name': 'æ½œåœ¨å®¢æˆ·', 'count': 200},
                {'id': 103, 'name': 'å·²è´­ä¹°', 'count': 150},
                {'id': 104, 'name': 'æ´»è·ƒç”¨æˆ·', 'count': 300},
            ]
            
            tags_created = []
            for tag_data in mock_tags:
                tag = self.env['wechat.user.tag'].create({
                    'account_id': self.account_id,
                    'tag_id': tag_data['id'],
                    'name': tag_data['name'],
                    'count': tag_data['count'],
                    'is_synced': True,
                })
                tags_created.append(tag.id)
            
            _logger.info(f"åŒæ­¥äº† {len(tags_created)} ä¸ªæ ‡ç­¾")
            return tags_created
            
        except Exception as e:
            _logger.error(f"åŒæ­¥æ ‡ç­¾å¤±è´¥: {str(e)}")
            raise
    
    def tag_users(self, tag_id: int, openids: List[str]) -> Dict:
        """ä¸ºç²‰ä¸æ‰“æ ‡ç­¾"""
        try:
            # æ‰¹é‡æ‰“æ ‡ç­¾
            success_count = 0
            failed_openids = []
            
            for openid in openids:
                try:
                    # è¿™é‡Œåº”è¯¥è°ƒç”¨å¾®ä¿¡çš„æ‰“æ ‡ç­¾API
                    # æ¨¡æ‹ŸæˆåŠŸ
                    success_count += 1
                    
                    # æ›´æ–°æœ¬åœ°è®°å½•
                    user = self.env['wechat.user'].search([
                        ('openid', '=', openid),
                        ('account_id', '=', self.account_id),
                    ], limit=1)
                    
                    if user:
                        # è§£æç°æœ‰çš„æ ‡ç­¾åˆ—è¡¨
                        current_tags = json.loads(user.tagid_list or '[]')
                        if tag_id not in current_tags:
                            current_tags.append(tag_id)
                            user.write({'tagid_list': json.dumps(current_tags)})
                    
                except Exception as e:
                    failed_openids.append({'openid': openid, 'error': str(e)})
            
            return {
                'success': True,
                'success_count': success_count,
                'failed_count': len(failed_openids),
                'failed_openids': failed_openids,
            }
            
        except Exception as e:
            _logger.error(f"æ‰¹é‡æ‰“æ ‡ç­¾å¤±è´¥: {str(e)}")
            return {
                'success': False,
                'error': str(e),
            }
    
    def get_user_tags(self, openid: str) -> List[Dict]:
        """è·å–ç²‰ä¸çš„æ ‡ç­¾"""
        try:
            user = self.env['wechat.user'].search([
                ('openid', '=', openid),
                ('account_id', '=', self.account_id),
            ], limit=1)
            
            if not user:
                return []
            
            tag_ids = json.loads(user.tagid_list or '[]')
            tags = self.env['wechat.user.tag'].search([
                ('tag_id', 'in', tag_ids),
                ('account_id', '=', self.account_id),
            ])
            
            return [{
                'id': tag.tag_id,
                'name': tag.name,
                'color': tag.color,
            } for tag in tags]
            
        except Exception as e:
            _logger.error(f"è·å–ç²‰ä¸æ ‡ç­¾å¤±è´¥ {openid}: {str(e)}")
            return []
    
    def analyze_user_segments(self) -> List[Dict]:
        """åˆ†æç”¨æˆ·åˆ†ç¾¤"""
        segments = []
        
        # æŒ‰åœ°åŒºåˆ†ç¾¤
        provinces = self.env['wechat.user'].read_group(
            [('account_id', '=', self.account_id), ('subscribe', '=', True)],
            ['province'],
            ['province']
        )
        
        for province_data in provinces:
            if province_data['province']:
                segments.append({
                    'type': 'province',
                    'name': province_data['province'],
                    'count': province_data['province_count'],
                    'description': f'{province_data["province"]}åœ°åŒºçš„ç²‰ä¸',
                })
        
        # æŒ‰æ€§åˆ«åˆ†ç¾¤
        genders = self.env['wechat.user'].read_group(
            [('account_id', '=', self.account_id), ('subscribe', '=', True)],
            ['sex'],
            ['sex']
        )
        
        gender_map = {'1': 'ç”·æ€§', '2': 'å¥³æ€§', '0': 'æœªçŸ¥'}
        for gender_data in genders:
            segments.append({
                'type': 'gender',
                'name': gender_map.get(gender_data['sex'], 'æœªçŸ¥'),
                'count': gender_data['sex_count'],
                'description': f'{gender_map.get(gender_data["sex"], "æœªçŸ¥")}ç²‰ä¸',
            })
        
        # æŒ‰æ´»è·ƒåº¦åˆ†ç¾¤
        active_users = self.env['wechat.user'].search_count([
            ('account_id', '=', self.account_id),
            ('subscribe', '=', True),
            ('last_message_time', '>=', datetime.now() - timedelta(days=7)),
        ])
        
        segments.append({
            'type': 'activity',
            'name': 'æ´»è·ƒç²‰ä¸',
            'count': active_users,
            'description': 'æœ€è¿‘7å¤©æœ‰äº’åŠ¨çš„ç²‰ä¸',
        })
        
        return segments


class UserBehaviorAnalyzer:
    """ç”¨æˆ·è¡Œä¸ºåˆ†æå™¨"""
    
    def __init__(self, account_id: int):
        self.account_id = account_id
    
    def analyze_message_patterns(self, days: int = 30) -> Dict:
        """åˆ†ææ¶ˆæ¯æ¨¡å¼"""
        start_date = datetime.now() - timedelta(days=days)
        
        # è·å–æ¶ˆæ¯æ•°æ®
        messages = self.env['wechat.message'].search([
            ('account_id', '=', self.account_id),
            ('create_time', '>=', start_date),
            ('direction', '=', 'in'),  # åªåˆ†ææ¥æ”¶çš„æ¶ˆæ¯
        ])
        
        # æŒ‰ç±»å‹ç»Ÿè®¡
        type_stats = {}
        for msg in messages:
            msg_type = msg.msg_type
            type_stats[msg_type] = type_stats.get(msg_type, 0) + 1
        
        # æŒ‰æ—¶é—´ç»Ÿè®¡ï¼ˆå°æ—¶ï¼‰
        hour_stats = {str(i).zfill(2): 0 for i in range(24)}
        for msg in messages:
            hour = msg.create_time.hour if msg.create_time else 0
            hour_key = str(hour).zfill(2)
            hour_stats[hour_key] = hour_stats.get(hour_key, 0) + 1
        
        # å…³é”®è¯åˆ†æï¼ˆä»…æ–‡æœ¬æ¶ˆæ¯ï¼‰
        text_messages = messages.filtered(lambda m: m.msg_type == 'text')
        word_freq = {}
        
        # ç®€å•çš„å…³é”®è¯æå–ï¼ˆå®é™…åº”è¯¥ç”¨æ›´å¤æ‚çš„æ–¹æ³•ï¼‰
        for msg in text_messages:
            if msg.content:
                words = msg.content.split()
                for word in words:
                    if len(word) >= 2:  # è‡³å°‘2ä¸ªå­—ç¬¦
                        word_freq[word] = word_freq.get(word, 0) + 1
        
        # å–å‡ºç°é¢‘ç‡æœ€é«˜çš„20ä¸ªè¯
        top_words = sorted(word_freq.items(), key=lambda x: x[1], reverse=True)[:20]
        
        return {
            'total_messages': len(messages),
            'type_distribution': type_stats,
            'hourly_distribution': hour_stats,
            'top_keywords': top_words,
            'active_users': len(set(messages.mapped('from_user_name'))),
            'response_rate': self._calculate_response_rate(messages),
        }
    
    def _calculate_response_rate(self, messages) -> float:
        """è®¡ç®—å›å¤ç‡"""
        received_messages = messages.filtered(lambda m: m.direction == 'in')
        replied_messages = received_messages.filtered(lambda m: m.status == 'replied')
        
        if not received_messages:
            return 0.0
        
        return len(replied_messages) / len(received_messages) * 100
    
    def analyze_user_retention(self, cohort_days: int = 7) -> List[Dict]:
        """åˆ†æç”¨æˆ·ç•™å­˜ç‡ï¼ˆç¾¤ç»„åˆ†æï¼‰"""
        cohorts = []
        
        # æŒ‰å‘¨åˆ†ç»„
        for i in range(4):  # åˆ†ææœ€è¿‘4å‘¨
            cohort_start = datetime.now() - timedelta(days=(i + 1) * cohort_days)
            cohort_end = cohort_start + timedelta(days=cohort_days)
            
            # è¯¥ç¾¤ç»„çš„æ–°å…³æ³¨ç”¨æˆ·
            new_users = self.env['wechat.user'].search([
                ('account_id', '=', self.account_id),
                ('subscribe_time', '>=', cohort_start),
                ('subscribe_time', '<', cohort_end),
                ('subscribe', '=', True),
            ])
            
            # è®¡ç®—ç•™å­˜
            retention_data = {
                'cohort': cohort_start.strftime('%Y-%m-%d'),
                'total_users': len(new_users),
                'retention': {},
            }
            
            # è®¡ç®—ç¬¬1ã€7ã€30å¤©ç•™å­˜
            for day in [1, 7, 30]:
                check_date = cohort_end + timedelta(days=day)
                
                # æ£€æŸ¥è¿˜æœ‰å¤šå°‘ç”¨æˆ·ä»ç„¶å…³æ³¨
                retained_users = new_users.filtered(
                    lambda u: u.subscribe and 
                    (not u.last_message_time or u.last_message_time <= check_date)
                )
                
                retention_rate = len(retained_users) / len(new_users) * 100 if new_users else 0
                retention_data['retention'][f'day_{day}'] = {
                    'count': len(retained_users),
                    'rate': retention_rate,
                }
            
            cohorts.append(retention_data)
        
        return cohorts
    
    def generate_user_report(self, openid: str) -> Dict:
        """ç”Ÿæˆç”¨æˆ·è¡Œä¸ºæŠ¥å‘Š"""
        user = self.env['wechat.user'].search([
            ('openid', '=', openid),
            ('account_id', '=', self.account_id),
        ], limit=1)
        
        if not user:
            return {}
        
        # è·å–ç”¨æˆ·çš„æ‰€æœ‰æ¶ˆæ¯
        messages = self.env['wechat.message'].search([
            ('account_id', '=', self.account_id),
            ('from_user_name', '=', openid),
            ('direction', '=', 'in'),
        ], order='create_time')
        
        # ç»Ÿè®¡ä¿¡æ¯
        total_messages = len(messages)
        first_message = messages[0] if messages else None
        last_message = messages[-1] if messages else None
        
        # æ¶ˆæ¯ç±»å‹åˆ†å¸ƒ
        type_stats = {}
        for msg in messages:
            msg_type = msg.msg_type
            type_stats[msg_type] = type_stats.get(msg_type, 0) + 1
        
        # æ´»è·ƒæ—¶é—´æ®µ
        hour_stats = {str(i).zfill(2): 0 for i in range(24)}
        for msg in messages:
            if msg.create_time:
                hour = msg.create_time.hour
                hour_key = str(hour).zfill(2)
                hour_stats[hour_key] = hour_stats.get(hour_key, 0) + 1
        
        # äº’åŠ¨é¢‘ç‡
        if first_message and last_message and messages:
            days_diff = (last_message.create_time - first_message.create_time).days + 1
            avg_messages_per_day = total_messages / days_diff if days_diff > 0 else 0
        else:
            avg_messages_per_day = 0
        
        return {
            'user_info': {
                'nickname': user.nickname,
                'subscribe_time': user.subscribe_time,
                'last_message_time': user.last_message_time,
            },
            'message_stats': {
                'total': total_messages,
                'type_distribution': type_stats,
                'hourly_distribution': hour_stats,
                'avg_per_day': avg_messages_per_day,
            },
            'behavior_patterns': {
                'preferred_message_type': max(type_stats.items(), key=lambda x: x[1])[0] if type_stats else None,
                'peak_hour': max(hour_stats.items(), key=lambda x: x[1])[0] if hour_stats else None,
                'response_rate': self._calculate_user_response_rate(openid),
            },
        }
    
    def _calculate_user_response_rate(self, openid: str) -> float:
        """è®¡ç®—ç”¨æˆ·çš„å›å¤ç‡"""
        received_messages = self.env['wechat.message'].search([
            ('account_id', '=', self.account_id),
            ('from_user_name', '=', openid),
            ('direction', '=', 'in'),
        ])
        
        replied_messages = received_messages.filtered(lambda m: m.status == 'replied')
        
        if not received_messages:
            return 0.0
        
        return len(replied_messages) / len(received_messages) * 100
```

#### **ä»»åŠ¡2ï¼šæ¶ˆæ¯é˜Ÿåˆ—å’Œå¼‚æ­¥å¤„ç†**
```python
# file: wechat_platform/lib/message_queue.py

import asyncio
import aiohttp
import json
import time
from typing import Dict, List, Optional, Any
from datetime import datetime
import logging
from concurrent.futures import ThreadPoolExecutor
import redis
import pickle

_logger = logging.getLogger(__name__)

class AsyncMessageProcessor:
    """å¼‚æ­¥æ¶ˆæ¯å¤„ç†å™¨"""
    
    def __init__(self, max_workers: int = 10, use_redis: bool = True):
        self.max_workers = max_workers
        self.use_redis = use_redis
        self.executor = ThreadPoolExecutor(max_workers=max_workers)
        self.loop = asyncio.get_event_loop()
        
        if use_redis:
            self.redis_client = redis.Redis(
                host='localhost',
                port=6379,
                db=1,
                decode_responses=False
            )
        
        # æ¶ˆæ¯é˜Ÿåˆ—
        self.message_queue = asyncio.Queue()
        self.processing_tasks = []
        
        # ç»Ÿè®¡ä¿¡æ¯
        self.stats = {
            'processed': 0,
            'failed': 0,
            'queued': 0,
            'processing': 0,
        }
    
    async def start(self):
        """å¯åŠ¨å¤„ç†å™¨"""
        _logger.info("å¯åŠ¨å¼‚æ­¥æ¶ˆæ¯å¤„ç†å™¨")
        
        # å¯åŠ¨å¤šä¸ªæ¶ˆè´¹è€…
        for i in range(self.max_workers):
            task = asyncio.create_task(self._consumer(i))
            self.processing_tasks.append(task)
        
        # å¯åŠ¨ç»Ÿè®¡æŠ¥å‘Š
        asyncio.create_task(self._report_stats())
    
    async def stop(self):
        """åœæ­¢å¤„ç†å™¨"""
        _logger.info("åœæ­¢å¼‚æ­¥æ¶ˆæ¯å¤„ç†å™¨")
        
        # å–æ¶ˆæ‰€æœ‰ä»»åŠ¡
        for task in self.processing_tasks:
            task.cancel()
        
        # ç­‰å¾…ä»»åŠ¡å®Œæˆ
        await asyncio.gather(*self.processing_tasks, return_exceptions=True)
        self.executor.shutdown(wait=True)
    
    async def enqueue_message(self, message_data: Dict) -> bool:
        """å°†æ¶ˆæ¯åŠ å…¥é˜Ÿåˆ—"""
        try:
            # åºåˆ—åŒ–æ¶ˆæ¯æ•°æ®
            if self.use_redis:
                # å­˜å‚¨åˆ°Redisé˜Ÿåˆ—
                queue_key = f"wechat:messages:{datetime.now().strftime('%Y%m%d')}"
                self.redis_client.rpush(queue_key, pickle.dumps(message_data))
                self.stats['queued'] += 1
            else:
                # åŠ å…¥å†…å­˜é˜Ÿåˆ—
                await self.message_queue.put(message_data)
                self.stats['queued'] += 1
            
            return True
            
        except Exception as e:
            _logger.error(f"æ¶ˆæ¯å…¥é˜Ÿå¤±è´¥: {str(e)}")
            return False
    
    async def _consumer(self, worker_id: int):
        """æ¶ˆæ¯æ¶ˆè´¹è€…"""
        _logger.info(f"å¯åŠ¨æ¶ˆæ¯æ¶ˆè´¹è€… {worker_id}")
        
        while True:
            try:
                # è·å–æ¶ˆæ¯
                if self.use_redis:
                    queue_key = f"wechat:messages:{datetime.now().strftime('%Y%m%d')}"
                    message_data = self.redis_client.blpop(queue_key, timeout=1)
                    if message_data:
                        message_data = pickle.loads(message_data[1])
                    else:
                        await asyncio.sleep(0.1)
                        continue
                else:
                    message_data = await self.message_queue.get()
                
                self.stats['processing'] += 1
                self.stats['queued'] -= 1
                
                # å¤„ç†æ¶ˆæ¯
                await self._process_message(worker_id, message_data)
                
                if not self.use_redis:
                    self.message_queue.task_done()
                
                self.stats['processing'] -= 1
                self.stats['processed'] += 1
                
            except asyncio.CancelledError:
                break
            except Exception as e:
                _logger.error(f"æ¶ˆè´¹è€… {worker_id} å¤„ç†å¤±è´¥: {str(e)}")
                self.stats['failed'] += 1
                self.stats['processing'] -= 1
    
    async def _process_message(self, worker_id: int, message_data: Dict):
        """å¤„ç†å•æ¡æ¶ˆæ¯"""
        try:
            start_time = time.time()
            
            # æ ¹æ®æ¶ˆæ¯ç±»å‹è°ƒç”¨ä¸åŒçš„å¤„ç†å™¨
            msg_type = message_data.get('msg_type')
            
            if msg_type == 'text':
                await self._process_text_message(message_data)
            elif msg_type == 'event':
                await self._process_event_message(message_data)
            elif msg_type == 'image':
                await self._process_image_message(message_data)
            else:
                await self._process_other_message(message_data)
            
            processing_time = time.time() - start_time
            _logger.debug(f"æ¶ˆè´¹è€… {worker_id} å¤„ç†æ¶ˆæ¯è€—æ—¶: {processing_time:.3f}s")
            
        except Exception as e:
            _logger.error(f"å¤„ç†æ¶ˆæ¯å¤±è´¥: {str(e)}")
            raise
    
    async def _process_text_message(self, message_data: Dict):
        """å¤„ç†æ–‡æœ¬æ¶ˆæ¯"""
        # è¿™é‡Œè°ƒç”¨åŒæ­¥çš„Odooæ–¹æ³•éœ€è¦åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œ
        await self.loop.run_in_executor(
            self.executor,
            self._sync_process_text_message,
            message_data
        )
    
    def _sync_process_text_message(self, message_data: Dict):
        """åŒæ­¥å¤„ç†æ–‡æœ¬æ¶ˆæ¯"""
        try:
            # è¿™é‡Œå¯ä»¥è°ƒç”¨Odooçš„æ¨¡å‹æ–¹æ³•
            # ä¾‹å¦‚ï¼šè‡ªåŠ¨å›å¤ã€å…³é”®è¯åŒ¹é…ç­‰
            content = message_data.get('content', '')
            openid = message_data.get('from_user_name', '')
            
            _logger.info(f"å¤„ç†æ–‡æœ¬æ¶ˆæ¯: {openid} -> {content[:50]}...")
            
            # è¿™é‡Œæ·»åŠ å®é™…çš„å¤„ç†é€»è¾‘
            
        except Exception as e:
            _logger.error(f"åŒæ­¥å¤„ç†æ–‡æœ¬æ¶ˆæ¯å¤±è´¥: {str(e)}")
    
    async def _process_event_message(self, message_data: Dict):
        """å¤„ç†äº‹ä»¶æ¶ˆæ¯"""
        event_type = message_data.get('event')
        
        if event_type == 'subscribe':
            await self._process_subscribe_event(message_data)
        elif event_type == 'unsubscribe':
            await self._process_unsubscribe_event(message_data)
        elif event_type == 'CLICK':
            await self._process_menu_click_event(message_data)
    
    async def _process_subscribe_event(self, message_data: Dict):
        """å¤„ç†å…³æ³¨äº‹ä»¶"""
        await self.loop.run_in_executor(
            self.executor,
            self._sync_process_subscribe_event,
            message_data
        )
    
    def _sync_process_subscribe_event(self, message_data: Dict):
        """åŒæ­¥å¤„ç†å…³æ³¨äº‹ä»¶"""
        try:
            # åŒæ­¥ç”¨æˆ·ä¿¡æ¯
            openid = message_data.get('from_user_name', '')
            account_id = message_data.get('account_id')
            
            _logger.info(f"å¤„ç†å…³æ³¨äº‹ä»¶: {openid}")
            
            # è¿™é‡Œæ·»åŠ å®é™…çš„å…³æ³¨äº‹ä»¶å¤„ç†é€»è¾‘
            
        except Exception as e:
            _logger.error(f"å¤„ç†å…³æ³¨äº‹ä»¶å¤±è´¥: {str(e)}")
    
    async def _process_image_message(self, message_data: Dict):
        """å¤„ç†å›¾ç‰‡æ¶ˆæ¯"""
        # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å›¾ç‰‡è¯†åˆ«ã€ä¿å­˜ç­‰é€»è¾‘
        media_id = message_data.get('media_id')
        pic_url = message_data.get('pic_url')
        
        _logger.info(f"å¤„ç†å›¾ç‰‡æ¶ˆæ¯: {media_id}")
    
    async def _process_other_message(self, message_data: Dict):
        """å¤„ç†å…¶ä»–ç±»å‹æ¶ˆæ¯"""
        msg_type = message_data.get('msg_type')
        _logger.info(f"å¤„ç† {msg_type} ç±»å‹æ¶ˆæ¯")
    
    async def _report_stats(self):
        """æŠ¥å‘Šç»Ÿè®¡ä¿¡æ¯"""
        while True:
            try:
                await asyncio.sleep(60)  # æ¯åˆ†é’ŸæŠ¥å‘Šä¸€æ¬¡
                
                _logger.info(f"æ¶ˆæ¯å¤„ç†ç»Ÿè®¡: {json.dumps(self.stats, indent=2)}")
                
                # é‡ç½®æ¯æ—¥ç»Ÿè®¡
                if datetime.now().hour == 0 and datetime.now().minute < 1:
                    self.stats = {
                        'processed': 0,
                        'failed': 0,
                        'queued': 0,
                        'processing': 0,
                    }
                
            except asyncio.CancelledError:
                break
            except Exception as e:
                _logger.error(f"æŠ¥å‘Šç»Ÿè®¡å¤±è´¥: {str(e)}")


class MessageRateLimiter:
    """æ¶ˆæ¯é¢‘ç‡é™åˆ¶å™¨"""
    
    def __init__(self, limits: Dict[str, int]):
        """
        Args:
            limits: é™åˆ¶é…ç½®ï¼Œä¾‹å¦‚ï¼š
                {
                    'per_second': 5,
                    'per_minute': 100,
                    'per_hour': 1000,
                }
        """
        self.limits = limits
        self.request_times = {}  # {user_id: [timestamp1, timestamp2, ...]}
        self.lock = asyncio.Lock()
    
    async def check_limit(self, user_id: str) -> Tuple[bool, Optional[str]]:
        """æ£€æŸ¥æ˜¯å¦è¶…è¿‡é¢‘ç‡é™åˆ¶"""
        async with self.lock:
            now = time.time()
            
            # åˆå§‹åŒ–ç”¨æˆ·è®°å½•
            if user_id not in self.request_times:
                self.request_times[user_id] = []
            
            user_times = self.request_times[user_id]
            
            # æ¸…ç†è¿‡æœŸè®°å½•
            user_times[:] = [t for t in user_times if now - t <= 3600]  # ä¿ç•™1å°æ—¶å†…çš„è®°å½•
            
            # æ£€æŸ¥ç§’çº§é™åˆ¶
            if 'per_second' in self.limits:
                recent_second = [t for t in user_times if now - t <= 1]
                if len(recent_second) >= self.limits['per_second']:
                    return False, 'per_second_limit'
            
            # æ£€æŸ¥åˆ†é’Ÿçº§é™åˆ¶
            if 'per_minute' in self.limits:
                recent_minute = [t for t in user_times if now - t <= 60]
                if len(recent_minute) >= self.limits['per_minute']:
                    return False, 'per_minute_limit'
            
            # æ£€æŸ¥å°æ—¶çº§é™åˆ¶
            if 'per_hour' in self.limits:
                recent_hour = [t for t in user_times if now - t <= 3600]
                if len(recent_hour) >= self.limits['per_hour']:
                    return False, 'per_hour_limit'
            
            # æ·»åŠ å½“å‰è¯·æ±‚
            user_times.append(now)
            
            # ä¿æŒè®°å½•æ•°é‡åˆç†
            if len(user_times) > 1000:
                user_times = user_times[-1000:]
            
            return True, None
    
    def get_user_stats(self, user_id: str) -> Dict:
        """è·å–ç”¨æˆ·è¯·æ±‚ç»Ÿè®¡"""
        now = time.time()
        
        if user_id not in self.request_times:
            return {'total': 0, 'per_second': 0, 'per_minute': 0, 'per_hour': 0}
        
        user_times = self.request_times[user_id]
        
        # æ¸…ç†è¿‡æœŸè®°å½•
        user_times[:] = [t for t in user_times if now - t <= 3600]
        
        return {
            'total': len(user_times),
            'per_second': len([t for t in user_times if now - t <= 1]),
            'per_minute': len([t for t in user_times if now - t <= 60]),
            'per_hour': len([t for t in user_times if now - t <= 3600]),
        }
    
    def cleanup_old_records(self, max_age: int = 86400):
        """æ¸…ç†è¿‡æœŸè®°å½•ï¼ˆ24å°æ—¶ï¼‰"""
        now = time.time()
        expired_count = 0
        
        for user_id in list(self.request_times.keys()):
            user_times = self.request_times[user_id]
            original_count = len(user_times)
            
            # æ¸…ç†è¿‡æœŸè®°å½•
            user_times[:] = [t for t in user_times if now - t <= max_age]
            
            expired_count += (original_count - len(user_times))
            
            # å¦‚æœç”¨æˆ·æ²¡æœ‰æ´»åŠ¨è®°å½•äº†ï¼Œåˆ é™¤ç”¨æˆ·
            if not user_times:
                del self.request_times[user_id]
        
        _logger.info(f"æ¸…ç†äº† {expired_count} æ¡è¿‡æœŸè®°å½•")
        return expired_count


class MessagePriorityQueue:
    """æ¶ˆæ¯ä¼˜å…ˆçº§é˜Ÿåˆ—"""
    
    def __init__(self, priorities: List[str] = None):
        self.priorities = priorities or ['high', 'normal', 'low']
        self.queues = {priority: asyncio.Queue() for priority in self.priorities}
        self.priority_weights = {
            'high': 3,
            'normal': 2,
            'low': 1,
        }
    
    async def put(self, message: Dict, priority: str = 'normal'):
        """æ·»åŠ æ¶ˆæ¯åˆ°é˜Ÿåˆ—"""
        if priority not in self.queues:
            priority = 'normal'
        
        await self.queues[priority].put(message)
    
    async def get(self) -> Dict:
        """è·å–æ¶ˆæ¯ï¼ˆåŠ æƒä¼˜å…ˆçº§ï¼‰"""
        # è®¡ç®—æ€»æƒé‡
        total_weight = sum(self.priority_weights.values())
        
        # æ ¹æ®æƒé‡é€‰æ‹©é˜Ÿåˆ—
        import random
        rand = random.uniform(0, total_weight)
        
        current = 0
        selected_priority = None
        
        for priority, weight in self.priority_weights.items():
            current += weight
            if rand <= current:
                selected_priority = priority
                break
        
        # å¦‚æœé€‰ä¸­çš„é˜Ÿåˆ—ä¸ºç©ºï¼Œå°è¯•å…¶ä»–é˜Ÿåˆ—
        if selected_priority and not self.queues[selected_priority].empty():
            return await self.queues[selected_priority].get()
        
        # æŒ‰ä¼˜å…ˆçº§é¡ºåºæ£€æŸ¥é˜Ÿåˆ—
        for priority in self.priorities:
            if not self.queues[priority].empty():
                return await self.queues[priority].get()
        
        # æ‰€æœ‰é˜Ÿåˆ—éƒ½ä¸ºç©ºï¼Œç­‰å¾…
        # ä½¿ç”¨asyncio.waitåŒæ—¶ç­‰å¾…æ‰€æœ‰é˜Ÿåˆ—
        tasks = [asyncio.create_task(q.get()) for q in self.queues.values()]
        done, pending = await asyncio.wait(tasks, return_when=asyncio.FIRST_COMPLETED)
        
        # å–æ¶ˆå…¶ä»–ä»»åŠ¡
        for task in pending:
            task.cancel()
        
        # è¿”å›å®Œæˆçš„ä»»åŠ¡ç»“æœ
        for task in done:
            return task.result()
    
    def qsize(self) -> Dict[str, int]:
        """è·å–å„ä¼˜å…ˆçº§é˜Ÿåˆ—å¤§å°"""
        return {priority: q.qsize() for priority, q in self.queues.items()}
    
    def empty(self) -> bool:
        """æ£€æŸ¥æ‰€æœ‰é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º"""
        return all(q.empty() for q in self.queues.values())
```

### **å®‰å…¨å®¡æŸ¥ä¸“å®¶å…·ä½“ä»»åŠ¡ï¼š**

#### **ä»»åŠ¡1ï¼šæ¶ˆæ¯å®‰å…¨æµ‹è¯•**
```python
# file: tests/security/test_wechat_message_security.py

import pytest
import json
import xml.etree.ElementTree as ET
from unittest.mock import Mock, patch, MagicMock
from odoo.tests.common import TransactionCase, tagged
from odoo.exceptions import ValidationError, UserError
from datetime import datetime, timedelta

@tagged('wechat_security', 'post_install', '-at_install')
class TestWechatMessageSecurity(TransactionCase):
    """å¾®ä¿¡æ¶ˆæ¯å®‰å…¨æµ‹è¯•"""
    
    def setUp(self):
        super(TestWechatMessageSecurity, self).setUp()
        
        # åˆ›å»ºæµ‹è¯•æ•°æ®
        self.wechat_account = self.env['wechat.account'].create({
            'name': 'æµ‹è¯•å…¬ä¼—å·',
            'app_id': 'wx_test_app_id',
            'app_secret': 'test_app_secret',
            'account_type': 'service',
            'token': 'test_token_123456',
            'encoding_aes_key': 'test_aes_key_1234567890123456789012345678901234567',
        })
        
        self.wechat_user = self.env['wechat.user'].create({
            'openid': 'test_openid_123456',
            'account_id': self.wechat_account.id,
            'nickname': 'æµ‹è¯•ç”¨æˆ·',
            'subscribe': True,
        })
    
    def test_message_injection_prevention(self):
        """æµ‹è¯•æ¶ˆæ¯æ³¨å…¥æ”»å‡»é˜²æŠ¤"""
        malicious_xmls = [
            # XMLæ³¨å…¥
            '''<xml>
                <ToUserName><![CDATA[toUser]]></ToUserName>
                <FromUserName><![CDATA[fromUser]]></FromUserName>
                <CreateTime>1348831860</CreateTime>
                <MsgType><![CDATA[text]]></MsgType>
                <Content><![CDATA[<script>alert("xss")</script>]]></Content>
                <MsgId>1234567890123456</MsgId>
            </xml>''',
            
            # SQLæ³¨å…¥
            '''<xml>
                <ToUserName><![CDATA[toUser]]></ToUserName>
                <FromUserName><![CDATA[fromUser]]></FromUserName>
                <CreateTime>1348831860</CreateTime>
                <MsgType><![CDATA[text]]></MsgType>
                <Content><![CDATA[' OR '1'='1]]></Content>
                <MsgId>1234567890123456</MsgId>
            </xml>''',
            
            # å‘½ä»¤æ³¨å…¥
            '''<xml>
                <ToUserName><![CDATA[toUser]]></ToUserName>
                <FromUserName><![CDATA[fromUser]]></FromUserName>
                <CreateTime>1348831860</CreateTime>
                <MsgType><![CDATA[text]]></MsgType>
                <Content><![CDATA[; rm -rf /;]]></Content>
                <MsgId>1234567890123456</MsgId>
            </xml>''',
        ]
        
        for malicious_xml in malicious_xmls:
            try:
                message = self.env['wechat.message'].create_from_xml(
                    self.wechat_account.id,
                    malicious_xml
                )
                
                # æ£€æŸ¥å†…å®¹æ˜¯å¦è¢«è½¬ä¹‰æˆ–è¿‡æ»¤
                if message and message.content:
                    assert '<script>' not in message.content, "XSSæ³¨å…¥æœªé˜²æŠ¤"
                    assert "' OR '1'='1" not in message.content, "SQLæ³¨å…¥æœªé˜²æŠ¤"
                    assert '; rm -rf' not in message.content, "å‘½ä»¤æ³¨å…¥æœªé˜²æŠ¤"
                    
            except Exception as e:
                # æœŸæœ›è§£æå¤±è´¥æˆ–éªŒè¯å¤±è´¥
                assert "æ³¨å…¥" in str(e).lower() or "invalid" in str(e).lower()
    
    def test_message_replay_attack(self):
        """æµ‹è¯•æ¶ˆæ¯é‡æ”¾æ”»å‡»é˜²æŠ¤"""
        # åˆ›å»ºä¸€æ¡æ­£å¸¸æ¶ˆæ¯
        normal_xml = '''<xml>
            <ToUserName><![CDATA[toUser]]></ToUserName>
            <FromUserName><![CDATA[fromUser]]></FromUserName>
            <CreateTime>1348831860</CreateTime>
            <MsgType><![CDATA[text]]></MsgType>
            <Content><![CDATA[æµ‹è¯•æ¶ˆæ¯]]></Content>
            <MsgId>1234567890123456</MsgId>
        </xml>'''
        
        # ç¬¬ä¸€æ¬¡æ¥æ”¶åº”è¯¥æˆåŠŸ
        message1 = self.env['wechat.message'].create_from_xml(
            self.wechat_account.id,
            normal_xml
        )
        assert message1, "ç¬¬ä¸€æ¬¡æ¥æ”¶æ¶ˆæ¯åº”è¯¥æˆåŠŸ"
        
        # ç«‹å³é‡æ”¾ç›¸åŒçš„æ¶ˆæ¯
        with pytest.raises(ValidationError) as context:
            self.env['wechat.message'].create_from_xml(
                self.wechat_account.id,
                normal_xml
            )
        
        # åº”è¯¥æ£€æµ‹åˆ°é‡æ”¾æ”»å‡»
        assert "é‡å¤" in str(context.value) or "é‡æ”¾" in str(context.value)
    
    def test_message_timestamp_validation(self):
        """æµ‹è¯•æ¶ˆæ¯æ—¶é—´æˆ³éªŒè¯"""
        now = int(datetime.now().timestamp())
        
        # è¿‡æœŸæ¶ˆæ¯ï¼ˆ10åˆ†é’Ÿå‰ï¼‰
        expired_xml = f'''<xml>
            <ToUserName><![CDATA[toUser]]></ToUserName>
            <FromUserName><![CDATA[fromUser]]></FromUserName>
            <CreateTime>{now - 600}</CreateTime>
            <MsgType><![CDATA[text]]></MsgType>
            <Content><![CDATA[æµ‹è¯•æ¶ˆæ¯]]></Content>
            <MsgId>1234567890123456</MsgId>
        </xml>'''
        
        # æœªæ¥æ¶ˆæ¯ï¼ˆ5åˆ†é’Ÿåï¼‰
        future_xml = f'''<xml>
            <ToUserName><![CDATA[toUser]]></ToUserName>
            <FromUserName><![CDATA[fromUser]]></FromUserName>
            <CreateTime>{now + 300}</CreateTime>
            <MsgType><![CDATA[text]]></MsgType>
            <Content><![CDATA[æµ‹è¯•æ¶ˆæ¯]]></Content>
            <MsgId>1234567890123456</MsgId>
        </xml>'''
        
        # æµ‹è¯•è¿‡æœŸæ¶ˆæ¯
        with pytest.raises(ValidationError) as context:
            self.env['wechat.message'].create_from_xml(
                self.wechat_account.id,
                expired_xml
            )
        assert "è¿‡æœŸ" in str(context.value) or "æ—¶é—´æˆ³" in str(context.value)
        
        # æµ‹è¯•æœªæ¥æ¶ˆæ¯
        with pytest.raises(ValidationError) as context:
            self.env['wechat.message'].create_from_xml(
                self.wechat_account.id,
                future_xml
            )
        assert "æœªæ¥" in str(context.value) or "æ—¶é—´æˆ³" in str(context.value)
    
    def test_message_signature_verification(self):
        """æµ‹è¯•æ¶ˆæ¯ç­¾åéªŒè¯"""
        # æ¨¡æ‹ŸéªŒè¯ç­¾åçš„æ–¹æ³•
        crypto = self.wechat_account.get_crypto()
        
        # æµ‹è¯•æœ‰æ•ˆç­¾å
        valid_params = {
            'signature': 'valid_signature_123',
            'timestamp': '1234567890',
            'nonce': 'nonce123',
            'echostr': 'echo_test',
        }
        
        with patch.object(type(crypto), 'verify_signature', return_value=True):
            result = crypto.verify_signature(
                valid_params['signature'],
                valid_params['timestamp'],
                valid_params['nonce'],
                valid_params['echostr']
            )
            assert result is True
        
        # æµ‹è¯•æ— æ•ˆç­¾å
        invalid_params = {
            'signature': 'invalid_signature',
            'timestamp': '1234567890',
            'nonce': 'nonce123',
            'echostr': 'echo_test',
        }
        
        with patch.object(type(crypto), 'verify_signature', return_value=False):
            result = crypto.verify_signature(
                invalid_params['signature'],
                invalid_params['timestamp'],
                invalid_params['nonce'],
                invalid_params['echostr']
            )
            assert result is False
    
    def test_message_encryption_security(self):
        """æµ‹è¯•æ¶ˆæ¯åŠ å¯†å®‰å…¨æ€§"""
        crypto = self.wechat_account.get_crypto()
        
        test_messages = [
            "æ™®é€šæ–‡æœ¬æ¶ˆæ¯",
            "åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼šå¯†ç 123456",
            "åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼š!@#$%^&*()",
            "åŒ…å«ä¸­æ–‡ï¼šæµ‹è¯•æ¶ˆæ¯",
            "é•¿æ¶ˆæ¯" * 100,
        ]
        
        for original_text in test_messages:
            # åŠ å¯†
            encrypted = crypto.encrypt(original_text)
            
            # éªŒè¯åŠ å¯†ç»“æœ
            assert encrypted, "åŠ å¯†åº”è¯¥æˆåŠŸ"
            assert len(encrypted) > len(original_text), "åŠ å¯†ååº”è¯¥æ›´é•¿"
            
            # è§£å¯†ï¼ˆè¿™é‡Œéœ€è¦æ¨¡æ‹Ÿå¾®ä¿¡çš„å›è°ƒæ•°æ®ï¼‰
            # åœ¨å®é™…æµ‹è¯•ä¸­ï¼Œéœ€è¦å®Œæ•´çš„åŠ å¯†/è§£å¯†æµç¨‹
            
    def test_user_data_privacy(self):
        """æµ‹è¯•ç”¨æˆ·æ•°æ®éšç§ä¿æŠ¤"""
        # åˆ›å»ºåŒ…å«æ•æ„Ÿä¿¡æ¯çš„ç”¨æˆ·
        sensitive_user = self.env['wechat.user'].create({
            'openid': 'sensitive_openid',
            'account_id': self.wechat_account.id,
            'nickname': 'æ•æ„Ÿç”¨æˆ·',
            'headimgurl': 'http://example.com/avatar.jpg',
            'country': 'ä¸­å›½',
            'province': 'å¹¿ä¸œ',
            'city': 'æ·±åœ³',
            'subscribe': True,
        })
        
        # æµ‹è¯•æ•°æ®è®¿é—®æƒé™
        # 1. æ™®é€šç”¨æˆ·ä¸åº”è¯¥çœ‹åˆ°æ•æ„Ÿå­—æ®µ
        with self.assertRaises(AccessError):
            self.env['wechat.user'].with_user(self.env.ref('base.user_demo')).read(
                ['openid', 'unionid', 'headimgurl']
            )
        
        # 2. ç³»ç»Ÿç”¨æˆ·å¯ä»¥çœ‹åˆ°æ‰€æœ‰å­—æ®µ
        admin_user = self.env.ref('base.user_admin')
        user_data = self.env['wechat.user'].with_user(admin_user).read(
            ['openid', 'unionid', 'headimgurl']
        )
        assert user_data, "ç®¡ç†å‘˜åº”è¯¥å¯ä»¥æŸ¥çœ‹ç”¨æˆ·æ•°æ®"
        
        # 3. å¯¼å‡ºæ•°æ®åº”è¯¥è„±æ•
        export_data = sensitive_user.export_data(['openid', 'nickname', 'headimgurl'])
        if export_data:
            # æ£€æŸ¥æ˜¯å¦å¯¹æ•æ„Ÿæ•°æ®è¿›è¡Œäº†å¤„ç†
            assert 'sensitive_openid' not in str(export_data), "å¯¼å‡ºæ•°æ®æœªè„±æ•"
    
    def test_message_rate_limiting(self):
        """æµ‹è¯•æ¶ˆæ¯é¢‘ç‡é™åˆ¶"""
        from wechat_platform.lib.message_queue import MessageRateLimiter
        
        limiter = MessageRateLimiter({
            'per_second': 5,
            'per_minute': 10,
            'per_hour': 100,
        })
        
        user_id = 'test_user_123'
        
        # æ¨¡æ‹Ÿå¿«é€Ÿè¯·æ±‚
        import asyncio
        
        async def test_requests():
            results = []
            for i in range(15):  # è¶…è¿‡æ¯åˆ†é’Ÿé™åˆ¶
                allowed, reason = await limiter.check_limit(user_id)
                results.append((allowed, reason))
                await asyncio.sleep(0.01)  # å¿«é€Ÿè¿ç»­è¯·æ±‚
            
            return results
        
        # è¿è¡Œæµ‹è¯•
        loop = asyncio.new_event_loop()
        results = loop.run_until_complete(test_requests())
        loop.close()
        
        # ç»Ÿè®¡ç»“æœ
        allowed_count = sum(1 for allowed, _ in results if allowed)
        blocked_count = len(results) - allowed_count
        
        # åº”è¯¥æœ‰é™åˆ¶
        assert blocked_count > 0, "é¢‘ç‡é™åˆ¶æœªç”Ÿæ•ˆ"
        
        # è·å–ç»Ÿè®¡ä¿¡æ¯
        stats = limiter.get_user_stats(user_id)
        assert stats['per_minute'] <= 10, "åˆ†é’Ÿçº§é™åˆ¶æœªç”Ÿæ•ˆ"
    
    def test_sql_injection_prevention(self):
        """æµ‹è¯•SQLæ³¨å…¥é˜²æŠ¤"""
        # æµ‹è¯•å„ç§SQLæ³¨å…¥å°è¯•
        injection_attempts = [
            "test' OR '1'='1",
            "test'; DROP TABLE wechat_user; --",
            "test' UNION SELECT * FROM wechat_user --",
            "test' AND 1=CONVERT(int, (SELECT @@version)) --",
        ]
        
        for injection in injection_attempts:
            # å°è¯•é€šè¿‡æœç´¢åŠŸèƒ½æ³¨å…¥
            try:
                users = self.env['wechat.user'].search([
                    '|',
                    ('nickname', 'ilike', injection),
                    ('openid', 'ilike', injection),
                ])
                
                # Odooçš„ORMåº”è¯¥é˜²æŠ¤SQLæ³¨å…¥
                # å¦‚æœæ²¡æœ‰å¼‚å¸¸ï¼Œæ£€æŸ¥ç»“æœæ˜¯å¦å®‰å…¨
                if users:
                    # ç¡®ä¿æ²¡æœ‰æ‰§è¡Œå±é™©çš„æŸ¥è¯¢
                    pass
                    
            except Exception as e:
                # æœŸæœ›ORMæŠ›å‡ºå®‰å…¨ç›¸å…³çš„å¼‚å¸¸
                assert "SQL" in str(e) or "injection" in str(e).lower()
        
        # æµ‹è¯•åŸå§‹SQLæŸ¥è¯¢çš„å®‰å…¨æ€§
        with self.assertRaises(Exception):
            self.env.cr.execute(f"SELECT * FROM wechat_user WHERE nickname = '{injection}'")
    
    def test_xss_prevention_in_messages(self):
        """æµ‹è¯•æ¶ˆæ¯ä¸­çš„XSSé˜²æŠ¤"""
        xss_attempts = [
            '<script>alert("xss")</script>',
            '<img src="x" onerror="alert(1)">',
            '<svg onload="alert(1)">',
            'javascript:alert(1)',
            'data:text/html,<script>alert(1)</script>',
        ]
        
        for xss in xss_attempts:
            # åˆ›å»ºåŒ…å«XSSå°è¯•çš„æ¶ˆæ¯
            message = self.env['wechat.message'].create({
                'account_id': self.wechat_account.id,
                'msg_type': 'text',
                'from_user_name': 'test_user',
                'to_user_name': 'test_account',
                'direction': 'in',
                'content': xss,
            })
            
            # æ£€æŸ¥å†…å®¹æ˜¯å¦è¢«è½¬ä¹‰æˆ–è¿‡æ»¤
            if message.content:
                assert '<script>' not in message.content, f"XSSæœªè¿‡æ»¤: {xss}"
                assert 'onerror=' not in message.content, f"äº‹ä»¶å¤„ç†å™¨æœªè¿‡æ»¤: {xss}"
                assert 'javascript:' not in message.content, f"JSåè®®æœªè¿‡æ»¤: {xss}"
    
    def test_file_upload_security(self):
        """æµ‹è¯•æ–‡ä»¶ä¸Šä¼ å®‰å…¨æ€§"""
        malicious_files = [
            ('evil.php', '<?php system($_GET["cmd"]); ?>'),
            ('test.exe', 'MZ...æ¶æ„ä»£ç ...'),
            ('../../etc/passwd', 'root:x:0:0:root:/root:/bin/bash'),
            ('normal.jpg', 'æ¶æ„å†…å®¹ä¼ªè£…æˆå›¾ç‰‡'),
        ]
        
        for filename, content in malicious_files:
            try:
                # å°è¯•ä¸Šä¼ æ¶æ„æ–‡ä»¶
                # è¿™é‡Œåº”è¯¥è°ƒç”¨æ–‡ä»¶ä¸Šä¼ çš„å®‰å…¨æ£€æŸ¥æ–¹æ³•
                
                # æ£€æŸ¥æ–‡ä»¶æ‰©å±•å
                if not self._is_safe_file_extension(filename):
                    raise ValidationError("ä¸å®‰å…¨çš„æ–‡ä»¶ç±»å‹")
                
                # æ£€æŸ¥æ–‡ä»¶å†…å®¹
                if self._contains_malicious_content(content):
                    raise ValidationError("æ–‡ä»¶åŒ…å«æ¶æ„å†…å®¹")
                
                # æ£€æŸ¥è·¯å¾„éå†
                if '..' in filename or '/' in filename:
                    raise ValidationError("ä¸å®‰å…¨çš„æ–‡ä»¶å")
                
            except ValidationError as e:
                # æœŸæœ›çš„å®‰å…¨æ£€æŸ¥å¤±è´¥
                assert "å®‰å…¨" in str(e) or "æ¶æ„" in str(e) or "ä¸å®‰å…¨" in str(e)
    
    def _is_safe_file_extension(self, filename):
        """æ£€æŸ¥æ–‡ä»¶æ‰©å±•åæ˜¯å¦å®‰å…¨"""
        safe_extensions = {'.jpg', '.jpeg', '.png', '.gif', '.mp3', '.mp4'}
        ext = '.' + filename.split('.')[-1].lower()
        return ext in safe_extensions
    
    def _contains_malicious_content(self, content):
        """æ£€æŸ¥æ˜¯å¦åŒ…å«æ¶æ„å†…å®¹"""
        malicious_patterns = [
            '<?php',
            '<script>',
            'eval(',
            'system(',
            'exec(',
        ]
        
        return any(pattern in content for pattern in malicious_patterns)
```

#### **ä»»åŠ¡2ï¼šå®‰å…¨ç›‘æ§å’Œå®¡è®¡**
```python
# file: security/wechat_security_monitor.py

import logging
import json
from datetime import datetime, timedelta
from typing import Dict, List, Optional
import hashlib
import hmac
import base64

_logger = logging.getLogger(__name__)

class WechatSecurityMonitor:
    """å¾®ä¿¡å®‰å…¨ç›‘æ§å™¨"""
    
    def __init__(self):
        self.suspicious_activities = []
        self.security_logs = []
        self.alert_thresholds = {
            'failed_auth': 5,  # 5æ¬¡è®¤è¯å¤±è´¥
            'invalid_signature': 10,  # 10æ¬¡æ— æ•ˆç­¾å
            'xss_attempts': 3,  # 3æ¬¡XSSå°è¯•
            'sql_injection': 2,  # 2æ¬¡SQLæ³¨å…¥å°è¯•
            'rate_limit_exceeded': 20,  # 20æ¬¡é¢‘ç‡é™åˆ¶
        }
        
    def log_security_event(self, event_type: str, event_data: Dict, severity: str = 'medium'):
        """è®°å½•å®‰å…¨äº‹ä»¶"""
        event = {
            'timestamp': datetime.now().isoformat(),
            'type': event_type,
            'data': event_data,
            'severity': severity,
            'ip_address': event_data.get('ip_address'),
            'user_agent': event_data.get('user_agent'),
        }
        
        self.security_logs.append(event)
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦è­¦æŠ¥
        if self._should_alert(event_type, event_data):
            self._trigger_alert(event)
        
        # ä¿å­˜åˆ°æ–‡ä»¶ï¼ˆç”Ÿäº§ç¯å¢ƒåº”è¯¥ä¿å­˜åˆ°æ•°æ®åº“ï¼‰
        self._save_event_to_file(event)
        
        return event
    
    def _should_alert(self, event_type: str, event_data: Dict) -> bool:
        """æ£€æŸ¥æ˜¯å¦éœ€è¦è§¦å‘è­¦æŠ¥"""
        # è·å–æœ€è¿‘ä¸€æ®µæ—¶é—´å†…åŒç±»å‹äº‹ä»¶çš„æ•°é‡
        time_window = {
            'failed_auth': timedelta(minutes=5),
            'invalid_signature': timedelta(minutes=10),
            'xss_attempts': timedelta(hours=1),
            'sql_injection': timedelta(hours=1),
            'rate_limit_exceeded': timedelta(minutes=1),
        }.get(event_type, timedelta(hours=1))
        
        cutoff_time = datetime.now() - time_window
        recent_events = [
            e for e in self.security_logs
            if e['type'] == event_type and 
            datetime.fromisoformat(e['timestamp']) > cutoff_time
        ]
        
        threshold = self.alert_thresholds.get(event_type, 10)
        return len(recent_events) >= threshold
    
    def _trigger_alert(self, event: Dict):
        """è§¦å‘å®‰å…¨è­¦æŠ¥"""
        alert = {
            'alert_id': hashlib.md5(json.dumps(event).encode()).hexdigest(),
            'timestamp': datetime.now().isoformat(),
            'event': event,
            'action_taken': self._take_mitigation_action(event),
        }
        
        self.suspicious_activities.append(alert)
        
        # å‘é€è­¦æŠ¥é€šçŸ¥
        self._send_alert_notification(alert)
        
        _logger.warning(f"å®‰å…¨è­¦æŠ¥: {event['type']} - {event['data'].get('description', '')}")
    
    def _take_mitigation_action(self, event: Dict) -> str:
        """é‡‡å–ç¼“è§£æªæ–½"""
        event_type = event['type']
        
        if event_type == 'failed_auth':
            return "ä¸´æ—¶å°é”IPåœ°å€"
        elif event_type == 'invalid_signature':
            return "è®°å½•å¹¶ç›‘æ§æ¥æº"
        elif event_type == 'xss_attempts' or event_type == 'sql_injection':
            return "æ°¸ä¹…å°é”æ¥æº"
        elif event_type == 'rate_limit_exceeded':
            return "ä¸´æ—¶é™åˆ¶è®¿é—®"
        else:
            return "è®°å½•å¹¶ç›‘æ§"
    
    def _send_alert_notification(self, alert: Dict):
        """å‘é€è­¦æŠ¥é€šçŸ¥"""
        # è¿™é‡Œå¯ä»¥é›†æˆé‚®ä»¶ã€çŸ­ä¿¡ã€Slackç­‰é€šçŸ¥æ–¹å¼
        # ç®€åŒ–ç¤ºä¾‹ï¼šåªè®°å½•æ—¥å¿—
        _logger.critical(f"SECURITY ALERT: {alert}")
    
    def _save_event_to_file(self, event: Dict):
        """ä¿å­˜äº‹ä»¶åˆ°æ–‡ä»¶"""
        try:
            filename = f"security_logs/{datetime.now().strftime('%Y%m%d')}.json"
            
            # è¯»å–ç°æœ‰æ—¥å¿—
            existing_logs = []
            try:
                with open(filename, 'r') as f:
                    existing_logs = json.load(f)
            except (FileNotFoundError, json.JSONDecodeError):
                pass
            
            # æ·»åŠ æ–°äº‹ä»¶
            existing_logs.append(event)
            
            # ä¿å­˜æ–‡ä»¶
            with open(filename, 'w') as f:
                json.dump(existing_logs, f, indent=2, ensure_ascii=False)
                
        except Exception as e:
            _logger.error(f"ä¿å­˜å®‰å…¨æ—¥å¿—å¤±è´¥: {str(e)}")
    
    def analyze_security_logs(self, start_date: datetime, end_date: datetime) -> Dict:
        """åˆ†æå®‰å…¨æ—¥å¿—"""
        filtered_logs = [
            log for log in self.security_logs
            if start_date <= datetime.fromisoformat(log['timestamp']) <= end_date
        ]
        
        analysis = {
            'total_events': len(filtered_logs),
            'events_by_type': {},
            'events_by_severity': {},
            'top_offenders': [],
            'timeline': [],
        }
        
        # æŒ‰ç±»å‹ç»Ÿè®¡
        for log in filtered_logs:
            event_type = log['type']
            analysis['events_by_type'][event_type] = analysis['events_by_type'].get(event_type, 0) + 1
        
        # æŒ‰ä¸¥é‡ç¨‹åº¦ç»Ÿè®¡
        for log in filtered_logs:
            severity = log['severity']
            analysis['events_by_severity'][severity] = analysis['events_by_severity'].get(severity, 0) + 1
        
        # æŸ¥æ‰¾æœ€æ´»è·ƒçš„æ”»å‡»æº
        ip_counts = {}
        for log in filtered_logs:
            ip = log.get('data', {}).get('ip_address')
            if ip:
                ip_counts[ip] = ip_counts.get(ip, 0) + 1
        
        analysis['top_offenders'] = sorted(ip_counts.items(), key=lambda x: x[1], reverse=True)[:10]
        
        # åˆ›å»ºæ—¶é—´çº¿æ•°æ®
        from collections import defaultdict
        timeline_data = defaultdict(int)
        
        for log in filtered_logs:
            timestamp = datetime.fromisoformat(log['timestamp'])
            hour_key = timestamp.strftime('%Y-%m-%d %H:00')
            timeline_data[hour_key] += 1
        
        analysis['timeline'] = sorted(timeline_data.items())
        
        return analysis
    
    def detect_anomalous_patterns(self) -> List[Dict]:
        """æ£€æµ‹å¼‚å¸¸æ¨¡å¼"""
        anomalies = []
        
        # æ£€æµ‹æš´åŠ›ç ´è§£å°è¯•
        auth_failures = [
            log for log in self.security_logs[-100:]  # æœ€è¿‘100æ¡æ—¥å¿—
            if log['type'] == 'failed_auth'
        ]
        
        if len(auth_failures) > 10:
            anomalies.append({
                'type': 'brute_force_attempt',
                'description': f'æ£€æµ‹åˆ° {len(auth_failures)} æ¬¡è®¤è¯å¤±è´¥å°è¯•',
                'severity': 'high',
                'timestamp': datetime.now().isoformat(),
            })
        
        # æ£€æµ‹æ‰«æè¡Œä¸º
        invalid_signatures = [
            log for log in self.security_logs[-1000:]
            if log['type'] == 'invalid_signature'
        ]
        
        if len(invalid_signatures) > 50:
            anomalies.append({
                'type': 'scanning_activity',
                'description': f'æ£€æµ‹åˆ° {len(invalid_signatures)} æ¬¡æ— æ•ˆç­¾åå°è¯•',
                'severity': 'medium',
                'timestamp': datetime.now().isoformat(),
            })
        
        # æ£€æµ‹æ³¨å…¥æ”»å‡»
        injection_attempts = [
            log for log in self.security_logs[-500:]
            if log['type'] in ['xss_attempts', 'sql_injection']
        ]
        
        if injection_attempts:
            anomalies.append({
                'type': 'injection_attack',
                'description': f'æ£€æµ‹åˆ° {len(injection_attempts)} æ¬¡æ³¨å…¥æ”»å‡»å°è¯•',
                'severity': 'critical',
                'timestamp': datetime.now().isoformat(),
            })
        
        return anomalies
    
    def generate_security_report(self, days: int = 7) -> Dict:
        """ç”Ÿæˆå®‰å…¨æŠ¥å‘Š"""
        end_date = datetime.now()
        start_date = end_date - timedelta(days=days)
        
        analysis = self.analyze_security_logs(start_date, end_date)
        anomalies = self.detect_anomalous_patterns()
        
        report = {
            'period': {
                'start': start_date.isoformat(),
                'end': end_date.isoformat(),
                'days': days,
            },
            'summary': {
                'total_events': analysis['total_events'],
                'alerts_triggered': len(self.suspicious_activities),
                'anomalies_detected': len(anomalies),
                'risk_level': self._calculate_risk_level(analysis, anomalies),
            },
            'detailed_analysis': analysis,
            'anomalies': anomalies,
            'recommendations': self._generate_recommendations(analysis, anomalies),
        }
        
        return report
    
    def _calculate_risk_level(self, analysis: Dict, anomalies: List[Dict]) -> str:
        """è®¡ç®—é£é™©ç­‰çº§"""
        total_events = analysis['total_events']
        critical_anomalies = len([a for a in anomalies if a['severity'] == 'critical'])
        
        if critical_anomalies > 0:
            return 'critical'
        elif total_events > 1000:
            return 'high'
        elif total_events > 100:
            return 'medium'
        else:
            return 'low'
    
    def _generate_recommendations(self, analysis: Dict, anomalies: List[Dict]) -> List[str]:
        """ç”Ÿæˆå®‰å…¨å»ºè®®"""
        recommendations = []
        
        # åŸºäºäº‹ä»¶ç±»å‹çš„å»ºè®®
        if analysis['events_by_type'].get('failed_auth', 0) > 100:
            recommendations.append("å®æ–½å¤šå› ç´ è®¤è¯")
            recommendations.append("å¢åŠ ç™»å½•å¤±è´¥é”å®šæœºåˆ¶")
        
        if analysis['events_by_type'].get('invalid_signature', 0) > 50:
            recommendations.append("åŠ å¼ºç­¾åéªŒè¯æœºåˆ¶")
            recommendations.append("å®æ–½IPç™½åå•")
        
        if any(a['type'] == 'injection_attack' for a in anomalies):
            recommendations.append("æ›´æ–°Webåº”ç”¨é˜²ç«å¢™è§„åˆ™")
            recommendations.append("åŠ å¼ºè¾“å…¥éªŒè¯")
        
        # é€šç”¨å»ºè®®
        recommendations.extend([
            "å®šæœŸæ›´æ–°å®‰å…¨è¡¥ä¸",
            "è¿›è¡Œå®‰å…¨å®¡è®¡",
            "å®æ–½å®‰å…¨ç›‘æ§",
            "å¤‡ä»½é‡è¦æ•°æ®",
        ])
        
        return recommendations


class MessageIntegrityChecker:
    """æ¶ˆæ¯å®Œæ•´æ€§æ£€æŸ¥å™¨"""
    
    def __init__(self, secret_key: str):
        self.secret_key = secret_key.encode('utf-8')
    
    def generate_hmac_signature(self, message: str) -> str:
        """ç”ŸæˆHMACç­¾å"""
        hmac_obj = hmac.new(self.secret_key, message.encode('utf-8'), hashlib.sha256)
        return base64.b64encode(hmac_obj.digest()).decode('utf-8')
    
    def verify_message_integrity(self, message: str, signature: str) -> bool:
        """éªŒè¯æ¶ˆæ¯å®Œæ•´æ€§"""
        expected_signature = self.generate_hmac_signature(message)
        return hmac.compare_digest(expected_signature, signature)
    
    def check_message_tampering(self, original_message: Dict, received_message: Dict) -> Dict:
        """æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦è¢«ç¯¡æ”¹"""
        issues = []
        
        # æ£€æŸ¥å…³é”®å­—æ®µæ˜¯å¦ä¸€è‡´
        critical_fields = ['msg_id', 'from_user_name', 'create_time', 'msg_type']
        
        for field in critical_fields:
            original = original_message.get(field)
            received = received_message.get(field)
            
            if original != received:
                issues.append({
                    'field': field,
                    'original': original,
                    'received': received,
                    'issue': 'ä¸ä¸€è‡´',
                })
        
        # æ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦åˆç†
        if 'create_time' in original_message and 'create_time' in received_message:
            original_time = original_message['create_time']
            received_time = received_message['create_time']
            
            # å…è®¸1åˆ†é’Ÿçš„æ—¶é—´å·®
            time_diff = abs((received_time - original_time).total_seconds())
            if time_diff > 60:
                issues.append({
                    'field': 'create_time',
                    'original': original_time,
                    'received': received_time,
                    'issue': f'æ—¶é—´å·®è¿‡å¤§: {time_diff}ç§’',
                })
        
        return {
            'is_tampered': len(issues) > 0,
            'issues': issues,
            'timestamp': datetime.now().isoformat(),
        }
```

---

## ğŸ“Š ç¬¬12-13å‘¨è¿›åº¦è·Ÿè¸ª

### **æ¯æ—¥ç«™ä¼šé‡ç‚¹**ï¼š
```
ç¬¬12å‘¨é‡ç‚¹ï¼š
å‘¨ä¸€ï¼šç²‰ä¸æ•°æ®æ¨¡å‹è®¾è®¡å’ŒåŒæ­¥æœºåˆ¶
å‘¨äºŒï¼šå¾®ä¿¡æ¶ˆæ¯æ¥æ”¶å’Œå­˜å‚¨è®¾è®¡
å‘¨ä¸‰ï¼šæ¶ˆæ¯è‡ªåŠ¨å¤„ç†å’Œå›å¤å¼•æ“
å‘¨å››ï¼šå‰ç«¯ç²‰ä¸ç®¡ç†ç•Œé¢å¼€å‘
å‘¨äº”ï¼šç¬¬ä¸€å‘¨æˆæœæ¼”ç¤ºå’Œé—®é¢˜ä¿®å¤

ç¬¬13å‘¨é‡ç‚¹ï¼š
å‘¨ä¸€ï¼šå‰ç«¯æ¶ˆæ¯ç®¡ç†ç•Œé¢å¼€å‘
å‘¨äºŒï¼šç”¨æˆ·è¡Œä¸ºåˆ†æå’Œç»Ÿè®¡åŠŸèƒ½
å‘¨ä¸‰ï¼šå®‰å…¨æµ‹è¯•å’Œç›‘æ§å®ç°
å‘¨å››ï¼šæ€§èƒ½ä¼˜åŒ–å’Œå‹åŠ›æµ‹è¯•
å‘¨äº”ï¼šç¬¬äºŒé˜¶æ®µæˆæœæ¼”ç¤ºå’Œé›†æˆæµ‹è¯•
```

### **å…³é”®äº¤ä»˜ç‰©æ£€æŸ¥ç‚¹ï¼ˆç¬¬13å‘¨æœ«ï¼‰**ï¼š

#### **åç«¯å¼€å‘äº¤ä»˜ç‰©**ï¼š
- [ ] `wechat_platform`æ¨¡å—æ ¸å¿ƒåŠŸèƒ½
- [ ] ç²‰ä¸ç®¡ç†å®Œæ•´æ¨¡å‹å’ŒåŒæ­¥æœºåˆ¶
- [ ] å¾®ä¿¡æ¶ˆæ¯å®Œæ•´å¤„ç†æµç¨‹
- [ ] è‡ªåŠ¨å›å¤è§„åˆ™å¼•æ“
- [ ] ä¸CRMæ¨¡å—æ·±åº¦é›†æˆ

#### **å‰ç«¯å¼€å‘äº¤ä»˜ç‰©**ï¼š
- [ ] ç²‰ä¸ç®¡ç†ç•Œé¢ï¼ˆåˆ—è¡¨ã€è¯¦æƒ…ã€æ“ä½œï¼‰
- [ ] æ¶ˆæ¯ç®¡ç†ç•Œé¢ï¼ˆå®æ—¶æ˜¾ç¤ºã€å›å¤ã€æœç´¢ï¼‰
- [ ] ç”¨æˆ·è¡Œä¸ºç»Ÿè®¡ä»ªè¡¨æ¿
- [ ] å“åº”å¼è®¾è®¡å’Œç”¨æˆ·ä½“éªŒä¼˜åŒ–

#### **å¾®ä¿¡å¼€å‘ä¸“å®¶äº¤ä»˜ç‰©**ï¼š
- [ ] ç²‰ä¸åŒæ­¥æœºåˆ¶ï¼ˆå¢é‡/å…¨é‡/å¹¶å‘ï¼‰
- [ ] æ¶ˆæ¯é˜Ÿåˆ—å’Œå¼‚æ­¥å¤„ç†ç³»ç»Ÿ
- [ ] é¢‘ç‡é™åˆ¶å’Œæµé‡æ§åˆ¶
- [ ] ç”¨æˆ·è¡Œä¸ºåˆ†æç®—æ³•

#### **å®‰å…¨å®¡æŸ¥ä¸“å®¶äº¤ä»˜ç‰©**ï¼š
- [ ] æ¶ˆæ¯å®‰å…¨æµ‹è¯•ç”¨ä¾‹
- [ ] å®‰å…¨ç›‘æ§å’Œå®¡è®¡ç³»ç»Ÿ
- [ ] æ¸—é€æµ‹è¯•æŠ¥å‘Š
- [ ] æ€§èƒ½å‹åŠ›æµ‹è¯•ç»“æœ

---

## ğŸ”§ å¼€å‘ç¯å¢ƒé…ç½®æ›´æ–°

### **å¾®ä¿¡å…¬ä¼—å·æµ‹è¯•ç¯å¢ƒ**ï¼š
```yaml
# å¾®ä¿¡æµ‹è¯•å·é…ç½®
æµ‹è¯•å·AppID: ä»å¾®ä¿¡å…¬ä¼—å¹³å°è·å–
æµ‹è¯•å·AppSecret: ä»å¾®ä¿¡å…¬ä¼—å¹³å°è·å–
æµ‹è¯•å·Token: è‡ªè¡Œè®¾ç½®ï¼ˆä¸Odooé…ç½®ä¸€è‡´ï¼‰
æµ‹è¯•å·EncodingAESKey: è‡ªè¡Œè®¾ç½®

# æµ‹è¯•å·¥å…·é…ç½®
ngrok: ç”¨äºæœ¬åœ°è°ƒè¯•çš„ç©¿é€å·¥å…·
å¾®ä¿¡å¼€å‘è€…å·¥å…·: ç”¨äºæ¥å£è°ƒè¯•
Postman: APIæµ‹è¯•é›†åˆ

# æµ‹è¯•æ•°æ®é‡
æµ‹è¯•ç²‰ä¸æ•°: 100-1000ä¸ª
æµ‹è¯•æ¶ˆæ¯é‡: 5000-10000æ¡
æµ‹è¯•å¹¶å‘æ•°: 10-50å¹¶å‘
```

### **è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬**ï¼š
```bash
# è¿è¡Œå®‰å…¨æµ‹è¯•
python scripts/run_security_tests.py --module wechat_platform

# è¿è¡Œæ€§èƒ½æµ‹è¯•
python scripts/run_performance_tests.py --users 100 --messages 1000

# ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
python scripts/generate_test_report.py --output reports/test_summary.html
```

---

## ğŸš¨ ç¬¬ä¸‰é˜¶æ®µé£é™©ç®¡ç†

### **æ–°å¢é£é™©**ï¼š
| é£é™© | å½±å“ | æ¦‚ç‡ | åº”å¯¹æªæ–½ | è´Ÿè´£äºº |
|------|------|------|----------|--------|
| å¾®ä¿¡APIé¢‘ç‡é™åˆ¶ | é«˜ | ä¸­ | 1. å®ç°è¯·æ±‚é˜Ÿåˆ— 2. ç¼“å­˜æœºåˆ¶ 3. ç›‘æ§å‘Šè­¦ | å¾®ä¿¡ä¸“å®¶ |
| æ¶ˆæ¯å¤„ç†æ€§èƒ½ | ä¸­ | ä¸­ | 1. å¼‚æ­¥å¤„ç† 2. è´Ÿè½½å‡è¡¡ 3. æ€§èƒ½æµ‹è¯• | åç«¯å¼€å‘ |
| æ•°æ®éšç§åˆè§„ | é«˜ | ä½ | 1. æ•°æ®è„±æ• 2. è®¿é—®æ§åˆ¶ 3. å®¡è®¡æ—¥å¿— | å®‰å…¨ä¸“å®¶ |

### **æŠ€æœ¯éš¾ç‚¹**ï¼š
1. **å®æ—¶æ¶ˆæ¯å¤„ç†**ï¼šé«˜å¹¶å‘ä¸‹çš„æ¶ˆæ¯æ¥æ”¶å’Œå¤„ç†
2. **ç²‰ä¸æ•°æ®åŒæ­¥**ï¼šç™¾ä¸‡çº§ç²‰ä¸çš„å¢é‡åŒæ­¥ç­–ç•¥
3. **ç”¨æˆ·è¡Œä¸ºåˆ†æ**ï¼šå®æ—¶ç»Ÿè®¡å’Œé¢„æµ‹ç®—æ³•

---

## ğŸ“ˆ è´¨é‡æŒ‡æ ‡ï¼ˆç¬¬13å‘¨æœ«ï¼‰

### **åŠŸèƒ½æŒ‡æ ‡**ï¼š
1. ç²‰ä¸åŒæ­¥æˆåŠŸç‡ > 99%
2. æ¶ˆæ¯å¤„ç†å»¶è¿Ÿ < 5ç§’
3. è‡ªåŠ¨å›å¤å‡†ç¡®ç‡ > 90%
4. CRMé›†æˆå®Œæ•´åº¦ 100%

### **æ€§èƒ½æŒ‡æ ‡**ï¼š
1. æ”¯æŒç²‰ä¸æ•° > 10ä¸‡
2. æ¶ˆæ¯å¤„ç†èƒ½åŠ› > 1000æ¡/ç§’
3. APIå“åº”æ—¶é—´ < 500ms
4. å†…å­˜å ç”¨ < 500MB

### **å®‰å…¨æŒ‡æ ‡**ï¼š
1. é€šè¿‡æ‰€æœ‰å®‰å…¨æµ‹è¯•
2. æ•°æ®åŠ å¯†å­˜å‚¨ç‡ 100%
3. è®¿é—®æ§åˆ¶å®Œæ•´åº¦ 100%
4. å®¡è®¡æ—¥å¿—è¦†ç›–ç‡ 100%

---

## ğŸ¯ ç¬¬12-13å‘¨æˆåŠŸæ ‡å‡†

1. **æ ¸å¿ƒåŠŸèƒ½å®Œæˆ**ï¼šç²‰ä¸ç®¡ç†å’Œæ¶ˆæ¯å¤„ç†å…¨æµç¨‹è·‘é€š
2. **ç”¨æˆ·ä½“éªŒè‰¯å¥½**ï¼šç•Œé¢å‹å¥½ï¼Œæ“ä½œæµç•…
3. **å®‰å…¨å¯é **ï¼šé€šè¿‡å®‰å…¨å®¡è®¡ï¼Œæ— é‡å¤§æ¼æ´
4. **æ€§èƒ½è¾¾æ ‡**ï¼šæ»¡è¶³æ‰€æœ‰æ€§èƒ½æŒ‡æ ‡
5. **é›†æˆå®Œå–„**ï¼šä¸Odoo CRMæ·±åº¦é›†æˆ

---

**ç¬¬ä¸‰é˜¶æ®µç¬¬12-13å‘¨å·¥ä½œæ­£å¼å¯åŠ¨ï¼** è¿™æ˜¯å¾®ä¿¡å…¬ä¼—å·ç®¡ç†å¹³å°çš„æ ¸å¿ƒå¼€å‘é˜¶æ®µï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œç”¨æˆ·ä½“éªŒã€‚

**æœ¬å‘¨é‡ç‚¹æé†’**ï¼š
1. ç²‰ä¸åŒæ­¥è¦è€ƒè™‘å¤§æ•°æ®é‡çš„å¤„ç†ç­–ç•¥
2. æ¶ˆæ¯å¤„ç†è¦å®ç°å®æ—¶æ€§å’Œå¯é æ€§çš„å¹³è¡¡
3. å®‰å…¨é˜²æŠ¤è¦è¦†ç›–æ‰€æœ‰å¯èƒ½çš„æ”»å‡»å‘é‡
4. ç”¨æˆ·ä½“éªŒè¦ç®€æ´ç›´è§‚ï¼Œé™ä½ä½¿ç”¨é—¨æ§›

**ä»Šæ—¥é‡ç‚¹å·¥ä½œ**ï¼š
1. åç«¯å¼€å‘ï¼šè®¾è®¡ç²‰ä¸æ•°æ®æ¨¡å‹å’ŒåŒæ­¥æœºåˆ¶
2. å‰ç«¯å¼€å‘ï¼šåˆ›å»ºç²‰ä¸ç®¡ç†ç•Œé¢æ¡†æ¶
3. å¾®ä¿¡å¼€å‘ä¸“å®¶ï¼šè®¾è®¡æ¶ˆæ¯é˜Ÿåˆ—æ¶æ„
4. å®‰å…¨å®¡æŸ¥ä¸“å®¶ï¼šåˆ¶å®šæ¶ˆæ¯å®‰å…¨æµ‹è¯•æ–¹æ¡ˆ

**ä»Šæ—¥ç«™ä¼šæ—¶é—´**ï¼šä¸‹åˆ4:00ï¼Œè®¨è®ºç²‰ä¸ç®¡ç†å’Œæ¶ˆæ¯å¤„ç†æ¶æ„è®¾è®¡ã€‚å¾®ä¿¡å¼€å‘ä¸“å®¶è¯·å‡†å¤‡å¾®ä¿¡APIé¢‘ç‡é™åˆ¶çš„å¤„ç†ç­–ç•¥ã€‚

# ğŸš€ ç¬¬ä¸‰é˜¶æ®µï¼šå¾®ä¿¡å…¬ä¼—å·ç®¡ç†å¹³å°ç»§ç»­æ¨è¿›ï¼ˆç¬¬14-15å‘¨ï¼‰

## ğŸ“‹ æœ¬å‘¨æ ¸å¿ƒç›®æ ‡

**æœ¬å‘¨é‡ç‚¹**ï¼šå®Œå–„è‡ªåŠ¨å›å¤ç³»ç»Ÿï¼Œå®ç°ç´ æç®¡ç†ä¸èœå•ç®¡ç†
**æŠ€æœ¯è¦ç‚¹**ï¼š
1. å®Œå–„å…³é”®è¯è‡ªåŠ¨å›å¤è§„åˆ™å¼•æ“
2. å®ç°å¾®ä¿¡å…¬ä¼—å·ç´ æç®¡ç†ï¼ˆå›¾ç‰‡ã€è¯­éŸ³ã€è§†é¢‘ã€å›¾æ–‡ï¼‰
3. åˆ›å»ºè‡ªå®šä¹‰èœå•ç®¡ç†ç³»ç»Ÿ
4. å®ç°é«˜çº§ç»Ÿè®¡åˆ†æåŠŸèƒ½
5. ä¼˜åŒ–CRMé›†æˆï¼Œå®ç°æ™ºèƒ½çº¿ç´¢è½¬åŒ–
**æ—¶é—´**ï¼šç¬¬14-15å‘¨ï¼ˆå…±2å‘¨ï¼‰

---

## ğŸ“… ç¬¬14å‘¨ï¼šè‡ªåŠ¨å›å¤ç³»ç»Ÿä¸ç´ æç®¡ç†

### **Pythonä¸“å®¶è°ƒåº¦æŒ‡ä»¤ï¼š**
```
æœ¬å‘¨é‡ç‚¹ï¼šå®Œå–„è‡ªåŠ¨å›å¤è§„åˆ™å¼•æ“ï¼Œå®ç°å®Œæ•´çš„ç´ æç®¡ç†ç³»ç»Ÿ
å¼€å‘é¡ºåºï¼šè‡ªåŠ¨å›å¤è§„åˆ™æ¨¡å‹ â†’ å…³é”®è¯åŒ¹é…ç®—æ³• â†’ ç´ ææ¨¡å‹è®¾è®¡ â†’ ç´ æä¸Šä¼ /ä¸‹è½½ â†’ å‰ç«¯ç•Œé¢

æ³¨æ„ç‚¹ï¼š
1. å…³é”®è¯åŒ¹é…è¦æ”¯æŒæ¨¡ç³ŠåŒ¹é…ã€ç²¾ç¡®åŒ¹é…ã€æ­£åˆ™è¡¨è¾¾å¼
2. ç´ æç®¡ç†è¦è€ƒè™‘å¾®ä¿¡çš„ç´ æé™åˆ¶ï¼ˆå›¾ç‰‡2Mï¼Œè¯­éŸ³2Mï¼Œè§†é¢‘10Mï¼Œå›¾æ–‡2Mï¼‰
3. ç´ æéœ€è¦å®šæ—¶æ¸…ç†ï¼Œé¿å…è¶…è¿‡å¾®ä¿¡é™åˆ¶
4. è‡ªåŠ¨å›å¤è¦æ”¯æŒå¤šç§æ¶ˆæ¯ç±»å‹ï¼ˆæ–‡æœ¬ã€å›¾ç‰‡ã€å›¾æ–‡ç­‰ï¼‰
```

### **åç«¯å¼€å‘å…·ä½“ä»»åŠ¡ï¼š**

#### **ä»»åŠ¡1ï¼šå®Œå–„è‡ªåŠ¨å›å¤è§„åˆ™æ¨¡å‹**
```python
# file: wechat_platform/models/wechat_auto_reply.py

from odoo import models, fields, api, _
from odoo.exceptions import ValidationError, UserError
import logging
import re
from datetime import datetime, timedelta
import json

_logger = logging.getLogger(__name__)

class WechatAutoReply(models.Model):
    """å¾®ä¿¡è‡ªåŠ¨å›å¤è§„åˆ™"""
    _name = 'wechat.auto_reply'
    _description = 'å¾®ä¿¡è‡ªåŠ¨å›å¤è§„åˆ™'
    _order = 'sequence, id'
    
    name = fields.Char(string='è§„åˆ™åç§°', required=True)
    account_id = fields.Many2one('wechat.account', string='æ‰€å±å…¬ä¼—å·', required=True)
    active = fields.Boolean(string='å¯ç”¨', default=True)
    
    # è§„åˆ™ç±»å‹
    rule_type = fields.Selection([
        ('subscribe', 'å…³æ³¨æ—¶å›å¤'),
        ('default', 'é»˜è®¤å›å¤'),
        ('keyword', 'å…³é”®è¯å›å¤'),
        ('menu_click', 'èœå•ç‚¹å‡»å›å¤'),
    ], string='è§„åˆ™ç±»å‹', required=True, default='keyword')
    
    # è§¦å‘æ¡ä»¶
    match_type = fields.Selection([
        ('exact', 'ç²¾ç¡®åŒ¹é…'),
        ('fuzzy', 'æ¨¡ç³ŠåŒ¹é…'),
        ('regex', 'æ­£åˆ™è¡¨è¾¾å¼'),
        ('prefix', 'å‰ç¼€åŒ¹é…'),
        ('suffix', 'åç¼€åŒ¹é…'),
    ], string='åŒ¹é…æ–¹å¼', default='fuzzy',
    help="æ¨¡ç³ŠåŒ¹é…: åŒ…å«å…³é”®è¯å³å¯\nç²¾ç¡®åŒ¹é…: å®Œå…¨ç­‰äºå…³é”®è¯\næ­£åˆ™è¡¨è¾¾å¼: ä½¿ç”¨æ­£åˆ™åŒ¹é…\nå‰ç¼€åŒ¹é…: ä»¥å…³é”®è¯å¼€å¤´\nåç¼€åŒ¹é…: ä»¥å…³é”®è¯ç»“å°¾")
    
    keyword = fields.Char(string='å…³é”®è¯', 
                         help='å¤šä¸ªå…³é”®è¯ç”¨é€—å·åˆ†éš”')
    keywords_list = fields.Char(string='å…³é”®è¯åˆ—è¡¨', compute='_compute_keywords_list', store=True)
    
    # å›å¤å†…å®¹
    reply_type = fields.Selection([
        ('text', 'æ–‡æœ¬'),
        ('image', 'å›¾ç‰‡'),
        ('voice', 'è¯­éŸ³'),
        ('video', 'è§†é¢‘'),
        ('news', 'å›¾æ–‡'),
        ('article', 'å•ç¯‡å›¾æ–‡'),
    ], string='å›å¤ç±»å‹', default='text')
    
    reply_content = fields.Text(string='æ–‡æœ¬å›å¤å†…å®¹',
                               help='æ–‡æœ¬å›å¤å†…å®¹ï¼Œæ”¯æŒæ¢è¡Œå’Œè¡¨æƒ…')
    
    # åª’ä½“å›å¤
    media_id = fields.Char(string='åª’ä½“ID', 
                          help='ä»å¾®ä¿¡ç´ æåº“è·å–çš„media_id')
    media_material_id = fields.Many2one('wechat.material', string='å…³è”ç´ æ')
    
    # å›¾æ–‡å›å¤
    news_material_id = fields.Many2one('wechat.material', string='å…³è”å›¾æ–‡ç´ æ',
                                      domain="[('material_type', '=', 'news')]")
    
    # é«˜çº§è®¾ç½®
    sequence = fields.Integer(string='ä¼˜å…ˆçº§', default=10,
                             help='æ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜')
    match_all_keywords = fields.Boolean(string='åŒ¹é…å…¨éƒ¨å…³é”®è¯', default=False,
                                       help='å¼€å¯åéœ€è¦åŒ¹é…æ‰€æœ‰å…³é”®è¯æ‰å›å¤')
    case_sensitive = fields.Boolean(string='åŒºåˆ†å¤§å°å†™', default=False)
    
    # ç»Ÿè®¡ä¿¡æ¯
    trigger_count = fields.Integer(string='è§¦å‘æ¬¡æ•°', default=0, readonly=True)
    last_trigger_time = fields.Datetime(string='æœ€åè§¦å‘æ—¶é—´', readonly=True)
    
    # æ—¶é—´é™åˆ¶
    enable_time_limit = fields.Boolean(string='å¯ç”¨æ—¶é—´é™åˆ¶', default=False)
    start_time = fields.Datetime(string='å¼€å§‹æ—¶é—´')
    end_time = fields.Datetime(string='ç»“æŸæ—¶é—´')
    
    # åˆ†ç»„/æ ‡ç­¾é™åˆ¶
    enable_tag_filter = fields.Boolean(string='å¯ç”¨æ ‡ç­¾è¿‡æ»¤', default=False)
    tag_ids = fields.Many2many('wechat.user.tag', string='æ ‡ç­¾é™åˆ¶',
                              help='åªæœ‰æ‹¥æœ‰è¿™äº›æ ‡ç­¾çš„ç”¨æˆ·æ‰ä¼šè§¦å‘å›å¤')
    
    # çŠ¶æ€æ ‡è®°
    is_valid = fields.Boolean(string='è§„åˆ™æœ‰æ•ˆ', compute='_compute_is_valid', store=True)
    
    @api.depends('keyword')
    def _compute_keywords_list(self):
        """è®¡ç®—å…³é”®è¯åˆ—è¡¨"""
        for rule in self:
            if rule.keyword:
                # åˆ†å‰²å…³é”®è¯ï¼Œå»é™¤ç©ºç™½å­—ç¬¦
                keywords = [k.strip() for k in rule.keyword.split(',') if k.strip()]
                rule.keywords_list = json.dumps(keywords, ensure_ascii=False)
            else:
                rule.keywords_list = '[]'
    
    @api.depends('active', 'enable_time_limit', 'start_time', 'end_time')
    def _compute_is_valid(self):
        """è®¡ç®—è§„åˆ™æ˜¯å¦æœ‰æ•ˆ"""
        now = fields.Datetime.now()
        for rule in self:
            if not rule.active:
                rule.is_valid = False
                continue
            
            if rule.enable_time_limit:
                if rule.start_time and rule.end_time:
                    rule.is_valid = rule.start_time <= now <= rule.end_time
                elif rule.start_time:
                    rule.is_valid = now >= rule.start_time
                elif rule.end_time:
                    rule.is_valid = now <= rule.end_time
                else:
                    rule.is_valid = True
            else:
                rule.is_valid = True
    
    @api.constrains('keyword')
    def _check_keyword(self):
        """æ£€æŸ¥å…³é”®è¯"""
        for rule in self:
            if rule.rule_type == 'keyword' and not rule.keyword:
                raise ValidationError(_('å…³é”®è¯å›å¤è§„åˆ™å¿…é¡»è®¾ç½®å…³é”®è¯'))
    
    @api.constrains('match_type', 'keyword')
    def _check_regex_keyword(self):
        """æ£€æŸ¥æ­£åˆ™è¡¨è¾¾å¼å…³é”®è¯"""
        for rule in self:
            if rule.match_type == 'regex' and rule.keyword:
                try:
                    re.compile(rule.keyword)
                except re.error as e:
                    raise ValidationError(_('æ­£åˆ™è¡¨è¾¾å¼æ ¼å¼é”™è¯¯: %s') % str(e))
    
    def match(self, content, user_tags=None):
        """åŒ¹é…è§„åˆ™"""
        self.ensure_one()
        
        if not self.is_valid:
            return False
        
        # æ£€æŸ¥æ ‡ç­¾è¿‡æ»¤
        if self.enable_tag_filter and self.tag_ids and user_tags:
            # ç”¨æˆ·éœ€è¦æ‹¥æœ‰æ‰€æœ‰æŒ‡å®šçš„æ ‡ç­¾
            required_tag_ids = set(self.tag_ids.ids)
            user_tag_ids = set(user_tags)
            if not required_tag_ids.issubset(user_tag_ids):
                return False
        
        # æ ¹æ®åŒ¹é…ç±»å‹è¿›è¡ŒåŒ¹é…
        if self.match_type == 'exact':
            return self._match_exact(content)
        elif self.match_type == 'fuzzy':
            return self._match_fuzzy(content)
        elif self.match_type == 'regex':
            return self._match_regex(content)
        elif self.match_type == 'prefix':
            return self._match_prefix(content)
        elif self.match_type == 'suffix':
            return self._match_suffix(content)
        
        return False
    
    def _match_exact(self, content):
        """ç²¾ç¡®åŒ¹é…"""
        if not self.keyword:
            return False
        
        keywords = self._get_keywords()
        if self.match_all_keywords:
            # éœ€è¦åŒ¹é…æ‰€æœ‰å…³é”®è¯
            return all(k in content for k in keywords)
        else:
            # åŒ¹é…ä»»æ„ä¸€ä¸ªå…³é”®è¯
            return any(k in content for k in keywords)
    
    def _match_fuzzy(self, content):
        """æ¨¡ç³ŠåŒ¹é…"""
        if not self.keyword:
            return False
        
        content_lower = content.lower() if not self.case_sensitive else content
        keywords = self._get_keywords()
        
        for keyword in keywords:
            keyword_lower = keyword.lower() if not self.case_sensitive else keyword
            if keyword_lower in content_lower:
                return True
        return False
    
    def _match_regex(self, content):
        """æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…"""
        if not self.keyword:
            return False
        
        try:
            pattern = re.compile(self.keyword, re.IGNORECASE if not self.case_sensitive else 0)
            return bool(pattern.search(content))
        except re.error:
            return False
    
    def _match_prefix(self, content):
        """å‰ç¼€åŒ¹é…"""
        if not self.keyword:
            return False
        
        keywords = self._get_keywords()
        content_lower = content.lower() if not self.case_sensitive else content
        
        for keyword in keywords:
            keyword_lower = keyword.lower() if not self.case_sensitive else keyword
            if content_lower.startswith(keyword_lower):
                return True
        return False
    
    def _match_suffix(self, content):
        """åç¼€åŒ¹é…"""
        if not self.keyword:
            return False
        
        keywords = self._get_keywords()
        content_lower = content.lower() if not self.case_sensitive else content
        
        for keyword in keywords:
            keyword_lower = keyword.lower() if not self.case_sensitive else keyword
            if content_lower.endswith(keyword_lower):
                return True
        return False
    
    def _get_keywords(self):
        """è·å–å…³é”®è¯åˆ—è¡¨"""
        if not self.keyword:
            return []
        
        keywords = [k.strip() for k in self.keyword.split(',') if k.strip()]
        
        if not self.case_sensitive:
            keywords = [k.lower() for k in keywords]
        
        return keywords
    
    def get_reply_content(self):
        """è·å–å›å¤å†…å®¹"""
        self.ensure_one()
        
        reply_data = {
            'msg_type': self.reply_type,
            'content': None,
        }
        
        if self.reply_type == 'text':
            reply_data['content'] = self.reply_content
        
        elif self.reply_type in ['image', 'voice', 'video']:
            if self.media_material_id and self.media_material_id.media_id:
                reply_data['media_id'] = self.media_material_id.media_id
            elif self.media_id:
                reply_data['media_id'] = self.media_id
        
        elif self.reply_type == 'news':
            if self.news_material_id:
                # è¿”å›å›¾æ–‡ç´ ææ•°æ®
                reply_data['news_data'] = self.news_material_id.get_news_data()
        
        return reply_data
    
    def record_trigger(self):
        """è®°å½•è§¦å‘"""
        self.ensure_one()
        self.write({
            'trigger_count': self.trigger_count + 1,
            'last_trigger_time': fields.Datetime.now(),
        })
    
    def test_match(self, test_content, user_tags=None):
        """æµ‹è¯•åŒ¹é…è§„åˆ™"""
        self.ensure_one()
        
        result = {
            'matched': self.match(test_content, user_tags),
            'rule_name': self.name,
            'rule_type': self.rule_type,
            'match_type': self.match_type,
            'keyword': self.keyword,
            'is_valid': self.is_valid,
        }
        
        if result['matched']:
            reply_content = self.get_reply_content()
            result['reply_type'] = reply_content.get('msg_type')
            result['reply_content'] = reply_content.get('content', '')
        
        return result
    
    @api.model
    def find_matching_rule(self, account_id, content, user_tags=None, rule_type='keyword'):
        """æŸ¥æ‰¾åŒ¹é…çš„è§„åˆ™"""
        rules = self.search([
            ('account_id', '=', account_id),
            ('active', '=', True),
            ('rule_type', '=', rule_type),
            ('is_valid', '=', True),
        ], order='sequence, id')
        
        for rule in rules:
            if rule.match(content, user_tags):
                rule.record_trigger()
                return rule
        
        return False
    
    def action_preview_reply(self):
        """é¢„è§ˆå›å¤å†…å®¹"""
        self.ensure_one()
        
        return {
            'type': 'ir.actions.act_window',
            'name': f'é¢„è§ˆå›å¤: {self.name}',
            'res_model': 'wechat.auto_reply.preview',
            'view_mode': 'form',
            'target': 'new',
            'context': {
                'default_rule_id': self.id,
                'default_content': self.reply_content or '',
                'default_reply_type': self.reply_type,
            },
        }
    
    def action_test_rule(self):
        """æµ‹è¯•è§„åˆ™"""
        self.ensure_one()
        
        return {
            'type': 'ir.actions.act_window',
            'name': f'æµ‹è¯•è§„åˆ™: {self.name}',
            'res_model': 'wechat.auto_reply.test',
            'view_mode': 'form',
            'target': 'new',
            'context': {
                'default_rule_id': self.id,
            },
        }
```

#### **ä»»åŠ¡2ï¼šç´ æç®¡ç†æ¨¡å‹è®¾è®¡**
```python
# file: wechat_platform/models/wechat_material.py

from odoo import models, fields, api, _
from odoo.exceptions import ValidationError, UserError
import logging
import os
import mimetypes
import base64
from datetime import datetime, timedelta
import json

_logger = logging.getLogger(__name__)

class WechatMaterial(models.Model):
    """å¾®ä¿¡ç´ æç®¡ç†"""
    _name = 'wechat.material'
    _description = 'å¾®ä¿¡ç´ æ'
    _order = 'update_time desc'
    
    # åŸºæœ¬ä¿¡æ¯
    name = fields.Char(string='ç´ æåç§°', required=True)
    account_id = fields.Many2one('wechat.account', string='æ‰€å±å…¬ä¼—å·', required=True)
    
    # ç´ æç±»å‹
    material_type = fields.Selection([
        ('image', 'å›¾ç‰‡'),
        ('voice', 'è¯­éŸ³'),
        ('video', 'è§†é¢‘'),
        ('thumb', 'ç¼©ç•¥å›¾'),
        ('news', 'å›¾æ–‡'),
    ], string='ç´ æç±»å‹', required=True)
    
    # åª’ä½“ä¿¡æ¯
    media_id = fields.Char(string='å¾®ä¿¡åª’ä½“ID', readonly=True,
                          help='å¾®ä¿¡æœåŠ¡å™¨è¿”å›çš„media_idï¼Œæœ‰æ•ˆæœŸ3å¤©')
    media_url = fields.Char(string='å¾®ä¿¡åª’ä½“URL', readonly=True,
                           help='å¾®ä¿¡æœåŠ¡å™¨è¿”å›çš„URLï¼Œæ°¸ä¹…æœ‰æ•ˆï¼ˆé™¤ä¸´æ—¶ç´ æï¼‰')
    
    # æ–‡ä»¶ä¿¡æ¯
    file_data = fields.Binary(string='æ–‡ä»¶å†…å®¹', attachment=True)
    file_name = fields.Char(string='æ–‡ä»¶å')
    file_size = fields.Integer(string='æ–‡ä»¶å¤§å°(KB)', compute='_compute_file_size')
    mime_type = fields.Char(string='MIMEç±»å‹')
    
    # è§†é¢‘ç´ æç‰¹å®šå­—æ®µ
    title = fields.Char(string='è§†é¢‘æ ‡é¢˜', help='è§†é¢‘ç´ æä¸“ç”¨')
    introduction = fields.Text(string='è§†é¢‘æè¿°', help='è§†é¢‘ç´ æä¸“ç”¨')
    
    # å›¾æ–‡ç´ æç‰¹å®šå­—æ®µ
    articles = fields.One2many('wechat.article', 'material_id', string='æ–‡ç« åˆ—è¡¨')
    article_count = fields.Integer(string='æ–‡ç« æ•°é‡', compute='_compute_article_count')
    
    # çŠ¶æ€ä¿¡æ¯
    is_temporary = fields.Boolean(string='ä¸´æ—¶ç´ æ', default=False,
                                 help='ä¸´æ—¶ç´ ææœ‰æ•ˆæœŸä¸º3å¤©')
    upload_time = fields.Datetime(string='ä¸Šä¼ æ—¶é—´', readonly=True)
    update_time = fields.Datetime(string='æ›´æ–°æ—¶é—´', readonly=True)
    expire_time = fields.Datetime(string='è¿‡æœŸæ—¶é—´', readonly=True,
                                 help='ä¸´æ—¶ç´ æçš„è¿‡æœŸæ—¶é—´')
    is_expired = fields.Boolean(string='å·²è¿‡æœŸ', compute='_compute_is_expired', store=True)
    
    # ä½¿ç”¨ç»Ÿè®¡
    usage_count = fields.Integer(string='ä½¿ç”¨æ¬¡æ•°', default=0, readonly=True)
    last_used_time = fields.Datetime(string='æœ€åä½¿ç”¨æ—¶é—´', readonly=True)
    
    # æ ‡ç­¾ç®¡ç†
    tag_ids = fields.Many2many('wechat.material.tag', string='æ ‡ç­¾')
    
    @api.depends('file_data')
    def _compute_file_size(self):
        """è®¡ç®—æ–‡ä»¶å¤§å°"""
        for material in self:
            if material.file_data:
                # file_dataæ˜¯base64ç¼–ç çš„ï¼Œè§£ç åè®¡ç®—å¤§å°
                try:
                    decoded_data = base64.b64decode(material.file_data)
                    material.file_size = len(decoded_data) // 1024  # è½¬æ¢ä¸ºKB
                except:
                    material.file_size = 0
            else:
                material.file_size = 0
    
    @api.depends('articles')
    def _compute_article_count(self):
        """è®¡ç®—æ–‡ç« æ•°é‡"""
        for material in self:
            material.article_count = len(material.articles)
    
    @api.depends('expire_time')
    def _compute_is_expired(self):
        """è®¡ç®—æ˜¯å¦è¿‡æœŸ"""
        now = fields.Datetime.now()
        for material in self:
            if material.expire_time and material.is_temporary:
                material.is_expired = now > material.expire_time
            else:
                material.is_expired = False
    
    @api.constrains('file_data')
    def _check_file_size(self):
        """æ£€æŸ¥æ–‡ä»¶å¤§å°é™åˆ¶"""
        size_limits = {
            'image': 2 * 1024 * 1024,  # 2MB
            'voice': 2 * 1024 * 1024,  # 2MB
            'video': 10 * 1024 * 1024,  # 10MB
            'thumb': 64 * 1024,  # 64KB
        }
        
        for material in self:
            if material.material_type in size_limits and material.file_data:
                try:
                    decoded_data = base64.b64decode(material.file_data)
                    file_size = len(decoded_data)
                    limit = size_limits[material.material_type]
                    
                    if file_size > limit:
                        raise ValidationError(
                            _('%sç´ æå¤§å°ä¸èƒ½è¶…è¿‡%dMBï¼Œå½“å‰%.2fMB') % (
                                material.material_type,
                                limit // 1024 // 1024,
                                file_size / 1024 / 1024
                            )
                        )
                except Exception as e:
                    _logger.error(f"æ£€æŸ¥æ–‡ä»¶å¤§å°å¤±è´¥: {str(e)}")
    
    @api.constrains('material_type', 'articles')
    def _check_news_material(self):
        """æ£€æŸ¥å›¾æ–‡ç´ æ"""
        for material in self:
            if material.material_type == 'news' and not material.articles:
                raise ValidationError(_('å›¾æ–‡ç´ æå¿…é¡»åŒ…å«æ–‡ç« '))
            
            if material.material_type == 'news' and len(material.articles) > 8:
                raise ValidationError(_('å›¾æ–‡ç´ ææœ€å¤šåŒ…å«8ç¯‡æ–‡ç« '))
    
    def upload_to_wechat(self, temporary=False):
        """ä¸Šä¼ ç´ æåˆ°å¾®ä¿¡"""
        self.ensure_one()
        
        try:
            account = self.account_id
            client = account.get_api_client()
            
            if self.material_type == 'image':
                result = client.upload_image(self.file_data, filename=self.file_name)
            elif self.material_type == 'voice':
                result = client.upload_voice(self.file_data, filename=self.file_name)
            elif self.material_type == 'video':
                result = client.upload_video(self.file_data, filename=self.file_name, 
                                           title=self.title, introduction=self.introduction)
            elif self.material_type == 'thumb':
                result = client.upload_thumb(self.file_data, filename=self.file_name)
            elif self.material_type == 'news':
                articles_data = [article.get_article_data() for article in self.articles]
                result = client.upload_news(articles_data)
            else:
                raise UserError(_('ä¸æ”¯æŒçš„ç´ æç±»å‹: %s') % self.material_type)
            
            # æ›´æ–°ç´ æä¿¡æ¯
            update_values = {
                'media_id': result.get('media_id'),
                'media_url': result.get('url'),
                'upload_time': fields.Datetime.now(),
                'update_time': fields.Datetime.now(),
                'is_temporary': temporary,
            }
            
            if temporary:
                # ä¸´æ—¶ç´ æ3å¤©åè¿‡æœŸ
                expire_time = datetime.now() + timedelta(days=3)
                update_values['expire_time'] = expire_time
            
            self.write(update_values)
            
            _logger.info(f"ç´ æä¸Šä¼ æˆåŠŸ: {self.name} (ID: {self.media_id})")
            return True
            
        except Exception as e:
            _logger.error(f"ç´ æä¸Šä¼ å¤±è´¥: {str(e)}")
            raise UserError(_('ç´ æä¸Šä¼ å¤±è´¥: %s') % str(e))
    
    def download_from_wechat(self):
        """ä»å¾®ä¿¡ä¸‹è½½ç´ æ"""
        self.ensure_one()
        
        if not self.media_id:
            raise UserError(_('ç´ ææ²¡æœ‰media_idï¼Œæ— æ³•ä¸‹è½½'))
        
        try:
            account = self.account_id
            client = account.get_api_client()
            
            # ä¸‹è½½ç´ æ
            result = client.download_material(self.media_id, self.is_temporary)
            
            if self.material_type == 'news':
                # å›¾æ–‡ç´ æè¿”å›çš„æ˜¯æ–‡ç« æ•°æ®
                articles_data = result.get('news_item', [])
                
                # æ¸…ç©ºç°æœ‰æ–‡ç« 
                self.articles.unlink()
                
                # åˆ›å»ºæ–°æ–‡ç« 
                for idx, article_data in enumerate(articles_data):
                    self.env['wechat.article'].create({
                        'material_id': self.id,
                        'sequence': idx,
                        'title': article_data.get('title', ''),
                        'author': article_data.get('author', ''),
                        'digest': article_data.get('digest', ''),
                        'content': article_data.get('content', ''),
                        'content_source_url': article_data.get('content_source_url', ''),
                        'thumb_media_id': article_data.get('thumb_media_id', ''),
                        'show_cover_pic': article_data.get('show_cover_pic', 0),
                        'need_open_comment': article_data.get('need_open_comment', 0),
                        'only_fans_can_comment': article_data.get('only_fans_can_comment', 0),
                    })
            else:
                # å…¶ä»–ç±»å‹ç´ æ
                if 'video_url' in result:
                    # è§†é¢‘ç´ æ
                    self.media_url = result.get('video_url')
                else:
                    # å›¾ç‰‡ã€è¯­éŸ³ã€ç¼©ç•¥å›¾
                    file_data = result.get('file_data')
                    if file_data:
                        self.file_data = base64.b64encode(file_data).decode('ascii')
                        self.mime_type = mimetypes.guess_type(self.file_name or '')[0]
            
            self.update_time = fields.Datetime.now()
            _logger.info(f"ç´ æä¸‹è½½æˆåŠŸ: {self.name}")
            
        except Exception as e:
            _logger.error(f"ç´ æä¸‹è½½å¤±è´¥: {str(e)}")
            raise UserError(_('ç´ æä¸‹è½½å¤±è´¥: %s') % str(e))
    
    def get_news_data(self):
        """è·å–å›¾æ–‡ç´ ææ•°æ®"""
        self.ensure_one()
        
        if self.material_type != 'news':
            return {}
        
        articles_data = []
        for article in self.articles.sorted('sequence'):
            articles_data.append(article.get_article_data())
        
        return {
            'articles': articles_data,
            'media_id': self.media_id,
        }
    
    def update_usage_count(self):
        """æ›´æ–°ä½¿ç”¨æ¬¡æ•°"""
        self.ensure_one()
        self.write({
            'usage_count': self.usage_count + 1,
            'last_used_time': fields.Datetime.now(),
        })
    
    def action_preview_material(self):
        """é¢„è§ˆç´ æ"""
        self.ensure_one()
        
        preview_urls = {
            'image': f'/wechat_platform/material/preview/image/{self.id}',
            'voice': f'/wechat_platform/material/preview/voice/{self.id}',
            'video': f'/wechat_platform/material/preview/video/{self.id}',
            'news': f'/wechat_platform/material/preview/news/{self.id}',
        }
        
        if self.material_type in preview_urls:
            return {
                'type': 'ir.actions.act_url',
                'url': preview_urls[self.material_type],
                'target': 'new',
            }
        
        return False
    
    def action_download_material(self):
        """ä¸‹è½½ç´ æ"""
        self.ensure_one()
        
        if not self.file_data:
            raise UserError(_('ç´ ææ²¡æœ‰æ–‡ä»¶æ•°æ®'))
        
        return {
            'type': 'ir.actions.act_url',
            'url': f'/web/content/wechat.material/{self.id}/file_data?download=true',
            'target': 'self',
        }
    
    def action_upload_to_wechat(self):
        """ä¸Šä¼ åˆ°å¾®ä¿¡"""
        self.ensure_one()
        
        if self.media_id and not self.is_expired:
            raise UserError(_('ç´ æå·²ä¸Šä¼ åˆ°å¾®ä¿¡ï¼Œæ— éœ€é‡å¤ä¸Šä¼ '))
        
        return {
            'type': 'ir.actions.act_window',
            'name': 'ä¸Šä¼ åˆ°å¾®ä¿¡',
            'res_model': 'wechat.material.upload',
            'view_mode': 'form',
            'target': 'new',
            'context': {
                'default_material_id': self.id,
            },
        }
    
    @api.model
    def cron_clean_expired_materials(self):
        """å®šæ—¶æ¸…ç†è¿‡æœŸç´ æ"""
        expired_materials = self.search([
            ('is_temporary', '=', True),
            ('is_expired', '=', True),
        ])
        
        deleted_count = 0
        for material in expired_materials:
            try:
                # ä»å¾®ä¿¡åˆ é™¤
                if material.media_id:
                    account = material.account_id
                    client = account.get_api_client()
                    client.delete_material(material.media_id)
                
                # ä»æœ¬åœ°åˆ é™¤
                material.unlink()
                deleted_count += 1
                
            except Exception as e:
                _logger.error(f"æ¸…ç†ç´ æå¤±è´¥ {material.name}: {str(e)}")
        
        _logger.info(f"æ¸…ç†äº† {deleted_count} ä¸ªè¿‡æœŸç´ æ")
        return deleted_count
    
    def batch_upload_materials(self, material_ids):
        """æ‰¹é‡ä¸Šä¼ ç´ æ"""
        success_count = 0
        failed_materials = []
        
        for material in self.browse(material_ids):
            try:
                material.upload_to_wechat()
                success_count += 1
            except Exception as e:
                failed_materials.append({
                    'material': material.name,
                    'error': str(e),
                })
        
        return {
            'success_count': success_count,
            'failed_count': len(failed_materials),
            'failed_materials': failed_materials,
        }


class WechatArticle(models.Model):
    """å¾®ä¿¡å›¾æ–‡ç´ ææ–‡ç« """
    _name = 'wechat.article'
    _description = 'å¾®ä¿¡å›¾æ–‡æ–‡ç« '
    _order = 'sequence, id'
    
    material_id = fields.Many2one('wechat.material', string='æ‰€å±å›¾æ–‡', required=True, ondelete='cascade')
    sequence = fields.Integer(string='æ’åº', default=0)
    
    # æ–‡ç« å†…å®¹
    title = fields.Char(string='æ ‡é¢˜', required=True, size=64)
    author = fields.Char(string='ä½œè€…', size=8)
    digest = fields.Text(string='æ‘˜è¦', size=120,
                        help='å›¾æ–‡æ¶ˆæ¯çš„æ‘˜è¦ï¼Œä»…æœ‰å•å›¾æ–‡æ¶ˆæ¯æ‰æ˜¾ç¤ºæ‘˜è¦')
    
    # æ­£æ–‡å†…å®¹
    content = fields.Html(string='æ­£æ–‡å†…å®¹', required=True)
    content_source_url = fields.Char(string='åŸæ–‡é“¾æ¥',
                                    help='ç‚¹å‡»"é˜…è¯»åŸæ–‡"åçš„é“¾æ¥')
    
    # å°é¢å›¾ç‰‡
    thumb_media_id = fields.Char(string='å°é¢å›¾ç‰‡media_id')
    thumb_image = fields.Binary(string='å°é¢å›¾ç‰‡', attachment=True)
    thumb_url = fields.Char(string='å°é¢å›¾ç‰‡URL', readonly=True)
    show_cover_pic = fields.Boolean(string='æ˜¾ç¤ºå°é¢å›¾ç‰‡', default=True,
                                   help='æ˜¯å¦åœ¨æ­£æ–‡ä¸­æ˜¾ç¤ºå°é¢å›¾ç‰‡')
    
    # è¯„è®ºè®¾ç½®
    need_open_comment = fields.Boolean(string='æ‰“å¼€è¯„è®º', default=False)
    only_fans_can_comment = fields.Boolean(string='ä»…ç²‰ä¸å¯è¯„è®º', default=False)
    
    # çŠ¶æ€ä¿¡æ¯
    url = fields.Char(string='æ–‡ç« URL', readonly=True,
                     help='å¾®ä¿¡æœåŠ¡å™¨è¿”å›çš„æ–‡ç« URL')
    
    def get_article_data(self):
        """è·å–æ–‡ç« æ•°æ®ï¼ˆç”¨äºä¸Šä¼ åˆ°å¾®ä¿¡ï¼‰"""
        return {
            'title': self.title,
            'author': self.author or '',
            'digest': self.digest or '',
            'content': self._clean_html_content(self.content),
            'content_source_url': self.content_source_url or '',
            'thumb_media_id': self.thumb_media_id or '',
            'show_cover_pic': 1 if self.show_cover_pic else 0,
            'need_open_comment': 1 if self.need_open_comment else 0,
            'only_fans_can_comment': 1 if self.only_fans_can_comment else 0,
        }
    
    def _clean_html_content(self, html_content):
        """æ¸…ç†HTMLå†…å®¹"""
        # ç§»é™¤å±é™©çš„HTMLæ ‡ç­¾å’Œå±æ€§
        # è¿™é‡Œåº”è¯¥å®ç°ä¸€ä¸ªå®‰å…¨çš„HTMLæ¸…ç†å‡½æ•°
        # ç®€åŒ–ç¤ºä¾‹ï¼šåªåšåŸºæœ¬æ¸…ç†
        import re
        
        # ç§»é™¤scriptæ ‡ç­¾
        html_content = re.sub(r'<script.*?>.*?</script>', '', html_content, flags=re.DOTALL | re.IGNORECASE)
        
        # ç§»é™¤onäº‹ä»¶å±æ€§
        html_content = re.sub(r'\bon\w+\s*=\s*".*?"', '', html_content, flags=re.IGNORECASE)
        html_content = re.sub(r"\bon\w+\s*=\s*'.*?'", '', html_content, flags=re.IGNORECASE)
        
        return html_content
    
    def upload_thumb_image(self):
        """ä¸Šä¼ å°é¢å›¾ç‰‡åˆ°å¾®ä¿¡"""
        self.ensure_one()
        
        if not self.thumb_image:
            raise UserError(_('è¯·å…ˆè®¾ç½®å°é¢å›¾ç‰‡'))
        
        try:
            # åˆ›å»ºä¸´æ—¶ç´ æè®°å½•
            material = self.env['wechat.material'].create({
                'name': f'{self.title} - å°é¢å›¾ç‰‡',
                'account_id': self.material_id.account_id.id,
                'material_type': 'image',
                'file_data': self.thumb_image,
                'file_name': 'thumb.jpg',
            })
            
            # ä¸Šä¼ åˆ°å¾®ä¿¡ï¼ˆä¸´æ—¶ç´ æï¼‰
            material.upload_to_wechat(temporary=True)
            
            # æ›´æ–°å°é¢å›¾ç‰‡media_id
            self.thumb_media_id = material.media_id
            self.thumb_url = material.media_url
            
            return True
            
        except Exception as e:
            _logger.error(f"ä¸Šä¼ å°é¢å›¾ç‰‡å¤±è´¥: {str(e)}")
            raise UserError(_('ä¸Šä¼ å°é¢å›¾ç‰‡å¤±è´¥: %s') % str(e))
    
    def action_preview_article(self):
        """é¢„è§ˆæ–‡ç« """
        self.ensure_one()
        
        if not self.url:
            raise UserError(_('æ–‡ç« å°šæœªä¸Šä¼ åˆ°å¾®ä¿¡ï¼Œæ— æ³•é¢„è§ˆ'))
        
        return {
            'type': 'ir.actions.act_url',
            'url': self.url,
            'target': 'new',
        }


class WechatMaterialTag(models.Model):
    """ç´ ææ ‡ç­¾"""
    _name = 'wechat.material.tag'
    _description = 'ç´ ææ ‡ç­¾'
    _order = 'name'
    
    name = fields.Char(string='æ ‡ç­¾åç§°', required=True)
    color = fields.Integer(string='é¢œè‰²ç´¢å¼•')
    material_count = fields.Integer(string='ç´ ææ•°é‡', compute='_compute_material_count')
    
    def _compute_material_count(self):
        """è®¡ç®—ç´ ææ•°é‡"""
        for tag in self:
            tag.material_count = self.env['wechat.material'].search_count([
                ('tag_ids', 'in', tag.id)
            ])
```

#### **ä»»åŠ¡3ï¼šè‡ªå®šä¹‰èœå•ç®¡ç†**
```python
# file: wechat_platform/models/wechat_menu.py

from odoo import models, fields, api, _
from odoo.exceptions import ValidationError, UserError
import logging
import json
from datetime import datetime

_logger = logging.getLogger(__name__)

class WechatMenu(models.Model):
    """å¾®ä¿¡è‡ªå®šä¹‰èœå•"""
    _name = 'wechat.menu'
    _description = 'å¾®ä¿¡è‡ªå®šä¹‰èœå•'
    _order = 'sequence, id'
    
    name = fields.Char(string='èœå•åç§°', required=True)
    account_id = fields.Many2one('wechat.account', string='æ‰€å±å…¬ä¼—å·', required=True)
    
    # èœå•ç±»å‹
    menu_type = fields.Selection([
        ('click', 'ç‚¹å‡»äº‹ä»¶'),
        ('view', 'è·³è½¬URL'),
        ('scancode_push', 'æ‰«ç æ¨äº‹ä»¶'),
        ('scancode_waitmsg', 'æ‰«ç å¸¦æç¤º'),
        ('pic_sysphoto', 'ç³»ç»Ÿæ‹ç…§å‘å›¾'),
        ('pic_photo_or_album', 'æ‹ç…§æˆ–è€…ç›¸å†Œå‘å›¾'),
        ('pic_weixin', 'å¾®ä¿¡ç›¸å†Œå‘å›¾'),
        ('location_select', 'å‘é€ä½ç½®'),
        ('media_id', 'å›¾ç‰‡æ¶ˆæ¯'),
        ('view_limited', 'å›¾æ–‡æ¶ˆæ¯'),
        ('miniprogram', 'å°ç¨‹åº'),
    ], string='èœå•ç±»å‹', default='click', required=True)
    
    # èœå•ç»“æ„
    parent_id = fields.Many2one('wechat.menu', string='çˆ¶èœå•', ondelete='cascade')
    child_ids = fields.One2many('wechat.menu', 'parent_id', string='å­èœå•')
    level = fields.Integer(string='å±‚çº§', compute='_compute_level', store=True)
    is_root = fields.Boolean(string='æ ¹èœå•', compute='_compute_is_root')
    
    # èœå•é…ç½®
    key = fields.Char(string='èœå•KEYå€¼',
                     help='clickç­‰ç‚¹å‡»ç±»å‹å¿…é¡»')
    url = fields.Char(string='è·³è½¬é“¾æ¥',
                     help='viewç±»å‹å¿…é¡»')
    media_id = fields.Char(string='åª’ä½“ID',
                          help='media_idç±»å‹å’Œview_limitedç±»å‹å¿…é¡»')
    appid = fields.Char(string='å°ç¨‹åºAppID',
                       help='miniprogramç±»å‹å¿…é¡»')
    pagepath = fields.Char(string='å°ç¨‹åºé¡µé¢è·¯å¾„',
                          help='miniprogramç±»å‹å¿…é¡»')
    
    # å›å¤å†…å®¹
    reply_type = fields.Selection([
        ('text', 'æ–‡æœ¬'),
        ('image', 'å›¾ç‰‡'),
        ('voice', 'è¯­éŸ³'),
        ('video', 'è§†é¢‘'),
        ('news', 'å›¾æ–‡'),
    ], string='å›å¤ç±»å‹', default='text')
    
    reply_content = fields.Text(string='å›å¤å†…å®¹')
    reply_material_id = fields.Many2one('wechat.material', string='å…³è”ç´ æ')
    
    # æ˜¾ç¤ºè®¾ç½®
    sequence = fields.Integer(string='æ’åº', default=10)
    is_active = fields.Boolean(string='å¯ç”¨', default=True)
    
    # ç»Ÿè®¡ä¿¡æ¯
    click_count = fields.Integer(string='ç‚¹å‡»æ¬¡æ•°', default=0, readonly=True)
    last_click_time = fields.Datetime(string='æœ€åç‚¹å‡»æ—¶é—´', readonly=True)
    
    # éªŒè¯ä¿¡æ¯
    is_valid = fields.Boolean(string='é…ç½®æœ‰æ•ˆ', compute='_compute_is_valid', store=True)
    validation_errors = fields.Text(string='é…ç½®é”™è¯¯', compute='_compute_is_valid', store=True)
    
    @api.depends('parent_id')
    def _compute_level(self):
        """è®¡ç®—èœå•å±‚çº§"""
        for menu in self:
            if menu.parent_id:
                menu.level = menu.parent_id.level + 1
            else:
                menu.level = 1
    
    @api.depends('parent_id')
    def _compute_is_root(self):
        """è®¡ç®—æ˜¯å¦æ˜¯æ ¹èœå•"""
        for menu in self:
            menu.is_root = not bool(menu.parent_id)
    
    @api.depends('menu_type', 'key', 'url', 'media_id', 'appid', 'pagepath')
    def _compute_is_valid(self):
        """éªŒè¯èœå•é…ç½®"""
        for menu in self:
            errors = []
            
            # æ£€æŸ¥å¿…å¡«å­—æ®µ
            if menu.menu_type == 'click' and not menu.key:
                errors.append('clickç±»å‹å¿…é¡»è®¾ç½®KEYå€¼')
            elif menu.menu_type == 'view' and not menu.url:
                errors.append('viewç±»å‹å¿…é¡»è®¾ç½®è·³è½¬é“¾æ¥')
            elif menu.menu_type in ['media_id', 'view_limited'] and not menu.media_id:
                errors.append(f'{menu.menu_type}ç±»å‹å¿…é¡»è®¾ç½®åª’ä½“ID')
            elif menu.menu_type == 'miniprogram' and (not menu.appid or not menu.pagepath):
                errors.append('miniprogramç±»å‹å¿…é¡»è®¾ç½®AppIDå’Œé¡µé¢è·¯å¾„')
            
            # æ£€æŸ¥å­èœå•æ•°é‡é™åˆ¶
            if menu.is_root and len(menu.child_ids) > 5:
                errors.append('ä¸€çº§èœå•æœ€å¤šåªèƒ½æœ‰5ä¸ªå­èœå•')
            elif not menu.is_root and menu.level > 2:
                errors.append('èœå•å±‚çº§ä¸èƒ½è¶…è¿‡2çº§')
            
            # æ£€æŸ¥èœå•åç§°é•¿åº¦
            if len(menu.name) > 16:
                errors.append('èœå•åç§°ä¸èƒ½è¶…è¿‡16ä¸ªå­—ç¬¦')
            
            # æ£€æŸ¥å­èœå•åç§°é•¿åº¦
            for child in menu.child_ids:
                if len(child.name) > 40:
                    errors.append(f'å­èœå•"{child.name}"åç§°ä¸èƒ½è¶…è¿‡40ä¸ªå­—ç¬¦')
            
            menu.validation_errors = '\n'.join(errors)
            menu.is_valid = len(errors) == 0
    
    @api.constrains('parent_id')
    def _check_menu_hierarchy(self):
        """æ£€æŸ¥èœå•å±‚çº§"""
        for menu in self:
            if menu.parent_id and menu.parent_id.parent_id:
                raise ValidationError(_('èœå•å±‚çº§ä¸èƒ½è¶…è¿‡2çº§'))
    
    @api.constrains('parent_id', 'account_id')
    def _check_account_consistency(self):
        """æ£€æŸ¥è´¦å·ä¸€è‡´æ€§"""
        for menu in self:
            if menu.parent_id and menu.parent_id.account_id != menu.account_id:
                raise ValidationError(_('å­èœå•å¿…é¡»å±äºåŒä¸€ä¸ªå…¬ä¼—å·'))
    
    def get_menu_data(self):
        """è·å–èœå•æ•°æ®ï¼ˆç”¨äºå‘å¸ƒåˆ°å¾®ä¿¡ï¼‰"""
        self.ensure_one()
        
        menu_data = {
            'name': self.name,
            'type': self.menu_type,
        }
        
        # æ ¹æ®ç±»å‹è®¾ç½®ä¸åŒçš„å­—æ®µ
        if self.menu_type == 'click':
            menu_data['key'] = self.key
        elif self.menu_type == 'view':
            menu_data['url'] = self.url
        elif self.menu_type in ['media_id', 'view_limited']:
            menu_data['media_id'] = self.media_id
        elif self.menu_type == 'miniprogram':
            menu_data['appid'] = self.appid
            menu_data['pagepath'] = self.pagepath
            menu_data['url'] = self.url or 'http://mp.weixin.qq.com'
        
        # å¦‚æœæœ‰å­èœå•
        if self.child_ids:
            menu_data['sub_button'] = [child.get_menu_data() for child in self.child_ids]
        
        return menu_data
    
    def publish_to_wechat(self):
        """å‘å¸ƒèœå•åˆ°å¾®ä¿¡"""
        self.ensure_one()
        
        if not self.is_valid:
            raise UserError(_('èœå•é…ç½®æœ‰è¯¯ï¼Œè¯·å…ˆä¿®æ­£:\n%s') % self.validation_errors)
        
        try:
            account = self.account_id
            client = account.get_api_client()
            
            # è·å–æ ¹èœå•
            root_menus = self.search([
                ('account_id', '=', account.id),
                ('parent_id', '=', False),
                ('is_active', '=', True),
                ('is_valid', '=', True),
            ], order='sequence')
            
            # æ„å»ºèœå•æ•°æ®
            menu_data = {
                'button': [menu.get_menu_data() for menu in root_menus]
            }
            
            # å‘å¸ƒèœå•
            result = client.create_menu(menu_data)
            
            # æ›´æ–°èœå•çŠ¶æ€
            root_menus.write({
                'click_count': 0,  # é‡ç½®ç‚¹å‡»ç»Ÿè®¡
                'last_click_time': False,
            })
            
            _logger.info(f"èœå•å‘å¸ƒæˆåŠŸ: {account.name}")
            return True
            
        except Exception as e:
            _logger.error(f"èœå•å‘å¸ƒå¤±è´¥: {str(e)}")
            raise UserError(_('èœå•å‘å¸ƒå¤±è´¥: %s') % str(e))
    
    def delete_from_wechat(self):
        """ä»å¾®ä¿¡åˆ é™¤èœå•"""
        self.ensure_one()
        
        try:
            account = self.account_id
            client = account.get_api_client()
            
            # åˆ é™¤èœå•
            result = client.delete_menu()
            
            _logger.info(f"èœå•åˆ é™¤æˆåŠŸ: {account.name}")
            return True
            
        except Exception as e:
            _logger.error(f"èœå•åˆ é™¤å¤±è´¥: {str(e)}")
            raise UserError(_('èœå•åˆ é™¤å¤±è´¥: %s') % str(e))
    
    def get_menu_from_wechat(self):
        """ä»å¾®ä¿¡è·å–èœå•"""
        self.ensure_one()
        
        try:
            account = self.account_id
            client = account.get_api_client()
            
            # è·å–èœå•
            result = client.get_menu()
            
            # æ¸…ç©ºç°æœ‰èœå•
            existing_menus = self.search([('account_id', '=', account.id)])
            existing_menus.unlink()
            
            # è§£æå¹¶åˆ›å»ºèœå•
            if 'menu' in result and 'button' in result['menu']:
                self._create_menus_from_data(account.id, result['menu']['button'], None)
            
            _logger.info(f"èœå•è·å–æˆåŠŸ: {account.name}")
            return True
            
        except Exception as e:
            _logger.error(f"èœå•è·å–å¤±è´¥: {str(e)}")
            raise UserError(_('èœå•è·å–å¤±è´¥: %s') % str(e))
    
    def _create_menus_from_data(self, account_id, buttons_data, parent_id=None, sequence=0):
        """ä»æ•°æ®åˆ›å»ºèœå•"""
        for idx, button_data in enumerate(buttons_data):
            sequence = idx * 10
            
            menu_values = {
                'account_id': account_id,
                'parent_id': parent_id,
                'name': button_data.get('name', ''),
                'menu_type': button_data.get('type', 'click'),
                'sequence': sequence,
            }
            
            # è®¾ç½®ç±»å‹ç›¸å…³å­—æ®µ
            if button_data.get('type') == 'click':
                menu_values['key'] = button_data.get('key')
            elif button_data.get('type') == 'view':
                menu_values['url'] = button_data.get('url')
            elif button_data.get('type') in ['media_id', 'view_limited']:
                menu_values['media_id'] = button_data.get('media_id')
            elif button_data.get('type') == 'miniprogram':
                menu_values['appid'] = button_data.get('appid')
                menu_values['pagepath'] = button_data.get('pagepath')
                menu_values['url'] = button_data.get('url')
            
            # åˆ›å»ºèœå•
            menu = self.create(menu_values)
            
            # å¤„ç†å­èœå•
            if 'sub_button' in button_data and button_data['sub_button']:
                self._create_menus_from_data(account_id, button_data['sub_button'], menu.id)
    
    def record_click(self):
        """è®°å½•èœå•ç‚¹å‡»"""
        self.ensure_one()
        
        self.write({
            'click_count': self.click_count + 1,
            'last_click_time': fields.Datetime.now(),
        })
        
        # åˆ›å»ºèœå•ç‚¹å‡»ç»Ÿè®¡è®°å½•
        self.env['wechat.menu.stat'].create({
            'menu_id': self.id,
            'click_time': fields.Datetime.now(),
        })
    
    def get_menu_tree(self):
        """è·å–èœå•æ ‘å½¢ç»“æ„"""
        self.ensure_one()
        
        def build_tree(menu):
            tree_data = {
                'id': menu.id,
                'name': menu.name,
                'type': menu.menu_type,
                'is_valid': menu.is_valid,
                'click_count': menu.click_count,
                'children': [],
            }
            
            for child in menu.child_ids:
                tree_data['children'].append(build_tree(child))
            
            return tree_data
        
        return build_tree(self)
    
    def action_preview_menu(self):
        """é¢„è§ˆèœå•"""
        self.ensure_one()
        
        if not self.is_root:
            raise UserError(_('åªèƒ½é¢„è§ˆæ ¹èœå•'))
        
        account = self.account_id
        
        return {
            'type': 'ir.actions.act_url',
            'url': f'https://mp.weixin.qq.com/debug/cgi-bin/apiinfo?t=index&type=%E8%87%AA%E5%AE%9A%E4%B9%89%E8%8F%9C%E5%8D%95&form=è‡ªå®šä¹‰èœå•è°ƒè¯•å·¥å…·&token={account.access_token}',
            'target': 'new',
        }


class WechatMenuStat(models.Model):
    """èœå•ç‚¹å‡»ç»Ÿè®¡"""
    _name = 'wechat.menu.stat'
    _description = 'èœå•ç‚¹å‡»ç»Ÿè®¡'
    _order = 'click_time desc'
    
    menu_id = fields.Many2one('wechat.menu', string='èœå•', required=True, ondelete='cascade')
    account_id = fields.Many2one('wechat.account', string='å…¬ä¼—å·', related='menu_id.account_id', store=True)
    click_time = fields.Datetime(string='ç‚¹å‡»æ—¶é—´', required=True)
    openid = fields.Char(string='ç”¨æˆ·OpenID')
    
    # ç”¨æˆ·ä¿¡æ¯
    user_id = fields.Many2one('wechat.user', string='ç²‰ä¸', 
                             compute='_compute_user_id', store=True)
    nickname = fields.Char(string='ç”¨æˆ·æ˜µç§°', related='user_id.nickname', store=True)
    
    # è®¾å¤‡ä¿¡æ¯
    user_agent = fields.Char(string='ç”¨æˆ·ä»£ç†')
    ip_address = fields.Char(string='IPåœ°å€')
    
    @api.depends('openid', 'account_id')
    def _compute_user_id(self):
        """è®¡ç®—å…³è”ç²‰ä¸"""
        for stat in self:
            if stat.openid and stat.account_id:
                user = self.env['wechat.user'].search([
                    ('openid', '=', stat.openid),
                    ('account_id', '=', stat.account_id.id),
                ], limit=1)
                stat.user_id = user.id if user else False
            else:
                stat.user_id = False
    
    @api.model
    def analyze_menu_stats(self, account_id=None, start_date=None, end_date=None):
        """åˆ†æèœå•ç»Ÿè®¡"""
        domain = []
        
        if account_id:
            domain.append(('account_id', '=', account_id))
        
        if start_date:
            domain.append(('click_time', '>=', start_date))
        
        if end_date:
            domain.append(('click_time', '<=', end_date))
        
        # è·å–ç»Ÿè®¡è®°å½•
        stats = self.search(domain)
        
        analysis = {
            'total_clicks': len(stats),
            'clicks_by_menu': {},
            'clicks_by_hour': {},
            'clicks_by_day': {},
            'top_users': [],
        }
        
        # æŒ‰èœå•ç»Ÿè®¡
        for stat in stats:
            menu_name = stat.menu_id.name
            analysis['clicks_by_menu'][menu_name] = analysis['clicks_by_menu'].get(menu_name, 0) + 1
        
        # æŒ‰å°æ—¶ç»Ÿè®¡
        for stat in stats:
            hour = stat.click_time.hour
            hour_key = f"{hour:02d}:00"
            analysis['clicks_by_hour'][hour_key] = analysis['clicks_by_hour'].get(hour_key, 0) + 1
        
        # æŒ‰å¤©ç»Ÿè®¡
        for stat in stats:
            day_key = stat.click_time.strftime('%Y-%m-%d')
            analysis['clicks_by_day'][day_key] = analysis['clicks_by_day'].get(day_key, 0) + 1
        
        # ç»Ÿè®¡ç‚¹å‡»æœ€å¤šçš„ç”¨æˆ·
        user_clicks = {}
        for stat in stats:
            if stat.openid:
                user_clicks[stat.openid] = user_clicks.get(stat.openid, 0) + 1
        
        top_users = sorted(user_clicks.items(), key=lambda x: x[1], reverse=True)[:10]
        analysis['top_users'] = [{'openid': openid, 'clicks': clicks} for openid, clicks in top_users]
        
        return analysis
```

### **å‰ç«¯å¼€å‘å…·ä½“ä»»åŠ¡ï¼š**

#### **ä»»åŠ¡1ï¼šè‡ªåŠ¨å›å¤è§„åˆ™ç®¡ç†ç•Œé¢**
```xml
<!-- file: wechat_platform/views/wechat_auto_reply_views.xml -->

<odoo>
    <data>
        <!-- è‡ªåŠ¨å›å¤è§„åˆ™åˆ—è¡¨è§†å›¾ -->
        <record id="wechat_auto_reply_list_view" model="ir.ui.view">
            <field name="name">wechat.auto.reply.list</field>
            <field name="model">wechat.auto_reply</field>
            <field name="arch" type="xml">
                <tree string="è‡ªåŠ¨å›å¤è§„åˆ™">
                    <field name="name"/>
                    <field name="account_id" invisible="1"/>
                    <field name="rule_type"/>
                    <field name="match_type"/>
                    <field name="keyword" widget="text"/>
                    <field name="reply_type"/>
                    <field name="active"/>
                    <field name="trigger_count"/>
                    <field name="last_trigger_time"/>
                    <field name="sequence" widget="handle"/>
                </tree>
            </field>
        </record>

        <!-- è‡ªåŠ¨å›å¤è§„åˆ™è¡¨å•è§†å›¾ -->
        <record id="wechat_auto_reply_form_view" model="ir.ui.view">
            <field name="name">wechat.auto.reply.form</field>
            <field name="model">wechat.auto_reply</field>
            <field name="arch" type="xml">
                <form string="è‡ªåŠ¨å›å¤è§„åˆ™">
                    <header>
                        <button name="action_test_rule" type="object" string="æµ‹è¯•è§„åˆ™" class="btn-primary"/>
                        <button name="action_preview_reply" type="object" string="é¢„è§ˆå›å¤"/>
                        <field name="active" widget="boolean_button" options='{"terminology": "archive"}'/>
                    </header>
                    
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button name="action_test_rule" type="object" class="oe_stat_button" icon="fa-search">
                                <div class="o_stat_info">
                                    <span class="o_stat_text">æµ‹è¯•è§„åˆ™</span>
                                </div>
                            </button>
                            <button name="action_preview_reply" type="object" class="oe_stat_button" icon="fa-eye">
                                <div class="o_stat_info">
                                    <span class="o_stat_text">é¢„è§ˆå›å¤</span>
                                </div>
                            </button>
                        </div>
                        
                        <group>
                            <group>
                                <field name="name"/>
                                <field name="account_id" options="{'no_create': True}" context="{'default_account_type': 'service'}"/>
                                <field name="rule_type"/>
                                <field name="sequence"/>
                                <field name="active"/>
                            </group>
                            
                            <group>
                                <field name="trigger_count" widget="progressbar" options="{'current_value': trigger_count, 'max_value': 1000, 'editable': false}"/>
                                <field name="last_trigger_time"/>
                            </group>
                        </group>
                        
                        <notebook>
                            <page string="è§¦å‘æ¡ä»¶">
                                <group>
                                    <group>
                                        <field name="match_type"/>
                                        <field name="keyword" placeholder="å¤šä¸ªå…³é”®è¯ç”¨é€—å·åˆ†éš”"/>
                                        <field name="match_all_keywords"/>
                                        <field name="case_sensitive"/>
                                    </group>
                                    
                                    <group string="æ—¶é—´é™åˆ¶">
                                        <field name="enable_time_limit"/>
                                        <field name="start_time" attrs="{'invisible': [('enable_time_limit', '=', False)]}"/>
                                        <field name="end_time" attrs="{'invisible': [('enable_time_limit', '=', False)]}"/>
                                    </group>
                                    
                                    <group string="æ ‡ç­¾é™åˆ¶">
                                        <field name="enable_tag_filter"/>
                                        <field name="tag_ids" widget="many2many_tags" 
                                               attrs="{'invisible': [('enable_tag_filter', '=', False)]}"
                                               options="{'color_field': 'color'}"/>
                                    </group>
                                </group>
                            </page>
                            
                            <page string="å›å¤å†…å®¹">
                                <group>
                                    <field name="reply_type"/>
                                    
                                    <group string="æ–‡æœ¬å›å¤" attrs="{'invisible': [('reply_type', '!=', 'text')]}">
                                        <field name="reply_content" nolabel="1" widget="html"/>
                                    </group>
                                    
                                    <group string="åª’ä½“å›å¤" attrs="{'invisible': [('reply_type', 'not in', ['image', 'voice', 'video'])]}">
                                        <field name="media_material_id" 
                                               context="{'default_material_type': reply_type}"
                                               domain="[('material_type', '=', reply_type), ('account_id', '=', account_id)]"/>
                                        <field name="media_id" attrs="{'readonly': [('media_material_id', '!=', False)]}"/>
                                    </group>
                                    
                                    <group string="å›¾æ–‡å›å¤" attrs="{'invisible': [('reply_type', '!=', 'news')]}">
                                        <field name="news_material_id" 
                                               domain="[('material_type', '=', 'news'), ('account_id', '=', account_id)]"/>
                                    </group>
                                </group>
                            </page>
                            
                            <page string="æµ‹è¯•è®°å½•">
                                <field name="message_ids" widget="mail_thread"/>
                            </page>
                        </notebook>
                    </sheet>
                </form>
            </field>
        </record>

        <!-- è‡ªåŠ¨å›å¤è§„åˆ™æœç´¢è§†å›¾ -->
        <record id="wechat_auto_reply_search_view" model="ir.ui.view">
            <field name="name">wechat.auto.reply.search</field>
            <field name="model">wechat.auto_reply</field>
            <field name="arch" type="xml">
                <search string="è‡ªåŠ¨å›å¤è§„åˆ™">
                    <field name="name"/>
                    <field name="account_id"/>
                    <field name="rule_type"/>
                    <field name="match_type"/>
                    <field name="keyword"/>
                    <field name="active"/>
                    
                    <filter string="å…³æ³¨æ—¶å›å¤" name="subscribe_rules" domain="[('rule_type', '=', 'subscribe')]"/>
                    <filter string="å…³é”®è¯å›å¤" name="keyword_rules" domain="[('rule_type', '=', 'keyword')]"/>
                    <filter string="é»˜è®¤å›å¤" name="default_rules" domain="[('rule_type', '=', 'default')]"/>
                    
                    <separator/>
                    
                    <filter string="æ´»è·ƒè§„åˆ™" name="active_rules" domain="[('active', '=', True)]"/>
                    <filter string="åœç”¨è§„åˆ™" name="inactive_rules" domain="[('active', '=', False)]"/>
                    
                    <group expand="0" string="åˆ†ç»„">
                        <filter string="æŒ‰å…¬ä¼—å·åˆ†ç»„" name="group_by_account" context="{'group_by': 'account_id'}"/>
                        <filter string="æŒ‰è§„åˆ™ç±»å‹åˆ†ç»„" name="group_by_rule_type" context="{'group_by': 'rule_type'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- è‡ªåŠ¨å›å¤è§„åˆ™åŠ¨ä½œ -->
        <record id="wechat_auto_reply_action" model="ir.actions.act_window">
            <field name="name">è‡ªåŠ¨å›å¤è§„åˆ™</field>
            <field name="res_model">wechat.auto_reply</field>
            <field name="view_mode">tree,form,kanban</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    è¿˜æ²¡æœ‰è‡ªåŠ¨å›å¤è§„åˆ™
                </p>
                <p>
                    åˆ›å»ºè‡ªåŠ¨å›å¤è§„åˆ™ï¼Œå½“ç²‰ä¸å‘é€æ¶ˆæ¯æ—¶è‡ªåŠ¨å›å¤ã€‚
                </p>
            </field>
        </record>

        <!-- èœå•é¡¹ -->
        <menuitem id="wechat_auto_reply_menu" 
                  name="è‡ªåŠ¨å›å¤" 
                  parent="wechat_platform.wechat_platform_menu" 
                  sequence="20"
                  action="wechat_auto_reply_action"/>
    </data>
</odoo>
```

#### **ä»»åŠ¡2ï¼šç´ æç®¡ç†ç•Œé¢**
```xml
<!-- file: wechat_platform/views/wechat_material_views.xml -->

<odoo>
    <data>
        <!-- ç´ æåˆ—è¡¨è§†å›¾ï¼ˆç½‘æ ¼è§†å›¾ï¼‰ -->
        <record id="wechat_material_kanban_view" model="ir.ui.view">
            <field name="name">wechat.material.kanban</field>
            <field name="model">wechat.material</field>
            <field name="arch" type="xml">
                <kanban class="o_wechat_material_kanban">
                    <field name="name"/>
                    <field name="material_type"/>
                    <field name="file_data"/>
                    <field name="media_id"/>
                    <field name="upload_time"/>
                    <field name="is_temporary"/>
                    <field name="is_expired"/>
                    <field name="tag_ids"/>
                    
                    <templates>
                        <t t-name="kanban-box">
                            <div class="oe_kanban_global_click o_wechat_material_card" t-att-data-id="record.id.raw_value">
                                <div class="o_kanban_image" t-attf-class="material-{{record.material_type.raw_value}}">
                                    <t t-if="record.material_type.raw_value == 'image' and record.file_data.raw_value">
                                        <img t-att-src="kanban_image('wechat.material', 'file_data', record.id.raw_value)" 
                                             alt="Image" class="img-fluid"/>
                                    </t>
                                    <t t-elif="record.material_type.raw_value == 'news'">
                                        <div class="news-preview">
                                            <t t-foreach="record.articles.raw_value.slice(0, 3)" t-as="article">
                                                <div class="news-item">
                                                    <h6 t-esc="article.title"/>
                                                    <small t-esc="article.digest.slice(0, 30) + '...'"/>
                                                </div>
                                            </t>
                                        </div>
                                    </t>
                                    <t t-else="">
                                        <div class="material-icon">
                                            <i t-attf-class="fa fa-{{{
                                                'image': 'file-image-o',
                                                'voice': 'file-audio-o',
                                                'video': 'file-video-o',
                                                'thumb': 'picture-o'
                                            }[record.material_type.raw_value] || 'file-o'}} fa-3x"/>
                                        </div>
                                    </t>
                                </div>
                                
                                <div class="o_kanban_card_content">
                                    <div class="o_kanban_card_header">
                                        <div class="o_kanban_card_header_title">
                                            <field name="name" widget="handle"/>
                                            <div class="material-type">
                                                <span t-attf-class="badge bg-{{{
                                                    'image': 'success',
                                                    'voice': 'warning',
                                                    'video': 'info',
                                                    'thumb': 'secondary',
                                                    'news': 'primary'
                                                }[record.material_type.raw_value]}}">
                                                    <t t-switch="record.material_type.raw_value">
                                                        <t t-case="image">å›¾ç‰‡</t>
                                                        <t t-case="voice">è¯­éŸ³</t>
                                                        <t t-case="video">è§†é¢‘</t>
                                                        <t t-case="thumb">ç¼©ç•¥å›¾</t>
                                                        <t t-case="news">å›¾æ–‡</t>
                                                    </t>
                                                </span>
                                                
                                                <t t-if="record.is_temporary.raw_value">
                                                    <span class="badge bg-warning">ä¸´æ—¶</span>
                                                </t>
                                                
                                                <t t-if="record.is_expired.raw_value">
                                                    <span class="badge bg-danger">å·²è¿‡æœŸ</span>
                                                </t>
                                            </div>
                                        </div>
                                        
                                        <div class="o_kanban_card_buttons">
                                            <button type="object" name="action_preview_material" class="btn btn-sm btn-link">
                                                <i class="fa fa-eye"/>
                                            </button>
                                            <button type="object" name="action_download_material" class="btn btn-sm btn-link">
                                                <i class="fa fa-download"/>
                                            </button>
                                            <button type="object" name="action_upload_to_wechat" class="btn btn-sm btn-link">
                                                <i class="fa fa-cloud-upload"/>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="o_kanban_card_body">
                                        <div class="material-info">
                                            <small class="text-muted">
                                                <i class="fa fa-calendar"/>
                                                <t t-esc="record.upload_time.raw_value ? moment(record.upload_time.raw_value).format('YYYY-MM-DD') : 'æœªä¸Šä¼ '"/>
                                            </small>
                                            
                                            <t t-if="record.media_id.raw_value">
                                                <small class="text-muted">
                                                    <i class="fa fa-id-card"/>
                                                    <t t-esc="record.media_id.raw_value.slice(0, 8) + '...'"/>
                                                </small>
                                            </t>
                                            
                                            <t t-if="record.file_size.raw_value">
                                                <small class="text-muted">
                                                    <i class="fa fa-hdd-o"/>
                                                    <t t-esc="record.file_size.raw_value + ' KB'"/>
                                                </small>
                                            </t>
                                        </div>
                                        
                                        <div class="material-tags">
                                            <t t-foreach="record.tag_ids.raw_value" t-as="tag">
                                                <span class="tag" t-att-style="'background-color: ' + tag.color + ';'">
                                                    <t t-esc="tag.name"/>
                                                </span>
                                            </t>
                                        </div>
                                        
                                        <div class="material-stats">
                                            <small>
                                                <i class="fa fa-download"/>
                                                <t t-esc="record.usage_count.raw_value"/> æ¬¡ä½¿ç”¨
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- ç´ æè¡¨å•è§†å›¾ -->
        <record id="wechat_material_form_view" model="ir.ui.view">
            <field name="name">wechat.material.form</field>
            <field name="model">wechat.material</field>
            <field name="arch" type="xml">
                <form string="å¾®ä¿¡ç´ æ">
                    <header>
                        <button name="action_upload_to_wechat" type="object" string="ä¸Šä¼ åˆ°å¾®ä¿¡" class="btn-primary"/>
                        <button name="download_from_wechat" type="object" string="ä»å¾®ä¿¡ä¸‹è½½"/>
                        <button name="action_preview_material" type="object" string="é¢„è§ˆ"/>
                        <button name="action_download_material" type="object" string="ä¸‹è½½"/>
                    </header>
                    
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button name="action_upload_to_wechat" type="object" class="oe_stat_button" icon="fa-cloud-upload">
                                <div class="o_stat_info">
                                    <span class="o_stat_text">ä¸Šä¼ åˆ°å¾®ä¿¡</span>
                                </div>
                            </button>
                            <button name="action_preview_material" type="object" class="oe_stat_button" icon="fa-eye">
                                <div class="o_stat_info">
                                    <span class="o_stat_text">é¢„è§ˆ</span>
                                </div>
                            </button>
                        </div>
                        
                        <group>
                            <group>
                                <field name="name"/>
                                <field name="account_id" options="{'no_create': True}"/>
                                <field name="material_type"/>
                                <field name="is_temporary"/>
                                
                                <field name="upload_time" attrs="{'readonly': True}"/>
                                <field name="expire_time" attrs="{'readonly': True, 'invisible': [('is_temporary', '=', False)]}"/>
                                <field name="is_expired" attrs="{'readonly': True}"/>
                            </group>
                            
                            <group>
                                <field name="media_id" attrs="{'readonly': True}"/>
                                <field name="media_url" attrs="{'readonly': True}"/>
                                <field name="file_name" attrs="{'readonly': True}"/>
                                <field name="file_size" widget="integer" attrs="{'readonly': True}"/>
                                <field name="usage_count" widget="integer" attrs="{'readonly': True}"/>
                                <field name="last_used_time" attrs="{'readonly': True}"/>
                            </group>
                        </group>
                        
                        <notebook>
                            <page string="æ–‡ä»¶å†…å®¹" attrs="{'invisible': [('material_type', 'in', ['news'])]}">
                                <group>
                                    <group>
                                        <field name="file_data" filename="file_name" widget="binary" 
                                               attrs="{'required': [('id', '=', False), ('material_type', 'not in', ['news'])]}"/>
                                    </group>
                                    
                                    <group attrs="{'invisible': [('material_type', '!=', 'video')]}" string="è§†é¢‘ä¿¡æ¯">
                                        <field name="title"/>
                                        <field name="introduction" widget="textarea"/>
                                    </group>
                                </group>
                            </page>
                            
                            <page string="å›¾æ–‡å†…å®¹" attrs="{'invisible': [('material_type', '!=', 'news')]}">
                                <field name="articles">
                                    <tree editable="bottom">
                                        <field name="sequence" widget="handle"/>
                                        <field name="title"/>
                                        <field name="author"/>
                                        <field name="digest"/>
                                        <field name="url" widget="url"/>
                                        <field name="show_cover_pic"/>
                                    </tree>
                                    
                                    <form>
                                        <group>
                                            <group>
                                                <field name="title"/>
                                                <field name="author"/>
                                                <field name="digest" widget="textarea" placeholder="æ‘˜è¦ï¼Œä»…æœ‰å•å›¾æ–‡æ¶ˆæ¯æ‰æ˜¾ç¤ºæ‘˜è¦"/>
                                                <field name="content_source_url" widget="url"/>
                                            </group>
                                            
                                            <group>
                                                <field name="thumb_image" filename="thumb_media_id" widget="binary"/>
                                                <field name="thumb_media_id" attrs="{'readonly': True}"/>
                                                <field name="thumb_url" widget="url" attrs="{'readonly': True}"/>
                                                
                                                <button name="upload_thumb_image" type="object" string="ä¸Šä¼ å°é¢å›¾ç‰‡" class="btn-secondary"/>
                                            </group>
                                        </group>
                                        
                                        <group>
                                            <field name="content" widget="html" nolabel="1"/>
                                        </group>
                                        
                                        <group>
                                            <field name="show_cover_pic"/>
                                            <field name="need_open_comment"/>
                                            <field name="only_fans_can_comment"/>
                                        </group>
                                    </form>
                                </field>
                            </page>
                            
                            <page string="æ ‡ç­¾">
                                <field name="tag_ids" widget="many2many_tags" options="{'color_field': 'color'}"/>
                            </page>
                            
                            <page string="ä½¿ç”¨è®°å½•">
                                <field name="message_ids" widget="mail_thread"/>
                            </page>
                        </notebook>
                    </sheet>
                </form>
            </field>
        </record>

        <!-- ç´ ææœç´¢è§†å›¾ -->
        <record id="wechat_material_search_view" model="ir.ui.view">
            <field name="name">wechat.material.search</field>
            <field name="model">wechat.material</field>
            <field name="arch" type="xml">
                <search string="å¾®ä¿¡ç´ æ">
                    <field name="name"/>
                    <field name="account_id"/>
                    <field name="material_type"/>
                    
                    <filter string="å›¾ç‰‡ç´ æ" name="image_materials" domain="[('material_type', '=', 'image')]"/>
                    <filter string="è¯­éŸ³ç´ æ" name="voice_materials" domain="[('material_type', '=', 'voice')]"/>
                    <filter string="è§†é¢‘ç´ æ" name="video_materials" domain="[('material_type', '=', 'video')]"/>
                    <filter string="å›¾æ–‡ç´ æ" name="news_materials" domain="[('material_type', '=', 'news')]"/>
                    
                    <separator/>
                    
                    <filter string="ä¸´æ—¶ç´ æ" name="temporary_materials" domain="[('is_temporary', '=', True)]"/>
                    <filter string="æ°¸ä¹…ç´ æ" name="permanent_materials" domain="[('is_temporary', '=', False)]"/>
                    <filter string="å·²è¿‡æœŸç´ æ" name="expired_materials" domain="[('is_expired', '=', True)]"/>
                    
                    <separator/>
                    
                    <filter string="æœªä¸Šä¼ " name="not_uploaded" domain="[('media_id', '=', False)]"/>
                    <filter string="å·²ä¸Šä¼ " name="uploaded" domain="[('media_id', '!=', False)]"/>
                    
                    <group expand="0" string="åˆ†ç»„">
                        <filter string="æŒ‰ç±»å‹åˆ†ç»„" name="group_by_type" context="{'group_by': 'material_type'}"/>
                        <filter string="æŒ‰å…¬ä¼—å·åˆ†ç»„" name="group_by_account" context="{'group_by': 'account_id'}"/>
                        <filter string="æŒ‰æ ‡ç­¾åˆ†ç»„" name="group_by_tags" context="{'group_by': 'tag_ids'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!-- ç´ æåŠ¨ä½œ -->
        <record id="wechat_material_action" model="ir.actions.act_window">
            <field name="name">å¾®ä¿¡ç´ æ</field>
            <field name="res_model">wechat.material</field>
            <field name="view_mode">kanban,tree,form</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    è¿˜æ²¡æœ‰å¾®ä¿¡ç´ æ
                </p>
                <p>
                    ä¸Šä¼ å›¾ç‰‡ã€è¯­éŸ³ã€è§†é¢‘æˆ–åˆ›å»ºå›¾æ–‡ç´ æï¼Œç”¨äºè‡ªåŠ¨å›å¤ã€èœå•ç­‰ã€‚
                </p>
            </field>
        </record>

        <!-- æ‰¹é‡ä¸Šä¼ å‘å¯¼ -->
        <record id="wechat_material_upload_wizard_form_view" model="ir.ui.view">
            <field name="name">wechat.material.upload.wizard.form</field>
            <field name="model">wechat.material.upload</field>
            <field name="arch" type="xml">
                <form string="ä¸Šä¼ ç´ æåˆ°å¾®ä¿¡">
                    <footer>
                        <button name="action_upload" type="object" string="ä¸Šä¼ " class="btn-primary"/>
                        <button special="cancel" string="å–æ¶ˆ" class="btn-secondary"/>
                    </footer>
                    
                    <sheet>
                        <group>
                            <group>
                                <field name="material_id" readonly="1"/>
                                <field name="upload_as_temporary" string="ä½œä¸ºä¸´æ—¶ç´ æä¸Šä¼ "/>
                                <field name="overwrite_existing" string="è¦†ç›–ç°æœ‰ç´ æ" attrs="{'invisible': [('upload_as_temporary', '=', True)]}"/>
                            </group>
                            
                            <group>
                                <field name="status" widget="html" nolabel="1"/>
                            </group>
                        </group>
                    </sheet>
                </form>
            </field>
        </record>
    </data>
</odoo>
```

#### **ä»»åŠ¡3ï¼šCSSæ ·å¼ä¼˜åŒ–**
```css
/* file: wechat_platform/static/src/css/wechat_material.css */

/* ç´ æç®¡ç†æ ·å¼ */
.o_wechat_material_kanban {
    padding: 16px;
}

.o_wechat_material_card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    overflow: hidden;
    transition: all 0.3s ease;
    background: white;
}

.o_wechat_material_card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.material-image .o_kanban_image {
    height: 160px;
    overflow: hidden;
    background: #f8f9fa;
}

.material-image .o_kanban_image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.material-voice .o_kanban_image,
.material-video .o_kanban_image,
.material-thumb .o_kanban_image {
    height: 120px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
}

.material-news .o_kanban_image {
    height: 200px;
    background: #f8f9fa;
    overflow-y: auto;
}

.news-preview {
    padding: 12px;
}

.news-item {
    padding: 8px;
    margin-bottom: 8px;
    background: white;
    border-radius: 4px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.news-item h6 {
    margin-bottom: 4px;
    font-size: 12px;
    line-height: 1.2;
    color: #333;
}

.news-item small {
    color: #666;
    font-size: 10px;
    line-height: 1.2;
}

.material-icon {
    color: rgba(255, 255, 255, 0.8);
}

.o_kanban_card_content {
    padding: 12px;
}

.o_kanban_card_header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
}

.o_kanban_card_header_title {
    flex: 1;
    min-width: 0;
    margin-right: 8px;
}

.o_kanban_card_header_title .material-type {
    margin-top: 4px;
}

.o_kanban_card_header_title .badge {
    margin-right: 4px;
    font-size: 10px;
    padding: 2px 6px;
}

.o_kanban_card_buttons {
    display: flex;
    gap: 4px;
}

.o_kanban_card_buttons .btn {
    padding: 2px 6px;
    font-size: 12px;
}

.material-info {
    margin-bottom: 8px;
}

.material-info small {
    display: block;
    margin-bottom: 2px;
    color: #666;
}

.material-info .fa {
    margin-right: 4px;
    width: 16px;
    text-align: center;
}

.material-tags {
    margin-bottom: 8px;
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
}

.material-tags .tag {
    padding: 2px 6px;
    border-radius: 12px;
    font-size: 10px;
    color: white;
    background: #6c757d;
}

.material-stats {
    font-size: 12px;
    color: #666;
}

.material-stats .fa {
    margin-right: 4px;
}

/* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
.o_wechat_file_upload {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 40px 20px;
    text-align: center;
    background: #f8f9fa;
    transition: all 0.3s ease;
    cursor: pointer;
}

.o_wechat_file_upload:hover {
    border-color: #007bff;
    background: #e7f3ff;
}

.o_wechat_file_upload i {
    font-size: 48px;
    color: #6c757d;
    margin-bottom: 16px;
}

.o_wechat_file_upload h4 {
    color: #495057;
    margin-bottom: 8px;
}

.o_wechat_file_upload p {
    color: #6c757d;
    font-size: 14px;
}

/* ç´ æç±»å‹æŒ‡ç¤ºå™¨ */
.material-type-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 8px;
}

.material-type-image { background: #28a745; }
.material-type-voice { background: #ffc107; }
.material-type-video { background: #17a2b8; }
.material-type-thumb { background: #6c757d; }
.material-type-news { background: #007bff; }

/* ç´ æä¸Šä¼ è¿›åº¦ */
.upload-progress {
    margin: 20px 0;
}

.upload-progress .progress {
    height: 20px;
    margin-bottom: 8px;
}

.upload-progress .progress-text {
    font-size: 12px;
    color: #666;
    text-align: center;
}

/* ç´ æé¢„è§ˆæ¨¡æ€æ¡† */
.material-preview-modal .modal-dialog {
    max-width: 800px;
}

.material-preview-modal .modal-body {
    padding: 0;
}

.material-preview-modal .preview-container {
    max-height: 80vh;
    overflow-y: auto;
}

.material-preview-modal .preview-image img {
    width: 100%;
    height: auto;
}

.material-preview-modal .prevoice-audio {
    width: 100%;
}

.material-preview-modal .preview-video {
    width: 100%;
}

.material-preview-modal .preview-news {
    padding: 20px;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .o_wechat_material_card {
        margin-bottom: 16px;
    }
    
    .material-image .o_kanban_image {
        height: 120px;
    }
    
    .material-news .o_kanban_image {
        height: 150px;
    }
}
```

### **å¾®ä¿¡å¼€å‘ä¸“å®¶å…·ä½“ä»»åŠ¡ï¼š**

#### **ä»»åŠ¡1ï¼šé«˜çº§æ¶ˆæ¯å¤„ç†å¼•æ“**
```python
# file: wechat_platform/lib/advanced_message_processor.py

import asyncio
import json
import re
import logging
from typing import Dict, List, Optional, Any, Tuple
from datetime import datetime, timedelta
from collections import defaultdict
import hashlib
import time

_logger = logging.getLogger(__name__)

class AdvancedMessageProcessor:
    """é«˜çº§æ¶ˆæ¯å¤„ç†å™¨"""
    
    def __init__(self):
        self.rules_cache = {}  # ç¼“å­˜è§„åˆ™
        self.intent_classifier = IntentClassifier()
        self.sentiment_analyzer = SentimentAnalyzer()
        self.conversation_manager = ConversationManager()
        
    async def process_message(self, account_id: int, message_data: Dict) -> Dict:
        """å¤„ç†æ¶ˆæ¯ï¼ˆé«˜çº§ç‰ˆï¼‰"""
        try:
            # 1. æ¶ˆæ¯é¢„å¤„ç†
            processed_message = await self._preprocess_message(message_data)
            
            # 2. æ„å›¾è¯†åˆ«
            intent = await self.intent_classifier.classify(processed_message)
            processed_message['intent'] = intent
            
            # 3. æƒ…æ„Ÿåˆ†æ
            sentiment = await self.sentiment_analyzer.analyze(processed_message)
            processed_message['sentiment'] = sentiment
            
            # 4. ä¸Šä¸‹æ–‡ç®¡ç†
            context = await self.conversation_manager.get_context(
                account_id, 
                processed_message['from_user_name']
            )
            processed_message['context'] = context
            
            # 5. æ™ºèƒ½å›å¤
            reply = await self._generate_intelligent_reply(
                account_id, processed_message, context
            )
            
            # 6. æ›´æ–°ä¸Šä¸‹æ–‡
            await self.conversation_manager.update_context(
                account_id,
                processed_message['from_user_name'],
                processed_message,
                reply
            )
            
            return {
                'success': True,
                'message': processed_message,
                'reply': reply,
                'intent': intent,
                'sentiment': sentiment,
            }
            
        except Exception as e:
            _logger.error(f"é«˜çº§æ¶ˆæ¯å¤„ç†å¤±è´¥: {str(e)}")
            return {
                'success': False,
                'error': str(e),
                'reply': None,
            }
    
    async def _preprocess_message(self, message_data: Dict) -> Dict:
        """æ¶ˆæ¯é¢„å¤„ç†"""
        processed = message_data.copy()
        
        # æ–‡æœ¬æ¶ˆæ¯çš„é¢„å¤„ç†
        if processed.get('msg_type') == 'text' and processed.get('content'):
            content = processed['content']
            
            # å»é™¤å¤šä½™ç©ºç™½
            content = ' '.join(content.split())
            
            # æ ‡å‡†åŒ–æ ‡ç‚¹
            content = content.replace('ï¼Œ', ',').replace('ã€‚', '.')
            
            # æå–å®ä½“
            processed['entities'] = self._extract_entities(content)
            
            # æå–å…³é”®è¯
            processed['keywords'] = self._extract_keywords(content)
            
            # æƒ…æ„Ÿè¯æ ‡è®°
            processed['sentiment_words'] = self._extract_sentiment_words(content)
            
            processed['content'] = content
        
        return processed
    
    def _extract_entities(self, text: str) -> List[Dict]:
        """æå–å®ä½“"""
        entities = []
        
        # æå–æ—¶é—´
        time_patterns = [
            r'(\d{1,2})ç‚¹(\d{1,2})åˆ†?',
            r'(\d{1,2}):(\d{1,2})',
            r'ä»Šå¤©|æ˜å¤©|åå¤©|æ˜¨å¤©',
            r'ä¸Šåˆ|ä¸‹åˆ|æ™šä¸Š|å‡Œæ™¨',
            r'\d{1,2}æœˆ\d{1,2}æ—¥',
        ]
        
        for pattern in time_patterns:
            matches = re.finditer(pattern, text)
            for match in matches:
                entities.append({
                    'type': 'time',
                    'value': match.group(),
                    'start': match.start(),
                    'end': match.end(),
                })
        
        # æå–æ•°å­—
        number_matches = re.finditer(r'\d+(\.\d+)?', text)
        for match in number_matches:
            entities.append({
                'type': 'number',
                'value': match.group(),
                'start': match.start(),
                'end': match.end(),
            })
        
        return entities
    
    def _extract_keywords(self, text: str) -> List[str]:
        """æå–å…³é”®è¯"""
        # ç®€å•çš„å…³é”®è¯æå–ï¼ˆå®é™…åº”è¯¥ç”¨TF-IDFç­‰ç®—æ³•ï¼‰
        words = re.findall(r'[\u4e00-\u9fa5]+|[a-zA-Z]+', text)
        
        # è¿‡æ»¤åœç”¨è¯
        stop_words = {'çš„', 'äº†', 'åœ¨', 'æ˜¯', 'æˆ‘', 'æœ‰', 'å’Œ', 'å°±', 'ä¸', 'äºº', 'éƒ½', 'ä¸€', 'ä¸€ä¸ª', 'ä¸Š', 'ä¹Ÿ', 'å¾ˆ', 'åˆ°', 'è¯´', 'è¦', 'å»', 'ä½ ', 'ä¼š', 'ç€', 'æ²¡æœ‰', 'çœ‹', 'å¥½', 'è‡ªå·±', 'è¿™'}
        keywords = [word for word in words if word not in stop_words and len(word) > 1]
        
        return keywords[:10]  # è¿”å›å‰10ä¸ªå…³é”®è¯
    
    def _extract_sentiment_words(self, text: str) -> List[Dict]:
        """æå–æƒ…æ„Ÿè¯"""
        # ç®€å•çš„æƒ…æ„Ÿè¯è¯å…¸
        positive_words = {'å¥½', 'å¾ˆå¥½', 'éå¸¸å¥½', 'æ£’', 'ä¸é”™', 'å–œæ¬¢', 'çˆ±', 'å¼€å¿ƒ', 'é«˜å…´', 'æ»¡æ„', 'èµ'}
        negative_words = {'ä¸å¥½', 'å¾ˆå·®', 'è®¨åŒ', 'æ¨', 'ç”Ÿæ°”', 'æ„¤æ€’', 'å¤±æœ›', 'ä¼¤å¿ƒ', 'ç³Ÿç³•', 'å·®åŠ²'}
        
        words = text.split()
        sentiment_words = []
        
        for word in words:
            if word in positive_words:
                sentiment_words.append({'word': word, 'polarity': 'positive'})
            elif word in negative_words:
                sentiment_words.append({'word': word, 'polarity': 'negative'})
        
        return sentiment_words
    
    async def _generate_intelligent_reply(self, account_id: int, 
                                         message: Dict, context: Dict) -> Optional[Dict]:
        """ç”Ÿæˆæ™ºèƒ½å›å¤"""
        msg_type = message.get('msg_type')
        
        if msg_type == 'text':
            return await self._generate_text_reply(account_id, message, context)
        elif msg_type == 'event':
            return await self._generate_event_reply(account_id, message, context)
        
        return None
    
    async def _generate_text_reply(self, account_id: int, 
                                  message: Dict, context: Dict) -> Optional[Dict]:
        """ç”Ÿæˆæ–‡æœ¬å›å¤"""
        content = message.get('content', '')
        intent = message.get('intent', {})
        
        # 1. é¦–å…ˆå°è¯•åŒ¹é…å…³é”®è¯è§„åˆ™
        from odoo.api import Environment
        env = Environment(self.env.cr, self.env.uid, self.env.context)
        
        rule = env['wechat.auto_reply'].find_matching_rule(
            account_id, content, rule_type='keyword'
        )
        
        if rule:
            reply_content = rule.get_reply_content()
            return {
                'type': 'rule_match',
                'rule_id': rule.id,
                'content': reply_content,
            }
        
        # 2. æ ¹æ®æ„å›¾ç”Ÿæˆå›å¤
        intent_type = intent.get('type')
        
        if intent_type == 'greeting':
            return await self._generate_greeting_reply(message, context)
        elif intent_type == 'question':
            return await self._generate_question_reply(message, context)
        elif intent_type == 'complaint':
            return await self._generate_complaint_reply(message, context)
        elif intent_type == 'praise':
            return await self._generate_praise_reply(message, context)
        
        # 3. ä½¿ç”¨å¯¹è¯å†å²ç”Ÿæˆå›å¤
        if context and context.get('history'):
            return await self._generate_contextual_reply(message, context)
        
        # 4. é»˜è®¤å›å¤
        default_rule = env['wechat.auto_reply'].find_matching_rule(
            account_id, '', rule_type='default'
        )
        
        if default_rule:
            reply_content = default_rule.get_reply_content()
            return {
                'type': 'default_rule',
                'rule_id': default_rule.id,
                'content': reply_content,
            }
        
        return None
    
    async def _generate_greeting_reply(self, message: Dict, context: Dict) -> Dict:
        """ç”Ÿæˆé—®å€™å›å¤"""
        greetings = [
            "æ‚¨å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ",
            "å—¨ï¼å¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ï¼",
            "æ¬¢è¿å…‰ä¸´ï¼è¯·é—®æœ‰ä»€ä¹ˆéœ€è¦ï¼Ÿ",
            "æ‚¨å¥½ï¼Œæˆ‘æ˜¯å®¢æœåŠ©æ‰‹ï¼Œéšæ—¶ä¸ºæ‚¨æœåŠ¡ï¼",
        ]
        
        import random
        reply_text = random.choice(greetings)
        
        return {
            'type': 'greeting',
            'content': {'msg_type': 'text', 'content': reply_text},
        }
    
    async def _generate_question_reply(self, message: Dict, context: Dict) -> Dict:
        """ç”Ÿæˆé—®é¢˜å›å¤"""
        # è¿™é‡Œå¯ä»¥é›†æˆçŸ¥è¯†åº“æˆ–FAQç³»ç»Ÿ
        return {
            'type': 'question',
            'content': {'msg_type': 'text', 'content': "è¿™ä¸ªé—®é¢˜æˆ‘éœ€è¦æŸ¥è¯¢ä¸€ä¸‹ï¼Œè¯·ç¨ç­‰..."},
        }
    
    async def _generate_complaint_reply(self, message: Dict, context: Dict) -> Dict:
        """ç”ŸæˆæŠ•è¯‰å›å¤"""
        sentiment = message.get('sentiment', {})
        
        if sentiment.get('score', 0) < -0.5:
            reply = "éå¸¸æŠ±æ­‰ç»™æ‚¨å¸¦æ¥ä¸å¥½çš„ä½“éªŒï¼æˆ‘ä»¬çš„å®¢æœä¼šå°½å¿«è”ç³»æ‚¨è§£å†³é—®é¢˜ã€‚"
        else:
            reply = "å¯¹ä¸èµ·è®©æ‚¨ä¸æ»¡æ„äº†ï¼Œæˆ‘ä»¬ä¼šè®¤çœŸå¤„ç†æ‚¨çš„é—®é¢˜ã€‚"
        
        return {
            'type': 'complaint',
            'content': {'msg_type': 'text', 'content': reply},
        }
    
    async def _generate_praise_reply(self, message: Dict, context: Dict) -> Dict:
        """ç”Ÿæˆè¡¨æ‰¬å›å¤"""
        replies = [
            "è°¢è°¢æ‚¨çš„å¤¸å¥–ï¼æˆ‘ä»¬ä¼šç»§ç»­åŠªåŠ›çš„ï¼",
            "æ‚¨çš„è®¤å¯æ˜¯æˆ‘ä»¬æœ€å¤§çš„åŠ¨åŠ›ï¼",
            "éå¸¸æ„Ÿè°¢ï¼æˆ‘ä»¬ä¼šåšå¾—æ›´å¥½ï¼",
        ]
        
        import random
        reply_text = random.choice(replies)
        
        return {
            'type': 'praise',
            'content': {'msg_type': 'text', 'content': reply_text},
        }
    
    async def _generate_contextual_reply(self, message: Dict, context: Dict) -> Dict:
        """ç”Ÿæˆä¸Šä¸‹æ–‡ç›¸å…³å›å¤"""
        # åŸºäºå¯¹è¯å†å²çš„ç®€å•å›å¤
        history = context.get('history', [])[-3:]  # æœ€è¿‘3æ¡å†å²
        
        if not history:
            return None
        
        # ç®€å•çš„ä¸Šä¸‹æ–‡å¤„ç†ï¼šå›å¤æœ€åä¸€ä¸ªé—®é¢˜
        last_message = history[-1]
        
        if last_message.get('msg_type') == 'text':
            content = last_message.get('content', '')
            
            # æ£€æŸ¥æ˜¯å¦åœ¨æé—®
            question_words = {'å—', 'ä¹ˆ', 'å‘¢', 'ï¼Ÿ', '?', 'ä»€ä¹ˆ', 'æ€ä¹ˆ', 'å¦‚ä½•', 'ä¸ºä»€ä¹ˆ'}
            
            if any(word in content for word in question_words):
                return {
                    'type': 'contextual',
                    'content': {'msg_type': 'text', 'content': "å…³äºæ‚¨åˆšæ‰çš„é—®é¢˜..."},
                }
        
        return None
    
    async def _generate_event_reply(self, account_id: int, 
                                   message: Dict, context: Dict) -> Optional[Dict]:
        """ç”Ÿæˆäº‹ä»¶å›å¤"""
        event_type = message.get('event')
        
        if event_type == 'subscribe':
            # å…³æ³¨äº‹ä»¶
            from odoo.api import Environment
            env = Environment(self.env.cr, self.env.uid, self.env.context)
            
            rule = env['wechat.auto_reply'].find_matching_rule(
                account_id, '', rule_type='subscribe'
            )
            
            if rule:
                reply_content = rule.get_reply_content()
                return {
                    'type': 'subscribe',
                    'rule_id': rule.id,
                    'content': reply_content,
                }
        
        return None


class IntentClassifier:
    """æ„å›¾åˆ†ç±»å™¨"""
    
    def __init__(self):
        self.intent_patterns = {
            'greeting': [
                r'ä½ å¥½|æ‚¨å¥½|å—¨|hello|hi',
                r'æ—©ä¸Šå¥½|ä¸‹åˆå¥½|æ™šä¸Šå¥½',
                r'åœ¨å—|åœ¨ä¹ˆ|æœ‰äººå—',
            ],
            'question': [
                r'æ€ä¹ˆ|å¦‚ä½•|æ€æ ·',
                r'ä¸ºä»€ä¹ˆ|ä¸ºä½•',
                r'ä»€ä¹ˆ|å“ªäº›|å“ªä¸ª',
                r'ï¼Ÿ|\?|å—|ä¹ˆ|å‘¢',
            ],
            'complaint': [
                r'æŠ•è¯‰|æŠ±æ€¨|ä¸æ»¡æ„|ä¸å¥½|å·®|ç³Ÿç³•',
                r'é—®é¢˜|æ•…éšœ|é”™è¯¯|bug',
                r'æ…¢|å¡|å»¶è¿Ÿ',
            ],
            'praise': [
                r'å¥½|å¾ˆå¥½|éå¸¸å¥½|æ£’|ä¼˜ç§€|èµ',
                r'å–œæ¬¢|æ»¡æ„|é«˜å…´|å¼€å¿ƒ',
                r'è°¢è°¢|æ„Ÿè°¢|è¾›è‹¦äº†',
            ],
            'purchase': [
                r'ä¹°|è´­ä¹°|ä¸‹å•|è®¢å•',
                r'ä»·æ ¼|ä»·é’±|å¤šå°‘é’±|æŠ¥ä»·',
                r'ä¼˜æƒ |æŠ˜æ‰£|æ´»åŠ¨|ä¿ƒé”€',
            ],
            'support': [
                r'å¸®åŠ©|æ”¯æŒ|å®¢æœ|äººå·¥',
                r'è”ç³»|ç”µè¯|å·ç ',
                r'å’¨è¯¢|è¯¢é—®',
            ],
        }
    
    async def classify(self, message: Dict) -> Dict:
        """åˆ†ç±»æ„å›¾"""
        if message.get('msg_type') != 'text':
            return {'type': 'unknown', 'confidence': 0.0}
        
        content = message.get('content', '').lower()
        scores = {}
        
        # è®¡ç®—æ¯ä¸ªæ„å›¾çš„åˆ†æ•°
        for intent_type, patterns in self.intent_patterns.items():
            score = 0.0
            
            for pattern in patterns:
                matches = re.findall(pattern, content)
                if matches:
                    score += len(matches) * 0.1
            
            scores[intent_type] = min(score, 1.0)  # é™åˆ¶æœ€å¤§åˆ†æ•°ä¸º1
        
        # æ‰¾å‡ºæœ€é«˜åˆ†æ•°çš„æ„å›¾
        if scores:
            best_intent = max(scores.items(), key=lambda x: x[1])
            if best_intent[1] > 0.1:  # é˜ˆå€¼
                return {
                    'type': best_intent[0],
                    'confidence': best_intent[1],
                    'all_scores': scores,
                }
        
        return {'type': 'unknown', 'confidence': 0.0, 'all_scores': scores}


class SentimentAnalyzer:
    """æƒ…æ„Ÿåˆ†æå™¨"""
    
    def __init__(self):
        # ç®€å•çš„æƒ…æ„Ÿè¯å…¸
        self.positive_words = {
            'å¥½', 'å¾ˆå¥½', 'éå¸¸å¥½', 'æ£’', 'ä¸é”™', 'å–œæ¬¢', 'çˆ±', 'å¼€å¿ƒ', 'é«˜å…´', 
            'æ»¡æ„', 'èµ', 'ä¼˜ç§€', 'å®Œç¾', 'æ¼‚äº®', 'ç¾ä¸½', 'å¼ºå¤§', 'å¿«', 'æ–¹ä¾¿',
            'ç®€å•', 'å®¹æ˜“', 'ä¾¿å®œ', 'å®æƒ ', 'è¶…å€¼', 'æ„Ÿè°¢', 'è°¢è°¢', 'è¾›è‹¦',
        }
        
        self.negative_words = {
            'ä¸å¥½', 'å¾ˆå·®', 'ç³Ÿç³•', 'å·®åŠ²', 'è®¨åŒ', 'æ¨', 'ç”Ÿæ°”', 'æ„¤æ€’', 'å¤±æœ›',
            'ä¼¤å¿ƒ', 'éš¾è¿‡', 'æ…¢', 'å¡', 'å»¶è¿Ÿ', 'å¤æ‚', 'å›°éš¾', 'éš¾ç”¨', 'è´µ',
            'æ˜‚è´µ', 'é—®é¢˜', 'é”™è¯¯', 'bug', 'æ•…éšœ', 'å', 'çƒ‚', 'å·®',
        }
        
        # ç¨‹åº¦å‰¯è¯
        self.intensifiers = {
            'å¾ˆ': 1.2, 'éå¸¸': 1.5, 'ç‰¹åˆ«': 1.5, 'æå…¶': 1.8, 'ååˆ†': 1.3,
            'å¤ª': 1.4, 'è¶…çº§': 1.6, 'æœ‰ç‚¹': 0.8, 'ç¨å¾®': 0.7, 'ç•¥': 0.6,
            'ä¸': -1.0, 'æ²¡': -1.0, 'æ— ': -1.0,
        }
    
    async def analyze(self, message: Dict) -> Dict:
        """åˆ†ææƒ…æ„Ÿ"""
        if message.get('msg_type') != 'text':
            return {'polarity': 'neutral', 'score': 0.0}
        
        content = message.get('content', '')
        words = re.findall(r'[\u4e00-\u9fa5]+', content)
        
        score = 0.0
        positive_count = 0
        negative_count = 0
        
        for i, word in enumerate(words):
            word_score = 0.0
            intensifier = 1.0
            
            # æ£€æŸ¥ç¨‹åº¦å‰¯è¯
            if i > 0:
                prev_word = words[i-1]
                if prev_word in self.intensifiers:
                    intensifier = self.intensifiers[prev_word]
            
            # æ£€æŸ¥æƒ…æ„Ÿè¯
            if word in self.positive_words:
                word_score = 1.0 * intensifier
                positive_count += 1
            elif word in self.negative_words:
                word_score = -1.0 * intensifier
                negative_count += 1
            
            score += word_score
        
        # å½’ä¸€åŒ–åˆ†æ•°
        if len(words) > 0:
            score = score / len(words)
        
        # ç¡®å®šæƒ…æ„Ÿææ€§
        if score > 0.1:
            polarity = 'positive'
        elif score < -0.1:
            polarity = 'negative'
        else:
            polarity = 'neutral'
        
        return {
            'polarity': polarity,
            'score': score,
            'positive_count': positive_count,
            'negative_count': negative_count,
            'total_words': len(words),
        }


class ConversationManager:
    """å¯¹è¯ç®¡ç†å™¨"""
    
    def __init__(self):
        self.conversations = defaultdict(list)  # {conversation_id: [messages]}
        self.user_contexts = {}  # {user_id: context}
        
    async def get_context(self, account_id: int, openid: str) -> Dict:
        """è·å–å¯¹è¯ä¸Šä¸‹æ–‡"""
        conversation_id = self._get_conversation_id(account_id, openid)
        
        if conversation_id in self.conversations:
            messages = self.conversations[conversation_id][-10:]  # æœ€è¿‘10æ¡æ¶ˆæ¯
        else:
            messages = []
        
        # è·å–ç”¨æˆ·ä¸Šä¸‹æ–‡
        user_context = self.user_contexts.get(conversation_id, {})
        
        return {
            'conversation_id': conversation_id,
            'history': messages,
            'user_context': user_context,
            'message_count': len(messages),
            'last_active': datetime.now().isoformat() if messages else None,
        }
    
    async def update_context(self, account_id: int, openid: str, 
                            message: Dict, reply: Optional[Dict]) -> None:
        """æ›´æ–°å¯¹è¯ä¸Šä¸‹æ–‡"""
        conversation_id = self._get_conversation_id(account_id, openid)
        
        # æ·»åŠ æ¶ˆæ¯åˆ°å†å²
        message_record = {
            'timestamp': datetime.now().isoformat(),
            'msg_type': message.get('msg_type'),
            'content': message.get('content'),
            'direction': 'in',
            'intent': message.get('intent', {}),
            'sentiment': message.get('sentiment', {}),
        }
        
        self.conversations[conversation_id].append(message_record)
        
        # æ·»åŠ å›å¤åˆ°å†å²
        if reply and reply.get('content'):
            reply_record = {
                'timestamp': datetime.now().isoformat(),
                'msg_type': reply['content'].get('msg_type'),
                'content': reply['content'].get('content'),
                'direction': 'out',
                'reply_type': reply.get('type'),
            }
            
            self.conversations[conversation_id].append(reply_record)
        
        # é™åˆ¶å†å²é•¿åº¦
        if len(self.conversations[conversation_id]) > 50:
            self.conversations[conversation_id] = self.conversations[conversation_id][-50:]
        
        # æ›´æ–°ç”¨æˆ·ä¸Šä¸‹æ–‡
        self._update_user_context(conversation_id, message, reply)
    
    def _get_conversation_id(self, account_id: int, openid: str) -> str:
        """ç”Ÿæˆå¯¹è¯ID"""
        return f"{account_id}_{openid}"
    
    def _update_user_context(self, conversation_id: str, 
                            message: Dict, reply: Optional[Dict]) -> None:
        """æ›´æ–°ç”¨æˆ·ä¸Šä¸‹æ–‡"""
        if conversation_id not in self.user_contexts:
            self.user_contexts[conversation_id] = {
                'topics': set(),
                'intents': [],
                'sentiments': [],
                'last_update': datetime.now().isoformat(),
            }
        
        context = self.user_contexts[conversation_id]
        
        # æ›´æ–°ä¸»é¢˜
        if 'keywords' in message:
            for keyword in message['keywords'][:3]:
                context['topics'].add(keyword)
        
        # æ›´æ–°æ„å›¾å†å²
        intent = message.get('intent', {}).get('type')
        if intent:
            context['intents'].append(intent)
            if len(context['intents']) > 10:
                context['intents'] = context['intents'][-10:]
        
        # æ›´æ–°æƒ…æ„Ÿå†å²
        sentiment = message.get('sentiment', {}).get('polarity')
        if sentiment:
            context['sentiments'].append(sentiment)
            if len(context['sentiments']) > 10:
                context['sentiments'] = context['sentiments'][-10:]
        
        context['last_update'] = datetime.now().isoformat()
    
    async def cleanup_old_conversations(self, max_age_hours: int = 24) -> int:
        """æ¸…ç†æ—§å¯¹è¯"""
        cutoff_time = datetime.now() - timedelta(hours=max_age_hours)
        cleaned_count = 0
        
        for conversation_id in list(self.conversations.keys()):
            messages = self.conversations[conversation_id]
            
            if not messages:
                continue
            
            # æ£€æŸ¥æœ€åä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´
            last_message_time_str = messages[-1].get('timestamp')
            if not last_message_time_str:
                continue
            
            last_message_time = datetime.fromisoformat(last_message_time_str)
            
            if last_message_time < cutoff_time:
                # æ¸…ç†å¯¹è¯å†å²
                del self.conversations[conversation_id]
                
                # æ¸…ç†ç”¨æˆ·ä¸Šä¸‹æ–‡
                if conversation_id in self.user_contexts:
                    del self.user_contexts[conversation_id]
                
                cleaned_count += 1
        
        _logger.info(f"æ¸…ç†äº† {cleaned_count} ä¸ªæ—§å¯¹è¯")
        return cleaned_count
```

### **å®‰å…¨å®¡æŸ¥ä¸“å®¶å…·ä½“ä»»åŠ¡ï¼š**

#### **ä»»åŠ¡1ï¼šç´ æä¸Šä¼ å®‰å…¨æ£€æµ‹**
```python
# file: wechat_platform/security/material_security.py

import logging
import magic
import imghdr
import mimetypes
import hashlib
from typing import Dict, Tuple, Optional
from datetime import datetime
import re

_logger = logging.getLogger(__name__)

class MaterialSecurityScanner:
    """ç´ æå®‰å…¨æ‰«æå™¨"""
    
    def __init__(self):
        self.malware_signatures = self._load_malware_signatures()
        self.suspicious_patterns = [
            b'<?php', b'<?=', b'eval(', b'system(', b'exec(',
            b'shell_exec', b'passthru', b'proc_open', b'popen',
            b'base64_decode', b'gzinflate', b'str_rot13',
        ]
        
    def _load_malware_signatures(self) -> Dict[bytes, str]:
        """åŠ è½½æ¶æ„è½¯ä»¶ç‰¹å¾ç """
        # è¿™é‡Œåº”è¯¥ä»æ•°æ®åº“æˆ–æ–‡ä»¶åŠ è½½ç‰¹å¾ç 
        # ç®€åŒ–ç¤ºä¾‹
        return {
            b'X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR': 'EICARæµ‹è¯•æ–‡ä»¶',
            b'%PDF-1.': 'å¯èƒ½çš„PDFæ¼æ´åˆ©ç”¨',
            b'\x4D\x5A': 'Windowså¯æ‰§è¡Œæ–‡ä»¶',
            b'\x7FELF': 'Linuxå¯æ‰§è¡Œæ–‡ä»¶',
        }
    
    def scan_file(self, file_data: bytes, filename: str) -> Dict:
        """æ‰«ææ–‡ä»¶å®‰å…¨æ€§"""
        try:
            scan_results = {
                'filename': filename,
                'file_size': len(file_data),
                'scan_time': datetime.now().isoformat(),
                'is_safe': True,
                'issues': [],
                'warnings': [],
                'metadata': {},
            }
            
            # 1. æ£€æŸ¥æ–‡ä»¶å¤§å°
            max_size = 10 * 1024 * 1024  # 10MB
            if len(file_data) > max_size:
                scan_results['issues'].append({
                    'type': 'size_limit',
                    'message': f'æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶: {len(file_data)} > {max_size}',
                    'severity': 'high',
                })
                scan_results['is_safe'] = False
            
            # 2. æ£€æŸ¥æ–‡ä»¶ç±»å‹
            file_type_info = self._detect_file_type(file_data, filename)
            scan_results['metadata'].update(file_type_info)
            
            allowed_types = {
                'image/jpeg', 'image/png', 'image/gif', 'image/bmp', 'image/webp',
                'audio/mpeg', 'audio/mp3', 'audio/wav', 'audio/ogg',
                'video/mp4', 'video/avi', 'video/mov', 'video/wmv',
                'text/plain', 'text/html',
            }
            
            detected_type = file_type_info.get('detected_type')
            if detected_type and detected_type not in allowed_types:
                scan_results['issues'].append({
                    'type': 'forbidden_type',
                    'message': f'ç¦æ­¢çš„æ–‡ä»¶ç±»å‹: {detected_type}',
                    'severity': 'high',
                })
                scan_results['is_safe'] = False
            
            # 3. æ£€æŸ¥æ¶æ„è½¯ä»¶ç‰¹å¾ç 
            malware_result = self._check_malware_signatures(file_data)
            if malware_result['found']:
                scan_results['issues'].append({
                    'type': 'malware',
                    'message': f'æ£€æµ‹åˆ°æ¶æ„è½¯ä»¶: {malware_result["name"]}',
                    'severity': 'critical',
                })
                scan_results['is_safe'] = False
            
            # 4. æ£€æŸ¥å¯ç–‘æ¨¡å¼
            suspicious_result = self._check_suspicious_patterns(file_data)
            if suspicious_result['found']:
                for pattern in suspicious_result['patterns']:
                    scan_results['warnings'].append({
                        'type': 'suspicious_pattern',
                        'message': f'å‘ç°å¯ç–‘æ¨¡å¼: {pattern}',
                        'severity': 'medium',
                    })
            
            # 5. æ£€æŸ¥å›¾åƒæœ‰æ•ˆæ€§
            if detected_type and detected_type.startswith('image/'):
                image_result = self._validate_image(file_data)
                if not image_result['valid']:
                    scan_results['issues'].append({
                        'type': 'invalid_image',
                        'message': image_result['message'],
                        'severity': 'medium',
                    })
                    scan_results['is_safe'] = False
            
            # 6. è®¡ç®—æ–‡ä»¶å“ˆå¸Œ
            file_hash = hashlib.sha256(file_data).hexdigest()
            scan_results['metadata']['sha256'] = file_hash
            
            # 7. æ£€æŸ¥æ–‡ä»¶åå®‰å…¨æ€§
            filename_result = self._check_filename_security(filename)
            if not filename_result['safe']:
                scan_results['issues'].append({
                    'type': 'filename_security',
                    'message': filename_result['message'],
                    'severity': 'medium',
                })
            
            return scan_results
            
        except Exception as e:
            _logger.error(f"æ–‡ä»¶æ‰«æå¤±è´¥: {str(e)}")
            return {
                'filename': filename,
                'is_safe': False,
                'issues': [{
                    'type': 'scan_error',
                    'message': f'æ‰«æå¤±è´¥: {str(e)}',
                    'severity': 'high',
                }],
                'warnings': [],
                'metadata': {},
            }
    
    def _detect_file_type(self, file_data: bytes, filename: str) -> Dict:
        """æ£€æµ‹æ–‡ä»¶ç±»å‹"""
        result = {
            'detected_by': [],
            'detected_type': None,
            'extension': None,
            'mime_type': None,
        }
        
        # 1. ä½¿ç”¨python-magicæ£€æµ‹
        try:
            import magic
            mime = magic.Magic(mime=True)
            detected = mime.from_buffer(file_data[:1024])  # åªè¯»å–å‰1KB
            result['detected_by'].append('libmagic')
            result['mime_type'] = detected
        except ImportError:
            _logger.warning("python-magicåº“æœªå®‰è£…ï¼Œä½¿ç”¨å¤‡ç”¨æ£€æµ‹æ–¹æ³•")
        except Exception as e:
            _logger.error(f"libmagicæ£€æµ‹å¤±è´¥: {str(e)}")
        
        # 2. ä½¿ç”¨imghdræ£€æµ‹å›¾åƒ
        if not result['mime_type'] and len(file_data) > 0:
            image_type = imghdr.what(None, file_data[:32])  # åªè¯»å–å‰32å­—èŠ‚
            if image_type:
                result['detected_by'].append('imghdr')
                result['mime_type'] = f'image/{image_type}'
        
        # 3. ä½¿ç”¨æ–‡ä»¶æ‰©å±•å
        if filename:
            ext = filename.split('.')[-1].lower() if '.' in filename else ''
            result['extension'] = ext
            
            if not result['mime_type']:
                guessed_type, _ = mimetypes.guess_type(filename)
                if guessed_type:
                    result['detected_by'].append('extension')
                    result['mime_type'] = guessed_type
        
        # 4. åŸºäºå†…å®¹çš„ç®€å•æ£€æµ‹
        if not result['mime_type']:
            if file_data.startswith(b'\xFF\xD8\xFF'):
                result['detected_by'].append('signature')
                result['mime_type'] = 'image/jpeg'
            elif file_data.startswith(b'\x89PNG\r\n\x1A\n'):
                result['detected_by'].append('signature')
                result['mime_type'] = 'image/png'
            elif file_data.startswith(b'GIF87a') or file_data.startswith(b'GIF89a'):
                result['detected_by'].append('signature')
                result['mime_type'] = 'image/gif'
            elif file_data.startswith(b'RIFF') and file_data[8:12] == b'WEBP':
                result['detected_by'].append('signature')
                result['mime_type'] = 'image/webp'
        
        result['detected_type'] = result['mime_type']
        return result
    
    def _check_malware_signatures(self, file_data: bytes) -> Dict:
        """æ£€æŸ¥æ¶æ„è½¯ä»¶ç‰¹å¾ç """
        for signature, name in self.malware_signatures.items():
            if signature in file_data:
                return {
                    'found': True,
                    'name': name,
                    'signature': signature.hex()[:20] + '...',
                }
        
        return {'found': False, 'name': None, 'signature': None}
    
    def _check_suspicious_patterns(self, file_data: bytes) -> Dict:
        """æ£€æŸ¥å¯ç–‘æ¨¡å¼"""
        found_patterns = []
        
        for pattern in self.suspicious_patterns:
            if pattern in file_data:
                found_patterns.append(pattern.decode('ascii', errors='ignore'))
        
        return {
            'found': len(found_patterns) > 0,
            'patterns': found_patterns,
            'count': len(found_patterns),
        }
    
    def _validate_image(self, file_data: bytes) -> Dict:
        """éªŒè¯å›¾åƒæ–‡ä»¶"""
        try:
            from PIL import Image
            from io import BytesIO
            
            # å°è¯•æ‰“å¼€å›¾åƒ
            img = Image.open(BytesIO(file_data))
            
            # éªŒè¯å›¾åƒ
            img.verify()
            
            # è·å–å›¾åƒä¿¡æ¯
            img_info = {
                'format': img.format,
                'size': img.size,
                'mode': img.mode,
                'valid': True,
            }
            
            # æ£€æŸ¥å›¾åƒå°ºå¯¸
            max_dimension = 10000  # æœ€å¤§å°ºå¯¸
            if max(img.size) > max_dimension:
                return {
                    'valid': False,
                    'message': f'å›¾åƒå°ºå¯¸è¿‡å¤§: {img.size}',
                    'info': img_info,
                }
            
            # æ£€æŸ¥å›¾åƒæ–‡ä»¶å¤§å°ä¸å°ºå¯¸æ¯”ä¾‹
            expected_size = img.size[0] * img.size[1] * len(img.mode)
            if len(file_data) > expected_size * 2:
                return {
                    'valid': False,
                    'message': 'å›¾åƒæ–‡ä»¶å¼‚å¸¸ï¼šæ–‡ä»¶å¤§å°ä¸åƒç´ æ•°é‡ä¸åŒ¹é…',
                    'info': img_info,
                }
            
            return {'valid': True, 'message': 'å›¾åƒéªŒè¯é€šè¿‡', 'info': img_info}
            
        except Exception as e:
            return {
                'valid': False,
                'message': f'å›¾åƒéªŒè¯å¤±è´¥: {str(e)}',
                'info': None,
            }
    
    def _check_filename_security(self, filename: str) -> Dict:
        """æ£€æŸ¥æ–‡ä»¶åå®‰å…¨æ€§"""
        issues = []
        
        # 1. æ£€æŸ¥è·¯å¾„éå†
        if '..' in filename or filename.startswith('/') or '\\' in filename:
            issues.append('åŒ…å«è·¯å¾„éå†å­—ç¬¦')
        
        # 2. æ£€æŸ¥ç‰¹æ®Šå­—ç¬¦
        dangerous_chars = [';', '|', '&', '$', '`']
        for char in dangerous_chars:
            if char in filename:
                issues.append(f'åŒ…å«å±é™©å­—ç¬¦: {char}')
        
        # 3. æ£€æŸ¥æ‰©å±•åæ¬ºéª—
        # ä¾‹å¦‚ï¼ševil.jpg.php
        if filename.count('.') > 1:
            # æ£€æŸ¥æœ€åä¸€ä¸ªæ‰©å±•åä¹‹å‰çš„æ‰©å±•å
            parts = filename.split('.')
            if len(parts) > 2:
                second_last = parts[-2].lower()
                dangerous_extensions = {'php', 'exe', 'sh', 'bat', 'cmd', 'js', 'vbs'}
                if second_last in dangerous_extensions:
                    issues.append('å¯èƒ½å­˜åœ¨æ‰©å±•åæ¬ºéª—')
        
        # 4. æ£€æŸ¥æ–‡ä»¶åé•¿åº¦
        if len(filename) > 255:
            issues.append('æ–‡ä»¶åè¿‡é•¿')
        
        # 5. æ£€æŸ¥ç©ºå­—èŠ‚
        if '\x00' in filename:
            issues.append('åŒ…å«ç©ºå­—èŠ‚')
        
        if issues:
            return {
                'safe': False,
                'message': '; '.join(issues),
                'issues': issues,
            }
        else:
            return {'safe': True, 'message': 'æ–‡ä»¶åå®‰å…¨æ£€æŸ¥é€šè¿‡', 'issues': []}


class ContentSecurityFilter:
    """å†…å®¹å®‰å…¨è¿‡æ»¤å™¨"""
    
    def __init__(self):
        self.xss_patterns = [
            # è„šæœ¬æ ‡ç­¾
            r'<script[^>]*>.*?</script>',
            r'<script[^>]*>',
            
            # äº‹ä»¶å¤„ç†å™¨
            r'\bon\w+\s*=',
            r'javascript:',
            r'data:text/html',
            
            # å±é™©çš„HTMLå±æ€§
            r'style\s*=.*expression\s*\(',
            r'style\s*=.*url\s*\(javascript:',
            
            # SVGæ”»å‡»
            r'<svg[^>]*onload=',
            r'<svg[^>]*onerror=',
            
            # æ¡†æ¶æ”»å‡»
            r'<iframe[^>]*>',
            r'<frame[^>]*>',
            r'<embed[^>]*>',
            r'<object[^>]*>',
            
            # è¡¨å•æ”»å‡»
            r'<form[^>]*>',
            r'<input[^>]*>',
            
            # å…¶ä»–å±é™©æ ‡ç­¾
            r'<meta[^>]*>',
            r'<link[^>]*>',
            r'<base[^>]*>',
        ]
        
        self.sql_injection_patterns = [
            r"'.*--",
            r"'.*;",
            r"'.*union.*select",
            r"'.*insert.*into",
            r"'.*update.*set",
            r"'.*delete.*from",
            r"'.*drop.*table",
            r"'.*exec.*\(",
            r"'.*sp_.*",
            r"'.*xp_.*",
        ]
        
        self.command_injection_patterns = [
            r';.*(rm|del|erase|format|mkfs)',
            r'\|\s*(rm|del|erase|format|mkfs)',
            r'&&\s*(rm|del|erase|format|mkfs)',
            r'\$\s*\(.*\)',
            r'`.*`',
        ]
        
    def filter_html_content(self, html_content: str) -> Tuple[str, List[Dict]]:
        """è¿‡æ»¤HTMLå†…å®¹"""
        if not html_content:
            return html_content, []
        
        issues = []
        filtered_content = html_content
        
        # 1. ç§»é™¤å±é™©æ ‡ç­¾
        dangerous_tags = [
            'script', 'iframe', 'frame', 'embed', 'object',
            'form', 'input', 'meta', 'link', 'base',
        ]
        
        for tag in dangerous_tags:
            pattern = f'<{tag}[^>]*>.*?</{tag}>'
            filtered_content, count = re.subn(pattern, '', filtered_content, flags=re.IGNORECASE | re.DOTALL)
            if count > 0:
                issues.append({
                    'type': 'dangerous_tag',
                    'tag': tag,
                    'count': count,
                    'severity': 'high',
                })
        
        # 2. ç§»é™¤äº‹ä»¶å¤„ç†å™¨
        event_pattern = r'\s(on\w+)\s*=\s*["\'][^"\']*["\']'
        filtered_content, count = re.subn(event_pattern, '', filtered_content, flags=re.IGNORECASE)
        if count > 0:
            issues.append({
                'type': 'event_handler',
                'count': count,
                'severity': 'high',
            })
        
        # 3. ç§»é™¤å±é™©å±æ€§
        dangerous_attrs = ['style', 'href', 'src']
        for attr in dangerous_attrs:
            pattern = f'{attr}\s*=\s*["\'][^"\']*["\']'
            filtered_content, count = re.subn(pattern, '', filtered_content, flags=re.IGNORECASE)
            if count > 0:
                issues.append({
                    'type': 'dangerous_attribute',
                    'attribute': attr,
                    'count': count,
                    'severity': 'medium',
                })
        
        # 4. ç§»é™¤JavaScriptåè®®
        js_pattern = r'javascript:\s*[^\s]+'
        filtered_content, count = re.subn(js_pattern, '', filtered_content, flags=re.IGNORECASE)
        if count > 0:
            issues.append({
                'type': 'javascript_protocol',
                'count': count,
                'severity': 'high',
            })
        
        # 5. ç§»é™¤æ•°æ®åè®®
        data_pattern = r'data:text/html[^,\s]*'
        filtered_content, count = re.subn(data_pattern, '', filtered_content, flags=re.IGNORECASE)
        if count > 0:
            issues.append({
                'type': 'data_protocol',
                'count': count,
                'severity': 'high',
            })
        
        # 6. è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦
        filtered_content = filtered_content.replace('<', '&lt;').replace('>', '&gt;')
        
        return filtered_content, issues
    
    def filter_text_content(self, text_content: str) -> Tuple[str, List[Dict]]:
        """è¿‡æ»¤æ–‡æœ¬å†…å®¹"""
        if not text_content:
            return text_content, []
        
        issues = []
        filtered_content = text_content
        
        # 1. æ£€æŸ¥XSSæ”»å‡»
        xss_issues = self._check_xss_attack(text_content)
        if xss_issues:
            issues.extend(xss_issues)
            # è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦
            filtered_content = (
                filtered_content
                .replace('<', '&lt;')
                .replace('>', '&gt;')
                .replace('"', '&quot;')
                .replace("'", '&#39;')
            )
        
        # 2. æ£€æŸ¥SQLæ³¨å…¥
        sql_issues = self._check_sql_injection(text_content)
        if sql_issues:
            issues.extend(sql_issues)
        
        # 3. æ£€æŸ¥å‘½ä»¤æ³¨å…¥
        cmd_issues = self._check_command_injection(text_content)
        if cmd_issues:
            issues.extend(cmd_issues)
        
        # 4. æ£€æŸ¥æ•æ„Ÿä¿¡æ¯
        sensitive_issues = self._check_sensitive_info(text_content)
        if sensitive_issues:
            issues.extend(sensitive_issues)
        
        return filtered_content, issues
    
    def _check_xss_attack(self, content: str) -> List[Dict]:
        """æ£€æŸ¥XSSæ”»å‡»"""
        issues = []
        
        for pattern in self.xss_patterns:
            matches = re.findall(pattern, content, re.IGNORECASE)
            if matches:
                issues.append({
                    'type': 'xss_pattern',
                    'pattern': pattern[:50] + '...' if len(pattern) > 50 else pattern,
                    'count': len(matches),
                    'severity': 'high',
                    'matches': matches[:3],  # åªæ˜¾ç¤ºå‰3ä¸ªåŒ¹é…
                })
        
        return issues
    
    def _check_sql_injection(self, content: str) -> List[Dict]:
        """æ£€æŸ¥SQLæ³¨å…¥"""
        issues = []
        
        for pattern in self.sql_injection_patterns:
            matches = re.findall(pattern, content, re.IGNORECASE)
            if matches:
                issues.append({
                    'type': 'sql_injection',
                    'pattern': pattern[:50] + '...' if len(pattern) > 50 else pattern,
                    'count': len(matches),
                    'severity': 'critical',
                    'matches': matches[:3],
                })
        
        return issues
    
    def _check_command_injection(self, content: str) -> List[Dict]:
        """æ£€æŸ¥å‘½ä»¤æ³¨å…¥"""
        issues = []
        
        for pattern in self.command_injection_patterns:
            matches = re.findall(pattern, content, re.IGNORECASE)
            if matches:
                issues.append({
                    'type': 'command_injection',
                    'pattern': pattern[:50] + '...' if len(pattern) > 50 else pattern,
                    'count': len(matches),
                    'severity': 'critical',
                    'matches': matches[:3],
                })
        
        return issues
    
    def _check_sensitive_info(self, content: str) -> List[Dict]:
        """æ£€æŸ¥æ•æ„Ÿä¿¡æ¯"""
        issues = []
        
        # èº«ä»½è¯å·æ¨¡å¼
        id_card_pattern = r'\b[1-9]\d{5}(18|19|20)\d{2}(0[1-9]|1[0-2])(0[1-9]|[1-2]\d|3[0-1])\d{3}[\dXx]\b'
        id_matches = re.findall(id_card_pattern, content)
        if id_matches:
            issues.append({
                'type': 'sensitive_info',
                'category': 'èº«ä»½è¯å·',
                'count': len(id_matches),
                'severity': 'high',
            })
        
        # æ‰‹æœºå·æ¨¡å¼
        phone_pattern = r'\b1[3-9]\d{9}\b'
        phone_matches = re.findall(phone_pattern, content)
        if phone_matches:
            issues.append({
                'type': 'sensitive_info',
                'category': 'æ‰‹æœºå·',
                'count': len(phone_matches),
                'severity': 'medium',
            })
        
        # é‚®ç®±æ¨¡å¼
        email_pattern = r'\b[\w\.-]+@[\w\.-]+\.\w+\b'
        email_matches = re.findall(email_pattern, content)
        if email_matches:
            issues.append({
                'type': 'sensitive_info',
                'category': 'é‚®ç®±',
                'count': len(email_matches),
                'severity': 'low',
            })
        
        # é“¶è¡Œå¡å·æ¨¡å¼
        bank_card_pattern = r'\b\d{16,19}\b'
        bank_matches = re.findall(bank_card_pattern, content)
        if bank_matches:
            issues.append({
                'type': 'sensitive_info',
                'category': 'é“¶è¡Œå¡å·',
                'count': len(bank_matches),
                'severity': 'high',
            })
        
        return issues
    
    def sanitize_filename(self, filename: str) -> str:
        """æ¸…ç†æ–‡ä»¶å"""
        if not filename:
            return 'unnamed'
        
        # ç§»é™¤è·¯å¾„åˆ†éš”ç¬¦
        sanitized = re.sub(r'[\\/:\*\?"<>\|]', '_', filename)
        
        # ç§»é™¤æ§åˆ¶å­—ç¬¦
        sanitized = ''.join(char for char in sanitized if ord(char) >= 32)
        
        # é™åˆ¶é•¿åº¦
        if len(sanitized) > 255:
            name, ext = os.path.splitext(sanitized)
            name = name[:255 - len(ext)]
            sanitized = name + ext
        
        return sanitized
```

#### **ä»»åŠ¡2ï¼šå®‰å…¨å®¡è®¡æ—¥å¿—ç³»ç»Ÿ**
```python
# file: wechat_platform/security/audit_logger.py

import logging
import json
import hashlib
from datetime import datetime, timedelta
from typing import Dict, List, Optional, Any
from enum import Enum
import threading

_logger = logging.getLogger(__name__)

class AuditLogLevel(Enum):
    """å®¡è®¡æ—¥å¿—çº§åˆ«"""
    INFO = "INFO"
    WARNING = "WARNING"
    ERROR = "ERROR"
    CRITICAL = "CRITICAL"

class AuditEventType(Enum):
    """å®¡è®¡äº‹ä»¶ç±»å‹"""
    # ç”¨æˆ·ç›¸å…³
    USER_LOGIN = "USER_LOGIN"
    USER_LOGOUT = "USER_LOGOUT"
    USER_CREATE = "USER_CREATE"
    USER_UPDATE = "USER_UPDATE"
    USER_DELETE = "USER_DELETE"
    
    # ç²‰ä¸ç›¸å…³
    FOLLOWER_SYNC = "FOLLOWER_SYNC"
    FOLLOWER_UPDATE = "FOLLOWER_UPDATE"
    FOLLOWER_DELETE = "FOLLOWER_DELETE"
    
    # æ¶ˆæ¯ç›¸å…³
    MESSAGE_RECEIVE = "MESSAGE_RECEIVE"
    MESSAGE_SEND = "MESSAGE_SEND"
    MESSAGE_DELETE = "MESSAGE_DELETE"
    
    # ç´ æç›¸å…³
    MATERIAL_UPLOAD = "MATERIAL_UPLOAD"
    MATERIAL_DOWNLOAD = "MATERIAL_DOWNLOAD"
    MATERIAL_DELETE = "MATERIAL_DELETE"
    
    # èœå•ç›¸å…³
    MENU_PUBLISH = "MENU_PUBLISH"
    MENU_DELETE = "MENU_DELETE"
    
    # è‡ªåŠ¨å›å¤ç›¸å…³
    REPLY_RULE_CREATE = "REPLY_RULE_CREATE"
    REPLY_RULE_UPDATE = "REPLY_RULE_UPDATE"
    REPLY_RULE_DELETE = "REPLY_RULE_DELETE"
    
    # å®‰å…¨ç›¸å…³
    SECURITY_ALERT = "SECURITY_ALERT"
    SECURITY_BREACH = "SECURITY_BREACH"
    SUSPICIOUS_ACTIVITY = "SUSPICIOUS_ACTIVITY"
    
    # ç³»ç»Ÿç›¸å…³
    SYSTEM_STARTUP = "SYSTEM_STARTUP"
    SYSTEM_SHUTDOWN = "SYSTEM_SHUTDOWN"
    CONFIG_CHANGE = "CONFIG_CHANGE"

class AuditLogger:
    """å®¡è®¡æ—¥å¿—è®°å½•å™¨"""
    
    _instance = None
    _lock = threading.Lock()
    
    def __new__(cls):
        with cls._lock:
            if cls._instance is None:
                cls._instance = super().__new__(cls)
                cls._instance._initialized = False
            return cls._instance
    
    def __init__(self):
        if self._initialized:
            return
        
        self.logs = []
        self.max_logs = 10000  # æœ€å¤§æ—¥å¿—æ•°é‡
        self.log_file = "audit_logs/audit.log"
        self.backup_days = 30  # å¤‡ä»½å¤©æ•°
        
        # åˆ›å»ºæ—¥å¿—ç›®å½•
        import os
        os.makedirs("audit_logs", exist_ok=True)
        
        self._initialized = True
        _logger.info("å®¡è®¡æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ")
    
    def log(self, event_type: AuditEventType, level: AuditLogLevel,
            user_id: Optional[str], ip_address: Optional[str],
            details: Dict, account_id: Optional[int] = None) -> str:
        """è®°å½•å®¡è®¡æ—¥å¿—"""
        try:
            log_entry = {
                'id': self._generate_log_id(),
                'timestamp': datetime.now().isoformat(),
                'event_type': event_type.value,
                'level': level.value,
                'user_id': user_id,
                'ip_address': ip_address,
                'account_id': account_id,
                'details': details,
                'hash': None,
            }
            
            # è®¡ç®—æ—¥å¿—å“ˆå¸Œ
            log_entry['hash'] = self._calculate_hash(log_entry)
            
            # æ·»åŠ åˆ°å†…å­˜
            self.logs.append(log_entry)
            
            # é™åˆ¶æ—¥å¿—æ•°é‡
            if len(self.logs) > self.max_logs:
                self.logs = self.logs[-self.max_logs:]
            
            # å†™å…¥æ–‡ä»¶
            self._write_to_file(log_entry)
            
            # è¾“å‡ºåˆ°ç³»ç»Ÿæ—¥å¿—
            self._output_to_syslog(log_entry)
            
            _logger.debug(f"å®¡è®¡æ—¥å¿—è®°å½•: {event_type.value} - {level.value}")
            return log_entry['id']
            
        except Exception as e:
            _logger.error(f"è®°å½•å®¡è®¡æ—¥å¿—å¤±è´¥: {str(e)}")
            return None
    
    def _generate_log_id(self) -> str:
        """ç”Ÿæˆæ—¥å¿—ID"""
        import uuid
        return str(uuid.uuid4())
    
    def _calculate_hash(self, log_entry: Dict) -> str:
        """è®¡ç®—æ—¥å¿—å“ˆå¸Œ"""
        # å¤åˆ¶æ—¥å¿—æ¡ç›®ï¼Œæ’é™¤hashå­—æ®µ
        data = log_entry.copy()
        data.pop('hash', None)
        
        # è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
        json_str = json.dumps(data, sort_keys=True, ensure_ascii=False)
        
        # è®¡ç®—SHA256å“ˆå¸Œ
        return hashlib.sha256(json_str.encode('utf-8')).hexdigest()
    
    def _write_to_file(self, log_entry: Dict):
        """å†™å…¥æ–‡ä»¶"""
        try:
            with open(self.log_file, 'a', encoding='utf-8') as f:
                json_str = json.dumps(log_entry, ensure_ascii=False)
                f.write(json_str + '\n')
        except Exception as e:
            _logger.error(f"å†™å…¥å®¡è®¡æ—¥å¿—æ–‡ä»¶å¤±è´¥: {str(e)}")
    
    def _output_to_syslog(self, log_entry: Dict):
        """è¾“å‡ºåˆ°ç³»ç»Ÿæ—¥å¿—"""
        level = log_entry['level']
        message = f"[AUDIT] {log_entry['event_type']} - {log_entry['details'].get('description', '')}"
        
        if level == AuditLogLevel.INFO.value:
            _logger.info(message)
        elif level == AuditLogLevel.WARNING.value:
            _logger.warning(message)
        elif level == AuditLogLevel.ERROR.value:
            _logger.error(message)
        elif level == AuditLogLevel.CRITICAL.value:
            _logger.critical(message)
    
    def search_logs(self, filters: Dict = None, limit: int = 100) -> List[Dict]:
        """æœç´¢å®¡è®¡æ—¥å¿—"""
        results = []
        
        for log in reversed(self.logs):  # ä»æœ€æ–°å¼€å§‹æœç´¢
            if self._matches_filters(log, filters):
                results.append(log)
                
                if len(results) >= limit:
                    break
        
        return results
    
    def _matches_filters(self, log: Dict, filters: Dict) -> bool:
        """æ£€æŸ¥æ—¥å¿—æ˜¯å¦åŒ¹é…è¿‡æ»¤å™¨"""
        if not filters:
            return True
        
        for key, value in filters.items():
            if key not in log:
                return False
            
            if isinstance(value, (list, tuple)):
                if log[key] not in value:
                    return False
            elif log[key] != value:
                return False
        
        return True
    
    def get_statistics(self, start_date: datetime, end_date: datetime) -> Dict:
        """è·å–ç»Ÿè®¡ä¿¡æ¯"""
        stats = {
            'total_logs': 0,
            'logs_by_level': {},
            'logs_by_event_type': {},
            'logs_by_user': {},
            'logs_by_ip': {},
            'hourly_distribution': {},
        }
        
        for log in self.logs:
            try:
                log_time = datetime.fromisoformat(log['timestamp'])
                if not (start_date <= log_time <= end_date):
                    continue
                
                stats['total_logs'] += 1
                
                # æŒ‰çº§åˆ«ç»Ÿè®¡
                level = log['level']
                stats['logs_by_level'][level] = stats['logs_by_level'].get(level, 0) + 1
                
                # æŒ‰äº‹ä»¶ç±»å‹ç»Ÿè®¡
                event_type = log['event_type']
                stats['logs_by_event_type'][event_type] = stats['logs_by_event_type'].get(event_type, 0) + 1
                
                # æŒ‰ç”¨æˆ·ç»Ÿè®¡
                user_id = log.get('user_id')
                if user_id:
                    stats['logs_by_user'][user_id] = stats['logs_by_user'].get(user_id, 0) + 1
                
                # æŒ‰IPç»Ÿè®¡
                ip_address = log.get('ip_address')
                if ip_address:
                    stats['logs_by_ip'][ip_address] = stats['logs_by_ip'].get(ip_address, 0) + 1
                
                # æŒ‰å°æ—¶ç»Ÿè®¡
                hour = log_time.strftime('%Y-%m-%d %H:00')
                stats['hourly_distribution'][hour] = stats['hourly_distribution'].get(hour, 0) + 1
                
            except Exception as e:
                _logger.warning(f"å¤„ç†å®¡è®¡æ—¥å¿—ç»Ÿè®¡å¤±è´¥: {str(e)}")
        
        return stats
    
    def verify_log_integrity(self) -> Dict:
        """éªŒè¯æ—¥å¿—å®Œæ•´æ€§"""
        verification = {
            'total_logs': len(self.logs),
            'invalid_hashes': 0,
            'tampered_logs': [],
            'missing_fields': [],
            'verification_time': datetime.now().isoformat(),
            'is_valid': True,
        }
        
        for i, log in enumerate(self.logs):
            try:
                # æ£€æŸ¥å¿…å¡«å­—æ®µ
                required_fields = ['id', 'timestamp', 'event_type', 'level', 'hash']
                for field in required_fields:
                    if field not in log:
                        verification['missing_fields'].append({
                            'index': i,
                            'field': field,
                            'log_id': log.get('id', 'unknown'),
                        })
                        verification['is_valid'] = False
                
                # éªŒè¯å“ˆå¸Œ
                original_hash = log.get('hash')
                if original_hash:
                    # ä¸´æ—¶ç§»é™¤hashå­—æ®µ
                    temp_log = log.copy()
                    temp_log.pop('hash')
                    
                    # è®¡ç®—å½“å‰å“ˆå¸Œ
                    json_str = json.dumps(temp_log, sort_keys=True, ensure_ascii=False)
                    current_hash = hashlib.sha256(json_str.encode('utf-8')).hexdigest()
                    
                    if current_hash != original_hash:
                        verification['invalid_hashes'] += 1
                        verification['tampered_logs'].append({
                            'index': i,
                            'log_id': log.get('id', 'unknown'),
                            'original_hash': original_hash,
                            'current_hash': current_hash,
                        })
                        verification['is_valid'] = False
                
            except Exception as e:
                _logger.error(f"éªŒè¯æ—¥å¿—å®Œæ•´æ€§å¤±è´¥: {str(e)}")
                verification['is_valid'] = False
        
        return verification
    
    def backup_logs(self):
        """å¤‡ä»½æ—¥å¿—"""
        try:
            import os
            import shutil
            
            backup_dir = f"audit_logs/backup/{datetime.now().strftime('%Y%m%d')}"
            os.makedirs(backup_dir, exist_ok=True)
            
            # å¤‡ä»½å½“å‰æ—¥å¿—æ–‡ä»¶
            if os.path.exists(self.log_file):
                shutil.copy2(self.log_file, f"{backup_dir}/audit.log")
            
            # æ¸…ç†æ—§å¤‡ä»½
            self._cleanup_old_backups()
            
            _logger.info(f"å®¡è®¡æ—¥å¿—å¤‡ä»½å®Œæˆ: {backup_dir}")
            
        except Exception as e:
            _logger.error(f"å¤‡ä»½å®¡è®¡æ—¥å¿—å¤±è´¥: {str(e)}")
    
    def _cleanup_old_backups(self):
        """æ¸…ç†æ—§å¤‡ä»½"""
        try:
            import os
            import shutil
            from datetime import datetime
            
            backup_root = "audit_logs/backup"
            if not os.path.exists(backup_root):
                return
            
            cutoff_date = datetime.now() - timedelta(days=self.backup_days)
            
            for backup_dir in os.listdir(backup_root):
                try:
                    dir_date = datetime.strptime(backup_dir, '%Y%m%d')
                    if dir_date < cutoff_date:
                        dir_path = os.path.join(backup_root, backup_dir)
                        shutil.rmtree(dir_path)
                        _logger.info(f"åˆ é™¤æ—§å¤‡ä»½: {backup_dir}")
                except ValueError:
                    continue  # å¿½ç•¥éæ—¥æœŸæ ¼å¼çš„ç›®å½•
            
        except Exception as e:
            _logger.error(f"æ¸…ç†æ—§å¤‡ä»½å¤±è´¥: {str(e)}")
    
    def export_logs(self, start_date: datetime, end_date: datetime, 
                   format: str = 'json') -> str:
        """å¯¼å‡ºæ—¥å¿—"""
        try:
            filtered_logs = []
            
            for log in self.logs:
                log_time = datetime.fromisoformat(log['timestamp'])
                if start_date <= log_time <= end_date:
                    filtered_logs.append(log)
            
            if format == 'json':
                return json.dumps(filtered_logs, indent=2, ensure_ascii=False)
            elif format == 'csv':
                return self._convert_to_csv(filtered_logs)
            else:
                raise ValueError(f"ä¸æ”¯æŒçš„æ ¼å¼: {format}")
            
        except Exception as e:
            _logger.error(f"å¯¼å‡ºå®¡è®¡æ—¥å¿—å¤±è´¥: {str(e)}")
            raise
    
    def _convert_to_csv(self, logs: List[Dict]) -> str:
        """è½¬æ¢ä¸ºCSVæ ¼å¼"""
        import csv
        import io
        
        if not logs:
            return ""
        
        # è·å–æ‰€æœ‰å­—æ®µ
        fields = set()
        for log in logs:
            fields.update(log.keys())
        
        # æ’åºå­—æ®µ
        field_order = ['timestamp', 'event_type', 'level', 'user_id', 
                      'ip_address', 'account_id', 'details']
        other_fields = sorted(f for f in fields if f not in field_order)
        all_fields = field_order + other_fields
        
        # åˆ›å»ºCSV
        output = io.StringIO()
        writer = csv.DictWriter(output, fieldnames=all_fields)
        
        writer.writeheader()
        for log in logs:
            writer.writerow(log)
        
        return output.getvalue()
    
    def clear_logs(self, before_date: datetime = None):
        """æ¸…ç†æ—¥å¿—"""
        try:
            if before_date:
                # æ¸…ç†æŒ‡å®šæ—¥æœŸä¹‹å‰çš„æ—¥å¿—
                new_logs = []
                for log in self.logs:
                    log_time = datetime.fromisoformat(log['timestamp'])
                    if log_time >= before_date:
                        new_logs.append(log)
                
                self.logs = new_logs
                _logger.info(f"æ¸…ç†äº† {len(self.logs) - len(new_logs)} æ¡æ—§æ—¥å¿—")
            else:
                # æ¸…ç†æ‰€æœ‰æ—¥å¿—
                cleared_count = len(self.logs)
                self.logs = []
                _logger.info(f"æ¸…ç†äº†æ‰€æœ‰ {cleared_count} æ¡æ—¥å¿—")
            
        except Exception as e:
            _logger.error(f"æ¸…ç†å®¡è®¡æ—¥å¿—å¤±è´¥: {str(e)}")
            raise


class AuditMiddleware:
    """å®¡è®¡ä¸­é—´ä»¶"""
    
    def __init__(self, get_response):
        self.get_response = get_response
        self.audit_logger = AuditLogger()
    
    def __call__(self, request):
        # è¯·æ±‚å‰å¤„ç†
        audit_data = self._capture_request_data(request)
        
        # æ‰§è¡Œè¯·æ±‚
        response = self.get_response(request)
        
        # è¯·æ±‚åå¤„ç†
        self._log_request(request, response, audit_data)
        
        return response
    
    def _capture_request_data(self, request):
        """æ•è·è¯·æ±‚æ•°æ®"""
        return {
            'method': request.method,
            'path': request.path,
            'query_params': dict(request.GET),
            'user_agent': request.META.get('HTTP_USER_AGENT'),
            'content_type': request.content_type,
            'timestamp': datetime.now().isoformat(),
        }
    
    def _log_request(self, request, response, audit_data):
        """è®°å½•è¯·æ±‚æ—¥å¿—"""
        try:
            user_id = None
            if hasattr(request, 'user') and request.user.is_authenticated:
                user_id = str(request.user.id)
            
            ip_address = self._get_client_ip(request)
            
            event_type = self._determine_event_type(request, response)
            level = self._determine_log_level(response.status_code)
            
            details = {
                'description': f"{request.method} {request.path}",
                'status_code': response.status_code,
                'request_data': audit_data,
                'response_size': len(response.content) if hasattr(response, 'content') else 0,
            }
            
            # è®°å½•å®¡è®¡æ—¥å¿—
            self.audit_logger.log(
                event_type=event_type,
                level=level,
                user_id=user_id,
                ip_address=ip_address,
                details=details,
            )
            
        except Exception as e:
            _logger.error(f"è®°å½•è¯·æ±‚å®¡è®¡æ—¥å¿—å¤±è´¥: {str(e)}")
    
    def _get_client_ip(self, request):
        """è·å–å®¢æˆ·ç«¯IP"""
        x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
        if x_forwarded_for:
            ip = x_forwarded_for.split(',')[0].strip()
        else:
            ip = request.META.get('REMOTE_ADDR')
        return ip
    
    def _determine_event_type(self, request, response):
        """ç¡®å®šäº‹ä»¶ç±»å‹"""
        path = request.path
        
        if '/wechat/message/' in path:
            return AuditEventType.MESSAGE_RECEIVE
        elif '/wechat/user/' in path:
            return AuditEventType.FOLLOWER_SYNC
        elif '/wechat/material/' in path:
            return AuditEventType.MATERIAL_UPLOAD
        elif '/login/' in path:
            return AuditEventType.USER_LOGIN
        elif '/logout/' in path:
            return AuditEventType.USER_LOGOUT
        else:
            return AuditEventType.SYSTEM_STARTUP  # é»˜è®¤å€¼
    
    def _determine_log_level(self, status_code):
        """ç¡®å®šæ—¥å¿—çº§åˆ«"""
        if status_code >= 500:
            return AuditLogLevel.ERROR
        elif status_code >= 400:
            return AuditLogLevel.WARNING
        else:
            return AuditLogLevel.INFO
```

---

## ğŸ“Š ç¬¬14-15å‘¨è¿›åº¦è·Ÿè¸ª

### **æ¯æ—¥ç«™ä¼šé‡ç‚¹**ï¼š
```
ç¬¬14å‘¨é‡ç‚¹ï¼š
å‘¨ä¸€ï¼šå®Œå–„è‡ªåŠ¨å›å¤è§„åˆ™å¼•æ“ï¼Œæ”¯æŒå¤æ‚åŒ¹é…
å‘¨äºŒï¼šå®ç°ç´ æç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒå¤šç§åª’ä½“ç±»å‹
å‘¨ä¸‰ï¼šå¼€å‘ç´ æä¸Šä¼ /ä¸‹è½½å’Œå®‰å…¨æ£€æµ‹
å‘¨å››ï¼šåˆ›å»ºè‡ªåŠ¨å›å¤å’Œç´ æç®¡ç†å‰ç«¯ç•Œé¢
å‘¨äº”ï¼šç¬¬ä¸€å‘¨æˆæœæ¼”ç¤ºå’Œé—®é¢˜ä¿®å¤

ç¬¬15å‘¨é‡ç‚¹ï¼š
å‘¨ä¸€ï¼šå®ç°è‡ªå®šä¹‰èœå•ç®¡ç†ç³»ç»Ÿ
å‘¨äºŒï¼šå¼€å‘é«˜çº§æ¶ˆæ¯å¤„ç†å¼•æ“ï¼ˆæ„å›¾è¯†åˆ«ã€æƒ…æ„Ÿåˆ†æï¼‰
å‘¨ä¸‰ï¼šå®ç°å®‰å…¨å®¡è®¡æ—¥å¿—ç³»ç»Ÿå’Œç›‘æ§
å‘¨å››ï¼šæ€§èƒ½ä¼˜åŒ–å’Œé›†æˆæµ‹è¯•
å‘¨äº”ï¼šç¬¬ä¸‰é˜¶æ®µæˆæœæ¼”ç¤ºå’Œæ€»ç»“
```

### **å…³é”®äº¤ä»˜ç‰©æ£€æŸ¥ç‚¹ï¼ˆç¬¬15å‘¨æœ«ï¼‰**ï¼š

#### **åç«¯å¼€å‘äº¤ä»˜ç‰©**ï¼š
- [ ] å®Œæ•´çš„è‡ªåŠ¨å›å¤è§„åˆ™å¼•æ“
- [ ] ç´ æç®¡ç†ç³»ç»Ÿï¼ˆæ”¯æŒå›¾ç‰‡ã€è¯­éŸ³ã€è§†é¢‘ã€å›¾æ–‡ï¼‰
- [ ] è‡ªå®šä¹‰èœå•ç®¡ç†ç³»ç»Ÿ
- [ ] é«˜çº§æ¶ˆæ¯å¤„ç†å¼•æ“ï¼ˆæ„å›¾è¯†åˆ«ã€æƒ…æ„Ÿåˆ†æï¼‰
- [ ] å®‰å…¨å®¡è®¡æ—¥å¿—ç³»ç»Ÿ

#### **å‰ç«¯å¼€å‘äº¤ä»˜ç‰©**ï¼š
- [ ] è‡ªåŠ¨å›å¤è§„åˆ™ç®¡ç†ç•Œé¢
- [ ] ç´ æç®¡ç†ç•Œé¢ï¼ˆç½‘æ ¼è§†å›¾ã€ä¸Šä¼ ã€é¢„è§ˆï¼‰
- [ ] è‡ªå®šä¹‰èœå•ç®¡ç†ç•Œé¢ï¼ˆæ ‘å½¢ç»“æ„ã€æ‹–æ‹½æ’åºï¼‰
- [ ] å®¡è®¡æ—¥å¿—æŸ¥çœ‹ç•Œé¢

#### **å¾®ä¿¡å¼€å‘ä¸“å®¶äº¤ä»˜ç‰©**ï¼š
- [ ] é«˜çº§æ¶ˆæ¯å¤„ç†ç®—æ³•
- [ ] ç´ æå®‰å…¨æ‰«ææœºåˆ¶
- [ ] æ¶ˆæ¯é˜Ÿåˆ—æ€§èƒ½ä¼˜åŒ–

#### **å®‰å…¨å®¡æŸ¥ä¸“å®¶äº¤ä»˜ç‰©**ï¼š
- [ ] ç´ æä¸Šä¼ å®‰å…¨æ£€æµ‹ç³»ç»Ÿ
- [ ] å†…å®¹å®‰å…¨è¿‡æ»¤æœºåˆ¶
- [ ] å®Œæ•´çš„å®¡è®¡æ—¥å¿—ç³»ç»Ÿ
- [ ] å®‰å…¨ç›‘æ§å‘Šè­¦æœºåˆ¶

---

## ğŸ”§ å¼€å‘ç¯å¢ƒé…ç½®æ›´æ–°

### **å®‰å…¨æµ‹è¯•ç¯å¢ƒ**ï¼š
```yaml
# å®‰å…¨æµ‹è¯•å·¥å…·
OWASP ZAP: Webåº”ç”¨å®‰å…¨æµ‹è¯•å·¥å…·
Burp Suite: Webå®‰å…¨æµ‹è¯•å·¥å…·
Nessus: æ¼æ´æ‰«æå·¥å…·
Metasploit: æ¸—é€æµ‹è¯•æ¡†æ¶

# æµ‹è¯•æ•°æ®
æ¶æ„æ–‡ä»¶æ ·æœ¬: ç”¨äºæµ‹è¯•ç´ æä¸Šä¼ å®‰å…¨
XSSæµ‹è¯•å‘é‡: ç”¨äºæµ‹è¯•æ¶ˆæ¯å®‰å…¨
SQLæ³¨å…¥æµ‹è¯•å‘é‡: ç”¨äºæµ‹è¯•æ•°æ®åº“å®‰å…¨

# ç›‘æ§å·¥å…·
Elasticsearch + Logstash + Kibana: æ—¥å¿—æ”¶é›†å’Œåˆ†æ
Prometheus + Grafana: ç³»ç»Ÿç›‘æ§
Sentry: é”™è¯¯ç›‘æ§
```

### **è‡ªåŠ¨åŒ–å®‰å…¨æµ‹è¯•è„šæœ¬**ï¼š
```bash
# è¿è¡Œå®‰å…¨æ‰«æ
python scripts/run_security_scan.py --target http://localhost:8069 --report-dir reports/

# è¿è¡Œæ¸—é€æµ‹è¯•
python scripts/run_penetration_test.py --module wechat_platform --output reports/penetration_test.html

# ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
python scripts/generate_security_report.py --include scans tests audits --output reports/security_summary.pdf
```

---

## ğŸš¨ ç¬¬ä¸‰é˜¶æ®µé£é™©ç®¡ç†

### **æ–°å¢é£é™©**ï¼š
| é£é™© | å½±å“ | æ¦‚ç‡ | åº”å¯¹æªæ–½ | è´Ÿè´£äºº |
|------|------|------|----------|--------|
| ç´ æä¸Šä¼ å®‰å…¨é£é™© | é«˜ | ä¸­ | 1. æ–‡ä»¶ç±»å‹éªŒè¯ 2. ç—…æ¯’æ‰«æ 3. å†…å®¹è¿‡æ»¤ | å®‰å…¨ä¸“å®¶ |
| è‡ªåŠ¨å›å¤è§„åˆ™å†²çª | ä¸­ | ä¸­ | 1. ä¼˜å…ˆçº§ç®¡ç† 2. è§„åˆ™æµ‹è¯• 3. å†²çªæ£€æµ‹ | åç«¯å¼€å‘ |
| èœå•é…ç½®å¤æ‚æ€§ | ä½ | é«˜ | 1. é…ç½®éªŒè¯ 2. å¯è§†åŒ–ç¼–è¾‘ 3. ä¸€é”®å‘å¸ƒ | å‰ç«¯å¼€å‘ |
| é«˜çº§ç®—æ³•æ€§èƒ½ | ä¸­ | ä½ | 1. ç®—æ³•ä¼˜åŒ– 2. ç¼“å­˜æœºåˆ¶ 3. å¼‚æ­¥å¤„ç† | å¾®ä¿¡ä¸“å®¶ |

### **æŠ€æœ¯éš¾ç‚¹**ï¼š
1. **æ„å›¾è¯†åˆ«å‡†ç¡®æ€§**ï¼šæé«˜è‡ªç„¶è¯­è¨€ç†è§£çš„å‡†ç¡®ç‡
2. **ç´ æå®‰å…¨æ£€æµ‹**ï¼šå¿«é€Ÿå‡†ç¡®æ£€æµ‹æ¶æ„æ–‡ä»¶
3. **å®æ—¶æ¶ˆæ¯å¤„ç†**ï¼šä¿è¯é«˜å¹¶å‘ä¸‹çš„å“åº”é€Ÿåº¦
4. **å®¡è®¡æ—¥å¿—å®Œæ•´æ€§**ï¼šç¡®ä¿æ—¥å¿—ä¸è¢«ç¯¡æ”¹

---

## ğŸ“ˆ è´¨é‡æŒ‡æ ‡ï¼ˆç¬¬15å‘¨æœ«ï¼‰

### **åŠŸèƒ½æŒ‡æ ‡**ï¼š
1. è‡ªåŠ¨å›å¤è§„åˆ™åŒ¹é…å‡†ç¡®ç‡ > 95%
2. ç´ æä¸Šä¼ æˆåŠŸç‡ > 99%
3. èœå•é…ç½®æœ‰æ•ˆæ€§ 100%
4. å®‰å…¨æ£€æµ‹è¦†ç›–ç‡ 100%

### **æ€§èƒ½æŒ‡æ ‡**ï¼š
1. æ„å›¾è¯†åˆ«å“åº”æ—¶é—´ < 100ms
2. ç´ ææ‰«æé€Ÿåº¦ > 10MB/ç§’
3. å®¡è®¡æ—¥å¿—å†™å…¥å»¶è¿Ÿ < 50ms
4. å†…å­˜å ç”¨ < 1GB

### **å®‰å…¨æŒ‡æ ‡**ï¼š
1. æ¶æ„æ–‡ä»¶æ£€æµ‹ç‡ > 99%
2. XSSæ”»å‡»é˜²æŠ¤ç‡ 100%
3. SQLæ³¨å…¥é˜²æŠ¤ç‡ 100%
4. å®¡è®¡æ—¥å¿—å®Œæ•´æ€§ 100%

---

## ğŸ¯ ç¬¬14-15å‘¨æˆåŠŸæ ‡å‡†

1. **åŠŸèƒ½å®Œæ•´æ€§**ï¼šè‡ªåŠ¨å›å¤ã€ç´ æç®¡ç†ã€èœå•ç®¡ç†åŠŸèƒ½å®Œæ•´
2. **ç”¨æˆ·ä½“éªŒ**ï¼šç•Œé¢å‹å¥½ï¼Œæ“ä½œæµç•…ï¼Œé…ç½®ç®€å•
3. **å®‰å…¨æ€§**ï¼šé€šè¿‡æ‰€æœ‰å®‰å…¨æµ‹è¯•ï¼Œæ— é‡å¤§æ¼æ´
4. **æ€§èƒ½è¾¾æ ‡**ï¼šæ»¡è¶³æ‰€æœ‰æ€§èƒ½æŒ‡æ ‡ï¼Œå“åº”è¿…é€Ÿ
5. **æ–‡æ¡£å®Œæ•´**ï¼šç”¨æˆ·æ‰‹å†Œã€å¼€å‘æ–‡æ¡£ã€APIæ–‡æ¡£é½å…¨

---

**ç¬¬ä¸‰é˜¶æ®µç¬¬14-15å‘¨å·¥ä½œæ­£å¼å¯åŠ¨ï¼** è¿™æ˜¯å¾®ä¿¡å…¬ä¼—å·ç®¡ç†å¹³å°åŠŸèƒ½å®Œå–„çš„å…³é”®é˜¶æ®µï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„ç³»ç»Ÿçš„å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒã€‚

**æœ¬å‘¨é‡ç‚¹æé†’**ï¼š
1. ç´ æå®‰å…¨æ£€æµ‹æ˜¯é‡ä¸­ä¹‹é‡ï¼Œå¿…é¡»ä¸¥æ ¼æŠŠå…³
2. è‡ªåŠ¨å›å¤è§„åˆ™è¦è€ƒè™‘å¤æ‚åœºæ™¯å’Œå†²çªå¤„ç†
3. èœå•

# ğŸš€ ç¬¬å››é˜¶æ®µï¼šé«˜çº§åˆ†æä¸ç³»ç»Ÿä¼˜åŒ–ï¼ˆç¬¬16-17å‘¨ï¼‰

## ğŸ“‹ æœ¬å‘¨æ ¸å¿ƒç›®æ ‡

**æœ¬å‘¨é‡ç‚¹**ï¼šå®ç°é«˜çº§æ•°æ®åˆ†æã€æŠ¥è¡¨ç³»ç»Ÿå’Œæ€§èƒ½ä¼˜åŒ–
**æŠ€æœ¯è¦ç‚¹**ï¼š
1. è®¾è®¡å¤šç»´ç»Ÿè®¡åˆ†ææ¨¡å‹å’ŒæŠ¥è¡¨ç³»ç»Ÿ
2. å®ç°æ•°æ®å¯è§†åŒ–ä»ªè¡¨ç›˜
3. è¿›è¡Œç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–ï¼ˆæ•°æ®åº“ã€ç¼“å­˜ã€ä»£ç ï¼‰
4. å®ç°æ¶ˆæ¯æ¨¡æ¿å’Œç¾¤å‘åŠŸèƒ½
5. å®Œå–„ç³»ç»Ÿç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
**æ—¶é—´**ï¼šç¬¬16-17å‘¨ï¼ˆå…±2å‘¨ï¼‰

---

## ğŸ“… ç¬¬16å‘¨ï¼šé«˜çº§ç»Ÿè®¡åˆ†æä¸æŠ¥è¡¨ç³»ç»Ÿ

### **Pythonä¸“å®¶è°ƒåº¦æŒ‡ä»¤ï¼š**
```
æœ¬å‘¨é‡ç‚¹ï¼šæ„å»ºå®Œæ•´çš„ç»Ÿè®¡åˆ†æç³»ç»Ÿå’Œæ•°æ®å¯è§†åŒ–æ¡†æ¶
å¼€å‘é¡ºåºï¼šç»Ÿè®¡æ¨¡å‹è®¾è®¡ â†’ æŠ¥è¡¨ç”Ÿæˆå¼•æ“ â†’ æ•°æ®èšåˆ â†’ å¯è§†åŒ–ç»„ä»¶ â†’ å¯¼å‡ºåŠŸèƒ½

æ³¨æ„ç‚¹ï¼š
1. ç»Ÿè®¡è¦è€ƒè™‘å®æ—¶æ€§å’Œå†å²æ•°æ®
2. æŠ¥è¡¨ç³»ç»Ÿè¦æ”¯æŒå¤šç§æ ¼å¼ï¼ˆPDFã€Excelã€HTMLï¼‰
3. æ•°æ®èšåˆè¦è€ƒè™‘å¤§æ•°æ®é‡çš„æ€§èƒ½
4. å¯è§†åŒ–è¦æ”¯æŒå¤šç§å›¾è¡¨ç±»å‹
5. å¯¼å‡ºåŠŸèƒ½è¦æ”¯æŒæ‰¹é‡å¤„ç†
```

### **åç«¯å¼€å‘å…·ä½“ä»»åŠ¡ï¼š**

#### **ä»»åŠ¡1ï¼šç»Ÿè®¡åˆ†æä¸æŠ¥è¡¨æ¨¡å‹è®¾è®¡**
```python
# file: wechat_platform/models/wechat_statistics.py

from odoo import models, fields, api, _
from odoo.exceptions import ValidationError, UserError
import logging
import json
from datetime import datetime, timedelta
from collections import defaultdict
import math

_logger = logging.getLogger(__name__)

class WechatStatistics(models.Model):
    """å¾®ä¿¡ç»Ÿè®¡åˆ†æ"""
    _name = 'wechat.statistics'
    _description = 'å¾®ä¿¡ç»Ÿè®¡åˆ†æ'
    _order = 'stat_date desc'
    
    # åŸºç¡€ä¿¡æ¯
    name = fields.Char(string='ç»Ÿè®¡åç§°', compute='_compute_name', store=True)
    account_id = fields.Many2one('wechat.account', string='æ‰€å±å…¬ä¼—å·', required=True)
    stat_date = fields.Date(string='ç»Ÿè®¡æ—¥æœŸ', required=True, default=fields.Date.today)
    stat_type = fields.Selection([
        ('daily', 'æ—¥æŠ¥'),
        ('weekly', 'å‘¨æŠ¥'),
        ('monthly', 'æœˆæŠ¥'),
        ('yearly', 'å¹´æŠ¥'),
        ('custom', 'è‡ªå®šä¹‰'),
    ], string='ç»Ÿè®¡ç±»å‹', required=True, default='daily')
    
    # ç²‰ä¸ç»Ÿè®¡
    new_followers = fields.Integer(string='æ–°å¢å…³æ³¨', default=0)
    unfollowers = fields.Integer(string='å–æ¶ˆå…³æ³¨', default=0)
    net_followers = fields.Integer(string='å‡€å¢å…³æ³¨', compute='_compute_net_followers', store=True)
    total_followers = fields.Integer(string='ç´¯è®¡å…³æ³¨', default=0)
    
    # æ¶ˆæ¯ç»Ÿè®¡
    received_messages = fields.Integer(string='æ¥æ”¶æ¶ˆæ¯', default=0)
    sent_messages = fields.Integer(string='å‘é€æ¶ˆæ¯', default=0)
    reply_rate = fields.Float(string='å›å¤ç‡', compute='_compute_reply_rate', store=True, digits=(5, 2))
    avg_response_time = fields.Float(string='å¹³å‡å“åº”æ—¶é—´(ç§’)', default=0)
    
    # æ¶ˆæ¯ç±»å‹åˆ†å¸ƒ
    text_message_count = fields.Integer(string='æ–‡æœ¬æ¶ˆæ¯', default=0)
    image_message_count = fields.Integer(string='å›¾ç‰‡æ¶ˆæ¯', default=0)
    voice_message_count = fields.Integer(string='è¯­éŸ³æ¶ˆæ¯', default=0)
    video_message_count = fields.Integer(string='è§†é¢‘æ¶ˆæ¯', default=0)
    event_message_count = fields.Integer(string='äº‹ä»¶æ¶ˆæ¯', default=0)
    
    # ç”¨æˆ·æ´»è·ƒåº¦
    active_users = fields.Integer(string='æ´»è·ƒç”¨æˆ·', default=0,
                                 help='å½“å¤©æœ‰æ¶ˆæ¯äº¤äº’çš„ç”¨æˆ·æ•°')
    active_rate = fields.Float(string='æ´»è·ƒç‡', compute='_compute_active_rate', store=True, digits=(5, 2))
    
    # èœå•ç‚¹å‡»ç»Ÿè®¡
    menu_clicks = fields.Integer(string='èœå•ç‚¹å‡»æ¬¡æ•°', default=0)
    top_menu_items = fields.Text(string='çƒ­é—¨èœå•é¡¹', 
                                help='JSONæ ¼å¼å­˜å‚¨çƒ­é—¨èœå•ç‚¹å‡»æ•°æ®')
    
    # è‡ªåŠ¨å›å¤ç»Ÿè®¡
    auto_reply_count = fields.Integer(string='è‡ªåŠ¨å›å¤æ¬¡æ•°', default=0)
    auto_reply_success = fields.Integer(string='æˆåŠŸå›å¤', default=0)
    auto_reply_failure = fields.Integer(string='å›å¤å¤±è´¥', default=0)
    
    # åœ°åŸŸåˆ†å¸ƒ
    location_data = fields.Text(string='åœ°åŸŸåˆ†å¸ƒæ•°æ®',
                               help='JSONæ ¼å¼å­˜å‚¨ç”¨æˆ·åœ°åŸŸåˆ†å¸ƒ')
    
    # ç”¨æˆ·æ¥æº
    subscribe_source = fields.Text(string='å…³æ³¨æ¥æº',
                                  help='JSONæ ¼å¼å­˜å‚¨ç”¨æˆ·å…³æ³¨æ¥æº')
    
    # æ€§èƒ½æŒ‡æ ‡
    api_calls = fields.Integer(string='APIè°ƒç”¨æ¬¡æ•°', default=0)
    api_errors = fields.Integer(string='APIé”™è¯¯æ•°', default=0)
    avg_api_response_time = fields.Float(string='APIå¹³å‡å“åº”æ—¶é—´(ms)', default=0)
    
    # ç³»ç»ŸæŒ‡æ ‡
    system_errors = fields.Integer(string='ç³»ç»Ÿé”™è¯¯æ•°', default=0)
    memory_usage = fields.Float(string='å†…å­˜ä½¿ç”¨(MB)', default=0)
    cpu_usage = fields.Float(string='CPUä½¿ç”¨ç‡(%)', default=0)
    
    # çŠ¶æ€æ ‡è®°
    is_calculated = fields.Boolean(string='å·²è®¡ç®—', default=False)
    calculation_time = fields.Datetime(string='è®¡ç®—æ—¶é—´')
    
    # çº¦æŸ
    _sql_constraints = [
        ('account_date_type_unique', 'UNIQUE(account_id, stat_date, stat_type)', 
         'åŒä¸€å…¬ä¼—å·ã€æ—¥æœŸå’Œç±»å‹çš„ç»Ÿè®¡è®°å½•å¿…é¡»å”¯ä¸€')
    ]
    
    @api.depends('new_followers', 'unfollowers')
    def _compute_net_followers(self):
        """è®¡ç®—å‡€å¢å…³æ³¨"""
        for stat in self:
            stat.net_followers = stat.new_followers - stat.unfollowers
    
    @api.depends('received_messages', 'sent_messages')
    def _compute_reply_rate(self):
        """è®¡ç®—å›å¤ç‡"""
        for stat in self:
            if stat.received_messages > 0:
                stat.reply_rate = (stat.sent_messages / stat.received_messages) * 100
            else:
                stat.reply_rate = 0.0
    
    @api.depends('active_users', 'total_followers')
    def _compute_active_rate(self):
        """è®¡ç®—æ´»è·ƒç‡"""
        for stat in self:
            if stat.total_followers > 0:
                stat.active_rate = (stat.active_users / stat.total_followers) * 100
            else:
                stat.active_rate = 0.0
    
    @api.depends('stat_date', 'stat_type', 'account_id')
    def _compute_name(self):
        """è®¡ç®—ç»Ÿè®¡åç§°"""
        for stat in self:
            date_str = stat.stat_date.strftime('%Y-%m-%d')
            stat.name = f"{stat.account_id.name} - {date_str} - {dict(stat._fields['stat_type'].selection).get(stat.stat_type)}"
    
    @api.model
    def generate_daily_statistics(self, account_id=None, date=None):
        """ç”Ÿæˆæ¯æ—¥ç»Ÿè®¡æ•°æ®"""
        if not date:
            date = fields.Date.today() - timedelta(days=1)  # é»˜è®¤ç»Ÿè®¡å‰ä¸€å¤©
        
        accounts = self.env['wechat.account']
        if account_id:
            accounts = self.env['wechat.account'].browse(account_id)
        else:
            accounts = self.env['wechat.account'].search([('is_valid', '=', True)])
        
        for account in accounts:
            try:
                # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç»Ÿè®¡
                existing_stat = self.search([
                    ('account_id', '=', account.id),
                    ('stat_date', '=', date),
                    ('stat_type', '=', 'daily'),
                ], limit=1)
                
                if existing_stat:
                    # é‡æ–°è®¡ç®—
                    stat_data = self._calculate_daily_statistics(account.id, date)
                    existing_stat.write(stat_data)
                else:
                    # åˆ›å»ºæ–°ç»Ÿè®¡
                    stat_data = self._calculate_daily_statistics(account.id, date)
                    stat_data.update({
                        'account_id': account.id,
                        'stat_date': date,
                        'stat_type': 'daily',
                        'is_calculated': True,
                        'calculation_time': fields.Datetime.now(),
                    })
                    self.create(stat_data)
                
                _logger.info(f"ç”Ÿæˆæ¯æ—¥ç»Ÿè®¡æˆåŠŸ: {account.name} - {date}")
                
            except Exception as e:
                _logger.error(f"ç”Ÿæˆæ¯æ—¥ç»Ÿè®¡å¤±è´¥ {account.name}: {str(e)}")
        
        return True
    
    def _calculate_daily_statistics(self, account_id, date):
        """è®¡ç®—æ¯æ—¥ç»Ÿè®¡æ•°æ®"""
        start_date = datetime.combine(date, datetime.min.time())
        end_date = datetime.combine(date, datetime.max.time())
        
        # ç²‰ä¸ç»Ÿè®¡
        new_followers = self.env['wechat.user'].search_count([
            ('account_id', '=', account_id),
            ('subscribe_time', '>=', start_date),
            ('subscribe_time', '<=', end_date),
            ('subscribe', '=', True),
        ])
        
        unfollowers = self.env['wechat.user'].search_count([
            ('account_id', '=', account_id),
            ('last_message_time', '>=', start_date),
            ('last_message_time', '<=', end_date),
            ('subscribe', '=', False),
        ])
        
        total_followers = self.env['wechat.user'].search_count([
            ('account_id', '=', account_id),
            ('subscribe', '=', True),
        ])
        
        # æ¶ˆæ¯ç»Ÿè®¡
        received_messages = self.env['wechat.message'].search_count([
            ('account_id', '=', account_id),
            ('create_time', '>=', start_date),
            ('create_time', '<=', end_date),
            ('direction', '=', 'in'),
        ])
        
        sent_messages = self.env['wechat.message'].search_count([
            ('account_id', '=', account_id),
            ('create_time', '>=', start_date),
            ('create_time', '<=', end_date),
            ('direction', '=', 'out'),
        ])
        
        # è®¡ç®—å¹³å‡å“åº”æ—¶é—´
        replied_messages = self.env['wechat.message'].search([
            ('account_id', '=', account_id),
            ('create_time', '>=', start_date),
            ('create_time', '<=', end_date),
            ('direction', '=', 'in'),
            ('status', '=', 'replied'),
        ])
        
        total_response_time = 0
        for msg in replied_messages:
            if msg.create_time and msg.process_time:
                response_time = (msg.process_time - msg.create_time).total_seconds()
                total_response_time += response_time
        
        avg_response_time = total_response_time / len(replied_messages) if replied_messages else 0
        
        # æ¶ˆæ¯ç±»å‹åˆ†å¸ƒ
        text_messages = self.env['wechat.message'].search_count([
            ('account_id', '=', account_id),
            ('create_time', '>=', start_date),
            ('create_time', '<=', end_date),
            ('msg_type', '=', 'text'),
        ])
        
        image_messages = self.env['wechat.message'].search_count([
            ('account_id', '=', account_id),
            ('create_time', '>=', start_date),
            ('create_time', '<=', end_date),
            ('msg_type', '=', 'image'),
        ])
        
        voice_messages = self.env['wechat.message'].search_count([
            ('account_id', '=', account_id),
            ('create_time', '>=', start_date),
            ('create_time', '<=', end_date),
            ('msg_type', '=', 'voice'),
        ])
        
        video_messages = self.env['wechat.message'].search_count([
            ('account_id', '=', account_id),
            ('create_time', '>=', start_date),
            ('create_time', '<=', end_date),
            ('msg_type', '=', 'video'),
        ])
        
        event_messages = self.env['wechat.message'].search_count([
            ('account_id', '=', account_id),
            ('create_time', '>=', start_date),
            ('create_time', '<=', end_date),
            ('msg_type', '=', 'event'),
        ])
        
        # æ´»è·ƒç”¨æˆ·
        active_users = self.env['wechat.user'].search_count([
            ('account_id', '=', account_id),
            ('last_message_time', '>=', start_date),
            ('last_message_time', '<=', end_date),
            ('subscribe', '=', True),
        ])
        
        # èœå•ç‚¹å‡»ç»Ÿè®¡
        menu_clicks = self.env['wechat.menu.stat'].search_count([
            ('account_id', '=', account_id),
            ('click_time', '>=', start_date),
            ('click_time', '<=', end_date),
        ])
        
        # çƒ­é—¨èœå•é¡¹
        menu_stats = self.env['wechat.menu.stat'].read_group([
            ('account_id', '=', account_id),
            ('click_time', '>=', start_date),
            ('click_time', '<=', end_date),
        ], ['menu_id'], ['menu_id'])
        
        top_menu_items = []
        for stat in menu_stats[:10]:  # å–å‰10ä¸ª
            if stat['menu_id']:
                menu = self.env['wechat.menu'].browse(stat['menu_id'][0])
                top_menu_items.append({
                    'id': menu.id,
                    'name': menu.name,
                    'clicks': stat['menu_id_count'],
                })
        
        # è‡ªåŠ¨å›å¤ç»Ÿè®¡
        auto_reply_messages = self.env['wechat.message'].search([
            ('account_id', '=', account_id),
            ('create_time', '>=', start_date),
            ('create_time', '<=', end_date),
            ('direction', '=', 'in'),
            ('auto_reply', '=', True),
        ])
        
        auto_reply_count = len(auto_reply_messages)
        auto_reply_success = len([m for m in auto_reply_messages if m.status == 'replied'])
        auto_reply_failure = auto_reply_count - auto_reply_success
        
        # åœ°åŸŸåˆ†å¸ƒ
        location_stats = self.env['wechat.user'].read_group([
            ('account_id', '=', account_id),
            ('subscribe', '=', True),
            ('province', '!=', False),
        ], ['province'], ['province'])
        
        location_data = []
        for stat in location_stats:
            location_data.append({
                'province': stat['province'],
                'count': stat['province_count'],
            })
        
        # å…³æ³¨æ¥æº
        source_stats = self.env['wechat.user'].read_group([
            ('account_id', '=', account_id),
            ('subscribe', '=', True),
            ('subscribe_scene', '!=', False),
        ], ['subscribe_scene'], ['subscribe_scene'])
        
        subscribe_source = []
        for stat in source_stats:
            subscribe_source.append({
                'source': stat['subscribe_scene'],
                'count': stat['subscribe_scene_count'],
            })
        
        return {
            'new_followers': new_followers,
            'unfollowers': unfollowers,
            'total_followers': total_followers,
            'received_messages': received_messages,
            'sent_messages': sent_messages,
            'avg_response_time': avg_response_time,
            'text_message_count': text_messages,
            'image_message_count': image_messages,
            'voice_message_count': voice_messages,
            'video_message_count': video_messages,
            'event_message_count': event_messages,
            'active_users': active_users,
            'menu_clicks': menu_clicks,
            'top_menu_items': json.dumps(top_menu_items, ensure_ascii=False),
            'auto_reply_count': auto_reply_count,
            'auto_reply_success': auto_reply_success,
            'auto_reply_failure': auto_reply_failure,
            'location_data': json.dumps(location_data, ensure_ascii=False),
            'subscribe_source': json.dumps(subscribe_source, ensure_ascii=False),
        }
    
    @api.model
    def generate_weekly_statistics(self, account_id=None, start_date=None):
        """ç”Ÿæˆæ¯å‘¨ç»Ÿè®¡æ•°æ®"""
        if not start_date:
            # é»˜è®¤ç»Ÿè®¡ä¸Šå‘¨
            start_date = fields.Date.today() - timedelta(days=7)
        
        end_date = start_date + timedelta(days=6)
        
        accounts = self.env['wechat.account']
        if account_id:
            accounts = self.env['wechat.account'].browse(account_id)
        else:
            accounts = self.env['wechat.account'].search([('is_valid', '=', True)])
        
        for account in accounts:
            try:
                # èšåˆæ¯æ—¥æ•°æ®
                daily_stats = self.search([
                    ('account_id', '=', account.id),
                    ('stat_date', '>=', start_date),
                    ('stat_date', '<=', end_date),
                    ('stat_type', '=', 'daily'),
                ])
                
                if not daily_stats:
                    _logger.warning(f"æ²¡æœ‰æ‰¾åˆ°æ¯æ—¥ç»Ÿè®¡æ•°æ®è¿›è¡Œèšåˆ: {account.name}")
                    continue
                
                # è®¡ç®—å‘¨ç»Ÿè®¡æ•°æ®
                weekly_data = self._aggregate_statistics(daily_stats)
                
                # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨å‘¨ç»Ÿè®¡
                existing_stat = self.search([
                    ('account_id', '=', account.id),
                    ('stat_date', '=', start_date),
                    ('stat_type', '=', 'weekly'),
                ], limit=1)
                
                if existing_stat:
                    existing_stat.write(weekly_data)
                else:
                    weekly_data.update({
                        'account_id': account.id,
                        'stat_date': start_date,
                        'stat_type': 'weekly',
                        'is_calculated': True,
                        'calculation_time': fields.Datetime.now(),
                    })
                    self.create(weekly_data)
                
                _logger.info(f"ç”Ÿæˆå‘¨ç»Ÿè®¡æˆåŠŸ: {account.name} - {start_date} åˆ° {end_date}")
                
            except Exception as e:
                _logger.error(f"ç”Ÿæˆå‘¨ç»Ÿè®¡å¤±è´¥ {account.name}: {str(e)}")
        
        return True
    
    def _aggregate_statistics(self, stats):
        """èšåˆç»Ÿè®¡æ•°æ®"""
        aggregated = {
            'new_followers': sum(s.new_followers for s in stats),
            'unfollowers': sum(s.unfollowers for s in stats),
            'total_followers': stats[-1].total_followers if stats else 0,
            'received_messages': sum(s.received_messages for s in stats),
            'sent_messages': sum(s.sent_messages for s in stats),
            'text_message_count': sum(s.text_message_count for s in stats),
            'image_message_count': sum(s.image_message_count for s in stats),
            'voice_message_count': sum(s.voice_message_count for s in stats),
            'video_message_count': sum(s.video_message_count for s in stats),
            'event_message_count': sum(s.event_message_count for s in stats),
            'active_users': len(set(user_id for s in stats 
                                   for user_id in self._get_active_users(s))),
            'menu_clicks': sum(s.menu_clicks for s in stats),
        }
        
        # è®¡ç®—å¹³å‡å“åº”æ—¶é—´
        total_response_time = sum(s.avg_response_time * s.received_messages for s in stats 
                                 if s.received_messages > 0)
        total_messages = sum(s.received_messages for s in stats)
        aggregated['avg_response_time'] = total_response_time / total_messages if total_messages > 0 else 0
        
        # è®¡ç®—å¹³å‡æ´»è·ƒç‡
        total_active_rate = sum(s.active_rate for s in stats if s.total_followers > 0)
        valid_stats = len([s for s in stats if s.total_followers > 0])
        aggregated['active_rate'] = total_active_rate / valid_stats if valid_stats > 0 else 0
        
        return aggregated
    
    def _get_active_users(self, stat):
        """è·å–æ´»è·ƒç”¨æˆ·åˆ—è¡¨ï¼ˆç®€åŒ–å®ç°ï¼‰"""
        # è¿™é‡Œåº”è¯¥ä»è¯¦ç»†çš„æ´»è·ƒç”¨æˆ·è®°å½•ä¸­è·å–
        # ç®€åŒ–å®ç°ï¼šè¿”å›æ¨¡æ‹Ÿæ•°æ®
        return []
    
    def get_statistics_summary(self, period='7d'):
        """è·å–ç»Ÿè®¡æ‘˜è¦"""
        end_date = fields.Date.today()
        
        if period == '7d':
            start_date = end_date - timedelta(days=6)
            stat_type = 'daily'
        elif period == '30d':
            start_date = end_date - timedelta(days=29)
            stat_type = 'daily'
        elif period == '90d':
            start_date = end_date - timedelta(days=89)
            stat_type = 'daily'
        elif period == '1y':
            start_date = end_date - timedelta(days=364)
            stat_type = 'weekly'
        else:
            raise UserError(_('ä¸æ”¯æŒçš„ç»Ÿè®¡å‘¨æœŸ: %s') % period)
        
        stats = self.search([
            ('account_id', '=', self.account_id.id),
            ('stat_date', '>=', start_date),
            ('stat_date', '<=', end_date),
            ('stat_type', '=', stat_type),
        ], order='stat_date')
        
        summary = {
            'period': period,
            'start_date': start_date,
            'end_date': end_date,
            'total_stats': len(stats),
            'data': [],
            'totals': {},
            'averages': {},
        }
        
        if not stats:
            return summary
        
        # å‡†å¤‡æ—¶é—´åºåˆ—æ•°æ®
        for stat in stats:
            summary['data'].append({
                'date': stat.stat_date.strftime('%Y-%m-%d'),
                'new_followers': stat.new_followers,
                'unfollowers': stat.unfollowers,
                'net_followers': stat.net_followers,
                'received_messages': stat.received_messages,
                'sent_messages': stat.sent_messages,
                'reply_rate': stat.reply_rate,
                'active_users': stat.active_users,
                'active_rate': stat.active_rate,
            })
        
        # è®¡ç®—æ€»è®¡
        summary['totals'] = {
            'new_followers': sum(s.new_followers for s in stats),
            'unfollowers': sum(s.unfollowers for s in stats),
            'net_followers': sum(s.net_followers for s in stats),
            'received_messages': sum(s.received_messages for s in stats),
            'sent_messages': sum(s.sent_messages for s in stats),
            'active_users': len(set(user_id for s in stats 
                                   for user_id in self._get_active_users(s))),
        }
        
        # è®¡ç®—å¹³å‡å€¼
        summary['averages'] = {
            'daily_new_followers': summary['totals']['new_followers'] / len(stats) if stats else 0,
            'daily_received_messages': summary['totals']['received_messages'] / len(stats) if stats else 0,
            'reply_rate': sum(s.reply_rate for s in stats) / len(stats) if stats else 0,
            'active_rate': sum(s.active_rate for s in stats) / len(stats) if stats else 0,
        }
        
        return summary
    
    def action_view_detailed_report(self):
        """æŸ¥çœ‹è¯¦ç»†æŠ¥è¡¨"""
        self.ensure_one()
        
        return {
            'type': 'ir.actions.act_url',
            'url': f'/wechat_platform/statistics/report/{self.id}',
            'target': 'new',
        }
    
    def action_export_statistics(self, export_format='excel'):
        """å¯¼å‡ºç»Ÿè®¡æ•°æ®"""
        self.ensure_one()
        
        if export_format == 'excel':
            return self._export_to_excel()
        elif export_format == 'pdf':
            return self._export_to_pdf()
        elif export_format == 'csv':
            return self._export_to_csv()
        else:
            raise UserError(_('ä¸æ”¯æŒçš„å¯¼å‡ºæ ¼å¼: %s') % export_format)
    
    def _export_to_excel(self):
        """å¯¼å‡ºåˆ°Excel"""
        # è¿™é‡Œåº”è¯¥å®ç°Excelå¯¼å‡ºé€»è¾‘
        # ä½¿ç”¨xlwtæˆ–openpyxlåº“
        return {
            'type': 'ir.actions.report',
            'report_name': 'wechat_platform.statistics_report_excel',
            'model': 'wechat.statistics',
            'report_type': 'xlsx',
            'data': {'stat_ids': self.ids},
        }
    
    def _export_to_pdf(self):
        """å¯¼å‡ºåˆ°PDF"""
        return {
            'type': 'ir.actions.report',
            'report_name': 'wechat_platform.statistics_report_pdf',
            'model': 'wechat.statistics',
            'report_type': 'qweb-pdf',
            'data': {'stat_ids': self.ids},
        }
    
    def _export_to_csv(self):
        """å¯¼å‡ºåˆ°CSV"""
        return {
            'type': 'ir.actions.report',
            'report_name': 'wechat_platform.statistics_report_csv',
            'model': 'wechat.statistics',
            'report_type': 'csv',
            'data': {'stat_ids': self.ids},
        }


class WechatAnalysisReport(models.Model):
    """å¾®ä¿¡åˆ†ææŠ¥è¡¨"""
    _name = 'wechat.analysis.report'
    _description = 'å¾®ä¿¡åˆ†ææŠ¥è¡¨'
    _order = 'create_date desc'
    
    name = fields.Char(string='æŠ¥è¡¨åç§°', required=True)
    account_id = fields.Many2one('wechat.account', string='æ‰€å±å…¬ä¼—å·')
    report_type = fields.Selection([
        ('follower_growth', 'ç²‰ä¸å¢é•¿åˆ†æ'),
        ('message_analysis', 'æ¶ˆæ¯åˆ†æ'),
        ('user_behavior', 'ç”¨æˆ·è¡Œä¸ºåˆ†æ'),
        ('menu_performance', 'èœå•æ€§èƒ½åˆ†æ'),
        ('material_effect', 'ç´ ææ•ˆæœåˆ†æ'),
        ('custom', 'è‡ªå®šä¹‰åˆ†æ'),
    ], string='æŠ¥è¡¨ç±»å‹', required=True)
    
    # æ—¶é—´èŒƒå›´
    start_date = fields.Date(string='å¼€å§‹æ—¥æœŸ', required=True)
    end_date = fields.Date(string='ç»“æŸæ—¥æœŸ', required=True)
    
    # æŠ¥è¡¨é…ç½®
    metrics = fields.Text(string='æŒ‡æ ‡é…ç½®',
                         help='JSONæ ¼å¼çš„æŒ‡æ ‡é…ç½®')
    filters = fields.Text(string='è¿‡æ»¤æ¡ä»¶',
                         help='JSONæ ¼å¼çš„è¿‡æ»¤æ¡ä»¶')
    grouping = fields.Text(string='åˆ†ç»„é…ç½®',
                          help='JSONæ ¼å¼çš„åˆ†ç»„é…ç½®')
    
    # æŠ¥è¡¨æ•°æ®
    report_data = fields.Text(string='æŠ¥è¡¨æ•°æ®',
                             help='JSONæ ¼å¼çš„æŠ¥è¡¨æ•°æ®')
    chart_config = fields.Text(string='å›¾è¡¨é…ç½®',
                              help='JSONæ ¼å¼çš„å›¾è¡¨é…ç½®')
    
    # æŠ¥è¡¨çŠ¶æ€
    is_generated = fields.Boolean(string='å·²ç”Ÿæˆ', default=False)
    generation_time = fields.Datetime(string='ç”Ÿæˆæ—¶é—´')
    last_viewed = fields.Datetime(string='æœ€åæŸ¥çœ‹æ—¶é—´')
    
    # å¯¼å‡ºä¿¡æ¯
    export_formats = fields.Selection([
        ('excel', 'Excel'),
        ('pdf', 'PDF'),
        ('html', 'HTML'),
        ('json', 'JSON'),
    ], string='æ”¯æŒå¯¼å‡ºæ ¼å¼', default='excel,json')
    
    def generate_report(self):
        """ç”ŸæˆæŠ¥è¡¨"""
        self.ensure_one()
        
        try:
            # æ ¹æ®æŠ¥è¡¨ç±»å‹ç”Ÿæˆæ•°æ®
            if self.report_type == 'follower_growth':
                data = self._generate_follower_growth_report()
            elif self.report_type == 'message_analysis':
                data = self._generate_message_analysis_report()
            elif self.report_type == 'user_behavior':
                data = self._generate_user_behavior_report()
            elif self.report_type == 'menu_performance':
                data = self._generate_menu_performance_report()
            elif self.report_type == 'material_effect':
                data = self._generate_material_effect_report()
            else:
                data = self._generate_custom_report()
            
            self.write({
                'report_data': json.dumps(data, ensure_ascii=False),
                'is_generated': True,
                'generation_time': fields.Datetime.now(),
            })
            
            _logger.info(f"æŠ¥è¡¨ç”ŸæˆæˆåŠŸ: {self.name}")
            return True
            
        except Exception as e:
            _logger.error(f"æŠ¥è¡¨ç”Ÿæˆå¤±è´¥: {str(e)}")
            raise UserError(_('æŠ¥è¡¨ç”Ÿæˆå¤±è´¥: %s') % str(e))
    
    def _generate_follower_growth_report(self):
        """ç”Ÿæˆç²‰ä¸å¢é•¿åˆ†ææŠ¥è¡¨"""
        # è·å–æ¯æ—¥ç»Ÿè®¡æ•°æ®
        stats = self.env['wechat.statistics'].search([
            ('account_id', '=', self.account_id.id),
            ('stat_date', '>=', self.start_date),
            ('stat_date', '<=', self.end_date),
            ('stat_type', '=', 'daily'),
        ], order='stat_date')
        
        # å‡†å¤‡æ•°æ®
        dates = []
        new_followers = []
        unfollowers = []
        net_growth = []
        total_followers = []
        
        for stat in stats:
            dates.append(stat.stat_date.strftime('%Y-%m-%d'))
            new_followers.append(stat.new_followers)
            unfollowers.append(stat.unfollowers)
            net_growth.append(stat.net_followers)
            total_followers.append(stat.total_followers)
        
        # è®¡ç®—å¢é•¿ç‡
        growth_rates = []
        for i in range(1, len(total_followers)):
            if total_followers[i-1] > 0:
                rate = ((total_followers[i] - total_followers[i-1]) / total_followers[i-1]) * 100
                growth_rates.append(round(rate, 2))
            else:
                growth_rates.append(0)
        
        # å¦‚æœæ•°æ®ä¸è¶³ï¼Œåœ¨å‰é¢è¡¥0
        if len(growth_rates) < len(dates):
            growth_rates = [0] * (len(dates) - len(growth_rates)) + growth_rates
        
        # è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡
        total_new = sum(new_followers)
        total_unfollow = sum(unfollowers)
        net_growth_total = sum(net_growth)
        
        avg_daily_new = total_new / len(dates) if dates else 0
        avg_daily_unfollow = total_unfollow / len(dates) if dates else 0
        
        retention_rate = 0
        if total_new > 0:
            retention_rate = ((total_new - total_unfollow) / total_new) * 100
        
        return {
            'type': 'follower_growth',
            'title': 'ç²‰ä¸å¢é•¿åˆ†æ',
            'period': f'{self.start_date} è‡³ {self.end_date}',
            'charts': {
                'growth_trend': {
                    'type': 'line',
                    'title': 'ç²‰ä¸å¢é•¿è¶‹åŠ¿',
                    'data': {
                        'labels': dates,
                        'datasets': [
                            {
                                'label': 'æ–°å¢å…³æ³¨',
                                'data': new_followers,
                                'borderColor': '#36a2eb',
                                'backgroundColor': 'rgba(54, 162, 235, 0.1)',
                            },
                            {
                                'label': 'å–æ¶ˆå…³æ³¨',
                                'data': unfollowers,
                                'borderColor': '#ff6384',
                                'backgroundColor': 'rgba(255, 99, 132, 0.1)',
                            },
                            {
                                'label': 'å‡€å¢å…³æ³¨',
                                'data': net_growth,
                                'borderColor': '#4bc0c0',
                                'backgroundColor': 'rgba(75, 192, 192, 0.1)',
                            },
                        ],
                    },
                },
                'total_followers': {
                    'type': 'line',
                    'title': 'ç´¯è®¡ç²‰ä¸æ•°',
                    'data': {
                        'labels': dates,
                        'datasets': [{
                            'label': 'ç´¯è®¡ç²‰ä¸æ•°',
                            'data': total_followers,
                            'borderColor': '#9966ff',
                            'backgroundColor': 'rgba(153, 102, 255, 0.1)',
                        }],
                    },
                },
                'growth_rate': {
                    'type': 'bar',
                    'title': 'æ—¥å¢é•¿ç‡',
                    'data': {
                        'labels': dates,
                        'datasets': [{
                            'label': 'å¢é•¿ç‡(%)',
                            'data': growth_rates,
                            'backgroundColor': '#ff9f40',
                        }],
                    },
                },
            },
            'summary': {
                'total_new_followers': total_new,
                'total_unfollowers': total_unfollow,
                'net_growth': net_growth_total,
                'avg_daily_new': round(avg_daily_new, 1),
                'avg_daily_unfollow': round(avg_daily_unfollow, 1),
                'retention_rate': round(retention_rate, 2),
                'start_followers': total_followers[0] if total_followers else 0,
                'end_followers': total_followers[-1] if total_followers else 0,
            },
            'recommendations': self._get_follower_growth_recommendations(
                total_new, total_unfollow, retention_rate
            ),
        }
    
    def _generate_message_analysis_report(self):
        """ç”Ÿæˆæ¶ˆæ¯åˆ†ææŠ¥è¡¨"""
        # è·å–æ¶ˆæ¯ç»Ÿè®¡æ•°æ®
        stats = self.env['wechat.statistics'].search([
            ('account_id', '=', self.account_id.id),
            ('stat_date', '>=', self.start_date),
            ('stat_date', '<=', self.end_date),
            ('stat_type', '=', 'daily'),
        ], order='stat_date')
        
        # å‡†å¤‡æ•°æ®
        dates = []
        received_msgs = []
        sent_msgs = []
        reply_rates = []
        
        msg_type_distribution = defaultdict(list)
        
        for stat in stats:
            dates.append(stat.stat_date.strftime('%Y-%m-%d'))
            received_msgs.append(stat.received_messages)
            sent_msgs.append(stat.sent_messages)
            reply_rates.append(stat.reply_rate)
            
            # æ¶ˆæ¯ç±»å‹åˆ†å¸ƒ
            msg_type_distribution['text'].append(stat.text_message_count)
            msg_type_distribution['image'].append(stat.image_message_count)
            msg_type_distribution['voice'].append(stat.voice_message_count)
            msg_type_distribution['video'].append(stat.video_message_count)
            msg_type_distribution['event'].append(stat.event_message_count)
        
        # è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡
        total_received = sum(received_msgs)
        total_sent = sum(sent_msgs)
        avg_reply_rate = sum(reply_rates) / len(reply_rates) if reply_rates else 0
        
        # æ¶ˆæ¯ç±»å‹æ€»è®¡
        type_totals = {
            'text': sum(msg_type_distribution['text']),
            'image': sum(msg_type_distribution['image']),
            'voice': sum(msg_type_distribution['voice']),
            'video': sum(msg_type_distribution['video']),
            'event': sum(msg_type_distribution['event']),
        }
        
        total_messages = sum(type_totals.values())
        type_percentages = {
            msg_type: (count / total_messages * 100) if total_messages > 0 else 0
            for msg_type, count in type_totals.items()
        }
        
        return {
            'type': 'message_analysis',
            'title': 'æ¶ˆæ¯åˆ†æ',
            'period': f'{self.start_date} è‡³ {self.end_date}',
            'charts': {
                'message_volume': {
                    'type': 'line',
                    'title': 'æ¶ˆæ¯é‡è¶‹åŠ¿',
                    'data': {
                        'labels': dates,
                        'datasets': [
                            {
                                'label': 'æ¥æ”¶æ¶ˆæ¯',
                                'data': received_msgs,
                                'borderColor': '#36a2eb',
                                'backgroundColor': 'rgba(54, 162, 235, 0.1)',
                            },
                            {
                                'label': 'å‘é€æ¶ˆæ¯',
                                'data': sent_msgs,
                                'borderColor': '#ff6384',
                                'backgroundColor': 'rgba(255, 99, 132, 0.1)',
                            },
                        ],
                    },
                },
                'reply_rate': {
                    'type': 'line',
                    'title': 'å›å¤ç‡è¶‹åŠ¿',
                    'data': {
                        'labels': dates,
                        'datasets': [{
                            'label': 'å›å¤ç‡(%)',
                            'data': reply_rates,
                            'borderColor': '#4bc0c0',
                            'backgroundColor': 'rgba(75, 192, 192, 0.1)',
                        }],
                    },
                },
                'message_type_distribution': {
                    'type': 'pie',
                    'title': 'æ¶ˆæ¯ç±»å‹åˆ†å¸ƒ',
                    'data': {
                        'labels': ['æ–‡æœ¬æ¶ˆæ¯', 'å›¾ç‰‡æ¶ˆæ¯', 'è¯­éŸ³æ¶ˆæ¯', 'è§†é¢‘æ¶ˆæ¯', 'äº‹ä»¶æ¶ˆæ¯'],
                        'datasets': [{
                            'data': list(type_totals.values()),
                            'backgroundColor': [
                                '#36a2eb', '#ff6384', '#ffcd56', '#4bc0c0', '#9966ff'
                            ],
                        }],
                    },
                },
            },
            'summary': {
                'total_received_messages': total_received,
                'total_sent_messages': total_sent,
                'avg_daily_received': round(total_received / len(dates), 1) if dates else 0,
                'avg_daily_sent': round(total_sent / len(dates), 1) if dates else 0,
                'avg_reply_rate': round(avg_reply_rate, 2),
                'message_type_totals': type_totals,
                'message_type_percentages': type_percentages,
            },
            'recommendations': self._get_message_analysis_recommendations(
                total_received, total_sent, avg_reply_rate, type_percentages
            ),
        }
    
    def _get_follower_growth_recommendations(self, total_new, total_unfollow, retention_rate):
        """è·å–ç²‰ä¸å¢é•¿å»ºè®®"""
        recommendations = []
        
        if retention_rate < 70:
            recommendations.append({
                'title': 'æé«˜ç²‰ä¸ç•™å­˜ç‡',
                'description': f'å½“å‰ç•™å­˜ç‡ä¸º{retention_rate:.1f}%ï¼Œå»ºè®®ä¼˜åŒ–å†…å®¹è´¨é‡å’Œäº’åŠ¨ç­–ç•¥',
                'priority': 'high',
                'actions': [
                    'åˆ†æå–æ¶ˆå…³æ³¨åŸå› ',
                    'ä¼˜åŒ–æ¬¢è¿æ¶ˆæ¯å’Œè‡ªåŠ¨å›å¤',
                    'æé«˜å†…å®¹è´¨é‡å’Œç›¸å…³æ€§',
                ],
            })
        
        if total_new < 100:
            recommendations.append({
                'title': 'å¢åŠ ç²‰ä¸è·å–',
                'description': f'è¿‘æœŸæ–°å¢ç²‰ä¸{total_new}äººï¼Œå»ºè®®åŠ å¤§æ¨å¹¿åŠ›åº¦',
                'priority': 'medium',
                'actions': [
                    'ä¼˜åŒ–å…¬ä¼—å·ä»‹ç»å’Œå¤´åƒ',
                    'é€šè¿‡å…¶ä»–æ¸ é“å¼•æµ',
                    'å¼€å±•ç²‰ä¸é‚€è¯·æ´»åŠ¨',
                ],
            })
        
        if total_unfollow > total_new * 0.3:
            recommendations.append({
                'title': 'å‡å°‘ç²‰ä¸æµå¤±',
                'description': f'å–æ¶ˆå…³æ³¨æ•°è¾ƒé«˜({total_unfollow}äºº)ï¼Œå»ºè®®åˆ†æåŸå› ',
                'priority': 'high',
                'actions': [
                    'æ£€æŸ¥æ˜¯å¦æœ‰è¿‡åº¦è¥é”€',
                    'ä¼˜åŒ–æ¶ˆæ¯å‘é€é¢‘ç‡',
                    'æé«˜å†…å®¹ä»·å€¼',
                ],
            })
        
        # é»˜è®¤å»ºè®®
        recommendations.extend([
            {
                'title': 'å®šæœŸåˆ†æç²‰ä¸æ•°æ®',
                'description': 'æŒç»­ç›‘æ§ç²‰ä¸å¢é•¿å’Œæµå¤±æƒ…å†µ',
                'priority': 'low',
                'actions': ['æ¯å‘¨æŸ¥çœ‹ç²‰ä¸åˆ†ææŠ¥å‘Š'],
            },
            {
                'title': 'ä¼˜åŒ–ç²‰ä¸äº’åŠ¨',
                'description': 'æé«˜ç²‰ä¸æ´»è·ƒåº¦å’Œå‚ä¸åº¦',
                'priority': 'medium',
                'actions': ['å¢åŠ äº’åŠ¨æ´»åŠ¨', 'åŠæ—¶å›å¤ç²‰ä¸æ¶ˆæ¯'],
            },
        ])
        
        return recommendations
    
    def _get_message_analysis_recommendations(self, total_received, total_sent, avg_reply_rate, type_percentages):
        """è·å–æ¶ˆæ¯åˆ†æå»ºè®®"""
        recommendations = []
        
        if avg_reply_rate < 80:
            recommendations.append({
                'title': 'æé«˜æ¶ˆæ¯å›å¤ç‡',
                'description': f'å½“å‰å›å¤ç‡ä¸º{avg_reply_rate:.1f}%ï¼Œå»ºè®®ä¼˜åŒ–å›å¤ç­–ç•¥',
                'priority': 'high',
                'actions': [
                    'è®¾ç½®æ›´å®Œå–„çš„è‡ªåŠ¨å›å¤è§„åˆ™',
                    'ç¼©çŸ­äººå·¥å›å¤æ—¶é—´',
                    'å¢åŠ å¸¸è§é—®é¢˜è‡ªåŠ¨å›å¤',
                ],
            })
        
        if total_received < 50:
            recommendations.append({
                'title': 'æé«˜ç²‰ä¸äº’åŠ¨',
                'description': f'è¿‘æœŸæ¥æ”¶æ¶ˆæ¯{total_received}æ¡ï¼Œäº’åŠ¨è¾ƒå°‘',
                'priority': 'medium',
                'actions': [
                    'å‘èµ·è¯é¢˜è®¨è®º',
                    'å¼€å±•é—®ç­”æ´»åŠ¨',
                    'ä¼˜åŒ–èœå•å¼•å¯¼',
                ],
            })
        
        if type_percentages.get('text', 0) > 80:
            recommendations.append({
                'title': 'ä¸°å¯Œæ¶ˆæ¯ç±»å‹',
                'description': 'æ–‡æœ¬æ¶ˆæ¯å æ¯”è¿‡é«˜ï¼Œå»ºè®®å¢åŠ å¤šåª’ä½“å†…å®¹',
                'priority': 'low',
                'actions': [
                    'å¢åŠ å›¾ç‰‡ã€è¯­éŸ³å›å¤',
                    'ä½¿ç”¨å›¾æ–‡æ¶ˆæ¯',
                    'åˆ¶ä½œçŸ­è§†é¢‘å†…å®¹',
                ],
            })
        
        # é»˜è®¤å»ºè®®
        recommendations.extend([
            {
                'title': 'åˆ†æé«˜å³°æ—¶æ®µ',
                'description': 'åœ¨ç²‰ä¸æ´»è·ƒæ—¶æ®µåŠ å¼ºäº’åŠ¨',
                'priority': 'medium',
                'actions': ['åˆ†ææ¶ˆæ¯æ—¶é—´åˆ†å¸ƒ', 'åœ¨é«˜å³°æ—¶æ®µå¢åŠ äº’åŠ¨'],
            },
            {
                'title': 'ä¼˜åŒ–è‡ªåŠ¨å›å¤',
                'description': 'æé«˜è‡ªåŠ¨å›å¤çš„å‡†ç¡®æ€§å’Œè¦†ç›–åº¦',
                'priority': 'medium',
                'actions': ['åˆ†ææœªåŒ¹é…æ¶ˆæ¯', 'ä¼˜åŒ–å…³é”®è¯è§„åˆ™'],
            },
        ])
        
        return recommendations
```

#### **ä»»åŠ¡2ï¼šæ•°æ®å¯è§†åŒ–ç»„ä»¶**
```python
# file: wechat_platform/lib/data_visualization.py

import json
import logging
from typing import Dict, List, Optional, Any
from datetime import datetime, timedelta
import math

_logger = logging.getLogger(__name__)

class DataVisualizer:
    """æ•°æ®å¯è§†åŒ–ç»„ä»¶"""
    
    def __init__(self):
        self.chart_types = {
            'line': self._create_line_chart,
            'bar': self._create_bar_chart,
            'pie': self._create_pie_chart,
            'doughnut': self._create_doughnut_chart,
            'radar': self._create_radar_chart,
            'scatter': self._create_scatter_chart,
            'heatmap': self._create_heatmap_chart,
        }
        
        self.color_palettes = {
            'default': ['#36a2eb', '#ff6384', '#ffcd56', '#4bc0c0', '#9966ff', '#ff9f40', '#c9cbcf'],
            'vibrant': ['#FF6B6B', '#4ECDC4', '#FFE66D', '#1A535C', '#FF9F1C', '#2EC4B6', '#E71D36'],
            'pastel': ['#A8E6CF', '#DCEDC1', '#FFD3B6', '#FFAAA5', '#FF8B94', '#D4A5A5', '#9B97B2'],
            'mono': ['#333333', '#666666', '#999999', '#CCCCCC', '#E6E6E6'],
        }
    
    def create_chart(self, chart_type: str, data: Dict, options: Dict = None) -> Dict:
        """åˆ›å»ºå›¾è¡¨"""
        if chart_type not in self.chart_types:
            raise ValueError(f"ä¸æ”¯æŒçš„å›¾è¡¨ç±»å‹: {chart_type}")
        
        chart_function = self.chart_types[chart_type]
        return chart_function(data, options or {})
    
    def _create_line_chart(self, data: Dict, options: Dict) -> Dict:
        """åˆ›å»ºæŠ˜çº¿å›¾"""
        chart_config = {
            'type': 'line',
            'data': {
                'labels': data.get('labels', []),
                'datasets': [],
            },
            'options': {
                'responsive': True,
                'plugins': {
                    'title': {
                        'display': options.get('show_title', True),
                        'text': options.get('title', 'æŠ˜çº¿å›¾'),
                    },
                    'legend': {
                        'display': options.get('show_legend', True),
                        'position': options.get('legend_position', 'top'),
                    },
                    'tooltip': {
                        'mode': 'index',
                        'intersect': False,
                    },
                },
                'scales': {
                    'x': {
                        'display': True,
                        'title': {
                            'display': options.get('show_x_title', False),
                            'text': options.get('x_title', ''),
                        },
                    },
                    'y': {
                        'display': True,
                        'title': {
                            'display': options.get('show_y_title', False),
                            'text': options.get('y_title', ''),
                        },
                        'beginAtZero': options.get('begin_at_zero', True),
                    },
                },
            },
        }
        
        # æ·»åŠ æ•°æ®é›†
        datasets = data.get('datasets', [])
        palette = self.color_palettes.get(options.get('color_palette', 'default'))
        
        for i, dataset in enumerate(datasets):
            color_index = i % len(palette)
            
            chart_dataset = {
                'label': dataset.get('label', f'æ•°æ®é›†{i+1}'),
                'data': dataset.get('data', []),
                'borderColor': dataset.get('border_color', palette[color_index]),
                'backgroundColor': dataset.get('background_color', 'rgba(0, 0, 0, 0)'),
                'borderWidth': dataset.get('border_width', 2),
                'fill': dataset.get('fill', False),
                'tension': dataset.get('tension', 0.1),
            }
            
            if 'point_style' in dataset:
                chart_dataset['pointStyle'] = dataset['point_style']
            
            chart_config['data']['datasets'].append(chart_dataset)
        
        return chart_config
    
    def _create_bar_chart(self, data: Dict, options: Dict) -> Dict:
        """åˆ›å»ºæŸ±çŠ¶å›¾"""
        chart_config = {
            'type': 'bar',
            'data': {
                'labels': data.get('labels', []),
                'datasets': [],
            },
            'options': {
                'responsive': True,
                'plugins': {
                    'title': {
                        'display': options.get('show_title', True),
                        'text': options.get('title', 'æŸ±çŠ¶å›¾'),
                    },
                    'legend': {
                        'display': options.get('show_legend', True),
                        'position': options.get('legend_position', 'top'),
                    },
                },
                'scales': {
                    'x': {
                        'display': True,
                        'title': {
                            'display': options.get('show_x_title', False),
                            'text': options.get('x_title', ''),
                        },
                    },
                    'y': {
                        'display': True,
                        'title': {
                            'display': options.get('show_y_title', False),
                            'text': options.get('y_title', ''),
                        },
                        'beginAtZero': options.get('begin_at_zero', True),
                    },
                },
            },
        }
        
        # æ·»åŠ æ•°æ®é›†
        datasets = data.get('datasets', [])
        palette = self.color_palettes.get(options.get('color_palette', 'default'))
        
        for i, dataset in enumerate(datasets):
            color_index = i % len(palette)
            
            chart_dataset = {
                'label': dataset.get('label', f'æ•°æ®é›†{i+1}'),
                'data': dataset.get('data', []),
                'backgroundColor': dataset.get('background_color', palette[color_index]),
                'borderColor': dataset.get('border_color', '#FFFFFF'),
                'borderWidth': dataset.get('border_width', 1),
                'borderRadius': dataset.get('border_radius', 0),
            }
            
            chart_config['data']['datasets'].append(chart_dataset)
        
        return chart_config
    
    def _create_pie_chart(self, data: Dict, options: Dict) -> Dict:
        """åˆ›å»ºé¥¼å›¾"""
        chart_config = {
            'type': 'pie',
            'data': {
                'labels': data.get('labels', []),
                'datasets': [{
                    'data': data.get('data', []),
                    'backgroundColor': [],
                    'borderColor': options.get('border_color', '#FFFFFF'),
                    'borderWidth': options.get('border_width', 1),
                }],
            },
            'options': {
                'responsive': True,
                'plugins': {
                    'title': {
                        'display': options.get('show_title', True),
                        'text': options.get('title', 'é¥¼å›¾'),
                    },
                    'legend': {
                        'display': options.get('show_legend', True),
                        'position': options.get('legend_position', 'right'),
                    },
                    'tooltip': {
                        'callbacks': {
                            'label': self._pie_tooltip_callback,
                        },
                    },
                },
            },
        }
        
        # è®¾ç½®é¢œè‰²
        palette = self.color_palettes.get(options.get('color_palette', 'default'))
        data_values = data.get('data', [])
        
        for i in range(len(data_values)):
            color_index = i % len(palette)
            chart_config['data']['datasets'][0]['backgroundColor'].append(palette[color_index])
        
        return chart_config
    
    def _pie_tooltip_callback(self, context):
        """é¥¼å›¾å·¥å…·æç¤ºå›è°ƒ"""
        label = context.label or ''
        value = context.raw or 0
        total = sum(context.dataset.data)
        percentage = (value / total * 100) if total > 0 else 0
        
        return f"{label}: {value} ({percentage:.1f}%)"
    
    def _create_doughnut_chart(self, data: Dict, options: Dict) -> Dict:
        """åˆ›å»ºç¯å½¢å›¾"""
        pie_config = self._create_pie_chart(data, options)
        pie_config['type'] = 'doughnut'
        
        # æ·»åŠ ç¯å½¢å›¾ç‰¹å®šé€‰é¡¹
        if 'cutout' in options:
            pie_config.setdefault('options', {}).setdefault('cutout', options['cutout'])
        else:
            pie_config.setdefault('options', {}).setdefault('cutout', '60%')
        
        return pie_config
    
    def _create_radar_chart(self, data: Dict, options: Dict) -> Dict:
        """åˆ›å»ºé›·è¾¾å›¾"""
        chart_config = {
            'type': 'radar',
            'data': {
                'labels': data.get('labels', []),
                'datasets': [],
            },
            'options': {
                'responsive': True,
                'plugins': {
                    'title': {
                        'display': options.get('show_title', True),
                        'text': options.get('title', 'é›·è¾¾å›¾'),
                    },
                    'legend': {
                        'display': options.get('show_legend', True),
                        'position': options.get('legend_position', 'top'),
                    },
                },
                'scales': {
                    'r': {
                        'beginAtZero': options.get('begin_at_zero', True),
                        'ticks': {
                            'stepSize': options.get('step_size', None),
                        },
                    },
                },
            },
        }
        
        # æ·»åŠ æ•°æ®é›†
        datasets = data.get('datasets', [])
        palette = self.color_palettes.get(options.get('color_palette', 'default'))
        
        for i, dataset in enumerate(datasets):
            color_index = i % len(palette)
            
            chart_dataset = {
                'label': dataset.get('label', f'æ•°æ®é›†{i+1}'),
                'data': dataset.get('data', []),
                'backgroundColor': dataset.get('background_color', f'rgba({self._hex_to_rgb(palette[color_index])}, 0.2)'),
                'borderColor': dataset.get('border_color', palette[color_index]),
                'borderWidth': dataset.get('border_width', 2),
                'pointBackgroundColor': palette[color_index],
                'pointBorderColor': '#FFFFFF',
                'pointBorderWidth': 1,
            }
            
            chart_config['data']['datasets'].append(chart_dataset)
        
        return chart_config
    
    def _hex_to_rgb(self, hex_color):
        """åå…­è¿›åˆ¶é¢œè‰²è½¬RGB"""
        hex_color = hex_color.lstrip('#')
        if len(hex_color) == 3:
            hex_color = ''.join([c*2 for c in hex_color])
        
        return tuple(int(hex_color[i:i+2], 16) for i in (0, 2, 4))
    
    def create_dashboard(self, widgets: List[Dict]) -> Dict:
        """åˆ›å»ºä»ªè¡¨ç›˜"""
        dashboard = {
            'title': 'å¾®ä¿¡æ•°æ®åˆ†æä»ªè¡¨ç›˜',
            'layout': 'grid',  # grid, flex, custom
            'widgets': [],
            'settings': {
                'auto_refresh': False,
                'refresh_interval': 300,  # ç§’
                'theme': 'light',  # light, dark
                'density': 'normal',  # compact, normal, comfortable
            },
        }
        
        for widget in widgets:
            widget_config = self._create_widget(widget)
            dashboard['widgets'].append(widget_config)
        
        return dashboard
    
    def _create_widget(self, widget: Dict) -> Dict:
        """åˆ›å»ºå°éƒ¨ä»¶"""
        widget_type = widget.get('type', 'chart')
        
        if widget_type == 'chart':
            return self._create_chart_widget(widget)
        elif widget_type == 'metric':
            return self._create_metric_widget(widget)
        elif widget_type == 'table':
            return self._create_table_widget(widget)
        elif widget_type == 'list':
            return self._create_list_widget(widget)
        else:
            raise ValueError(f"ä¸æ”¯æŒçš„å°éƒ¨ä»¶ç±»å‹: {widget_type}")
    
    def _create_chart_widget(self, widget: Dict) -> Dict:
        """åˆ›å»ºå›¾è¡¨å°éƒ¨ä»¶"""
        chart_data = widget.get('data', {})
        chart_options = widget.get('options', {})
        
        chart_config = self.create_chart(
            widget.get('chart_type', 'line'),
            chart_data,
            chart_options
        )
        
        return {
            'type': 'chart',
            'id': widget.get('id', f"chart_{len(widget)}"),
            'title': widget.get('title', 'å›¾è¡¨'),
            'size': widget.get('size', 'medium'),  # small, medium, large, xlarge
            'position': widget.get('position', {}),
            'config': chart_config,
            'actions': widget.get('actions', []),
        }
    
    def _create_metric_widget(self, widget: Dict) -> Dict:
        """åˆ›å»ºæŒ‡æ ‡å°éƒ¨ä»¶"""
        value = widget.get('value', 0)
        previous_value = widget.get('previous_value', None)
        
        change = None
        change_percentage = None
        
        if previous_value is not None and previous_value != 0:
            change = value - previous_value
            change_percentage = (change / previous_value) * 100
        
        return {
            'type': 'metric',
            'id': widget.get('id', f"metric_{len(widget)}"),
            'title': widget.get('title', 'æŒ‡æ ‡'),
            'value': value,
            'formatter': widget.get('formatter', 'number'),
            'unit': widget.get('unit', ''),
            'change': change,
            'change_percentage': change_percentage,
            'trend': 'up' if change and change > 0 else 'down' if change and change < 0 else 'neutral',
            'size': widget.get('size', 'small'),
            'icon': widget.get('icon', None),
            'color': widget.get('color', 'primary'),
        }
    
    def _create_table_widget(self, widget: Dict) -> Dict:
        """åˆ›å»ºè¡¨æ ¼å°éƒ¨ä»¶"""
        columns = widget.get('columns', [])
        rows = widget.get('rows', [])
        
        return {
            'type': 'table',
            'id': widget.get('id', f"table_{len(widget)}"),
            'title': widget.get('title', 'è¡¨æ ¼'),
            'columns': columns,
            'rows': rows,
            'pagination': widget.get('pagination', True),
            'page_size': widget.get('page_size', 10),
            'sortable': widget.get('sortable', True),
            'filterable': widget.get('filterable', True),
            'size': widget.get('size', 'medium'),
        }
    
    def _create_list_widget(self, widget: Dict) -> Dict:
        """åˆ›å»ºåˆ—è¡¨å°éƒ¨ä»¶"""
        items = widget.get('items', [])
        
        return {
            'type': 'list',
            'id': widget.get('id', f"list_{len(widget)}"),
            'title': widget.get('title', 'åˆ—è¡¨'),
            'items': items,
            'item_template': widget.get('item_template', None),
            'max_items': widget.get('max_items', 10),
            'size': widget.get('size', 'small'),
        }
    
    def generate_report_template(self, template_type: str, data: Dict) -> Dict:
        """ç”ŸæˆæŠ¥è¡¨æ¨¡æ¿"""
        templates = {
            'daily_summary': self._daily_summary_template,
            'weekly_report': self._weekly_report_template,
            'monthly_analysis': self._monthly_analysis_template,
            'performance_review': self._performance_review_template,
        }
        
        if template_type not in templates:
            raise ValueError(f"ä¸æ”¯æŒçš„æŠ¥è¡¨æ¨¡æ¿: {template_type}")
        
        return templates[template_type](data)
    
    def _daily_summary_template(self, data: Dict) -> Dict:
        """æ—¥æŠ¥æ¨¡æ¿"""
        return {
            'title': 'å¾®ä¿¡è¿è¥æ—¥æŠ¥',
            'sections': [
                {
                    'title': 'æ ¸å¿ƒæŒ‡æ ‡æ¦‚è§ˆ',
                    'type': 'metrics',
                    'metrics': [
                        {
                            'title': 'æ–°å¢ç²‰ä¸',
                            'value': data.get('new_followers', 0),
                            'change': data.get('new_followers_change', 0),
                            'icon': 'user-plus',
                        },
                        {
                            'title': 'æ¥æ”¶æ¶ˆæ¯',
                            'value': data.get('received_messages', 0),
                            'change': data.get('received_messages_change', 0),
                            'icon': 'message-square',
                        },
                        {
                            'title': 'å›å¤ç‡',
                            'value': f"{data.get('reply_rate', 0):.1f}%",
                            'change': data.get('reply_rate_change', 0),
                            'icon': 'repeat',
                        },
                        {
                            'title': 'æ´»è·ƒç”¨æˆ·',
                            'value': data.get('active_users', 0),
                            'change': data.get('active_users_change', 0),
                            'icon': 'activity',
                        },
                    ],
                },
                {
                    'title': 'ç²‰ä¸å¢é•¿è¶‹åŠ¿',
                    'type': 'chart',
                    'chart_type': 'line',
                    'data': data.get('follower_growth_data', {}),
                },
                {
                    'title': 'æ¶ˆæ¯ç±»å‹åˆ†å¸ƒ',
                    'type': 'chart',
                    'chart_type': 'pie',
                    'data': data.get('message_type_data', {}),
                },
                {
                    'title': 'çƒ­é—¨å…³é”®è¯',
                    'type': 'list',
                    'items': data.get('top_keywords', []),
                },
            ],
        }
    
    def _weekly_report_template(self, data: Dict) -> Dict:
        """å‘¨æŠ¥æ¨¡æ¿"""
        return {
            'title': 'å¾®ä¿¡è¿è¥å‘¨æŠ¥',
            'period': data.get('period', ''),
            'sections': [
                {
                    'title': 'æœ¬å‘¨æ€»ç»“',
                    'type': 'summary',
                    'content': data.get('summary', ''),
                },
                {
                    'title': 'å…³é”®æŒ‡æ ‡å¯¹æ¯”',
                    'type': 'metrics',
                    'metrics': [
                        {
                            'title': 'æ–°å¢ç²‰ä¸',
                            'value': data.get('weekly_new_followers', 0),
                            'change': data.get('weekly_new_followers_change', 0),
                            'comparison': f"ä¸Šå‘¨: {data.get('last_week_new_followers', 0)}",
                        },
                        {
                            'title': 'æ¶ˆæ¯æ€»é‡',
                            'value': data.get('weekly_messages', 0),
                            'change': data.get('weekly_messages_change', 0),
                            'comparison': f"ä¸Šå‘¨: {data.get('last_week_messages', 0)}",
                        },
                        {
                            'title': 'å¹³å‡å›å¤ç‡',
                            'value': f"{data.get('weekly_reply_rate', 0):.1f}%",
                            'change': data.get('weekly_reply_rate_change', 0),
                            'comparison': f"ä¸Šå‘¨: {data.get('last_week_reply_rate', 0):.1f}%",
                        },
                        {
                            'title': 'ç²‰ä¸ç•™å­˜ç‡',
                            'value': f"{data.get('retention_rate', 0):.1f}%",
                            'change': data.get('retention_rate_change', 0),
                            'comparison': f"ä¸Šå‘¨: {data.get('last_week_retention_rate', 0):.1f}%",
                        },
                    ],
                },
                {
                    'title': 'ç²‰ä¸å¢é•¿è¶‹åŠ¿',
                    'type': 'chart',
                    'chart_type': 'line',
                    'data': data.get('weekly_growth_data', {}),
                },
                {
                    'title': 'ç”¨æˆ·æ´»è·ƒæ—¶æ®µ',
                    'type': 'chart',
                    'chart_type': 'bar',
                    'data': data.get('active_hours_data', {}),
                },
                {
                    'title': 'å»ºè®®ä¸æ”¹è¿›',
                    'type': 'recommendations',
                    'items': data.get('recommendations', []),
                },
            ],
        }
    
    def _monthly_analysis_template(self, data: Dict) -> Dict:
        """æœˆæŠ¥æ¨¡æ¿"""
        return {
            'title': 'å¾®ä¿¡è¿è¥æœˆæŠ¥',
            'period': data.get('period', ''),
            'sections': [
                {
                    'title': 'æœˆåº¦æ¦‚è§ˆ',
                    'type': 'overview',
                    'content': data.get('overview', ''),
                },
                {
                    'title': 'æœˆåº¦æŒ‡æ ‡è¶‹åŠ¿',
                    'type': 'chart',
                    'chart_type': 'line',
                    'data': data.get('monthly_trends_data', {}),
                },
                {
                    'title': 'ç”¨æˆ·è¡Œä¸ºåˆ†æ',
                    'type': 'analysis',
                    'charts': [
                        {
                            'title': 'ç”¨æˆ·åœ°åŸŸåˆ†å¸ƒ',
                            'type': 'map',
                            'data': data.get('user_location_data', {}),
                        },
                        {
                            'title': 'ç”¨æˆ·æ¥æºåˆ†æ',
                            'type': 'pie',
                            'data': data.get('user_source_data', {}),
                        },
                    ],
                },
                {
                    'title': 'å†…å®¹æ•ˆæœåˆ†æ',
                    'type': 'analysis',
                    'tables': [
                        {
                            'title': 'çƒ­é—¨æ–‡ç« TOP10',
                            'data': data.get('top_articles', []),
                        },
                        {
                            'title': 'çƒ­é—¨èœå•é¡¹',
                            'data': data.get('top_menus', []),
                        },
                    ],
                },
                {
                    'title': 'ä¸‹æœˆè®¡åˆ’',
                    'type': 'plan',
                    'items': data.get('next_month_plan', []),
                },
            ],
        }
```

### **å‰ç«¯å¼€å‘å…·ä½“ä»»åŠ¡ï¼š**

#### **ä»»åŠ¡1ï¼šæ•°æ®å¯è§†åŒ–ä»ªè¡¨ç›˜ç•Œé¢**
```xml
<!-- file: wechat_platform/static/src/xml/wechat_dashboard.xml -->

<templates id="template" xml:space="preserve">
    
    <!-- ä¸»ä»ªè¡¨ç›˜ç•Œé¢ -->
    <t t-name="wechat_platform.DashboardView" owl="1">
        <div class="wechat-dashboard">
            <!-- ä»ªè¡¨ç›˜å¤´éƒ¨ -->
            <div class="dashboard-header">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 class="mb-1">
                            <i class="fa fa-tachometer me-2"></i>
                            å¾®ä¿¡æ•°æ®åˆ†æä»ªè¡¨ç›˜
                        </h1>
                        <p class="text-muted mb-0">
                            å®æ—¶ç›‘æ§å…¬ä¼—å·è¿è¥æ•°æ®ï¼ŒåŠ©åŠ›å†³ç­–åˆ†æ
                        </p>
                    </div>
                    
                    <div class="dashboard-controls">
                        <div class="btn-group me-2">
                            <button class="btn btn-outline-secondary" 
                                    t-on-click="refreshDashboard">
                                <i class="fa fa-refresh me-1"></i>
                                åˆ·æ–°
                            </button>
                            <button class="btn btn-outline-secondary" 
                                    t-on-click="toggleAutoRefresh">
                                <i t-if="state.autoRefresh" class="fa fa-pause me-1"></i>
                                <i t-else="" class="fa fa-play me-1"></i>
                                <span t-if="state.autoRefresh">æš‚åœ</span>
                                <span t-else="">è‡ªåŠ¨åˆ·æ–°</span>
                            </button>
                        </div>
                        
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" 
                                    type="button" 
                                    data-bs-toggle="dropdown">
                                <i class="fa fa-calendar me-1"></i>
                                <span t-esc="state.periodLabel"/>
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <a class="dropdown-item" href="#" 
                                       t-on-click.prevent="changePeriod('today')">
                                        ä»Šæ—¥
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" 
                                       t-on-click.prevent="changePeriod('yesterday')">
                                        æ˜¨æ—¥
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"/></li>
                                <li>
                                    <a class="dropdown-item" href="#" 
                                       t-on-click.prevent="changePeriod('7d')">
                                        æœ€è¿‘7å¤©
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" 
                                       t-on-click.prevent="changePeriod('30d')">
                                        æœ€è¿‘30å¤©
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" 
                                       t-on-click.prevent="changePeriod('90d')">
                                        æœ€è¿‘90å¤©
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"/></li>
                                <li>
                                    <a class="dropdown-item" href="#" 
                                       t-on-click.prevent="showCustomDatePicker">
                                        è‡ªå®šä¹‰æ—¥æœŸ
                                    </a>
                                </li>
                            </ul>
                        </div>
                        
                        <button class="btn btn-primary ms-2" 
                                t-on-click="exportDashboard">
                            <i class="fa fa-download me-1"></i>
                            å¯¼å‡ºæŠ¥å‘Š
                        </button>
                    </div>
                </div>
                
                <!-- æ—¥æœŸé€‰æ‹©å™¨ï¼ˆè‡ªå®šä¹‰æ—¥æœŸï¼‰ -->
                <t t-if="state.showDatePicker">
                    <div class="custom-date-picker card mb-4">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-5">
                                    <label class="form-label">å¼€å§‹æ—¥æœŸ</label>
                                    <input type="date" class="form-control" 
                                           t-model="state.customStartDate"/>
                                </div>
                                <div class="col-md-5">
                                    <label class="form-label">ç»“æŸæ—¥æœŸ</label>
                                    <input type="date" class="form-control" 
                                           t-model="state.customEndDate"/>
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-primary w-100" 
                                            t-on-click="applyCustomDate">
                                        åº”ç”¨
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </t>
            </div>
            
            <!-- KPIæŒ‡æ ‡å¡ç‰‡ -->
            <div class="kpi-cards mb-4">
                <div class="row">
                    <!-- æ€»ç²‰ä¸æ•° -->
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card kpi-card border-start border-primary border-4">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted mb-2">æ€»ç²‰ä¸æ•°</h6>
                                        <h2 class="mb-0" t-esc="formatNumber(state.kpiData.totalFollowers)"/>
                                    </div>
                                    <div class="kpi-icon bg-primary">
                                        <i class="fa fa-users text-white"></i>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <span class="badge" 
                                          t-att-class="state.kpiData.followerChange >= 0 ? 'bg-success' : 'bg-danger'">
                                        <i t-if="state.kpiData.followerChange >= 0" class="fa fa-arrow-up me-1"></i>
                                        <i t-else="" class="fa fa-arrow-down me-1"></i>
                                        <span t-esc="Math.abs(state.kpiData.followerChange)"/>
                                    </span>
                                    <small class="text-muted ms-2">è¾ƒæ˜¨æ—¥</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ–°å¢ç²‰ä¸ -->
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card kpi-card border-start border-success border-4">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted mb-2">æ–°å¢ç²‰ä¸</h6>
                                        <h2 class="mb-0" t-esc="formatNumber(state.kpiData.newFollowers)"/>
                                    </div>
                                    <div class="kpi-icon bg-success">
                                        <i class="fa fa-user-plus text-white"></i>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <span class="badge" 
                                          t-att-class="state.kpiData.newFollowerChange >= 0 ? 'bg-success' : 'bg-danger'">
                                        <i t-if="state.kpiData.newFollowerChange >= 0" class="fa fa-arrow-up me-1"></i>
                                        <i t-else="" class="fa fa-arrow-down me-1"></i>
                                        <span t-esc="Math.abs(state.kpiData.newFollowerChange)"/>
                                    </span>
                                    <small class="text-muted ms-2">è¾ƒæ˜¨æ—¥</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ¶ˆæ¯å›å¤ç‡ -->
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card kpi-card border-start border-info border-4">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted mb-2">æ¶ˆæ¯å›å¤ç‡</h6>
                                        <h2 class="mb-0">
                                            <span t-esc="state.kpiData.replyRate.toFixed(1)"/>%
                                        </h2>
                                    </div>
                                    <div class="kpi-icon bg-info">
                                        <i class="fa fa-reply text-white"></i>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <span class="badge" 
                                          t-att-class="state.kpiData.replyRateChange >= 0 ? 'bg-success' : 'bg-danger'">
                                        <i t-if="state.kpiData.replyRateChange >= 0" class="fa fa-arrow-up me-1"></i>
                                        <i t-else="" class="fa fa-arrow-down me-1"></i>
                                        <span t-esc="Math.abs(state.kpiData.replyRateChange.toFixed(1))"/>%
                                    </span>
                                    <small class="text-muted ms-2">è¾ƒæ˜¨æ—¥</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ´»è·ƒç”¨æˆ· -->
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card kpi-card border-start border-warning border-4">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted mb-2">æ´»è·ƒç”¨æˆ·</h6>
                                        <h2 class="mb-0" t-esc="formatNumber(state.kpiData.activeUsers)"/>
                                    </div>
                                    <div class="kpi-icon bg-warning">
                                        <i class="fa fa-bolt text-white"></i>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <span class="badge" 
                                          t-att-class="state.kpiData.activeUserChange >= 0 ? 'bg-success' : 'bg-danger'">
                                        <i t-if="state.kpiData.activeUserChange >= 0" class="fa fa-arrow-up me-1"></i>
                                        <i t-else="" class="fa fa-arrow-down me-1"></i>
                                        <span t-esc="Math.abs(state.kpiData.activeUserChange)"/>
                                    </span>
                                    <small class="text-muted ms-2">è¾ƒæ˜¨æ—¥</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å›¾è¡¨åŒºåŸŸ -->
            <div class="dashboard-charts">
                <div class="row">
                    <!-- ç²‰ä¸å¢é•¿è¶‹åŠ¿ -->
                    <div class="col-xl-8 mb-4">
                        <div class="card chart-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fa fa-line-chart me-2"></i>
                                    ç²‰ä¸å¢é•¿è¶‹åŠ¿
                                </h5>
                                <div class="chart-controls">
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-secondary" 
                                                t-att-class="state.chartSettings.followerChartType === 'line' ? 'active' : ''"
                                                t-on-click="() => changeChartType('follower', 'line')">
                                            æŠ˜çº¿å›¾
                                        </button>
                                        <button class="btn btn-outline-secondary" 
                                                t-att-class="state.chartSettings.followerChartType === 'bar' ? 'active' : ''"
                                                t-on-click="() => changeChartType('follower', 'bar')">
                                            æŸ±çŠ¶å›¾
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="height: 300px;">
                                    <canvas t-ref="followerChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ¶ˆæ¯ç±»å‹åˆ†å¸ƒ -->
                    <div class="col-xl-4 mb-4">
                        <div class="card chart-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fa fa-pie-chart me-2"></i>
                                    æ¶ˆæ¯ç±»å‹åˆ†å¸ƒ
                                </h5>
                                <div class="chart-controls">
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-secondary" 
                                                t-att-class="state.chartSettings.messageChartType === 'pie' ? 'active' : ''"
                                                t-on-click="() => changeChartType('message', 'pie')">
                                            é¥¼å›¾
                                        </button>
                                        <button class="btn btn-outline-secondary" 
                                                t-att-class="state.chartSettings.messageChartType === 'doughnut' ? 'active' : ''"
                                                t-on-click="() => changeChartType('message', 'doughnut')">
                                            ç¯å½¢å›¾
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="height: 300px;">
                                    <canvas t-ref="messageChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <!-- ç”¨æˆ·æ´»è·ƒæ—¶æ®µ -->
                    <div class="col-xl-6 mb-4">
                        <div class="card chart-card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fa fa-clock-o me-2"></i>
                                    ç”¨æˆ·æ´»è·ƒæ—¶æ®µåˆ†å¸ƒ
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="height: 250px;">
                                    <canvas t-ref="activeHoursChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç”¨æˆ·åœ°åŸŸåˆ†å¸ƒ -->
                    <div class="col-xl-6 mb-4">
                        <div class="card chart-card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fa fa-map-marker me-2"></i>
                                    ç”¨æˆ·åœ°åŸŸåˆ†å¸ƒ TOP10
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="height: 250px;">
                                    <canvas t-ref="locationChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ•°æ®è¡¨æ ¼ -->
            <div class="dashboard-tables">
                <div class="row">
                    <!-- æœ€æ–°æ¶ˆæ¯ -->
                    <div class="col-xl-6 mb-4">
                        <div class="card table-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fa fa-comments me-2"></i>
                                    æœ€æ–°æ¶ˆæ¯
                                </h5>
                                <a href="#" t-on-click.prevent="viewAllMessages">
                                    æŸ¥çœ‹å…¨éƒ¨ <i class="fa fa-arrow-right"></i>
                                </a>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>ç”¨æˆ·</th>
                                                <th>æ¶ˆæ¯</th>
                                                <th>æ—¶é—´</th>
                                                <th>çŠ¶æ€</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="state.recentMessages" t-as="message">
                                                <tr t-on-click="() => viewMessageDetail(message.id)"
                                                    style="cursor: pointer;">
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="user-avatar me-2">
                                                                <t t-if="message.user_avatar">
                                                                    <img t-att-src="message.user_avatar" 
                                                                         class="rounded-circle" 
                                                                         style="width: 24px; height: 24px;"/>
                                                                </t>
                                                                <t t-else="">
                                                                    <div class="avatar-placeholder rounded-circle bg-secondary d-flex align-items-center justify-content-center" 
                                                                         style="width: 24px; height: 24px;">
                                                                        <i class="fa fa-user text-white" style="font-size: 12px;"></i>
                                                                    </div>
                                                                </t>
                                                            </div>
                                                            <div>
                                                                <div class="fw-medium" 
                                                                     t-esc="message.user_name or 'æœªçŸ¥ç”¨æˆ·'"/>
                                                                <small class="text-muted" 
                                                                       t-esc="message.openid ? message.openid.substring(0, 6) + '...' : ''"/>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div class="message-preview">
                                                            <t t-if="message.msg_type === 'text'">
                                                                <span t-esc="message.content ? (message.content.length > 30 ? message.content.substring(0, 30) + '...' : message.content) : ''"/>
                                                            </t>
                                                            <t t-elif="message.msg_type === 'image'">
                                                                <span class="text-muted">
                                                                    <i class="fa fa-image me-1"></i>
                                                                    å›¾ç‰‡æ¶ˆæ¯
                                                                </span>
                                                            </t>
                                                            <t t-elif="message.msg_type === 'voice'">
                                                                <span class="text-muted">
                                                                    <i class="fa fa-microphone me-1"></i>
                                                                    è¯­éŸ³æ¶ˆæ¯
                                                                </span>
                                                            </t>
                                                            <t t-else="">
                                                                <span class="text-muted">
                                                                    <i class="fa fa-info-circle me-1"></i>
                                                                    å…¶ä»–æ¶ˆæ¯
                                                                </span>
                                                            </t>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <small class="text-muted" 
                                                               t-esc="formatTime(message.create_time)"/>
                                                    </td>
                                                    <td>
                                                        <span t-att-class="'badge ' + getMessageStatusBadge(message.status)">
                                                            <t t-switch="message.status">
                                                                <t t-case="'received'">æœªå¤„ç†</t>
                                                                <t t-case="'processed'">å·²å¤„ç†</t>
                                                                <t t-case="'replied'">å·²å›å¤</t>
                                                                <t t-case="'failed'">å¤±è´¥</t>
                                                            </t>
                                                        </span>
                                                    </td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- çƒ­é—¨å…³é”®è¯ -->
                    <div class="col-xl-6 mb-4">
                        <div class="card table-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fa fa-tags me-2"></i>
                                    çƒ­é—¨å…³é”®è¯
                                </h5>
                                <a href="#" t-on-click.prevent="viewKeywordAnalysis">
                                    è¯¦ç»†åˆ†æ <i class="fa fa-arrow-right"></i>
                                </a>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th>å…³é”®è¯</th>
                                                <th>è§¦å‘æ¬¡æ•°</th>
                                                <th>å›å¤ç‡</th>
                                                <th>è¶‹åŠ¿</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="state.topKeywords" t-as="keyword">
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <span class="badge bg-light text-dark me-2">
                                                                #<span t-esc="keyword.rank"/>
                                                            </span>
                                                            <span t-esc="keyword.word"/>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span t-esc="formatNumber(keyword.count)"/>
                                                        <small class="text-muted ms-1">æ¬¡</small>
                                                    </td>
                                                    <td>
                                                        <div class="progress" style="height: 6px;">
                                                            <div class="progress-bar" 
                                                                 role="progressbar" 
                                                                 t-att-style="'width: ' + keyword.reply_rate + '%;'"
                                                                 t-att-aria-valuenow="keyword.reply_rate"
                                                                 aria-valuemin="0" 
                                                                 aria-valuemax="100">
                                                            </div>
                                                        </div>
                                                        <small class="text-muted">
                                                            <span t-esc="keyword.reply_rate.toFixed(1)"/>%
                                                        </small>
                                                    </td>
                                                    <td>
                                                        <span t-att-class="keyword.trend === 'up' ? 'text-success' : keyword.trend === 'down' ? 'text-danger' : 'text-muted'">
                                                            <i t-if="keyword.trend === 'up'" class="fa fa-arrow-up"></i>
                                                            <i t-elif="keyword.trend === 'down'" class="fa fa-arrow-down"></i>
                                                            <i t-else="" class="fa fa-minus"></i>
                                                            <span class="ms-1" t-esc="keyword.change + '%'"/>
                                                        </span>
                                                    </td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- åŠ è½½çŠ¶æ€ -->
            <t t-if="state.loading">
                <div class="loading-overlay">
                    <div class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                        <p class="mt-3">æ­£åœ¨åŠ è½½æ•°æ®...</p>
                    </div>
                </div>
            </t>
        </div>
    </t>
    
    <!-- æ ·å¼ -->
    <style>
        .wechat-dashboard {
            background: #f8f9fa;
            min-height: 100vh;
            padding: 20px;
        }
        
        .dashboard-header {
            margin-bottom: 30px;
        }
        
        .dashboard-controls {
            display: flex;
            align-items: center;
        }
        
        .custom-date-picker {
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .kpi-card {
            transition: all 0.3s ease;
        }
        
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .kpi-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .chart-card {
            height: 100%;
        }
        
        .chart-card .card-body {
            padding: 20px;
        }
        
        .chart-container {
            position: relative;
        }
        
        .table-card .card-body {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .user-avatar img {
            object-fit: cover;
        }
        
        .avatar-placeholder {
            font-size: 12px;
        }
        
        .message-preview {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .wechat-dashboard {
                padding: 10px;
            }
            
            .dashboard-controls {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .kpi-card {
                margin-bottom: 15px;
            }
        }
    </style>
</templates>
```

#### **ä»»åŠ¡2ï¼šæŠ¥è¡¨å¯¼å‡ºå’Œæ‰“å°åŠŸèƒ½**
```javascript
// file: wechat_platform/static/src/js/report_exporter.js

odoo.define('wechat_platform.ReportExporter', function (require) {
    "use strict";

    const { Component, useState, onMounted, onWillUnmount } = owl;
    const { useService } = require("@web/core/utils/hooks");
    
    class ReportExporter extends Component {
        static template = "wechat_platform.ReportExporter";
        static components = {};
        
        setup() {
            super.setup();
            this.orm = useService("orm");
            this.notification = useService("notification");
            this.action = useService("action");
            
            this.state = useState({
                formats: [
                    { id: 'excel', name: 'Excel', icon: 'fa-file-excel-o', color: 'success' },
                    { id: 'pdf', name: 'PDF', icon: 'fa-file-pdf-o', color: 'danger' },
                    { id: 'html', name: 'HTML', icon: 'fa-file-code-o', color: 'warning' },
                    { id: 'csv', name: 'CSV', icon: 'fa-file-text-o', color: 'info' },
                ],
                selectedFormat: 'excel',
                exporting: false,
                progress: 0,
                exportHistory: [],
                templates: [],
                selectedTemplate: null,
                customOptions: {},
            });
            
            onMounted(() => {
                this.loadTemplates();
                this.loadExportHistory();
            });
        }
        
        // åŠ è½½æŠ¥è¡¨æ¨¡æ¿
        async loadTemplates() {
            try {
                const templates = await this.orm.call(
                    'wechat.analysis.report',
                    'search_read',
                    [],
                    {
                        fields: ['id', 'name', 'report_type', 'start_date', 'end_date'],
                        order: 'create_date desc',
                        limit: 20,
                    }
                );
                
                this.state.templates = templates;
                
                if (templates.length > 0 && !this.state.selectedTemplate) {
                    this.state.selectedTemplate = templates[0].id;
                }
                
            } catch (error) {
                console.error('åŠ è½½æŠ¥è¡¨æ¨¡æ¿å¤±è´¥:', error);
                this.notification.add("åŠ è½½å¤±è´¥", { type: 'danger' });
            }
        }
        
        // åŠ è½½å¯¼å‡ºå†å²
        async loadExportHistory() {
            try {
                // è¿™é‡Œåº”è¯¥ä»æœåŠ¡å™¨è·å–å¯¼å‡ºå†å²
                // ç®€åŒ–å®ç°ï¼šæ¨¡æ‹Ÿæ•°æ®
                const mockHistory = [
                    {
                        id: 1,
                        name: 'ç²‰ä¸å¢é•¿åˆ†ææŠ¥å‘Š',
                        format: 'excel',
                        size: '2.5 MB',
                        export_time: new Date().toISOString(),
                        status: 'completed',
                    },
                    {
                        id: 2,
                        name: 'æ¶ˆæ¯åˆ†æå‘¨æŠ¥',
                        format: 'pdf',
                        size: '1.8 MB',
                        export_time: new Date(Date.now() - 86400000).toISOString(),
                        status: 'completed',
                    },
                    {
                        id: 3,
                        name: 'ç”¨æˆ·è¡Œä¸ºåˆ†æ',
                        format: 'html',
                        size: '4.2 MB',
                        export_time: new Date(Date.now() - 172800000).toISOString(),
                        status: 'failed',
                    },
                ];
                
                this.state.exportHistory = mockHistory;
                
            } catch (error) {
                console.error('åŠ è½½å¯¼å‡ºå†å²å¤±è´¥:', error);
            }
        }
        
        // å¯¼å‡ºæŠ¥è¡¨
        async exportReport() {
            if (this.state.exporting) {
                return;
            }
            
            const templateId = this.state.selectedTemplate;
            const format = this.state.selectedFormat;
            
            if (!templateId) {
                this.notification.add("è¯·é€‰æ‹©æŠ¥è¡¨æ¨¡æ¿", { type: 'warning' });
                return;
            }
            
            this.state.exporting = true;
            this.state.progress = 0;
            
            try {
                // æ¨¡æ‹Ÿå¯¼å‡ºè¿›åº¦
                const progressInterval = setInterval(() => {
                    this.state.progress += 10;
                    
                    if (this.state.progress >= 100) {
                        clearInterval(progressInterval);
                        
                        // å®é™…å¯¼å‡º
                        this._performExport(templateId, format);
                    }
                }, 200);
                
            } catch (error) {
                console.error('å¯¼å‡ºæŠ¥è¡¨å¤±è´¥:', error);
                this.notification.add("å¯¼å‡ºå¤±è´¥", { type: 'danger' });
                this.state.exporting = false;
                this.state.progress = 0;
            }
        }
        
        async _performExport(templateId, format) {
            try {
                // è°ƒç”¨åç«¯å¯¼å‡ºæ¥å£
                const result = await this.orm.call(
                    'wechat.analysis.report',
                    'action_export_statistics',
                    [[templateId], format],
                    {}
                );
                
                if (result && result.url) {
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const link = document.createElement('a');
                    link.href = result.url;
                    link.download = result.filename || `report_${new Date().getTime()}.${format}`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // æ·»åŠ åˆ°å†å²è®°å½•
                    this._addToExportHistory(
                        templateId,
                        format,
                        result.size || 'N/A'
                    );
                    
                    this.notification.add("å¯¼å‡ºæˆåŠŸ", { type: 'success' });
                }
                
            } catch (error) {
                console.error('æ‰§è¡Œå¯¼å‡ºå¤±è´¥:', error);
                this.notification.add("å¯¼å‡ºå¤±è´¥", { type: 'danger' });
            } finally {
                this.state.exporting = false;
                this.state.progress = 0;
            }
        }
        
        _addToExportHistory(templateId, format, size) {
            const template = this.state.templates.find(t => t.id === templateId);
            
            if (!template) {
                return;
            }
            
            const historyItem = {
                id: Date.now(),
                name: template.name,
                format: format,
                size: size,
                export_time: new Date().toISOString(),
                status: 'completed',
            };
            
            this.state.exportHistory.unshift(historyItem);
            
            // é™åˆ¶å†å²è®°å½•æ•°é‡
            if (this.state.exportHistory.length > 50) {
                this.state.exportHistory = this.state.exportHistory.slice(0, 50);
            }
        }
        
        // æ‰¹é‡å¯¼å‡º
        async batchExport(templateIds, format) {
            if (!templateIds || templateIds.length === 0) {
                this.notification.add("è¯·é€‰æ‹©è¦å¯¼å‡ºçš„æŠ¥è¡¨", { type: 'warning' });
                return;
            }
            
            this.state.exporting = true;
            this.state.progress = 0;
            
            try {
                // åˆ›å»ºZIPæ–‡ä»¶
                const zip = new JSZip();
                let completed = 0;
                const total = templateIds.length;
                
                for (const templateId of templateIds) {
                    try {
                        // è·å–æŠ¥è¡¨æ•°æ®
                        const reportData = await this.orm.call(
                            'wechat.analysis.report',
                            'generate_report',
                            [[templateId]],
                            {}
                        );
                        
                        // æ ¹æ®æ ¼å¼ç”Ÿæˆæ–‡ä»¶å†…å®¹
                        let fileContent, extension;
                        
                        switch (format) {
                            case 'excel':
                                fileContent = this._generateExcelContent(reportData);
                                extension = 'xlsx';
                                break;
                            case 'pdf':
                                fileContent = this._generatePdfContent(reportData);
                                extension = 'pdf';
                                break;
                            case 'csv':
                                fileContent = this._generateCsvContent(reportData);
                                extension = 'csv';
                                break;
                            case 'html':
                                fileContent = this._generateHtmlContent(reportData);
                                extension = 'html';
                                break;
                            default:
                                throw new Error(`ä¸æ”¯æŒçš„æ ¼å¼: ${format}`);
                        }
                        
                        // æ·»åŠ åˆ°ZIP
                        const template = this.state.templates.find(t => t.id === templateId);
                        const filename = template ? 
                            `${template.name}_${new Date().getTime()}.${extension}` :
                            `report_${templateId}_${new Date().getTime()}.${extension}`;
                        
                        zip.file(filename, fileContent);
                        
                    } catch (error) {
                        console.error(`å¤„ç†æŠ¥è¡¨ ${templateId} å¤±è´¥:`, error);
                    }
                    
                    completed++;
                    this.state.progress = Math.floor((completed / total) * 100);
                }
                
                // ç”ŸæˆZIPæ–‡ä»¶
                const zipContent = await zip.generateAsync({ type: 'blob' });
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = URL.createObjectURL(zipContent);
                const link = document.createElement('a');
                link.href = url;
                link.download = `wechat_reports_${new Date().getTime()}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // é‡Šæ”¾URL
                setTimeout(() => URL.revokeObjectURL(url), 1000);
                
                this.notification.add(`æ‰¹é‡å¯¼å‡ºå®Œæˆï¼ŒæˆåŠŸ ${completed}/${total} ä¸ªæŠ¥è¡¨`, { 
                    type: 'success' 
                });
                
            } catch (error) {
                console.error('æ‰¹é‡å¯¼å‡ºå¤±è´¥:', error);
                this.notification.add("æ‰¹é‡å¯¼å‡ºå¤±è´¥", { type: 'danger' });
            } finally {
                this.state.exporting = false;
                this.state.progress = 0;
            }
        }
        
        _generateExcelContent(reportData) {
            // ä½¿ç”¨SheetJSåº“ç”ŸæˆExcelæ–‡ä»¶
            // è¿™é‡Œç®€åŒ–å®ç°
            return JSON.stringify(reportData);
        }
        
        _generatePdfContent(reportData) {
            // ä½¿ç”¨jsPDFåº“ç”ŸæˆPDFæ–‡ä»¶
            // è¿™é‡Œç®€åŒ–å®ç°
            return JSON.stringify(reportData);
        }
        
        _generateCsvContent(reportData) {
            // ç”ŸæˆCSVå†…å®¹
            const rows = [];
            
            // æ·»åŠ æ ‡é¢˜è¡Œ
            if (reportData.title) {
                rows.push([reportData.title]);
                rows.push([]);
            }
            
            // æ·»åŠ æ‘˜è¦æ•°æ®
            if (reportData.summary) {
                rows.push(['æ‘˜è¦']);
                Object.entries(reportData.summary).forEach(([key, value]) => {
                    rows.push([key, value]);
                });
                rows.push([]);
            }
            
            // æ·»åŠ å›¾è¡¨æ•°æ®
            if (reportData.charts && reportData.charts.growth_trend) {
                const chartData = reportData.charts.growth_trend.data;
                rows.push(['å¢é•¿è¶‹åŠ¿æ•°æ®']);
                rows.push(['æ—¥æœŸ', 'æ–°å¢å…³æ³¨', 'å–æ¶ˆå…³æ³¨', 'å‡€å¢å…³æ³¨']);
                
                chartData.labels.forEach((label, index) => {
                    const row = [
                        label,
                        chartData.datasets[0].data[index] || 0,
                        chartData.datasets[1].data[index] || 0,
                        chartData.datasets[2].data[index] || 0,
                    ];
                    rows.push(row);
                });
            }
            
            // è½¬æ¢ä¸ºCSVå­—ç¬¦ä¸²
            return rows.map(row => 
                row.map(cell => 
                    typeof cell === 'string' && cell.includes(',') ? 
                    `"${cell}"` : cell
                ).join(',')
            ).join('\n');
        }
        
        _generateHtmlContent(reportData) {
            // ç”ŸæˆHTMLå†…å®¹
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>${reportData.title || 'å¾®ä¿¡åˆ†ææŠ¥å‘Š'}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        h1 { color: #333; }
                        .summary { background: #f8f9fa; padding: 20px; border-radius: 5px; margin: 20px 0; }
                        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .footer { margin-top: 40px; color: #666; font-size: 12px; }
                    </style>
                </head>
                <body>
                    <h1>${reportData.title || 'å¾®ä¿¡åˆ†ææŠ¥å‘Š'}</h1>
                    <p>ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}</p>
                    
                    ${reportData.summary ? `
                        <div class="summary">
                            <h2>æ‘˜è¦</h2>
                            <table>
                                ${Object.entries(reportData.summary).map(([key, value]) => `
                                    <tr>
                                        <td><strong>${key}</strong></td>
                                        <td>${value}</td>
                                    </tr>
                                `).join('')}
                            </table>
                        </div>
                    ` : ''}
                    
                    ${reportData.recommendations ? `
                        <h2>å»ºè®®ä¸æ”¹è¿›</h2>
                        <ul>
                            ${reportData.recommendations.map(rec => `
                                <li>
                                    <strong>${rec.title}</strong>: ${rec.description}
                                    ${rec.actions ? `<br><small>å»ºè®®è¡ŒåŠ¨: ${rec.actions.join(', ')}</small>` : ''}
                                </li>
                            `).join('')}
                        </ul>
                    ` : ''}
                    
                    <div class="footer">
                        <hr>
                        <p>æœ¬æŠ¥å‘Šç”±å¾®ä¿¡å…¬ä¼—å·ç®¡ç†å¹³å°ç”Ÿæˆ</p>
                        <p>Â© ${new Date().getFullYear()} å¾®ä¿¡è¿è¥å›¢é˜Ÿ</p>
                    </div>
                </body>
                </html>
            `;
        }
        
        // æ‰“å°æŠ¥è¡¨
        printReport(templateId) {
            if (!templateId) {
                this.notification.add("è¯·é€‰æ‹©è¦æ‰“å°çš„æŠ¥è¡¨", { type: 'warning' });
                return;
            }
            
            // åˆ›å»ºæ‰“å°çª—å£
            const printWindow = window.open('', '_blank');
            
            // åŠ è½½æŠ¥è¡¨æ•°æ®å¹¶ç”ŸæˆHTML
            this.orm.call(
                'wechat.analysis.report',
                'generate_report',
                [[templateId]],
                {}
            ).then(reportData => {
                const htmlContent = this._generateHtmlContent(reportData);
                
                printWindow.document.write(htmlContent);
                printWindow.document.close();
                
                // ç­‰å¾…å†…å®¹åŠ è½½å®Œæˆ
                printWindow.onload = () => {
                    printWindow.print();
                    printWindow.onafterprint = () => {
                        printWindow.close();
                    };
                };
                
            }).catch(error => {
                console.error('æ‰“å°æŠ¥è¡¨å¤±è´¥:', error);
                this.notification.add("æ‰“å°å¤±è´¥", { type: 'danger' });
                
                if (printWindow) {
                    printWindow.close();
                }
            });
        }
        
        // ä¸‹è½½å†å²è®°å½•
        downloadHistoryItem(historyItem) {
            // è¿™é‡Œåº”è¯¥ä»æœåŠ¡å™¨é‡æ–°ä¸‹è½½æ–‡ä»¶
            // ç®€åŒ–å®ç°ï¼šæç¤ºç”¨æˆ·
            this.notification.add(`å¼€å§‹ä¸‹è½½: ${historyItem.name}`, { 
                type: 'info' 
            });
            
            // æ¨¡æ‹Ÿä¸‹è½½
            setTimeout(() => {
                this.notification.add(`ä¸‹è½½å®Œæˆ: ${historyItem.name}`, { 
                    type: 'success' 
                });
            }, 1000);
        }
        
        // åˆ é™¤å†å²è®°å½•
        deleteHistoryItem(historyId) {
            const index = this.state.exportHistory.findIndex(item => item.id === historyId);
            
            if (index !== -1) {
                this.state.exportHistory.splice(index, 1);
                this.notification.add("å·²åˆ é™¤å†å²è®°å½•", { type: 'success' });
            }
        }
        
        // æŸ¥çœ‹æŠ¥è¡¨è¯¦æƒ…
        viewReportDetail(templateId) {
            if (!templateId) {
                return;
            }
            
            this.action.doAction({
                type: 'ir.actions.act_window',
                name: 'æŠ¥è¡¨è¯¦æƒ…',
                res_model: 'wechat.analysis.report',
                views: [[false, 'form']],
                res_id: templateId,
                target: 'current',
            });
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        formatTime(timestamp) {
            if (!timestamp) return 'N/A';
            
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
            });
        }
    }
    
    return ReportExporter;
});
```

### **å¾®ä¿¡å¼€å‘ä¸“å®¶å…·ä½“ä»»åŠ¡ï¼š**

#### **ä»»åŠ¡1ï¼šæ¶ˆæ¯æ¨¡æ¿å’Œç¾¤å‘åŠŸèƒ½**
```python
# file: wechat_platform/models/wechat_template.py

from odoo import models, fields, api, _
from odoo.exceptions import ValidationError, UserError
import logging
import json
from datetime import datetime, timedelta

_logger = logging.getLogger(__name__)

class WechatTemplate(models.Model):
    """å¾®ä¿¡æ¶ˆæ¯æ¨¡æ¿"""
    _name = 'wechat.template'
    _description = 'å¾®ä¿¡æ¶ˆæ¯æ¨¡æ¿'
    _order = 'sequence, id'
    
    # æ¨¡æ¿ä¿¡æ¯
    template_id = fields.Char(string='æ¨¡æ¿ID', required=True,
                             help='å¾®ä¿¡å…¬ä¼—å¹³å°æä¾›çš„æ¨¡æ¿ID')
    title = fields.Char(string='æ¨¡æ¿æ ‡é¢˜', required=True)
    primary_industry = fields.Char(string='ä¸»è¥è¡Œä¸š')
    deputy_industry = fields.Char(string='å‰¯è¥è¡Œä¸š')
    content = fields.Text(string='æ¨¡æ¿å†…å®¹', readonly=True,
                         help='ä»å¾®ä¿¡è·å–çš„åŸå§‹æ¨¡æ¿å†…å®¹')
    
    # æ¨¡æ¿å­—æ®µ
    template_fields = fields.Text(string='æ¨¡æ¿å­—æ®µ',
                                 help='JSONæ ¼å¼çš„æ¨¡æ¿å­—æ®µå®šä¹‰')
    
    # å…³è”ä¿¡æ¯
    account_id = fields.Many2one('wechat.account', string='æ‰€å±å…¬ä¼—å·', required=True)
    sequence = fields.Integer(string='æ’åº', default=10)
    is_active = fields.Boolean(string='å¯ç”¨', default=True)
    
    # ä½¿ç”¨ç»Ÿè®¡
    usage_count = fields.Integer(string='ä½¿ç”¨æ¬¡æ•°', default=0, readonly=True)
    last_used_time = fields.Datetime(string='æœ€åä½¿ç”¨æ—¶é—´', readonly=True)
    
    # ç¤ºä¾‹æ•°æ®
    example_data = fields.Text(string='ç¤ºä¾‹æ•°æ®',
                              help='JSONæ ¼å¼çš„ç¤ºä¾‹æ•°æ®ï¼Œç”¨äºé¢„è§ˆ')
    
    @api.model
    def sync_templates_from_wechat(self, account_id):
        """ä»å¾®ä¿¡åŒæ­¥æ¨¡æ¿"""
        try:
            account = self.env['wechat.account'].browse(account_id)
            client = account.get_api_client()
            
            # è·å–æ¨¡æ¿åˆ—è¡¨
            templates_data = client.get_all_private_template()
            
            if 'template_list' not in templates_data:
                raise UserError(_('ä»å¾®ä¿¡è·å–æ¨¡æ¿å¤±è´¥'))
            
            synced_count = 0
            for template_data in templates_data['template_list']:
                template_id = template_data.get('template_id')
                
                # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                existing = self.search([
                    ('template_id', '=', template_id),
                    ('account_id', '=', account_id),
                ], limit=1)
                
                if existing:
                    # æ›´æ–°ç°æœ‰æ¨¡æ¿
                    existing.write({
                        'title': template_data.get('title', ''),
                        'primary_industry': template_data.get('primary_industry', ''),
                        'deputy_industry': template_data.get('deputy_industry', ''),
                        'content': template_data.get('content', ''),
                    })
                else:
                    # åˆ›å»ºæ–°æ¨¡æ¿
                    self.create({
                        'template_id': template_id,
                        'title': template_data.get('title', ''),
                        'primary_industry': template_data.get('primary_industry', ''),
                        'deputy_industry': template_data.get('deputy_industry', ''),
                        'content': template_data.get('content', ''),
                        'account_id': account_id,
                        'is_active': True,
                    })
                
                synced_count += 1
            
            _logger.info(f"åŒæ­¥äº† {synced_count} ä¸ªæ¨¡æ¿")
            return synced_count
            
        except Exception as e:
            _logger.error(f"åŒæ­¥æ¨¡æ¿å¤±è´¥: {str(e)}")
            raise UserError(_('åŒæ­¥æ¨¡æ¿å¤±è´¥: %s') % str(e))
    
    def parse_template_fields(self):
        """è§£ææ¨¡æ¿å­—æ®µ"""
        self.ensure_one()
        
        if not self.content:
            return []
        
        # è§£ææ¨¡æ¿å†…å®¹ä¸­çš„å­—æ®µ
        # æ¨¡æ¿æ ¼å¼ç¤ºä¾‹ï¼š{{first.DATA}} {{keyword1.DATA}} {{keyword2.DATA}} {{remark.DATA}}
        import re
        
        pattern = r'\{\{(\w+?)\.DATA\}\}'
        fields = re.findall(pattern, self.content)
        
        # å»é‡å¹¶ä¿æŒé¡ºåº
        unique_fields = []
        for field in fields:
            if field not in unique_fields:
                unique_fields.append(field)
        
        # ä¿å­˜å­—æ®µå®šä¹‰
        field_definitions = []
        for field in unique_fields:
            field_definitions.append({
                'name': field,
                'label': self._get_field_label(field),
                'required': True,
                'type': 'text',
                'max_length': 20,
            })
        
        self.template_fields = json.dumps(field_definitions, ensure_ascii=False)
        return field_definitions
    
    def _get_field_label(self, field_name):
        """è·å–å­—æ®µæ ‡ç­¾"""
        label_map = {
            'first': 'é¦–è¡Œå†…å®¹',
            'keyword1': 'å…³é”®è¯1',
            'keyword2': 'å…³é”®è¯2',
            'keyword3': 'å…³é”®è¯3',
            'keyword4': 'å…³é”®è¯4',
            'keyword5': 'å…³é”®è¯5',
            'keyword6': 'å…³é”®è¯6',
            'keyword7': 'å…³é”®è¯7',
            'keyword8': 'å…³é”®è¯8',
            'keyword9': 'å…³é”®è¯9',
            'remark': 'å¤‡æ³¨',
            'thing1': 'äº‹ç‰©1',
            'thing2': 'äº‹ç‰©2',
            'thing3': 'äº‹ç‰©3',
            'thing4': 'äº‹ç‰©4',
            'thing5': 'äº‹ç‰©5',
            'thing6': 'äº‹ç‰©6',
            'thing7': 'äº‹ç‰©7',
            'thing8': 'äº‹ç‰©8',
            'thing9': 'äº‹ç‰©9',
            'number1': 'æ•°å­—1',
            'number2': 'æ•°å­—2',
            'number3': 'æ•°å­—3',
            'number4': 'æ•°å­—4',
            'number5': 'æ•°å­—5',
            'number6': 'æ•°å­—6',
            'number7': 'æ•°å­—7',
            'number8': 'æ•°å­—8',
            'number9': 'æ•°å­—9',
            'date1': 'æ—¥æœŸ1',
            'date2': 'æ—¥æœŸ2',
            'date3': 'æ—¥æœŸ3',
            'date4': 'æ—¥æœŸ4',
            'date5': 'æ—¥æœŸ5',
            'date6': 'æ—¥æœŸ6',
            'date7': 'æ—¥æœŸ7',
            'date8': 'æ—¥æœŸ8',
            'date9': 'æ—¥æœŸ9',
            'time1': 'æ—¶é—´1',
            'time2': 'æ—¶é—´2',
            'time3': 'æ—¶é—´3',
            'time4': 'æ—¶é—´4',
            'time5': 'æ—¶é—´5',
            'time6': 'æ—¶é—´6',
            'time7': 'æ—¶é—´7',
            'time8': 'æ—¶é—´8',
            'time9': 'æ—¶é—´9',
            'amount1': 'é‡‘é¢1',
            'amount2': 'é‡‘é¢2',
            'amount3': 'é‡‘é¢3',
            'amount4': 'é‡‘é¢4',
            'amount5': 'é‡‘é¢5',
            'amount6': 'é‡‘é¢6',
            'amount7': 'é‡‘é¢7',
            'amount8': 'é‡‘é¢8',
            'amount9': 'é‡‘é¢9',
            'phrase1': 'çŸ­è¯­1',
            'phrase2': 'çŸ­è¯­2',
            'phrase3': 'çŸ­è¯­3',
            'phrase4': 'çŸ­è¯­4',
            'phrase5': 'çŸ­è¯­5',
            'phrase6': 'çŸ­è¯­6',
            'phrase7': 'çŸ­è¯­7',
            'phrase8': 'çŸ­è¯­8',
            'phrase9': 'çŸ­è¯­9',
        }
        
        return label_map.get(field_name, field_name)
    
    def send_template_message(self, openid, data, url=None, miniprogram=None):
        """å‘é€æ¨¡æ¿æ¶ˆæ¯"""
        self.ensure_one()
        
        try:
            account = self.account_id
            client = account.get_api_client()
            
            # æ„å»ºæ¶ˆæ¯æ•°æ®
            message_data = {
                'touser': openid,
                'template_id': self.template_id,
                'data': data,
            }
            
            if url:
                message_data['url'] = url
            
            if miniprogram:
                message_data['miniprogram'] = miniprogram
            
            # å‘é€æ¨¡æ¿æ¶ˆæ¯
            result = client.send_template_message(message_data)
            
            # æ›´æ–°ä½¿ç”¨ç»Ÿè®¡
            self.write({
                'usage_count': self.usage_count + 1,
                'last_used_time': fields.Datetime.now(),
            })
            
            # è®°å½•å‘é€æ—¥å¿—
            self.env['wechat.template.send.log'].create({
                'template_id': self.id,
                'account_id': account.id,
                'openid': openid,
                'send_time': fields.Datetime.now(),
                'data': json.dumps(data, ensure_ascii=False),
                'url': url,
                'message_id': result.get('msgid'),
                'status': 'success',
            })
            
            return result
            
        except Exception as e:
            _logger.error(f"å‘é€æ¨¡æ¿æ¶ˆæ¯å¤±è´¥: {str(e)}")
            
            # è®°å½•å¤±è´¥æ—¥å¿—
            self.env['wechat.template.send.log'].create({
                'template_id': self.id,
                'account_id': self.account_id.id,
                'openid': openid,
                'send_time': fields.Datetime.now(),
                'data': json.dumps(data, ensure_ascii=False),
                'url': url,
                'status': 'failed',
                'error_message': str(e),
            })
            
            raise UserError(_('å‘é€æ¨¡æ¿æ¶ˆæ¯å¤±è´¥: %s') % str(e))
    
    def action_preview_template(self):
        """é¢„è§ˆæ¨¡æ¿"""
        self.ensure_one()
        
        # è§£æå­—æ®µ
        fields = self.parse_template_fields()
        
        return {
            'type': 'ir.actions.act_window',
            'name': f'é¢„è§ˆæ¨¡æ¿: {self.title}',
            'res_model': 'wechat.template.preview',
            'view_mode': 'form',
            'target': 'new',
            'context': {
                'default_template_id': self.id,
                'default_fields': json.dumps(fields, ensure_ascii=False),
            },
        }


class WechatMassSend(models.Model):
    """å¾®ä¿¡ç¾¤å‘æ¶ˆæ¯"""
    _name = 'wechat.mass.send'
    _description = 'å¾®ä¿¡ç¾¤å‘æ¶ˆæ¯'
    _order = 'send_time desc'
    
    name = fields.Char(string='ç¾¤å‘åç§°', required=True)
    account_id = fields.Many2one('wechat.account', string='æ‰€å±å…¬ä¼—å·', required=True)
    
    # å‘é€ç±»å‹
    send_type = fields.Selection([
        ('text', 'æ–‡æœ¬æ¶ˆæ¯'),
        ('image', 'å›¾ç‰‡æ¶ˆæ¯'),
        ('voice', 'è¯­éŸ³æ¶ˆæ¯'),
        ('video', 'è§†é¢‘æ¶ˆæ¯'),
        ('news', 'å›¾æ–‡æ¶ˆæ¯'),
        ('template', 'æ¨¡æ¿æ¶ˆæ¯'),
    ], string='å‘é€ç±»å‹', required=True, default='text')
    
    # å‘é€å¯¹è±¡
    target_type = fields.Selection([
        ('all', 'å…¨éƒ¨ç²‰ä¸'),
        ('tag', 'æŒ‰æ ‡ç­¾'),
        ('openid', 'æŒ‡å®šç”¨æˆ·'),
        ('filter', 'æ¡ä»¶ç­›é€‰'),
    ], string='å‘é€å¯¹è±¡', required=True, default='all')
    
    tag_id = fields.Many2one('wechat.user.tag', string='æ ‡ç­¾',
                            help='æŒ‰æ ‡ç­¾é€‰æ‹©å‘é€å¯¹è±¡æ—¶ä½¿ç”¨')
    filter_conditions = fields.Text(string='ç­›é€‰æ¡ä»¶',
                                   help='JSONæ ¼å¼çš„ç­›é€‰æ¡ä»¶')
    
    # æ¶ˆæ¯å†…å®¹
    content = fields.Text(string='æ–‡æœ¬å†…å®¹',
                         help='æ–‡æœ¬æ¶ˆæ¯å†…å®¹')
    media_id = fields.Char(string='åª’ä½“ID',
                          help='å›¾ç‰‡ã€è¯­éŸ³ã€è§†é¢‘æ¶ˆæ¯ä½¿ç”¨')
    material_id = fields.Many2one('wechat.material', string='å…³è”ç´ æ',
                                 help='å›¾æ–‡æ¶ˆæ¯æˆ–åª’ä½“æ¶ˆæ¯ä½¿ç”¨')
    template_id = fields.Many2one('wechat.template', string='æ¨¡æ¿',
                                 help='æ¨¡æ¿æ¶ˆæ¯ä½¿ç”¨')
    template_data = fields.Text(string='æ¨¡æ¿æ•°æ®',
                               help='JSONæ ¼å¼çš„æ¨¡æ¿æ•°æ®')
    
    # å‘é€è®¾ç½®
    send_time = fields.Datetime(string='å‘é€æ—¶é—´', default=fields.Datetime.now)
    is_send_now = fields.Boolean(string='ç«‹å³å‘é€', default=True)
    send_speed = fields.Selection([
        ('normal', 'æ­£å¸¸é€Ÿåº¦'),
        ('slow', 'æ…¢é€Ÿå‘é€'),
        ('fast', 'å¿«é€Ÿå‘é€'),
    ], string='å‘é€é€Ÿåº¦', default='normal')
    
    # å‘é€çŠ¶æ€
    status = fields.Selection([
        ('draft', 'è‰ç¨¿'),
        ('scheduled', 'å·²è®¡åˆ’'),
        ('sending', 'å‘é€ä¸­'),
        ('sent', 'å·²å‘é€'),
        ('failed', 'å‘é€å¤±è´¥'),
        ('cancelled', 'å·²å–æ¶ˆ'),
    ], string='çŠ¶æ€', default='draft', readonly=True)
    
    # å‘é€ç»“æœ
    total_users = fields.Integer(string='ç›®æ ‡ç”¨æˆ·æ•°', readonly=True)
    sent_count = fields.Integer(string='å·²å‘é€æ•°', readonly=True)
    success_count = fields.Integer(string='æˆåŠŸæ•°', readonly=True)
    fail_count = fields.Integer(string='å¤±è´¥æ•°', readonly=True)
    send_progress = fields.Float(string='å‘é€è¿›åº¦', compute='_compute_send_progress', store=True)
    
    # å¾®ä¿¡è¿”å›ä¿¡æ¯
    msg_id = fields.Char(string='æ¶ˆæ¯ID', readonly=True,
                        help='å¾®ä¿¡æœåŠ¡å™¨è¿”å›çš„æ¶ˆæ¯ID')
    msg_data_id = fields.Char(string='æ¶ˆæ¯æ•°æ®ID', readonly=True,
                             help='å›¾æ–‡æ¶ˆæ¯çš„æ•°æ®ID')
    
    # ç»Ÿè®¡ä¿¡æ¯
    open_count = fields.Integer(string='æ‰“å¼€æ¬¡æ•°', readonly=True)
    open_users = fields.Integer(string='æ‰“å¼€äººæ•°', readonly=True)
    
    @api.depends('sent_count', 'total_users')
    def _compute_send_progress(self):
        """è®¡ç®—å‘é€è¿›åº¦"""
        for send in self:
            if send.total_users > 0:
                send.send_progress = (send.sent_count / send.total_users) * 100
            else:
                send.send_progress = 0
    
    @api.constrains('send_time')
    def _check_send_time(self):
        """æ£€æŸ¥å‘é€æ—¶é—´"""
        for send in self:
            if send.send_time and send.send_time < fields.Datetime.now():
                raise ValidationError(_('å‘é€æ—¶é—´ä¸èƒ½æ—©äºå½“å‰æ—¶é—´'))
    
    def action_preview(self):
        """é¢„è§ˆç¾¤å‘æ¶ˆæ¯"""
        self.ensure_one()
        
        preview_data = {
            'send_type': self.send_type,
            'target_type': self.target_type,
            'content': self.content,
            'media_id': self.media_id,
            'material_id': self.material_id.id if self.material_id else None,
        }
        
        if self.target_type == 'tag' and self.tag_id:
            preview_data['tag_name'] = self.tag_id.name
        
        return {
            'type': 'ir.actions.act_window',
            'name': f'é¢„è§ˆç¾¤å‘: {self.name}',
            'res_model': 'wechat.mass.send.preview',
            'view_mode': 'form',
            'target': 'new',
            'context': {
                'default_mass_send_id': self.id,
                'default_preview_data': json.dumps(preview_data, ensure_ascii=False),
            },
        }
    
    def action_send(self):
        """å‘é€ç¾¤å‘æ¶ˆæ¯"""
        self.ensure_one()
        
        if self.status not in ['draft', 'scheduled']:
            raise UserError(_('åªæœ‰è‰ç¨¿æˆ–è®¡åˆ’ä¸­çš„æ¶ˆæ¯å¯ä»¥å‘é€'))
        
        # è®¡ç®—ç›®æ ‡ç”¨æˆ·
        target_users = self._get_target_users()
        
        if not target_users:
            raise UserError(_('æ²¡æœ‰æ‰¾åˆ°ç›®æ ‡ç”¨æˆ·'))
        
        # æ›´æ–°çŠ¶æ€
        self.write({
            'status': 'sending' if self.is_send_now else 'scheduled',
            'total_users': len(target_users),
            'sent_count': 0,
            'success_count': 0,
            'fail_count': 0,
        })
        
        if self.is_send_now:
            # ç«‹å³å‘é€
            self._send_mass_message(target_users)
        else:
            # è®¡åˆ’å‘é€
            self._schedule_mass_send(target_users)
        
        return True
    
    def _get_target_users(self):
        """è·å–ç›®æ ‡ç”¨æˆ·"""
        domain = [
            ('account_id', '=', self.account_id.id),
            ('subscribe', '=', True),
        ]
        
        if self.target_type == 'tag' and self.tag_id:
            # æŒ‰æ ‡ç­¾ç­›é€‰
            domain.append(('tagid_list', 'ilike', str(self.tag_id.tag_id)))
        
        elif self.target_type == 'filter' and self.filter_conditions:
            # æŒ‰æ¡ä»¶ç­›é€‰
            try:
                filters = json.loads(self.filter_conditions)
                domain.extend(self._parse_filters(filters))
            except Exception as e:
                _logger.error(f"è§£æç­›é€‰æ¡ä»¶å¤±è´¥: {str(e)}")
                raise UserError(_('ç­›é€‰æ¡ä»¶æ ¼å¼é”™è¯¯'))
        
        elif self.target_type == 'openid':
            # æŒ‡å®šç”¨æˆ·ï¼ˆè¿™é‡Œéœ€è¦ç‰¹æ®Šå¤„ç†ï¼‰
            # ç®€åŒ–å®ç°ï¼šè¿”å›ç©ºåˆ—è¡¨
            return []
        
        # æŸ¥è¯¢ç”¨æˆ·
        users = self.env['wechat.user'].search(domain)
        return users
    
    def _parse_filters(self, filters):
        """è§£æç­›é€‰æ¡ä»¶"""
        domain = []
        
        for filter_item in filters:
            field = filter_item.get('field')
            operator = filter_item.get('operator')
            value = filter_item.get('value')
            
            if not all([field, operator, value]):
                continue
            
            # æ„å»ºåŸŸå
            if operator == '=':
                domain.append((field, '=', value))
            elif operator == '!=':
                domain.append((field, '!=', value))
            elif operator == '>':
                domain.append((field, '>', value))
            elif operator == '>=':
                domain.append((field, '>=', value))
            elif operator == '<':
                domain.append((field, '<', value))
            elif operator == '<=':
                domain.append((field, '<=', value))
            elif operator == 'like':
                domain.append((field, 'like', value))
            elif operator == 'ilike':
                domain.append((field, 'ilike', value))
            elif operator == 'in':
                domain.append((field, 'in', value))
            elif operator == 'not in':
                domain.append((field, 'not in', value))
        
        return domain
    
    def _send_mass_message(self, users):
        """å‘é€ç¾¤å‘æ¶ˆæ¯"""
        try:
            account = self.account_id
            client = account.get_api_client()
            
            # å‡†å¤‡æ¶ˆæ¯æ•°æ®
            message_data = self._prepare_message_data()
            
            if self.target_type == 'all':
                # å…¨éƒ¨ç”¨æˆ·
                if self.send_type == 'text':
                    result = client.send_mass_message_to_all('text', message_data)
                elif self.send_type == 'image':
                    result = client.send_mass_message_to_all('image', message_data)
                elif self.send_type == 'voice':
                    result = client.send_mass_message_to_all('voice', message_data)
                elif self.send_type == 'video':
                    result = client.send_mass_message_to_all('video', message_data)
                elif self.send_type == 'news':
                    result = client.send_mass_message_to_all('mpnews', message_data)
                elif self.send_type == 'template':
                    # æ¨¡æ¿æ¶ˆæ¯ä¸æ”¯æŒå…¨éƒ¨å‘é€ï¼Œéœ€è¦åˆ†æ‰¹å‘é€
                    self._send_template_to_users(users)
                    return
            
            elif self.target_type == 'tag' and self.tag_id:
                # æŒ‰æ ‡ç­¾å‘é€
                tag_id = self.tag_id.tag_id
                
                if self.send_type == 'text':
                    result = client.send_mass_message_by_tag('text', message_data, tag_id)
                elif self.send_type == 'image':
                    result = client.send_mass_message_by_tag('image', message_data, tag_id)
                elif self.send_type == 'voice':
                    result = client.send_mass_message_by_tag('voice', message_data, tag_id)
                elif self.send_type == 'video':
                    result = client.send_mass_message_by_tag('video', message_data, tag_id)
                elif self.send_type == 'news':
                    result = client.send_mass_message_by_tag('mpnews', message_data, tag_id)
                elif self.send_type == 'template':
                    # æ¨¡æ¿æ¶ˆæ¯éœ€è¦é€ä¸ªå‘é€
                    self._send_template_to_users(users)
                    return
            
            # æ›´æ–°å‘é€ç»“æœ
            if result:
                self.write({
                    'status': 'sent',
                    'msg_id': result.get('msg_id'),
                    'msg_data_id': result.get('msg_data_id'),
                    'sent_count': len(users),
                    'success_count': len(users),  # ç®€åŒ–å¤„ç†
                    'send_time': fields.Datetime.now(),
                })
            
            _logger.info(f"ç¾¤å‘æ¶ˆæ¯æˆåŠŸ: {self.name}")
            
        except Exception as e:
            _logger.error(f"ç¾¤å‘æ¶ˆæ¯å¤±è´¥: {str(e)}")
            
            self.write({
                'status': 'failed',
                'fail_count': len(users),
            })
            
            raise UserError(_('ç¾¤å‘æ¶ˆæ¯å¤±è´¥: %s') % str(e))
    
    def _send_template_to_users(self, users):
        """å‘é€æ¨¡æ¿æ¶ˆæ¯ç»™ç”¨æˆ·"""
        if not self.template_id:
            raise UserError(_('è¯·é€‰æ‹©æ¨¡æ¿'))
        
        try:
            template_data = json.loads(self.template_data) if self.template_data else {}
            
            success_count = 0
            fail_count = 0
            
            for user in users:
                try:
                    self.template_id.send_template_message(
                        user.openid,
                        template_data,
                        url=self._get_template_url()
                    )
                    success_count += 1
                except Exception as e:
                    fail_count += 1
                    _logger.error(f"å‘é€æ¨¡æ¿æ¶ˆæ¯ç»™ç”¨æˆ·å¤±è´¥ {user.openid}: {str(e)}")
                
                # æ›´æ–°è¿›åº¦
                sent_count = success_count + fail_count
                self.write({
                    'sent_count': sent_count,
                    'success_count': success_count,
                    'fail_count': fail_count,
                })
            
            # æ›´æ–°æœ€ç»ˆçŠ¶æ€
            self.write({
                'status': 'sent' if success_count > 0 else 'failed',
                'send_time': fields.Datetime.now(),
            })
            
        except Exception as e:
            _logger.error(f"æ‰¹é‡å‘é€æ¨¡æ¿æ¶ˆæ¯å¤±è´¥: {str(e)}")
            raise
    
    def _prepare_message_data(self):
        """å‡†å¤‡æ¶ˆæ¯æ•°æ®"""
        if self.send_type == 'text':
            return {
                'content': self.content,
            }
        elif self.send_type == 'image':
            return {
                'media_id': self.media_id or self.material_id.media_id,
            }
        elif self.send_type == 'voice':
            return {
                'media_id': self.media_id or self.material_id.media_id,
            }
        elif self.send_type == 'video':
            return {
                'media_id': self.media_id or self.material_id.media_id,
                'title': self.material_id.title if self.material_id else '',
                'description': self.material_id.introduction if self.material_id else '',
            }
        elif self.send_type == 'news':
            if self.material_id and self.material_id.material_type == 'news':
                return {
                    'media_id': self.material_id.media_id,
                }
            else:
                raise UserError(_('è¯·é€‰æ‹©å›¾æ–‡ç´ æ'))
        else:
            return {}
    
    def _get_template_url(self):
        """è·å–æ¨¡æ¿æ¶ˆæ¯URL"""
        # è¿™é‡Œå¯ä»¥æ ¹æ®éœ€è¦ç”ŸæˆURL
        return None
    
    def action_cancel(self):
        """å–æ¶ˆç¾¤å‘"""
        self.ensure_one()
        
        if self.status not in ['draft', 'scheduled']:
            raise UserError(_('åªæœ‰è‰ç¨¿æˆ–è®¡åˆ’ä¸­çš„æ¶ˆæ¯å¯ä»¥å–æ¶ˆ'))
        
        self.write({
            'status': 'cancelled',
        })
        
        return True
    
    def action_view_details(self):
        """æŸ¥çœ‹è¯¦æƒ…"""
        self.ensure_one()
        
        return {
            'type': 'ir.actions.act_window',
            'name': f'ç¾¤å‘è¯¦æƒ…: {self.name}',
            'res_model': 'wechat.mass.send.detail',
            'view_mode': 'form',
            'target': 'new',
            'context': {
                'default_mass_send_id': self.id,
            },
        }
    
    @api.model
    def cron_process_scheduled_sends(self):
        """å¤„ç†è®¡åˆ’å‘é€çš„ä»»åŠ¡"""
        scheduled_sends = self.search([
            ('status', '=', 'scheduled'),
            ('send_time', '<=', fields.Datetime.now()),
        ])
        
        for send in scheduled_sends:
            try:
                target_users = send._get_target_users()
                send._send_mass_message(target_users)
            except Exception as e:
                _logger.error(f"å¤„ç†è®¡åˆ’å‘é€å¤±è´¥ {send.name}: {str(e)}")
                send.write({'status': 'failed'})
        
        return len(scheduled_sends)
```

### **å®‰å…¨å®¡æŸ¥ä¸“å®¶å…·ä½“ä»»åŠ¡ï¼š**

#### **ä»»åŠ¡1ï¼šæ€§èƒ½ç›‘æ§ä¸ä¼˜åŒ–**
```python
# file: wechat_platform/performance/monitor.py

import logging
import time
import psutil
import gc
from datetime import datetime, timedelta
from typing import Dict, List, Optional, Any
from collections import defaultdict, deque
import threading
import json

_logger = logging.getLogger(__name__)

class PerformanceMonitor:
    """æ€§èƒ½ç›‘æ§å™¨"""
    
    def __init__(self, sampling_interval=60):
        self.sampling_interval = sampling_interval  # é‡‡æ ·é—´éš”ï¼ˆç§’ï¼‰
        self.metrics_history = defaultdict(lambda: deque(maxlen=1000))
        self.is_monitoring = False
        self.monitor_thread = None
        self.lock = threading.Lock()
        
        # æŒ‡æ ‡å®šä¹‰
        self.metric_definitions = {
            'cpu_percent': {
                'name': 'CPUä½¿ç”¨ç‡',
                'unit': '%',
                'type': 'gauge',
                'warning_threshold': 80,
                'critical_threshold': 95,
            },
            'memory_percent': {
                'name': 'å†…å­˜ä½¿ç”¨ç‡',
                'unit': '%',
                'type': 'gauge',
                'warning_threshold': 85,
                'critical_threshold': 95,
            },
            'memory_used': {
                'name': 'å†…å­˜ä½¿ç”¨é‡',
                'unit': 'MB',
                'type': 'gauge',
                'warning_threshold': None,
                'critical_threshold': None,
            },
            'disk_usage': {
                'name': 'ç£ç›˜ä½¿ç”¨ç‡',
                'unit': '%',
                'type': 'gauge',
                'warning_threshold': 80,
                'critical_threshold': 90,
            },
            'api_response_time': {
                'name': 'APIå“åº”æ—¶é—´',
                'unit': 'ms',
                'type': 'histogram',
                'warning_threshold': 1000,
                'critical_threshold': 5000,
            },
            'api_success_rate': {
                'name': 'APIæˆåŠŸç‡',
                'unit': '%',
                'type': 'gauge',
                'warning_threshold': 95,
                'critical_threshold': 90,
            },
            'message_queue_size': {
                'name': 'æ¶ˆæ¯é˜Ÿåˆ—å¤§å°',
                'unit': 'ä¸ª',
                'type': 'gauge',
                'warning_threshold': 1000,
                'critical_threshold': 5000,
            },
            'active_connections': {
                'name': 'æ´»è·ƒè¿æ¥æ•°',
                'unit': 'ä¸ª',
                'type': 'gauge',
                'warning_threshold': 100,
                'critical_threshold': 200,
            },
            'gc_collections': {
                'name': 'GCå›æ”¶æ¬¡æ•°',
                'unit': 'æ¬¡',
                'type': 'counter',
                'warning_threshold': None,
                'critical_threshold': None,
            },
            'gc_memory_freed': {
                'name': 'GCé‡Šæ”¾å†…å­˜',
                'unit': 'MB',
                'type': 'counter',
                'warning_threshold': None,
                'critical_threshold': None,
            },
        }
    
    def start_monitoring(self):
        """å¼€å§‹ç›‘æ§"""
        if self.is_monitoring:
            _logger.warning("æ€§èƒ½ç›‘æ§å·²ç»åœ¨è¿è¡Œ")
            return
        
        self.is_monitoring = True
        self.monitor_thread = threading.Thread(
            target=self._monitoring_loop,
            daemon=True,
            name="PerformanceMonitor"
        )
        self.monitor_thread.start()
        
        _logger.info("æ€§èƒ½ç›‘æ§å·²å¯åŠ¨")
    
    def stop_monitoring(self):
        """åœæ­¢ç›‘æ§"""
        self.is_monitoring = False
        
        if self.monitor_thread:
            self.monitor_thread.join(timeout=5)
            self.monitor_thread = None
        
        _logger.info("æ€§èƒ½ç›‘æ§å·²åœæ­¢")
    
    def _monitoring_loop(self):
        """ç›‘æ§å¾ªç¯"""
        while self.is_monitoring:
            try:
                self._collect_metrics()
            except Exception as e:
                _logger.error(f"æ”¶é›†æ€§èƒ½æŒ‡æ ‡å¤±è´¥: {str(e)}")
            
            time.sleep(self.sampling_interval)
    
    def _collect_metrics(self):
        """æ”¶é›†æ€§èƒ½æŒ‡æ ‡"""
        timestamp = datetime.now()
        
        # æ”¶é›†ç³»ç»ŸæŒ‡æ ‡
        cpu_percent = psutil.cpu_percent(interval=1)
        memory = psutil.virtual_memory()
        disk = psutil.disk_usage('/')
        
        # æ”¶é›†è¿›ç¨‹æŒ‡æ ‡
        process = psutil.Process()
        process_memory = process.memory_info()
        
        # æ”¶é›†GCæŒ‡æ ‡
        gc_collections = gc.get_count()
        gc_memory_freed = gc.get_stats()
        
        metrics = {
            'timestamp': timestamp.isoformat(),
            'cpu_percent': cpu_percent,
            'memory_percent': memory.percent,
            'memory_used': memory.used / 1024 / 1024,  # è½¬æ¢ä¸ºMB
            'disk_usage': disk.percent,
            'process_memory_rss': process_memory.rss / 1024 / 1024,  # è½¬æ¢ä¸ºMB
            'process_memory_vms': process_memory.vms / 1024 / 1024,  # è½¬æ¢ä¸ºMB
            'gc_gen0_collections': gc_collections[0],
            'gc_gen1_collections': gc_collections[1],
            'gc_gen2_collections': gc_collections[2],
        }
        
        # å­˜å‚¨æŒ‡æ ‡
        with self.lock:
            for key, value in metrics.items():
                if key != 'timestamp':
                    self.metrics_history[key].append({
                        'timestamp': timestamp,
                        'value': value,
                    })
        
        # æ£€æŸ¥å‘Šè­¦
        self._check_alerts(metrics)
        
        return metrics
    
    def _check_alerts(self, metrics):
        """æ£€æŸ¥å‘Šè­¦"""
        alerts = []
        
        # CPUå‘Šè­¦
        if metrics['cpu_percent'] > self.metric_definitions['cpu_percent']['critical_threshold']:
            alerts.append({
                'metric': 'cpu_percent',
                'value': metrics['cpu_percent'],
                'threshold': self.metric_definitions['cpu_percent']['critical_threshold'],
                'level': 'critical',
                'message': f'CPUä½¿ç”¨ç‡è¿‡é«˜: {metrics["cpu_percent"]}%',
            })
        elif metrics['cpu_percent'] > self.metric_definitions['cpu_percent']['warning_threshold']:
            alerts.append({
                'metric': 'cpu_percent',
                'value': metrics['cpu_percent'],
                'threshold': self.metric_definitions['cpu_percent']['warning_threshold'],
                'level': 'warning',
                'message': f'CPUä½¿ç”¨ç‡åé«˜: {metrics["cpu_percent"]}%',
            })
        
        # å†…å­˜å‘Šè­¦
        if metrics['memory_percent'] > self.metric_definitions['memory_percent']['critical_threshold']:
            alerts.append({
                'metric': 'memory_percent',
                'value': metrics['memory_percent'],
                'threshold': self.metric_definitions['memory_percent']['critical_threshold'],
                'level': 'critical',
                'message': f'å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: {metrics["memory_percent"]}%',
            })
        elif metrics['memory_percent'] > self.metric_definitions['memory_percent']['warning_threshold']:
            alerts.append({
                'metric': 'memory_percent',
                'value': metrics['memory_percent'],
                'threshold': self.metric_definitions['memory_percent']['warning_threshold'],
                'level': 'warning',
                'message': f'å†…å­˜ä½¿ç”¨ç‡åé«˜: {metrics["memory_percent"]}%',
            })
        
        # ç£ç›˜å‘Šè­¦
        if metrics['disk_usage'] > self.metric_definitions['disk_usage']['critical_threshold']:
            alerts.append({
                'metric': 'disk_usage',
                'value': metrics['disk_usage'],
                'threshold': self.metric_definitions['disk_usage']['critical_threshold'],
                'level': 'critical',
                'message': f'ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜: {metrics["disk_usage"]}%',
            })
        elif metrics['disk_usage'] > self.metric_definitions['disk_usage']['warning_threshold']:
            alerts.append({
                'metric': 'disk_usage',
                'value': metrics['disk_usage'],
                'threshold': self.metric_definitions['disk_usage']['warning_threshold'],
                'level': 'warning',
                'message': f'ç£ç›˜ä½¿ç”¨ç‡åé«˜: {metrics["disk_usage"]}%',
            })
        
        # å‘é€å‘Šè­¦
        if alerts:
            self._send_alerts(alerts)
    
    def _send_alerts(self, alerts):
        """å‘é€å‘Šè­¦"""
        for alert in alerts:
            _logger.warning(f"æ€§èƒ½å‘Šè­¦: {alert['message']}")
            
            # è¿™é‡Œå¯ä»¥é›†æˆé‚®ä»¶ã€çŸ­ä¿¡ã€Slackç­‰å‘Šè­¦æ–¹å¼
            # ç®€åŒ–å®ç°ï¼šåªè®°å½•æ—¥å¿—
    
    def record_api_call(self, endpoint, duration, success=True):
        """è®°å½•APIè°ƒç”¨"""
        timestamp = datetime.now()
        
        with self.lock:
            # è®°å½•å“åº”æ—¶é—´
            self.metrics_history[f'api_response_time_{endpoint}'].append({
                'timestamp': timestamp,
                'value': duration * 1000,  # è½¬æ¢ä¸ºæ¯«ç§’
            })
            
            # è®°å½•æˆåŠŸç‡
            self.metrics_history[f'api_success_{endpoint}'].append({
                'timestamp': timestamp,
                'value': 1 if success else 0,
            })
    
    def get_metrics(self, metric_name, start_time=None, end_time=None):
        """è·å–æŒ‡æ ‡æ•°æ®"""
        with self.lock:
            if metric_name not in self.metrics_history:
                return []
            
            metrics = list(self.metrics_history[metric_name])
        
        # è¿‡æ»¤æ—¶é—´èŒƒå›´
        if start_time:
            metrics = [m for m in metrics if m['timestamp'] >= start_time]
        
        if end_time:
            metrics = [m for m in metrics if m['timestamp'] <= end_time]
        
        return metrics
    
    def get_summary(self, period='1h'):
        """è·å–æ€§èƒ½æ‘˜è¦"""
        end_time = datetime.now()
        
        if period == '1h':
            start_time = end_time - timedelta(hours=1)
        elif period == '24h':
            start_time = end_time - timedelta(days=1)
        elif period == '7d':
            start_time = end_time - timedelta(days=7)
        else:
            start_time = end_time - timedelta(hours=1)
        
        summary = {
            'period': period,
            'start_time': start_time.isoformat(),
            'end_time': end_time.isoformat(),
            'metrics': {},
            'alerts': [],
            'recommendations': [],
        }
        
        # è®¡ç®—å„é¡¹æŒ‡æ ‡çš„å¹³å‡å€¼ã€æœ€å¤§å€¼ã€æœ€å°å€¼
        for metric_name in self.metric_definitions.keys():
            metrics = self.get_metrics(metric_name, start_time, end_time)
            
            if not metrics:
                continue
            
            values = [m['value'] for m in metrics]
            
            summary['metrics'][metric_name] = {
                'avg': sum(values) / len(values),
                'max': max(values),
                'min': min(values),
                'count': len(values),
                'latest': values[-1] if values else None,
            }
        
        # ç”Ÿæˆå»ºè®®
        self._generate_recommendations(summary)
        
        return summary
    
    def _generate_recommendations(self, summary):
        """ç”Ÿæˆä¼˜åŒ–å»ºè®®"""
        recommendations = []
        
        cpu_avg = summary['metrics'].get('cpu_percent', {}).get('avg', 0)
        memory_avg = summary['metrics'].get('memory_percent', {}).get('avg', 0)
        disk_avg = summary['metrics'].get('disk_usage', {}).get('avg', 0)
        
        if cpu_avg > 80:
            recommendations.append({
                'title': 'CPUä½¿ç”¨ç‡ä¼˜åŒ–',
                'description': f'å¹³å‡CPUä½¿ç”¨ç‡è¾ƒé«˜ ({cpu_avg:.1f}%)',
                'priority': 'high',
                'actions': [
                    'æ£€æŸ¥æ˜¯å¦æœ‰CPUå¯†é›†å‹ä»»åŠ¡',
                    'ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢',
                    'è€ƒè™‘å¢åŠ æœåŠ¡å™¨é…ç½®',
                ],
            })
        
        if memory_avg > 85:
            recommendations.append({
                'title': 'å†…å­˜ä½¿ç”¨ä¼˜åŒ–',
                'description': f'å¹³å‡å†…å­˜ä½¿ç”¨ç‡è¾ƒé«˜ ({memory_avg:.1f}%)',
                'priority': 'high',
                'actions': [
                    'æ£€æŸ¥å†…å­˜æ³„æ¼',
                    'ä¼˜åŒ–ç¼“å­˜ç­–ç•¥',
                    'å¢åŠ ç‰©ç†å†…å­˜',
                ],
            })
        
        if disk_avg > 80:
            recommendations.append({
                'title': 'ç£ç›˜ç©ºé—´æ¸…ç†',
                'description': f'ç£ç›˜ä½¿ç”¨ç‡è¾ƒé«˜ ({disk_avg:.1f}%)',
                'priority': 'medium',
                'actions': [
                    'æ¸…ç†æ—¥å¿—æ–‡ä»¶',
                    'å½’æ¡£å†å²æ•°æ®',
                    'å¢åŠ ç£ç›˜ç©ºé—´',
                ],
            })
        
        # æ£€æŸ¥APIæ€§èƒ½
        api_response_time = summary['metrics'].get('api_response_time', {}).get('avg', 0)
        if api_response_time > 1000:  # å¤§äº1ç§’
            recommendations.append({
                'title': 'APIæ€§èƒ½ä¼˜åŒ–',
                'description': f'APIå¹³å‡å“åº”æ—¶é—´è¾ƒé•¿ ({api_response_time:.1f}ms)',
                'priority': 'medium',
                'actions': [
                    'ä¼˜åŒ–æ•°æ®åº“ç´¢å¼•',
                    'æ·»åŠ ç¼“å­˜å±‚',
                    'å¼‚æ­¥å¤„ç†è€—æ—¶æ“ä½œ',
                ],
            })
        
        summary['recommendations'] = recommendations


class DatabasePerformanceAnalyzer:
    """æ•°æ®åº“æ€§èƒ½åˆ†æå™¨"""
    
    def __init__(self, env):
        self.env = env
    
    def analyze_slow_queries(self, threshold_ms=1000, limit=50):
        """åˆ†ææ…¢æŸ¥è¯¢"""
        # è¿™é‡Œéœ€è¦æ•°æ®åº“ç‰¹å®šçš„å®ç°
        # ç®€åŒ–å®ç°ï¼šè¿”å›æ¨¡æ‹Ÿæ•°æ®
        
        mock_slow_queries = [
            {
                'query': 'SELECT * FROM wechat_message WHERE create_time >= %s',
                'avg_duration': 1250.5,
                'count': 125,
                'last_executed': datetime.now().isoformat(),
                'table': 'wechat_message',
            },
            {
                'query': 'UPDATE wechat_user SET last_message_time = %s WHERE id = %s',
                'avg_duration': 850.3,
                'count': 89,
                'last_executed': datetime.now().isoformat(),
                'table': 'wechat_user',
            },
        ]
        
        return mock_slow_queries
    
    def analyze_table_sizes(self):
        """åˆ†æè¡¨å¤§å°"""
        # è·å–æ‰€æœ‰è¡¨çš„å¤§å°
        query = """
            SELECT 
                table_name,
                pg_size_pretty(pg_total_relation_size(quote_ident(table_name))) as total_size,
                pg_size_pretty(pg_relation_size(quote_ident(table_name))) as table_size,
                pg_size_pretty(pg_total_relation_size(quote_ident(table_name)) - pg_relation_size(quote_ident(table_name))) as index_size,
                (SELECT COUNT(*) FROM %s) as row_count
            FROM information_schema.tables
            WHERE table_schema = 'public'
            ORDER BY pg_total_relation_size(quote_ident(table_name)) DESC
        """
        
        # ç®€åŒ–å®ç°ï¼šè¿”å›æ¨¡æ‹Ÿæ•°æ®
        mock_table_sizes = [
            {
                'table_name': 'wechat_message',
                'total_size': '1.2 GB',
                'table_size': '850 MB',
                'index_size': '350 MB',
                'row_count': 1250000,
            },
            {
                'table_name': 'wechat_user',
                'total_size': '450 MB',
                'table_size': '320 MB',
                'index_size': '130 MB',
                'row_count': 250000,
            },
            {
                'table_name': 'wechat_statistics',
                'total_size': '120 MB',
                'table_size': '95 MB',
                'index_size': '25 MB',
                'row_count': 3650,
            },
        ]
        
        return mock_table_sizes
    
    def analyze_index_usage(self):
        """åˆ†æç´¢å¼•ä½¿ç”¨æƒ…å†µ"""
        # ç®€åŒ–å®ç°ï¼šè¿”å›æ¨¡æ‹Ÿæ•°æ®
        mock_index_usage = [
            {
                'table_name': 'wechat_message',
                'index_name': 'wechat_message_create_time_idx',
                'index_size': '150 MB',
                'scans': 125000,
                'reads': 850000,
                'last_used': datetime.now().isoformat(),
                'usage_percentage': 95.5,
            },
            {
                'table_name': 'wechat_user',
                'index_name': 'wechat_user_openid_account_idx',
                'index_size': '85 MB',
                'scans': 98000,
                'reads': 420000,
                'last_used': datetime.now().isoformat(),
                'usage_percentage': 98.2,
            },
            {
                'table_name': 'wechat_message',
                'index_name': 'wechat_message_status_idx',
                'index_size': '45 MB',
                'scans': 12500,
                'reads': 85000,
                'last_used': (datetime.now() - timedelta(days=1)).isoformat(),
                'usage_percentage': 12.5,
            },
        ]
        
        return mock_index_usage
    
    def generate_optimization_recommendations(self):
        """ç”Ÿæˆä¼˜åŒ–å»ºè®®"""
        recommendations = []
        
        # åˆ†æè¡¨å¤§å°
        table_sizes = self.analyze_table_sizes()
        
        for table in table_sizes:
            if table['row_count'] > 1000000:  # è¶…è¿‡100ä¸‡è¡Œ
                recommendations.append({
                    'type': 'table_partition',
                    'table': table['table_name'],
                    'description': f'è¡¨ {table["table_name"]} æ•°æ®é‡è¾ƒå¤§ ({table["row_count"]:,} è¡Œ)ï¼Œå»ºè®®åˆ†åŒº',
                    'priority': 'medium',
                    'actions': [
                        f'æŒ‰æ—¶é—´å¯¹ {table["table_name"]} è¡¨è¿›è¡Œåˆ†åŒº',
                        'å½’æ¡£å†å²æ•°æ®',
                    ],
                })
        
        # åˆ†æç´¢å¼•ä½¿ç”¨
        index_usage = self.analyze_index_usage()
        
        for index in index_usage:
            if index['usage_percentage'] < 10:  # ä½¿ç”¨ç‡ä½äº10%
                recommendations.append({
                    'type': 'index_optimization',
                    'table': index['table_name'],
                    'index': index['index_name'],
                    'description': f'ç´¢å¼• {index["index_name"]} ä½¿ç”¨ç‡è¾ƒä½ ({index["usage_percentage"]:.1f}%)ï¼Œå»ºè®®è¯„ä¼°æ˜¯å¦éœ€è¦',
                    'priority': 'low',
                    'actions': [
                        f'è¯„ä¼°ç´¢å¼• {index["index_name"]} çš„å¿…è¦æ€§',
                        'è€ƒè™‘åˆ é™¤æˆ–é‡å»ºç´¢å¼•',
                    ],
                })
        
        # åˆ†ææ…¢æŸ¥è¯¢
        slow_queries = self.analyze_slow_queries()
        
        for query in slow_queries:
            if query['avg_duration'] > 5000:  # è¶…è¿‡5ç§’
                recommendations.append({
                    'type': 'query_optimization',
                    'table': query['table'],
                    'description': f'æŸ¥è¯¢æ‰§è¡Œè¾ƒæ…¢ (å¹³å‡ {query["avg_duration"]:.1f}ms)ï¼Œå»ºè®®ä¼˜åŒ–',
                    'priority': 'high',
                    '
æˆ‘å°†ç»§ç»­ç¬¬16å‘¨çš„å·¥ä½œï¼š**æ–‡æ¡£ä¸éƒ¨ç½²**ã€‚æ ¹æ®é¡¹ç›®è®¡åˆ’ï¼Œç¬¬16å‘¨æ˜¯é¡¹ç›®æ”¶å°¾é˜¶æ®µï¼Œéœ€è¦å®Œæˆæ‰€æœ‰æ–‡æ¡£ç¼–å†™å’Œéƒ¨ç½²å‡†å¤‡å·¥ä½œã€‚

## ğŸ“š ç¬¬16å‘¨ï¼šæ–‡æ¡£ä¸éƒ¨ç½²

### **Pythonä¸“å®¶è°ƒåº¦æŒ‡ä»¤ï¼š**
```
æœ¬å‘¨é‡ç‚¹ï¼šå®Œæˆæ‰€æœ‰æŠ€æœ¯æ–‡æ¡£ã€ç”¨æˆ·æ‰‹å†Œå’Œéƒ¨ç½²åŒ…åˆ¶ä½œ
å¼€å‘é¡ºåºï¼šæŠ€æœ¯æ–‡æ¡£ â†’ ç”¨æˆ·æ–‡æ¡£ â†’ éƒ¨ç½²è„šæœ¬ â†’ åŸ¹è®­ææ–™
```

### **åç«¯å¼€å‘å…·ä½“ä»»åŠ¡ï¼š**

#### **ä»»åŠ¡1ï¼šé¡¹ç›®æ–‡æ¡£ä½“ç³»æ­å»º**
```python
# file: docs/__init__.py
"""
Odoo 19å¾®ä¿¡æ”¯ä»˜ä¸ç”Ÿæ€ç³»ç»Ÿé›†æˆé¡¹ç›®
æ–‡æ¡£ä½“ç³»
"""

import os
import json
from pathlib import Path

class ProjectDocumentation:
    """é¡¹ç›®ç®¡ç†æ‰€æœ‰æ–‡æ¡£"""
    
    DOCUMENTATION_STRUCTURE = {
        "æŠ€æœ¯æ–‡æ¡£": {
            "01-ç³»ç»Ÿæ¶æ„è®¾è®¡æ–‡æ¡£.md": "è¯¦ç»†ç³»ç»Ÿæ¶æ„è®¾è®¡",
            "02-æ•°æ®åº“è®¾è®¡æ–‡æ¡£.md": "æ•°æ®åº“è¡¨ç»“æ„è®¾è®¡",
            "03-APIæ¥å£æ–‡æ¡£.md": "RESTful APIæ¥å£è¯´æ˜",
            "04-éƒ¨ç½²è¿ç»´æ‰‹å†Œ.md": "ç³»ç»Ÿéƒ¨ç½²å’Œè¿ç»´æŒ‡å—",
            "05-å®‰å…¨åˆè§„æ–‡æ¡£.md": "å®‰å…¨å®¡è®¡å’Œåˆè§„è¦æ±‚",
        },
        "ç”¨æˆ·æ–‡æ¡£": {
            "01-ç³»ç»Ÿç®¡ç†å‘˜æ‰‹å†Œ.md": "ç®¡ç†å‘˜æ“ä½œæŒ‡å—",
            "02-ç»ˆç«¯ç”¨æˆ·æ“ä½œæŒ‡å—.md": "æ™®é€šç”¨æˆ·ä½¿ç”¨è¯´æ˜",
            "03-POSæ”¶é“¶å‘˜æ‰‹å†Œ.md": "POSç«¯æ“ä½œæŒ‡å—",
            "04-å°ç¨‹åºä½¿ç”¨è¯´æ˜.md": "å¾®ä¿¡å°ç¨‹åºç”¨æˆ·æ‰‹å†Œ",
        },
        "å¼€å‘æ–‡æ¡£": {
            "01-å¼€å‘ç¯å¢ƒæ­å»º.md": "å¼€å‘ç¯å¢ƒé…ç½®æŒ‡å—",
            "02-æ¨¡å—å¼€å‘æŒ‡å—.md": "è‡ªå®šä¹‰æ¨¡å—å¼€å‘è¯´æ˜",
            "03-ä»£ç è§„èŒƒ.md": "ç¼–ç è§„èŒƒå’Œæœ€ä½³å®è·µ",
            "04-æµ‹è¯•æŒ‡å—.md": "è‡ªåŠ¨åŒ–æµ‹è¯•å’Œæ‰‹åŠ¨æµ‹è¯•",
            "05-è´¡çŒ®æŒ‡å—.md": "ä»£ç è´¡çŒ®æµç¨‹",
        },
        "APIæ–‡æ¡£": {
            "01-å¾®ä¿¡æ”¯ä»˜API.md": "å¾®ä¿¡æ”¯ä»˜æ¥å£æ–‡æ¡£",
            "02-æ”¯ä»˜å®æ”¯ä»˜API.md": "æ”¯ä»˜å®æ¥å£æ–‡æ¡£",
            "03-å¾®ä¿¡å…¬ä¼—å·API.md": "å…¬ä¼—å·ç®¡ç†æ¥å£",
            "04-å°ç¨‹åºåç«¯API.md": "å°ç¨‹åºåç«¯æ¥å£",
            "05-ç»Ÿä¸€æ”¯ä»˜ç®¡ç†API.md": "æ”¯ä»˜ç®¡ç†å¹³å°æ¥å£",
        }
    }
    
    def __init__(self, project_root):
        self.project_root = Path(project_root)
        self.docs_dir = self.project_root / "docs"
        
    def create_documentation_structure(self):
        """åˆ›å»ºæ–‡æ¡£ç›®å½•ç»“æ„"""
        print("ğŸ“ åˆ›å»ºæ–‡æ¡£ç›®å½•ç»“æ„...")
        
        # åˆ›å»ºä¸»ç›®å½•
        self.docs_dir.mkdir(exist_ok=True)
        
        # åˆ›å»ºå­ç›®å½•å’Œæ–‡ä»¶
        for category, files in self.DOCUMENTATION_STRUCTURE.items():
            category_dir = self.docs_dir / category
            category_dir.mkdir(exist_ok=True)
            
            print(f"\nğŸ“‚ {category}:")
            for filename, description in files.items():
                file_path = category_dir / filename
                if not file_path.exists():
                    file_path.write_text(self._get_template_content(filename, description))
                    print(f"  ğŸ“„ {filename} - {description}")
                else:
                    print(f"  âœ“ {filename} (å·²å­˜åœ¨)")
    
    def _get_template_content(self, filename, description):
        """è·å–æ–‡æ¡£æ¨¡æ¿å†…å®¹"""
        templates = {
            "ç³»ç»Ÿæ¶æ„è®¾è®¡æ–‡æ¡£.md": self._get_architecture_template(),
            "æ•°æ®åº“è®¾è®¡æ–‡æ¡£.md": self._get_database_template(),
            "APIæ¥å£æ–‡æ¡£.md": self._get_api_template(),
            "éƒ¨ç½²è¿ç»´æ‰‹å†Œ.md": self._get_deployment_template(),
            "å®‰å…¨åˆè§„æ–‡æ¡£.md": self._get_security_template(),
            "ç³»ç»Ÿç®¡ç†å‘˜æ‰‹å†Œ.md": self._get_admin_template(),
            "ç»ˆç«¯ç”¨æˆ·æ“ä½œæŒ‡å—.md": self._get_user_template(),
            "POSæ”¶é“¶å‘˜æ‰‹å†Œ.md": self._get_pos_template(),
            "å°ç¨‹åºä½¿ç”¨è¯´æ˜.md": self._get_miniprogram_template(),
        }
        
        return templates.get(filename, f"# {filename}\n\n{description}\n\n<!-- å¾…å®Œå–„ -->")
    
    def _get_architecture_template(self):
        """ç³»ç»Ÿæ¶æ„è®¾è®¡æ–‡æ¡£æ¨¡æ¿"""
        return """# ç³»ç»Ÿæ¶æ„è®¾è®¡æ–‡æ¡£

## 1. æ¦‚è¿°

### 1.1 é¡¹ç›®ç®€ä»‹
åŸºäºOdoo 19çš„å¾®ä¿¡æ”¯ä»˜ä¸ç”Ÿæ€ç³»ç»Ÿé›†æˆè§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬å¾®ä¿¡æ”¯ä»˜ã€æ”¯ä»˜å®æ”¯ä»˜ã€äº‘é—ªä»˜æ”¯ä»˜ã€å¾®ä¿¡å…¬ä¼—å·ç®¡ç†å¹³å°å’Œå¾®ä¿¡å°ç¨‹åºåç«¯ã€‚

### 1.2 è®¾è®¡ç›®æ ‡
- æ¨¡å—åŒ–è®¾è®¡ï¼Œå„åŠŸèƒ½å¯ç‹¬ç«‹éƒ¨ç½²
- æ”¯æŒé«˜å¹¶å‘æ”¯ä»˜å¤„ç†
- ç¡®ä¿æ”¯ä»˜å®‰å…¨æ€§å’Œåˆè§„æ€§
- æä¾›è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Odoo 19 æ ¸å¿ƒç³»ç»Ÿ                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ”¯ä»˜æ¨¡å— â”‚  â”‚ å…¬ä¼—å·æ¨¡å—â”‚  â”‚ å°ç¨‹åºæ¨¡å—â”‚  â”‚ å…¬å…±æ¨¡å— â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚              â”‚              â”‚              â”‚
         â–¼              â–¼              â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å¤–éƒ¨APIç½‘å…³                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ å¾®ä¿¡æ”¯ä»˜ â”‚  â”‚ æ”¯ä»˜å®   â”‚  â”‚ äº‘é—ªä»˜   â”‚  â”‚ å¾®ä¿¡å¹³å° â”‚   â”‚
â”‚  â”‚ API      â”‚  â”‚ API      â”‚  â”‚ API      â”‚  â”‚ API      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æŠ€æœ¯æ ˆ
| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|----------|------|------|
| **åç«¯æ¡†æ¶** | Odoo | 19.0 | ä¼ä¸šçº§ERPæ¡†æ¶ |
| **ç¼–ç¨‹è¯­è¨€** | Python | 3.10+ | ä¸»è¦å¼€å‘è¯­è¨€ |
| **æ•°æ®åº“** | PostgreSQL | 14+ | ä¸»æ•°æ®åº“ |
| **å‰ç«¯æ¡†æ¶** | OWL (Odoo Web Library) | 2.0+ | Odooå®˜æ–¹å‰ç«¯æ¡†æ¶ |
| **ç¼“å­˜** | Redis | 6.0+ | ç¼“å­˜å’Œä¼šè¯ç®¡ç† |
| **æ¶ˆæ¯é˜Ÿåˆ—** | RabbitMQ/Celery | å¯é€‰ | å¼‚æ­¥ä»»åŠ¡å¤„ç† |
| **å®¹å™¨åŒ–** | Docker | 20.10+ | å®¹å™¨åŒ–éƒ¨ç½² |
| **CI/CD** | GitLab CI/CD | - | æŒç»­é›†æˆéƒ¨ç½² |

## 3. æ¨¡å—è®¾è®¡

### 3.1 æ”¯ä»˜æ¨¡å— (`payment_wechat`, `payment_alipay`, `payment_unionpay`)
- ç»§æ‰¿Odooæ”¯ä»˜æä¾›å•†æ¥å£
- æ”¯æŒæ‰«ç æ”¯ä»˜ã€JSAPIæ”¯ä»˜ã€å°ç¨‹åºæ”¯ä»˜
- å®Œæ•´çš„æ”¯ä»˜æµç¨‹ï¼šä¸‹å•â†’æ”¯ä»˜â†’å›è°ƒâ†’å¯¹è´¦

### 3.2 å¾®ä¿¡å…¬ä¼—å·æ¨¡å— (`wechat_platform`)
- ç²‰ä¸ç®¡ç†å’ŒåŒæ­¥
- æ¶ˆæ¯è‡ªåŠ¨å›å¤
- èœå•ç®¡ç†
- ç´ æç®¡ç†

### 3.3 å¾®ä¿¡å°ç¨‹åºæ¨¡å— (`wechat_miniprogram`)
- å°ç¨‹åºåç«¯API
- ç”¨æˆ·è®¤è¯å’Œä¼šè¯ç®¡ç†
- å•†å“å’Œè®¢å•ç®¡ç†
- æ”¯ä»˜é›†æˆ

### 3.4 å…¬å…±æ¨¡å— (`wechat_common`)
- å¾®ä¿¡APIå®¢æˆ·ç«¯å°è£…
- Access Tokenç®¡ç†
- æ¶ˆæ¯åŠ è§£å¯†å·¥å…·
- é€šç”¨å·¥å…·å‡½æ•°

## 4. æ•°æ®åº“è®¾è®¡

### 4.1 æ ¸å¿ƒè¡¨å…³ç³»
```
payment_provider (Odooæ ‡å‡†è¡¨)
    â”œâ”€â”€ payment_provider_wechat (æ‰©å±•è¡¨)
    â”œâ”€â”€ payment_provider_alipay (æ‰©å±•è¡¨)
    â””â”€â”€ payment_provider_unionpay (æ‰©å±•è¡¨)

payment_transaction (Odooæ ‡å‡†è¡¨)
    â””â”€â”€ wechat_payment_transaction (æ‰©å±•è¡¨)

wechat_account (å¾®ä¿¡å…¬ä¼—å·è´¦å·)
    â”œâ”€â”€ wechat_user (ç²‰ä¸ä¿¡æ¯)
    â”œâ”€â”€ wechat_menu (èœå•é…ç½®)
    â””â”€â”€ wechat_message (æ¶ˆæ¯è®°å½•)

pos_payment_method (POSæ”¯ä»˜æ–¹æ³•)
    â””â”€â”€ pos_payment_wechat_config (å¾®ä¿¡æ”¯ä»˜é…ç½®)
```

### 4.2 å…³é”®è¡¨ç»“æ„
è¯¦ç»†è¡¨ç»“æ„è§ã€Šæ•°æ®åº“è®¾è®¡æ–‡æ¡£ã€‹ã€‚

## 5. å®‰å…¨æ¶æ„

### 5.1 æ”¯ä»˜å®‰å…¨
- APIç­¾åéªŒè¯
- è¯ä¹¦ç®¡ç†
- é˜²é‡æ”¾æ”»å‡»
- æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨

### 5.2 æ•°æ®å®‰å…¨
- æ•°æ®åº“åŠ å¯†
- è®¿é—®æ§åˆ¶
- å®¡è®¡æ—¥å¿—
- å¤‡ä»½æ¢å¤

## 6. æ€§èƒ½è®¾è®¡

### 6.1 ç¼“å­˜ç­–ç•¥
- Redisç¼“å­˜Access Token
- æ•°æ®åº“æŸ¥è¯¢ç¼“å­˜
- é™æ€èµ„æºCDN

### 6.2 è´Ÿè½½å‡è¡¡
- æ”¯æŒå¤šå®ä¾‹éƒ¨ç½²
- æ•°æ®åº“è¯»å†™åˆ†ç¦»
- é™æ€æ–‡ä»¶åˆ†ç¦»

## 7. éƒ¨ç½²æ¶æ„

### 7.1 å•æœºéƒ¨ç½²
é€‚ç”¨äºä¸­å°å‹ä¼ä¸š

### 7.2 é›†ç¾¤éƒ¨ç½²
é€‚ç”¨äºå¤§å‹ä¼ä¸šå’Œé«˜å¹¶å‘åœºæ™¯

## 8. ç›‘æ§å‘Šè­¦

### 8.1 ç³»ç»Ÿç›‘æ§
- æœåŠ¡å™¨èµ„æºç›‘æ§
- åº”ç”¨æ€§èƒ½ç›‘æ§
- æ”¯ä»˜æˆåŠŸç‡ç›‘æ§

### 8.2 ä¸šåŠ¡ç›‘æ§
- äº¤æ˜“é‡ç›‘æ§
- ç”¨æˆ·æ´»è·ƒåº¦ç›‘æ§
- å¼‚å¸¸äº¤æ˜“æ£€æµ‹

## 9. æ‰©å±•æ€§è®¾è®¡

### 9.1 æ°´å¹³æ‰©å±•
- æ”¯æŒå¢åŠ æ”¯ä»˜æ¸ é“
- æ”¯æŒæ‰©å±•ä¸šåŠ¡æ¨¡å—
- æ”¯æŒå›½é™…åŒ–

### 9.2 å‚ç›´æ‰©å±•
- æ¨¡å—å¯ç‹¬ç«‹å‡çº§
- APIå‘åå…¼å®¹
- é…ç½®åŒ–å¼€å‘

---

*æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.0*
*æœ€åæ›´æ–°ï¼š{å½“å‰æ—¥æœŸ}*
*ç»´æŠ¤å›¢é˜Ÿï¼šå¼€å‘å›¢é˜Ÿ*
"""

    def _get_database_template(self):
        """æ•°æ®åº“è®¾è®¡æ–‡æ¡£æ¨¡æ¿"""
        return """# æ•°æ®åº“è®¾è®¡æ–‡æ¡£

## 1. æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°Odoo 19å¾®ä¿¡æ”¯ä»˜ä¸ç”Ÿæ€ç³»ç»Ÿé›†æˆé¡¹ç›®çš„æ•°æ®åº“è®¾è®¡ï¼ŒåŒ…æ‹¬è¡¨ç»“æ„ã€å­—æ®µå®šä¹‰ã€ç´¢å¼•ã€çº¦æŸå’Œå…³ç³»ã€‚

## 2. æ•°æ®åº“ç‰ˆæœ¬
- PostgreSQL 14+
- å­—ç¬¦é›†ï¼šUTF8
- æ’åºè§„åˆ™ï¼šen_US.UTF-8

## 3. æ ¸å¿ƒè¡¨ç»“æ„

### 3.1 å¾®ä¿¡æ”¯ä»˜æä¾›å•†è¡¨ (`payment_provider_wechat`)

**è¡¨è¯´æ˜**: å­˜å‚¨å¾®ä¿¡æ”¯ä»˜æä¾›å•†é…ç½®ä¿¡æ¯

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å¯ç©º | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|------|--------|------|
| `id` | INTEGER | - | NO | åºåˆ— | ä¸»é”® |
| `create_uid` | INTEGER | - | YES | NULL | åˆ›å»ºç”¨æˆ· |
| `create_date` | TIMESTAMP | - | YES | NULL | åˆ›å»ºæ—¶é—´ |
| `write_uid` | INTEGER | - | YES | NULL | æœ€åä¿®æ”¹ç”¨æˆ· |
| `write_date` | TIMESTAMP | - | YES | NULL | æœ€åä¿®æ”¹æ—¶é—´ |
| `provider_id` | INTEGER | - | NO | - | å…³è”æ”¯ä»˜æä¾›å•† |
| `wechat_mch_id` | VARCHAR | 32 | NO | - | å¾®ä¿¡å•†æˆ·å· |
| `wechat_app_id` | VARCHAR | 32 | NO | - | å…¬ä¼—å·AppID |
| `wechat_api_v3_key` | VARCHAR | 128 | NO | - | APIv3å¯†é’¥(åŠ å¯†å­˜å‚¨) |
| `wechat_merchant_serial_no` | VARCHAR | 64 | YES | NULL | å•†æˆ·è¯ä¹¦åºåˆ—å· |
| `wechat_payment_methods` | VARCHAR | 32 | NO | 'native' | æ”¯ä»˜æ–¹å¼ |
| `wechat_sandbox` | BOOLEAN | - | NO | false | æ²™ç®±æ¨¡å¼ |
| `wechat_cert_path` | VARCHAR | 255 | YES | NULL | è¯ä¹¦è·¯å¾„ |
| `wechat_private_key` | BYTEA | - | YES | NULL | ç§é’¥(åŠ å¯†å­˜å‚¨) |

**ç´¢å¼•**:
- `idx_payment_provider_wechat_provider` ON `provider_id`
- `idx_payment_provider_wechat_mch_id` ON `wechat_mch_id`

**å¤–é”®**:
- `provider_id` REFERENCES `payment_provider`(`id`) ON DELETE CASCADE

### 3.2 å¾®ä¿¡äº¤æ˜“æ‰©å±•è¡¨ (`wechat_payment_transaction`)

**è¡¨è¯´æ˜**: æ‰©å±•æ”¯ä»˜äº¤æ˜“è¡¨ï¼Œå­˜å‚¨å¾®ä¿¡æ”¯ä»˜ç‰¹æœ‰ä¿¡æ¯

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å¯ç©º | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|------|--------|------|
| `id` | INTEGER | - | NO | åºåˆ— | ä¸»é”® |
| `transaction_id` | INTEGER | - | NO | - | å…³è”äº¤æ˜“ |
| `wechat_prepay_id` | VARCHAR | 64 | YES | NULL | å¾®ä¿¡é¢„æ”¯ä»˜ID |
| `wechat_transaction_id` | VARCHAR | 32 | YES | NULL | å¾®ä¿¡äº¤æ˜“å· |
| `wechat_openid` | VARCHAR | 64 | YES | NULL | ç”¨æˆ·OpenID |
| `wechat_bank_type` | VARCHAR | 16 | YES | NULL | é“¶è¡Œç±»å‹ |
| `wechat_fee_type` | VARCHAR | 8 | YES | 'CNY' | è´§å¸ç±»å‹ |
| `wechat_cash_fee` | INTEGER | - | YES | 0 | ç°é‡‘æ”¯ä»˜é‡‘é¢(åˆ†) |
| `wechat_time_end` | VARCHAR | 14 | YES | NULL | æ”¯ä»˜å®Œæˆæ—¶é—´ |
| `wechat_trade_state` | VARCHAR | 32 | YES | NULL | äº¤æ˜“çŠ¶æ€ |
| `wechat_trade_state_desc` | VARCHAR | 256 | YES | NULL | äº¤æ˜“çŠ¶æ€æè¿° |
| `wechat_refund_id` | VARCHAR | 64 | YES | NULL | å¾®ä¿¡é€€æ¬¾å•å· |

**ç´¢å¼•**:
- `idx_wechat_payment_transaction` ON `transaction_id`
- `idx_wechat_payment_transaction_wechat` ON `wechat_transaction_id`
- `idx_wechat_payment_transaction_openid` ON `wechat_openid`

**å¤–é”®**:
- `transaction_id` REFERENCES `payment_transaction`(`id`) ON DELETE CASCADE

### 3.3 å¾®ä¿¡å…¬ä¼—å·è´¦å·è¡¨ (`wechat_account`)

**è¡¨è¯´æ˜**: å­˜å‚¨å¾®ä¿¡å…¬ä¼—å·é…ç½®ä¿¡æ¯

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å¯ç©º | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|------|--------|------|
| `id` | INTEGER | - | NO | åºåˆ— | ä¸»é”® |
| `name` | VARCHAR | 128 | NO | - | å…¬ä¼—å·åç§° |
| `app_id` | VARCHAR | 32 | NO | - | å…¬ä¼—å·AppID |
| `app_secret` | VARCHAR | 128 | NO | - | AppSecret(åŠ å¯†å­˜å‚¨) |
| `account_type` | VARCHAR | 32 | NO | 'service' | è´¦å·ç±»å‹ |
| `access_token` | VARCHAR | 512 | YES | NULL | Access Token |
| `token_expires_at` | TIMESTAMP | - | YES | NULL | Tokenè¿‡æœŸæ—¶é—´ |
| `jsapi_ticket` | VARCHAR | 512 | YES | NULL | JSAPI Ticket |
| `ticket_expires_at` | TIMESTAMP | - | YES | NULL | Ticketè¿‡æœŸæ—¶é—´ |
| `token` | VARCHAR | 32 | NO | - | æœåŠ¡å™¨ä»¤ç‰Œ |
| `encoding_aes_key` | VARCHAR | 43 | YES | NULL | æ¶ˆæ¯åŠ è§£å¯†å¯†é’¥ |
| `server_url` | VARCHAR | 255 | YES | NULL | æœåŠ¡å™¨åœ°å€ |
| `is_valid` | BOOLEAN | - | NO | false | é…ç½®æ˜¯å¦æœ‰æ•ˆ |
| `last_sync_time` | TIMESTAMP | - | YES | NULL | æœ€ååŒæ­¥æ—¶é—´ |
| `api_call_count` | INTEGER | - | NO | 0 | APIè°ƒç”¨æ¬¡æ•° |
| `error_count` | INTEGER | - | NO | 0 | é”™è¯¯è®¡æ•° |
| `last_error` | TEXT | - | YES | NULL | æœ€åé”™è¯¯ä¿¡æ¯ |

**ç´¢å¼•**:
- `idx_wechat_account_app_id` ON `app_id`
- `idx_wechat_account_is_valid` ON `is_valid`

### 3.4 å¾®ä¿¡ç²‰ä¸è¡¨ (`wechat_user`)

**è¡¨è¯´æ˜**: å­˜å‚¨å¾®ä¿¡å…¬ä¼—å·ç²‰ä¸ä¿¡æ¯

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å¯ç©º | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|------|--------|------|
| `id` | INTEGER | - | NO | åºåˆ— | ä¸»é”® |
| `account_id` | INTEGER | - | NO | - | å…³è”å…¬ä¼—å· |
| `openid` | VARCHAR | 64 | NO | - | ç”¨æˆ·OpenID |
| `unionid` | VARCHAR | 64 | YES | NULL | ç”¨æˆ·UnionID |
| `nickname` | VARCHAR | 128 | YES | NULL | ç”¨æˆ·æ˜µç§° |
| `sex` | INTEGER | - | YES | 0 | æ€§åˆ«(1ç”·,2å¥³,0æœªçŸ¥) |
| `province` | VARCHAR | 64 | YES | NULL | çœä»½ |
| `city` | VARCHAR | 64 | YES | NULL | åŸå¸‚ |
| `country` | VARCHAR | 64 | YES | NULL | å›½å®¶ |
| `headimgurl` | VARCHAR | 512 | YES | NULL | å¤´åƒURL |
| `privilege` | TEXT | - | YES | NULL | ç”¨æˆ·ç‰¹æƒä¿¡æ¯(JSON) |
| `subscribe` | BOOLEAN | - | NO | false | æ˜¯å¦å…³æ³¨ |
| `subscribe_time` | TIMESTAMP | - | YES | NULL | å…³æ³¨æ—¶é—´ |
| `subscribe_scene` | VARCHAR | 64 | YES | NULL | å…³æ³¨æ¥æº |
| `qr_scene` | VARCHAR | 64 | YES | NULL | äºŒç»´ç åœºæ™¯å€¼ |
| `qr_scene_str` | VARCHAR | 128 | YES | NULL | äºŒç»´ç åœºæ™¯å­—ç¬¦ä¸² |
| `remark` | VARCHAR | 256 | YES | NULL | å¤‡æ³¨ |
| `groupid` | INTEGER | - | YES | 0 | åˆ†ç»„ID |
| `tagid_list` | TEXT | - | YES | NULL | æ ‡ç­¾IDåˆ—è¡¨(JSON) |
| `partner_id` | INTEGER | - | YES | NULL | å…³è”è”ç³»äºº |
| `last_sync_time` | TIMESTAMP | - | YES | NULL | æœ€ååŒæ­¥æ—¶é—´ |

**ç´¢å¼•**:
- `idx_wechat_user_account_openid` ON `account_id`, `openid`
- `idx_wechat_user_unionid` ON `unionid`
- `idx_wechat_user_partner` ON `partner_id`
- `idx_wechat_user_subscribe` ON `subscribe`

**å¤–é”®**:
- `account_id` REFERENCES `wechat_account`(`id`) ON DELETE CASCADE
- `partner_id` REFERENCES `res_partner`(`id`) ON DELETE SET NULL

### 3.5 POSå¾®ä¿¡æ”¯ä»˜é…ç½®è¡¨ (`pos_payment_wechat_config`)

**è¡¨è¯´æ˜**: å­˜å‚¨POSç«¯å¾®ä¿¡æ”¯ä»˜é…ç½®

| å­—æ®µå | ç±»å‹ | é•¿åº¦ | å¯ç©º | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|------|------|--------|------|
| `id` | INTEGER | - | NO | åºåˆ— | ä¸»é”® |
| `payment_method_id` | INTEGER | - | NO | - | å…³è”æ”¯ä»˜æ–¹æ³• |
| `wechat_payment_type` | VARCHAR | 32 | NO | 'barcode' | æ”¯ä»˜ç±»å‹ |
| `wechat_terminal_id` | VARCHAR | 32 | YES | NULL | ç»ˆç«¯ç¼–å· |
| `wechat_store_id` | VARCHAR | 32 | YES | NULL | é—¨åº—ç¼–å· |
| `wechat_device_info` | VARCHAR | 64 | YES | NULL | è®¾å¤‡ä¿¡æ¯ |
| `wechat_sub_merchant_id` | VARCHAR | 32 | YES | NULL | å­å•†æˆ·å· |
| `wechat_payment_provider_id` | INTEGER | - | YES | NULL | å¾®ä¿¡æ”¯ä»˜æä¾›å•† |

**ç´¢å¼•**:
- `idx_pos_payment_wechat_config_method` ON `payment_method_id`

**å¤–é”®**:
- `payment_method_id` REFERENCES `pos_payment_method`(`id`) ON DELETE CASCADE
- `wechat_payment_provider_id` REFERENCES `payment_provider`(`id`) ON DELETE SET NULL

## 4. æ•°æ®å­—å…¸

### 4.1 æšä¸¾å€¼å®šä¹‰

#### æ”¯ä»˜æ–¹å¼ (`wechat_payment_methods`)
- `native`: æ‰«ç æ”¯ä»˜
- `jsapi`: JSAPIæ”¯ä»˜ï¼ˆå¾®ä¿¡å†…æ”¯ä»˜ï¼‰
- `miniprogram`: å°ç¨‹åºæ”¯ä»˜
- `app`: APPæ”¯ä»˜
- `mwap`: H5æ”¯ä»˜

#### å…¬ä¼—å·ç±»å‹ (`account_type`)
- `service`: æœåŠ¡å·
- `subscription`: è®¢é˜…å·
- `enterprise`: ä¼ä¸šå·
- `miniprogram`: å°ç¨‹åº

#### æ”¯ä»˜çŠ¶æ€ (`wechat_trade_state`)
- `SUCCESS`: æ”¯ä»˜æˆåŠŸ
- `REFUND`: è½¬å…¥é€€æ¬¾
- `NOTPAY`: æœªæ”¯ä»˜
- `CLOSED`: å·²å…³é—­
- `REVOKED`: å·²æ’¤é”€
- `USERPAYING`: ç”¨æˆ·æ”¯ä»˜ä¸­
- `PAYERROR`: æ”¯ä»˜å¤±è´¥

## 5. æ•°æ®åº“è§†å›¾

### 5.1 æ”¯ä»˜äº¤æ˜“è§†å›¾ (`v_payment_transaction_detail`)
```sql
CREATE VIEW v_payment_transaction_detail AS
SELECT 
    pt.id,
    pt.reference,
    pt.amount,
    pt.state,
    pt.date_validate,
    pp.name as provider_name,
    pp.code as provider_code,
    wpt.wechat_transaction_id,
    wpt.wechat_openid,
    wpt.wechat_trade_state,
    wpt.wechat_time_end
FROM payment_transaction pt
LEFT JOIN payment_provider pp ON pt.provider_id = pp.id
LEFT JOIN wechat_payment_transaction wpt ON pt.id = wpt.transaction_id;
```

### 5.2 ç²‰ä¸ç»Ÿè®¡è§†å›¾ (`v_wechat_user_statistics`)
```sql
CREATE VIEW v_wechat_user_statistics AS
SELECT 
    wa.name as account_name,
    COUNT(CASE WHEN wu.subscribe = true THEN 1 END) as subscribe_count,
    COUNT(CASE WHEN wu.subscribe = false THEN 1 END) as unsubscribe_count,
    COUNT(DISTINCT wu.province) as province_count,
    AVG(CASE WHEN wu.sex = 1 THEN 1 WHEN wu.sex = 2 THEN 2 ELSE 1.5 END) as avg_sex,
    MAX(wu.subscribe_time) as latest_subscribe
FROM wechat_account wa
LEFT JOIN wechat_user wu ON wa.id = wu.account_id
GROUP BY wa.id, wa.name;
```

## 6. å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°

### 6.1 åŒæ­¥ç²‰ä¸æ•°æ®å‡½æ•°
```sql
CREATE OR REPLACE FUNCTION sync_wechat_users(
    p_account_id INTEGER,
    p_sync_count INTEGER DEFAULT 1000
)
RETURNS INTEGER AS $$
DECLARE
    v_synced_count INTEGER := 0;
BEGIN
    -- å®ç°ç²‰ä¸åŒæ­¥é€»è¾‘
    -- è¿™é‡Œè°ƒç”¨å¾®ä¿¡APIåŒæ­¥ç²‰ä¸æ•°æ®
    RETURN v_synced_count;
END;
$$ LANGUAGE plpgsql;
```

### 6.2 æ”¯ä»˜å¯¹è´¦å­˜å‚¨è¿‡ç¨‹
```sql
CREATE OR REPLACE PROCEDURE reconcile_payments(
    p_start_date DATE,
    p_end_date DATE,
    p_provider_code VARCHAR DEFAULT NULL
)
LANGUAGE plpgsql
AS $$
BEGIN
    -- å®ç°å¯¹è´¦é€»è¾‘
    -- æ¯”è¾ƒç³»ç»Ÿäº¤æ˜“å’Œç¬¬ä¸‰æ–¹æ”¯ä»˜å¹³å°äº¤æ˜“
END;
$$;
```

## 7. æ•°æ®åº“ç»´æŠ¤

### 7.1 å®šæ—¶ä»»åŠ¡
```sql
-- æ¯å¤©å‡Œæ™¨æ¸…ç†è¿‡æœŸToken
SELECT cron.schedule(
    'clean-expired-tokens',
    '0 2 * * *',
    $$DELETE FROM wechat_account 
      WHERE token_expires_at < NOW() - INTERVAL '7 days'$$
);

-- æ¯å°æ—¶åˆ·æ–°å³å°†è¿‡æœŸçš„Token
SELECT cron.schedule(
    'refresh-expiring-tokens',
    '0 * * * *',
    $$UPDATE wechat_account 
      SET access_token = NULL, token_expires_at = NULL
      WHERE token_expires_at < NOW() + INTERVAL '5 minutes'$$
);
```

### 7.2 å¤‡ä»½ç­–ç•¥
- å…¨é‡å¤‡ä»½ï¼šæ¯å¤©å‡Œæ™¨2ç‚¹
- å¢é‡å¤‡ä»½ï¼šæ¯å°æ—¶
- äº¤æ˜“æ—¥å¿—å¤‡ä»½ï¼šæ¯15åˆ†é’Ÿ
- ä¿ç•™ç­–ç•¥ï¼š30å¤©

## 8. æ€§èƒ½ä¼˜åŒ–

### 8.1 ç´¢å¼•ä¼˜åŒ–å»ºè®®
1. ä¸ºé¢‘ç¹æŸ¥è¯¢çš„å­—æ®µåˆ›å»ºç´¢å¼•
2. ä½¿ç”¨å¤åˆç´¢å¼•å‡å°‘ç´¢å¼•æ•°é‡
3. å®šæœŸåˆ†æç´¢å¼•ä½¿ç”¨æƒ…å†µ

### 8.2 åˆ†åŒºç­–ç•¥
- äº¤æ˜“è¡¨æŒ‰æœˆä»½åˆ†åŒº
- æ—¥å¿—è¡¨æŒ‰æ—¥æœŸåˆ†åŒº
- ç²‰ä¸è¡¨æŒ‰å…¬ä¼—å·åˆ†åŒº

### 8.3 æŸ¥è¯¢ä¼˜åŒ–
- é¿å…SELECT *
- ä½¿ç”¨EXPLAINåˆ†ææŸ¥è¯¢è®¡åˆ’
- åˆç†ä½¿ç”¨JOINå’Œå­æŸ¥è¯¢

## 9. å®‰å…¨è€ƒè™‘

### 9.1 æ•°æ®åŠ å¯†
- æ•æ„Ÿå­—æ®µåŠ å¯†å­˜å‚¨
- ä¼ è¾“è¿‡ç¨‹ä½¿ç”¨SSL/TLS
- å®šæœŸæ›´æ¢åŠ å¯†å¯†é’¥

### 9.2 è®¿é—®æ§åˆ¶
- æœ€å°æƒé™åŸåˆ™
- å®¡è®¡æ‰€æœ‰æ•°æ®è®¿é—®
- IPç™½åå•é™åˆ¶

## 10. é™„å½•

### 10.1 æ•°æ®åº“ç‰ˆæœ¬å‡çº§è„šæœ¬
è§ `scripts/database/migrations/` ç›®å½•

### 10.2 æ•°æ®è¿ç§»æŒ‡å—
è§ `docs/éƒ¨ç½²è¿ç»´æ‰‹å†Œ.md`

---

*æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.0*
*æœ€åæ›´æ–°ï¼š{å½“å‰æ—¥æœŸ}*
*ç»´æŠ¤å›¢é˜Ÿï¼šå¼€å‘å›¢é˜Ÿ*
"""

    def _get_api_template(self):
        """APIæ¥å£æ–‡æ¡£æ¨¡æ¿"""
        return """# APIæ¥å£æ–‡æ¡£

## 1. æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°Odoo 19å¾®ä¿¡æ”¯ä»˜ä¸ç”Ÿæ€ç³»ç»Ÿé›†æˆé¡¹ç›®çš„APIæ¥å£è§„èŒƒï¼ŒåŒ…æ‹¬å¾®ä¿¡æ”¯ä»˜APIã€æ”¯ä»˜å®APIã€å¾®ä¿¡å…¬ä¼—å·APIå’Œå°ç¨‹åºåç«¯APIã€‚

## 2. APIçº¦å®š

### 2.1 é€šç”¨çº¦å®š
- æ‰€æœ‰APIä½¿ç”¨HTTPSåè®®
- è¯·æ±‚å’Œå“åº”ä½¿ç”¨JSONæ ¼å¼
- å­—ç¬¦ç¼–ç ï¼šUTF-8
- æ—¶é—´æ ¼å¼ï¼šISO 8601 (YYYY-MM-DDTHH:mm:ssZ)

### 2.2 è®¤è¯æ–¹å¼
- å†…éƒ¨APIï¼šä½¿ç”¨Odoo Sessionè®¤è¯
- å¤–éƒ¨APIï¼šä½¿ç”¨JWT Tokenæˆ–API Key
- å¾®ä¿¡å›è°ƒï¼šä½¿ç”¨å¾®ä¿¡ç­¾åéªŒè¯

### 2.3 å“åº”æ ¼å¼
```json
{
    "success": true,
    "code": 0,
    "message": "æ“ä½œæˆåŠŸ",
    "data": {},
    "timestamp": "2024-01-01T00:00:00Z"
}
```

### 2.4 é”™è¯¯ç å®šä¹‰
| é”™è¯¯ç  | è¯´æ˜ |
|--------|------|
| 0 | æˆåŠŸ |
| 1000-1999 | ä¸šåŠ¡é”™è¯¯ |
| 2000-2999 | è®¤è¯é”™è¯¯ |
| 3000-3999 | å‚æ•°é”™è¯¯ |
| 4000-4999 | æ”¯ä»˜é”™è¯¯ |
| 5000-5999 | ç³»ç»Ÿé”™è¯¯ |

## 3. å¾®ä¿¡æ”¯ä»˜API

### 3.1 åˆ›å»ºæ”¯ä»˜è®¢å•
**æ¥å£**: `POST /api/v1/wechat/payment/create`

**è¯·æ±‚å‚æ•°**:
```json
{
    "order_id": "ORDER202401010001",
    "amount": 100.00,
    "description": "æµ‹è¯•è®¢å•",
    "payment_type": "native",
    "openid": "o6_bmjrPTlm6_2sgVt7hMZOPfL2M",
    "notify_url": "https://example.com/wechat/notify"
}
```

**å“åº”å‚æ•°**:
```json
{
    "success": true,
    "data": {
        "payment_id": "PAY123456789",
        "qr_code_url": "https://api.mch.weixin.qq.com/v3/pay/transactions/native?code_url=weixin://wxpay/bizpayurl?pr=abcdefg",
        "prepay_id": "wx20240101000000abcdefghijklmnopqrst",
        "expire_time": "2024-01-01T00:10:00Z"
    }
}
```

### 3.2 æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€
**æ¥å£**: `GET /api/v1/wechat/payment/query/{payment_id}`

**å“åº”å‚æ•°**:
```json
{
    "success": true,
    "data": {
        "payment_id": "PAY123456789",
        "status": "SUCCESS",
        "amount": 100.00,
        "transaction_id": "4200000000202401010000000001",
        "payment_time": "2024-01-01T00:05:00+08:00",
        "payer_openid": "o6_bmjrPTlm6_2sgVt7hMZOPfL2M"
    }
}
```

### 3.3 é€€æ¬¾æ¥å£
**æ¥å£**: `POST /api/v1/wechat/payment/refund`

**è¯·æ±‚å‚æ•°**:
```json
{
    "payment_id": "PAY123456789",
    "refund_amount": 100.00,
    "refund_reason": "ç”¨æˆ·ç”³è¯·é€€æ¬¾",
    "notify_url": "https://example.com/wechat/refund/notify"
}
```

## 4. æ”¯ä»˜å®API

### 4.1 åˆ›å»ºæ”¯ä»˜å®æ”¯ä»˜
**æ¥å£**: `POST /api/v1/alipay/payment/create`

### 4.2 æ”¯ä»˜å®å›è°ƒå¤„ç†
**æ¥å£**: `POST /api/v1/alipay/payment/notify`

## 5. å¾®ä¿¡å…¬ä¼—å·API

### 5.1 è·å–JS-SDKé…ç½®
**æ¥å£**: `GET /api/v1/wechat/jsconfig`

**è¯·æ±‚å‚æ•°**:
```json
{
    "url": "https://example.com/page"
}
```

**å“åº”å‚æ•°**:
```json
{
    "success": true,
    "data": {
        "appId": "wx1234567890abcdef",
        "timestamp": 1704067200,
        "nonceStr": "abcdefg123456",
        "signature": "abcdefghijklmnopqrstuvwxyz123456",
        "jsApiList": ["chooseImage", "previewImage", "uploadImage"]
    }
}
```

### 5.2 å‘é€æ¨¡æ¿æ¶ˆæ¯
**æ¥å£**: `POST /api/v1/wechat/template/send`

## 6. å°ç¨‹åºåç«¯API

### 6.1 å°ç¨‹åºç™»å½•
**æ¥å£**: `POST /api/v1/miniprogram/auth/login`

**è¯·æ±‚å‚æ•°**:
```json
{
    "code": "021abc123def456ghi789jkl012mno345"
}
```

**å“åº”å‚æ•°**:
```json
{
    "success": true,
    "data": {
        "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
        "user_info": {
            "openid": "o6_bmjrPTlm6_2sgVt7hMZOPfL2M",
            "unionid": "o6_bmasdasdsad6_2sgVt7hMZOPfL2M",
            "nickname": "å¾®ä¿¡ç”¨æˆ·",
            "avatar": "https://thirdwx.qlogo.cn/mmopen/vi_32/..."
        }
    }
}
```

### 6.2 è·å–å•†å“åˆ—è¡¨
**æ¥å£**: `GET /api/v1/miniprogram/products`

**è¯·æ±‚å‚æ•°**:
```json
{
    "page": 1,
    "page_size": 20,
    "category_id": 1,
    "sort_by": "price",
    "sort_order": "asc"
}
```

## 7. ç»Ÿä¸€æ”¯ä»˜ç®¡ç†API

### 7.1 è·å–æ”¯ä»˜æä¾›å•†åˆ—è¡¨
**æ¥å£**: `GET /api/v1/payment/providers`

### 7.2 äº¤æ˜“æŸ¥è¯¢
**æ¥å£**: `GET /api/v1/payment/transactions`

## 8. Webhookå›è°ƒ

### 8.1 å¾®ä¿¡æ”¯ä»˜å›è°ƒ
**æ¥å£**: `POST /wechat/payment/notify`

### 8.2 æ”¯ä»˜å®å›è°ƒ
**æ¥å£**: `POST /alipay/payment/notify`

## 9. APIé™æµç­–ç•¥

| APIç±»åˆ« | é™åˆ¶é¢‘ç‡ | é™åˆ¶å•ä½ |
|---------|----------|----------|
| æ”¯ä»˜ç›¸å…³ | 100æ¬¡/åˆ†é’Ÿ | æ¯IP |
| ç”¨æˆ·ç›¸å…³ | 60æ¬¡/åˆ†é’Ÿ | æ¯ç”¨æˆ· |
| æŸ¥è¯¢ç›¸å…³ | 300æ¬¡/åˆ†é’Ÿ | æ¯IP |
| ç®¡ç†ç›¸å…³ | 30æ¬¡/åˆ†é’Ÿ | æ¯ç”¨æˆ· |

## 10. APIæµ‹è¯•

### 10.1 æµ‹è¯•ç¯å¢ƒ
- åœ°å€ï¼šhttps://test.example.com/api
- æµ‹è¯•è´¦å·ï¼štest@example.com
- æµ‹è¯•å¯†ç ï¼šTest@123456

### 10.2 æµ‹è¯•å·¥å…·
- Postman Collection: `docs/api/Wechat_Payment_API.postman_collection.json`
- Swagger UI: `https://example.com/api/docs`

## 11. é™„å½•

### 11.1 æ¥å£å˜æ›´å†å²
| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´è¯´æ˜ |
|------|------|----------|
| v1.0 | 2024-01-01 | åˆå§‹ç‰ˆæœ¬ |
| v1.1 | 2024-02-01 | å¢åŠ å°ç¨‹åºAPI |

### 11.2 å¸¸è§é—®é¢˜
1. Q: APIè¿”å›ç­¾åé”™è¯¯æ€ä¹ˆåŠï¼Ÿ
   A: æ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦åŒæ­¥ï¼Œç­¾åå‚æ•°æ˜¯å¦æ­£ç¡®

2. Q: æ”¯ä»˜å›è°ƒæ²¡æœ‰æ”¶åˆ°æ€ä¹ˆåŠï¼Ÿ
   A: æ£€æŸ¥æœåŠ¡å™¨ç½‘ç»œï¼ŒæŸ¥çœ‹å›è°ƒæ—¥å¿—

---

*æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.0*
*æœ€åæ›´æ–°ï¼š{å½“å‰æ—¥æœŸ}*
*ç»´æŠ¤å›¢é˜Ÿï¼šå¼€å‘å›¢é˜Ÿ*
"""

    def _get_deployment_template(self):
        """éƒ¨ç½²è¿ç»´æ‰‹å†Œæ¨¡æ¿"""
        return """# éƒ¨ç½²è¿ç»´æ‰‹å†Œ

## 1. ç³»ç»Ÿè¦æ±‚

### 1.1 ç¡¬ä»¶è¦æ±‚
| ç¯å¢ƒ | CPU | å†…å­˜ | å­˜å‚¨ | ç½‘ç»œ |
|------|-----|------|------|------|
| æµ‹è¯•ç¯å¢ƒ | 4æ ¸ | 8GB | 100GB | 10Mbps |
| ç”Ÿäº§ç¯å¢ƒ | 8æ ¸+ | 16GB+ | 500GB+ | 100Mbps+ |
| é«˜å¯ç”¨ç¯å¢ƒ | 16æ ¸+ | 32GB+ | 1TB+ | 1Gbps+ |

### 1.2 è½¯ä»¶è¦æ±‚
| ç»„ä»¶ | ç‰ˆæœ¬è¦æ±‚ | è¯´æ˜ |
|------|----------|------|
| æ“ä½œç³»ç»Ÿ | Ubuntu 20.04+/CentOS 8+ | Linuxå‘è¡Œç‰ˆ |
| Python | 3.10+ | ç¼–ç¨‹è¯­è¨€ |
| PostgreSQL | 14+ | æ•°æ®åº“ |
| Redis | 6.0+ | ç¼“å­˜ |
| Nginx | 1.18+ | WebæœåŠ¡å™¨ |
| Docker | 20.10+ | å®¹å™¨åŒ–(å¯é€‰) |

## 2. éƒ¨ç½²æ–¹å¼

### 2.1 Dockeréƒ¨ç½²ï¼ˆæ¨èï¼‰

#### 2.1.1 ç¯å¢ƒå‡†å¤‡
```bash
# å®‰è£…Dockerå’ŒDocker Compose
sudo apt-get update
sudo apt-get install docker.io docker-compose

# åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir -p /opt/odoo-wechat
cd /opt/odoo-wechat
```

#### 2.1.2 é…ç½®æ–‡ä»¶
```yaml
# docker-compose.yml
version: '3.8'

services:
  postgres:
    image: postgres:14
    environment:
      POSTGRES_DB: odoo
      POSTGRES_USER: odoo
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    restart: unless-stopped

  redis:
    image: redis:6-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis-data:/data
    restart: unless-stopped

  odoo:
    image: odoo:19.0
    depends_on:
      - postgres
      - redis
    environment:
      HOST: postgres
      USER: odoo
      PASSWORD: ${DB_PASSWORD}
      REDIS_HOST: redis
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    volumes:
      - odoo-data:/var/lib/odoo
      - ./addons:/mnt/addons
      - ./config:/etc/odoo
    ports:
      - "8069:8069"
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - odoo
    restart: unless-stopped

volumes:
  postgres-data:
  redis-data:
  odoo-data:
```

#### 2.1.3 ç¯å¢ƒå˜é‡æ–‡ä»¶
```bash
# .env
DB_PASSWORD=StrongPassword123!
REDIS_PASSWORD=RedisPass456
ODOO_ADMIN_PASSWORD=Admin@123456
WEIXIN_API_KEY=your_weixin_api_key
ALIPAY_API_KEY=your_alipay_api_key
```

#### 2.1.4 Nginxé…ç½®
```nginx
# nginx.conf
events {
    worker_connections 1024;
}

http {
    upstream odoo {
        server odoo:8069;
    }

    server {
        listen 80;
        server_name your-domain.com;
        return 301 https://$server_name$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name your-domain.com;

        ssl_certificate /etc/nginx/ssl/fullchain.pem;
        ssl_certificate_key /etc/nginx/ssl/privkey.pem;

        # SSLé…ç½®
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers off;

        # Odooåº”ç”¨
        location / {
            proxy_pass http://odoo;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # é™æ€æ–‡ä»¶ç¼“å­˜
        location /web/static/ {
            proxy_cache_valid 200 60m;
            proxy_buffering on;
            proxy_pass http://odoo;
        }

        # é•¿è½®è¯¢
        location /longpolling {
            proxy_pass http://odoo;
        }
    }
}
```

#### 2.1.5 å¯åŠ¨æœåŠ¡
```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f odoo
```

### 2.2 ä¼ ç»Ÿéƒ¨ç½²

#### 2.2.1 å®‰è£…ä¾èµ–
```bash
# æ›´æ–°ç³»ç»Ÿ
sudo apt-get update
sudo apt-get upgrade -y

# å®‰è£…Pythonå’Œç›¸å…³å·¥å…·
sudo apt-get install -y python3.10 python3.10-venv python3.10-dev
sudo apt-get install -y build-essential libssl-dev libffi-dev
sudo apt-get install -y libxml2-dev libxslt1-dev libldap2-dev libsasl2-dev
sudo apt-get install -y libpq-dev libjpeg-dev libfreetype6-dev zlib1g-dev

# å®‰è£…PostgreSQL
sudo apt-get install -y postgresql-14 postgresql-client-14

# å®‰è£…Redis
sudo apt-get install -y redis-server

# å®‰è£…Nginx
sudo apt-get install -y nginx
```

#### 2.2.2 é…ç½®PostgreSQL
```bash
# åˆ‡æ¢åˆ°postgresç”¨æˆ·
sudo -u postgres psql

# åˆ›å»ºæ•°æ®åº“ç”¨æˆ·
CREATE USER odoo WITH PASSWORD 'StrongPassword123!';

# åˆ›å»ºæ•°æ®åº“
CREATE DATABASE odoo OWNER odoo;

# é€€å‡º
\q
```

#### 2.2.3 å®‰è£…Odoo
```bash
# åˆ›å»ºodooç”¨æˆ·
sudo useradd -m -d /opt/odoo -U -r -s /bin/bash odoo

# åˆ‡æ¢åˆ°odooç”¨æˆ·
sudo su - odoo

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3.10 -m venv /opt/odoo/venv
source /opt/odoo/venv/bin/activate

# å®‰è£…Odoo
pip install --upgrade pip
pip install odoo==19.0

# å®‰è£…é¡¹ç›®ä¾èµ–
pip install requests cryptography xmltodict wechatpy python-alipay-sdk redis
```

#### 2.2.4 é…ç½®Odoo
```ini
# /etc/odoo/odoo.conf
[options]
admin_passwd = Admin@123456
db_host = localhost
db_port = 5432
db_user = odoo
db_password = StrongPassword123!
addons_path = /opt/odoo/addons,/opt/odoo/custom-addons
data_dir = /var/lib/odoo
logfile = /var/log/odoo/odoo.log
log_level = info
proxy_mode = True
without_demo = True
limit_time_cpu = 600
limit_time_real = 1200
workers = 4
max_cron_threads = 2
xmlrpc_port = 8069
longpolling_port = 8072
```

#### 2.2.5 é…ç½®ç³»ç»ŸæœåŠ¡
```systemd
# /etc/systemd/system/odoo.service
[Unit]
Description=Odoo 19
After=network.target postgresql.service

[Service]
Type=simple
User=odoo
Group=odoo
ExecStart=/opt/odoo/venv/bin/odoo --config /etc/odoo/odoo.conf
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
```

## 3. æ¨¡å—å®‰è£…

### 3.1 å®‰è£…è‡ªå®šä¹‰æ¨¡å—
```bash
# åˆ›å»ºæ¨¡å—ç›®å½•
sudo mkdir -p /opt/odoo/custom-addons
sudo chown -R odoo:odoo /opt/odoo/custom-addons

# å¤åˆ¶é¡¹ç›®æ¨¡å—
cp -r payment_wechat /opt/odoo/custom-addons/
cp -r payment_alipay /opt/odoo/custom-addons/
cp -r wechat_common /opt/odoo/custom-addons/
cp -r wechat_platform /opt/odoo/custom-addons/
cp -r wechat_miniprogram /opt/odoo/custom-addons/

# å®‰è£…æ¨¡å—
# é€šè¿‡Odooç½‘é¡µç•Œé¢æˆ–å‘½ä»¤è¡Œå®‰è£…
```

### 3.2 åˆå§‹åŒ–æ•°æ®åº“
```bash
# ä½¿ç”¨Odooå‘½ä»¤è¡Œåˆå§‹åŒ–
odoo --config /etc/odoo/odoo.conf -i payment_wechat,payment_alipay,wechat_common --stop-after-init

# æˆ–é€šè¿‡ç½‘é¡µå®‰è£…
# è®¿é—® http://your-server:8069
```

## 4. é…ç½®æ”¯ä»˜æ¸ é“

### 4.1 å¾®ä¿¡æ”¯ä»˜é…ç½®
1. ç™»å½•Odooåå°
2. è¿›å…¥ã€Œä¼šè®¡ã€â†’ã€Œé…ç½®ã€â†’ã€Œæ”¯ä»˜æä¾›å•†ã€
3. ç‚¹å‡»ã€Œæ–°å»ºã€
4. é€‰æ‹©ã€Œå¾®ä¿¡æ”¯ä»˜ã€
5. å¡«å†™å•†æˆ·ä¿¡æ¯ï¼š
   - å•†æˆ·å·(MCHID)
   - AppID
   - APIv3å¯†é’¥
   - ä¸Šä¼ å•†æˆ·è¯ä¹¦

### 4.2 æ”¯ä»˜å®é…ç½®
1. åŒæ ·ä½ç½®åˆ›å»ºæ”¯ä»˜å®æ”¯ä»˜æä¾›å•†
2. å¡«å†™æ”¯ä»˜å®å•†æˆ·ä¿¡æ¯ï¼š
   - AppID
   - åº”ç”¨ç§é’¥
   - æ”¯ä»˜å®å…¬é’¥

## 5. ç³»ç»Ÿé…ç½®

### 5.1 æ—¶åŒºé…ç½®
```python
# åœ¨Odooé…ç½®ä¸­è®¾ç½®æ—¶åŒº
[options]
timezone = Asia/Shanghai
```

### 5.2 é‚®ä»¶é…ç½®
```python
# é…ç½®SMTPæœåŠ¡å™¨
[options]
smtp_server = smtp.example.com
smtp_port = 465
smtp_ssl = True
smtp_user = noreply@example.com
smtp_password = EmailPass123
```

## 6. ç›‘æ§å’Œç»´æŠ¤

### 6.1 æ—¥å¿—ç›‘æ§
```bash
# æŸ¥çœ‹Odooæ—¥å¿—
tail -f /var/log/odoo/odoo.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
grep -i error /var/log/odoo/odoo.log

# æŸ¥çœ‹æ”¯ä»˜ç›¸å…³æ—¥å¿—
grep -i "wechat\|alipay" /var/log/odoo/odoo.log
```

### 6.2 æ€§èƒ½ç›‘æ§
```bash
# å®‰è£…ç›‘æ§å·¥å…·
sudo apt-get install -y htop iotop iftop

# ç›‘æ§æ•°æ®åº“è¿æ¥
sudo -u postgres psql -c "SELECT count(*) FROM pg_stat_activity;"

# ç›‘æ§Redis
redis-cli info memory
```

### 6.3 å¤‡ä»½ç­–ç•¥
```bash
# æ•°æ®åº“å¤‡ä»½è„šæœ¬
#!/bin/bash
BACKUP_DIR="/backup/odoo"
DATE=$(date +%Y%m%d_%H%M%S)

# å¤‡ä»½æ•°æ®åº“
pg_dump -U odoo odoo | gzip > "$BACKUP_DIR/odoo_db_$DATE.sql.gz"

# å¤‡ä»½æ–‡ä»¶å­˜å‚¨
tar -czf "$BACKUP_DIR/odoo_filestore_$DATE.tar.gz" /var/lib/odoo/filestore

# æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™30å¤©ï¼‰
find "$BACKUP_DIR" -name "*.gz" -mtime +30 -delete
```

## 7. æ•…éšœæ’é™¤

### 7.1 å¸¸è§é—®é¢˜

#### é—®é¢˜1: Odooæ— æ³•å¯åŠ¨
**å¯èƒ½åŸå› **: é…ç½®é”™è¯¯ã€ç«¯å£å ç”¨ã€æƒé™é—®é¢˜
**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥é…ç½®æ–‡ä»¶
odoo --config /etc/odoo/odoo.conf --test-enable

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep :8069

# æ£€æŸ¥æƒé™
ls -la /var/lib/odoo
```

#### é—®é¢˜2: æ”¯ä»˜å›è°ƒå¤±è´¥
**å¯èƒ½åŸå› **: ç½‘ç»œé—®é¢˜ã€ç­¾åé”™è¯¯ã€é‡å¤å›è°ƒ
**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦èƒ½è®¿é—®å¤–ç½‘
2. éªŒè¯å¾®ä¿¡/æ”¯ä»˜å®å›è°ƒç­¾å
3. æ£€æŸ¥å›è°ƒURLæ˜¯å¦æ­£ç¡®é…ç½®

#### é—®é¢˜3: æ•°æ®åº“æ€§èƒ½é—®é¢˜
**å¯èƒ½åŸå› **: ç´¢å¼•ç¼ºå¤±ã€æŸ¥è¯¢ä¼˜åŒ–ä¸è¶³
**è§£å†³æ–¹æ¡ˆ**:
```sql
-- åˆ†ææ…¢æŸ¥è¯¢
EXPLAIN ANALYZE SELECT * FROM payment_transaction WHERE state = 'done';

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_payment_transaction_state ON payment_transaction(state);
```

## 8. å‡çº§æŒ‡å—

### 8.1 æ¨¡å—å‡çº§
```bash
# å¤‡ä»½å½“å‰ç‰ˆæœ¬
cp -r /opt/odoo/custom-addons /opt/odoo/custom-addons_backup_$(date +%Y%m%d)

# æ›´æ–°ä»£ç 
cd /opt/odoo/custom-addons
git pull origin main

# æ›´æ–°æ•°æ®åº“
odoo --config /etc/odoo/odoo.conf -u payment_wechat,payment_alipay --stop-after-init
```

### 8.2 Odooç‰ˆæœ¬å‡çº§
1. æµ‹è¯•ç¯å¢ƒéªŒè¯æ–°ç‰ˆæœ¬å…¼å®¹æ€§
2. å¤‡ä»½æ‰€æœ‰æ•°æ®å’Œæ–‡ä»¶
3. æ›´æ–°Odooç‰ˆæœ¬
4. è¿è¡Œæ•°æ®åº“è¿ç§»
5. éªŒè¯åŠŸèƒ½æ­£å¸¸

## 9. å®‰å…¨é…ç½®

### 9.1 SSLè¯ä¹¦é…ç½®
```bash
# ä½¿ç”¨Let's Encryptè·å–å…è´¹è¯ä¹¦
sudo apt-get install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```

### 9.2 é˜²ç«å¢™é…ç½®
```bash
# é…ç½®UFWé˜²ç«å¢™
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

### 9.3 å®‰å…¨åŠ å›º
```bash
# ç¦ç”¨root SSHç™»å½•
sudo sed -i 's/PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config

# ä½¿ç”¨SSHå¯†é’¥ç™»å½•
sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config

# é‡å¯SSHæœåŠ¡
sudo systemctl restart sshd
```

## 10. é™„å½•

### 10.1 éƒ¨ç½²æ£€æŸ¥æ¸…å•
- [ ] æœåŠ¡å™¨èµ„æºæ£€æŸ¥
- [ ] ä¾èµ–è½¯ä»¶å®‰è£…
- [ ] æ•°æ®åº“é…ç½®
- [ ] Odooå®‰è£…é…ç½®
- [ ] æ¨¡å—å®‰è£…
- [ ] æ”¯ä»˜æ¸ é“é…ç½®
- [ ] SSLè¯ä¹¦é…ç½®
- [ ] é˜²ç«å¢™é…ç½®
- [ ] å¤‡ä»½ç­–ç•¥é…ç½®
- [ ] ç›‘æ§é…ç½®

### 10.2 å¸¸ç”¨å‘½ä»¤
```bash
# æœåŠ¡ç®¡ç†
sudo systemctl status odoo
sudo systemctl restart odoo
sudo systemctl stop odoo

# æ—¥å¿—æŸ¥çœ‹
journalctl -u odoo -f
tail -f /var/log/odoo/odoo.log

# æ•°æ®åº“ç®¡ç†
sudo -u postgres psql odoo
\dt payment_*  # æŸ¥çœ‹æ”¯ä»˜ç›¸å…³è¡¨

# ç¼“å­˜æ¸…ç†
redis-cli FLUSHALL
```

### 10.3 è”ç³»æ–¹å¼
- æŠ€æœ¯æ”¯æŒï¼šsupport@example.com
- ç´§æ€¥è”ç³»ç”µè¯ï¼š+86-XXX-XXXX-XXXX
- æ–‡æ¡£åœ°å€ï¼šhttps://docs.example.com

---

*æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.0*
*æœ€åæ›´æ–°ï¼š{å½“å‰æ—¥æœŸ}*
*ç»´æŠ¤å›¢é˜Ÿï¼šå¼€å‘å›¢é˜Ÿ*
"""

    def _get_security_template(self):
        """å®‰å…¨åˆè§„æ–‡æ¡£æ¨¡æ¿"""
        return """# å®‰å…¨åˆè§„æ–‡æ¡£

## 1. å®‰å…¨æ¶æ„

### 1.1 å®‰å…¨è®¾è®¡åŸåˆ™
- æœ€å°æƒé™åŸåˆ™
- çºµæ·±é˜²å¾¡ç­–ç•¥
- å®‰å…¨é»˜è®¤é…ç½®
- å…¨ç¨‹å®¡è®¡è¿½è¸ª

### 1.2 å®‰å…¨å±‚æ¬¡
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åº”ç”¨å®‰å…¨      â”‚ â† è¾“å…¥éªŒè¯ã€è¾“å‡ºç¼–ç ã€ä¼šè¯ç®¡ç†
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ•°æ®å®‰å…¨      â”‚ â† åŠ å¯†å­˜å‚¨ã€è®¿é—®æ§åˆ¶ã€æ•°æ®è„±æ•
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ç½‘ç»œå®‰å…¨      â”‚ â† é˜²ç«å¢™ã€WAFã€DDoSé˜²æŠ¤
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ä¸»æœºå®‰å…¨      â”‚ â† ç³»ç»ŸåŠ å›ºã€æ¼æ´ç®¡ç†
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ç‰©ç†å®‰å…¨      â”‚ â† æœºæˆ¿å®‰å…¨ã€è®¾å¤‡å®‰å…¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2. æ”¯ä»˜å®‰å…¨

### 2.1 æ”¯ä»˜æ•°æ®ä¿æŠ¤
#### æ•æ„Ÿæ•°æ®å®šä¹‰
- é“¶è¡Œå¡å·ã€æœ‰æ•ˆæœŸã€CVVç 
- æ”¯ä»˜å¯†ç ã€çŸ­ä¿¡éªŒè¯ç 
- å•†æˆ·å¯†é’¥ã€APIå¯†é’¥
- ç”¨æˆ·èº«ä»½è¯å·ã€æ‰‹æœºå·

#### æ•°æ®åŠ å¯†å­˜å‚¨
```python
# æ•æ„Ÿæ•°æ®åŠ å¯†ç¤ºä¾‹
from cryptography.fernet import Fernet

class DataEncryption:
    def __init__(self, key):
        self.cipher = Fernet(key)
    
    def encrypt(self, data):
        """åŠ å¯†æ•°æ®"""
        return self.cipher.encrypt(data.encode()).decode()
    
    def decrypt(self, encrypted_data):
        """è§£å¯†æ•°æ®"""
        return self.cipher.decrypt(encrypted_data.encode()).decode()
```

### 2.2 æ”¯ä»˜æµç¨‹å®‰å…¨
#### æ”¯ä»˜è¯·æ±‚éªŒè¯
1. å‚æ•°å®Œæ•´æ€§æ£€æŸ¥
2. é‡‘é¢èŒƒå›´éªŒè¯
3. è®¢å•å·å”¯ä¸€æ€§æ£€æŸ¥
4. ç­¾åéªŒè¯

#### é˜²é‡æ”¾æ”»å‡»
```python
class ReplayAttackProtection:
    def __init__(self, cache):
        self.cache = cache  # Redisç¼“å­˜
    
    def check_and_set_nonce(self, nonce, expire_time=300):
        """æ£€æŸ¥éšæœºæ•°æ˜¯å¦å·²ä½¿ç”¨"""
        key = f"nonce:{nonce}"
        if self.cache.exists(key):
            return False  # å·²ä½¿ç”¨ï¼Œæ‹’ç»è¯·æ±‚
        
        self.cache.set(key, "1", expire_time)
        return True
```

### 2.3 è¯ä¹¦ç®¡ç†
#### å¾®ä¿¡æ”¯ä»˜è¯ä¹¦
```python
class WechatCertificateManager:
    def __init__(self, cert_dir):
        self.cert_dir = cert_dir
    
    def download_certificate(self):
        """ä»å¾®ä¿¡æœåŠ¡å™¨ä¸‹è½½è¯ä¹¦"""
        # è‡ªåŠ¨ä¸‹è½½å’Œæ›´æ–°è¯ä¹¦
        pass
    
    def verify_signature(self, signature, data):
        """éªŒè¯å¾®ä¿¡å›è°ƒç­¾å"""
        # ä½¿ç”¨APIv3å¯†é’¥éªŒè¯ç­¾å
        pass
```

## 3. æ•°æ®å®‰å…¨

### 3.1 æ•°æ®åº“å®‰å…¨
#### æ•°æ®åº“åŠ å¯†
```sql
-- ä½¿ç”¨PostgreSQLåŠ å¯†æ‰©å±•
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- åŠ å¯†å­˜å‚¨æ•æ„Ÿæ•°æ®
INSERT INTO payment_provider (
    wechat_api_v3_key_encrypted,
    wechat_private_key_encrypted
) VALUES (
    pgp_sym_encrypt('API_KEY', 'ENCRYPTION_KEY'),
    pgp_sym_encrypt('PRIVATE_KEY', 'ENCRYPTION_KEY')
);
```

#### æ•°æ®è„±æ•
```python
def mask_sensitive_data(data):
    """æ•°æ®è„±æ•å¤„ç†"""
    if isinstance(data, dict):
        masked = data.copy()
        sensitive_fields = ['card_no', 'id_no', 'phone', 'email']
        
        for field in sensitive_fields:
            if field in masked:
                masked[field] = mask_string(masked[field])
        
        return masked
    return data

def mask_string(value, keep_chars=4):
    """å­—ç¬¦ä¸²è„±æ•"""
    if not value or len(value) <= keep_chars:
        return value
    
    return value[:keep_chars] + '*' * (len(value) - keep_chars)
```

### 3.2 æ•°æ®ä¼ è¾“å®‰å…¨
#### TLS/SSLé…ç½®
```nginx
# Nginx SSLé…ç½®
ssl_protocols TLSv1.2 TLSv1.3;
ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
ssl_prefer_server_ciphers on;
ssl_session_timeout 1d;
ssl_session_cache shared:SSL:50m;
ssl_session_tickets off;
```

#### HSTSé…ç½®
```nginx
# å¼ºåˆ¶HTTPS
add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
```

## 4. è®¿é—®æ§åˆ¶

### 4.1 èº«ä»½è®¤è¯
#### å¤šå› ç´ è®¤è¯(MFA)
```python
class MultiFactorAuth:
    def __init__(self, user):
        self.user = user
    
    def send_verification_code(self):
        """å‘é€éªŒè¯ç """
        code = generate_random_code()
        # å‘é€çŸ­ä¿¡æˆ–é‚®ä»¶
        send_sms(self.user.phone, f"éªŒè¯ç : {code}")
        return code
    
    def verify_code(self, input_code):
        """éªŒè¯éªŒè¯ç """
        return input_code == stored_code
```

#### ä¼šè¯ç®¡ç†
```python
class SecureSessionManager:
    def __init__(self):
        self.session_timeout = 1800  # 30åˆ†é’Ÿ
    
    def create_session(self, user_id):
        """åˆ›å»ºå®‰å…¨ä¼šè¯"""
        session_id = generate_session_id()
        session_data = {
            'user_id': user_id,
            'created_at': time.time(),
            'last_activity': time.time(),
            'ip_address': get_client_ip(),
            'user_agent': get_user_agent()
        }
        
        # å­˜å‚¨ä¼šè¯
        cache.set(f"session:{session_id}", session_data, self.session_timeout)
        return session_id
    
    def validate_session(self, session_id):
        """éªŒè¯ä¼šè¯"""
        session = cache.get(f"session:{session_id}")
        if not session:
            return False
        
        # æ£€æŸ¥ä¼šè¯è¶…æ—¶
        if time.time() - session['last_activity'] > self.session_timeout:
            cache.delete(f"session:{session_id}")
            return False
        
        # æ›´æ–°æœ€åæ´»åŠ¨æ—¶é—´
        session['last_activity'] = time.time()
        cache.set(f"session:{session_id}", session, self.session_timeout)
        
        return True
```

### 4.2 æƒé™ç®¡ç†
#### RBACæƒé™æ¨¡å‹
```python
class RBACPermission:
    ROLES = {
        'admin': ['payment.view', 'payment.create', 'payment.edit', 'payment.delete'],
        'manager': ['payment.view', 'payment.create', 'payment.edit'],
        'operator': ['payment.view'],
        'auditor': ['payment.view', 'audit.view']
    }
    
    def check_permission(self, user_role, permission):
        """æ£€æŸ¥æƒé™"""
        if user_role not in self.ROLES:
            return False
        
        return permission in self.ROLES[user_role]
```

## 5. åº”ç”¨å®‰å…¨

### 5.1 è¾“å…¥éªŒè¯
```python
class InputValidator:
    @staticmethod
    def validate_payment_amount(amount):
        """éªŒè¯æ”¯ä»˜é‡‘é¢"""
        try:
            amount = float(amount)
            if amount <= 0:
                return False, "é‡‘é¢å¿…é¡»å¤§äº0"
            if amount > 1000000:  # 100ä¸‡é™åˆ¶
                return False, "é‡‘é¢è¶…è¿‡é™åˆ¶"
            return True, amount
        except ValueError:
            return False, "é‡‘é¢æ ¼å¼é”™è¯¯"
    
    @staticmethod
    def sanitize_input(input_str):
        """æ¸…ç†è¾“å…¥ï¼Œé˜²æ­¢XSS"""
        import html
        return html.escape(input_str)
```

### 5.2 SQLæ³¨å…¥é˜²æŠ¤
```python
# Odoo ORMè‡ªåŠ¨é˜²æŠ¤SQLæ³¨å…¥
# å§‹ç»ˆä½¿ç”¨ORMæ–¹æ³•ï¼Œè€Œä¸æ˜¯ç›´æ¥SQL

# âŒ é”™è¯¯åšæ³•ï¼ˆæ˜“å—SQLæ³¨å…¥æ”»å‡»ï¼‰
self.env.cr.execute(f"SELECT * FROM payment_transaction WHERE reference = '{user_input}'")

# âœ… æ­£ç¡®åšæ³•ï¼ˆORMé˜²æŠ¤ï¼‰
transactions = self.env['payment.transaction'].search([
    ('reference', '=', user_input)
])
```

### 5.3 CSRFé˜²æŠ¤
```python
# Odooè‡ªåŠ¨å¤„ç†CSRFé˜²æŠ¤
# ç¡®ä¿æ‰€æœ‰POSTè¯·æ±‚åŒ…å«CSRF token

class WechatPaymentController(http.Controller):
    @http.route('/wechat/payment/create', type='json', auth='public', csrf=True)
    def create_payment(self, **kwargs):
        """åˆ›å»ºæ”¯ä»˜è®¢å•ï¼ˆè‡ªåŠ¨CSRFé˜²æŠ¤ï¼‰"""
        pass
```

## 6. æ—¥å¿—å’Œå®¡è®¡

### 6.1 å®‰å…¨æ—¥å¿—
#### æ—¥å¿—å†…å®¹
```python
class SecurityLogger:
    def log_sensitive_operation(self, operation, user, details):
        """è®°å½•æ•æ„Ÿæ“ä½œ"""
        log_entry = {
            'timestamp': datetime.now().isoformat(),
            'operation': operation,
            'user_id': user.id,
            'user_name': user.name,
            'ip_address': request.httprequest.remote_addr,
            'user_agent': request.httprequest.user_agent,
            'details': details,
            'risk_level': self._assess_risk(operation, details)
        }
        
        # å†™å…¥å®‰å…¨æ—¥å¿—
        self._write_security_log(log_entry)
        
        # é«˜é£é™©æ“ä½œå‘é€å‘Šè­¦
        if log_entry['risk_level'] == 'HIGH':
            self._send_alert(log_entry)
```

#### æ—¥å¿—å­˜å‚¨
```python
# å®‰å…¨æ—¥å¿—å•ç‹¬å­˜å‚¨ï¼Œä¸å¯ä¿®æ”¹
class ImmutableLogStorage:
    def __init__(self, log_file):
        self.log_file = log_file
    
    def write_log(self, entry):
        """å†™å…¥æ—¥å¿—ï¼ˆè¿½åŠ æ¨¡å¼ï¼Œä¸å¯ä¿®æ”¹ï¼‰"""
        with open(self.log_file, 'a') as f:
            f.write(json.dumps(entry) + '\n')
```

### 6.2 å®¡è®¡è¿½è¸ª
#### æ•°æ®å˜æ›´å®¡è®¡
```python
class DataChangeAudit:
    def audit_model_changes(self, model, record, changes, user):
        """å®¡è®¡æ¨¡å‹æ•°æ®å˜æ›´"""
        audit_log = {
            'model': model._name,
            'record_id': record.id,
            'changes': changes,
            'changed_by': user.id,
            'changed_at': datetime.now().isoformat(),
            'ip_address': request.httprequest.remote_addr
        }
        
        # å­˜å‚¨å®¡è®¡æ—¥å¿—
        self.env['audit.log'].create(audit_log)
```

## 7. åˆè§„è¦æ±‚

### 7.1 PCI DSSåˆè§„
#### è¦æ±‚æ¦‚è¿°
| è¦æ±‚ | å®æ–½æªæ–½ | éªŒè¯æ–¹æ³• |
|------|----------|----------|
| 3.2 ä¸å­˜å‚¨æ•æ„Ÿæ•°æ® | ä¸å­˜å‚¨å¡å·ã€CVVç­‰ | ä»£ç å®¡æŸ¥ã€æ•°æ®åº“å®¡è®¡ |
| 3.4 æ¸²æŸ“PANä¸å¯è¯» | æ•°æ®è„±æ•æ˜¾ç¤º | ç•Œé¢æµ‹è¯• |
| 4.1 åŠ å¯†ä¼ è¾“æ•°æ® | ä½¿ç”¨TLS 1.2+ | SSLæµ‹è¯• |
| 6.5 é˜²æ­¢å¸¸è§æ¼æ´ | å®‰å…¨ç¼–ç ã€æ¼æ´æ‰«æ | æ¸—é€æµ‹è¯• |
| 8.2 èº«ä»½éªŒè¯ | å¤šå› ç´ è®¤è¯ | è®¤è¯æµç¨‹æµ‹è¯• |
| 10.1 å®¡è®¡è¿½è¸ª | å®Œæ•´æ—¥å¿—è®°å½• | æ—¥å¿—å®¡è®¡ |

#### åˆè§„æ£€æŸ¥æ¸…å•
- [ ] ä¸å­˜å‚¨å®Œæ•´çš„æ”¯ä»˜å¡æ•°æ®
- [ ] ä½¿ç”¨å¼ºåŠ å¯†ç®—æ³•
- [ ] å®æ–½è®¿é—®æ§åˆ¶
- [ ] å®šæœŸå®‰å…¨æµ‹è¯•
- [ ] å®‰å…¨ç­–ç•¥å’Œæµç¨‹
- [ ] å‘˜å·¥å®‰å…¨åŸ¹è®­

### 7.2 ç­‰çº§ä¿æŠ¤è¦æ±‚
#### äºŒçº§ç­‰ä¿è¦æ±‚
1. èº«ä»½é‰´åˆ«
2. è®¿é—®æ§åˆ¶
3. å®‰å…¨å®¡è®¡
4. å…¥ä¾µé˜²èŒƒ
5. æ¶æ„ä»£ç é˜²èŒƒ
6. æ•°æ®å®Œæ•´æ€§
7. æ•°æ®ä¿å¯†æ€§
8. å¤‡ä»½æ¢å¤

## 8. å®‰å…¨æµ‹è¯•

### 8.1 æ¸—é€æµ‹è¯•
#### æµ‹è¯•èŒƒå›´
1. Webåº”ç”¨å®‰å…¨æµ‹è¯•
2. APIå®‰å…¨æµ‹è¯•
3. ç§»åŠ¨ç«¯å®‰å…¨æµ‹è¯•
4. ç½‘ç»œæ¸—é€æµ‹è¯•
5. ç¤¾ä¼šå·¥ç¨‹å­¦æµ‹è¯•

#### æµ‹è¯•å·¥å…·
- Burp Suite
- OWASP ZAP
- Nmap
- Metasploit
- SQLmap

### 8.2 ä»£ç å®‰å…¨æ‰«æ
```bash
# ä½¿ç”¨Banditè¿›è¡ŒPythonä»£ç å®‰å…¨æ‰«æ
bandit -r . -f json -o bandit-report.json

# ä½¿ç”¨Safetyæ£€æŸ¥ä¾èµ–æ¼æ´
safety check --json > safety-report.json

# ä½¿ç”¨TruffleHogæ‰«æå¯†é’¥æ³„éœ²
trufflehog --regex --entropy=False --max_depth 50 .
```

### 8.3 æ¼æ´ç®¡ç†æµç¨‹
```
å‘ç°æ¼æ´ â†’ è¯„ä¼°é£é™© â†’ åˆ¶å®šä¿®å¤è®¡åˆ’ â†’ ä¿®å¤æ¼æ´ â†’ éªŒè¯ä¿®å¤ â†’ æ–‡æ¡£è®°å½•
```

## 9. åº”æ€¥å“åº”

### 9.1 å®‰å…¨äº‹ä»¶åˆ†ç±»
| çº§åˆ« | æè¿° | å“åº”æ—¶é—´ |
|------|------|----------|
| ç´§æ€¥ | æ•°æ®æ³„éœ²ã€æ”¯ä»˜æ¬ºè¯ˆ | ç«‹å³å“åº” |
| é«˜ | ç³»ç»Ÿå…¥ä¾µã€æ¶æ„è½¯ä»¶ | 2å°æ—¶å†… |
| ä¸­ | æœªæˆæƒè®¿é—®ã€é…ç½®é”™è¯¯ | 24å°æ—¶å†… |
| ä½ | å®‰å…¨è­¦å‘Šã€å¼‚å¸¸æ—¥å¿— | 7å¤©å†… |

### 9.2 åº”æ€¥å“åº”æµç¨‹
```python
class SecurityIncidentResponse:
    def handle_incident(self, incident):
        """å¤„ç†å®‰å…¨äº‹ä»¶"""
        # 1. ç¡®è®¤äº‹ä»¶
        if self._confirm_incident(incident):
            # 2. éš”ç¦»å½±å“
            self._contain_incident(incident)
            
            # 3. æ”¶é›†è¯æ®
            evidence = self._collect_evidence(incident)
            
            # 4. ä¿®å¤é—®é¢˜
            self._remediate_incident(incident)
            
            # 5. æ¢å¤æœåŠ¡
            self._recover_service(incident)
            
            # 6. äº‹ååˆ†æ
            self._post_incident_analysis(incident, evidence)
```

## 10. å®‰å…¨åŸ¹è®­

### 10.1 å¼€å‘äººå‘˜åŸ¹è®­
#### å®‰å…¨ç¼–ç è§„èŒƒ
1. è¾“å…¥éªŒè¯å’Œè¾“å‡ºç¼–ç 
2. è®¤è¯å’Œä¼šè¯ç®¡ç†
3. è®¿é—®æ§åˆ¶
4. åŠ å¯†æŠ€æœ¯
5. é”™è¯¯å¤„ç†
6. æ—¥å¿—è®°å½•

### 10.2 è¿ç»´äººå‘˜åŸ¹è®­
1. å®‰å…¨é…ç½®ç®¡ç†
2. æ¼æ´ç®¡ç†
3. åº”æ€¥å“åº”
4. å¤‡ä»½æ¢å¤

## 11. é™„å½•

### 11.1 å®‰å…¨å·¥å…·æ¸…å•
| å·¥å…· | ç”¨é€” | é“¾æ¥ |
|------|------|------|
| OWASP ZAP | Webåº”ç”¨æ‰«æ | https://www.zaproxy.org |
| Burp Suite | æ¸—é€æµ‹è¯• | https://portswigger.net |
| Nmap | ç«¯å£æ‰«æ | https://nmap.org |
| Wireshark | ç½‘ç»œåˆ†æ | https://www.wireshark.org |
| Metasploit | æ¼æ´åˆ©ç”¨ | https://www.metasploit.com |

### 11.2 å®‰å…¨èµ„æº
- OWASP Top 10: https://owasp.org/Top10/
- PCI DSSæ ‡å‡†: https://www.pcisecuritystandards.org
- ç½‘ç»œå®‰å…¨æ³•: ç›¸å…³æ³•å¾‹æ³•è§„

### 11.3 è”ç³»ä¿¡æ¯
- å®‰å…¨å›¢é˜Ÿ: security@example.com
- ç´§æ€¥è”ç³»ç”µè¯: +86-XXX-XXXX-XXXX
- æ¼æ´æŠ¥å‘Š: security@example.com

---

*æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.0*
*æœ€åæ›´æ–°ï¼š{å½“å‰æ—¥æœŸ}*
*ç»´æŠ¤å›¢é˜Ÿï¼šå®‰å…¨å›¢é˜Ÿ*
"""

    def _get_admin_template(self):
        """ç³»ç»Ÿç®¡ç†å‘˜æ‰‹å†Œæ¨¡æ¿"""
        return """# ç³»ç»Ÿç®¡ç†å‘˜æ‰‹å†Œ

## 1. ç³»ç»Ÿæ¦‚è¿°

### 1.1 ç³»ç»Ÿç®€ä»‹
Odoo 19å¾®ä¿¡æ”¯ä»˜ä¸ç”Ÿæ€ç³»ç»Ÿé›†æˆç³»ç»Ÿæ˜¯ä¸€ä¸ªé›†æˆäº†å¾®ä¿¡æ”¯ä»˜ã€æ”¯ä»˜å®æ”¯ä»˜ã€äº‘é—ªä»˜æ”¯ä»˜ã€å¾®ä¿¡å…¬ä¼—å·ç®¡ç†å’Œå°ç¨‹åºåç«¯çš„ä¼ä¸šçº§è§£å†³æ–¹æ¡ˆã€‚

### 1.2 ç³»ç»ŸåŠŸèƒ½
- **æ”¯ä»˜ç®¡ç†**: å¾®ä¿¡æ”¯ä»˜ã€æ”¯ä»˜å®æ”¯ä»˜ã€äº‘é—ªä»˜æ”¯ä»˜
- **å…¬ä¼—å·ç®¡ç†**: ç²‰ä¸ç®¡ç†ã€æ¶ˆæ¯å›å¤ã€èœå•ç®¡ç†
- **å°ç¨‹åºåç«¯**: å•†å“å±•ç¤ºã€è®¢å•ç®¡ç†ã€æ”¯ä»˜é›†æˆ
- **POSæ”¯ä»˜**: é—¨åº—æ”¶é“¶ç³»ç»Ÿé›†æˆ
- **æŠ¥è¡¨åˆ†æ**: æ”¯ä»˜ç»Ÿè®¡ã€ç”¨æˆ·åˆ†æã€ä¸šåŠ¡æŠ¥è¡¨

## 2. ç³»ç»Ÿå®‰è£…

### 2.1 ç¯å¢ƒè¦æ±‚
- æ“ä½œç³»ç»Ÿ: Ubuntu 20.04+/CentOS 8+
- æ•°æ®åº“: PostgreSQL 14+
- Python: 3.10+
- å†…å­˜: 8GB+ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®16GB+ï¼‰
- å­˜å‚¨: 100GB+ï¼ˆæ ¹æ®ä¸šåŠ¡é‡è°ƒæ•´ï¼‰

### 2.2 å®‰è£…æ­¥éª¤
è¯¦ç»†å®‰è£…æ­¥éª¤è§ã€Šéƒ¨ç½²è¿ç»´æ‰‹å†Œã€‹ã€‚

## 3. ç³»ç»Ÿé…ç½®

### 3.1 åˆå§‹é…ç½®

#### 3.1.1 è®¿é—®ç³»ç»Ÿ
1. æ‰“å¼€æµè§ˆå™¨è®¿é—®: `http://your-server:8069`
2. é¦–æ¬¡è®¿é—®ä¼šæ˜¾ç¤ºæ•°æ®åº“åˆ›å»ºé¡µé¢
3. å¡«å†™æ•°æ®åº“ä¿¡æ¯å’Œç®¡ç†å‘˜å¯†ç 

#### 3.1.2 å…¬å¸ä¿¡æ¯é…ç½®
1. ç™»å½•ç³»ç»Ÿåï¼Œè¿›å…¥ã€Œè®¾ç½®ã€â†’ã€Œå…¬å¸ã€
2. å¡«å†™å…¬å¸åŸºæœ¬ä¿¡æ¯ï¼š
   - å…¬å¸åç§°
   - åœ°å€
   - è”ç³»ç”µè¯
   - é‚®ç®±
   - å¢å€¼ç¨å·
3. ä¸Šä¼ å…¬å¸Logo

### 3.2 æ”¯ä»˜é…ç½®

#### 3.2.1 é…ç½®å¾®ä¿¡æ”¯ä»˜
1. è¿›å…¥ã€Œä¼šè®¡ã€â†’ã€Œé…ç½®ã€â†’ã€Œæ”¯ä»˜æä¾›å•†ã€
2. ç‚¹å‡»ã€Œæ–°å»ºã€
3. é€‰æ‹©ã€Œå¾®ä¿¡æ”¯ä»˜ã€
4. å¡«å†™é…ç½®ä¿¡æ¯ï¼š
   ```
   åç§°: å¾®ä¿¡æ”¯ä»˜
   å•†æˆ·å·(MCHID): å¾®ä¿¡å•†æˆ·å¹³å°è·å–
   AppID: å…¬ä¼—å·æˆ–å°ç¨‹åºAppID
   APIv3å¯†é’¥: å¾®ä¿¡å•†æˆ·å¹³å°è®¾ç½®
   å•†æˆ·è¯ä¹¦: ä»å¾®ä¿¡å•†æˆ·å¹³å°ä¸‹è½½
   ```

5. é…ç½®æ”¯ä»˜æ–¹å¼ï¼š
   - æ‰«ç æ”¯ä»˜
   - JSAPIæ”¯ä»˜ï¼ˆå¾®ä¿¡å†…æ”¯ä»˜ï¼‰
   - å°ç¨‹åºæ”¯ä»˜

#### 3.2.2 é…ç½®æ”¯ä»˜å®æ”¯ä»˜
1. åŒæ ·ä½ç½®åˆ›å»ºæ”¯ä»˜å®æ”¯ä»˜æä¾›å•†
2. å¡«å†™é…ç½®ä¿¡æ¯ï¼š
   ```
   åç§°: æ”¯ä»˜å®
   AppID: æ”¯ä»˜å®å¼€æ”¾å¹³å°è·å–
   åº”ç”¨ç§é’¥: ç”Ÿæˆçš„RSAç§é’¥
   æ”¯ä»˜å®å…¬é’¥: æ”¯ä»˜å®å¼€æ”¾å¹³å°è·å–
   ```

### 3.3 å¾®ä¿¡å…¬ä¼—å·é…ç½®

#### 3.3.1 æ·»åŠ å…¬ä¼—å·
1. è¿›å…¥ã€Œå¾®ä¿¡ã€â†’ã€Œå…¬ä¼—å·ã€â†’ã€Œå…¬ä¼—å·ç®¡ç†ã€
2. ç‚¹å‡»ã€Œæ–°å»ºã€
3. å¡«å†™å…¬ä¼—å·ä¿¡æ¯ï¼š
   ```
   å…¬ä¼—å·åç§°: æ‚¨çš„å…¬ä¼—å·åç§°
   AppID: å…¬ä¼—å·AppID
   AppSecret: å…¬ä¼—å·AppSecret
   è´¦å·ç±»å‹: æœåŠ¡å·/è®¢é˜…å·
   ```

4. é…ç½®æœåŠ¡å™¨ï¼š
   - ä»¤ç‰Œ(Token): éšæœºç”Ÿæˆçš„å­—ç¬¦ä¸²
   - æ¶ˆæ¯åŠ è§£å¯†å¯†é’¥: éšæœºç”Ÿæˆçš„43ä½å­—ç¬¦ä¸²
   - æœåŠ¡å™¨åœ°å€: ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ

5. åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°é…ç½®ç›¸åŒçš„æœåŠ¡å™¨ä¿¡æ¯

#### 3.3.2 é…ç½®è‡ªåŠ¨å›å¤
1. è¿›å…¥ã€Œå¾®ä¿¡ã€â†’ã€Œå…¬ä¼—å·ã€â†’ã€Œè‡ªåŠ¨å›å¤ã€
2. æ·»åŠ å›å¤è§„åˆ™ï¼š
   - å…³é”®è¯: ç”¨æˆ·å‘é€çš„å…³é”®è¯
   - å›å¤ç±»å‹: æ–‡æœ¬/å›¾ç‰‡/å›¾æ–‡
   - å›å¤å†…å®¹: å¯¹åº”çš„å›å¤å†…å®¹
3. è®¾ç½®é»˜è®¤å›å¤ï¼ˆæ— åŒ¹é…å…³é”®è¯æ—¶ï¼‰

### 3.4 å°ç¨‹åºé…ç½®

#### 3.4.1 é…ç½®å°ç¨‹åºåç«¯
1. è¿›å…¥ã€Œå¾®ä¿¡ã€â†’ã€Œå°ç¨‹åºã€â†’ã€Œå°ç¨‹åºé…ç½®ã€
2. å¡«å†™å°ç¨‹åºä¿¡æ¯ï¼š
   ```
   å°ç¨‹åºåç§°: æ‚¨çš„å°ç¨‹åºåç§°
   AppID: å°ç¨‹åºAppID
   AppSecret: å°ç¨‹åºAppSecret
   ```

3. é…ç½®APIåŸŸåï¼š
   - å°†å°ç¨‹åºåå°çš„requeståŸŸåé…ç½®ä¸ºç³»ç»Ÿåœ°å€
   - é…ç½®uploadFileå’ŒdownloadFileåŸŸå

#### 3.4.2 é…ç½®å•†å“åŒæ­¥
1. è¿›å…¥ã€Œå¾®ä¿¡ã€â†’ã€Œå°ç¨‹åºã€â†’ã€Œå•†å“ç®¡ç†ã€
2. é…ç½®åŒæ­¥è§„åˆ™ï¼š
   - é€‰æ‹©è¦åŒæ­¥çš„äº§å“åˆ†ç±»
   - è®¾ç½®åŒæ­¥æ—¶é—´é—´éš”
   - é…ç½®ä»·æ ¼æ˜¾ç¤ºè§„åˆ™

## 4. ç”¨æˆ·ç®¡ç†

### 4.1 åˆ›å»ºç”¨æˆ·è´¦æˆ·

#### 4.1.1 ç®¡ç†å‘˜è´¦æˆ·
1. è¿›å…¥ã€Œè®¾ç½®ã€â†’ã€Œç”¨æˆ·ã€â†’ã€Œç”¨æˆ·ã€
2. ç‚¹å‡»ã€Œæ–°å»ºã€
3. å¡«å†™ç”¨æˆ·ä¿¡æ¯ï¼š
   ```
   å§“å: ç®¡ç†å‘˜å§“å
   é‚®ç®±: ç”¨æˆ·é‚®ç®±ï¼ˆç”¨äºç™»å½•ï¼‰
   å¯†ç : è®¾ç½®ç™»å½•å¯†ç 
   ```

4. åˆ†é…æƒé™ï¼š
   - ç”¨æˆ·ç±»å‹: å†…éƒ¨ç”¨æˆ·
   - è®¿é—®æƒé™: å…¨ç³»ç»Ÿæƒé™
   - åº”ç”¨æƒé™: æ‰€æœ‰åº”ç”¨

#### 4.1.2 æ”¶é“¶å‘˜è´¦æˆ·
1. åŒæ ·ä½ç½®åˆ›å»ºç”¨æˆ·
2. åˆ†é…æƒé™ï¼š
   ```
   ç”¨æˆ·ç±»å‹: å†…éƒ¨ç”¨æˆ·
   è®¿é—®æƒé™: POSæ¨¡å—
   åº”ç”¨æƒé™: POSã€æ”¯ä»˜
   ```

#### 4.1.3 å®¢æœè´¦æˆ·
1. åˆ›å»ºå®¢æœç”¨æˆ·
2. åˆ†é…æƒé™ï¼š
   ```
   ç”¨æˆ·ç±»å‹: å†…éƒ¨ç”¨æˆ·
   è®¿é—®æƒé™: å¾®ä¿¡ã€CRM
   åº”ç”¨æƒé™: å…¬ä¼—å·ç®¡ç†ã€å®¢æˆ·å…³ç³»
   ```

### 4.2 æƒé™ç»„ç®¡ç†

#### 4.2.1 é¢„å®šä¹‰æƒé™ç»„
- **æ”¯ä»˜ç®¡ç†å‘˜**: æ”¯ä»˜é…ç½®ã€äº¤æ˜“ç®¡ç†ã€é€€æ¬¾å¤„ç†
- **å…¬ä¼—å·ç®¡ç†å‘˜**: å…¬ä¼—å·é…ç½®ã€ç²‰ä¸ç®¡ç†ã€æ¶ˆæ¯å›å¤
- **POSæ“ä½œå‘˜**: POSé”€å”®ã€æ”¶é“¶ã€é€€æ¬¾
- **æŠ¥è¡¨æŸ¥çœ‹å‘˜**: æŸ¥çœ‹å„ç±»æŠ¥è¡¨ï¼Œæ— ä¿®æ”¹æƒé™

#### 4.2.2 è‡ªå®šä¹‰æƒé™ç»„
1. è¿›å…¥ã€Œè®¾ç½®ã€â†’ã€Œç”¨æˆ·ã€â†’ã€Œç»„ã€
2. ç‚¹å‡»ã€Œæ–°å»ºã€
3. è®¾ç½®ç»„åç§°å’Œæè¿°
4. é€‰æ‹©åº”ç”¨æƒé™
5. é…ç½®è¯¦ç»†æƒé™ï¼ˆæŸ¥çœ‹ã€åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤ï¼‰

## 5. æ•°æ®ç®¡ç†

### 5.1 æ•°æ®å¤‡ä»½

#### 5.1.1 è‡ªåŠ¨å¤‡ä»½é…ç½®
1. è¿›å…¥ã€Œè®¾ç½®ã€â†’ã€ŒæŠ€æœ¯ã€â†’ã€Œè®¡åˆ’åŠ¨ä½œã€
2. æ‰¾åˆ°ã€Œæ•°æ®åº“å¤‡ä»½ã€åŠ¨ä½œ
3. é…ç½®å¤‡ä»½å‚æ•°ï¼š
   ```
   å¤‡ä»½é¢‘ç‡: æ¯å¤©
   å¤‡ä»½æ—¶é—´: 02:00
   ä¿ç•™å¤©æ•°: 30
   å¤‡ä»½è·¯å¾„: /backup/odoo
   ```

4. å¯ç”¨å¤‡ä»½åŠ¨ä½œ

#### 5.1.2 æ‰‹åŠ¨å¤‡ä»½
1. è¿›å…¥ã€Œè®¾ç½®ã€â†’ã€Œæ•°æ®åº“ã€â†’ã€Œå¤‡ä»½ã€
2. ç‚¹å‡»ã€Œå¤‡ä»½æ•°æ®åº“ã€
3. é€‰æ‹©å¤‡ä»½æ ¼å¼ï¼šzipæˆ–dump
4. ç‚¹å‡»ã€Œå¤‡ä»½ã€å¼€å§‹å¤‡ä»½

### 5.2 æ•°æ®æ¢å¤

#### 5.2.1 ä»å¤‡ä»½æ¢å¤
1. åœæ­¢OdooæœåŠ¡
   ```bash
   sudo systemctl stop odoo
   ```

2. æ¢å¤æ•°æ®åº“
   ```bash
   # ä½¿ç”¨pg_restoreæ¢å¤
   pg_restore -U odoo -d odoo_new /backup/odoo/backup_file.dump
   ```

3. æ¢å¤æ–‡ä»¶å­˜å‚¨
   ```bash
   tar -xzf /backup/odoo/filestore_backup.tar.gz -C /var/lib/odoo/
   ```

4. å¯åŠ¨OdooæœåŠ¡
   ```bash
   sudo systemctl start odoo
   ```

### 5.3 æ•°æ®æ¸…ç†

#### 5.3.1 æ¸…ç†æ—¥å¿—æ•°æ®
1. è¿›å…¥ã€Œè®¾ç½®ã€â†’ã€ŒæŠ€æœ¯ã€â†’ã€Œæ•°æ®åº“ç»“æ„ã€â†’ã€Œæ¸…ç†æ•°æ®ã€
2. é€‰æ‹©è¦æ¸…ç†çš„æ¨¡å‹ï¼š
   - ç³»ç»Ÿæ—¥å¿—
   - é‚®ä»¶æ¶ˆæ¯
   - ä¼šè¯è®°å½•
3. è®¾ç½®ä¿ç•™æ—¶é—´ï¼ˆå¦‚ï¼šä¿ç•™30å¤©ï¼‰
4. æ‰§è¡Œæ¸…ç†

#### 5.3.2 å½’æ¡£å†å²æ•°æ®
1. è¿›å…¥ã€Œä¼šè®¡ã€â†’ã€Œé…ç½®ã€â†’ã€Œä¼šè®¡æœŸé—´ã€
2. åˆ›å»ºæ–°çš„ä¼šè®¡æœŸé—´
3. å…³é—­æ—§æœŸé—´
4. æ•°æ®è‡ªåŠ¨å½’æ¡£

## 6. ç³»ç»Ÿç›‘æ§

### 6.1 æ€§èƒ½ç›‘æ§

#### 6.1.1 æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€
1. è¿›å…¥ã€Œè®¾ç½®ã€â†’ã€ŒæŠ€æœ¯ã€â†’ã€Œç›‘æ§ã€â†’ã€Œç³»ç»ŸçŠ¶æ€ã€
2. æŸ¥çœ‹å…³é”®æŒ‡æ ‡ï¼š
   - CPUä½¿ç”¨ç‡
   - å†…å­˜ä½¿ç”¨ç‡
   - ç£ç›˜ç©ºé—´
   - æ•°æ®åº“è¿æ¥æ•°
   - æ´»è·ƒä¼šè¯æ•°

#### 6.1.2 æŸ¥çœ‹é˜Ÿåˆ—çŠ¶æ€
1. è¿›å…¥ã€Œè®¾ç½®ã€â†’ã€ŒæŠ€æœ¯ã€â†’ã€Œç›‘æ§ã€â†’ã€Œä½œä¸šé˜Ÿåˆ—ã€
2. æŸ¥çœ‹å¼‚æ­¥ä»»åŠ¡ï¼š
   - å¾…å¤„ç†ä»»åŠ¡
   - æ‰§è¡Œä¸­ä»»åŠ¡
   - å¤±è´¥ä»»åŠ¡
3. å¯é‡æ–°æ‰§è¡Œå¤±è´¥ä»»åŠ¡

### 6.2 æ—¥å¿—æŸ¥çœ‹

#### 6.2.1 ç³»ç»Ÿæ—¥å¿—
1. è¿›å…¥ã€Œè®¾ç½®ã€â†’ã€ŒæŠ€æœ¯ã€â†’ã€Œæ—¥å¿—ã€â†’ã€ŒæœåŠ¡å™¨æ—¥å¿—ã€
2. æŸ¥çœ‹æ—¥å¿—çº§åˆ«ï¼š
   - DEBUG: è°ƒè¯•ä¿¡æ¯
   - INFO: ä¸€èˆ¬ä¿¡æ¯
   - WARNING: è­¦å‘Šä¿¡æ¯
   - ERROR: é”™è¯¯ä¿¡æ¯
   - CRITICAL: ä¸¥é‡é”™è¯¯

#### 6.2.2 æ”¯ä»˜æ—¥å¿—
1. è¿›å…¥ã€Œä¼šè®¡ã€â†’ã€Œæ”¯ä»˜ã€â†’ã€Œæ”¯ä»˜æ—¥å¿—ã€
2. æŸ¥çœ‹æ”¯ä»˜ç›¸å…³æ—¥å¿—ï¼š
   - æ”¯ä»˜è¯·æ±‚
   - æ”¯ä»˜å›è°ƒ
   - é€€æ¬¾è®°å½•
   - å¼‚å¸¸äº¤æ˜“

## 7. æ•…éšœå¤„ç†

### 7.1 å¸¸è§é—®é¢˜è§£å†³

#### é—®é¢˜1: æ— æ³•è®¿é—®ç³»ç»Ÿ
**å¯èƒ½åŸå› **:
1. æœåŠ¡æœªå¯åŠ¨
2. ç«¯å£è¢«å ç”¨
3. é˜²ç«å¢™é˜»æ­¢

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status odoo

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep :8069

# æ£€æŸ¥é˜²ç«å¢™
sudo ufw status
```

#### é—®é¢˜2: æ”¯ä»˜å›è°ƒå¤±è´¥
**å¯èƒ½åŸå› **:
1. ç½‘ç»œé—®é¢˜
2. ç­¾åé”™è¯¯
3. é‡å¤å›è°ƒ

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥æœåŠ¡å™¨ç½‘ç»œè¿æ¥
2. éªŒè¯å¾®ä¿¡/æ”¯ä»˜å®å›è°ƒé…ç½®
3. æŸ¥çœ‹æ”¯ä»˜å›è°ƒæ—¥å¿—

#### é—®é¢˜3: æ•°æ®åº“æ€§èƒ½é—®é¢˜
**å¯èƒ½åŸå› **:
1. ç¼ºå°‘ç´¢å¼•
2. æŸ¥è¯¢è¯­å¥æ•ˆç‡ä½
3. è¿æ¥æ•°è¿‡å¤š

**è§£å†³æ–¹æ¡ˆ**:
```sql
-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT query, calls, total_time, rows
FROM pg_stat_statements
ORDER BY total_time DESC
LIMIT 10;

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_payment_transaction_state ON payment_transaction(state);
```

### 7.2 ç´§æ€¥æ¢å¤

#### 7.2.1 æœåŠ¡é‡å¯
```bash
# é‡å¯æ‰€æœ‰æœåŠ¡
sudo systemctl restart odoo
sudo systemctl restart postgresql
sudo systemctl restart nginx
```

#### 7.2.2 æ•°æ®åº“ä¿®å¤
```bash
# ä¿®å¤æ•°æ®åº“
sudo -u postgres psql -c "REINDEX DATABASE odoo;"

# æ¸…ç†æ•°æ®åº“ç¼“å­˜
sudo -u postgres psql -c "SELECT pg_stat_reset();"
```

## 8. ç³»ç»Ÿç»´æŠ¤

### 8.1 å®šæœŸç»´æŠ¤ä»»åŠ¡

#### æ¯æ—¥ä»»åŠ¡
1. æ£€æŸ¥å¤‡ä»½æ˜¯å¦æˆåŠŸ
2. æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯
3. ç›‘æ§æ”¯ä»˜æˆåŠŸç‡
4. æ£€æŸ¥ç£ç›˜ç©ºé—´

#### æ¯å‘¨ä»»åŠ¡
1. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
2. æ›´æ–°ç³»ç»Ÿè¡¥ä¸
3. æ£€æŸ¥å®‰å…¨æ—¥å¿—
4. åˆ†ææ€§èƒ½æŠ¥å‘Š

#### æ¯æœˆä»»åŠ¡
1. æ•°æ®å½’æ¡£
2. å®‰å…¨å®¡è®¡
3. æ€§èƒ½ä¼˜åŒ–
4. æ›´æ–°è¯ä¹¦

### 8.2 æ€§èƒ½ä¼˜åŒ–

#### 8.2.1 æ•°æ®åº“ä¼˜åŒ–
```sql
-- æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE;

-- æ¸…ç†è¿‡æœŸæ•°æ®
VACUUM ANALYZE payment_transaction;

-- é‡å»ºç´¢å¼•
REINDEX TABLE payment_transaction;
```

#### 8.2.2 åº”ç”¨ä¼˜åŒ–
1. è°ƒæ•´Odooé…ç½®
   ```ini
   workers = 4  # æ ¹æ®CPUæ ¸å¿ƒæ•°è°ƒæ•´
   max_cron_threads = 2  # å®šæ—¶ä»»åŠ¡çº¿ç¨‹æ•°
   limit_memory_hard = 2684354560  # 2.5GBå†…å­˜é™åˆ¶
   ```

2. å¯ç”¨ç¼“å­˜
   ```ini
   # é…ç½®Redisç¼“å­˜
   cache_redis = True
   redis_host = localhost
   redis_port = 6379
   redis_password = your_password
   ```

## 9. å®‰å…¨ç®¡ç†

### 9.1 å®‰å…¨é…ç½®

#### 9.1.1 å¯†ç ç­–ç•¥
1. è¿›å…¥ã€Œè®¾ç½®ã€â†’ã€Œé€šç”¨è®¾ç½®ã€â†’ã€Œå®‰å…¨ã€
2. é…ç½®å¯†ç ç­–ç•¥ï¼š
   - æœ€å°é•¿åº¦: 8ä½
   - å¤æ‚åº¦è¦æ±‚: åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦
   - è¿‡æœŸæ—¶é—´: 90å¤©
   - å†å²å¯†ç : ä¸å¯é‡å¤æœ€è¿‘5æ¬¡å¯†ç 

#### 9.1.2 è®¿é—®æ§åˆ¶
1. é…ç½®IPç™½åå•
   ```ini
   # odoo.conf
   proxy_mode = True
   proxy_allow_ips = 192.168.1.*,10.0.0.*
   ```

2. é™åˆ¶ç®¡ç†ç•Œé¢è®¿é—®
   ```ini
   # åªå…è®¸ç‰¹å®šIPè®¿é—®ç®¡ç†ç•Œé¢
   admin_restrict_ips = 192.168.1.100,10.0.0.50
   ```

### 9.2 å®‰å…¨å®¡è®¡

#### 9.2.1 å®¡è®¡æ—¥å¿—æŸ¥çœ‹
1. è¿›å…¥ã€Œè®¾ç½®ã€â†’ã€ŒæŠ€æœ¯ã€â†’ã€Œå®¡è®¡æ—¥å¿—ã€
2. æŸ¥çœ‹ç”¨æˆ·æ“ä½œè®°å½•ï¼š
   - ç™»å½•/ç™»å‡º
   - æ•°æ®åˆ›å»º/ä¿®æ”¹/åˆ é™¤
   - æƒé™å˜æ›´
   - é…ç½®ä¿®æ”¹

#### 9.2.2 å®‰å…¨æŠ¥å‘Š
1. ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
   - ç”¨æˆ·æ´»åŠ¨æŠ¥å‘Š
   - å¼‚å¸¸è®¿é—®æŠ¥å‘Š
   - æ”¯ä»˜å¼‚å¸¸æŠ¥å‘Š
   - ç³»ç»Ÿå®‰å…¨çŠ¶æ€æŠ¥å‘Š

## 10. å‡çº§ç®¡ç†

### 10.1 æ¨¡å—å‡çº§

#### 10.1.1 æ£€æŸ¥æ›´æ–°
1. è¿›å…¥ã€Œåº”ç”¨ã€â†’ã€Œæ›´æ–°åº”ç”¨åˆ—è¡¨ã€
2. æŸ¥çœ‹å¯æ›´æ–°çš„æ¨¡å—
3. æŸ¥çœ‹æ›´æ–°æ—¥å¿—

#### 10.1.2 æ‰§è¡Œå‡çº§
1. å¤‡ä»½å½“å‰ç³»ç»Ÿ
2. é€‰æ‹©è¦æ›´æ–°çš„æ¨¡å—
3. ç‚¹å‡»ã€Œæ›´æ–°ã€
4. éªŒè¯æ›´æ–°åçš„åŠŸèƒ½

### 10.2 ç³»ç»Ÿå‡çº§

#### 10.2.1 å‡çº§å‡†å¤‡
1. æ£€æŸ¥å…¼å®¹æ€§
2. å¤‡ä»½æ‰€æœ‰æ•°æ®
3. é€šçŸ¥ç”¨æˆ·ç»´æŠ¤æ—¶é—´

#### 10.2.2 å‡çº§æ­¥éª¤
1. åœæ­¢æœåŠ¡
2. æ›´æ–°Odooç‰ˆæœ¬
3. æ‰§è¡Œæ•°æ®åº“è¿ç§»
4. å¯åŠ¨æœåŠ¡
5. éªŒè¯åŠŸèƒ½

## 11. é™„å½•

### 11.1 å¸¸ç”¨å‘½ä»¤
```bash
# æœåŠ¡ç®¡ç†
sudo systemctl status odoo
sudo systemctl restart odoo
sudo journalctl -u odoo -f

# æ•°æ®åº“ç®¡ç†
sudo -u postgres psql odoo
\dt payment_*  # æŸ¥çœ‹æ”¯ä»˜ç›¸å…³è¡¨

# æ–‡ä»¶ç®¡ç†
du -sh /var/lib/odoo  # æŸ¥çœ‹æ–‡ä»¶å­˜å‚¨å¤§å°
df -h  # æŸ¥çœ‹ç£ç›˜ç©ºé—´
```

### 11.2 é…ç½®æ–‡ä»¶ä½ç½®
- Odooä¸»é…ç½®: `/etc/odoo/odoo.conf`
- æ—¥å¿—æ–‡ä»¶: `/var/log/odoo/odoo.log`
- æ•°æ®ç›®å½•: `/var/lib/odoo`
- æ¨¡å—ç›®å½•: `/opt/odoo/custom-addons/`

### 11.3 è”ç³»æ”¯æŒ
- æŠ€æœ¯æ”¯æŒé‚®ç®±: support@example.com
- ç´§æ€¥è”ç³»ç”µè¯: +86-XXX-XXXX-XXXX
- åœ¨çº¿æ–‡æ¡£: https://docs.example.com
- ç¤¾åŒºè®ºå›: https://forum.example.com

### 11.4 ç®¡ç†æ£€æŸ¥æ¸…å•
- [ ] æ¯æ—¥å¤‡ä»½æ£€æŸ¥
- [ ] ç³»ç»Ÿæ—¥å¿—æ£€æŸ¥
- [ ] æ”¯ä»˜æˆåŠŸç‡ç›‘æ§
- [ ] ç£ç›˜ç©ºé—´ç›‘æ§
- [ ] å®‰å…¨æ›´æ–°æ£€æŸ¥
- [ ] ç”¨æˆ·æ´»åŠ¨å®¡è®¡

---

*æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.0*
*æœ€åæ›´æ–°ï¼š{å½“å‰æ—¥æœŸ}*
*ç»´æŠ¤å›¢é˜Ÿï¼šæŠ€æœ¯æ”¯æŒå›¢é˜Ÿ*
"""

    def _get_user_template(self):
        """ç»ˆç«¯ç”¨æˆ·æ“ä½œæŒ‡å—æ¨¡æ¿"""
        return """# ç»ˆç«¯ç”¨æˆ·æ“ä½œæŒ‡å—

## 1. ç³»ç»Ÿç™»å½•

### 1.1 è®¿é—®ç³»ç»Ÿ
1. æ‰“å¼€æµè§ˆå™¨ï¼Œè¾“å…¥ç³»ç»Ÿç½‘å€: `https://your-company.com`
2. è¾“å…¥æ‚¨çš„ç”¨æˆ·åå’Œå¯†ç 
3. ç‚¹å‡»ã€Œç™»å½•ã€æŒ‰é’®

### 1.2 é¦–æ¬¡ç™»å½•
- é¦–æ¬¡ç™»å½•éœ€è¦ä¿®æ”¹å¯†ç 
- å¯†ç è¦æ±‚ï¼šè‡³å°‘8ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦
- å»ºè®®å¯ç”¨åŒå› ç´ è®¤è¯

### 1.3 å¿˜è®°å¯†ç 
1. ç‚¹å‡»ç™»å½•é¡µé¢çš„ã€Œå¿˜è®°å¯†ç ï¼Ÿã€
2. è¾“å…¥æ‚¨çš„æ³¨å†Œé‚®ç®±
3. æŸ¥æ”¶é‚®ä»¶ä¸­çš„é‡ç½®é“¾æ¥
4. è®¾ç½®æ–°å¯†ç 

## 2. ä¸ªäººè®¾ç½®

### 2.1 ä¿®æ”¹ä¸ªäººä¿¡æ¯
1. ç‚¹å‡»å³ä¸Šè§’ç”¨æˆ·å
2. é€‰æ‹©ã€Œæˆ‘çš„è´¦æˆ·ã€
3. ç¼–è¾‘ä¸ªäººä¿¡æ¯ï¼š
   - å§“å
   - é‚®ç®±
   - ç”µè¯
   - å¤´åƒ
4. ç‚¹å‡»ã€Œä¿å­˜ã€

### 2.2 ä¿®æ”¹å¯†ç 
1. è¿›å…¥ã€Œæˆ‘çš„è´¦æˆ·ã€
2. ç‚¹å‡»ã€Œæ›´æ”¹å¯†ç ã€
3. è¾“å…¥å½“å‰å¯†ç 
4. è¾“å…¥æ–°å¯†ç ï¼ˆä¸¤æ¬¡ï¼‰
5. ç‚¹å‡»ã€Œæ›´æ”¹å¯†ç ã€

### 2.3 é€šçŸ¥è®¾ç½®
1. è¿›å…¥ã€Œè®¾ç½®ã€â†’ã€Œä¸ªäººè®¾ç½®ã€
2. é…ç½®é€šçŸ¥æ–¹å¼ï¼š
   - é‚®ä»¶é€šçŸ¥
   - ç«™å†…æ¶ˆæ¯
   - æ‰‹æœºçŸ­ä¿¡
3. é€‰æ‹©é€šçŸ¥ç±»å‹ï¼š
   - æ”¯ä»˜æˆåŠŸé€šçŸ¥
   - é€€æ¬¾é€šçŸ¥
   - ç³»ç»Ÿå…¬å‘Š

## 3. æ”¯ä»˜åŠŸèƒ½

### 3.1 å‘èµ·æ”¯ä»˜

#### 3.1.1 åˆ›å»ºæ”¯ä»˜è®¢å•
1. è¿›å…¥ã€Œé”€å”®ã€â†’ã€Œè®¢å•ã€â†’ã€Œé”€å”®è®¢å•ã€
2. é€‰æ‹©å®¢æˆ·å’Œäº§å“
3. ç¡®è®¤è®¢å•é‡‘é¢
4. ç‚¹å‡»ã€Œç¡®è®¤ã€
5. é€‰æ‹©ã€Œæ”¯ä»˜ã€æŒ‰é’®

#### 3.1.2 é€‰æ‹©æ”¯ä»˜æ–¹å¼
1. é€‰æ‹©æ”¯ä»˜æ¸ é“ï¼š
   - å¾®ä¿¡æ”¯ä»˜
   - æ”¯ä»˜å®æ”¯ä»˜
   - äº‘é—ªä»˜æ”¯ä»˜
2. é€‰æ‹©æ”¯ä»˜æ–¹å¼ï¼š
   - æ‰«ç æ”¯ä»˜
   - åœ¨çº¿æ”¯ä»˜
   - æ‰‹æœºæ”¯ä»˜

#### 3.1.3 å®Œæˆæ”¯ä»˜
**æ‰«ç æ”¯ä»˜**:
1. ç³»ç»Ÿç”Ÿæˆæ”¯ä»˜äºŒç»´ç 
2. ä½¿ç”¨å¾®ä¿¡/æ”¯ä»˜å®æ‰«æäºŒç»´ç 
3. åœ¨æ‰‹æœºä¸Šç¡®è®¤æ”¯ä»˜
4. ç³»ç»Ÿè‡ªåŠ¨è·³è½¬æ”¯ä»˜æˆåŠŸé¡µé¢

**åœ¨çº¿æ”¯ä»˜**:
1. è·³è½¬åˆ°æ”¯ä»˜å¹³å°é¡µé¢
2. ç™»å½•æ”¯ä»˜è´¦æˆ·
3. ç¡®è®¤æ”¯ä»˜ä¿¡æ¯
4. è¾“å…¥æ”¯ä»˜å¯†ç 
5. è¿”å›å•†æˆ·é¡µé¢

### 3.2 æŸ¥çœ‹æ”¯ä»˜è®°å½•

#### 3.2.1 æŸ¥çœ‹äº¤æ˜“è®°å½•
1. è¿›å…¥ã€Œä¼šè®¡ã€â†’ã€Œæ”¯ä»˜ã€â†’ã€Œäº¤æ˜“è®°å½•ã€
2. æŸ¥çœ‹äº¤æ˜“åˆ—è¡¨ï¼š
   - è®¢å•å·
   - æ”¯ä»˜æ—¶é—´
   - æ”¯ä»˜é‡‘é¢
   - æ”¯ä»˜çŠ¶æ€
   - æ”¯ä»˜æ–¹å¼

#### 3.2.2 æœç´¢äº¤æ˜“è®°å½•
1. ä½¿ç”¨ç­›é€‰æ¡ä»¶ï¼š
   - æ—¥æœŸèŒƒå›´
   - æ”¯ä»˜çŠ¶æ€
   - æ”¯ä»˜æ–¹å¼
   - è®¢å•å·
   - å®¢æˆ·åç§°
2. ç‚¹å‡»ã€Œæœç´¢ã€

#### 3.2.3 å¯¼å‡ºäº¤æ˜“è®°å½•
1. é€‰æ‹©è¦å¯¼å‡ºçš„è®°å½•
2. ç‚¹å‡»ã€Œå¯¼å‡ºã€
3. é€‰æ‹©å¯¼å‡ºæ ¼å¼ï¼š
   - Excel
   - CSV
   - PDF
4. ç‚¹å‡»ã€Œä¸‹è½½ã€

### 3.3 é€€æ¬¾å¤„ç†

#### 3.3.1 å‘èµ·é€€æ¬¾
1. è¿›å…¥ã€Œä¼šè®¡ã€â†’ã€Œæ”¯ä»˜ã€â†’ã€Œäº¤æ˜“è®°å½•ã€
2. æ‰¾åˆ°è¦é€€æ¬¾çš„äº¤æ˜“
3. ç‚¹å‡»ã€Œé€€æ¬¾ã€æŒ‰é’®
4. è¾“å…¥é€€æ¬¾é‡‘é¢
5. é€‰æ‹©é€€æ¬¾åŸå› ï¼š
   - å•†å“è´¨é‡é—®é¢˜
   - å‘é”™å•†å“
   - å®¢æˆ·å–æ¶ˆè®¢å•
   - å…¶ä»–åŸå› 
6. ç‚¹å‡»ã€Œç¡®è®¤é€€æ¬¾ã€

#### 3.3.2 æŸ¥çœ‹é€€æ¬¾è¿›åº¦
1. è¿›å…¥ã€Œä¼šè®¡ã€â†’ã€Œæ”¯ä»˜ã€â†’ã€Œé€€æ¬¾è®°å½•ã€
2. æŸ¥çœ‹é€€æ¬¾çŠ¶æ€ï¼š
   - å¤„ç†ä¸­
   - å·²é€€æ¬¾
   - é€€æ¬¾å¤±è´¥
3. æŸ¥çœ‹é€€æ¬¾è¯¦æƒ…ï¼š
   - é€€æ¬¾å•å·
   - é€€æ¬¾æ—¶é—´
   - é€€æ¬¾é‡‘é¢
   - é€€æ¬¾åŸå› 

#### 3.3.3 å¤„ç†é€€æ¬¾å¤±è´¥
å¦‚æœé€€æ¬¾å¤±è´¥ï¼š
1. æŸ¥çœ‹å¤±è´¥åŸå› 
2. æ£€æŸ¥æ”¯ä»˜è´¦æˆ·ä½™é¢
3. è”ç³»æŠ€æœ¯æ”¯æŒ
4. é‡æ–°å‘èµ·é€€æ¬¾

## 4. å¾®ä¿¡å…¬ä¼—å·ç®¡ç†

### 4.1 ç²‰ä¸ç®¡ç†

#### 4.1.1 æŸ¥çœ‹ç²‰ä¸åˆ—è¡¨
1. è¿›å…¥ã€Œå¾®ä¿¡ã€â†’ã€Œå…¬ä¼—å·ã€â†’ã€Œç²‰ä¸ç®¡ç†ã€
2. æŸ¥çœ‹ç²‰ä¸ä¿¡æ¯ï¼š
   - æ˜µç§°
   - æ€§åˆ«
   - åœ°åŒº
   - å…³æ³¨æ—¶é—´
   - å¤‡æ³¨

#### 4.1.2 æœç´¢ç²‰ä¸
1. ä½¿ç”¨ç­›é€‰æ¡ä»¶ï¼š
   - æ˜µç§°
   - æ€§åˆ«
   - åœ°åŒº
   - å…³æ³¨æ—¶é—´
   - æ ‡ç­¾
2. ç‚¹å‡»ã€Œæœç´¢ã€

#### 4.1.3 ç®¡ç†ç²‰ä¸æ ‡ç­¾
1. é€‰æ‹©ç²‰ä¸
2. ç‚¹å‡»ã€Œæ‰“æ ‡ç­¾ã€
3. é€‰æ‹©å·²æœ‰æ ‡ç­¾æˆ–æ–°å»ºæ ‡ç­¾
4. æ ‡ç­¾åˆ†ç±»ï¼š
   - VIPå®¢æˆ·
   - æ½œåœ¨å®¢æˆ·
   - å·²è´­ä¹°å®¢æˆ·
   - æ´»åŠ¨å‚ä¸å®¢æˆ·

### 4.2 æ¶ˆæ¯ç®¡ç†

#### 4.2.1 æŸ¥çœ‹æ¶ˆæ¯è®°å½•
1. è¿›å…¥ã€Œå¾®ä¿¡ã€â†’ã€Œå…¬ä¼—å·ã€â†’ã€Œæ¶ˆæ¯ç®¡ç†ã€
2. æŸ¥çœ‹æ¶ˆæ¯åˆ—è¡¨ï¼š
   - å‘é€äºº
   - æ¶ˆæ¯å†…å®¹
   - å‘é€æ—¶é—´
   - æ¶ˆæ¯ç±»å‹
   - å›å¤çŠ¶æ€

#### 4.2.2 å›å¤æ¶ˆæ¯
1. é€‰æ‹©è¦å›å¤çš„æ¶ˆæ¯
2. ç‚¹å‡»ã€Œå›å¤ã€
3. è¾“å…¥å›å¤å†…å®¹
4. é€‰æ‹©å›å¤ç±»å‹ï¼š
   - æ–‡æœ¬
   - å›¾ç‰‡
   - å›¾æ–‡
   - è¯­éŸ³
5. ç‚¹å‡»ã€Œå‘é€ã€

#### 4.2.3 è®¾ç½®è‡ªåŠ¨å›å¤
1. è¿›å…¥ã€Œå¾®ä¿¡ã€â†’ã€Œå…¬ä¼—å·ã€â†’ã€Œè‡ªåŠ¨å›å¤ã€
2. æ·»åŠ å›å¤è§„åˆ™ï¼š
   - å…³é”®è¯ï¼šç”¨æˆ·å‘é€çš„å…³é”®è¯
   - åŒ¹é…æ–¹å¼ï¼šå®Œå…¨åŒ¹é…/åŒ…å«åŒ¹é…
   - å›å¤å†…å®¹ï¼šæ–‡æœ¬ã€å›¾ç‰‡ã€å›¾æ–‡ç­‰
3. è®¾ç½®é»˜è®¤å›å¤ï¼ˆæ— åŒ¹é…æ—¶ï¼‰

### 4.3 èœå•ç®¡ç†

#### 4.3.1 æŸ¥çœ‹èœå•
1. è¿›å…¥ã€Œå¾®ä¿¡ã€â†’ã€Œå…¬ä¼—å·ã€â†’ã€Œèœå•ç®¡ç†ã€
2. æŸ¥çœ‹å½“å‰èœå•ç»“æ„
3. é¢„è§ˆèœå•æ•ˆæœ

#### 4.3.2 ç¼–è¾‘èœå•
1. ç‚¹å‡»ã€Œç¼–è¾‘èœå•ã€
2. æ·»åŠ èœå•é¡¹ï¼š
   - èœå•åç§°
   - èœå•ç±»å‹ï¼šç‚¹å‡»/è·³è½¬
   - èœå•å†…å®¹/é“¾æ¥
   - å­èœå•ï¼ˆå¯é€‰ï¼‰
3. æ‹–æ‹½è°ƒæ•´èœå•é¡ºåº
4. ç‚¹å‡»ã€Œä¿å­˜ã€

#### 4.3.3 å‘å¸ƒèœå•
1. ç¼–è¾‘å®Œæˆåç‚¹å‡»ã€Œå‘å¸ƒã€
2. ç¡®è®¤å‘å¸ƒå†…å®¹
3. èœå•å°†åœ¨å¾®ä¿¡å®¢æˆ·ç«¯æ›´æ–°ï¼ˆéœ€ç­‰å¾…ç‰‡åˆ»ï¼‰

## 5. å°ç¨‹åºç®¡ç†

### 5.1 å•†å“ç®¡ç†

#### 5.1.1 æŸ¥çœ‹å°ç¨‹åºå•†å“
1. è¿›å…¥ã€Œå¾®ä¿¡ã€â†’ã€Œå°ç¨‹åºã€â†’ã€Œå•†å“ç®¡ç†ã€
2. æŸ¥çœ‹å•†å“åˆ—è¡¨ï¼š
   - å•†å“åç§°
   - ä»·æ ¼
   - åº“å­˜
   - é”€é‡
   - çŠ¶æ€

#### 5.1.2 åŒæ­¥å•†å“åˆ°å°ç¨‹åº
1. é€‰æ‹©Odooä¸­çš„å•†å“
2. ç‚¹å‡»ã€ŒåŒæ­¥åˆ°å°ç¨‹åºã€
3. é…ç½®åŒæ­¥é€‰é¡¹ï¼š
   - åŒæ­¥ä»·æ ¼
   - åŒæ­¥åº“å­˜
   - åŒæ­¥å›¾ç‰‡
4. ç‚¹å‡»ã€Œç¡®è®¤åŒæ­¥ã€

#### 5.1.3 ç®¡ç†å•†å“åˆ†ç±»
1. è¿›å…¥ã€Œå¾®ä¿¡ã€â†’ã€Œå°ç¨‹åºã€â†’ã€Œå•†å“åˆ†ç±»ã€
2. æ·»åŠ åˆ†ç±»ï¼š
   - åˆ†ç±»åç§°
   - åˆ†ç±»å›¾ç‰‡
   - æ’åºé¡ºåº
   - çˆ¶åˆ†ç±»ï¼ˆå¯é€‰ï¼‰
3. æ‹–æ‹½è°ƒæ•´åˆ†ç±»é¡ºåº

### 5.2 è®¢å•ç®¡ç†

#### 5.2.1 æŸ¥çœ‹å°ç¨‹åºè®¢å•
1. è¿›å…¥ã€Œå¾®ä¿¡ã€â†’ã€Œå°ç¨‹åºã€â†’ã€Œè®¢å•ç®¡ç†ã€
2. æŸ¥çœ‹è®¢å•åˆ—è¡¨ï¼š
   - è®¢å•å·
   - å®¢æˆ·ä¿¡æ¯
   - è®¢å•é‡‘é¢
   - ä¸‹å•æ—¶é—´
   - è®¢å•çŠ¶æ€

#### 5.2.2 å¤„ç†è®¢å•
1. é€‰æ‹©è®¢å•
2. ç‚¹å‡»ã€Œå¤„ç†ã€
3. æ“ä½œé€‰é¡¹ï¼š
   - ç¡®è®¤è®¢å•
   - å‘è´§
   - å–æ¶ˆè®¢å•
   - é€€æ¬¾
4. æ›´æ–°è®¢å•çŠ¶æ€

#### 5.2.3 æŸ¥çœ‹è®¢å•è¯¦æƒ…
1. ç‚¹å‡»è®¢å•å·
2. æŸ¥çœ‹è®¢å•è¯¦æƒ…ï¼š
   - å•†å“æ˜ç»†
   - æ”¶è´§åœ°å€
   - æ”¯ä»˜ä¿¡æ¯
   - ç‰©æµä¿¡æ¯
   - è®¢å•å¤‡æ³¨

## 6. æŠ¥è¡¨æŸ¥çœ‹

### 6.1 æ”¯ä»˜æŠ¥è¡¨

#### 6.1.1 é”€å”®æŠ¥è¡¨
1. è¿›å…¥ã€ŒæŠ¥è¡¨ã€â†’ã€Œé”€å”®ã€â†’ã€Œé”€å”®åˆ†æã€
2. æŸ¥çœ‹é”€å”®æ•°æ®ï¼š
   - é”€å”®é¢è¶‹åŠ¿
   - çƒ­é”€å•†å“
   - å®¢æˆ·è´­ä¹°åˆ†æ
   - æ”¯ä»˜æ–¹å¼åˆ†å¸ƒ

#### 6.1.2 æ”¯ä»˜ç»Ÿè®¡
1. è¿›å…¥ã€ŒæŠ¥è¡¨ã€â†’ã€Œè´¢åŠ¡ã€â†’ã€Œæ”¯ä»˜ç»Ÿè®¡ã€
2. æŸ¥çœ‹æ”¯ä»˜æ•°æ®ï¼š
   - æ”¯ä»˜æˆåŠŸç‡
   - æ”¯ä»˜æ¸ é“å¯¹æ¯”
   - é€€æ¬¾ç‡ç»Ÿè®¡
   - æ”¯ä»˜æ—¶é—´åˆ†å¸ƒ

### 6.2 ç”¨æˆ·æŠ¥è¡¨

#### 6.2.1 ç”¨æˆ·å¢é•¿æŠ¥è¡¨
1. è¿›å…¥ã€ŒæŠ¥è¡¨ã€â†’ã€Œç”¨æˆ·ã€â†’ã€Œç”¨æˆ·åˆ†æã€
2. æŸ¥çœ‹ç”¨æˆ·æ•°æ®ï¼š
   - æ–°å¢ç”¨æˆ·è¶‹åŠ¿
   - ç”¨æˆ·æ´»è·ƒåº¦
   - ç”¨æˆ·ç•™å­˜ç‡
   - ç”¨æˆ·åœ°åŸŸåˆ†å¸ƒ

#### 6.2.2 ç²‰ä¸åˆ†ææŠ¥è¡¨
1. è¿›å…¥ã€ŒæŠ¥è¡¨ã€â†’ã€Œå¾®ä¿¡ã€â†’ã€Œç²‰ä¸åˆ†æã€
2. æŸ¥çœ‹ç²‰ä¸æ•°æ®ï¼š
   - ç²‰ä¸å¢é•¿è¶‹åŠ¿
   - ç²‰ä¸æ€§åˆ«æ¯”ä¾‹
   - ç²‰ä¸åœ°åŸŸåˆ†å¸ƒ
   - ç²‰ä¸äº’åŠ¨åˆ†æ

### 6.3 å¯¼å‡ºæŠ¥è¡¨

#### 6.3.1 å¯¼å‡ºæ•°æ®
1. åœ¨æŠ¥è¡¨é¡µé¢ç‚¹å‡»ã€Œå¯¼å‡ºã€
2. é€‰æ‹©å¯¼å‡ºæ ¼å¼ï¼š
   - Excel (.xlsx)
   - CSV (.csv)
   - PDF (.pdf)
3. é€‰æ‹©å¯¼å‡ºèŒƒå›´ï¼š
   - å½“å‰é¡µé¢æ•°æ®
   - æ‰€æœ‰æ•°æ®
4. ç‚¹å‡»ã€Œä¸‹è½½ã€

#### 6.3.2 å®šæœŸæŠ¥è¡¨
1. è¿›å…¥ã€ŒæŠ¥è¡¨ã€â†’ã€Œè®¾ç½®ã€â†’ã€Œå®šæœŸæŠ¥è¡¨ã€
2. é…ç½®å®šæœŸå‘é€ï¼š
   - æŠ¥è¡¨ç±»å‹
   - å‘é€é¢‘ç‡ï¼šæ¯æ—¥/æ¯å‘¨/æ¯æœˆ
   - å‘é€æ—¶é—´
   - æ”¶ä»¶äºº
3. ä¿å­˜è®¾ç½®

## 7. å¸¸è§é—®é¢˜

### 7.1 æ”¯ä»˜é—®é¢˜

#### Q1: æ”¯ä»˜æ—¶æç¤º"å•†æˆ·å·ä¸å­˜åœ¨"
A: 
1. æ£€æŸ¥æ”¯ä»˜é…ç½®æ˜¯å¦æ­£ç¡®
2. è”ç³»ç®¡ç†å‘˜ç¡®è®¤å•†æˆ·å·
3. æ£€æŸ¥ç½‘ç»œè¿æ¥

#### Q2: æ”¯ä»˜æˆåŠŸä½†è®¢å•çŠ¶æ€æœªæ›´æ–°
A:
1. ç­‰å¾…å‡ åˆ†é’Ÿååˆ·æ–°é¡µé¢
2. æŸ¥çœ‹æ”¯ä»˜å›è°ƒæ—¥å¿—
3. è”ç³»æŠ€æœ¯æ”¯æŒ

#### Q3: é€€æ¬¾å¤±è´¥
A:
1. æ£€æŸ¥æ”¯ä»˜è´¦æˆ·ä½™é¢
2. ç¡®è®¤é€€æ¬¾é‡‘é¢ä¸è¶…è¿‡æ”¯ä»˜é‡‘é¢
3. æŸ¥çœ‹é€€æ¬¾å¤±è´¥åŸå› 

### 7.2 ç³»ç»Ÿé—®é¢˜

#### Q1: æ— æ³•ç™»å½•ç³»ç»Ÿ
A:
1. æ£€æŸ¥ç”¨æˆ·åå¯†ç æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤è´¦æˆ·æ˜¯å¦è¢«é”å®š
3. è”ç³»ç®¡ç†å‘˜é‡ç½®å¯†ç 

#### Q2: é¡µé¢åŠ è½½ç¼“æ…¢
A:
1. æ£€æŸ¥ç½‘ç»œè¿æ¥
2. æ¸…ç†æµè§ˆå™¨ç¼“å­˜
3. è”ç³»ç³»ç»Ÿç®¡ç†å‘˜

#### Q3: æ•°æ®æ— æ³•ä¿å­˜
A:
1. æ£€æŸ¥å¿…å¡«å­—æ®µæ˜¯å¦å¡«å†™
2. ç¡®è®¤æ˜¯å¦æœ‰ä¿å­˜æƒé™
3. åˆ·æ–°é¡µé¢é‡è¯•

### 7.3 å¾®ä¿¡ç›¸å…³é—®é¢˜

#### Q1: å…¬ä¼—å·èœå•ä¸æ˜¾ç¤º
A:
1. ç¡®è®¤èœå•å·²å‘å¸ƒ
2. ç­‰å¾…å¾®ä¿¡å®¢æˆ·ç«¯åˆ·æ–°
3. é‡æ–°å…³æ³¨å…¬ä¼—å·

#### Q2: è‡ªåŠ¨å›å¤ä¸ç”Ÿæ•ˆ
A:
1. æ£€æŸ¥å…³é”®è¯è®¾ç½®
2. ç¡®è®¤è‡ªåŠ¨å›å¤å·²å¯ç”¨
3. æ£€æŸ¥å›å¤å†…å®¹æ ¼å¼

#### Q3: ç²‰ä¸åŒæ­¥å¤±è´¥
A:
1. æ£€æŸ¥å…¬ä¼—å·é…ç½®
2. ç¡®è®¤APIæƒé™
3. é‡æ–°åŒæ­¥

## 8. è”ç³»æ”¯æŒ

### 8.1 æŠ€æœ¯æ”¯æŒ
- é‚®ç®±: support@your-company.com
- ç”µè¯: 400-XXX-XXXX
- åœ¨çº¿å®¢æœ: ç³»ç»Ÿå³ä¸‹è§’ã€Œåœ¨çº¿å¸®åŠ©ã€

### 8.2 åé¦ˆå»ºè®®
1. è¿›å…¥ã€Œå¸®åŠ©ã€â†’ã€Œåé¦ˆå»ºè®®ã€
2. æè¿°é—®é¢˜æˆ–å»ºè®®
3. ä¸Šä¼ æˆªå›¾ï¼ˆå¯é€‰ï¼‰
4. æäº¤åé¦ˆ

### 8.3 åŸ¹è®­èµ„æº
- è§†é¢‘æ•™ç¨‹: https://learn.your-company.com
- æ“ä½œæ‰‹å†Œ: æœ¬æ–‡æ¡£
- åœ¨çº¿åŸ¹è®­: æ¯å‘¨ä¸‰ä¸‹åˆ3ç‚¹

## 9. é™„å½•

### 9.1 å¿«æ·é”®åˆ—è¡¨
| å¿«æ·é”® | åŠŸèƒ½ |
|--------|------|
| Ctrl + S | ä¿å­˜ |
| Ctrl + P | æ‰“å° |
| Ctrl + F | æŸ¥æ‰¾ |
| Ctrl + Z | æ’¤é”€ |
| Ctrl + Y | é‡åš |
| F5 | åˆ·æ–° |

### 9.2 æµè§ˆå™¨è¦æ±‚
- Chrome 80+
- Firefox 75+
- Edge 80+
- Safari 13+
- ä¸æ”¯æŒIEæµè§ˆå™¨

### 9.3 ç§»åŠ¨ç«¯ä½¿ç”¨
1. åœ¨æ‰‹æœºæµè§ˆå™¨è®¿é—®ç³»ç»Ÿç½‘å€
2. æˆ–ä½¿ç”¨Odooå®˜æ–¹APP
3. æ”¯æŒå“åº”å¼è®¾è®¡ï¼Œè‡ªåŠ¨é€‚é…å±å¹•

---

*æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.0*
*æœ€åæ›´æ–°ï¼š{å½“å‰æ—¥æœŸ}*
*ç»´æŠ¤å›¢é˜Ÿï¼šäº§å“å›¢é˜Ÿ*
"""

    def _get_pos_template(self):
        """POSæ”¶é“¶å‘˜æ‰‹å†Œæ¨¡æ¿"""
        return """# POSæ”¶é“¶å‘˜æ‰‹å†Œ

## 1. POSç³»ç»Ÿç™»å½•

### 1.1 å¯åŠ¨POS
1. æ‰“å¼€POSæ”¶é“¶æœº
2. ç­‰å¾…ç³»ç»Ÿå¯åŠ¨å®Œæˆ
3. è¾“å…¥ç”¨æˆ·åå’Œå¯†ç 
4. ç‚¹å‡»ã€Œç™»å½•ã€

### 1.2 é€‰æ‹©æ”¶é“¶å°
1. ç™»å½•åé€‰æ‹©æ”¶é“¶å°
2. ç¡®è®¤æ”¶é“¶å°å·æ­£ç¡®
3. ç‚¹å‡»ã€Œå¼€å§‹ã€è¿›å…¥æ”¶é“¶ç•Œé¢

### 1.3 æ”¶é“¶å‘˜äº¤æ¥
1. ä¸Šç­æ—¶ç‚¹å‡»ã€Œä¸Šç­ç­¾åˆ°ã€
2. è¾“å…¥å¤‡ç”¨é‡‘é‡‘é¢
3. ç¡®è®¤äº¤æ¥ä¿¡æ¯
4. ä¸‹ç­æ—¶ç‚¹å‡»ã€Œä¸‹ç­ç­¾é€€ã€
5. æ ¸å¯¹å½“æ—¥æ”¶æ¬¾

## 2. å•†å“é”€å”®

### 2.1 æ·»åŠ å•†å“

#### 2.1.1 æ‰«ç æ·»åŠ 
1. ä½¿ç”¨æ‰«ç æªæ‰«æå•†å“æ¡ç 
2. ç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«å•†å“
3. æ˜¾ç¤ºå•†å“åç§°ã€ä»·æ ¼ã€åº“å­˜

#### 2.1.2 æœç´¢æ·»åŠ 
1. ç‚¹å‡»ã€Œæœç´¢å•†å“ã€æŒ‰é’®
2. è¾“å…¥å•†å“åç§°æˆ–ç¼–ç 
3. ä»åˆ—è¡¨ä¸­é€‰æ‹©å•†å“
4. ç‚¹å‡»ã€Œæ·»åŠ ã€

#### 2.1.3 åˆ†ç±»é€‰æ‹©
1. ç‚¹å‡»å·¦ä¾§å•†å“åˆ†ç±»
2. æµè§ˆå•†å“åˆ—è¡¨
3. ç‚¹å‡»å•†å“å›¾ç‰‡æ·»åŠ 

### 2.2 ä¿®æ”¹è®¢å•

#### 2.2.1 ä¿®æ”¹æ•°é‡
1. åœ¨å•†å“è¡Œç‚¹å‡»æ•°é‡
2. è¾“å…¥æ–°æ•°é‡æˆ–ä½¿ç”¨åŠ å‡æŒ‰é’®
3. ç‚¹å‡»ç¡®è®¤

#### 2.2.2 åˆ é™¤å•†å“
1. ç‚¹å‡»å•†å“è¡Œå³ä¾§çš„ã€ŒÃ—ã€æŒ‰é’®
2. ç¡®è®¤åˆ é™¤

#### 2.2.3 ä»·æ ¼ä¿®æ”¹
1. ç‚¹å‡»å•†å“ä»·æ ¼
2. è¾“å…¥æ–°ä»·æ ¼ï¼ˆéœ€è¦æƒé™ï¼‰
3. è¾“å…¥ä¿®æ”¹åŸå› 
4. ç‚¹å‡»ç¡®è®¤

### 2.3 ä¼˜æƒ å¤„ç†

#### 2.3.1 æŠ˜æ‰£
1. ç‚¹å‡»ã€ŒæŠ˜æ‰£ã€æŒ‰é’®
2. é€‰æ‹©æŠ˜æ‰£ç±»å‹ï¼š
   - æ•´å•æŠ˜æ‰£
   - å•å“æŠ˜æ‰£
3. è¾“å…¥æŠ˜æ‰£ç‡æˆ–æŠ˜æ‰£é‡‘é¢
4. ç‚¹å‡»ç¡®è®¤

#### 2.3.2 ä¼˜æƒ åˆ¸
1. ç‚¹å‡»ã€Œä¼˜æƒ åˆ¸ã€æŒ‰é’®
2. æ‰«ææˆ–è¾“å…¥ä¼˜æƒ åˆ¸ç 
3. ç³»ç»Ÿè‡ªåŠ¨è®¡ç®—ä¼˜æƒ 
4. ç‚¹å‡»ç¡®è®¤

#### 2.3.3 ä¼šå‘˜ä¼˜æƒ 
1. æ‰«æä¼šå‘˜ç æˆ–è¾“å…¥ä¼šå‘˜æ‰‹æœºå·
2. ç³»ç»Ÿæ˜¾ç¤ºä¼šå‘˜ä¿¡æ¯
3. è‡ªåŠ¨åº”ç”¨ä¼šå‘˜æŠ˜æ‰£
4. ç´¯è®¡ä¼šå‘˜ç§¯åˆ†

## 3. æ”¯ä»˜æ“ä½œ

### 3.1 ç°é‡‘æ”¯ä»˜

#### 3.1.1 é€‰æ‹©ç°é‡‘æ”¯ä»˜
1. ç‚¹å‡»ã€Œç°é‡‘ã€æŒ‰é’®
2. ç³»ç»Ÿæ˜¾ç¤ºåº”ä»˜é‡‘é¢
3. è¾“å…¥å®æ”¶é‡‘é¢
4. ç‚¹å‡»ã€Œç¡®è®¤ã€

#### 3.1.2 æ‰¾é›¶è®¡ç®—
1. ç³»ç»Ÿè‡ªåŠ¨è®¡ç®—æ‰¾é›¶é‡‘é¢
2. æ˜¾ç¤ºæ‰¾é›¶é‡‘é¢
3. ç¡®è®¤æ— è¯¯åæ‰“å°å°ç¥¨

#### 3.1.3 å¤§é¢ç°é‡‘å¤„ç†
1. è¶…è¿‡5000å…ƒéœ€ä¸»ç®¡æˆæƒ
2. ç‚¹å‡»ã€Œä¸»ç®¡æˆæƒã€æŒ‰é’®
3. ä¸»ç®¡è¾“å…¥å¯†ç 
4. ç»§ç»­æ”¯ä»˜æµç¨‹

### 3.2 å¾®ä¿¡æ”¯ä»˜

#### 3.2.1 é¡¾å®¢æ‰«ç ï¼ˆä¸»æ‰«ï¼‰
1. ç‚¹å‡»ã€Œå¾®ä¿¡æ”¯ä»˜ã€æŒ‰é’®
2. ç³»ç»Ÿç”Ÿæˆä»˜æ¬¾äºŒç»´ç 
3. é¡¾å®¢ä½¿ç”¨å¾®ä¿¡æ‰«æäºŒç»´ç 
4. é¡¾å®¢åœ¨æ‰‹æœºä¸Šç¡®è®¤æ”¯ä»˜
5. ç³»ç»Ÿæ˜¾ç¤ºæ”¯ä»˜æˆåŠŸ
6. è‡ªåŠ¨æ‰“å°å°ç¥¨

#### 3.2.2 å•†å®¶æ‰«ç ï¼ˆè¢«æ‰«ï¼‰
1. ç‚¹å‡»ã€Œæ‰«ç æ”¶æ¬¾ã€æŒ‰é’®
2. ä½¿ç”¨æ‰«ç æªæ‰«æé¡¾å®¢ä»˜æ¬¾ç 
3. ç³»ç»Ÿæ˜¾ç¤ºæ”¯ä»˜ç»“æœ
4. è‡ªåŠ¨æ‰“å°å°ç¥¨

#### 3.2.3 æ”¯ä»˜çŠ¶æ€æŸ¥è¯¢
1. å¦‚æ”¯ä»˜çŠ¶æ€æœªåŠæ—¶æ›´æ–°
2. ç‚¹å‡»ã€ŒæŸ¥è¯¢æ”¯ä»˜çŠ¶æ€ã€
3. ç³»ç»Ÿé‡æ–°æŸ¥è¯¢æ”¯ä»˜ç»“æœ
4. æ˜¾ç¤ºæœ€ç»ˆæ”¯ä»˜çŠ¶æ€

### 3.3 æ”¯ä»˜å®æ”¯ä»˜
æ“ä½œæµç¨‹ä¸å¾®ä¿¡æ”¯ä»˜ç±»ä¼¼

### 3.4 é“¶è¡Œå¡æ”¯ä»˜
1. ç‚¹å‡»ã€Œé“¶è¡Œå¡ã€æŒ‰é’®
2. æ’å…¥æˆ–åˆ·å¡
3. è¾“å…¥å¯†ç ï¼ˆå¦‚éœ€ï¼‰
4. æ‰“å°ç­¾è´­å•
5. é¡¾å®¢ç­¾å­—ç¡®è®¤

### 3.5 ç»„åˆæ”¯ä»˜
1. é€‰æ‹©ç¬¬ä¸€ç§æ”¯ä»˜æ–¹å¼
2. è¾“å…¥éƒ¨åˆ†æ”¯ä»˜é‡‘é¢
3. é€‰æ‹©ç¬¬äºŒç§æ”¯ä»˜æ–¹å¼
4. æ”¯ä»˜å‰©ä½™é‡‘é¢
5. ç¡®è®¤æ”¯ä»˜å®Œæˆ

## 4. å°ç¥¨ç®¡ç†

### 4.1 å°ç¥¨æ‰“å°

#### 4.1.1 è‡ªåŠ¨æ‰“å°
- æ”¯ä»˜æˆåŠŸåè‡ªåŠ¨æ‰“å°å°ç¥¨
- åŒ…å«è®¢å•ä¿¡æ¯å’Œæ”¯ä»˜ä¿¡æ¯
- æ˜¾ç¤ºåº—é“ºä¿¡æ¯å’Œæ—¶é—´

#### 4.1.2 æ‰‹åŠ¨æ‰“å°
1. ç‚¹å‡»ã€Œæ‰“å°å°ç¥¨ã€æŒ‰é’®
2. é€‰æ‹©æ‰“å°å†…å®¹ï¼š
   - å½“å‰è®¢å•
   - å†å²è®¢å•
   - æ—¥ç»“å°ç¥¨
3. ç‚¹å‡»ã€Œæ‰“å°ã€

#### 4.1.3 é‡æ‰“å°å°ç¥¨
1. è¿›å…¥ã€Œå†å²è®¢å•ã€
2. æ‰¾åˆ°éœ€è¦é‡æ‰“å°çš„è®¢å•
3. ç‚¹å‡»ã€Œé‡æ‰“å°å°ç¥¨ã€
4. ç¡®è®¤æ‰“å°

### 4.2 å°ç¥¨å†…å®¹

#### 4.2.1 å¤´éƒ¨ä¿¡æ¯
- åº—é“ºåç§°
- åº—é“ºåœ°å€
- è”ç³»ç”µè¯
- æ”¶é“¶å‘˜ç¼–å·
- æ”¶é“¶å°å·
- è®¢å•å·
- äº¤æ˜“æ—¶é—´

#### 4.2.2 å•†å“æ˜ç»†
- å•†å“åç§°
- å•ä»·
- æ•°é‡
- å°è®¡
- æŠ˜æ‰£ä¿¡æ¯

#### 4.2.3 æ”¯ä»˜ä¿¡æ¯
- åº”ä»˜é‡‘é¢
- å®ä»˜é‡‘é¢
- æ‰¾é›¶é‡‘é¢
- æ”¯ä»˜æ–¹å¼
- äº¤æ˜“æµæ°´å·

#### 4.2.4 åº•éƒ¨ä¿¡æ¯
- æ„Ÿè°¢è¯­
- åº—é“ºäºŒç»´ç 
- å®¢æœç”µè¯
- é€€æ¢è´§æ”¿ç­–

### 4.3 å°ç¥¨è®¾ç½®

#### 4.3.1 æ‰“å°æœºè®¾ç½®
1. è¿›å…¥ã€Œè®¾ç½®ã€â†’ã€Œæ‰“å°æœºè®¾ç½®ã€
2. é€‰æ‹©æ‰“å°æœºå‹å·
3. é…ç½®æ‰“å°æœºå‚æ•°
4. æµ‹è¯•æ‰“å°

#### 4.3.2 å°ç¥¨æ¨¡æ¿è®¾ç½®
1. è¿›å…¥ã€Œè®¾ç½®ã€â†’ã€Œå°ç¥¨è®¾ç½®ã€
2. ç¼–è¾‘å°ç¥¨æ¨¡æ¿
3. è°ƒæ•´æ˜¾ç¤ºå†…å®¹
4. ä¿å­˜è®¾ç½®

## 5. ä¼šå‘˜ç®¡ç†

### 5.1 ä¼šå‘˜æ³¨å†Œ

#### 5.1.1 æ–°ä¼šå‘˜æ³¨å†Œ
1. ç‚¹å‡»ã€Œä¼šå‘˜ã€â†’ã€Œæ–°ä¼šå‘˜ã€
2. è¾“å…¥ä¼šå‘˜ä¿¡æ¯ï¼š
   - æ‰‹æœºå·ï¼ˆå¿…å¡«ï¼‰
   - å§“å
   - ç”Ÿæ—¥
   - é‚®ç®±
3. è®¾ç½®åˆå§‹ç§¯åˆ†
4. ç‚¹å‡»ã€Œæ³¨å†Œã€

#### 5.1.2 å‘é€ä¼šå‘˜å¡
1. æ³¨å†ŒæˆåŠŸå
2. ç‚¹å‡»ã€Œå‘é€ä¼šå‘˜å¡ã€
3. å‘é€å¾®ä¿¡ä¼šå‘˜å¡
4. é¡¾å®¢åœ¨å¾®ä¿¡ä¸­é¢†å–

### 5.2 ä¼šå‘˜æŸ¥è¯¢

#### 5.2.1 æ‰‹æœºå·æŸ¥è¯¢
1. ç‚¹å‡»ã€Œä¼šå‘˜æŸ¥è¯¢ã€
2. è¾“å…¥ä¼šå‘˜æ‰‹æœºå·
3. æ˜¾ç¤ºä¼šå‘˜ä¿¡æ¯ï¼š
   - ä¼šå‘˜ç­‰çº§
   - å½“å‰ç§¯åˆ†
   - ç´¯è®¡æ¶ˆè´¹
   - ä¼˜æƒ åˆ¸

#### 5.2.2 æ‰«ç æŸ¥è¯¢
1. æ‰«æä¼šå‘˜äºŒç»´ç 
2. è‡ªåŠ¨æ˜¾ç¤ºä¼šå‘˜ä¿¡æ¯
3. åº”ç”¨ä¼šå‘˜ä¼˜æƒ 

### 5.3 ç§¯åˆ†ç®¡ç†

#### 5.3.1 ç§¯åˆ†ç´¯ç§¯
- æ¶ˆè´¹1å…ƒç´¯ç§¯1ç§¯åˆ†
- ä¼šå‘˜æ—¥åŒå€ç§¯åˆ†
- æ´»åŠ¨æœŸé—´é¢å¤–ç§¯åˆ†

#### 5.3.2 ç§¯åˆ†å…‘æ¢
1. ç‚¹å‡»ã€Œç§¯åˆ†å…‘æ¢ã€
2. é€‰æ‹©å…‘æ¢ç¤¼å“
3. æ‰£é™¤ç›¸åº”ç§¯åˆ†
4. æ‰“å°å…‘æ¢å‡­è¯

#### 5.3.3 ç§¯åˆ†è°ƒæ•´
1. éœ€è¦ä¸»ç®¡æˆæƒ
2. è¾“å…¥è°ƒæ•´åŸå› 
3. è¾“å…¥è°ƒæ•´ç§¯åˆ†
4. ç¡®è®¤è°ƒæ•´

## 6. é€€æ¬¾é€€è´§

### 6.1 é€€è´§æµç¨‹

#### 6.1.1 æŸ¥æ‰¾åŸè®¢å•
1. ç‚¹å‡»ã€Œé€€è´§ã€æŒ‰é’®
2. æŸ¥æ‰¾åŸè®¢å•æ–¹å¼ï¼š
   - æ‰«æåŸå°ç¥¨
   - è¾“å…¥è®¢å•å·
   - è¾“å…¥æ‰‹æœºå·
3. æ˜¾ç¤ºåŸè®¢å•ä¿¡æ¯

#### 6.1.2 é€‰æ‹©é€€è´§å•†å“
1. ä»åŸè®¢å•ä¸­é€‰æ‹©è¦é€€è´§çš„å•†å“
2. è¾“å…¥é€€è´§æ•°é‡
3. é€‰æ‹©é€€è´§åŸå› ï¼š
   - è´¨é‡é—®é¢˜
   - å°ºç ä¸åˆé€‚
   - å…¶ä»–åŸå› 

#### 6.1.3 é€€è´§é€€æ¬¾
1. ç³»ç»Ÿè®¡ç®—é€€æ¬¾é‡‘é¢
2. é€‰æ‹©é€€æ¬¾æ–¹å¼ï¼š
   - åŸè·¯é€€å›ï¼ˆæ¨èï¼‰
   - ç°é‡‘é€€æ¬¾
   - é€€åˆ°ä¼šå‘˜å¡
3. æ‰§è¡Œé€€æ¬¾
4. æ‰“å°é€€è´§å•

### 6.2 é€€æ¬¾æˆæƒ

#### 6.2.1 éœ€è¦æˆæƒçš„åœºæ™¯
- é€€æ¬¾é‡‘é¢è¶…è¿‡500å…ƒ
- éåŸè·¯é€€å›
- æ— åŸå§‹å°ç¥¨
- è¶…è¿‡7å¤©é€€è´§æœŸ

#### 6.2.2 æˆæƒæµç¨‹
1. ç‚¹å‡»ã€Œä¸»ç®¡æˆæƒã€
2. ä¸»ç®¡è¾“å…¥æˆæƒç 
3. è®°å½•æˆæƒåŸå› 
4. ç»§ç»­é€€æ¬¾æµç¨‹

### 6.3 é€€è´§ç»Ÿè®¡

#### 6.3.1 æŸ¥çœ‹é€€è´§è®°å½•
1. è¿›å…¥ã€ŒæŠ¥è¡¨ã€â†’ã€Œé€€è´§è®°å½•ã€
2. æŸ¥çœ‹é€€è´§ç»Ÿè®¡ï¼š
   - å½“æ—¥é€€è´§é‡‘é¢
   - é€€è´§å•†å“æ’è¡Œ
   - é€€è´§åŸå› åˆ†æ

#### 6.3.2 å¯¼å‡ºé€€è´§æ•°æ®
1. é€‰æ‹©æ—¥æœŸèŒƒå›´
2. ç‚¹å‡»ã€Œå¯¼å‡ºã€
3. é€‰æ‹©å¯¼å‡ºæ ¼å¼
4. ä¸‹è½½æ–‡ä»¶

## 7. æ—¥ç»“æµç¨‹

### 7.1 æ”¶é“¶å‘˜æ—¥ç»“

#### 7.1.1 å¼€å§‹æ—¥ç»“
1. ç‚¹å‡»ã€Œæ—¥ç»“ã€æŒ‰é’®
2. ç³»ç»Ÿæç¤ºç¡®è®¤
3. ç‚¹å‡»ã€Œå¼€å§‹æ—¥ç»“ã€

#### 7.1.2 ç°é‡‘æ¸…ç‚¹
1. æ¸…ç‚¹å®é™…ç°é‡‘
2. è¾“å…¥æ¸…ç‚¹é‡‘é¢
3. ç³»ç»Ÿè‡ªåŠ¨æ ¸å¯¹å·®å¼‚

#### 7.1.3 æ ¸å¯¹æ”¯ä»˜æ–¹å¼
1. å¾®ä¿¡æ”¯ä»˜æ ¸å¯¹
2. æ”¯ä»˜å®æ”¯ä»˜æ ¸å¯¹
3. é“¶è¡Œå¡æ ¸å¯¹
4. å…¶ä»–æ”¯ä»˜æ ¸å¯¹

#### 7.1.4 å®Œæˆæ—¥ç»“
1. ç¡®è®¤æ‰€æœ‰æ•°æ®æ­£ç¡®
2. ç‚¹å‡»ã€Œå®Œæˆæ—¥ç»“ã€
3. æ‰“å°æ—¥ç»“å°ç¥¨
4. ä¸»ç®¡ç­¾å­—ç¡®è®¤

### 7.2 å¼‚å¸¸å¤„ç†

#### 7.2.1 ç°é‡‘å·®å¼‚å¤„ç†
- å·®å¼‚å°äº10å…ƒï¼šè®°å½•å¤‡æ³¨
- å·®å¼‚10-50å…ƒï¼šä¸»ç®¡æ ¸æŸ¥
- å·®å¼‚è¶…è¿‡50å…ƒï¼šä¸ŠæŠ¥ç»ç†

#### 7.2.2 æ”¯ä»˜å·®å¼‚å¤„ç†
1. å¾®ä¿¡/æ”¯ä»˜å®å·®å¼‚ï¼š
   - æ ¸å¯¹äº¤æ˜“è®°å½•
   - æŸ¥çœ‹å›è°ƒæ—¥å¿—
   - è”ç³»æŠ€æœ¯æ”¯æŒ
2. é“¶è¡Œå¡å·®å¼‚ï¼š
   - æ ¸å¯¹ç­¾è´­å•
   - æŸ¥çœ‹é“¶è¡Œå¯¹è´¦å•
   - è”ç³»é“¶è¡Œå®¢æœ

### 7.3 æ—¥ç»“æŠ¥è¡¨

#### 7.3.1 æ”¶é“¶å‘˜æŠ¥è¡¨
- æ”¶é“¶å‘˜ï¼šå§“å
- æ”¶é“¶å°ï¼šç¼–å·
- ä¸Šç­æ—¶é—´ï¼šå¼€å§‹æ—¶é—´
- ä¸‹ç­æ—¶é—´ï¼šç»“æŸæ—¶é—´
- ç°é‡‘æ”¶æ¬¾ï¼šé‡‘é¢
- å¾®ä¿¡æ”¶æ¬¾ï¼šé‡‘é¢
- æ”¯ä»˜å®æ”¶æ¬¾ï¼šé‡‘é¢
- é“¶è¡Œå¡æ”¶æ¬¾ï¼šé‡‘é¢
- é€€æ¬¾é‡‘é¢ï¼šé‡‘é¢
- å·®å¼‚é‡‘é¢ï¼šé‡‘é¢

#### 7.3.2 åº—é“ºæ—¥æŠ¥
- æ€»è¥ä¸šé¢
- å„æ”¯ä»˜æ–¹å¼å æ¯”
- å®¢å•ä»·åˆ†æ
- ç•…é”€å•†å“æ’è¡Œ
- ä¼šå‘˜é”€å”®å æ¯”

## 8. ç³»ç»Ÿç»´æŠ¤

### 8.1 æ—¥å¸¸æ£€æŸ¥

#### 8.1.1 ä¸Šç­å‰æ£€æŸ¥
1. æ£€æŸ¥ç½‘ç»œè¿æ¥
2. æ£€æŸ¥æ‰“å°æœºçŠ¶æ€
3. æ£€æŸ¥æ‰«ç æª
4. æ£€æŸ¥é’±ç®±
5. æ£€æŸ¥å°ç¥¨çº¸

#### 8.1.2 è¥ä¸šä¸­ç›‘æ§
1. ç›‘æ§æ”¯ä»˜æˆåŠŸç‡
2. ç›‘æ§ç½‘ç»œçŠ¶æ€
3. ç›‘æ§åº“å­˜é¢„è­¦
4. ç›‘æ§ç³»ç»Ÿæ€§èƒ½

#### 8.1.3 ä¸‹ç­å‰æ£€æŸ¥
1. å®Œæˆæ—¥ç»“
2. å…³é—­POSç³»ç»Ÿ
3. æ¸…ç†æ”¶é“¶å°
4. å®‰å…¨æ£€æŸ¥

### 8.2 æ•…éšœå¤„ç†

#### 8.2.1 ç½‘ç»œæ•…éšœ
1. æ£€æŸ¥ç½‘çº¿è¿æ¥
2. é‡å¯è·¯ç”±å™¨
3. åˆ‡æ¢åˆ°å¤‡ç”¨ç½‘ç»œ
4. ä½¿ç”¨ç¦»çº¿æ¨¡å¼

#### 8.2.2 æ‰“å°æœºæ•…éšœ
1. æ£€æŸ¥ç”µæºå’Œè¿æ¥
2. æ£€æŸ¥å°ç¥¨çº¸
3. æ¸…æ´æ‰“å°å¤´
4. é‡å¯æ‰“å°æœº

#### 8.2.3 æ‰«ç æªæ•…éšœ
1. æ£€æŸ¥è¿æ¥çº¿
2. é‡å¯æ‰«ç æª
3. æ£€æŸ¥æ¡ç æ¸…æ™°åº¦
4. æ›´æ¢æ‰«ç æª

#### 8.2.4 æ”¯ä»˜æ•…éšœ
1. æ£€æŸ¥æ”¯ä»˜ç»ˆç«¯
2. æ£€æŸ¥ç½‘ç»œè¿æ¥
3. é‡å¯æ”¯ä»˜è®¾å¤‡
4. è”ç³»æŠ€æœ¯æ”¯æŒ

## 9. å®‰å…¨è§„èŒƒ

### 9.1 ç°é‡‘å®‰å…¨

#### 9.1.1 ç°é‡‘ä¿ç®¡
- å¤§é¢ç°é‡‘åŠæ—¶å­˜å…¥ä¿é™©ç®±
- è¥ä¸šæœŸé—´é’±ç®±ä¸Šé”
- ä¸‹ç­å‰æ¸…ç‚¹ç°é‡‘
- ç°é‡‘äº¤æ¥ç­¾å­—ç¡®è®¤

#### 9.1.2 å‡å¸è¯†åˆ«
1. æ”¶åˆ°ç°é‡‘æ—¶ä»”ç»†æ£€æŸ¥
2. ä½¿ç”¨éªŒé’æœºéªŒè¯
3. å‘ç°å‡å¸ç«‹å³ä¸ŠæŠ¥
4. è®°å½•å‡å¸ä¿¡æ¯

### 9.2 ç³»ç»Ÿå®‰å…¨

#### 9.2.1 è´¦å·å®‰å…¨
- æ¯äººä½¿ç”¨è‡ªå·±çš„è´¦å·
- å®šæœŸä¿®æ”¹å¯†ç 
- ä¸‹ç­æ—¶é€€å‡ºç™»å½•
- ä¸é€éœ²è´¦å·å¯†ç 

#### 9.2.2 æ•°æ®å®‰å…¨
- ä¸éšæ„åˆ é™¤äº¤æ˜“è®°å½•
- ä¸æ³„éœ²å®¢æˆ·ä¿¡æ¯
- å®šæœŸå¤‡ä»½æ•°æ®
- éµå®ˆæ•°æ®ä¿æŠ¤æ³•è§„

### 9.3 æ“ä½œå®‰å…¨

#### 9.3.1 è§„èŒƒæ“ä½œ
- æŒ‰æµç¨‹æ“ä½œ
- ä»”ç»†æ ¸å¯¹é‡‘é¢
- ç¡®è®¤æ”¯ä»˜æˆåŠŸ
- ä¿å­˜äº¤æ˜“å‡­è¯

#### 9.3.2 å¼‚å¸¸å¤„ç†
- é‡åˆ°é—®é¢˜åŠæ—¶ä¸ŠæŠ¥
- ä¸æ“…è‡ªå¤„ç†å¼‚å¸¸
- è®°å½•é—®é¢˜è¯¦æƒ…
- é…åˆè°ƒæŸ¥å¤„ç†

## 10. é™„å½•

### 10.1 å¿«æ·é”®å‚è€ƒ
| å¿«æ·é”® | åŠŸèƒ½ |
|--------|------|
| F1 | å¸®åŠ© |
| F2 | å•†å“æœç´¢ |
| F3 | ä¼šå‘˜æŸ¥è¯¢ |
| F4 | æ”¯ä»˜ç•Œé¢ |
| F5 | æ—¥ç»“ |
| F6 | é€€è´§ |
| F7 | æ‰“å°å°ç¥¨ |
| F8 | è®¾ç½® |
| F9 | ç¦»çº¿æ¨¡å¼ |
| F10 | åœ¨çº¿æ¨¡å¼ |

### 10.2 é”™è¯¯ä»£ç å‚è€ƒ
| é”™è¯¯ç  | å«ä¹‰ | å¤„ç†æ–¹æ³• |
|--------|------|----------|
| ERR-001 | ç½‘ç»œè¿æ¥å¤±è´¥ | æ£€æŸ¥ç½‘ç»œï¼Œé‡å¯è·¯ç”±å™¨ |
| ERR-002 | æ‰“å°æœºæœªè¿æ¥ | æ£€æŸ¥è¿æ¥ï¼Œé‡å¯æ‰“å°æœº |
| ERR-003 | æ‰«ç æªæ•…éšœ | é‡æ–°è¿æ¥ï¼Œé‡å¯è®¾å¤‡ |
| ERR-004 | æ”¯ä»˜è¶…æ—¶ | é‡æ–°æ”¯ä»˜ï¼ŒæŸ¥è¯¢çŠ¶æ€ |
| ERR-005 | åº“å­˜ä¸è¶³ | è°ƒæ•´æ•°é‡ï¼Œè”ç³»è¡¥è´§ |
| ERR-006 | æƒé™ä¸è¶³ | è”ç³»ä¸»ç®¡æˆæƒ |
| ERR-007 | æ•°æ®é”™è¯¯ | é‡å¯ç³»ç»Ÿï¼Œè”ç³»æŠ€æœ¯æ”¯æŒ |

### 10.3 è”ç³»æ–¹å¼
- æŠ€æœ¯æ”¯æŒï¼š400-XXX-XXXX
- åº—é•¿ç”µè¯ï¼šXXX-XXXX-XXXX
- ä¸»ç®¡ç”µè¯ï¼šXXX-XXXX-XXXX
- ç´§æ€¥è”ç³»ï¼šXXX-XXXX-XXXX

### 10.4 åŸ¹è®­æ£€æŸ¥æ¸…å•
- [ ] POSç³»ç»ŸåŸºæœ¬æ“ä½œ
- [ ] å•†å“æ·»åŠ å’Œä¿®æ”¹
- [ ] å„ç§æ”¯ä»˜æ–¹å¼æ“ä½œ
- [ ] ä¼šå‘˜ç®¡ç†æ“ä½œ
- [ ] é€€è´§é€€æ¬¾æµç¨‹
- [ ] æ—¥ç»“æµç¨‹
- [ ] æ•…éšœå¤„ç†æ–¹æ³•
- [ ] å®‰å…¨è§„èŒƒ

---

*æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.0*
*æœ€åæ›´æ–°ï¼š{å½“å‰æ—¥æœŸ}*
*ç»´æŠ¤å›¢é˜Ÿï¼šåŸ¹è®­å›¢é˜Ÿ*
"""

    def _get_miniprogram_template(self):
        """å°ç¨‹åºä½¿ç”¨è¯´æ˜æ¨¡æ¿"""
        return """# å¾®ä¿¡å°ç¨‹åºä½¿ç”¨è¯´æ˜

## 1. å°ç¨‹åºæ¦‚è¿°

### 1.1 å°ç¨‹åºç®€ä»‹
æœ¬å°ç¨‹åºæ˜¯åŸºäºOdoo 19çš„å¾®ä¿¡ç”Ÿæ€ç³»ç»Ÿé›†æˆçš„ä¸€éƒ¨åˆ†ï¼Œä¸ºç”¨æˆ·æä¾›ä¾¿æ·çš„è´­ç‰©ã€æ”¯ä»˜å’ŒæœåŠ¡ä½“éªŒã€‚

### 1.2 ä¸»è¦åŠŸèƒ½
- **å•†å“æµè§ˆ**: æŸ¥çœ‹å•†å“è¯¦æƒ…ã€åˆ†ç±»æµè§ˆ
- **åœ¨çº¿ä¸‹å•**: åˆ›å»ºè®¢å•ã€é€‰æ‹©é…é€æ–¹å¼
- **å¾®ä¿¡æ”¯ä»˜**: å®‰å…¨ä¾¿æ·çš„æ”¯ä»˜ä½“éªŒ
- **è®¢å•ç®¡ç†**: æŸ¥çœ‹è®¢å•çŠ¶æ€ã€ç‰©æµè·Ÿè¸ª
- **ä¼šå‘˜ä¸­å¿ƒ**: ä¸ªäººèµ„æ–™ã€ä¼˜æƒ åˆ¸ã€ç§¯åˆ†

### 1.3 é€‚ç”¨è®¾å¤‡
- iOS 10.0+ ç³»ç»Ÿ
- Android 5.0+ ç³»ç»Ÿ
- å¾®ä¿¡ç‰ˆæœ¬ 7.0+

## 2. å°ç¨‹åºå…¥å£

### 2.1 æœç´¢è¿›å…¥
1. æ‰“å¼€å¾®ä¿¡
2. ç‚¹å‡»å³ä¸Šè§’ã€Œæœç´¢ã€å›¾æ ‡
3. è¾“å…¥å°ç¨‹åºåç§°
4. ç‚¹å‡»æœç´¢ç»“æœè¿›å…¥

### 2.2 æ‰«ç è¿›å…¥
1. ä½¿ç”¨å¾®ä¿¡ã€Œæ‰«ä¸€æ‰«ã€
2. æ‰«æå°ç¨‹åºäºŒç»´ç 
3. è‡ªåŠ¨è·³è½¬åˆ°å°ç¨‹åº

### 2.3 åˆ†äº«è¿›å…¥
1. å¥½å‹åˆ†äº«å°ç¨‹åºå¡ç‰‡
2. ç‚¹å‡»å¡ç‰‡è¿›å…¥å°ç¨‹åº
3. æˆ–é€šè¿‡å¾®ä¿¡ç¾¤åˆ†äº«è¿›å…¥

### 2.4 å†å²è®°å½•
1. å¾®ä¿¡é¦–é¡µä¸‹æ‹‰
2. æ˜¾ç¤ºæœ€è¿‘ä½¿ç”¨çš„å°ç¨‹åº
3. ç‚¹å‡»å›¾æ ‡è¿›å…¥

## 3. ç”¨æˆ·æ³¨å†Œç™»å½•

### 3.1 å¾®ä¿¡ä¸€é”®ç™»å½•
1. é¦–æ¬¡è¿›å…¥å°ç¨‹åº
2. ç‚¹å‡»ã€Œå¾®ä¿¡ä¸€é”®ç™»å½•ã€
3. è·å–å¾®ä¿¡æˆæƒ
4. è‡ªåŠ¨å®Œæˆæ³¨å†Œç™»å½•

### 3.2 æ‰‹æœºå·æ³¨å†Œ
1. ç‚¹å‡»ã€Œæ‰‹æœºå·æ³¨å†Œã€
2. è¾“å…¥æ‰‹æœºå·
3. è·å–éªŒè¯ç 
4. è®¾ç½®å¯†ç 
5. å®Œæˆæ³¨å†Œ

### 3.3 è´¦å·ç™»å½•
1. è¾“å…¥æ‰‹æœºå·/ç”¨æˆ·å
2. è¾“å…¥å¯†ç 
3. ç‚¹å‡»ã€Œç™»å½•ã€
4. å¯å‹¾é€‰ã€Œè®°ä½å¯†ç ã€

### 3.4 æ‰¾å›å¯†ç 
1. ç‚¹å‡»ã€Œå¿˜è®°å¯†ç ã€
2. è¾“å…¥æ³¨å†Œæ‰‹æœºå·
3. è·å–éªŒè¯ç 
4. è®¾ç½®æ–°å¯†ç 
5. é‡æ–°ç™»å½•

## 4. é¦–é¡µåŠŸèƒ½

### 4.1 è½®æ’­å¹¿å‘Š
- æ˜¾ç¤ºæœ€æ–°æ´»åŠ¨
- ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…
- è‡ªåŠ¨è½®æ’­åˆ‡æ¢

### 4.2 å•†å“åˆ†ç±»
1. ç‚¹å‡»åˆ†ç±»å›¾æ ‡
2. è¿›å…¥åˆ†ç±»é¡µé¢
3. æµè§ˆåˆ†ç±»å•†å“
4. å¯åˆ‡æ¢åˆ†ç±»

### 4.3 æ¨èå•†å“
- çƒ­é”€å•†å“æ¨è
- æ–°å“ä¸Šæ¶
- ç‰¹ä»·å•†å“
- ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…

### 4.4 æœç´¢åŠŸèƒ½
1. ç‚¹å‡»æœç´¢æ¡†
2. è¾“å…¥å…³é”®è¯
3. æ˜¾ç¤ºæœç´¢ç»“æœ
4. æ”¯æŒæ¨¡ç³Šæœç´¢

### 4.5 ä¼šå‘˜æƒç›Š
- æ˜¾ç¤ºä¼šå‘˜ç­‰çº§
- å½“å‰ç§¯åˆ†
- ä¼˜æƒ åˆ¸æ•°é‡
- ç‚¹å‡»è¿›å…¥ä¼šå‘˜ä¸­å¿ƒ

## 5. å•†å“æµè§ˆ

### 5.1 åˆ†ç±»æµè§ˆ
1. ç‚¹å‡»ã€Œåˆ†ç±»ã€æ ‡ç­¾
2. é€‰æ‹©å•†å“åˆ†ç±»
3. æµè§ˆå•†å“åˆ—è¡¨
4. æ”¯æŒå¤šçº§åˆ†ç±»

### 5.2 å•†å“åˆ—è¡¨
- å•†å“å›¾ç‰‡
- å•†å“åç§°
- å•†å“ä»·æ ¼
- é”€é‡æ˜¾ç¤º
- åº“å­˜çŠ¶æ€

### 5.3 æ’åºç­›é€‰
1. ç‚¹å‡»ã€Œæ’åºã€æŒ‰é’®
2. é€‰æ‹©æ’åºæ–¹å¼ï¼š
   - ç»¼åˆæ’åº
   - é”€é‡æ’åº
   - ä»·æ ¼ä»ä½åˆ°é«˜
   - ä»·æ ¼ä»é«˜åˆ°ä½
   - æ–°å“ä¼˜å…ˆ
3. ç‚¹å‡»ã€Œç­›é€‰ã€æŒ‰é’®
4. è®¾ç½®ç­›é€‰æ¡ä»¶ï¼š
   - ä»·æ ¼åŒºé—´
   - å“ç‰Œç­›é€‰
   - è§„æ ¼ç­›é€‰
   - ä¿ƒé”€æ´»åŠ¨

### 5.4 å•†å“è¯¦æƒ…
1. ç‚¹å‡»å•†å“è¿›å…¥è¯¦æƒ…é¡µ
2. æŸ¥çœ‹å•†å“ä¿¡æ¯ï¼š
   - å•†å“å›¾ç‰‡ï¼ˆå¯æ”¾å¤§ï¼‰
   - å•†å“åç§°
   - å•†å“ä»·æ ¼ï¼ˆåŸä»·/ç°ä»·ï¼‰
   - å•†å“è§„æ ¼
   - å•†å“è¯¦æƒ…ï¼ˆå›¾æ–‡ï¼‰
   - ç”¨æˆ·è¯„ä»·
3. æ“ä½œæŒ‰é’®ï¼š
   - åŠ å…¥è´­ç‰©è½¦
   - ç«‹å³è´­ä¹°
   - æ”¶è—å•†å“

## 6. è´­ç‰©æµç¨‹

### 6.1 åŠ å…¥è´­ç‰©è½¦
1. åœ¨å•†å“è¯¦æƒ…é¡µ
2. é€‰æ‹©å•†å“è§„æ ¼
3. é€‰æ‹©è´­ä¹°æ•°é‡
4. ç‚¹å‡»ã€ŒåŠ å…¥è´­ç‰©è½¦ã€
5. æç¤ºæ·»åŠ æˆåŠŸ

### 6.2 ç®¡ç†è´­ç‰©è½¦
1. ç‚¹å‡»åº•éƒ¨ã€Œè´­ç‰©è½¦ã€å›¾æ ‡
2. æŸ¥çœ‹è´­ç‰©è½¦å•†å“ï¼š
   - å•†å“å›¾ç‰‡
   - å•†å“åç§°
   - è§„æ ¼ä¿¡æ¯
   - å•ä»·
   - æ•°é‡ï¼ˆå¯ä¿®æ”¹ï¼‰
   - å°è®¡
3. æ“ä½œåŠŸèƒ½ï¼š
   - é€‰æ‹©/å–æ¶ˆé€‰æ‹©
   - ä¿®æ”¹æ•°é‡
   - åˆ é™¤å•†å“
   - æ¸…ç©ºè´­ç‰©è½¦

### 6.3 ç«‹å³è´­ä¹°
1. åœ¨å•†å“è¯¦æƒ…é¡µ
2. é€‰æ‹©è§„æ ¼å’Œæ•°é‡
3. ç‚¹å‡»ã€Œç«‹å³è´­ä¹°ã€
4. ç›´æ¥è¿›å…¥è®¢å•ç¡®è®¤é¡µ

### 6.4 ç»“ç®—è®¢å•
1. åœ¨è´­ç‰©è½¦é€‰æ‹©å•†å“
2. ç‚¹å‡»ã€Œç»“ç®—ã€
3. è¿›å…¥è®¢å•ç¡®è®¤é¡µ
4. ç¡®è®¤è®¢å•ä¿¡æ¯ï¼š
   - æ”¶è´§åœ°å€
   - å•†å“åˆ—è¡¨
   - è®¢å•å¤‡æ³¨
   - ä¼˜æƒ ä¿¡æ¯
   - é…é€æ–¹å¼
   - æ”¯ä»˜æ–¹å¼
   - è®¢å•é‡‘é¢
5. ç‚¹å‡»ã€Œæäº¤è®¢å•ã€

## 7. è®¢å•ç®¡ç†

### 7.1 è®¢å•çŠ¶æ€
| çŠ¶æ€ | è¯´æ˜ | å¯æ“ä½œ |
|------|------|--------|
| å¾…ä»˜æ¬¾ | è®¢å•å·²åˆ›å»ºï¼Œç­‰å¾…æ”¯ä»˜ | æ”¯ä»˜ã€å–æ¶ˆ |
| å¾…å‘è´§ | å·²ä»˜æ¬¾ï¼Œç­‰å¾…å•†å®¶å‘è´§ | æŸ¥çœ‹ã€è”ç³»å®¢æœ |
| å¾…æ”¶è´§ | å·²å‘è´§ï¼Œè¿è¾“ä¸­ | æŸ¥çœ‹ç‰©æµã€ç¡®è®¤æ”¶è´§ |
| å·²å®Œæˆ | å·²ç¡®è®¤æ”¶è´§ | è¯„ä»·ã€å†æ¬¡è´­ä¹° |
| å·²å–æ¶ˆ | è®¢å•å·²å–æ¶ˆ | åˆ é™¤è®¢å• |
| é€€æ¬¾ä¸­ | ç”³è¯·é€€æ¬¾å¤„ç†ä¸­ | æŸ¥çœ‹é€€æ¬¾è¿›åº¦ |

### 7.2 æŸ¥çœ‹è®¢å•
1. ç‚¹å‡»ã€Œæˆ‘çš„ã€â†’ã€Œæˆ‘çš„è®¢å•ã€
2. æŸ¥çœ‹è®¢å•åˆ—è¡¨ï¼š
   - è®¢å•å·
   - ä¸‹å•æ—¶é—´
   - è®¢å•çŠ¶æ€
   - è®¢å•é‡‘é¢
   - å•†å“ä¿¡æ¯
3. ç‚¹å‡»è®¢å•æŸ¥çœ‹è¯¦æƒ…

### 7.3 è®¢å•è¯¦æƒ…
- è®¢å•åŸºæœ¬ä¿¡æ¯
- æ”¶è´§åœ°å€
- å•†å“æ˜ç»†
- ä»·æ ¼æ˜ç»†
- æ”¯ä»˜ä¿¡æ¯
- ç‰©æµä¿¡æ¯
- å”®åä¿¡æ¯

### 7.4 è®¢å•æ“ä½œ

#### 7.4.1 å–æ¶ˆè®¢å•
1. æ‰¾åˆ°ã€Œå¾…ä»˜æ¬¾ã€è®¢å•
2. ç‚¹å‡»ã€Œå–æ¶ˆè®¢å•ã€
3. é€‰æ‹©å–æ¶ˆåŸå› 
4. ç¡®è®¤å–æ¶ˆ

#### 7.4.2 ç¡®è®¤æ”¶è´§
1. æ‰¾åˆ°ã€Œå¾…æ”¶è´§ã€è®¢å•
2. ç‚¹å‡»ã€Œç¡®è®¤æ”¶è´§ã€
3. ç¡®è®¤æ”¶åˆ°å•†å“
4. è®¢å•çŠ¶æ€å˜æ›´ä¸ºã€Œå·²å®Œæˆã€

#### 7.4.3 åˆ é™¤è®¢å•
1. æ‰¾åˆ°ã€Œå·²å–æ¶ˆã€æˆ–ã€Œå·²å®Œæˆã€è®¢å•
2. ç‚¹å‡»ã€Œåˆ é™¤è®¢å•ã€
3. ç¡®è®¤åˆ é™¤
4. ä»åˆ—è¡¨ç§»é™¤

## 8. æ”¯ä»˜æµç¨‹

### 8.1 é€‰æ‹©æ”¯ä»˜æ–¹å¼
1. æäº¤è®¢å•åè¿›å…¥æ”¯ä»˜é¡µé¢
2. é€‰æ‹©æ”¯ä»˜æ–¹å¼ï¼š
   - å¾®ä¿¡æ”¯ä»˜
   - ä½™é¢æ”¯ä»˜
   - è´§åˆ°ä»˜æ¬¾ï¼ˆå¦‚æ”¯æŒï¼‰
3. ç‚¹å‡»ã€Œç«‹å³æ”¯ä»˜ã€

### 8.2 å¾®ä¿¡æ”¯ä»˜
1. ç‚¹å‡»ã€Œå¾®ä¿¡æ”¯ä»˜ã€
2. è°ƒç”¨å¾®ä¿¡æ”¯ä»˜æ¥å£
3. è¾“å…¥æ”¯ä»˜å¯†ç 
4. æ”¯ä»˜æˆåŠŸ
5. è‡ªåŠ¨è·³è½¬æ”¯ä»˜æˆåŠŸé¡µé¢

### 8.3 æ”¯ä»˜ç»“æœ
- **æ”¯ä»˜æˆåŠŸ**: è·³è½¬æˆåŠŸé¡µé¢ï¼Œæ˜¾ç¤ºè®¢å•ä¿¡æ¯
- **æ”¯ä»˜å¤±è´¥**: æ˜¾ç¤ºå¤±è´¥åŸå› ï¼Œå¯é€‰æ‹©é‡æ–°æ”¯ä»˜
- **æ”¯ä»˜å–æ¶ˆ**: è¿”å›è®¢å•é¡µé¢ï¼Œå¯é‡æ–°æ”¯ä»˜æˆ–å–æ¶ˆè®¢å•

### 8.4 æ”¯ä»˜å®‰å…¨æç¤º
1. è¯·å‹¿æ³„éœ²æ”¯ä»˜å¯†ç 
2. ç¡®è®¤å•†æˆ·åç§°æ­£ç¡®
3. æ ¸å¯¹æ”¯ä»˜é‡‘é¢
4. åœ¨å®‰å…¨ç½‘ç»œç¯å¢ƒä¸‹æ”¯ä»˜

## 9. ä¼šå‘˜ä¸­å¿ƒ

### 9.1 ä¸ªäººèµ„æ–™
1. ç‚¹å‡»ã€Œæˆ‘çš„ã€è¿›å…¥ä¸ªäººä¸­å¿ƒ
2. ç‚¹å‡»å¤´åƒæˆ–ç”¨æˆ·å
3. ç¼–è¾‘ä¸ªäººä¿¡æ¯ï¼š
   - å¤´åƒ
   - æ˜µç§°
   - æ€§åˆ«
   - ç”Ÿæ—¥
   - åœ°åŒº
4. ç‚¹å‡»ã€Œä¿å­˜ã€

### 9.2 æ”¶è´§åœ°å€ç®¡ç†
1. ç‚¹å‡»ã€Œæˆ‘çš„åœ°å€ã€
2. æŸ¥çœ‹åœ°å€åˆ—è¡¨
3. æ“ä½œåŠŸèƒ½ï¼š
   - æ·»åŠ æ–°åœ°å€
   - ç¼–è¾‘åœ°å€
   - åˆ é™¤åœ°å€
   - è®¾ç½®é»˜è®¤åœ°å€
4. åœ°å€ä¿¡æ¯ï¼š
   - æ”¶è´§äºº
   - æ‰‹æœºå·
   - æ‰€åœ¨åœ°åŒº
   - è¯¦ç»†åœ°å€
   - é—¨ç‰Œå·
   - åœ°å€æ ‡ç­¾ï¼ˆå®¶/å…¬å¸/å­¦æ ¡ï¼‰

### 9.3 æˆ‘çš„ä¼˜æƒ åˆ¸
1. ç‚¹å‡»ã€Œæˆ‘çš„ä¼˜æƒ åˆ¸ã€
2. æŸ¥çœ‹ä¼˜æƒ åˆ¸åˆ—è¡¨ï¼š
   - å¯ç”¨ä¼˜æƒ åˆ¸
   - å·²ä½¿ç”¨ä¼˜æƒ åˆ¸
   - å·²è¿‡æœŸä¼˜æƒ åˆ¸
3. ä¼˜æƒ åˆ¸ä¿¡æ¯ï¼š
   - ä¼˜æƒ åˆ¸åç§°
   - ä½¿ç”¨æ¡ä»¶
   - ä¼˜æƒ é‡‘é¢
   - æœ‰æ•ˆæœŸ
   - ä½¿ç”¨çŠ¶æ€

### 9.4 æˆ‘çš„ç§¯åˆ†
1. ç‚¹å‡»ã€Œæˆ‘çš„ç§¯åˆ†ã€
2. æŸ¥çœ‹ç§¯åˆ†ä¿¡æ¯ï¼š
   - å½“å‰ç§¯åˆ†
   - ç§¯åˆ†æ˜ç»†
   - ç§¯åˆ†è§„åˆ™
   - ç§¯åˆ†å…‘æ¢
3. ç§¯åˆ†è·å–ï¼š
   - è´­ç‰©æ¶ˆè´¹
   - æ¯æ—¥ç­¾åˆ°
   - æ´»åŠ¨å¥–åŠ±
   - è¯„ä»·å•†å“

### 9.5 æˆ‘çš„æ”¶è—
1. ç‚¹å‡»ã€Œæˆ‘çš„æ”¶è—ã€
2. æŸ¥çœ‹æ”¶è—å•†å“
3. æ“ä½œåŠŸèƒ½ï¼š
   - å–æ¶ˆæ”¶è—
   - åŠ å…¥è´­ç‰©è½¦
   - ç«‹å³è´­ä¹°

## 10. å®¢æˆ·æœåŠ¡

### 10.1 åœ¨çº¿å®¢æœ
1. ç‚¹å‡»ã€Œå®¢æœã€æŒ‰é’®
2. è¿›å…¥å®¢æœå¯¹è¯ç•Œé¢
3. è¾“å…¥é—®é¢˜
4. å®¢æœå›å¤
5. æ”¯æŒå‘é€å›¾ç‰‡

### 10.2 å¸¸è§é—®é¢˜
1. ç‚¹å‡»ã€Œå¸®åŠ©ä¸­å¿ƒã€
2. æŸ¥çœ‹å¸¸è§é—®é¢˜åˆ†ç±»ï¼š
   - è´­ç‰©æµç¨‹
   - æ”¯ä»˜é—®é¢˜
   - ç‰©æµé…é€
   - å”®åæ”¿ç­–
   - ä¼šå‘˜é—®é¢˜
3. ç‚¹å‡»é—®é¢˜æŸ¥çœ‹ç­”æ¡ˆ

### 10.3 æ„è§åé¦ˆ
1. ç‚¹å‡»ã€Œæ„è§åé¦ˆã€
2. é€‰æ‹©åé¦ˆç±»å‹
3. æè¿°é—®é¢˜è¯¦æƒ…
4. ä¸Šä¼ æˆªå›¾ï¼ˆå¯é€‰ï¼‰
5. æäº¤åé¦ˆ
6. æŸ¥çœ‹åé¦ˆè¿›åº¦

### 10.4 æŠ•è¯‰å»ºè®®
1. ç‚¹å‡»ã€ŒæŠ•è¯‰å»ºè®®ã€
2. é€‰æ‹©æŠ•è¯‰ç±»å‹
3. å¡«å†™è¯¦ç»†ä¿¡æ¯
4. æäº¤æŠ•è¯‰
5. å®¢æœä¼šè”ç³»å¤„ç†

## 11. è®¾ç½®åŠŸèƒ½

### 11.1 æ¶ˆæ¯é€šçŸ¥
1. ç‚¹å‡»ã€Œè®¾ç½®ã€â†’ã€Œæ¶ˆæ¯é€šçŸ¥ã€
2. è®¾ç½®é€šçŸ¥ç±»å‹ï¼š
   - è®¢å•çŠ¶æ€é€šçŸ¥
   - ä¿ƒé”€æ´»åŠ¨é€šçŸ¥
   - ç³»ç»Ÿæ¶ˆæ¯é€šçŸ¥
3. é€‰æ‹©é€šçŸ¥æ–¹å¼ï¼š
   - å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯
   - å°ç¨‹åºè®¢é˜…æ¶ˆæ¯

### 11.2 éšç§è®¾ç½®
1. ç‚¹å‡»ã€Œè®¾ç½®ã€â†’ã€Œéšç§è®¾ç½®ã€
2. è®¾ç½®éšç§é€‰é¡¹ï¼š
   - ä¸ªäººä¿¡æ¯å¯è§æ€§
   - è´­ä¹°è®°å½•éšç§
   - æ”¶è—åˆ—è¡¨éšç§
3. ç®¡ç†æˆæƒï¼š
   - ä½ç½®æƒé™
   - ç›¸å†Œæƒé™
   - ç›¸æœºæƒé™

### 11.3 æ¸…é™¤ç¼“å­˜
1. ç‚¹å‡»ã€Œè®¾ç½®ã€â†’ã€Œæ¸…é™¤ç¼“å­˜ã€
2. é€‰æ‹©æ¸…é™¤å†…å®¹ï¼š
   - å›¾ç‰‡ç¼“å­˜
   - æµè§ˆè®°å½•
   - æœç´¢å†å²
   - ç™»å½•çŠ¶æ€
3. ç‚¹å‡»ã€Œç¡®è®¤æ¸…é™¤ã€

### 11.4 å…³äºæˆ‘ä»¬
- å…¬å¸ç®€ä»‹
- è”ç³»æ–¹å¼
- ç”¨æˆ·åè®®
- éšç§æ”¿ç­–
- ç‰ˆæœ¬ä¿¡æ¯

## 12. å¸¸è§é—®é¢˜

### 12.1 ç™»å½•é—®é¢˜

#### Q1: æ— æ³•å¾®ä¿¡ç™»å½•
A:
1. æ£€æŸ¥å¾®ä¿¡ç‰ˆæœ¬æ˜¯å¦è¿‡æ—§
2. æ£€æŸ¥ç½‘ç»œè¿æ¥
3. é‡å¯å¾®ä¿¡åé‡è¯•
4. è”ç³»å®¢æœå¤„ç†

#### Q2: å¿˜è®°å¯†ç 
A:
1. ç‚¹å‡»ã€Œå¿˜è®°å¯†ç ã€
2. é€šè¿‡æ‰‹æœºå·æ‰¾å›
3. é‡æ–°è®¾ç½®å¯†ç 
4. ä½¿ç”¨æ–°å¯†ç ç™»å½•

### 12.2 æ”¯ä»˜é—®é¢˜

#### Q1: æ”¯ä»˜å¤±è´¥
A:
1. æ£€æŸ¥å¾®ä¿¡æ”¯ä»˜ä½™é¢
2. æ£€æŸ¥é“¶è¡Œå¡çŠ¶æ€
3. é‡æ–°å‘èµ·æ”¯ä»˜
4. è”ç³»å¾®ä¿¡æ”¯ä»˜å®¢æœ

#### Q2: é‡å¤æ‰£æ¬¾
A:
1. ä¸è¦é‡å¤æ”¯ä»˜
2. æŸ¥çœ‹è®¢å•çŠ¶æ€
3. è”ç³»å®¢æœé€€æ¬¾
4. æä¾›æ”¯ä»˜å‡­è¯

### 12.3 è®¢å•é—®é¢˜

#### Q1: è®¢å•çŠ¶æ€æœªæ›´æ–°
A:
1. ç­‰å¾…ç³»ç»ŸåŒæ­¥
2. ä¸‹æ‹‰åˆ·æ–°é¡µé¢
3. é€€å‡ºé‡æ–°ç™»å½•
4. è”ç³»å®¢æœæŸ¥è¯¢

#### Q2: éœ€è¦ä¿®æ”¹è®¢å•
A:
1. è®¢å•çŠ¶æ€ä¸ºã€Œå¾…ä»˜æ¬¾ã€æ—¶å¯å–æ¶ˆé‡ä¸‹
2. å…¶ä»–çŠ¶æ€è”ç³»å®¢æœå¤„ç†
3. æä¾›è®¢å•å·å’Œä¿®æ”¹éœ€æ±‚

### 12.4 ç‰©æµé—®é¢˜

#### Q1: ç‰©æµä¿¡æ¯ä¸æ›´æ–°
A:
1. ç‰©æµå…¬å¸å¯èƒ½æœªåŠæ—¶æ›´æ–°
2. ç­‰å¾…1-2å¤©å†æŸ¥çœ‹
3. è”ç³»å•†å®¶æŸ¥è¯¢
4. è”ç³»ç‰©æµå…¬å¸

#### Q2: å¿«é€’ä¸¢å¤±æˆ–æŸå
A:
1. è”ç³»å•†å®¶å®¢æœ
2. æä¾›è®¢å•ä¿¡æ¯å’Œç…§ç‰‡
3. å•†å®¶ååŠ©å¤„ç†
4. ç”³è¯·é€€æ¬¾æˆ–è¡¥å‘

## 13. å®‰å…¨æç¤º

### 13.1 è´¦å·å®‰å…¨
1. è®¾ç½®å¤æ‚å¯†ç 
2. ä¸é€éœ²è´¦å·å¯†ç 
3. å®šæœŸä¿®æ”¹å¯†ç 
4. ä¸åœ¨å…¬å…±è®¾å¤‡ç™»å½•

### 13.2 æ”¯ä»˜å®‰å…¨
1. ç¡®è®¤æ”¯ä»˜ç¯å¢ƒå®‰å…¨
2. æ ¸å¯¹æ”¯ä»˜é‡‘é¢å’Œå•†æˆ·
3. åŠæ—¶å…³é—­æ”¯ä»˜é¡µé¢
4. å®šæœŸæ£€æŸ¥è´¦å•

### 13.3 ä¸ªäººä¿¡æ¯ä¿æŠ¤
1. è°¨æ…å¡«å†™ä¸ªäººä¿¡æ¯
2. ä¸éšæ„æˆæƒæƒé™
3. å®šæœŸæ¸…ç†ç¼“å­˜
4. æ³¨æ„éšç§è®¾ç½®

## 14. é™„å½•

### 14.1 å°ç¨‹åºç 
![å°ç¨‹åºç ](https://example.com/miniprogram-qrcode.png)
*ä½¿ç”¨å¾®ä¿¡æ‰«ä¸€æ‰«è¿›å…¥å°ç¨‹åº*

### 14.2 å®¢æœæ—¶é—´
- å·¥ä½œæ—¥ï¼š9:00-21:00
- å‘¨æœ«ï¼š10:00-18:00
- èŠ‚å‡æ—¥ï¼š10:00-17:00

### 14.3 è”ç³»æ–¹å¼
- å®¢æœç”µè¯ï¼š400-XXX-XXXX
- å®¢æœå¾®ä¿¡ï¼šservice-account
- å®¢æœé‚®ç®±ï¼šservice@example.com
- å…¬å¸åœ°å€ï¼šXXçœXXå¸‚XXåŒºXXè·¯XXå·

### 14.4 ç‰ˆæœ¬æ›´æ–°
| ç‰ˆæœ¬ | æ›´æ–°æ—¥æœŸ | æ›´æ–°å†…å®¹ |
|------|----------|----------|
| v1.0 | 2024-01-01 | åˆå§‹ç‰ˆæœ¬ï¼ŒåŸºç¡€åŠŸèƒ½ |
| v1.1 | 2024-02-01 | ä¼˜åŒ–æ”¯ä»˜æµç¨‹ï¼Œå¢åŠ ä¼šå‘˜åŠŸèƒ½ |
| v1.2 | 2024-03-01 | å¢åŠ å®¢æœç³»ç»Ÿï¼Œä¼˜åŒ–ç•Œé¢ |

---

*æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.0*
*æœ€åæ›´æ–°ï¼š{å½“å‰æ—¥æœŸ}*
*ç»´æŠ¤å›¢é˜Ÿï¼šäº§å“å›¢é˜Ÿ*
"""

    def create_all_documentation(self):
        """åˆ›å»ºæ‰€æœ‰æ–‡æ¡£"""
        print("=" * 60)
        print("ğŸ“š åˆ›å»ºé¡¹ç›®æ–‡æ¡£ä½“ç³»")
        print("=" * 60)
        
        self.create_documentation_structure()
        
        # ç”ŸæˆREADMEæ–‡ä»¶
        readme_content = self._generate_readme()
        readme_path = self.project_root / "README.md"
        readme_path.write_text(readme_content)
        print(f"\nğŸ“„ README.md - é¡¹ç›®è¯´æ˜æ–‡æ¡£")
        
        # ç”ŸæˆCHANGELOGæ–‡ä»¶
        changelog_content = self._generate_changelog()
        changelog_path = self.project_root / "CHANGELOG.md"
        changelog_path.write_text(changelog_content)
        print(f"ğŸ“„ CHANGELOG.md - ç‰ˆæœ¬å˜æ›´è®°å½•")
        
        print("\nâœ… æ–‡æ¡£åˆ›å»ºå®Œæˆï¼")
    
    def _generate_readme(self):
        """ç”ŸæˆREADMEæ–‡ä»¶"""
        return """# Odoo 19 å¾®ä¿¡æ”¯ä»˜ä¸ç”Ÿæ€ç³»ç»Ÿé›†æˆé¡¹ç›®

## ğŸ“‹ é¡¹ç›®ç®€ä»‹

æœ¬é¡¹ç›®æ˜¯åŸºäºOdoo 19å¼€å‘çš„å®Œæ•´æ”¯ä»˜ä¸å¾®ä¿¡ç”Ÿæ€ç³»ç»Ÿé›†æˆè§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š

- **å¾®ä¿¡æ”¯ä»˜**: æ‰«ç æ”¯ä»˜ã€JSAPIæ”¯ä»˜ã€å°ç¨‹åºæ”¯ä»˜
- **æ”¯ä»˜å®æ”¯ä»˜**: å¿«é€Ÿç»“è´¦ã€æ‰«ç æ”¯ä»˜
- **äº‘é—ªä»˜æ”¯ä»˜**: APPæ”¯ä»˜ã€æ‰«ç æ”¯ä»˜
- **å¾®ä¿¡å…¬ä¼—å·ç®¡ç†å¹³å°**: ç²‰ä¸ç®¡ç†ã€æ¶ˆæ¯å›å¤ã€èœå•ç®¡ç†
- **å¾®ä¿¡å°ç¨‹åºåç«¯**: å•†å“å±•ç¤ºã€è®¢å•ç®¡ç†ã€ç”¨æˆ·ä¸­å¿ƒ

## ğŸš€ ä¸»è¦ç‰¹æ€§

### ğŸ’° æ”¯ä»˜åŠŸèƒ½
- æ”¯æŒå¾®ä¿¡ã€æ”¯ä»˜å®ã€äº‘é—ªä»˜å¤šæ¸ é“æ”¯ä»˜
- å®Œæ•´çš„æ”¯ä»˜æµç¨‹ï¼šä¸‹å•â†’æ”¯ä»˜â†’å›è°ƒâ†’å¯¹è´¦
- POSæ”¶é“¶ç³»ç»Ÿé›†æˆ
- å®‰å…¨åˆè§„çš„æ”¯ä»˜å¤„ç†

### ğŸ“± å¾®ä¿¡ç”Ÿæ€é›†æˆ
- å…¬ä¼—å·ç²‰ä¸ç®¡ç†å’ŒåŒæ­¥
- æ¶ˆæ¯è‡ªåŠ¨å›å¤å’Œæ¨¡æ¿æ¶ˆæ¯
- å°ç¨‹åºåç«¯APIæ”¯æŒ
- ç»Ÿä¸€çš„ç”¨æˆ·èº«ä»½ç®¡ç†

### ğŸ› ï¸ æŠ€æœ¯ä¼˜åŠ¿
- åŸºäºOdoo 19æœ€æ–°æ¡†æ¶å¼€å‘
- æ¨¡å—åŒ–è®¾è®¡ï¼Œå¯ç‹¬ç«‹éƒ¨ç½²
- æ”¯æŒé«˜å¹¶å‘æ”¯ä»˜å¤„ç†
- å®Œæ•´çš„å®‰å…¨å®¡è®¡å’Œåˆè§„æ”¯æŒ

## ğŸ“ é¡¹ç›®ç»“æ„

```
odoo19-wechat-payment/
â”œâ”€â”€ payment_wechat/           # å¾®ä¿¡æ”¯ä»˜æ ¸å¿ƒæ¨¡å—
â”œâ”€â”€ payment_alipay/          # æ”¯ä»˜å®æ”¯ä»˜æ¨¡å—
â”œâ”€â”€ payment_unionpay/        # äº‘é—ªä»˜æ”¯ä»˜æ¨¡å—
â”œâ”€â”€ wechat_common/           # å¾®ä¿¡å…¬å…±å·¥å…·æ¨¡å—
â”œâ”€â”€ wechat_platform/         # å¾®ä¿¡å…¬ä¼—å·ç®¡ç†å¹³å°
â”œâ”€â”€ wechat_miniprogram/      # å¾®ä¿¡å°ç¨‹åºåç«¯
â”œâ”€â”€ pos_payment_wechat/      # POSå¾®ä¿¡æ”¯ä»˜é›†æˆ
â”œâ”€â”€ docs/                    # é¡¹ç›®æ–‡æ¡£
â”œâ”€â”€ tests/                   # æµ‹è¯•ç”¨ä¾‹
â”œâ”€â”€ scripts/                 # éƒ¨ç½²è„šæœ¬
â””â”€â”€ requirements.txt         # Pythonä¾èµ–
```

## ğŸ› ï¸ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚
- Odoo 19.0+
- Python 3.10+
- PostgreSQL 14+
- Redis 6.0+ (æ¨è)

### å®‰è£…æ­¥éª¤

1. **å…‹éš†é¡¹ç›®**
   ```bash
   git clone https://github.com/your-company/odoo19-wechat-payment.git
   cd odoo19-wechat-payment
   ```

2. **å®‰è£…ä¾èµ–**
   ```bash
   pip install -r requirements.txt
   ```

3. **é…ç½®Odoo**
   - å°†æ¨¡å—ç›®å½•æ·»åŠ åˆ°Odooçš„addonsè·¯å¾„
   - é…ç½®æ•°æ®åº“è¿æ¥
   - è®¾ç½®æ”¯ä»˜å‚æ•°

4. **å®‰è£…æ¨¡å—**
   - é€šè¿‡Odooåº”ç”¨èœå•å®‰è£…æ¨¡å—
   - æˆ–ä½¿ç”¨å‘½ä»¤è¡Œå®‰è£…

5. **é…ç½®æ”¯ä»˜æ¸ é“**
   - é…ç½®å¾®ä¿¡æ”¯ä»˜å•†æˆ·ä¿¡æ¯
   - é…ç½®æ”¯ä»˜å®å•†æˆ·ä¿¡æ¯
   - æµ‹è¯•æ”¯ä»˜æµç¨‹

è¯¦ç»†éƒ¨ç½²æŒ‡å—è§ [docs/éƒ¨ç½²è¿ç»´æ‰‹å†Œ.md](docs/éƒ¨ç½²è¿ç»´æ‰‹å†Œ.md)

## ğŸ“– æ–‡æ¡£

å®Œæ•´æ–‡æ¡£ä½äº `docs/` ç›®å½•ï¼š

- **[æŠ€æœ¯æ–‡æ¡£](docs/æŠ€æœ¯æ–‡æ¡£/)**
  - [ç³»ç»Ÿæ¶æ„è®¾è®¡æ–‡æ¡£](docs/æŠ€æœ¯æ–‡æ¡£/01-ç³»ç»Ÿæ¶æ„è®¾è®¡æ–‡æ¡£.md)
  - [æ•°æ®åº“è®¾è®¡æ–‡æ¡£](docs/æŠ€æœ¯æ–‡æ¡£/02-æ•°æ®åº“è®¾è®¡æ–‡æ¡£.md)
  - [APIæ¥å£æ–‡æ¡£](docs/æŠ€æœ¯æ–‡æ¡£/03-APIæ¥å£æ–‡æ¡£.md)
  - [éƒ¨ç½²è¿ç»´æ‰‹å†Œ](docs/æŠ€æœ¯æ–‡æ¡£/04-éƒ¨ç½²è¿ç»´æ‰‹å†Œ.md)
  - [å®‰å…¨åˆè§„æ–‡æ¡£](docs/æŠ€æœ¯æ–‡æ¡£/05-å®‰å…¨åˆè§„æ–‡æ¡£.md)

- **[ç”¨æˆ·æ–‡æ¡£](docs/ç”¨æˆ·æ–‡æ¡£/)**
  - [ç³»ç»Ÿç®¡ç†å‘˜æ‰‹å†Œ](docs/ç”¨æˆ·æ–‡æ¡£/01-ç³»ç»Ÿç®¡ç†å‘˜æ‰‹å†Œ.md)
  - [ç»ˆç«¯ç”¨æˆ·æ“ä½œæŒ‡å—](docs/ç”¨æˆ·æ–‡æ¡£/02-ç»ˆç«¯ç”¨æˆ·æ“ä½œæŒ‡å—.md)
  - [POSæ”¶é“¶å‘˜æ‰‹å†Œ](docs/ç”¨æˆ·æ–‡æ¡£/03-POSæ”¶é“¶å‘˜æ‰‹å†Œ.md)
  - [å°ç¨‹åºä½¿ç”¨è¯´æ˜](docs/ç”¨æˆ·æ–‡æ¡£/04-å°ç¨‹åºä½¿ç”¨è¯´æ˜.md)

- **[å¼€å‘æ–‡æ¡£](docs/å¼€å‘æ–‡æ¡£/)**
  - [å¼€å‘ç¯å¢ƒæ­å»º](docs/å¼€å‘æ–‡æ¡£/01-å¼€å‘ç¯å¢ƒæ­å»º.md)
  - [æ¨¡å—å¼€å‘æŒ‡å—](docs/å¼€å‘æ–‡æ¡£/02-æ¨¡å—å¼€å‘æŒ‡å—.md)
  - [ä»£ç è§„èŒƒ](docs/å¼€å‘æ–‡æ¡£/03-ä»£ç è§„èŒƒ.md)
  - [æµ‹è¯•æŒ‡å—](docs/å¼€å‘æ–‡æ¡£/04-æµ‹è¯•æŒ‡å—.md)
  - [è´¡çŒ®æŒ‡å—](docs/å¼€å‘æ–‡æ¡£/05-è´¡çŒ®æŒ‡å—.md)

- **[APIæ–‡æ¡£](docs/APIæ–‡æ¡£/)**
  - [å¾®ä¿¡æ”¯ä»˜API](docs/APIæ–‡æ¡£/01-å¾®ä¿¡æ”¯ä»˜API.md)
  - [æ”¯ä»˜å®æ”¯ä»˜API](docs/APIæ–‡æ¡£/02-æ”¯ä»˜å®æ”¯ä»˜API.md)
  - [å¾®ä¿¡å…¬ä¼—å·API](docs/APIæ–‡æ¡£/03-å¾®ä¿¡å…¬ä¼—å·API.md)
  - [å°ç¨‹åºåç«¯API](docs/APIæ–‡æ¡£/04-å°ç¨‹åºåç«¯API.md)
  - [ç»Ÿä¸€æ”¯ä»˜ç®¡ç†API](docs/APIæ–‡æ¡£/05-ç»Ÿä¸€æ”¯ä»˜ç®¡ç†API.md)

## ğŸ§ª æµ‹è¯•

### è¿è¡Œæµ‹è¯•
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
python -m pytest

# è¿è¡Œç‰¹å®šæ¨¡å—æµ‹è¯•
python -m pytest payment_wechat/tests/

# ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
python -m pytest --html=report.html --self-contained-html
```

### æµ‹è¯•è¦†ç›–
- å•å…ƒæµ‹è¯•: æ¨¡å‹ã€å·¥å…·å‡½æ•°
- é›†æˆæµ‹è¯•: æ”¯ä»˜æµç¨‹ã€APIæ¥å£
- æ€§èƒ½æµ‹è¯•: é«˜å¹¶å‘æ”¯ä»˜æµ‹è¯•
- å®‰å…¨æµ‹è¯•: æ”¯ä»˜å®‰å…¨ã€æ•°æ®å®‰å…¨

## ğŸ”§ å¼€å‘æŒ‡å—

### ä»£ç è§„èŒƒ
- éµå¾ªPEP 8ç¼–ç è§„èŒƒ
- ä½¿ç”¨Blackä»£ç æ ¼å¼åŒ–
- ç¼–å†™å®Œæ•´çš„æ–‡æ¡£å­—ç¬¦ä¸²
- æ·»åŠ ç±»å‹æç¤º

### æ¨¡å—å¼€å‘
1. ç»§æ‰¿Odooçš„payment.provideræ¨¡å‹
2. å®ç°æ”¯ä»˜æµç¨‹æ¥å£
3. æ·»åŠ å¿…è¦çš„è§†å›¾å’Œèœå•
4. ç¼–å†™æµ‹è¯•ç”¨ä¾‹
5. æ›´æ–°æ–‡æ¡£

è¯¦ç»†å¼€å‘æŒ‡å—è§ [docs/å¼€å‘æ–‡æ¡£/02-æ¨¡å—å¼€å‘æŒ‡å—.md](docs/å¼€å‘æ–‡æ¡£/02-æ¨¡å—å¼€å‘æŒ‡å—.md)

## ğŸ¤ è´¡çŒ®æŒ‡å—

æˆ‘ä»¬æ¬¢è¿å„ç§å½¢å¼çš„è´¡çŒ®ï¼

### æŠ¥å‘Šé—®é¢˜
- ä½¿ç”¨GitHub IssuesæŠ¥å‘Šbug
- æä¾›è¯¦ç»†çš„é‡ç°æ­¥éª¤
- åŒ…æ‹¬ç›¸å…³çš„æ—¥å¿—ä¿¡æ¯

### æäº¤ä»£ç 
1. Forké¡¹ç›®ä»“åº“
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. å‘èµ·Pull Request

### å¼€å‘æµç¨‹
1. é˜…è¯»å¼€å‘æ–‡æ¡£
2. è®¾ç½®å¼€å‘ç¯å¢ƒ
3. ç¼–å†™ä»£ç å’Œæµ‹è¯•
4. ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡
5. æ›´æ–°ç›¸å…³æ–‡æ¡£

## ğŸ“ æ”¯æŒ

### æŠ€æœ¯æ”¯æŒ
- ğŸ“§ é‚®ç®±: support@example.com
- ğŸ“± ç”µè¯: 400-XXX-XXXX
- ğŸ’¬ å¾®ä¿¡å®¢æœ: wechat-support

### ç¤¾åŒºæ”¯æŒ
- ğŸ“š æ–‡æ¡£: https://docs.example.com
- ğŸ’¬ è®ºå›: https://forum.example.com
- ğŸ› Issues: GitHub Issues

### å•†ä¸šæ”¯æŒ
- ğŸ¢ ä¼ä¸šå®šåˆ¶å¼€å‘
- ğŸ›¡ï¸ æŠ€æœ¯æ”¯æŒæœåŠ¡
- ğŸ“ åŸ¹è®­æœåŠ¡

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

## ğŸ™ è‡´è°¢

æ„Ÿè°¢ä»¥ä¸‹å¼€æºé¡¹ç›®çš„è´¡çŒ®ï¼š
- [Odoo](https://www.odoo.com) - ä¼ä¸šçº§ERPæ¡†æ¶
- [wechatpy](https://github.com/wechatpy/wechatpy) - å¾®ä¿¡SDK
- [python-alipay-sdk](https://github.com/fzlee/alipay) - æ”¯ä»˜å®SDK

## ğŸ“ˆ é¡¹ç›®çŠ¶æ€

| æ¨¡å— | çŠ¶æ€ | ç‰ˆæœ¬ |
|------|------|------|
| payment_wechat | âœ… å®Œæˆ | v1.0 |
| payment_alipay | âœ… å®Œæˆ | v1.0 |
| payment_unionpay | âœ… å®Œæˆ | v1.0 |
| wechat_common | âœ… å®Œæˆ | v1.0 |
| wechat_platform | âœ… å®Œæˆ | v1.0 |
| wechat_miniprogram | âœ… å®Œæˆ | v1.0 |
| pos_payment_wechat | âœ… å®Œæˆ | v1.0 |

**æœ€æ–°ç‰ˆæœ¬**: v1.0.0 (2024-01-01)

---

*Made with â¤ï¸ by Odooå¼€å‘å›¢é˜Ÿ*
"""

    def _generate_changelog(self):
        """ç”ŸæˆCHANGELOGæ–‡ä»¶"""
        return """# æ›´æ–°æ—¥å¿—

æ‰€æœ‰é‡è¦çš„å˜æ›´éƒ½ä¼šè®°å½•åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ã€‚

æ ¼å¼åŸºäº [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)ï¼Œ
å¹¶ä¸”æœ¬é¡¹ç›®éµå¾ª [è¯­ä¹‰åŒ–ç‰ˆæœ¬](https://semver.org/lang/zh-CN/)ã€‚

## [1.0.0] - 2024-01-01

### æ–°å¢
- **å¾®ä¿¡æ”¯ä»˜æ¨¡å—** (`payment_wechat`)
  - æ‰«ç æ”¯ä»˜ï¼ˆNativeï¼‰åŠŸèƒ½
  - JSAPIæ”¯ä»˜ï¼ˆå¾®ä¿¡å†…æ”¯ä»˜ï¼‰
  - å°ç¨‹åºæ”¯ä»˜
  - é€€æ¬¾åŠŸèƒ½
  - äº¤æ˜“æŸ¥è¯¢

- **æ”¯ä»˜å®æ”¯ä»˜æ¨¡å—** (`payment_alipay`)
  - å¿«é€Ÿç»“è´¦åŠŸèƒ½
  - æ‰«ç æ”¯ä»˜
  - å¼‚æ­¥å›è°ƒå¤„ç†
  - é€€æ¬¾æ¥å£

- **äº‘é—ªä»˜æ”¯ä»˜æ¨¡å—** (`payment_unionpay`)
  - APPæ”¯ä»˜
  - æ‰«ç æ”¯ä»˜
  - è¯ä¹¦ç®¡ç†
  - äº¤æ˜“æŸ¥è¯¢

- **å¾®ä¿¡å…¬ä¼—å·ç®¡ç†å¹³å°** (`wechat_platform`)
  - å…¬ä¼—å·é…ç½®ç®¡ç†
  - ç²‰ä¸ç®¡ç†å’ŒåŒæ­¥
  - æ¶ˆæ¯è‡ªåŠ¨å›å¤
  - è‡ªå®šä¹‰èœå•ç®¡ç†
  - ç´ æç®¡ç†

- **å¾®ä¿¡å°ç¨‹åºåç«¯** (`wechat_miniprogram`)
  - å°ç¨‹åºç™»å½•è®¤è¯
  - å•†å“APIæ¥å£
  - è®¢å•ç®¡ç†æ¥å£
  - ç”¨æˆ·ä¸­å¿ƒæ¥å£
  - æ”¯ä»˜é›†æˆ

- **POSæ”¯ä»˜é›†æˆ** (`pos_payment_wechat`)
  - POSç«¯å¾®ä¿¡æ”¯ä»˜
  - POSç«¯æ”¯ä»˜å®æ”¯ä»˜
  - æ‰«ç æªé›†æˆ
  - å°ç¥¨æ‰“å°æ‰©å±•

- **å…¬å…±å·¥å…·æ¨¡å—** (`wechat_common`)
  - å¾®ä¿¡APIå®¢æˆ·ç«¯å°è£…
  - Access Tokenç®¡ç†
  - æ¶ˆæ¯åŠ è§£å¯†å·¥å…·
  - è¯ä¹¦ç®¡ç†

### æ”¹è¿›
- ä¼˜åŒ–æ”¯ä»˜å›è°ƒå¤„ç†
- å¢å¼ºæ”¯ä»˜å®‰å…¨æ€§
- æ”¹è¿›é”™è¯¯å¤„ç†æœºåˆ¶
- ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½

### ä¿®å¤
- ä¿®å¤æ”¯ä»˜ç­¾åéªŒè¯é—®é¢˜
- ä¿®å¤å›è°ƒé‡å¤å¤„ç†é—®é¢˜
- ä¿®å¤è¯ä¹¦ç®¡ç†é—®é¢˜
- ä¿®å¤POSæ”¯ä»˜çŠ¶æ€åŒæ­¥é—®é¢˜

## [0.9.0] - 2023-12-15

### æ–°å¢
- å¾®ä¿¡æ”¯ä»˜åŸºç¡€åŠŸèƒ½
- æ”¯ä»˜å®æ”¯ä»˜åŸºç¡€åŠŸèƒ½
- å¾®ä¿¡å…¬ä¼—å·åŸºç¡€æ¡†æ¶
- å°ç¨‹åºåç«¯åŸºç¡€æ¡†æ¶

### æ”¹è¿›
- ä¼˜åŒ–é¡¹ç›®ç»“æ„
- æ”¹è¿›å¼€å‘æ–‡æ¡£
- å¢å¼ºæµ‹è¯•è¦†ç›–

## [0.8.0] - 2023-12-01

### æ–°å¢
- é¡¹ç›®åŸºç¡€æ¡†æ¶
- å¼€å‘ç¯å¢ƒé…ç½®
- åŸºæœ¬æ¨¡å—ç»“æ„
- åŸºç¡€æµ‹è¯•æ¡†æ¶

---

## å‘å¸ƒè¯´æ˜

### ç‰ˆæœ¬å·è§„åˆ™
æœ¬é¡¹ç›®ä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬å·ï¼Œæ ¼å¼ä¸ºï¼š`ä¸»ç‰ˆæœ¬å·.æ¬¡ç‰ˆæœ¬å·.ä¿®è®¢å·`

- **ä¸»ç‰ˆæœ¬å·**: ä¸å…¼å®¹çš„APIä¿®æ”¹
- **æ¬¡ç‰ˆæœ¬å·**: å‘ä¸‹å…¼å®¹çš„åŠŸèƒ½æ€§æ–°å¢
- **ä¿®è®¢å·**: å‘ä¸‹å…¼å®¹çš„é—®é¢˜ä¿®æ­£

### å‘å¸ƒå‘¨æœŸ
- **ä¸»è¦ç‰ˆæœ¬**: æ¯6ä¸ªæœˆå‘å¸ƒä¸€æ¬¡
- **æ¬¡è¦ç‰ˆæœ¬**: æ¯æœˆå‘å¸ƒä¸€æ¬¡
- **ä¿®è®¢ç‰ˆæœ¬**: æ ¹æ®éœ€è¦å‘å¸ƒ

### å‡çº§æŒ‡å—
- å°ç‰ˆæœ¬å‡çº§ï¼šç›´æ¥å‡çº§
- å¤§ç‰ˆæœ¬å‡çº§ï¼šæŸ¥çœ‹å‡çº§æ–‡æ¡£ï¼Œè¿›è¡Œå…¼å®¹æ€§æµ‹è¯•

### åºŸå¼ƒåŠŸèƒ½
- åºŸå¼ƒçš„åŠŸèƒ½ä¼šæ ‡è®°ä¸ºå¼ƒç”¨
- åºŸå¼ƒåŠŸèƒ½ä¼šåœ¨ä¸¤ä¸ªå¤§ç‰ˆæœ¬åç§»é™¤
- ç§»é™¤å‰ä¼šæœ‰æ˜ç¡®çš„è¿ç§»æŒ‡å—

---

## è´¡çŒ®è€…

æ„Ÿè°¢æ‰€æœ‰ä¸ºæœ¬é¡¹ç›®åšå‡ºè´¡çŒ®çš„å¼€å‘è€…ï¼

æŒ‰å­—æ¯é¡ºåºæ’åˆ—ï¼š

- å¼ ä¸‰
- æå››
- ç‹äº”
- èµµå…­

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»ï¼š

- ğŸ“§ é‚®ç®±: support@example.com
- ğŸ“± ç”µè¯: 400-XXX-XXXX
- ğŸ’¬ å¾®ä¿¡: wechat-support

---

*æ›´æ–°æ—¥å¿—è‡ªåŠ¨ç”Ÿæˆï¼Œæœ€åæ›´æ–°ï¼š{å½“å‰æ—¥æœŸ}*
"""

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    import sys
    
    if len(sys.argv) > 1:
        project_root = sys.argv[1]
    else:
        project_root = "."
    
    doc_manager = ProjectDocumentation(project_root)
    doc_manager.create_all_documentation()
```

#### **ä»»åŠ¡2ï¼šéƒ¨ç½²åŒ…åˆ¶ä½œè„šæœ¬**
```python
# file: scripts/build_deployment_package.py

#!/usr/bin/env python3
"""
Odoo 19å¾®ä¿¡æ”¯ä»˜é¡¹ç›®éƒ¨ç½²åŒ…åˆ¶ä½œè„šæœ¬
ç”¨äºåˆ›å»ºå¯éƒ¨ç½²çš„å®‰è£…åŒ…
"""

import os
import sys
import shutil
import tarfile
import zipfile
import json
import hashlib
from datetime import datetime
from pathlib import Path
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class DeploymentPackageBuilder:
    """éƒ¨ç½²åŒ…æ„å»ºå™¨"""
    
    def __init__(self, project_root="."):
        self.project_root = Path(project_root).resolve()
        self.build_dir = self.project_root / "build"
        self.dist_dir = self.project_root / "dist"
        self.version = self._get_version()
        
    def _get_version(self):
        """è·å–é¡¹ç›®ç‰ˆæœ¬"""
        try:
            with open(self.project_root / "VERSION", "r") as f:
                return f.read().strip()
        except FileNotFoundError:
            return "1.0.0"
    
    def clean_build(self):
        """æ¸…ç†æ„å»ºç›®å½•"""
        logger.info("ğŸ§¹ æ¸…ç†æ„å»ºç›®å½•...")
        
        if self.build_dir.exists():
            shutil.rmtree(self.build_dir)
        
        if self.dist_dir.exists():
            shutil.rmtree(self.dist_dir)
        
        self.build_dir.mkdir(parents=True, exist_ok=True)
        self.dist_dir.mkdir(parents=True, exist_ok=True)
    
    def collect_files(self):
        """æ”¶é›†éƒ¨ç½²æ–‡ä»¶"""
        logger.info("ğŸ“¦ æ”¶é›†éƒ¨ç½²æ–‡ä»¶...")
        
        # æ¨¡å—ç›®å½•
        modules = [
            "payment_wechat",
            "payment_alipay", 
            "payment_unionpay",
            "wechat_common",
            "wechat_platform",
            "wechat_miniprogram",
            "pos_payment_wechat"
        ]
        
        for module in modules:
            module_path = self.project_root / module
            if module_path.exists():
                dest_path = self.build_dir / "modules" / module
                shutil.copytree(module_path, dest_path)
                logger.info(f"  âœ… {module}")
        
        # æ–‡æ¡£ç›®å½•
        docs_src = self.project_root / "docs"
        if docs_src.exists():
            docs_dest = self.build_dir / "docs"
            shutil.copytree(docs_src, docs_dest)
            logger.info("  âœ… æ–‡æ¡£")
        
        # è„šæœ¬ç›®å½•
        scripts_src = self.project_root / "scripts"
        if scripts_src.exists():
            scripts_dest = self.build_dir / "scripts"
            shutil.copytree(scripts_src, scripts_dest)
            logger.info("  âœ… è„šæœ¬")
        
        # é…ç½®æ–‡ä»¶
        config_files = [
            "requirements.txt",
            "README.md",
            "CHANGELOG.md",
            "LICENSE",
            ".env.example",
            "docker-compose.yml",
            "nginx.conf.example"
        ]
        
        for config_file in config_files:
            src_path = self.project_root / config_file
            if src_path.exists():
                shutil.copy2(src_path, self.build_dir / config_file)
                logger.info(f"  âœ… {config_file}")
        
        # åˆ›å»ºéƒ¨ç½²è¯´æ˜
        self._create_deployment_instructions()
        
        return len(modules)
    
    def _create_deployment_instructions(self):
        """åˆ›å»ºéƒ¨ç½²è¯´æ˜æ–‡ä»¶"""
        instructions = f"""# Odoo 19å¾®ä¿¡æ”¯ä»˜é¡¹ç›®éƒ¨ç½²è¯´æ˜

## é¡¹ç›®ä¿¡æ¯
- é¡¹ç›®åç§°: Odoo 19å¾®ä¿¡æ”¯ä»˜ä¸ç”Ÿæ€ç³»ç»Ÿé›†æˆ
- ç‰ˆæœ¬: {self.version}
- æ„å»ºæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
- æ„å»ºç¯å¢ƒ: Python {sys.version}

## æ–‡ä»¶ç»“æ„
```
deployment-package/
â”œâ”€â”€ modules/              # Odooæ¨¡å—
â”‚   â”œâ”€â”€ payment_wechat/   # å¾®ä¿¡æ”¯ä»˜æ¨¡å—
â”‚   â”œâ”€â”€ payment_alipay/   # æ”¯ä»˜å®æ”¯ä»˜æ¨¡å—
â”‚   â”œâ”€â”€ payment_unionpay/ # äº‘é—ªä»˜æ”¯ä»˜æ¨¡å—
â”‚   â”œâ”€â”€ wechat_common/    # å¾®ä¿¡å…¬å…±æ¨¡å—
â”‚   â”œâ”€â”€ wechat_platform/  # å…¬ä¼—å·ç®¡ç†å¹³å°
â”‚   â”œâ”€â”€ wechat_miniprogram/# å°ç¨‹åºåç«¯
â”‚   â””â”€â”€ pos_payment_wechat/# POSæ”¯ä»˜é›†æˆ
â”œâ”€â”€ docs/                 # æ–‡æ¡£ç›®å½•
â”œâ”€â”€ scripts/              # éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ requirements.txt      # Pythonä¾èµ–
â”œâ”€â”€ docker-compose.yml    # Dockeréƒ¨ç½²é…ç½®
â”œâ”€â”€ nginx.conf.example    # Nginxé…ç½®ç¤ºä¾‹
â”œâ”€â”€ .env.example          # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â””â”€â”€ README.md            # é¡¹ç›®è¯´æ˜
```

## éƒ¨ç½²æ–¹å¼

### æ–¹å¼ä¸€: Dockeréƒ¨ç½²ï¼ˆæ¨èï¼‰
```bash
# 1. å¤åˆ¶é…ç½®æ–‡ä»¶
cp .env.example .env
cp nginx.conf.example nginx.conf

# 2. ç¼–è¾‘é…ç½®æ–‡ä»¶
# ä¿®æ”¹.envä¸­çš„æ•°æ®åº“å¯†ç ã€Rediså¯†ç ç­‰

# 3. å¯åŠ¨æœåŠ¡
docker-compose up -d

# 4. è®¿é—®ç³»ç»Ÿ
# http://your-server:8069
```

### æ–¹å¼äºŒ: ä¼ ç»Ÿéƒ¨ç½²
```bash
# 1. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 2. é…ç½®Odoo
# å°†modulesç›®å½•æ·»åŠ åˆ°Odooçš„addonsè·¯å¾„

# 3. å®‰è£…æ¨¡å—
# é€šè¿‡Odooç½‘é¡µç•Œé¢æˆ–å‘½ä»¤è¡Œå®‰è£…æ¨¡å—
```

### æ–¹å¼ä¸‰: æ‰‹åŠ¨éƒ¨ç½²
1. å°†modulesç›®å½•ä¸­çš„æ¨¡å—å¤åˆ¶åˆ°Odooçš„addonsè·¯å¾„
2. é‡å¯OdooæœåŠ¡
3. é€šè¿‡åº”ç”¨èœå•å®‰è£…æ¨¡å—

## æ¨¡å—å®‰è£…é¡ºåº
å»ºè®®æŒ‰ä»¥ä¸‹é¡ºåºå®‰è£…æ¨¡å—ï¼š
1. wechat_commonï¼ˆåŸºç¡€æ¨¡å—ï¼‰
2. payment_wechatï¼ˆå¾®ä¿¡æ”¯ä»˜ï¼‰
3. payment_alipayï¼ˆæ”¯ä»˜å®æ”¯ä»˜ï¼‰  
4. payment_unionpayï¼ˆäº‘é—ªä»˜æ”¯ä»˜ï¼‰
5. wechat_platformï¼ˆå…¬ä¼—å·ç®¡ç†ï¼‰
6. wechat_miniprogramï¼ˆå°ç¨‹åºåç«¯ï¼‰
7. pos_payment_wechatï¼ˆPOSé›†æˆï¼‰

## é…ç½®è¯´æ˜

### å¾®ä¿¡æ”¯ä»˜é…ç½®
1. è¿›å…¥Odooåå°
2. è¿›å…¥ã€Œä¼šè®¡ã€â†’ã€Œé…ç½®ã€â†’ã€Œæ”¯ä»˜æä¾›å•†ã€
3. åˆ›å»ºå¾®ä¿¡æ”¯ä»˜æä¾›å•†
4. å¡«å†™å¾®ä¿¡å•†æˆ·ä¿¡æ¯ï¼š
   - å•†æˆ·å·(MCHID)
   - AppID
   - APIv3å¯†é’¥
   - å•†æˆ·è¯ä¹¦

### æ”¯ä»˜å®é…ç½®
1. åŒæ ·ä½ç½®åˆ›å»ºæ”¯ä»˜å®æ”¯ä»˜æä¾›å•†
2. å¡«å†™æ”¯ä»˜å®å•†æˆ·ä¿¡æ¯ï¼š
   - AppID
   - åº”ç”¨ç§é’¥
   - æ”¯ä»˜å®å…¬é’¥

### å…¬ä¼—å·é…ç½®
1. è¿›å…¥ã€Œå¾®ä¿¡ã€â†’ã€Œå…¬ä¼—å·ã€â†’ã€Œå…¬ä¼—å·ç®¡ç†ã€
2. æ·»åŠ å…¬ä¼—å·
3. å¡«å†™å…¬ä¼—å·ä¿¡æ¯ï¼š
   - AppID
   - AppSecret
   - æœåŠ¡å™¨é…ç½®ä¿¡æ¯

## éªŒè¯å®‰è£…

### éªŒè¯æ­¥éª¤
1. æ£€æŸ¥æ‰€æœ‰æ¨¡å—æ˜¯å¦æ­£å¸¸å®‰è£…
2. æµ‹è¯•æ”¯ä»˜åŠŸèƒ½
3. éªŒè¯å›è°ƒåŠŸèƒ½
4. æ£€æŸ¥æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯

### æµ‹è¯•æ”¯ä»˜
1. åˆ›å»ºä¸€ä¸ªæµ‹è¯•è®¢å•
2. é€‰æ‹©å¾®ä¿¡æ”¯ä»˜
3. ä½¿ç”¨å¾®ä¿¡æ”¯ä»˜æµ‹è¯•å·¥å…·å®Œæˆæ”¯ä»˜
4. éªŒè¯è®¢å•çŠ¶æ€æ›´æ–°

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜
1. **æ¨¡å—å®‰è£…å¤±è´¥**: æ£€æŸ¥ä¾èµ–æ˜¯å¦å®‰è£…
2. **æ”¯ä»˜å›è°ƒå¤±è´¥**: æ£€æŸ¥ç½‘ç»œå’Œé…ç½®
3. **è¯ä¹¦é”™è¯¯**: ç¡®ä¿è¯ä¹¦æ ¼å¼æ­£ç¡®
4. **æƒé™é—®é¢˜**: æ£€æŸ¥æ–‡ä»¶å’Œç›®å½•æƒé™

### æ—¥å¿—ä½ç½®
- Odooæ—¥å¿—: /var/log/odoo/odoo.log
- Nginxæ—¥å¿—: /var/log/nginx/
- Dockeræ—¥å¿—: docker-compose logs

## æ”¯æŒä¸è”ç³»

- æŠ€æœ¯æ”¯æŒ: support@example.com
- æ–‡æ¡£åœ°å€: https://docs.example.com
- ç´§æ€¥è”ç³»: 400-XXX-XXXX

## ç‰ˆæœ¬ä¿¡æ¯

- å½“å‰ç‰ˆæœ¬: {self.version}
- Odooç‰ˆæœ¬è¦æ±‚: 19.0+
- Pythonç‰ˆæœ¬è¦æ±‚: 3.10+
- æ•°æ®åº“è¦æ±‚: PostgreSQL 14+

---

*éƒ¨ç½²åŒ…ç”Ÿæˆæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}*
"""
        
        with open(self.build_dir / "DEPLOYMENT.md", "w", encoding="utf-8") as f:
            f.write(instructions)
    
    def create_package_info(self):
        """åˆ›å»ºåŒ…ä¿¡æ¯æ–‡ä»¶"""
        package_info = {
            "name": "odoo19-wechat-payment",
            "version": self.version,
            "description": "Odoo 19å¾®ä¿¡æ”¯ä»˜ä¸ç”Ÿæ€ç³»ç»Ÿé›†æˆè§£å†³æ–¹æ¡ˆ",
            "author": "Odooå¼€å‘å›¢é˜Ÿ",
            "license": "MIT",
            "build_date": datetime.now().isoformat(),
            "modules": [
                "payment_wechat",
                "payment_alipay",
                "payment_unionpay",
                "wechat_common",
                "wechat_platform",
                "wechat_miniprogram",
                "pos_payment_wechat"
            ],
            "requirements": [
                "odoo>=19.0",
                "requests>=2.28.0",
                "cryptography>=39.0.0",
                "xmltodict>=0.13.0"
            ],
            "system_requirements": {
                "python": "3.10+",
                "postgresql": "14+",
                "redis": "6.0+",
                "odoo": "19.0+"
            }
        }
        
        with open(self.build_dir / "package-info.json", "w", encoding="utf-8") as f:
            json.dump(package_info, f, indent=2, ensure_ascii=False)
    
    def calculate_checksums(self):
        """è®¡ç®—æ–‡ä»¶æ ¡éªŒå’Œ"""
        logger.info("ğŸ” è®¡ç®—æ–‡ä»¶æ ¡éªŒå’Œ...")
        
        checksums = {}
        
        for root, dirs, files in os.walk(self.build_dir):
            for file in files:
                file_path = Path(root) / file
                rel_path = file_path.relative_to(self.build_dir)
                
                # è®¡ç®—MD5å’ŒSHA256
                with open(file_path, "rb") as f:
                    content = f.read()
                    md5 = hashlib.md5(content).hexdigest()
                    sha256 = hashlib.sha256(content).hexdigest()
                
                checksums[str(rel_path)] = {
                    "md5": md5,
                    "sha256": sha256,
                    "size": os.path.getsize(file_path)
                }
        
        with open(self.build_dir / "checksums.json", "w", encoding="utf-8") as f:
            json.dump(checksums, f, indent=2)
        
        logger.info(f"  âœ… è®¡ç®—äº† {len(checksums)} ä¸ªæ–‡ä»¶çš„æ ¡éªŒå’Œ")
        return checksums
    
    def create_tar_package(self):
        """åˆ›å»ºtar.gzåŒ…"""
        logger.info("ğŸ“¦ åˆ›å»ºtar.gzéƒ¨ç½²åŒ…...")
        
        package_name = f"odoo19-wechat-payment-{self.version}"
        tar_filename = f"{package_name}.tar.gz"
        tar_path = self.dist_dir / tar_filename
        
        with tarfile.open(tar_path, "w:gz") as tar:
            tar.add(self.build_dir, arcname=package_name)
        
        tar_size = os.path.getsize(tar_path) / (1024 * 1024)  # MB
        logger.info(f"  âœ… åˆ›å»ºå®Œæˆ: {tar_filename} ({tar_size:.2f} MB)")
        
        return tar_path
    
    def create_zip_package(self):
        """åˆ›å»ºzipåŒ…"""
        logger.info("ğŸ“¦ åˆ›å»ºzipéƒ¨ç½²åŒ…...")
        
        package_name = f"odoo19-wechat-payment-{self.version}"
        zip_filename = f"{package_name}.zip"
        zip_path = self.dist_dir / zip_filename
        
        with zipfile.ZipFile(zip_path, 'w', zipfile.ZIP_DEFLATED) as zipf:
            for root, dirs, files in os.walk(self.build_dir):
                for file in files:
                    file_path = Path(root) / file
                    arcname = package_name / file_path.relative_to(self.build_dir)
                    zipf.write(file_path, arcname)
        
        zip_size = os.path.getsize(zip_path) / (1024 * 1024)  # MB
        logger.info(f"  âœ… åˆ›å»ºå®Œæˆ: {zip_filename} ({zip_size:.2f} MB)")
        
        return zip_path
    
    def create_installer_script(self):
        """åˆ›å»ºå®‰è£…è„šæœ¬"""
        logger.info("ğŸ“œ åˆ›å»ºå®‰è£…è„šæœ¬...")
        
        installer_content = """#!/bin/bash
# Odoo 19å¾®ä¿¡æ”¯ä»˜é¡¹ç›®å®‰è£…è„šæœ¬
# ç‰ˆæœ¬: {version}

set -e

# é¢œè‰²å®šä¹‰
RED='\\033[0;31m'
GREEN='\\033[0;32m'
YELLOW='\\033[1;33m'
BLUE='\\033[0;34m'
NC='\\033[0m' # No Color

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# æ˜¾ç¤ºæ¨ªå¹…
show_banner() {
    echo "========================================"
    echo "  Odoo 19å¾®ä¿¡æ”¯ä»˜é¡¹ç›®å®‰è£…è„šæœ¬"
    echo "  ç‰ˆæœ¬: {version}"
    echo "========================================"
    echo ""
}

# æ£€æŸ¥ä¾èµ–
check_dependencies() {
    log_info "æ£€æŸ¥ç³»ç»Ÿä¾èµ–..."
    
    # æ£€æŸ¥Python
    if command -v python3 &> /dev/null; then
        python_version=$(python3 --version | cut -d' ' -f2)
        log_info "Pythonç‰ˆæœ¬: $python_version"
        
        # æ£€æŸ¥Pythonç‰ˆæœ¬
        if [[ $(echo "$python_version 3.10" | tr " " "\\n" | sort -V | head -n1) != "3.10" ]]; then
            log_error "Pythonç‰ˆæœ¬éœ€è¦3.10æˆ–æ›´é«˜"
            return 1
        fi
    else
        log_error "æœªæ‰¾åˆ°Python3"
        return 1
    fi
    
    # æ£€æŸ¥Pip
    if command -v pip3 &> /dev/null; then
        log_info "æ‰¾åˆ°pip3"
    else
        log_error "æœªæ‰¾åˆ°pip3"
        return 1
    fi
    
    # æ£€æŸ¥Dockerï¼ˆå¯é€‰ï¼‰
    if command -v docker &> /dev/null; then
        log_info "æ‰¾åˆ°Docker"
    else
        log_warning "æœªæ‰¾åˆ°Dockerï¼Œå°†ä½¿ç”¨ä¼ ç»Ÿå®‰è£…æ–¹å¼"
    fi
    
    # æ£€æŸ¥Docker Composeï¼ˆå¯é€‰ï¼‰
    if command -v docker-compose &> /dev/null; then
        log_info "æ‰¾åˆ°Docker Compose"
    fi
    
    log_success "ä¾èµ–æ£€æŸ¥å®Œæˆ"
    return 0
}

# å®‰è£…Pythonä¾èµ–
install_python_deps() {
    log_info "å®‰è£…Pythonä¾èµ–..."
    
    if [ -f "requirements.txt" ]; then
        pip3 install -r requirements.txt
        if [ $? -eq 0 ]; then
            log_success "Pythonä¾èµ–å®‰è£…å®Œæˆ"
        else
            log_error "Pythonä¾èµ–å®‰è£…å¤±è´¥"
            return 1
        fi
    else
        log_warning "æœªæ‰¾åˆ°requirements.txtæ–‡ä»¶"
    fi
    
    return 0
}

# å®‰è£…Odooæ¨¡å—
install_odoo_modules() {
    log_info "å®‰è£…Odooæ¨¡å—..."
    
    # æ£€æŸ¥Odooå®‰è£…
    if ! command -v odoo &> /dev/null; then
        log_error "æœªæ‰¾åˆ°Odooï¼Œè¯·å…ˆå®‰è£…Odoo 19"
        return 1
    fi
    
    # æ¨¡å—å®‰è£…é¡ºåº
    modules=(
        "wechat_common"
        "payment_wechat"
        "payment_alipay"
        "payment_unionpay"
        "wechat_platform"
        "wechat_miniprogram"
        "pos_payment_wechat"
    )
    
    for module in "${{modules[@]}}"; do
        if [ -d "modules/$module" ]; then
            log_info "å®‰è£…æ¨¡å—: $module"
            # è¿™é‡Œåº”è¯¥è°ƒç”¨Odooçš„æ¨¡å—å®‰è£…å‘½ä»¤
            # å®é™…å®ç°éœ€è¦æ ¹æ®å…·ä½“ç¯å¢ƒè°ƒæ•´
        else
            log_warning "æ¨¡å—ä¸å­˜åœ¨: $module"
        fi
    done
    
    log_success "æ¨¡å—å®‰è£…å®Œæˆ"
    return 0
}

# Dockerå®‰è£…
docker_installation() {
    log_info "ä½¿ç”¨Dockerå®‰è£…..."
    
    if [ ! -f "docker-compose.yml" ]; then
        log_error "æœªæ‰¾åˆ°docker-compose.ymlæ–‡ä»¶"
        return 1
    fi
    
    # æ£€æŸ¥ç¯å¢ƒå˜é‡æ–‡ä»¶
    if [ ! -f ".env" ]; then
        if [ -f ".env.example" ]; then
            log_info "åˆ›å»º.envæ–‡ä»¶..."
            cp .env.example .env
            log_warning "è¯·ç¼–è¾‘.envæ–‡ä»¶ä¸­çš„é…ç½®"
        else
            log_error "æœªæ‰¾åˆ°ç¯å¢ƒå˜é‡æ–‡ä»¶"
            return 1
        fi
    fi
    
    # å¯åŠ¨DockeræœåŠ¡
    log_info "å¯åŠ¨DockeræœåŠ¡..."
    docker-compose up -d
    
    if [ $? -eq 0 ]; then
        log_success "DockeræœåŠ¡å¯åŠ¨æˆåŠŸ"
        log_info "æœåŠ¡è®¿é—®åœ°å€: http://localhost:8069"
    else
        log_error "DockeræœåŠ¡å¯åŠ¨å¤±è´¥"
        return 1
    fi
    
    return 0
}

# ä¼ ç»Ÿå®‰è£…
traditional_installation() {
    log_info "ä½¿ç”¨ä¼ ç»Ÿæ–¹å¼å®‰è£…..."
    
    # è¿™é‡Œå®ç°ä¼ ç»Ÿå®‰è£…é€»è¾‘
    # åŒ…æ‹¬é…ç½®Odooã€å¤åˆ¶æ¨¡å—ç­‰
    
    log_success "ä¼ ç»Ÿå®‰è£…å®Œæˆ"
    return 0
}

# éªŒè¯å®‰è£…
verify_installation() {
    log_info "éªŒè¯å®‰è£…..."
    
    # æ£€æŸ¥æœåŠ¡çŠ¶æ€
    if command -v docker &> /dev/null && docker-compose ps | grep -q "Up"; then
        log_success "DockeræœåŠ¡è¿è¡Œæ­£å¸¸"
    fi
    
    # æ£€æŸ¥æ¨¡å—å®‰è£…
    # è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„éªŒè¯é€»è¾‘
    
    log_success "å®‰è£…éªŒè¯å®Œæˆ"
    return 0
}

# æ˜¾ç¤ºå®‰è£…åè¯´æ˜
show_post_install() {
    echo ""
    echo "========================================"
    echo "          å®‰è£…å®Œæˆï¼"
    echo "========================================"
    echo ""
    echo "æ¥ä¸‹æ¥éœ€è¦åšçš„:"
    echo "1. è®¿é—®Odooç³»ç»Ÿ: http://localhost:8069"
    echo "2. é…ç½®æ”¯ä»˜æ¸ é“ï¼ˆå¾®ä¿¡æ”¯ä»˜ã€æ”¯ä»˜å®ç­‰ï¼‰"
    echo "3. é…ç½®å¾®ä¿¡å…¬ä¼—å·"
    echo "4. æµ‹è¯•æ”¯ä»˜åŠŸèƒ½"
    echo ""
    echo "è¯¦ç»†é…ç½®æŒ‡å—è¯·æŸ¥çœ‹ DEPLOYMENT.md æ–‡ä»¶"
    echo ""
    echo "å¦‚æœéœ€è¦å¸®åŠ©ï¼Œè¯·è”ç³»:"
    echo "- é‚®ç®±: support@example.com"
    echo "- ç”µè¯: 400-XXX-XXXX"
    echo ""
}

# ä¸»å‡½æ•°
main() {
    show_banner
    
    # æ£€æŸ¥å‚æ•°
    if [ $# -eq 0 ]; then
        INSTALL_MODE="auto"
    else
        INSTALL_MODE="$1"
    fi
    
    # æ£€æŸ¥ä¾èµ–
    check_dependencies
    if [ $? -ne 0 ]; then
        log_error "ä¾èµ–æ£€æŸ¥å¤±è´¥ï¼Œè¯·å…ˆè§£å†³ä¾èµ–é—®é¢˜"
        exit 1
    fi
    
    # é€‰æ‹©å®‰è£…æ–¹å¼
    case $INSTALL_MODE in
        "docker")
            log_info "ä½¿ç”¨Dockerå®‰è£…æ¨¡å¼"
            docker_installation
            ;;
        "traditional")
            log_info "ä½¿ç”¨ä¼ ç»Ÿå®‰è£…æ¨¡å¼"
            install_python_deps
            traditional_installation
            ;;
        "auto"|*)
            if command -v docker &> /dev/null && command -v docker-compose &> /dev/null; then
                log_info "è‡ªåŠ¨é€‰æ‹©Dockerå®‰è£…"
                docker_installation
            else
                log_info "è‡ªåŠ¨é€‰æ‹©ä¼ ç»Ÿå®‰è£…"
                install_python_deps
                traditional_installation
            fi
            ;;
    esac
    
    if [ $? -eq 0 ]; then
        install_odoo_modules
        verify_installation
        show_post_install
        log_success "å®‰è£…å®Œæˆï¼"
    else
        log_error "å®‰è£…å¤±è´¥"
        exit 1
    fi
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
""".format(version=self.version)
        
        installer_path = self.build_dir / "install.sh"
        with open(installer_path, "w", encoding="utf-8") as f:
            f.write(installer_content)
        
        # è®¾ç½®æ‰§è¡Œæƒé™
        os.chmod(installer_path, 0o755)
        
        logger.info("  âœ… å®‰è£…è„šæœ¬åˆ›å»ºå®Œæˆ")
    
    def create_windows_installer(self):
        """åˆ›å»ºWindowså®‰è£…è„šæœ¬"""
        logger.info("ğŸªŸ åˆ›å»ºWindowså®‰è£…è„šæœ¬...")
        
        bat_content = f"""@echo off
chcp 65001 > nul
title Odoo 19å¾®ä¿¡æ”¯ä»˜é¡¹ç›®å®‰è£…è„šæœ¬ - ç‰ˆæœ¬ {self.version}

echo ========================================
echo   Odoo 19å¾®ä¿¡æ”¯ä»˜é¡¹ç›®å®‰è£…è„šæœ¬
echo   ç‰ˆæœ¬: {self.version}
echo ========================================
echo.

:check_python
echo [INFO] æ£€æŸ¥Pythonå®‰è£…...
python --version > nul 2>&1
if %errorlevel% neq 0 (
    echo [ERROR] æœªæ‰¾åˆ°Pythonï¼Œè¯·å…ˆå®‰è£…Python 3.10+
    echo ä¸‹è½½åœ°å€: https://www.python.org/downloads/
    pause
    exit /b 1
)

python -c "import sys; print('Pythonç‰ˆæœ¬:', sys.version)" 2>&1 | find "3.10" > nul
if %errorlevel% neq 0 (
    echo [ERROR] Pythonç‰ˆæœ¬éœ€è¦3.10æˆ–æ›´é«˜
    pause
    exit /b 1
)

echo [SUCCESS] Pythonæ£€æŸ¥é€šè¿‡
echo.

:check_pip
echo [INFO] æ£€æŸ¥pipå®‰è£…...
python -m pip --version > nul 2>&1
if %errorlevel% neq 0 (
    echo [ERROR] æœªæ‰¾åˆ°pipï¼Œè¯·å…ˆå®‰è£…pip
    pause
    exit /b 1
)

echo [SUCCESS] pipæ£€æŸ¥é€šè¿‡
echo.

:install_deps
echo [INFO] å®‰è£…Pythonä¾èµ–...
if exist "requirements.txt" (
    python -m pip install -r requirements.txt
    if %errorlevel% neq 0 (
        echo [ERROR] ä¾èµ–å®‰è£…å¤±è´¥
        pause
        exit /b 1
    )
    echo [SUCCESS] ä¾èµ–å®‰è£…å®Œæˆ
) else (
    echo [WARNING] æœªæ‰¾åˆ°requirements.txtæ–‡ä»¶
)
echo.

:check_docker
echo [INFO] æ£€æŸ¥Dockerå®‰è£…...
docker --version > nul 2>&1
if %errorlevel% neq 0 (
    echo [WARNING] æœªæ‰¾åˆ°Dockerï¼Œå°†ä½¿ç”¨ä¼ ç»Ÿå®‰è£…æ–¹å¼
    set DOCKER_AVAILABLE=0
) else (
    echo [INFO] æ‰¾åˆ°Docker
    set DOCKER_AVAILABLE=1
)

docker-compose --version > nul 2>&1
if %errorlevel% neq 0 (
    echo [WARNING] æœªæ‰¾åˆ°Docker Compose
    set DOCKER_COMPOSE_AVAILABLE=0
) else (
    echo [INFO] æ‰¾åˆ°Docker Compose
    set DOCKER_COMPOSE_AVAILABLE=1
)
echo.

:choose_installation
set /p INSTALL_MODE="è¯·é€‰æ‹©å®‰è£…æ–¹å¼ (1-Docker, 2-ä¼ ç»Ÿ, å›è½¦è‡ªåŠ¨é€‰æ‹©): "
if "%INSTALL_MODE%"=="1" (
    goto docker_install
) else if "%INSTALL_MODE%"=="2" (
    goto traditional_install
) else (
    if %DOCKER_AVAILABLE%==1 if %DOCKER_COMPOSE_AVAILABLE%==1 (
        goto docker_install
    ) else (
        goto traditional_install
    )
)

:docker_install
echo [INFO] ä½¿ç”¨Dockerå®‰è£…...
if not exist "docker-compose.yml" (
    echo [ERROR] æœªæ‰¾åˆ°docker-compose.ymlæ–‡ä»¶
    pause
    exit /b 1
)

if not exist ".env" (
    if exist ".env.example" (
        echo [INFO] åˆ›å»º.envæ–‡ä»¶...
        copy ".env.example" ".env"
        echo [WARNING] è¯·ç¼–è¾‘.envæ–‡ä»¶ä¸­çš„é…ç½®
    ) else (
        echo [ERROR] æœªæ‰¾åˆ°ç¯å¢ƒå˜é‡æ–‡ä»¶
        pause
        exit /b 1
    )
)

echo [INFO] å¯åŠ¨DockeræœåŠ¡...
docker-compose up -d
if %errorlevel% neq 0 (
    echo [ERROR] DockeræœåŠ¡å¯åŠ¨å¤±è´¥
    pause
    exit /b 1
)

echo [SUCCESS] DockeræœåŠ¡å¯åŠ¨æˆåŠŸ
echo [INFO] æœåŠ¡è®¿é—®åœ°å€: http://localhost:8069
goto post_install

:traditional_install
echo [INFO] ä½¿ç”¨ä¼ ç»Ÿæ–¹å¼å®‰è£…...
echo [INFO] è¯·æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹æ­¥éª¤:
echo 1. å°†modulesç›®å½•å¤åˆ¶åˆ°Odooçš„addonsè·¯å¾„
echo 2. é…ç½®Odooçš„odoo.confæ–‡ä»¶
echo 3. å¯åŠ¨OdooæœåŠ¡
echo 4. é€šè¿‡ç½‘é¡µå®‰è£…æ¨¡å—
goto post_install

:post_install
echo.
echo ========================================
echo           å®‰è£…å®Œæˆï¼
echo ========================================
echo.
echo æ¥ä¸‹æ¥éœ€è¦åšçš„:
echo 1. è®¿é—®Odooç³»ç»Ÿ: http://localhost:8069
echo 2. é…ç½®æ”¯ä»˜æ¸ é“ï¼ˆå¾®ä¿¡æ”¯ä»˜ã€æ”¯ä»˜å®ç­‰ï¼‰
echo 3. é…ç½®å¾®ä¿¡å…¬ä¼—å·
echo 4. æµ‹è¯•æ”¯ä»˜åŠŸèƒ½
echo.
echo è¯¦ç»†é…ç½®æŒ‡å—è¯·æŸ¥çœ‹ DEPLOYMENT.md æ–‡ä»¶
echo.
echo å¦‚æœéœ€è¦å¸®åŠ©ï¼Œè¯·è”ç³»:
echo - é‚®ç®±: support@example.com
echo - ç”µè¯: 400-XXX-XXXX
echo.
pause
exit /b 0
"""
        
        bat_path = self.build_dir / "install.bat"
        with open(bat_path, "w", encoding="utf-8") as f:
            f.write(bat_content)
        
        logger.info("  âœ… Windowså®‰è£…è„šæœ¬åˆ›å»ºå®Œæˆ")
    
    def build(self):
        """æ„å»ºéƒ¨ç½²åŒ…"""
        logger.info("=" * 60)
        logger.info("ğŸš€ å¼€å§‹æ„å»ºéƒ¨ç½²åŒ…")
        logger.info("=" * 60)
        
        try:
            # 1. æ¸…ç†æ„å»ºç›®å½•
            self.clean_build()
            
            # 2. æ”¶é›†æ–‡ä»¶
            module_count = self.collect_files()
            logger.info(f"ğŸ“¦ å…±æ”¶é›† {module_count} ä¸ªæ¨¡å—")
            
            # 3. åˆ›å»ºåŒ…ä¿¡æ¯
            self.create_package_info()
            
            # 4. è®¡ç®—æ ¡éªŒå’Œ
            self.calculate_checksums()
            
            # 5. åˆ›å»ºå®‰è£…è„šæœ¬
            self.create_installer_script()
            self.create_windows_installer()
            
            # 6. åˆ›å»ºå‹ç¼©åŒ…
            tar_path = self.create_tar_package()
            zip_path = self.create_zip_package()
            
            # 7. ç”Ÿæˆæ„å»ºæŠ¥å‘Š
            self._generate_build_report(tar_path, zip_path, module_count)
            
            logger.info("=" * 60)
            logger.info("ğŸ‰ éƒ¨ç½²åŒ…æ„å»ºå®Œæˆï¼")
            logger.info("=" * 60)
            
            return True
            
        except Exception as e:
            logger.error(f"æ„å»ºå¤±è´¥: {str(e)}")
            return False
    
    def _generate_build_report(self, tar_path, zip_path, module_count):
        """ç”Ÿæˆæ„å»ºæŠ¥å‘Š"""
        report = f"""# æ„å»ºæŠ¥å‘Š

## é¡¹ç›®ä¿¡æ¯
- é¡¹ç›®åç§°: Odoo 19å¾®ä¿¡æ”¯ä»˜ä¸ç”Ÿæ€ç³»ç»Ÿé›†æˆ
- ç‰ˆæœ¬: {self.version}
- æ„å»ºæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
- æ„å»ºç¯å¢ƒ: Python {sys.version}

## æ„å»ºç»“æœ
- æ¨¡å—æ•°é‡: {module_count} ä¸ª
- æ„å»ºç›®å½•: {self.build_dir}
- è¾“å‡ºç›®å½•: {self.dist_dir}

## ç”Ÿæˆçš„æ–‡ä»¶
1. **éƒ¨ç½²åŒ…**
   - `{tar_path.name}` ({os.path.getsize(tar_path) / (1024*1024):.2f} MB)
   - `{zip_path.name}` ({os.path.getsize(zip_path) / (1024*1024):.2f} MB)

2. **å®‰è£…è„šæœ¬**
   - `install.sh` (Linux/macOS)
   - `install.bat` (Windows)

3. **é…ç½®æ–‡ä»¶**
   - `package-info.json` (åŒ…ä¿¡æ¯)
   - `checksums.json` (æ–‡ä»¶æ ¡éªŒå’Œ)
   - `DEPLOYMENT.md` (éƒ¨ç½²è¯´æ˜)

## åŒ…å«çš„æ¨¡å—
1. wechat_common (å¾®ä¿¡å…¬å…±æ¨¡å—)
2. payment_wechat (å¾®ä¿¡æ”¯ä»˜)
3. payment_alipay (æ”¯ä»˜å®æ”¯ä»˜)
4. payment_unionpay (äº‘é—ªä»˜æ”¯ä»˜)
5. wechat_platform (å…¬ä¼—å·ç®¡ç†)
6. wechat_miniprogram (å°ç¨‹åºåç«¯)
7. pos_payment_wechat (POSæ”¯ä»˜é›†æˆ)

## ç³»ç»Ÿè¦æ±‚
- Python: 3.10+
- Odoo: 19.0+
- PostgreSQL: 14+
- Redis: 6.0+ (æ¨è)

## éƒ¨ç½²æ–¹å¼
1. **Dockeréƒ¨ç½²** (æ¨è)
   ```bash
   tar -xzf {tar_path.name}
   cd {tar_path.stem}
   ./install.sh docker
   ```

2. **ä¼ ç»Ÿéƒ¨ç½²**
   ```bash
   tar -xzf {tar_path.name}
   cd {tar_path.stem}
   ./install.sh traditional
   ```

## éªŒè¯å®‰è£…
å®‰è£…å®Œæˆåï¼Œè¯·éªŒè¯ï¼š
1. æ‰€æœ‰æ¨¡å—æ­£å¸¸å®‰è£…
2. æ”¯ä»˜åŠŸèƒ½æ­£å¸¸å·¥ä½œ
3. å›è°ƒåŠŸèƒ½æ­£å¸¸
4. æ— é”™è¯¯æ—¥å¿—

## æ”¯æŒä¿¡æ¯
- æŠ€æœ¯æ”¯æŒ: support@example.com
- æ–‡æ¡£åœ°å€: https://docs.example.com
- ç´§æ€¥è”ç³»: 400-XXX-XXXX

---

*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}*
"""
        
        report_path = self.dist_dir / "BUILD_REPORT.md"
        with open(report_path, "w", encoding="utf-8") as f:
            f.write(report)
        
        logger.info(f"ğŸ“Š æ„å»ºæŠ¥å‘Š: {report_path}")

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    import argparse
    
    parser = argparse.ArgumentParser(description="Odoo 19å¾®ä¿¡æ”¯ä»˜é¡¹ç›®éƒ¨ç½²åŒ…æ„å»ºå·¥å…·")
    parser.add_argument("--project-root", default=".", help="é¡¹ç›®æ ¹ç›®å½•")
    parser.add_argument("--clean", action="store_true", help="åªæ¸…ç†ä¸æ„å»º")
    
    args = parser.parse_args()
    
    builder = DeploymentPackageBuilder(args.project_root)
    
    if args.clean:
        builder.clean_build()
        logger.info("âœ… æ¸…ç†å®Œæˆ")
    else:
        success = builder.build()
        if success:
            logger.info("ğŸ‰ æ„å»ºæˆåŠŸï¼")
            sys.exit(0)
        else:
            logger.error("âŒ æ„å»ºå¤±è´¥")
            sys.exit(1)
```

### **å‰ç«¯å¼€å‘å…·ä½“ä»»åŠ¡ï¼š**

#### **ä»»åŠ¡1ï¼šåˆ›å»ºæ“ä½œè§†é¢‘è„šæœ¬**
```python
# file: scripts/create_training_videos.py

#!/usr/bin/env python3
"""
åŸ¹è®­è§†é¢‘è„šæœ¬ç”Ÿæˆå™¨
ç”Ÿæˆæ“ä½œè§†é¢‘çš„æ‹æ‘„è„šæœ¬å’Œåˆ¶ä½œæŒ‡å—
"""

import json
from datetime import datetime
from pathlib import Path

class TrainingVideoScriptGenerator:
    """åŸ¹è®­è§†é¢‘è„šæœ¬ç”Ÿæˆå™¨"""
    
    def __init__(self, output_dir="training_videos"):
        self.output_dir = Path(output_dir)
        self.output_dir.mkdir(exist_ok=True)
        
    def generate_video_scripts(self):
        """ç”Ÿæˆæ‰€æœ‰è§†é¢‘è„šæœ¬"""
        print("ğŸ¬ ç”ŸæˆåŸ¹è®­è§†é¢‘è„šæœ¬...")
        
        videos = [
            self._create_installation_video(),
            self._create_wechat_payment_video(),
            self._create_alipay_payment_video(),
            self._create_pos_payment_video(),
            self._create_wechat_platform_video(),
            self._create_miniprogram_video(),
            self._create_troubleshooting_video()
        ]
        
        # ç”Ÿæˆæ€»ç›®å½•
        self._create_video_catalog(videos)
        
        print(f"\nâœ… å…±ç”Ÿæˆ {len(videos)} ä¸ªè§†é¢‘è„šæœ¬")
        return videos
    
    def _create_installation_video(self):
        """åˆ›å»ºç³»ç»Ÿå®‰è£…è§†é¢‘è„šæœ¬"""
        script = {
            "video_id": "INSTALLATION_01",
            "title": "ç³»ç»Ÿå®‰è£…ä¸é…ç½®",
            "duration": "15åˆ†é’Ÿ",
            "target_audience": ["ç³»ç»Ÿç®¡ç†å‘˜", "å®æ–½é¡¾é—®"],
            "prerequisites": ["LinuxåŸºç¡€", "DockeråŸºç¡€"],
            
            "scenes": [
                {
                    "scene": 1,
                    "title": "ç¯å¢ƒå‡†å¤‡",
                    "duration": "2åˆ†é’Ÿ",
                    "content": [
                        "æ£€æŸ¥ç³»ç»Ÿè¦æ±‚ï¼ˆPython 3.10+, Docker, PostgreSQLï¼‰",
                        "ä¸‹è½½éƒ¨ç½²åŒ…",
                        "è§£å‹éƒ¨ç½²åŒ…"
                    ],
                    "visuals": [
                        "ç»ˆç«¯ç•Œé¢æ˜¾ç¤ºç³»ç»Ÿæ£€æŸ¥å‘½ä»¤",
                        "æ–‡ä»¶æµè§ˆå™¨æ˜¾ç¤ºéƒ¨ç½²åŒ…",
                        "è§£å‹è¿‡ç¨‹çš„åŠ¨ç”»"
                    ],
                    "voiceover": "åœ¨å¼€å§‹å®‰è£…ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿ç³»ç»Ÿæ»¡è¶³åŸºæœ¬è¦æ±‚..."
                },
                {
                    "scene": 2,
                    "title": "Dockerå®‰è£…",
                    "duration": "5åˆ†é’Ÿ",
                    "content": [
                        "å¤åˆ¶ç¯å¢ƒé…ç½®æ–‡ä»¶",
                        "ç¼–è¾‘ç¯å¢ƒå˜é‡",
                        "å¯åŠ¨DockeræœåŠ¡",
                        "éªŒè¯æœåŠ¡çŠ¶æ€"
                    ],
                    "visuals": [
                        "ç¼–è¾‘.envæ–‡ä»¶çš„ç‰¹å†™",
                        "ç»ˆç«¯è¿è¡Œdocker-composeå‘½ä»¤",
                        "æµè§ˆå™¨è®¿é—®Odooç•Œé¢"
                    ],
                    "voiceover": "æˆ‘ä»¬ä½¿ç”¨Dockerè¿›è¡Œå¿«é€Ÿéƒ¨ç½²ï¼Œé¦–å…ˆé…ç½®ç¯å¢ƒå˜é‡..."
                },
                {
                    "scene": 3,
                    "title": "æ¨¡å—å®‰è£…",
                    "duration": "4åˆ†é’Ÿ",
                    "content": [
                        "ç™»å½•Odooç³»ç»Ÿ",
                        "æ¿€æ´»å¼€å‘è€…æ¨¡å¼",
                        "å®‰è£…å¾®ä¿¡æ”¯ä»˜æ¨¡å—",
                        "å®‰è£…å…¶ä»–ç›¸å…³æ¨¡å—"
                    ],
                    "visuals": [
                        "Odooç™»å½•ç•Œé¢",
                        "åº”ç”¨èœå•æœç´¢æ¨¡å—",
                        "æ¨¡å—å®‰è£…è¿›åº¦æ¡"
                    ],
                    "voiceover": "ç™»å½•ç³»ç»Ÿåï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…å„ä¸ªåŠŸèƒ½æ¨¡å—..."
                },
                {
                    "scene": 4,
                    "title": "åˆå§‹é…ç½®",
                    "duration": "4åˆ†é’Ÿ",
                    "content": [
                        "é…ç½®å…¬å¸ä¿¡æ¯",
                        "è®¾ç½®æ”¯ä»˜å‚æ•°",
                        "æµ‹è¯•æ”¯ä»˜åŠŸèƒ½",
                        "éªŒè¯å®‰è£…"
                    ],
                    "visuals": [
                        "é…ç½®ç•Œé¢çš„å¡«å†™è¿‡ç¨‹",
                        "æ”¯ä»˜æµ‹è¯•çš„æˆåŠŸé¡µé¢",
                        "ç³»ç»Ÿæ­£å¸¸è¿è¡Œçš„å…¨æ™¯"
                    ],
                    "voiceover": "æœ€åè¿›è¡Œå¿…è¦çš„åˆå§‹é…ç½®ï¼Œå¹¶æµ‹è¯•ç³»ç»ŸåŠŸèƒ½æ˜¯å¦æ­£å¸¸..."
                }
            ],
            
            "key_points": [
                "ç¡®ä¿ç³»ç»Ÿç¯å¢ƒæ»¡è¶³è¦æ±‚",
                "æ­£ç¡®é…ç½®ç¯å¢ƒå˜é‡",
                "æŒ‰é¡ºåºå®‰è£…æ¨¡å—",
                "æµ‹è¯•éªŒè¯ç³»ç»ŸåŠŸèƒ½"
            ],
            
            "troubleshooting": [
                "å¦‚æœDockerå¯åŠ¨å¤±è´¥ï¼Œæ£€æŸ¥ç«¯å£å ç”¨",
                "å¦‚æœæ¨¡å—å®‰è£…å¤±è´¥ï¼Œæ£€æŸ¥ä¾èµ–å…³ç³»",
                "å¦‚æœæ”¯ä»˜æµ‹è¯•å¤±è´¥ï¼Œæ£€æŸ¥é…ç½®å‚æ•°"
            ],
            
            "resources": [
                "éƒ¨ç½²åŒ…ä¸­çš„DEPLOYMENT.md",
                "ç¯å¢ƒé…ç½®æ–‡ä»¶æ¨¡æ¿",
                "å®‰è£…æ£€æŸ¥æ¸…å•"
            ]
        }
        
        self._save_script(script, "01_installation")
        return script
    
    def _create_wechat_payment_video(self):
        """åˆ›å»ºå¾®ä¿¡æ”¯ä»˜é…ç½®è§†é¢‘è„šæœ¬"""
        script = {
            "video_id": "WECHAT_PAYMENT_01",
            "title": "å¾®ä¿¡æ”¯ä»˜é…ç½®æŒ‡å—",
            "duration": "12åˆ†é’Ÿ",
            "target_audience": ["æ”¯ä»˜ç®¡ç†å‘˜", "è´¢åŠ¡äººå‘˜"],
            
            "scenes": [
                {
                    "scene": 1,
                    "title": "å‡†å¤‡å¾®ä¿¡å•†æˆ·èµ„æ–™",
                    "duration": "2åˆ†é’Ÿ",
                    "content": [
                        "ç™»å½•å¾®ä¿¡æ”¯ä»˜å•†æˆ·å¹³å°",
                        "è·å–å•†æˆ·å·(MCHID)",
                        "è·å–APIv3å¯†é’¥",
                        "ä¸‹è½½å•†æˆ·è¯ä¹¦"
                    ],
                    "visuals": [
                        "å¾®ä¿¡æ”¯ä»˜å•†æˆ·å¹³å°ç•Œé¢",
                        "APIå¯†é’¥ç®¡ç†é¡µé¢",
                        "è¯ä¹¦ä¸‹è½½é¡µé¢"
                    ]
                },
                {
                    "scene": 2,
                    "title": "é…ç½®æ”¯ä»˜æä¾›å•†",
                    "duration": "4åˆ†é’Ÿ",
                    "content": [
                        "è¿›å…¥Odooæ”¯ä»˜æä¾›å•†é…ç½®",
                        "åˆ›å»ºå¾®ä¿¡æ”¯ä»˜æä¾›å•†",
                        "å¡«å†™å•†æˆ·ä¿¡æ¯",
                        "ä¸Šä¼ è¯ä¹¦æ–‡ä»¶"
                    ],
                    "visuals": [
                        "Odooæ”¯ä»˜é…ç½®ç•Œé¢",
                        "è¡¨å•å¡«å†™è¿‡ç¨‹",
                        "æ–‡ä»¶ä¸Šä¼ è¿‡ç¨‹"
                    ]
                },
                {
                    "scene": 3,
                    "title": "æµ‹è¯•æ”¯ä»˜åŠŸèƒ½",
                    "duration": "3åˆ†é’Ÿ",
                    "content": [
                        "åˆ›å»ºæµ‹è¯•è®¢å•",
                        "é€‰æ‹©å¾®ä¿¡æ”¯ä»˜",
                        "ä½¿ç”¨æµ‹è¯•å·¥å…·æ”¯ä»˜",
                        "éªŒè¯å›è°ƒç»“æœ"
                    ],
                    "visuals": [
                        "åˆ›å»ºè®¢å•æµç¨‹",
                        "æ”¯ä»˜äºŒç»´ç ç”Ÿæˆ",
                        "æ”¯ä»˜æˆåŠŸé¡µé¢"
                    ]
                },
                {
                    "scene": 4,
                    "title": "é«˜çº§é…ç½®",
                    "duration": "3åˆ†é’Ÿ",
                    "content": [
                        "é…ç½®JSAPIæ”¯ä»˜",
                        "é…ç½®å°ç¨‹åºæ”¯ä»˜",
                        "è®¾ç½®é€€æ¬¾è§„åˆ™",
                        "é…ç½®åˆ†è´¦åŠŸèƒ½"
                    ],
                    "visuals": [
                        "JSAPIæ”¯ä»˜é…ç½®ç•Œé¢",
                        "é€€æ¬¾è§„åˆ™è®¾ç½®",
                        "åˆ†è´¦é…ç½®é¡µé¢"
                    ]
                }
            ]
        }
        
        self._save_script(script, "02_wechat_payment")
        return script
    
    def _create_alipay_payment_video(self):
        """åˆ›å»ºæ”¯ä»˜å®é…ç½®è§†é¢‘è„šæœ¬"""
        script = {
            "video_id": "ALIPAY_PAYMENT_01",
            "title": "æ”¯ä»˜å®æ”¯ä»˜é…ç½®æŒ‡å—",
            "duration": "10åˆ†é’Ÿ",
            "target_audience": ["æ”¯ä»˜ç®¡ç†å‘˜", "è´¢åŠ¡äººå‘˜"],
            
            "scenes": [
                {
                    "scene": 1,
                    "title": "å‡†å¤‡æ”¯ä»˜å®å•†æˆ·èµ„æ–™",
                    "duration": "2åˆ†é’Ÿ",
                    "content": [
                        "ç™»å½•æ”¯ä»˜å®å¼€æ”¾å¹³å°",
                        "åˆ›å»ºåº”ç”¨",
                        "è·å–APPID",
                        "ç”Ÿæˆå¯†é’¥å¯¹"
                    ]
                },
                {
                    "scene": 2,
                    "title": "é…ç½®æ”¯ä»˜æä¾›å•†",
                    "duration": "3åˆ†é’Ÿ",
                    "content": [
                        "åˆ›å»ºæ”¯ä»˜å®æ”¯ä»˜æä¾›å•†",
                        "å¡«å†™åº”ç”¨ä¿¡æ¯",
                        "é…ç½®å¯†é’¥",
                        "è®¾ç½®å›è°ƒåœ°å€"
                    ]
                },
                {
                    "scene": 3,
                    "title": "æµ‹è¯•æ”¯ä»˜åŠŸèƒ½",
                    "duration": "3åˆ†é’Ÿ",
                    "content": [
                        "æ²™ç®±ç¯å¢ƒæµ‹è¯•",
                        "æ‰«ç æ”¯ä»˜æµ‹è¯•",
                        "ç½‘é¡µæ”¯ä»˜æµ‹è¯•",
                        "éªŒè¯äº¤æ˜“ç»“æœ"
                    ]
                },
                {
                    "scene": 4,
                    "title": "ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²",
                    "duration": "2åˆ†é’Ÿ",
                    "content": [
                        "åˆ‡æ¢ç”Ÿäº§ç¯å¢ƒ",
                        "é…ç½®æ­£å¼å¯†é’¥",
                        "è®¾ç½®å¯¹è´¦å‚æ•°",
                        "ç›‘æ§æ”¯ä»˜çŠ¶æ€"
                    ]
                }
            ]
        }
        
        self._save_script(script, "03_alipay_payment")
        return script
    
    def _create_pos_payment_video(self):
        """åˆ›å»ºPOSæ”¯ä»˜è§†é¢‘è„šæœ¬"""
        script = {
            "video_id": "POS_PAYMENT_01",
            "title": "POSæ”¶é“¶ç³»ç»Ÿæ”¯ä»˜é…ç½®",
            "duration": "15åˆ†é’Ÿ",
            "target_audience": ["æ”¶é“¶å‘˜", "åº—é•¿", "ITæ”¯æŒ"],
            
            "scenes": [
                {
                    "scene": 1,
                    "title": "POSç³»ç»Ÿè®¾ç½®",
                    "duration": "3åˆ†é’Ÿ",
                    "content": [
                        "å¯åŠ¨POSç³»ç»Ÿ",
                        "é…ç½®æ”¶é“¶å°",
                        "è¿æ¥ç¡¬ä»¶è®¾å¤‡",
                        "è®¾ç½®æ”¯ä»˜æ–¹å¼"
                    ]
                },
                {
                    "scene": 2,
                    "title": "æ‰«ç æ”¯ä»˜æ“ä½œ",
                    "duration": "4åˆ†é’Ÿ",
                    "content": [
                        "å•†å“æ‰«ç æ·»åŠ ",
                        "é€‰æ‹©å¾®ä¿¡æ”¯ä»˜",
                        "é¡¾å®¢æ‰«ç æ”¯ä»˜",
                        "æ‰“å°å°ç¥¨"
                    ]
                },
                {
                    "scene": 3,
                    "title": "è¢«æ‰«æ”¯ä»˜æ“ä½œ",
                    "duration": "3åˆ†é’Ÿ",
                    "content": [
                        "é€‰æ‹©æ‰«ç æ”¶æ¬¾",
                        "æ‰«æé¡¾å®¢ä»˜æ¬¾ç ",
                        "ç¡®è®¤æ”¯ä»˜ç»“æœ",
                        "å®Œæˆäº¤æ˜“"
                    ]
                },
                {
                    "scene": 4,
                    "title": "æ—¥ç»“ä¸å¯¹è´¦",
                    "duration": "5åˆ†é’Ÿ",
                    "content": [
                        "æ”¶é“¶å‘˜æ—¥ç»“æµç¨‹",
                        "ç°é‡‘æ¸…ç‚¹",
                        "æ”¯ä»˜å¯¹è´¦",
                        "å¼‚å¸¸å¤„ç†"
                    ]
                }
            ]
        }
        
        self._save_script(script, "04_pos_payment")
        return script
    
    def _create_wechat_platform_video(self):
        """åˆ›å»ºå…¬ä¼—å·ç®¡ç†è§†é¢‘è„šæœ¬"""
        script = {
            "video_id": "WECHAT_PLATFORM_01",
            "title": "å¾®ä¿¡å…¬ä¼—å·ç®¡ç†å¹³å°ä½¿ç”¨æŒ‡å—",
            "duration": "20åˆ†é’Ÿ",
            "target_audience": ["è¿è¥äººå‘˜", "å®¢æœäººå‘˜", "è¥é”€äººå‘˜"],
            
            "scenes": [
                {
                    "scene": 1,
                    "title": "å…¬ä¼—å·é…ç½®",
                    "duration": "5åˆ†é’Ÿ",
                    "content": [
                        "æ·»åŠ å…¬ä¼—å·",
                        "é…ç½®æœåŠ¡å™¨ä¿¡æ¯",
                        "åœ¨å¾®ä¿¡å¹³å°éªŒè¯",
                        "æµ‹è¯•æ¶ˆæ¯æ¥æ”¶"
                    ]
                },
                {
                    "scene": 2,
                    "title": "ç²‰ä¸ç®¡ç†",
                    "duration": "5åˆ†é’Ÿ",
                    "content": [
                        "æŸ¥çœ‹ç²‰ä¸åˆ—è¡¨",
                        "ç²‰ä¸åˆ†ç»„ç®¡ç†",
                        "æ ‡ç­¾ç®¡ç†",
                        "ç²‰ä¸åŒæ­¥è®¾ç½®"
                    ]
                },
                {
                    "scene": 3,
                    "title": "æ¶ˆæ¯ç®¡ç†",
                    "duration": "5åˆ†é’Ÿ",
                    "content": [
                        "è‡ªåŠ¨å›å¤è®¾ç½®",
                        "å…³é”®è¯å›å¤",
                        "å®¢æœæ¶ˆæ¯è½¬å‘",
                        "æ¨¡æ¿æ¶ˆæ¯å‘é€"
                    ]
                },
                {
                    "scene": 4,
                    "title": "èœå•ä¸ç´ æ",
                    "duration": "5åˆ†é’Ÿ",
                    "content": [
                        "è‡ªå®šä¹‰èœå•é…ç½®",
                        "å›¾æ–‡ç´ æç®¡ç†",
                        "å›¾ç‰‡è§†é¢‘ä¸Šä¼ ",
                        "èœå•å‘å¸ƒæµ‹è¯•"
                    ]
                }
            ]
        }
        
        self._save_script(script, "05_wechat_platform")
        return script
    
    def _create_miniprogram_video(self):
        """åˆ›å»ºå°ç¨‹åºç®¡ç†è§†é¢‘è„šæœ¬"""
        script = {
            "video_id": "MINIPROGRAM_01",
            "title": "å¾®ä¿¡å°ç¨‹åºåå°ç®¡ç†",
            "duration": "18åˆ†é’Ÿ",
            "target_audience": ["è¿è¥äººå‘˜", "äº§å“ç»ç†", "å¼€å‘äººå‘˜"],
            
            "scenes": [
                {
                    "scene": 1,
                    "title": "å°ç¨‹åºé…ç½®",
                    "duration": "4åˆ†é’Ÿ",
                    "content": [
                        "æ·»åŠ å°ç¨‹åº",
                        "é…ç½®APIåŸŸå",
                        "è®¾ç½®æ”¯ä»˜æƒé™",
                        "æµ‹è¯•ç™»å½•åŠŸèƒ½"
                    ]
                },
                {
                    "scene": 2,
                    "title": "å•†å“ç®¡ç†",
                    "duration": "5åˆ†é’Ÿ",
                    "content": [
                        "å•†å“åŒæ­¥è®¾ç½®",
                        "åˆ†ç±»ç®¡ç†",
                        "ä»·æ ¼ç­–ç•¥",
                        "åº“å­˜åŒæ­¥"
                    ]
                },
                {
                    "scene": 3,
                    "title": "è®¢å•ç®¡ç†",
                    "duration": "4åˆ†é’Ÿ",
                    "content": [
                        "æŸ¥çœ‹å°ç¨‹åºè®¢å•",
                        "è®¢å•å¤„ç†æµç¨‹",
                        "é€€æ¬¾å¤„ç†",
                        "ç‰©æµè·Ÿè¸ª"
                    ]
                },
                {
                    "scene": 4,
                    "title": "ç”¨æˆ·ä¸è¥é”€",
                    "duration": "5åˆ†é’Ÿ",
                    "content": [
                        "ç”¨æˆ·æ•°æ®åˆ†æ",
                        "ä¼˜æƒ åˆ¸ç®¡ç†",
                        "è¥é”€æ´»åŠ¨è®¾ç½®",
                        "æ•°æ®æŠ¥è¡¨æŸ¥çœ‹"
                    ]
                }
            ]
        }
        
        self._save_script(script, "06_miniprogram")
        return script
    
    def _create_troubleshooting_video(self):
        """åˆ›å»ºæ•…éšœæ’é™¤è§†é¢‘è„šæœ¬"""
        script = {
            "video_id": "TROUBLESHOOTING_01",
            "title": "å¸¸è§é—®é¢˜ä¸æ•…éšœæ’é™¤",
            "duration": "25åˆ†é’Ÿ",
            "target_audience": ["æ‰€æœ‰ç”¨æˆ·", "æŠ€æœ¯æ”¯æŒ"],
            
            "scenes": [
                {
                    "scene": 1,
                    "title": "å®‰è£…é—®é¢˜",
                    "duration": "5åˆ†é’Ÿ",
                    "content": [
                        "Dockerå¯åŠ¨å¤±è´¥",
                        "æ¨¡å—å®‰è£…å¤±è´¥",
                        "æ•°æ®åº“è¿æ¥é—®é¢˜",
                        "ç«¯å£å†²çªè§£å†³"
                    ]
                },
                {
                    "scene": 2,
                    "title": "æ”¯ä»˜é—®é¢˜",
                    "duration": "7åˆ†é’Ÿ",
                    "content": [
                        "æ”¯ä»˜å›è°ƒå¤±è´¥",
                        "è¯ä¹¦é”™è¯¯å¤„ç†",
                        "ç­¾åéªŒè¯å¤±è´¥",
                        "é‡å¤æ”¯ä»˜å¤„ç†"
                    ]
                },
                {
                    "scene": 3,
                    "title": "å¾®ä¿¡é—®é¢˜",
                    "duration": "6åˆ†é’Ÿ",
                    "content": [
                        "å…¬ä¼—å·é…ç½®å¤±è´¥",
                        "æ¶ˆæ¯æ— æ³•æ¥æ”¶",
                        "èœå•ä¸æ˜¾ç¤º",
                        "ç²‰ä¸åŒæ­¥å¤±è´¥"
                    ]
                },
                {
                    "scene": 4,
                    "title": "æ€§èƒ½é—®é¢˜",
                    "duration": "7åˆ†é’Ÿ",
                    "content": [
                        "ç³»ç»Ÿå“åº”ç¼“æ…¢",
                        "æ”¯ä»˜è¶…æ—¶å¤„ç†",
                        "æ•°æ®åº“ä¼˜åŒ–",
                        "ç¼“å­˜é…ç½®ä¼˜åŒ–"
                    ]
                }
            ]
        }
        
        self._save_script(script, "07_troubleshooting")
        return script
    
    def _create_video_catalog(self, videos):
        """åˆ›å»ºè§†é¢‘ç›®å½•"""
        catalog = {
            "project": "Odoo 19å¾®ä¿¡æ”¯ä»˜ä¸ç”Ÿæ€ç³»ç»Ÿé›†æˆé¡¹ç›®",
            "version": "1.0.0",
            "generated_date": datetime.now().isoformat(),
            "total_videos": len(videos),
            "total_duration": "115åˆ†é’Ÿ",
            "videos": []
        }
        
        for video in videos:
            catalog["videos"].append({
                "video_id": video["video_id"],
                "title": video["title"],
                "duration": video["duration"],
                "target_audience": video["target_audience"],
                "filename": f"{video['video_id']}.mp4"
            })
        
        catalog_path = self.output_dir / "VIDEO_CATALOG.json"
        with open(catalog_path, "w", encoding="utf-8") as f:
            json.dump(catalog, f, indent=2, ensure_ascii=False)
        
        # ç”ŸæˆREADMEæ–‡ä»¶
        readme = self._generate_video_readme(catalog)
        readme_path = self.output_dir / "README.md"
        readme_path.write_text(readme)
        
        print(f"\nğŸ“ è§†é¢‘ç›®å½•æ–‡ä»¶: {catalog_path}")
    
    def _generate_video_readme(self, catalog):
        """ç”Ÿæˆè§†é¢‘READMEæ–‡ä»¶"""
        readme = f"""# åŸ¹è®­è§†é¢‘åˆ¶ä½œæŒ‡å—

## é¡¹ç›®ä¿¡æ¯
- é¡¹ç›®åç§°: {catalog['project']}
- ç‰ˆæœ¬: {catalog['version']}
- ç”Ÿæˆæ—¥æœŸ: {catalog['generated_date']}
- è§†é¢‘æ€»æ•°: {catalog['total_videos']}
- æ€»æ—¶é•¿: {catalog['total_duration']}

## è§†é¢‘åˆ—è¡¨

| è§†é¢‘ID | æ ‡é¢˜ | æ—¶é•¿ | ç›®æ ‡è§‚ä¼— | ç”¨é€” |
|--------|------|------|----------|------|
"""
        
        for video in catalog["videos"]:
            audience = ", ".join(video["target_audience"])
            readme += f"| {video['video_id']} | {video['title']} | {video['duration']} | {audience} | åŸ¹è®­æ•™å­¦ |\n"
        
        readme += """

## åˆ¶ä½œè¦æ±‚

### æŠ€æœ¯è¦æ±‚
- åˆ†è¾¨ç‡: 1920x1080 (1080p)
- å¸§ç‡: 30fps
- ç¼–ç : H.264
- éŸ³é¢‘: AAC, 44.1kHz, 128kbps
- æ ¼å¼: MP4

### å†…å®¹è¦æ±‚
1. æ¯ä¸ªè§†é¢‘åŒ…å«ç‰‡å¤´ï¼ˆ5ç§’ï¼‰å’Œç‰‡å°¾ï¼ˆ5ç§’ï¼‰
2. ç‰‡å¤´åŒ…å«ï¼šè§†é¢‘æ ‡é¢˜ã€ç‰ˆæœ¬ä¿¡æ¯
3. ç‰‡å°¾åŒ…å«ï¼šè”ç³»æ–¹å¼ã€ç‰ˆæƒä¿¡æ¯
4. æ·»åŠ å­—å¹•ï¼ˆä¸­æ–‡ï¼‰
5. æ·»åŠ èƒŒæ™¯éŸ³ä¹ï¼ˆè½»æŸ”ï¼‰

### é£æ ¼è¦æ±‚
- ä¸“ä¸šã€æ¸…æ™°ã€ç®€æ´
- ç»Ÿä¸€é…è‰²æ–¹æ¡ˆ
- ç»Ÿä¸€å­—ä½“æ ·å¼
- ç»Ÿä¸€è½¬åœºæ•ˆæœ

## åˆ¶ä½œæµç¨‹

### 1. å‰æœŸå‡†å¤‡
1. é˜…è¯»è§†é¢‘è„šæœ¬
2. å‡†å¤‡æ¼”ç¤ºç¯å¢ƒ
3. å‡†å¤‡å°è¯è„šæœ¬
4. æ£€æŸ¥å½•åˆ¶è®¾å¤‡

### 2. å½•åˆ¶é˜¶æ®µ
1. å½•åˆ¶å±å¹•æ“ä½œ
2. å½•åˆ¶é…éŸ³
3. å½•åˆ¶ç¤ºèŒƒæ“ä½œï¼ˆå¦‚éœ€è¦ï¼‰
4. å½•åˆ¶æ•…éšœæ’é™¤æ¼”ç¤º

### 3. åæœŸåˆ¶ä½œ
1. è§†é¢‘å‰ªè¾‘
2. é…éŸ³åˆæˆ
3. æ·»åŠ å­—å¹•
4. æ·»åŠ ç‰¹æ•ˆ
5. è´¨é‡æ£€æŸ¥

### 4. å‘å¸ƒå‡†å¤‡
1. ç”Ÿæˆå¤šç§æ ¼å¼
2. æ·»åŠ æ°´å°
3. ç”Ÿæˆç¼©ç•¥å›¾
4. ç¼–å†™è¯´æ˜æ–‡æ¡£

## æ–‡ä»¶ç»“æ„

```
training_videos/
â”œâ”€â”€ scripts/              # è§†é¢‘è„šæœ¬
â”‚   â”œâ”€â”€ 01_installation.json
â”‚   â”œâ”€â”€ 02_wechat_payment.json
â”‚   â”œâ”€â”€ 03_alipay_payment.json
â”‚   â”œâ”€â”€ 04_pos_payment.json
â”‚   â”œâ”€â”€ 05_wechat_platform.json
â”‚   â”œâ”€â”€ 06_miniprogram.json
â”‚   â””â”€â”€ 07_troubleshooting.json
â”œâ”€â”€ assets/               # ç´ æèµ„æº
â”‚   â”œâ”€â”€ intro/           # ç‰‡å¤´ç´ æ
â”‚   â”œâ”€â”€ outro/           # ç‰‡å°¾ç´ æ
â”‚   â”œâ”€â”€ music/           # èƒŒæ™¯éŸ³ä¹
â”‚   â”œâ”€â”€ fonts/           # å­—ä½“æ–‡ä»¶
â”‚   â””â”€â”€ templates/       # æ¨¡æ¿æ–‡ä»¶
â”œâ”€â”€ raw_footage/         # åŸå§‹å½•åƒ
â”œâ”€â”€ edited/              # å‰ªè¾‘ç‰ˆæœ¬
â”œâ”€â”€ final/               # æœ€ç»ˆç‰ˆæœ¬
â”œâ”€â”€ VIDEO_CATALOG.json   # è§†é¢‘ç›®å½•
â””â”€â”€ README.md           # æœ¬æ–‡ä»¶
```

## é…éŸ³è¦æ±‚

### é…éŸ³äººå‘˜
- æ™®é€šè¯æ ‡å‡†
- å£°éŸ³æ¸…æ™°
- è¯­é€Ÿé€‚ä¸­
- å¯Œæœ‰æ„Ÿæƒ…

### å½•éŸ³ç¯å¢ƒ
- å®‰é™çš„ç¯å¢ƒ
- æ— å›å£°
- ä½¿ç”¨ä¸“ä¸šéº¦å…‹é£
- é‡‡æ ·ç‡44.1kHz

## å­—å¹•åˆ¶ä½œ

### æ ¼å¼è¦æ±‚
- æ ¼å¼: SRT
- ç¼–ç : UTF-8
- æ¯è¡Œä¸è¶…è¿‡20ä¸ªå­—ç¬¦
- æ¯å±ä¸è¶…è¿‡2è¡Œ

### æ—¶é—´è½´
- å­—å¹•æå‰0.5ç§’å‡ºç°
- å»¶è¿Ÿ0.5ç§’æ¶ˆå¤±
- ä¸é…éŸ³åŒæ­¥
- é‡è¦å†…å®¹é«˜äº®æ˜¾ç¤º

## å‘å¸ƒæ¸ é“

### å†…éƒ¨åŸ¹è®­
- å…¬å¸å†…ç½‘
- åŸ¹è®­å¹³å°
- é‚®ä»¶åˆ†å‘

### å®¢æˆ·äº¤ä»˜
- Uç›˜äº¤ä»˜
- åœ¨çº¿ä¸‹è½½
- äº‘ç›˜åˆ†äº«

### åœ¨çº¿å¹³å°
- è§†é¢‘ç½‘ç«™
- çŸ¥è¯†åº“
- å¸®åŠ©ä¸­å¿ƒ

## ç»´æŠ¤æ›´æ–°

### ç‰ˆæœ¬ç®¡ç†
- æ¯æ¬¡æ›´æ–°ä¿ç•™æ—§ç‰ˆæœ¬
- è®°å½•å˜æ›´å†…å®¹
- æ›´æ–°è„šæœ¬æ–‡ä»¶

### å†…å®¹æ›´æ–°
1. ç³»ç»ŸåŠŸèƒ½æ›´æ–°æ—¶
2. ç•Œé¢é‡å¤§æ”¹åŠ¨æ—¶
3. å‘ç°é”™è¯¯å†…å®¹æ—¶
4. å®¢æˆ·åé¦ˆéœ€è¦æ—¶

## è”ç³»æ–¹å¼

- è§†é¢‘åˆ¶ä½œ: video-team@example.com
- æŠ€æœ¯æ”¯æŒ: support@example.com
- ç´§æ€¥è”ç³»: 400-XXX-XXXX

---

*æœ€åæ›´æ–°: {datetime.now().strftime('%Y-%m-%d')}*
"""
        
        return readme
    
    def _save_script(self, script, filename):
        """ä¿å­˜è„šæœ¬æ–‡ä»¶"""
        script_path = self.output_dir / "scripts" / f"{filename}.json"
        script_path.parent.mkdir(exist_ok=True)
        
        with open(script_path, "w", encoding="utf-8") as f:
            json.dump(script, f, indent=2, ensure_ascii=False)
        
        print(f"  ğŸ“ {script['title']}")

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    generator = TrainingVideoScriptGenerator()
    videos = generator.generate_video_scripts()
    
    print("\nğŸ¬ åŸ¹è®­è§†é¢‘è„šæœ¬ç”Ÿæˆå®Œæˆï¼")
    print(f"ğŸ“ è¾“å‡ºç›®å½•: {generator.output_dir}")
    print("ğŸ“‹ ä¸‹ä¸€æ­¥:")
    print("1. æ ¹æ®è„šæœ¬å½•åˆ¶è§†é¢‘")
    print("2. è¿›è¡ŒåæœŸåˆ¶ä½œ")
    print("3. å‘å¸ƒåˆ°åŸ¹è®­å¹³å°")
```

#### **ä»»åŠ¡2ï¼šå¸¸è§é—®é¢˜è§£ç­”ç”Ÿæˆå™¨**
```python
# file: scripts/generate_faq.py

#!/usr/bin/env python3
"""
å¸¸è§é—®é¢˜è§£ç­”ç”Ÿæˆå™¨
è‡ªåŠ¨ç”Ÿæˆé¡¹ç›®çš„å¸¸è§é—®é¢˜è§£ç­”æ–‡æ¡£
"""

import json
from datetime import datetime
from pathlib import Path

class FAQGenerator:
    """å¸¸è§é—®é¢˜è§£ç­”ç”Ÿæˆå™¨"""
    
    def __init__(self, output_file="docs/FAQ.md"):
        self.output_file = Path(output_file)
        self.output_file.parent.mkdir(exist_ok=True)
        
    def generate_faq(self):
        """ç”Ÿæˆå¸¸è§é—®é¢˜è§£ç­”"""
        print("â“ ç”Ÿæˆå¸¸è§é—®é¢˜è§£ç­”...")
        
        faq_sections = [
            self._create_installation_faq(),
            self._create_payment_faq(),
            self._create_wechat_faq(),
            self._create_pos_faq(),
            self._create_troubleshooting_faq(),
            self._create_security_faq()
        ]
        
        faq_content = self._format_faq(faq_sections)
        
        with open(self.output_file, "w", encoding="utf-8") as f:
            f.write(faq_content)
        
        print(f"âœ… FAQæ–‡æ¡£ç”Ÿæˆå®Œæˆ: {self.output_file}")
        return faq_sections
    
    def _create_installation_faq(self):
        """åˆ›å»ºå®‰è£…ç›¸å…³FAQ"""
        return {
            "section": "å®‰è£…ä¸é…ç½®",
            "questions": [
                {
                    "q": "ç³»ç»Ÿæœ‰å“ªäº›ç¯å¢ƒè¦æ±‚ï¼Ÿ",
                    "a": "ç³»ç»Ÿéœ€è¦ä»¥ä¸‹ç¯å¢ƒï¼š\n- Python 3.10+\n- Odoo 19.0+\n- PostgreSQL 14+\n- Redis 6.0+ï¼ˆæ¨èï¼‰\n- è‡³å°‘8GBå†…å­˜ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®16GB+ï¼‰",
                    "tags": ["å®‰è£…", "ç¯å¢ƒ"],
                    "difficulty": "åˆçº§"
                },
                {
                    "q": "å¦‚ä½•é€‰æ‹©å®‰è£…æ–¹å¼ï¼Ÿ",
                    "a": "æä¾›ä¸‰ç§å®‰è£…æ–¹å¼ï¼š\n1. **Dockerå®‰è£…**ï¼ˆæ¨èï¼‰ï¼šé€‚åˆå¿«é€Ÿéƒ¨ç½²ï¼ŒåŒ…å«æ‰€æœ‰ä¾èµ–\n2. **ä¼ ç»Ÿå®‰è£…**ï¼šé€‚åˆå·²æœ‰Odooç¯å¢ƒ\n3. **æ‰‹åŠ¨å®‰è£…**ï¼šé€‚åˆé«˜çº§ç”¨æˆ·\n\nå»ºè®®æ–°æ‰‹ä½¿ç”¨Dockerå®‰è£…ã€‚",
                    "tags": ["å®‰è£…", "éƒ¨ç½²"],
                    "difficulty": "åˆçº§"
                },
                {
                    "q": "å®‰è£…æ—¶æç¤ºç«¯å£å†²çªæ€ä¹ˆåŠï¼Ÿ",
                    "a": "å¯ä»¥é‡‡å–ä»¥ä¸‹æªæ–½ï¼š\n1. æ£€æŸ¥ç«¯å£å ç”¨ï¼š`sudo netstat -tlnp | grep :8069`\n2. åœæ­¢å ç”¨ç«¯å£çš„è¿›ç¨‹\n3. ä¿®æ”¹Odooç«¯å£ï¼šåœ¨odoo.confä¸­è®¾ç½®`xmlrpc_port = 8069`\n4. ä½¿ç”¨å…¶ä»–å¯ç”¨ç«¯å£",
                    "tags": ["å®‰è£…", "æ•…éšœ"],
                    "difficulty": "ä¸­çº§"
                },
                {
                    "q": "æ¨¡å—å®‰è£…å¤±è´¥æ€ä¹ˆåŠï¼Ÿ",
                    "a": "æ£€æŸ¥ä»¥ä¸‹é—®é¢˜ï¼š\n1. **ä¾èµ–ç¼ºå¤±**ï¼šè¿è¡Œ`pip install -r requirements.txt`\n2. **æƒé™é—®é¢˜**ï¼šç¡®ä¿æœ‰æ¨¡å—ç›®å½•çš„è¯»å†™æƒé™\n3. **ç‰ˆæœ¬å†²çª**ï¼šæ£€æŸ¥Odooç‰ˆæœ¬å…¼å®¹æ€§\n4. **æ•°æ®åº“é—®é¢˜**ï¼šæ£€æŸ¥æ•°æ®åº“è¿æ¥å’Œæƒé™\n\nè¯¦ç»†é”™è¯¯ä¿¡æ¯å¯åœ¨æ—¥å¿—ä¸­æŸ¥çœ‹ã€‚",
                    "tags": ["å®‰è£…", "æ¨¡å—"],
                    "difficulty": "ä¸­çº§"
                }
            ]
        }
    
    def _create_payment_faq(self):
        """åˆ›å»ºæ”¯ä»˜ç›¸å…³FAQ"""
        return {
            "section": "æ”¯ä»˜é…ç½®",
            "questions": [
                {
                    "q": "å¦‚ä½•è·å–å¾®ä¿¡æ”¯ä»˜å•†æˆ·ä¿¡æ¯ï¼Ÿ",
                    "a": "éœ€è¦ä»¥ä¸‹ä¿¡æ¯ï¼š\n1. **å•†æˆ·å·(MCHID)**ï¼šåœ¨å¾®ä¿¡æ”¯ä»˜å•†æˆ·å¹³å°-è´¦æˆ·ä¸­å¿ƒè·å–\n2. **AppID**ï¼šå…¬ä¼—å·æˆ–å°ç¨‹åºçš„AppID\n3. **APIv3å¯†é’¥**ï¼šåœ¨APIå®‰å…¨ä¸­è®¾ç½®\n4. **å•†æˆ·è¯ä¹¦**ï¼šåœ¨APIå®‰å…¨ä¸­ä¸‹è½½\n\næ‰€æœ‰ä¿¡æ¯éƒ½éœ€è¦åœ¨å¾®ä¿¡æ”¯ä»˜å•†æˆ·å¹³å°ç”³è¯·å’Œè®¾ç½®ã€‚",
                    "tags": ["å¾®ä¿¡æ”¯ä»˜", "é…ç½®"],
                    "difficulty": "ä¸­çº§"
                },
                {
                    "q": "æ”¯ä»˜å®å¯†é’¥å¦‚ä½•ç”Ÿæˆï¼Ÿ",
                    "a": "ç”Ÿæˆæ­¥éª¤ï¼š\n1. ç™»å½•æ”¯ä»˜å®å¼€æ”¾å¹³å°\n2. è¿›å…¥\"å¯†é’¥ç®¡ç†\"\n3. ä½¿ç”¨å¯†é’¥ç”Ÿæˆå·¥å…·ç”ŸæˆRSAå¯†é’¥å¯¹\n4. ä¿å­˜åº”ç”¨ç§é’¥ï¼ˆç”¨äºç³»ç»Ÿé…ç½®ï¼‰\n5. è®¾ç½®æ”¯ä»˜å®å…¬é’¥ï¼ˆåœ¨å¼€æ”¾å¹³å°è®¾ç½®ï¼‰\n\næ³¨æ„ï¼šå¯†é’¥é•¿åº¦å»ºè®®2048ä½ã€‚",
                    "tags": ["æ”¯ä»˜å®", "å¯†é’¥"],
                    "difficulty": "ä¸­çº§"
                },
                {
                    "q": "æ”¯ä»˜å›è°ƒå¤±è´¥å¦‚ä½•å¤„ç†ï¼Ÿ",
                    "a": "æ’æŸ¥æ­¥éª¤ï¼š\n1. **æ£€æŸ¥ç½‘ç»œ**ï¼šç¡®ä¿æœåŠ¡å™¨èƒ½è®¿é—®å¤–ç½‘\n2. **æ£€æŸ¥é…ç½®**ï¼šç¡®è®¤å›è°ƒURLæ­£ç¡®é…ç½®\n3. **æ£€æŸ¥ç­¾å**ï¼šéªŒè¯å›è°ƒç­¾åæ˜¯å¦æ­£ç¡®\n4. **æŸ¥çœ‹æ—¥å¿—**ï¼šåœ¨æ”¯ä»˜æ—¥å¿—ä¸­æŸ¥çœ‹è¯¦ç»†é”™è¯¯\n5. **æµ‹è¯•å·¥å…·**ï¼šä½¿ç”¨å¾®ä¿¡/æ”¯ä»˜å®çš„æµ‹è¯•å·¥å…·éªŒè¯",
                    "tags": ["æ”¯ä»˜", "å›è°ƒ", "æ•…éšœ"],
                    "difficulty": "é«˜çº§"
                },
                {
                    "q": "å¦‚ä½•æµ‹è¯•æ”¯ä»˜åŠŸèƒ½ï¼Ÿ",
                    "a": "æµ‹è¯•æ–¹æ³•ï¼š\n1. **å¾®ä¿¡æ”¯ä»˜**ï¼šä½¿ç”¨æµ‹è¯•å•†æˆ·å·å’Œæµ‹è¯•é‡‘é¢ï¼ˆå¦‚0.01å…ƒï¼‰\n2. **æ”¯ä»˜å®**ï¼šä½¿ç”¨æ²™ç®±ç¯å¢ƒå’Œæµ‹è¯•è´¦å·\n3. **æµ‹è¯•æ­¥éª¤**ï¼š\n   - åˆ›å»ºæµ‹è¯•è®¢å•\n   - é€‰æ‹©æµ‹è¯•æ”¯ä»˜æ–¹å¼\n   - å®Œæˆæ”¯ä»˜æµç¨‹\n   - éªŒè¯è®¢å•çŠ¶æ€æ›´æ–°\n4. **éªŒè¯å›è°ƒ**ï¼šç¡®è®¤å›è°ƒæ­£ç¡®å¤„ç†",
                    "tags": ["æ”¯ä»˜", "æµ‹è¯•"],
                    "difficulty": "åˆçº§"
                },
                {
                    "q": "æ”¯ä»˜è¯ä¹¦è¿‡æœŸæ€ä¹ˆåŠï¼Ÿ",
                    "a": "å¤„ç†æµç¨‹ï¼š\n1. **å¾®ä¿¡æ”¯ä»˜**ï¼šè¯ä¹¦æœ‰æ•ˆæœŸä¸º3å¹´ï¼Œæå‰1ä¸ªæœˆåœ¨å•†æˆ·å¹³å°æ›´æ–°\n2. **æ”¯ä»˜å®**ï¼šå¯†é’¥é•¿æœŸæœ‰æ•ˆï¼Œå»ºè®®æ¯å¹´æ£€æŸ¥\n3. **æ›´æ–°æ­¥éª¤**ï¼š\n   - ä¸‹è½½æ–°è¯ä¹¦\n   - æ›´æ–°ç³»ç»Ÿé…ç½®\n   - æµ‹è¯•æ”¯ä»˜åŠŸèƒ½\n   - ç›‘æ§æ”¯ä»˜æˆåŠŸç‡\n\nå»ºè®®è®¾ç½®è¯ä¹¦åˆ°æœŸæé†’ã€‚",
                    "tags": ["æ”¯ä»˜", "è¯ä¹¦", "ç»´æŠ¤"],
                    "difficulty": "ä¸­çº§"
                }
            ]
        }
    
    def _create_wechat_faq(self):
        """åˆ›å»ºå¾®ä¿¡ç›¸å…³FAQ"""
        return {
            "section": "å¾®ä¿¡å…¬ä¼—å·ä¸å°ç¨‹åº",
            "questions": [
                {
                    "q": "å…¬ä¼—å·æœåŠ¡å™¨é…ç½®å¤±è´¥æ€ä¹ˆåŠï¼Ÿ",
                    "a": "å¸¸è§åŸå› å’Œè§£å†³ï¼š\n1. **Tokenä¸åŒ¹é…**ï¼šç¡®ä¿ç³»ç»Ÿé…ç½®ä¸å¾®ä¿¡å¹³å°ä¸€è‡´\n2. **URLé”™è¯¯**ï¼šç¡®è®¤æœåŠ¡å™¨åœ°å€å¯å…¬å¼€è®¿é—®\n3. **ç¼–ç é”™è¯¯**ï¼šç¡®ä¿æ¶ˆæ¯åŠ è§£å¯†é…ç½®æ­£ç¡®\n4. **ç½‘ç»œé—®é¢˜**ï¼šæ£€æŸ¥æœåŠ¡å™¨ç½‘ç»œè¿æ¥\n\néªŒè¯æ–¹æ³•ï¼šä½¿ç”¨å¾®ä¿¡å…¬ä¼—å¹³å°çš„éªŒè¯å·¥å…·ã€‚",
                    "tags": ["å…¬ä¼—å·", "é…ç½®"],
                    "difficulty": "ä¸­çº§"
                },
                {
                    "q": "ç²‰ä¸åŒæ­¥å¤±è´¥å¦‚ä½•å¤„ç†ï¼Ÿ",
                    "a": "æ’æŸ¥æ­¥éª¤ï¼š\n1. **æ£€æŸ¥æƒé™**ï¼šç¡®ä¿å…¬ä¼—å·æœ‰ç”¨æˆ·ç®¡ç†æƒé™\n2. **æ£€æŸ¥Token**ï¼šç¡®è®¤Access Tokenæœ‰æ•ˆ\n3. **æŸ¥çœ‹æ—¥å¿—**ï¼šåœ¨å…¬ä¼—å·æ—¥å¿—ä¸­æŸ¥çœ‹é”™è¯¯\n4. **æ‰‹åŠ¨åŒæ­¥**ï¼šå°è¯•æ‰‹åŠ¨åŒæ­¥ç²‰ä¸\n5. **è”ç³»æ”¯æŒ**ï¼šå¦‚é—®é¢˜æŒç»­ï¼Œè”ç³»æŠ€æœ¯æ”¯æŒ",
                    "tags": ["å…¬ä¼—å·", "ç²‰ä¸", "åŒæ­¥"],
                    "difficulty": "ä¸­çº§"
                },
                {
                    "q": "å°ç¨‹åºæ— æ³•ç™»å½•æ€ä¹ˆåŠï¼Ÿ",
                    "a": "æ£€æŸ¥ä»¥ä¸‹é…ç½®ï¼š\n1. **AppIDé…ç½®**ï¼šç¡®è®¤å°ç¨‹åºAppIDæ­£ç¡®\n2. **æœåŠ¡å™¨åŸŸå**ï¼šé…ç½®æ­£ç¡®çš„requeståŸŸå\n3. **ä»£ç æ£€æŸ¥**ï¼šç¡®è®¤wx.loginè°ƒç”¨æ­£ç¡®\n4. **ç½‘ç»œæƒé™**ï¼šç¡®ä¿æœåŠ¡å™¨èƒ½è®¿é—®å¾®ä¿¡API\n\næµ‹è¯•æ–¹æ³•ï¼šä½¿ç”¨å¾®ä¿¡å¼€å‘è€…å·¥å…·è°ƒè¯•ã€‚",
                    "tags": ["å°ç¨‹åº", "ç™»å½•"],
                    "difficulty": "ä¸­çº§"
                },
                {
                    "q": "å¦‚ä½•é…ç½®æ¨¡æ¿æ¶ˆæ¯ï¼Ÿ",
                    "a": "é…ç½®æ­¥éª¤ï¼š\n1. **ç”³è¯·æ¨¡æ¿**ï¼šåœ¨å¾®ä¿¡å…¬ä¼—å¹³å°ç”³è¯·æ¶ˆæ¯æ¨¡æ¿\n2. **è·å–æ¨¡æ¿ID**ï¼šè®°å½•æ¨¡æ¿ID\n3. **ç³»ç»Ÿé…ç½®**ï¼šåœ¨å…¬ä¼—å·ç®¡ç†ä¸­é…ç½®æ¨¡æ¿\n4. **æµ‹è¯•å‘é€**ï¼šå‘é€æµ‹è¯•æ¶ˆæ¯éªŒè¯\n5. **ç›‘æ§çŠ¶æ€**ï¼šç›‘æ§æ¶ˆæ¯å‘é€æˆåŠŸç‡",
                    "tags": ["å…¬ä¼—å·", "æ¨¡æ¿æ¶ˆæ¯"],
                    "difficulty": "ä¸­çº§"
                }
            ]
        }
    
    def _create_pos_faq(self):
        """åˆ›å»ºPOSç›¸å…³FAQ"""
        return {
            "section": "POSæ”¶é“¶ç³»ç»Ÿ",
            "questions": [
                {
                    "q": "POSæ‰«ç æªæ— æ³•ä½¿ç”¨æ€ä¹ˆåŠï¼Ÿ",
                    "a": "æ’æŸ¥æ­¥éª¤ï¼š\n1. **ç¡¬ä»¶æ£€æŸ¥**ï¼šæ£€æŸ¥æ‰«ç æªç”µæºå’Œè¿æ¥\n2. **é©±åŠ¨æ£€æŸ¥**ï¼šç¡®è®¤é©±åŠ¨ç¨‹åºå·²å®‰è£…\n3. **é…ç½®æ£€æŸ¥**ï¼šæ£€æŸ¥POSæ‰«ç æªé…ç½®\n4. **æµ‹è¯•å·¥å…·**ï¼šä½¿ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æµ‹è¯•æ‰«ç åŠŸèƒ½\n5. **æ›´æ¢è®¾å¤‡**ï¼šå¦‚ç¡¬ä»¶æ•…éšœï¼Œæ›´æ¢æ‰«ç æª",
                    "tags": ["POS", "ç¡¬ä»¶", "æ‰«ç æª"],
                    "difficulty": "åˆçº§"
                },
                {
                    "q": "POSæ”¯ä»˜è¶…æ—¶å¦‚ä½•å¤„ç†ï¼Ÿ",
                    "a": "å¤„ç†æµç¨‹ï¼š\n1. **æ£€æŸ¥ç½‘ç»œ**ï¼šç¡®è®¤POSæœºç½‘ç»œè¿æ¥æ­£å¸¸\n2. **æŸ¥è¯¢çŠ¶æ€**ï¼šä½¿ç”¨\"æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€\"åŠŸèƒ½\n3. **é‡æ–°æ”¯ä»˜**ï¼šå¦‚è¶…æ—¶ï¼Œé‡æ–°å‘èµ·æ”¯ä»˜\n4. **æ£€æŸ¥æ—¥å¿—**ï¼šæŸ¥çœ‹æ”¯ä»˜ç»ˆç«¯æ—¥å¿—\n5. **è”ç³»æ”¯æŒ**ï¼šå¦‚é—®é¢˜æŒç»­ï¼Œè”ç³»æ”¯ä»˜æœåŠ¡å•†",
                    "tags": ["POS", "æ”¯ä»˜", "è¶…æ—¶"],
                    "difficulty": "ä¸­çº§"
                },
                {
                    "q": "æ—¥ç»“æ•°æ®ä¸ä¸€è‡´æ€ä¹ˆåŠï¼Ÿ",
                    "a": "æ ¸å¯¹æ­¥éª¤ï¼š\n1. **ç°é‡‘æ ¸å¯¹**ï¼šé‡æ–°æ¸…ç‚¹ç°é‡‘\n2. **æ”¯ä»˜æ ¸å¯¹**ï¼šæ ¸å¯¹å„æ”¯ä»˜æ¸ é“äº¤æ˜“è®°å½•\n3. **è®¢å•æ ¸å¯¹**ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆè®¢å•\n4. **ç³»ç»Ÿæ ¸å¯¹**ï¼šæ ¸å¯¹ç³»ç»Ÿæ—¥å¿—å’Œæ•°æ®åº“\n5. **å·®å¼‚å¤„ç†**ï¼šè®°å½•å·®å¼‚åŸå› ï¼Œè¿›è¡Œè°ƒè´¦",
                    "tags": ["POS", "æ—¥ç»“", "å¯¹è´¦"],
                    "difficulty": "é«˜çº§"
                },
                {
                    "q": "å¦‚ä½•åŸ¹è®­æ”¶é“¶å‘˜ä½¿ç”¨POSï¼Ÿ",
                    "a": "åŸ¹è®­å»ºè®®ï¼š\n1. **ç†è®ºåŸ¹è®­**ï¼šè®²è§£æ”¯ä»˜æµç¨‹å’Œå®‰å…¨è§„èŒƒ\n2. **æ“ä½œåŸ¹è®­**ï¼šæ¼”ç¤ºå„ç§æ”¯ä»˜æ–¹å¼æ“ä½œ\n3. **æ¨¡æ‹Ÿç»ƒä¹ **ï¼šä½¿ç”¨æµ‹è¯•æ¨¡å¼è¿›è¡Œç»ƒä¹ \n4. **è€ƒæ ¸è®¤è¯**ï¼šé€šè¿‡è€ƒæ ¸åæ‰èƒ½ä¸Šå²—\n5. **æŒç»­åŸ¹è®­**ï¼šå®šæœŸè¿›è¡Œå¤è®­å’Œæ›´æ–°åŸ¹è®­",
                    "tags": ["POS", "åŸ¹è®­", "æ“ä½œ"],
                    "difficulty": "åˆçº§"
                }
            ]
        }
    
    def _create_troubleshooting_faq(self):
        """åˆ›å»ºæ•…éšœæ’é™¤FAQ"""
        return {
            "section": "æ•…éšœæ’é™¤",
            "questions": [
                {
                    "q": "ç³»ç»Ÿå“åº”ç¼“æ…¢å¦‚ä½•ä¼˜åŒ–ï¼Ÿ",
                    "a": "ä¼˜åŒ–å»ºè®®ï¼š\n1. **ç¡¬ä»¶å‡çº§**ï¼šå¢åŠ å†…å­˜ã€ä½¿ç”¨SSD\n2. **æ•°æ®åº“ä¼˜åŒ–**ï¼šåˆ›å»ºç´¢å¼•ã€å®šæœŸç»´æŠ¤\n3. **ç¼“å­˜é…ç½®**ï¼šå¯ç”¨Redisç¼“å­˜\n4. **ä»£ç ä¼˜åŒ–**ï¼šä¼˜åŒ–æŸ¥è¯¢è¯­å¥ï¼Œå‡å°‘N+1æŸ¥è¯¢\n5. **ç›‘æ§åˆ†æ**ï¼šä½¿ç”¨ç›‘æ§å·¥å…·åˆ†ææ€§èƒ½ç“¶é¢ˆ",
                    "tags": ["æ€§èƒ½", "ä¼˜åŒ–"],
                    "difficulty": "é«˜çº§"
                },
                {
                    "q": "æ•°æ®åº“è¿æ¥å¤±è´¥æ€ä¹ˆåŠï¼Ÿ",
                    "a": "æ’æŸ¥æ­¥éª¤ï¼š\n1. **æ£€æŸ¥æœåŠ¡**ï¼šç¡®è®¤PostgreSQLæœåŠ¡è¿è¡Œæ­£å¸¸\n2. **æ£€æŸ¥é…ç½®**ï¼šç¡®è®¤æ•°æ®åº“è¿æ¥é…ç½®æ­£ç¡®\n3. **æ£€æŸ¥æƒé™**ï¼šç¡®è®¤æ•°æ®åº“ç”¨æˆ·æœ‰è¿æ¥æƒé™\n4. **æ£€æŸ¥ç½‘ç»œ**ï¼šç¡®è®¤ç½‘ç»œè¿æ¥æ­£å¸¸\n5. **æŸ¥çœ‹æ—¥å¿—**ï¼šæŸ¥çœ‹æ•°æ®åº“æ—¥å¿—å’ŒOdooæ—¥å¿—",
                    "tags": ["æ•°æ®åº“", "è¿æ¥"],
                    "difficulty": "ä¸­çº§"
                },
                {
                    "q": "å¦‚ä½•æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—ï¼Ÿ",
                    "a": "æ—¥å¿—ä½ç½®ï¼š\n1. **Odooæ—¥å¿—**ï¼š`/var/log/odoo/odoo.log`\n2. **æ”¯ä»˜æ—¥å¿—**ï¼šåœ¨Odooç•Œé¢æŸ¥çœ‹æ”¯ä»˜æ—¥å¿—\n3. **æ•°æ®åº“æ—¥å¿—**ï¼š`/var/log/postgresql/`\n4. **ç³»ç»Ÿæ—¥å¿—**ï¼š`/var/log/syslog`\n\næŸ¥çœ‹å‘½ä»¤ï¼š`tail -f /var/log/odoo/odoo.log`",
                    "tags": ["æ—¥å¿—", "è°ƒè¯•"],
                    "difficulty": "åˆçº§"
                },
                {
                    "q": "æ•°æ®å¤‡ä»½å’Œæ¢å¤æ€ä¹ˆåšï¼Ÿ",
                    "a": "å¤‡ä»½æ–¹æ¡ˆï¼š\n1. **è‡ªåŠ¨å¤‡ä»½**ï¼šé…ç½®è®¡åˆ’ä»»åŠ¡è‡ªåŠ¨å¤‡ä»½\n2. **æ‰‹åŠ¨å¤‡ä»½**ï¼šä½¿ç”¨Odooçš„å¤‡ä»½åŠŸèƒ½\n3. **æ–‡ä»¶å¤‡ä»½**ï¼šå¤‡ä»½æ–‡ä»¶å­˜å‚¨ç›®å½•\n4. **æ¢å¤æµ‹è¯•**ï¼šå®šæœŸæµ‹è¯•å¤‡ä»½æ¢å¤åŠŸèƒ½\n5. **å¼‚åœ°å¤‡ä»½**ï¼šé‡è¦æ•°æ®åšå¼‚åœ°å¤‡ä»½",
                    "tags": ["å¤‡ä»½", "æ¢å¤", "æ•°æ®"],
                    "difficulty": "ä¸­çº§"
                }
            ]
        }
    
    def _create_security_faq(self):
        """åˆ›å»ºå®‰å…¨ç›¸å…³FAQ"""
        return {
            "section": "å®‰å…¨ä¸åˆè§„",
            "questions": [
                {
                    "q": "å¦‚ä½•ç¡®ä¿æ”¯ä»˜å®‰å…¨ï¼Ÿ",
                    "a": "å®‰å…¨æªæ–½ï¼š\n1. **APIç­¾å**ï¼šæ‰€æœ‰æ”¯ä»˜è¯·æ±‚å¿…é¡»ç­¾åéªŒè¯\n2. **è¯ä¹¦ç®¡ç†**ï¼šå®šæœŸæ›´æ–°æ”¯ä»˜è¯ä¹¦\n3. **æ•°æ®åŠ å¯†**ï¼šæ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨\n4. **è®¿é—®æ§åˆ¶**ï¼šé™åˆ¶æ”¯ä»˜ç›¸å…³æ“ä½œæƒé™\n5. **å®¡è®¡æ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰æ”¯ä»˜æ“ä½œæ—¥å¿—",
                    "tags": ["å®‰å…¨", "æ”¯ä»˜", "åˆè§„"],
                    "difficulty": "é«˜çº§"
                },
                {
                    "q": "éœ€è¦å“ªäº›åˆè§„è®¤è¯ï¼Ÿ",
                    "a": "ä¸»è¦åˆè§„è¦æ±‚ï¼š\n1. **PCI DSS**ï¼šæ”¯ä»˜å¡è¡Œä¸šæ•°æ®å®‰å…¨æ ‡å‡†\n2. **ç­‰çº§ä¿æŠ¤**ï¼šç½‘ç»œå®‰å…¨ç­‰çº§ä¿æŠ¤\n3. **æ•°æ®å®‰å…¨æ³•**ï¼šä¸ªäººä¿¡æ¯ä¿æŠ¤è¦æ±‚\n4. **è¡Œä¸šè§„èŒƒ**ï¼šæ”¯ä»˜è¡Œä¸šç›¸å…³è§„èŒƒ\n\nå»ºè®®å’¨è¯¢ä¸“ä¸šåˆè§„é¡¾é—®ã€‚",
                    "tags": ["åˆè§„", "å®‰å…¨", "è®¤è¯"],
                    "difficulty": "é«˜çº§"
                },
                {
                    "q": "å¦‚ä½•é˜²æ­¢SQLæ³¨å…¥æ”»å‡»ï¼Ÿ",
                    "a": "é˜²æŠ¤æªæ–½ï¼š\n1. **ä½¿ç”¨ORM**ï¼šä½¿ç”¨Odoo ORMè€Œä¸æ˜¯åŸç”ŸSQL\n2. **å‚æ•°åŒ–æŸ¥è¯¢**ï¼šå¿…é¡»ä½¿ç”¨æ—¶ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢\n3. **è¾“å…¥éªŒè¯**ï¼šæ‰€æœ‰è¾“å…¥æ•°æ®å¿…é¡»éªŒè¯\n4. **æƒé™é™åˆ¶**ï¼šæ•°æ®åº“ç”¨æˆ·ä½¿ç”¨æœ€å°æƒé™\n5. **å®‰å…¨å®¡è®¡**ï¼šå®šæœŸè¿›è¡Œå®‰å…¨ä»£ç å®¡è®¡",
                    "tags": ["å®‰å…¨", "SQLæ³¨å…¥", "é˜²æŠ¤"],
                    "difficulty": "é«˜çº§"
                },
                {
                    "q": "æ•æ„Ÿæ•°æ®å¦‚ä½•ä¿æŠ¤ï¼Ÿ",
                    "a": "ä¿æŠ¤æªæ–½ï¼š\n1. **åŠ å¯†å­˜å‚¨**ï¼šå¯†ç ã€å¯†é’¥ç­‰æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨\n2. **æ•°æ®è„±æ•**ï¼šæ˜¾ç¤ºæ—¶è¿›è¡Œæ•°æ®è„±æ•\n3. **è®¿é—®æ§åˆ¶**ï¼šä¸¥æ ¼é™åˆ¶æ•°æ®è®¿é—®æƒé™\n4. **ä¼ è¾“åŠ å¯†**ï¼šä½¿ç”¨HTTPSåŠ å¯†ä¼ è¾“\n5. **å®šæœŸæ¸…ç†**ï¼šå®šæœŸæ¸…ç†ä¸å¿…è¦çš„æ•æ„Ÿæ•°æ®",
                    "tags": ["å®‰å…¨", "æ•°æ®", "éšç§"],
                    "difficulty": "ä¸­çº§"
                }
            ]
        }
    
    def _format_faq(self, sections):
        """æ ¼å¼åŒ–FAQæ–‡æ¡£"""
        faq_content = f"""# å¸¸è§é—®é¢˜è§£ç­” (FAQ)

> æœ€åæ›´æ–°ï¼š{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
> 
> æœ¬æ–‡æ¡£æä¾›Odoo 19å¾®ä¿¡æ”¯ä»˜ä¸ç”Ÿæ€ç³»ç»Ÿé›†æˆé¡¹ç›®çš„å¸¸è§é—®é¢˜è§£ç­”ã€‚

## ğŸ“‹ ç›®å½•

"""
        
        # ç”Ÿæˆç›®å½•
        for i, section in enumerate(sections, 1):
            faq_content += f"{i}. [{section['section']}](#{section['section'].replace(' ', '-')})\n"
        
        faq_content += "\n---\n\n"
        
        # ç”Ÿæˆå„ç« èŠ‚å†…å®¹
        for section in sections:
            faq_content += f"## {section['section']}\n\n"
            
            for j, qa in enumerate(section['questions'], 1):
                tags = " ".join([f"`{tag}`" for tag in qa['tags']])
                faq_content += f"### Q{j}: {qa['q']}\n\n"
                faq_content += f"**éš¾åº¦**: {qa['difficulty']}  |  **æ ‡ç­¾**: {tags}\n\n"
                faq_content += f"{qa['a']}\n\n"
                
                if j < len(section['questions']):
                    faq_content += "---\n\n"
            
            faq_content += "\n"
        
        # æ·»åŠ é™„å½•
        faq_content += self._generate_appendix()
        
        return faq_content
    
    def _generate_appendix(self):
        """ç”Ÿæˆé™„å½•"""
        return f"""## ğŸ“ è”ç³»æ”¯æŒ

å¦‚æœæ‚¨çš„é—®é¢˜æœªåœ¨æœ¬æ–‡æ¡£ä¸­æ‰¾åˆ°ç­”æ¡ˆï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»æˆ‘ä»¬ï¼š

### æŠ€æœ¯æ”¯æŒ
- ğŸ“§ é‚®ç®±: support@example.com
- ğŸ“± ç”µè¯: 400-XXX-XXXX (å·¥ä½œæ—¥ 9:00-18:00)
- ğŸ’¬ åœ¨çº¿å®¢æœ: ç³»ç»Ÿå³ä¸‹è§’ã€Œåœ¨çº¿å¸®åŠ©ã€

### æ–‡æ¡£èµ„æº
- [ç”¨æˆ·æ‰‹å†Œ](docs/ç”¨æˆ·æ–‡æ¡£/01-ç³»ç»Ÿç®¡ç†å‘˜æ‰‹å†Œ.md)
- [éƒ¨ç½²æŒ‡å—](docs/æŠ€æœ¯æ–‡æ¡£/04-éƒ¨ç½²è¿ç»´æ‰‹å†Œ.md)
- [APIæ–‡æ¡£](docs/APIæ–‡æ¡£/)
- [è§†é¢‘æ•™ç¨‹](training_videos/)

### ç¤¾åŒºæ”¯æŒ
- ğŸ’¬ æŠ€æœ¯è®ºå›: https://forum.example.com
- ğŸ› Bugåé¦ˆ: GitHub Issues
- ğŸ’¡ åŠŸèƒ½å»ºè®®: äº§å“åé¦ˆè¡¨å•

## ğŸ”„ æ–‡æ¡£æ›´æ–°

### æ›´æ–°é¢‘ç‡
- æ¯æœˆæ›´æ–°ä¸€æ¬¡å¸¸è§„å†…å®¹
- ç³»ç»Ÿé‡å¤§æ›´æ–°æ—¶ç«‹å³æ›´æ–°
- æ ¹æ®ç”¨æˆ·åé¦ˆæŒç»­å®Œå–„

### è´¡çŒ®æŒ‡å—
æ¬¢è¿è´¡çŒ®FAQå†…å®¹ï¼š
1. Forké¡¹ç›®ä»“åº“
2. æ·»åŠ æˆ–ä¿®æ”¹FAQå†…å®¹
3. æäº¤Pull Request
4. æˆ‘ä»¬ä¼šå°½å¿«å®¡æ ¸åˆå¹¶

### ç‰ˆæœ¬å†å²
| ç‰ˆæœ¬ | æ›´æ–°æ—¥æœŸ | æ›´æ–°å†…å®¹ |
|------|----------|----------|
| v1.0 | 2024-01-01 | åˆå§‹ç‰ˆæœ¬ |
| v1.1 | 2024-02-01 | å¢åŠ æ”¯ä»˜é—®é¢˜è§£ç­” |

## ğŸ“Š é—®é¢˜åˆ†ç±»ç»Ÿè®¡

### æŒ‰éš¾åº¦åˆ†ç±»
- åˆçº§é—®é¢˜: é€‚åˆæ–°ç”¨æˆ·çš„åŸºç¡€é—®é¢˜
- ä¸­çº§é—®é¢˜: éœ€è¦ä¸€å®šæŠ€æœ¯çŸ¥è¯†çš„é—®é¢˜  
- é«˜çº§é—®é¢˜: éœ€è¦ä¸“ä¸šæŠ€æœ¯çŸ¥è¯†çš„é—®é¢˜

### æŒ‰æ¨¡å—åˆ†ç±»
- å®‰è£…é…ç½®: ç³»ç»Ÿå®‰è£…å’Œç¯å¢ƒé…ç½®
- æ”¯ä»˜åŠŸèƒ½: æ”¯ä»˜é…ç½®å’Œæ•…éšœå¤„ç†
- å¾®ä¿¡ç”Ÿæ€: å…¬ä¼—å·å’Œå°ç¨‹åºç®¡ç†
- POSç³»ç»Ÿ: æ”¶é“¶ç³»ç»Ÿæ“ä½œå’Œç»´æŠ¤
- å®‰å…¨åˆè§„: å®‰å…¨å’Œåˆè§„ç›¸å…³é—®é¢˜
- æ•…éšœæ’é™¤: å„ç±»æ•…éšœå¤„ç†æ–¹æ³•

## ğŸ¯ ä½¿ç”¨å»ºè®®

### æŸ¥æ‰¾é—®é¢˜
1. ä½¿ç”¨æµè§ˆå™¨çš„æœç´¢åŠŸèƒ½ (Ctrl+F)
2. æ ¹æ®é—®é¢˜åˆ†ç±»æŸ¥æ‰¾
3. æŸ¥çœ‹ç›¸å…³æ ‡ç­¾çš„é—®é¢˜
4. ä½¿ç”¨ç›®å½•å¿«é€Ÿå¯¼èˆª

### è§£å†³é—®é¢˜
1. ä»”ç»†é˜…è¯»é—®é¢˜è§£ç­”
2. æŒ‰ç…§æ­¥éª¤æ“ä½œ
3. æŸ¥çœ‹ç›¸å…³æ–‡æ¡£
4. å¦‚æœªè§£å†³ï¼Œè”ç³»æ”¯æŒ

### åé¦ˆé—®é¢˜
1. æè¿°é—®é¢˜çš„å…·ä½“æƒ…å†µ
2. æä¾›ç›¸å…³é”™è¯¯ä¿¡æ¯
3. è¯´æ˜å·²å°è¯•çš„è§£å†³æ–¹æ³•
4. æä¾›è”ç³»æ–¹å¼ä»¥ä¾¿è·Ÿè¿›

## ğŸ“ é—®é¢˜è®°å½•æ¨¡æ¿

å¦‚æœæœ¬æ–‡æ¡£æœªåŒ…å«æ‚¨çš„é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ¨¡æ¿åé¦ˆï¼š

```
é—®é¢˜ç±»å‹: [å®‰è£…/é…ç½®/æ”¯ä»˜/å…¶ä»–]
é—®é¢˜æè¿°: [è¯¦ç»†æè¿°é—®é¢˜]
ç¯å¢ƒä¿¡æ¯:
- ç³»ç»Ÿç‰ˆæœ¬: [å¦‚: Ubuntu 20.04]
- Odooç‰ˆæœ¬: [å¦‚: 19.0]
- æ¨¡å—ç‰ˆæœ¬: [å¦‚: payment_wechat v1.0]
é”™è¯¯ä¿¡æ¯: [å¦‚æœ‰é”™è¯¯æ—¥å¿—ï¼Œè¯·æä¾›]
å·²å°è¯•çš„è§£å†³: [å·²å°è¯•çš„è§£å†³æ–¹æ³•]
æœŸæœ›ç»“æœ: [æœŸæœ›è¾¾åˆ°çš„æ•ˆæœ]
```

---

*æœ¬FAQæ–‡æ¡£å°†æ ¹æ®ç”¨æˆ·åé¦ˆå’Œç³»ç»Ÿæ›´æ–°æŒç»­å®Œå–„ã€‚*
*æ„Ÿè°¢æ‚¨çš„ä½¿ç”¨å’Œæ”¯æŒï¼*
"""
    
    def generate_searchable_faq(self):
        """ç”Ÿæˆå¯æœç´¢çš„HTMLç‰ˆæœ¬"""
        faq_sections = self.generate_faq()
        
        html_content = self._create_html_faq(faq_sections)
        html_path = self.output_file.with_suffix(".html")
        
        with open(html_path, "w", encoding="utf-8") as f:
            f.write(html_content)
        
        print(f"âœ… HTMLç‰ˆæœ¬ç”Ÿæˆå®Œæˆ: {html_path}")
        return html_path
    
    def _create_html_faq(self, sections):
        """åˆ›å»ºHTMLç‰ˆæœ¬çš„FAQ"""
        html = f"""<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Odoo 19å¾®ä¿¡æ”¯ä»˜é¡¹ç›® - å¸¸è§é—®é¢˜è§£ç­”</title>
    <style>
        :root {{
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --info-color: #17a2b8;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
        }}
        
        * {{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }}
        
        body {{
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }}
        
        .container {{
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }}
        
        .header {{
            background: linear-gradient(135deg, var(--primary-color), #0056b3);
            color: white;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }}
        
        .header h1 {{
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }}
        
        .header .subtitle {{
            font-size: 1.1rem;
            opacity: 0.9;
        }}
        
        .search-box {{
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }}
        
        .search-box input {{
            width: 100%;
            padding: 12px 20px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            outline: none;
            transition: border-color 0.3s;
        }}
        
        .search-box input:focus {{
            border-color: var(--primary-color);
        }}
        
        .quick-stats {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }}
        
        .stat-card {{
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }}
        
        .stat-card .number {{
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }}
        
        .stat-card .label {{
            color: var(--secondary-color);
            font-size: 0.9rem;
        }}
        
        .faq-container {{
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 2rem;
        }}
        
        .sidebar {{
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
        }}
        
        .sidebar h3 {{
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--light-color);
        }}
        
        .nav-list {{
            list-style: none;
        }}
        
        .nav-item {{
            margin-bottom: 0.5rem;
        }}
        
        .nav-item a {{
            display: block;
            padding: 8px 12px;
            color: var(--dark-color);
            text-decoration: none;
            border-radius: 4px;
            transition: all 0.3s;
        }}
        
        .nav-item a:hover {{
            background-color: var(--light-color);
            color: var(--primary-color);
        }}
        
        .nav-item.active a {{
            background-color: var(--primary-color);
            color: white;
        }}
        
        .content {{
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }}
        
        .section {{
            margin-bottom: 3rem;
        }}
        
        .section h2 {{
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--light-color);
        }}
        
        .question {{
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid var(--light-color);
            border-radius: 8px;
            transition: all 0.3s;
        }}
        
        .question:hover {{
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }}
        
        .question h3 {{
            color: var(--dark-color);
            margin-bottom: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }}
        
        .question h3 .toggle {{
            color: var(--primary-color);
            font-size: 1.2rem;
        }}
        
        .meta {{
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }}
        
        .difficulty {{
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }}
        
        .difficulty.beginner {{
            background-color: #d4edda;
            color: #155724;
        }}
        
        .difficulty.intermediate {{
            background-color: #fff3cd;
            color: #856404;
        }}
        
        .difficulty.advanced {{
            background-color: #f8d7da;
            color: #721c24;
        }}
        
        .tags {{
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }}
        
        .tag {{
            padding: 2px 8px;
            background-color: var(--light-color);
            color: var(--secondary-color);
            border-radius: 12px;
            font-size: 0.8rem;
        }}
        
        .answer {{
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--light-color);
        }}
        
        .footer {{
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid var(--light-color);
            text-align: center;
            color: var(--secondary-color);
            font-size: 0.9rem;
        }}
        
        .contact-info {{
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin: 1rem 0;
        }}
        
        .contact-item {{
            text-align: center;
        }}
        
        .contact-item i {{
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }}
        
        @media (max-width: 768px) {{
            .faq-container {{
                grid-template-columns: 1fr;
            }}
            
            .sidebar {{
                position: static;
            }}
            
            .quick-stats {{
                grid-template-columns: 1fr;
            }}
        }}
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1><i class="fas fa-question-circle"></i> å¸¸è§é—®é¢˜è§£ç­”</h1>
            <div class="subtitle">Odoo 19å¾®ä¿¡æ”¯ä»˜ä¸ç”Ÿæ€ç³»ç»Ÿé›†æˆé¡¹ç›®</div>
            <div class="subtitle">æœ€åæ›´æ–°: {datetime.now().strftime('%Y-%m-%d')}</div>
        </header>
        
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢é—®é¢˜... (è¾“å…¥å…³é”®è¯æŸ¥æ‰¾ç›¸å…³é—®é¢˜)">
        </div>
        
        <div class="quick-stats">
            <div class="stat-card">
                <div class="number" id="totalQuestions">0</div>
                <div class="label">é—®é¢˜æ€»æ•°</div>
            </div>
            <div class="stat-card">
                <div class="number" id="totalSections">0</div>
                <div class="label">åˆ†ç±»æ•°é‡</div>
            </div>
            <div class="stat-card">
                <div class="number">3</div>
                <div class="label">éš¾åº¦ç­‰çº§</div>
            </div>
            <div class="stat-card">
                <div class="number">6</div>
                <div class="label">ä¸»è¦æ¨¡å—</div>
            </div>
        </div>
        
        <div class="faq-container">
            <nav class="sidebar">
                <h3><i class="fas fa-list"></i> ç›®å½•</h3>
                <ul class="nav-list" id="navList">
                    <!-- é€šè¿‡JavaScriptç”Ÿæˆ -->
                </ul>
            </nav>
            
            <main class="content" id="content">
                <!-- é€šè¿‡JavaScriptç”Ÿæˆ -->
            </main>
        </div>
        
        <footer class="footer">
            <div class="contact-info">
                <div class="contact-item">
                    <i class="fas fa-envelope"></i>
                    <div>support@example.com</div>
                </div>
                <div class="contact-item">
                    <i class="fas fa-phone"></i>
                    <div>400-XXX-XXXX</div>
                </div>
                <div class="contact-item">
                    <i class="fas fa-clock"></i>
                    <div>å·¥ä½œæ—¥ 9:00-18:00</div>
                </div>
            </div>
            <p>Â© 2024 Odooå¼€å‘å›¢é˜Ÿ. ä¿ç•™æ‰€æœ‰æƒåˆ©.</p>
            <p>ç‰ˆæœ¬: 1.0.0 | æ–‡æ¡£ID: FAQ-{datetime.now().strftime('%Y%m%d')}</p>
        </footer>
    </div>
    
    <script>
        // FAQæ•°æ®
        const faqData = {json.dumps(sections, ensure_ascii=False)};
        
        // ç»Ÿè®¡é—®é¢˜
        let totalQuestions = 0;
        faqData.forEach(section => {{
            totalQuestions += section.questions.length;
        }});
        
        document.getElementById('totalQuestions').textContent = totalQuestions;
        document.getElementById('totalSections').textContent = faqData.length;
        
        // ç”Ÿæˆå¯¼èˆª
        const navList = document.getElementById('navList');
        faqData.forEach((section, index) => {{
            const li = document.createElement('li');
            li.className = 'nav-item';
            li.innerHTML = `
                <a href="#section-{index}" onclick="scrollToSection({index})">
                    <i class="fas fa-folder"></i> {section.section}
                    <span class="badge">({section.questions.length})</span>
                </a>
            `;
            navList.appendChild(li);
        }});
        
        // ç”Ÿæˆå†…å®¹
        const content = document.getElementById('content');
        faqData.forEach((section, sectionIndex) => {{
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'section';
            sectionDiv.id = `section-{sectionIndex}`;
            
            let questionsHTML = '';
            section.questions.forEach((question, qIndex) => {{
                const difficultyClass = question.difficulty.toLowerCase();
                const tagsHTML = question.tags.map(tag => 
                    `<span class="tag">#${tag}</span>`
                ).join('');
                
                questionsHTML += `
                    <div class="question" data-index="${{sectionIndex}}-{qIndex}">
                        <h3 onclick="toggleAnswer(this)">
                            <span>Q{qIndex + 1}: ${question.q}</span>
                            <span class="toggle"><i class="fas fa-chevron-down"></i></span>
                        </h3>
                        <div class="meta">
                            <span class="difficulty ${{difficultyClass}}">
                                <i class="fas fa-signal"></i> ${question.difficulty}
                            </span>
                            <span class="views">
                                <i class="far fa-eye"></i> å¸¸ç”¨é—®é¢˜
                            </span>
                        </div>
                        <div class="tags">
                            ${tagsHTML}
                        </div>
                        <div class="answer" style="display: none;">
                            ${question.a.replace(/\\n/g, '<br>')}
                        </div>
                    </div>
                `;
            }});
            
            sectionDiv.innerHTML = `
                <h2><i class="fas fa-book"></i> ${section.section}</h2>
                ${questionsHTML}
            `;
            
            content.appendChild(sectionDiv);
        }});
        
        // æœç´¢åŠŸèƒ½
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', function(e) {{
            const searchTerm = e.target.value.toLowerCase();
            const questions = document.querySelectorAll('.question');
            
            questions.forEach(question => {{
                const questionText = question.textContent.toLowerCase();
                const answer = question.querySelector('.answer');
                
                if (searchTerm === '') {{
                    question.style.display = 'block';
                    answer.style.display = 'none';
                }} else if (questionText.includes(searchTerm)) {{
                    question.style.display = 'block';
                    answer.style.display = 'block'; // æœç´¢æ—¶æ˜¾ç¤ºç­”æ¡ˆ
                }} else {{
                    question.style.display = 'none';
                }}
            }});
        }});
        
        // ç­”æ¡ˆåˆ‡æ¢
        function toggleAnswer(header) {{
            const answer = header.parentElement.querySelector('.answer');
            const toggleIcon = header.querySelector('.toggle i');
            
            if (answer.style.display === 'none') {{
                answer.style.display = 'block';
                toggleIcon.className = 'fas fa-chevron-up';
            }} else {{
                answer.style.display = 'none';
                toggleIcon.className = 'fas fa-chevron-down';
            }}
        }}
        
        // æ»šåŠ¨åˆ°æŒ‡å®šéƒ¨åˆ†
        function scrollToSection(index) {{
            const section = document.getElementById(`section-${{index}}`);
            section.scrollIntoView({{ behavior: 'smooth' }});
            
            // æ›´æ–°å¯¼èˆªæ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.nav-item').forEach((item, i) => {{
                if (i === index) {{
                    item.classList.add('active');
                }} else {{
                    item.classList.remove('active');
                }}
            }});
        }}
        
        // åˆå§‹æ˜¾ç¤ºç¬¬ä¸€ä¸ªç­”æ¡ˆ
        document.addEventListener('DOMContentLoaded', function() {{
            const firstQuestion = document.querySelector('.question');
            if (firstQuestion) {{
                const firstAnswer = firstQuestion.querySelector('.answer');
                const firstToggle = firstQuestion.querySelector('.toggle i');
                if (firstAnswer) {{
                    firstAnswer.style.display = 'block';
                    firstToggle.className = 'fas fa-chevron-up';
                }}
            }}
            
            // æ¿€æ´»ç¬¬ä¸€ä¸ªå¯¼èˆªé¡¹
            document.querySelector('.nav-item').classList.add('active');
        }});
        
        // URLé”šç‚¹å¤„ç†
        window.addEventListener('hashchange', function() {{
            const hash = window.location.hash;
            if (hash) {{
                const sectionId = hash.replace('#', '');
                const section = document.getElementById(sectionId);
                if (section) {{
                    section.scrollIntoView({{ behavior: 'smooth' }});
                }}
            }}
        }});
        
        // æ£€æŸ¥URLä¸­çš„é”šç‚¹
        if (window.location.hash) {{
            window.dispatchEvent(new Event('hashchange'));
        }}
    </script>
</body>
</html>"""
        
        return html

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    import argparse
    
    parser = argparse.ArgumentParser(description="å¸¸è§é—®é¢˜è§£ç­”ç”Ÿæˆå™¨")
    parser.add_argument("--format", choices=["markdown", "html", "both"], default="both", help="è¾“å‡ºæ ¼å¼")
    parser.add_argument("--output", default="docs/FAQ.md", help="è¾“å‡ºæ–‡ä»¶è·¯å¾„")
    
    args = parser.parse_args()
    
    generator = FAQGenerator(args.output)
    
    if args.format in ["markdown", "both"]:
        generator.generate_faq()
    
    if args.format in ["html", "both"]:
        generator.generate_searchable_faq()
    
    print("\nâœ… FAQç”Ÿæˆå®Œæˆï¼")
    print("ğŸ“‹ ä¸‹ä¸€æ­¥:")
    print("1. å°†FAQæ–‡æ¡£é›†æˆåˆ°å¸®åŠ©ç³»ç»Ÿ")
    print("2. æ ¹æ®ç”¨æˆ·åé¦ˆæ›´æ–°å†…å®¹")
    print("3. å®šæœŸç»´æŠ¤å’Œæ›´æ–°")
```

### **å¾®ä¿¡å¼€å‘ä¸“å®¶å…·ä½“ä»»åŠ¡ï¼š**

#### **ä»»åŠ¡1ï¼šéƒ¨ç½²æ£€æŸ¥æ¸…å•ç”Ÿæˆå™¨**
```python
# file: scripts/deployment_checklist.py

#!/usr/bin/env python3
"""
éƒ¨ç½²æ£€æŸ¥æ¸…å•ç”Ÿæˆå™¨
ç”Ÿæˆç³»ç»Ÿéƒ¨ç½²çš„è¯¦ç»†æ£€æŸ¥æ¸…å•
"""

import json
from datetime import datetime
from pathlib import Path

class DeploymentChecklistGenerator:
    """éƒ¨ç½²æ£€æŸ¥æ¸…å•ç”Ÿæˆå™¨"""
    
    def __init__(self, output_dir="deployment_checklists"):
        self.output_dir = Path(output_dir)
        self.output_dir.mkdir(exist_ok=True)
        
    def generate_all_checklists(self):
        """ç”Ÿæˆæ‰€æœ‰æ£€æŸ¥æ¸…å•"""
        print("ğŸ“‹ ç”Ÿæˆéƒ¨ç½²æ£€æŸ¥æ¸…å•...")
        
        checklists = [
            self._create_pre_deployment_checklist(),
            self._create_installation_checklist(),
            self._create_configuration_checklist(),
            self._create_security_checklist(),
            self._create_testing_checklist(),
            self._create_post_deployment_checklist()
        ]
        
        # ç”Ÿæˆæ€»æ¸…å•
        self._create_master_checklist(checklists)
        
        print(f"\nâœ… å…±ç”Ÿæˆ {len(checklists)} ä¸ªæ£€æŸ¥æ¸…å•")
        return checklists
    
    def _create_pre_deployment_checklist(self):
        """åˆ›å»ºéƒ¨ç½²å‰æ£€æŸ¥æ¸…å•"""
        checklist = {
            "id": "PRE_DEPLOYMENT",
            "title": "éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•",
            "phase": "pre-deployment",
            "target": "ç³»ç»Ÿç®¡ç†å‘˜",
            "estimated_time": "2å°æ—¶",
            
            "sections": [
                {
                    "section": "ç¯å¢ƒæ£€æŸ¥",
                    "items": [
                        {
                            "id": "PRE-ENV-01",
                            "description": "æ£€æŸ¥æœåŠ¡å™¨ç¡¬ä»¶èµ„æº",
                            "details": "CPU: 8æ ¸+, å†…å­˜: 16GB+, å­˜å‚¨: 500GB+",
                            "criticality": "high",
                            "verification": "è¿è¡Œ `top`, `df -h`, `free -h`",
                            "expected_result": "èµ„æºå……è¶³ï¼Œæ— è­¦å‘Š"
                        },
                        {
                            "id": "PRE-ENV-02",
                            "description": "æ£€æŸ¥æ“ä½œç³»ç»Ÿç‰ˆæœ¬",
                            "details": "Ubuntu 20.04+ æˆ– CentOS 8+",
                            "criticality": "high",
                            "verification": "è¿è¡Œ `cat /etc/os-release`",
                            "expected_result": "ç‰ˆæœ¬ç¬¦åˆè¦æ±‚"
                        },
                        {
                            "id": "PRE-ENV-03",
                            "description": "æ£€æŸ¥ç½‘ç»œè¿æ¥",
                            "details": "å†…ç½‘å¤–ç½‘è¿é€šæ€§ï¼ŒDNSè§£æ",
                            "criticality": "high",
                            "verification": "pingæµ‹è¯•ï¼Œcurlæµ‹è¯•",
                            "expected_result": "ç½‘ç»œæ­£å¸¸ï¼ŒDNSè§£ææ­£ç¡®"
                        },
                        {
                            "id": "PRE-ENV-04",
                            "description": "æ£€æŸ¥é˜²ç«å¢™é…ç½®",
                            "details": "å¼€æ”¾å¿…è¦ç«¯å£ï¼š80, 443, 8069, 5432, 6379",
                            "criticality": "medium",
                            "verification": "è¿è¡Œ `sudo ufw status`",
                            "expected_result": "å¿…è¦ç«¯å£å·²å¼€æ”¾"
                        }
                    ]
                },
                {
                    "section": "è½¯ä»¶ä¾èµ–æ£€æŸ¥",
                    "items": [
                        {
                            "id": "PRE-SOFT-01",
                            "description": "æ£€æŸ¥Dockerå®‰è£…",
                            "details": "Docker 20.10+, Docker Compose",
                            "criticality": "high",
                            "verification": "è¿è¡Œ `docker --version`, `docker-compose --version`",
                            "expected_result": "ç‰ˆæœ¬ç¬¦åˆè¦æ±‚"
                        },
                        {
                            "id": "PRE-SOFT-02",
                            "description": "æ£€æŸ¥Pythonç‰ˆæœ¬",
                            "details": "Python 3.10+",
                            "criticality": "high",
                            "verification": "è¿è¡Œ `python3 --version`",
                            "expected_result": "ç‰ˆæœ¬3.10+"
                        },
                        {
                            "id": "PRE-SOFT-03",
                            "description": "æ£€æŸ¥PostgreSQL",
                            "details": "PostgreSQL 14+ï¼ˆå¦‚æœä¸ç”¨Dockerï¼‰",
                            "criticality": "medium",
                            "verification": "è¿è¡Œ `psql --version`",
                            "expected_result": "ç‰ˆæœ¬14+æˆ–æ— éœ€æ£€æŸ¥ï¼ˆç”¨Dockerï¼‰"
                        },
                        {
                            "id": "PRE-SOFT-04",
                            "description": "æ£€æŸ¥Redis",
                            "details": "Redis 6.0+ï¼ˆå¦‚æœä¸ç”¨Dockerï¼‰",
                            "criticality": "medium",
                            "verification": "è¿è¡Œ `redis-server --version`",
                            "expected_result": "ç‰ˆæœ¬6.0+æˆ–æ— éœ€æ£€æŸ¥ï¼ˆç”¨Dockerï¼‰"
                        }
                    ]
                },
                {
                    "section": "èµ„æ–™å‡†å¤‡",
                    "items": [
                        {
                            "id": "PRE-DOC-01",
                            "description": "è·å–éƒ¨ç½²æ–‡æ¡£",
                            "details": "éƒ¨ç½²è¿ç»´æ‰‹å†Œã€é…ç½®æŒ‡å—",
                            "criticality": "medium",
                            "verification": "ç¡®è®¤æ–‡æ¡£å®Œæ•´å¯ç”¨",
                            "expected_result": "æ–‡æ¡£å‡†å¤‡å°±ç»ª"
                        },
                        {
                            "id": "PRE-DOC-02",
                            "description": "å‡†å¤‡é…ç½®æ–‡ä»¶æ¨¡æ¿",
                            "details": ".env.example, docker-compose.yml, nginx.conf",
                            "criticality": "medium",
                            "verification": "æ£€æŸ¥é…ç½®æ–‡ä»¶å®Œæ•´æ€§",
                            "expected_result": "é…ç½®æ–‡ä»¶å‡†å¤‡å°±ç»ª"
                        },
                        {
                            "id": "PRE-DOC-03",
                            "description": "å‡†å¤‡éƒ¨ç½²åŒ…",
                            "details": "ä¸‹è½½æœ€æ–°éƒ¨ç½²åŒ…",
                            "criticality": "high",
                            "verification": "æ£€æŸ¥éƒ¨ç½²åŒ…ç‰ˆæœ¬å’Œå®Œæ•´æ€§",
                            "expected_result": "éƒ¨ç½²åŒ…å‡†å¤‡å°±ç»ª"
                        }
                    ]
                },
                {
                    "section": "å¤‡ä»½è®¡åˆ’",
                    "items": [
                        {
                            "id": "PRE-BAK-01",
                            "description": "åˆ¶å®šå¤‡ä»½ç­–ç•¥",
                            "details": "æ•°æ®åº“å¤‡ä»½ã€æ–‡ä»¶å¤‡ä»½ã€å¤‡ä»½é¢‘ç‡",
                            "criticality": "medium",
                            "verification": "æ£€æŸ¥å¤‡ä»½æ–¹æ¡ˆæ–‡æ¡£",
                            "expected_result": "å¤‡ä»½ç­–ç•¥å·²åˆ¶å®š"
                        },
                        {
                            "id": "PRE-BAK-02",
                            "description": "å‡†å¤‡å¤‡ä»½å­˜å‚¨",
                            "details": "å¤‡ä»½ç›®å½•ã€å®¹é‡ã€æƒé™",
                            "criticality": "medium",
                            "verification": "æ£€æŸ¥å¤‡ä»½ç›®å½•",
                            "expected_result": "å¤‡ä»½å­˜å‚¨å‡†å¤‡å°±ç»ª"
                        },
                        {
                            "id": "PRE-BAK-03",
                            "description": "åˆ¶å®šå›æ»šè®¡åˆ’",
                            "details": "éƒ¨ç½²å¤±è´¥çš„å›æ»šæ­¥éª¤",
                            "criticality": "medium",
                            "verification": "æ£€æŸ¥å›æ»šæ–¹æ¡ˆ",
                            "expected_result": "å›æ»šè®¡åˆ’å·²åˆ¶å®š"
                        }
                    ]
                }
            ],
            
            "completion_criteria": [
                "æ‰€æœ‰ç¯å¢ƒæ£€æŸ¥é€šè¿‡",
                "è½¯ä»¶ä¾èµ–æ»¡è¶³è¦æ±‚", 
                "éƒ¨ç½²èµ„æ–™å‡†å¤‡å®Œæ•´",
                "å¤‡ä»½å’Œå›æ»šè®¡åˆ’å°±ç»ª"
            ],
            
            "notes": "éƒ¨ç½²å‰æ£€æŸ¥æ˜¯ç¡®ä¿é¡ºåˆ©éƒ¨ç½²çš„å…³é”®æ­¥éª¤ï¼Œä¸è¦è·³è¿‡ä»»ä½•é¡¹ç›®ã€‚"
        }
        
        self._save_checklist(checklist, "01_pre_deployment")
        return checklist
    
    def _create_installation_checklist(self):
        """åˆ›å»ºå®‰è£…æ£€æŸ¥æ¸…å•"""
        checklist = {
            "id": "INSTALLATION",
            "title": "ç³»ç»Ÿå®‰è£…æ£€æŸ¥æ¸…å•",
            "phase": "installation",
            "target": "å®æ–½å·¥ç¨‹å¸ˆ",
            "estimated_time": "1å°æ—¶",
            
            "sections": [
                {
                    "section": "Dockerå®‰è£…",
                    "items": [
                        {
                            "id": "INST-DOCK-01",
                            "description": "è§£å‹éƒ¨ç½²åŒ…",
                            "details": "å°†éƒ¨ç½²åŒ…è§£å‹åˆ°ç›®æ ‡ç›®å½•",
                            "criticality": "high",
                            "verification": "æ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§",
                            "expected_result": "æ‰€æœ‰æ–‡ä»¶è§£å‹æˆåŠŸ"
                        },
                        {
                            "id": "INST-DOCK-02",
                            "description": "é…ç½®ç¯å¢ƒå˜é‡",
                            "details": "å¤åˆ¶.env.exampleä¸º.envå¹¶ç¼–è¾‘",
                            "criticality": "high",
                            "verification": "æ£€æŸ¥å…³é”®é…ç½®é¡¹",
                            "expected_result": ".envæ–‡ä»¶é…ç½®æ­£ç¡®"
                        },
                        {
                            "id": "INST-DOCK-03",
                            "description": "å¯åŠ¨DockeræœåŠ¡",
                            "details": "è¿è¡Œdocker-compose up -d",
                            "criticality": "high",
                            "verification": "æ£€æŸ¥å®¹å™¨çŠ¶æ€",
                            "expected_result": "æ‰€æœ‰å®¹å™¨è¿è¡Œæ­£å¸¸"
                        },
                        {
                            "id": "INST-DOCK-04",
                            "description": "æ£€æŸ¥æœåŠ¡æ—¥å¿—",
                            "details": "æŸ¥çœ‹Odooã€PostgreSQLã€Redisæ—¥å¿—",
                            "criticality": "medium",
                            "verification": "docker-compose logs",
                            "expected_result": "æ—¥å¿—æ— é”™è¯¯ä¿¡æ¯"
                        }
                    ]
                },
                {
                    "section": "ä¼ ç»Ÿå®‰è£…",
                    "items": [
                        {
                            "id": "INST-TRAD-01",
                            "description": "å®‰è£…Pythonä¾èµ–",
                            "details": "pip install -r requirements.txt",
                            "criticality": "high",
                            "verification": "æ£€æŸ¥ä¾èµ–å®‰è£…çŠ¶æ€",
                            "expected_result": "æ‰€æœ‰ä¾èµ–å®‰è£…æˆåŠŸ"
                        },
                        {
                            "id": "INST-TRAD-02",
                            "description": "é…ç½®Odoo",
                            "details": "ç¼–è¾‘odoo.confé…ç½®æ–‡ä»¶",
                            "criticality": "high",
                            "verification": "æ£€æŸ¥é…ç½®é¡¹",
                            "expected_result": "odoo.confé…ç½®æ­£ç¡®"
                        },
                        {
                            "id": "INST-TRAD-03",
                            "description": "å¤åˆ¶æ¨¡å—æ–‡ä»¶",
                            "details": "å°†æ¨¡å—å¤åˆ¶åˆ°addonsç›®å½•",
                            "criticality": "high",
                            "verification": "æ£€æŸ¥æ¨¡å—å®Œæ•´æ€§",
                            "expected_result": "æ‰€æœ‰æ¨¡å—å¤åˆ¶æˆåŠŸ"
                        },
                        {
                            "id": "INST-TRAD-04",
                            "description": "å¯åŠ¨OdooæœåŠ¡",
                            "details": "systemctl start odoo",
                            "criticality": "high",
                            "verification": "æ£€æŸ¥æœåŠ¡çŠ¶æ€",
                            "expected_result": "OdooæœåŠ¡è¿è¡Œæ­£å¸¸"
                        }
                    ]
                },
                {
                    "section": "æ¨¡å—å®‰è£…",
                    "items": [
                        {
                            "id": "INST-MOD-01",
                            "description": "ç™»å½•Odooç³»ç»Ÿ",
                            "details": "ä½¿ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•",
                            "criticality": "high",
                            "verification": "èƒ½å¤Ÿè®¿é—®Odooç•Œé¢",
                            "expected_result": "ç™»å½•æˆåŠŸ"
                        },
                        {
                            "id": "INST-MOD-02",
                            "description": "æ¿€æ´»å¼€å‘è€…æ¨¡å¼",
                            "details": "å¯ç”¨å¼€å‘è€…æ¨¡å¼ä»¥å®‰è£…è‡ªå®šä¹‰æ¨¡å—",
                            "criticality": "medium",
                            "verification": "æ£€æŸ¥è®¾ç½®èœå•",
                            "expected_result": "å¼€å‘è€…æ¨¡å¼å·²æ¿€æ´»"
                        },
                        {
                            "id": "INST-MOD-03",
                            "description": "å®‰è£…åŸºç¡€æ¨¡å—",
                            "details": "æŒ‰é¡ºåºå®‰è£…wechat_commonç­‰æ¨¡å—",
                            "criticality": "high",
                            "verification": "æ£€æŸ¥åº”ç”¨åˆ—è¡¨",
                            "expected_result": "æ¨¡å—å®‰è£…æˆåŠŸ"
                        },
                        {
                            "id": "INST-MOD-04",
                            "description": "éªŒè¯æ¨¡å—å®‰è£…",
                            "details": "æ£€æŸ¥æ¨¡å—åŠŸèƒ½æ˜¯å¦æ­£å¸¸",
                            "criticality": "medium",
                            "verification": "è®¿é—®æ¨¡å—ç›¸å…³èœå•",
                            "expected_result": "æ¨¡å—åŠŸèƒ½æ­£å¸¸"
                        }
                    ]
                }
            ],
            
            "completion_criteria": [
                "DockeræœåŠ¡æˆ–ä¼ ç»Ÿå®‰è£…å®Œæˆ",
                "æ‰€æœ‰æ¨¡å—å®‰è£…æˆåŠŸ", 
                "ç³»ç»Ÿå¯ä»¥æ­£å¸¸è®¿é—®",
                "æ— å®‰è£…é”™è¯¯æ—¥å¿—"
            ],
            
            "notes": "å®‰è£…è¿‡ç¨‹ä¸­æ³¨æ„è®°å½•é‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆã€‚"
        }
        
        self._save_checklist(checklist, "02_installation")
        return checklist
    
    def _create_configuration_checklist(self):
        """åˆ›å»ºé…ç½®æ£€æŸ¥æ¸…å•"""
        checklist = {
            "id": "CONFIGURATION", 
            "title": "ç³»ç»Ÿé…ç½®æ£€æŸ¥æ¸…å•",
            "phase": "configuration",
            "target": ["ç³»ç»Ÿç®¡ç†å‘˜", "æ”¯ä»˜ç®¡ç†å‘˜"],
            "estimated_time": "3å°æ—¶",
            
            "sections": [
                {
                    "section": "åŸºç¡€é…ç½®",
                    "items": [
                        {
                            "id": "CFG-BASIC-01",
                            "description": "é…ç½®å…¬å¸ä¿¡æ¯",
                            "details": "è®¾ç½®å…¬å¸åç§°ã€åœ°å€ã€è”ç³»æ–¹å¼",
                            "criticality": "high",
                            "verification": "æ£€æŸ¥å…¬å¸è®¾ç½®é¡µé¢",
                            "expected_result": "å…¬å¸ä¿¡æ¯å®Œæ•´æ­£ç¡®"
                        },
                        {
                            "id": "CFG-BASIC-02",
                            "description": "é…ç½®ç”¨æˆ·å’Œæƒé™",
                            "details": "åˆ›å»ºç”¨æˆ·è´¦å·ï¼Œåˆ†é…æƒé™ç»„",
                            "criticality": "high",
                            "verification": "æµ‹è¯•ç”¨æˆ·ç™»å½•å’Œæƒé™",
                            "expected_result": "ç”¨æˆ·æƒé™è®¾ç½®æ­£ç¡®"
                        },
                        {
                            "id": "CFG-BASIC-03",
                            "description": "é…ç½®é‚®ä»¶æœåŠ¡å™¨",
                            "details": "è®¾ç½®SMTPæœåŠ¡å™¨å‘é€é€šçŸ¥é‚®ä»¶",
                            "criticality": "medium",
                            "verification": "å‘é€æµ‹è¯•é‚®ä»¶",
                            "expected_result": "é‚®ä»¶å‘é€æˆåŠŸ"
                        },
                        {
                            "id": "CFG-BASIC-04",
                            "description": "é…ç½®æ—¶åŒºå’Œè¯­è¨€",
                            "details": "è®¾ç½®ç³»ç»Ÿæ—¶åŒºå’Œæ˜¾ç¤ºè¯­è¨€",
                            "criticality": "medium",
                            "verification": "æ£€æŸ¥ç³»ç»Ÿæ—¶é—´å’Œè¯­è¨€",
                            "expected_result": "æ—¶åŒºå’Œè¯­è¨€è®¾ç½®æ­£ç¡®"
                        }
                    ]
                },
                {
                    "section": "å¾®ä¿¡æ”¯ä»˜é…ç½®",
                    "items": [
                        {
                            "id": "CFG-WECHAT-01",
                            "description": "é…ç½®å¾®ä¿¡æ”¯ä»˜æä¾›å•†",
                            "details": "å¡«å†™å•†æˆ·å·ã€AppIDã€APIv3å¯†é’¥",
                            "criticality": "high",
                            "verification": "æ£€æŸ¥æ”¯ä»˜æä¾›å•†é…ç½®",
                            "expected_result": "å¾®ä¿¡æ”¯ä»˜é…ç½®å®Œæ•´"
                        },
                        {
                            "id": "CFG-WECHAT-02",
                            "description": "ä¸Šä¼ å•†æˆ·è¯ä¹¦",
                            "details": "ä¸Šä¼ ä»å¾®ä¿¡å•†æˆ·å¹³å°ä¸‹è½½çš„è¯ä¹¦",
                            "criticality": "high",
                            "verification": "æ£€æŸ¥è¯ä¹¦çŠ¶æ€",
                            "expected_result": "è¯ä¹¦ä¸Šä¼ æˆåŠŸ"
                        },
                        {
                            "id": "CFG-WECHAT-03",
                            "description": "é…ç½®æ”¯ä»˜æ–¹å¼",
                            "details": "å¯ç”¨æ‰«ç æ”¯ä»˜ã€JSAPIæ”¯ä»˜ç­‰",
                            "criticality": "medium",
                            "verification": "æ£€æŸ¥æ”¯ä»˜æ–¹å¼åˆ—è¡¨",
                            "expected_result": "æ”¯ä»˜æ–¹å¼é…ç½®æ­£ç¡®"
                        },
                        {
                            "id": "CFG-WECHAT-04",
                            "description": "è®¾ç½®å›è°ƒåœ°å€",
                            "details": "é…ç½®æ”¯ä»˜æˆåŠŸå›è°ƒURL",
                            "criticality": "high",
                            "verification": "æ£€æŸ¥å›è°ƒé…ç½®",
                            "expected_result": "å›è°ƒåœ°å€æ­£ç¡®"
                        }
                    ]
                },
                {
                    "section": "æ”¯ä»˜å®é…ç½®",
                    "items": [
                        {
                            "id": "CFG-ALIPAY-01",
                            "description": "é…ç½®æ”¯ä»˜å®æ”¯ä»˜æä¾›å•†",
                            "details": "å¡«å†™AppIDã€åº”ç”¨ç§é’¥ã€æ”¯ä»˜å®å…¬é’¥",
                            "criticality": "high",
                            "verification": "æ£€æŸ¥æ”¯ä»˜å®é…ç½®",
                            "expected_result": "æ”¯ä»˜å®é…ç½®å®Œæ•´"
                        },
                        {
                            "id": "CFG-ALIPAY-02",
                            "description": "é…ç½®æ²™ç®±ç¯å¢ƒ",
                            "details": "ä½¿ç”¨æ²™ç®±ç¯å¢ƒè¿›è¡Œæµ‹è¯•",
                            "criticality": "medium",
                            "verification": "æ£€æŸ¥æ²™ç®±é…ç½®",
                            "expected_result": "æ²™ç®±ç¯å¢ƒé…ç½®æ­£ç¡®"
                        },
                        {
                            "id": "CFG-ALIPAY-03",
                            "description": "è®¾ç½®ç”Ÿäº§ç¯å¢ƒ",
                            "details": "åˆ‡æ¢ç”Ÿäº§ç¯å¢ƒé…ç½®",
                            "criticality": "high",
                            "verification": "æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒé…ç½®",
                            "expected_result": "ç”Ÿäº§ç¯å¢ƒé…ç½®æ­£ç¡®"
                        }
                    ]
                },
                {
                    "section": "å¾®ä¿¡å…¬ä¼—å·é…ç½®",
                    "items": [
                        {
                            "id": "CFG-MP-01",
                            "description": "æ·»åŠ å…¬ä¼—å·",
                            "details": "å¡«å†™å…¬ä¼—å·AppIDã€AppSecret",
                            "criticality": "high",
                            "verification": "æ£€æŸ¥å…¬ä¼—å·é…ç½®",
                            "expected_result": "å…¬ä¼—å·æ·»åŠ æˆåŠŸ"
                        },
                        {
                            "id": "CFG-MP-02",
                            "description": "é…ç½®æœåŠ¡å™¨ä¿¡æ¯",
                            "details": "è®¾ç½®Tokenã€EncodingAESKeyã€æœåŠ¡å™¨URL",
                            "criticality": "high",
                            "verification": "åœ¨å¾®ä¿¡å¹³å°éªŒè¯æœåŠ¡å™¨",
                            "expected_result": "æœåŠ¡å™¨éªŒè¯æˆåŠŸ"
                        },
                        {
                            "id": "CFG-MP-03",
                            "description": "é…ç½®è‡ªåŠ¨å›å¤",
                            "details": "è®¾ç½®å…³é”®è¯å›å¤è§„åˆ™",
                            "criticality": "medium",
                            "verification": "æµ‹è¯•è‡ªåŠ¨å›å¤åŠŸèƒ½",
                            "expected_result": "è‡ªåŠ¨å›å¤å·¥ä½œæ­£å¸¸"
                        },
                        {
                            "id": "CFG-MP-04",
                            "description": "é…ç½®è‡ªå®šä¹‰èœå•",
                            "details": "åˆ›å»ºå…¬ä¼—å·èœå•",
                            "criticality": "medium",
                            "verification": "æ£€æŸ¥èœå•æ˜¾ç¤º",
                            "expected_result": "èœå•æ˜¾ç¤ºæ­£ç¡®"
                        }
                    ]
                }
            ],
            
            "completion_criteria": [
                "æ‰€æœ‰åŸºç¡€é…ç½®å®Œæˆ",
                "æ”¯ä»˜æ¸ é“é…ç½®å®Œæˆå¹¶æµ‹è¯•",
                "å¾®ä¿¡å…¬ä¼—å·é…ç½®å®Œæˆå¹¶éªŒè¯",
                "æ‰€æœ‰é…ç½®æœ‰æ–‡æ¡£è®°å½•"
            ],
            
            "notes": "é…ç½®å®ŒæˆååŠ¡å¿…è¿›è¡Œæµ‹è¯•éªŒè¯ã€‚"
        }
        
        self._save_checklist(checklist, "03_configuration")
        return checklist
    
    def _create_security_checklist(self):
        """åˆ›å»ºå®‰å…¨æ£€æŸ¥æ¸…å•"""
        checklist = {
            "id": "SECURITY",
            "title": "å®‰å…¨é…ç½®æ£€æŸ¥æ¸…å•", 
            "phase": "security",
            "target": "å®‰å…¨ç®¡ç†å‘˜",
            "estimated_time": "2å°æ—¶",
            
            "sections": [
                {
                    "section": "è®¿é—®å®‰å…¨",
                    "items": [
                        {
                            "id": "SEC-ACC-01",
                            "description": "ä¿®æ”¹é»˜è®¤ç®¡ç†å‘˜å¯†ç ",
                            "details": "ä¿®æ”¹Odooé»˜è®¤ç®¡ç†å‘˜å¯†ç ",
                            "criticality": "high",
                            "verification": "ä½¿ç”¨æ–°å¯†ç ç™»å½•",
                            "expected_result": "é»˜è®¤å¯†ç å·²ä¿®æ”¹"
                        },
                        {
                            "id": "SEC-ACC-02",
                            "description": "é…ç½®å¼ºå¯†ç ç­–ç•¥",
                            "details": "è®¾ç½®å¯†ç å¤æ‚åº¦è¦æ±‚",
                            "criticality": "medium",
                            "verification": "æ£€æŸ¥å¯†ç ç­–ç•¥è®¾ç½®",
                            "expected_result": "å¼ºå¯†ç ç­–ç•¥å·²å¯ç”¨"
                        },
                        {
                            "id": "SEC-ACC-03",
                            "description": "é™åˆ¶ç®¡ç†ç•Œé¢è®¿é—®",
                            "details": "é…ç½®IPç™½åå•é™åˆ¶",
                            "criticality": "medium",
                            "verification": "æµ‹è¯•éç™½åå•IPè®¿é—®",
                            "expected_result": "è®¿é—®è¢«æ­£ç¡®é™åˆ¶"
                        },
                        {
                            "id": "SEC-ACC-04",
                            "description": "é…ç½®ä¼šè¯è¶…æ—¶",
                            "details": "è®¾ç½®åˆç†çš„ä¼šè¯è¶…æ—¶æ—¶é—´",
                            "criticality": "medium",
                            "verification": "æµ‹è¯•ä¼šè¯è¶…æ—¶",
                            "expected_result": "ä¼šè¯è¶…æ—¶å·¥ä½œæ­£å¸¸"
                        }
                    ]
                },
                {
                    "section": "æ•°æ®å®‰å…¨",
                    "items": [
                        {
                            "id": "SEC-DATA-01",
                            "description": "åŠ å¯†æ•æ„Ÿæ•°æ®",
                            "details": "ç¡®è®¤æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨",
                            "criticality": "high",
                            "verification": "æ£€æŸ¥æ•°æ®åº“æ•æ„Ÿå­—æ®µ",
                            "expected_result": "æ•æ„Ÿæ•°æ®å·²åŠ å¯†"
                        },
                        {
                            "id": "SEC-DATA-02",
                            "description": "é…ç½®SSL/TLS",
                            "details": "å¯ç”¨HTTPSè®¿é—®",
                            "criticality": "high",
                            "verification": "ä½¿ç”¨HTTPSè®¿é—®ç³»ç»Ÿ",
                            "expected_result": "HTTPSå·¥ä½œæ­£å¸¸"
                        },
                        {
                            "id": "SEC-DATA-03",
                            "description": "è®¾ç½®æ•°æ®å¤‡ä»½åŠ å¯†",
                            "details": "å¤‡ä»½æ–‡ä»¶åŠ å¯†å­˜å‚¨",
                            "criticality": "medium",
                            "verification": "æ£€æŸ¥å¤‡ä»½æ–‡ä»¶",
                            "expected_result": "å¤‡ä»½æ–‡ä»¶å·²åŠ å¯†"
                        },
                        {
                            "id": "SEC-DATA-04",
                            "description": "é…ç½®å®¡è®¡æ—¥å¿—",
                            "details": "å¯ç”¨æ“ä½œå®¡è®¡æ—¥å¿—",
                            "criticality": "medium",
                            "verification": "æ£€æŸ¥å®¡è®¡æ—¥å¿—åŠŸèƒ½",
                            "expected_result": "å®¡è®¡æ—¥å¿—æ­£å¸¸è®°å½•"
                        }
                    ]
                },
                {
                    "section": "æ”¯ä»˜å®‰å…¨",
                    "items": [
                        {
                            "id": "SEC-PAY-01",
                            "description": "éªŒè¯APIç­¾åé…ç½®",
                            "details": "ç¡®è®¤æ”¯ä»˜APIç­¾åæ­£ç¡®é…ç½®",
                            "criticality": "high",
                            "verification": "æµ‹è¯•æ”¯ä»˜ç­¾åéªŒè¯",
                            "expected_result": "ç­¾åéªŒè¯æ­£å¸¸"
                        },
                        {
                            "id": "SEC-PAY-02",
                            "description": "æ£€æŸ¥è¯ä¹¦ç®¡ç†",
                            "details": "ç¡®è®¤æ”¯ä»˜è¯ä¹¦å®‰å…¨å­˜å‚¨",
                            "criticality": "high",
                            "verification": "æ£€æŸ¥è¯ä¹¦å­˜å‚¨ä½ç½®å’Œæƒé™",
                            "expected_result": "è¯ä¹¦å®‰å…¨å­˜å‚¨"
                        },
                        {
                            "id": "SEC-PAY-03",
                            "description": "é…ç½®é˜²é‡æ”¾æ”»å‡»",
                            "details": "å¯ç”¨nonceæ£€æŸ¥æœºåˆ¶",
                            "criticality": "medium",
                            "verification": "æµ‹è¯•é‡æ”¾æ”»å‡»é˜²æŠ¤",
                            "expected_result": "é‡æ”¾æ”»å‡»è¢«é˜»æ­¢"
                        },
                        {
                            "id": "SEC-PAY-04",
                            "description": "è®¾ç½®æ”¯ä»˜é¢‘ç‡é™åˆ¶",
                            "details": "é…ç½®APIè°ƒç”¨é¢‘ç‡é™åˆ¶",
                            "criticality": "medium",
                            "verification": "æµ‹è¯•é¢‘ç‡é™åˆ¶",
                            "expected_result": "é¢‘ç‡é™åˆ¶ç”Ÿæ•ˆ"
                        }
                    ]
                }
            ],
            
            "completion_criteria": [
                "æ‰€æœ‰å®‰å…¨é…ç½®å®Œæˆ",
                "æ”¯ä»˜å®‰å…¨æªæ–½åˆ°ä½",
                "æ•°æ®åŠ å¯†é…ç½®å®Œæˆ",
                "å®‰å…¨å®¡è®¡åŠŸèƒ½æ­£å¸¸"
            ],
            
            "notes": "å®‰å…¨é…ç½®éœ€è¦å®šæœŸæ£€æŸ¥å’Œæ›´æ–°ã€‚"
        }
        
        self._save_checklist(checklist, "04_security")
        return checklist
    
    def _create_testing_checklist(self):
        """åˆ›å»ºæµ‹è¯•æ£€æŸ¥æ¸…å•"""
        checklist = {
            "id": "TESTING",
            "title": "ç³»ç»Ÿæµ‹è¯•æ£€æŸ¥æ¸…å•",
            "phase": "testing", 
            "target": ["æµ‹è¯•å·¥ç¨‹å¸ˆ", "è´¨é‡ä¿è¯"],
            "estimated_time": "4å°æ—¶",
            
            "sections": [
                {
                    "section": "åŠŸèƒ½æµ‹è¯•",
                    "items": [
                        {
                            "id": "TEST-FUNC-01",
                            "description": "æµ‹è¯•å¾®ä¿¡æ”¯ä»˜",
                            "details": "æ‰«ç æ”¯ä»˜ã€JSAPIæ”¯ä»˜ã€é€€æ¬¾",
                            "criticality": "high",
                            "verification": "ä½¿ç”¨æµ‹è¯•é‡‘é¢è¿›è¡Œæ”¯ä»˜",
                            "expected_result": "æ”¯ä»˜æµç¨‹æ­£å¸¸ï¼Œå›è°ƒæ­£ç¡®"
                        },
                        {
                            "id": "TEST-FUNC-02",
                            "description": "æµ‹è¯•æ”¯ä»˜å®æ”¯ä»˜",
                            "details": "å¿«é€Ÿæ”¯ä»˜ã€æ‰«ç æ”¯ä»˜ã€é€€æ¬¾",
                            "criticality": "high",
                            "verification": "æ²™ç®±ç¯å¢ƒæµ‹è¯•æ”¯ä»˜",
                            "expected_result": "æ”¯ä»˜å®æ”¯ä»˜æ­£å¸¸"
                        },
                        {
                            "id": "TEST-FUNC-03",
                            "description": "æµ‹è¯•POSæ”¯ä»˜",
                            "details": "ä¸»æ‰«æ”¯ä»˜ã€è¢«æ‰«æ”¯ä»˜ã€æ—¥ç»“",
                            "criticality": "high",
                            "verification": "æ¨¡æ‹ŸPOSæ”¯ä»˜åœºæ™¯",
                            "expected_result": "POSæ”¯ä»˜æ­£å¸¸"
                        },
                        {
                            "id": "TEST-FUNC-04",
                            "description": "æµ‹è¯•å…¬ä¼—å·åŠŸèƒ½",
                            "details": "æ¶ˆæ¯æ¥æ”¶ã€è‡ªåŠ¨å›å¤ã€èœå•ç‚¹å‡»",
                            "criticality": "medium",
                            "verification": "ä½¿ç”¨æµ‹è¯•å…¬ä¼—å·æµ‹è¯•",
                            "expected_result": "å…¬ä¼—å·åŠŸèƒ½æ­£å¸¸"
                        }
                    ]
                },
                {
                    "section": "æ€§èƒ½æµ‹è¯•",
                    "items": [
                        {
                            "id": "TEST-PERF-01",
                            "description": "æµ‹è¯•æ”¯ä»˜å“åº”æ—¶é—´",
                            "details": "æ”¯ä»˜è¯·æ±‚åˆ°å“åº”çš„å»¶è¿Ÿ",
                            "criticality": "medium",
                            "verification": "ä½¿ç”¨æ€§èƒ½æµ‹è¯•å·¥å…·",
                            "expected_result": "å“åº”æ—¶é—´<2ç§’"
                        },
                        {
                            "id": "TEST-PERF-02",
                            "description": "æµ‹è¯•å¹¶å‘æ”¯ä»˜",
                            "details": "å¤šä¸ªç”¨æˆ·åŒæ—¶æ”¯ä»˜",
                            "criticality": "medium",
                            "verification": "æ¨¡æ‹Ÿå¹¶å‘æ”¯ä»˜è¯·æ±‚",
                            "expected_result": "å¹¶å‘å¤„ç†æ­£å¸¸"
                        },
                        {
                            "id": "TEST-PERF-03",
                            "description": "æµ‹è¯•ç³»ç»Ÿè´Ÿè½½",
                            "details": "é«˜è´Ÿè½½ä¸‹çš„ç³»ç»Ÿè¡¨ç°",
                            "criticality": "medium",
                            "verification": "å‹åŠ›æµ‹è¯•å·¥å…·",
                            "expected_result": "ç³»ç»Ÿç¨³å®šï¼Œæ— å´©æºƒ"
                        },
                        {
                            "id": "TEST-PERF-04",
                            "description": "æµ‹è¯•æ•°æ®åº“æ€§èƒ½",
                            "details": "æŸ¥è¯¢å“åº”æ—¶é—´ï¼Œè¿æ¥æ•°",
                            "criticality": "medium",
                            "verification": "æ•°æ®åº“æ€§èƒ½ç›‘æ§",
                            "expected_result": "æ•°æ®åº“æ€§èƒ½æ­£å¸¸"
                        }
                    ]
                },
                {
                    "section": "å®‰å…¨æµ‹è¯•",
                    "items": [
                        {
                            "id": "TEST-SEC-01",
                            "description": "æµ‹è¯•SQLæ³¨å…¥é˜²æŠ¤",
                            "details": "å°è¯•SQLæ³¨å…¥æ”»å‡»",
                            "criticality": "high",
                            "verification": "å®‰å…¨æµ‹è¯•å·¥å…·",
                            "expected_result": "SQLæ³¨å…¥è¢«é˜»æ­¢"
                        },
                        {
                            "id": "TEST-SEC-02",
                            "description": "æµ‹è¯•XSSé˜²æŠ¤",
                            "details": "å°è¯•è·¨ç«™è„šæœ¬æ”»å‡»",
                            "criticality": "high",
                            "verification": "XSSæµ‹è¯•å·¥å…·",
                            "expected_result": "XSSæ”»å‡»è¢«é˜»æ­¢"
                        },
                        {
                            "id": "TEST-SEC-03",
                            "description": "æµ‹è¯•CSRFé˜²æŠ¤",
                            "details": "å°è¯•è·¨ç«™è¯·æ±‚ä¼ªé€ ",
                            "criticality": "high",
                            "verification": "CSRFæµ‹è¯•",
                            "expected_result": "CSRFæ”»å‡»è¢«é˜»æ­¢"
                        },
                        {
                            "id": "TEST-SEC-04",
                            "description": "æµ‹è¯•æ”¯ä»˜é‡æ”¾æ”»å‡»",
                            "details": "é‡å¤å‘é€æ”¯ä»˜è¯·æ±‚",
                            "criticality": "high",
                            "verification": "æ¨¡æ‹Ÿé‡æ”¾æ”»å‡»",
                            "expected_result": "é‡æ”¾æ”»å‡»è¢«é˜»æ­¢"
                        }
                    ]
                },
                {
                    "section": "å…¼å®¹æ€§æµ‹è¯•",
                    "items": [
                        {
                            "id": "TEST-COMP-01",
                            "description": "æµ‹è¯•æµè§ˆå™¨å…¼å®¹æ€§",
                            "details": "Chromeã€Firefoxã€Safariã€Edge",
                            "criticality": "medium",
                            "verification": "åœ¨ä¸åŒæµè§ˆå™¨æµ‹è¯•",
                            "expected_result": "ä¸»è¦æµè§ˆå™¨å…¼å®¹"
                        },
                        {
                            "id": "TEST-COMP-02",
                            "description": "æµ‹è¯•ç§»åŠ¨ç«¯å…¼å®¹æ€§",
                            "details": "æ‰‹æœºæµè§ˆå™¨ã€å¾®ä¿¡å†…è®¿é—®",
                            "criticality": "medium",
                            "verification": "åœ¨ç§»åŠ¨è®¾å¤‡æµ‹è¯•",
                            "expected_result": "ç§»åŠ¨ç«¯å…¼å®¹"
                        },
                        {
                            "id": "TEST-COMP-03",
                            "description": "æµ‹è¯•ä¸åŒåˆ†è¾¨ç‡",
                            "details": "å„ç§å±å¹•å°ºå¯¸æ˜¾ç¤º",
                            "criticality": "low",
                            "verification": "ä¸åŒåˆ†è¾¨ç‡æµ‹è¯•",
                            "expected_result": "å“åº”å¼è®¾è®¡æ­£å¸¸"
                        }
                    ]
                }
            ],
            
            "completion_criteria": [
                "æ‰€æœ‰åŠŸèƒ½æµ‹è¯•é€šè¿‡",
                "æ€§èƒ½æµ‹è¯•è¾¾æ ‡",
                "å®‰å…¨æµ‹è¯•æ— æ¼æ´",
                "å…¼å®¹æ€§æµ‹è¯•é€šè¿‡"
            ],
            
            "notes": "æµ‹è¯•éœ€è¦è¯¦ç»†è®°å½•æµ‹è¯•ç»“æœå’Œå‘ç°çš„é—®é¢˜ã€‚"
        }
        
        self._save_checklist(checklist, "05_testing")
        return checklist
    
    def _create_post_deployment_checklist(self):
        """åˆ›å»ºéƒ¨ç½²åæ£€æŸ¥æ¸…å•"""
        checklist = {
            "id": "POST_DEPLOYMENT",
            "title": "éƒ¨ç½²åæ£€æŸ¥æ¸…å•",
            "phase": "post-deployment",
            "target": "è¿ç»´å·¥ç¨‹å¸ˆ",
            "estimated_time": "1å°æ—¶",
            
            "sections": [
                {
                    "section": "ç³»ç»Ÿç›‘æ§",
                    "items": [
                        {
                            "id": "POST-MON-01",
                            "description": "é…ç½®ç³»ç»Ÿç›‘æ§",
                            "details": "CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œç›‘æ§",
                            "criticality": "high",
                            "verification": "æ£€æŸ¥ç›‘æ§ç³»ç»Ÿ",
                            "expected_result": "ç›‘æ§é…ç½®å®Œæˆ"
                        },
                        {
                            "id": "POST-MON-02",
                            "description": "é…ç½®åº”ç”¨ç›‘æ§",
                            "details": "OdooæœåŠ¡ã€æ•°æ®åº“ã€Redisç›‘æ§",
                            "criticality": "high",
                            "verification": "æ£€æŸ¥åº”ç”¨ç›‘æ§",
                            "expected_result": "åº”ç”¨ç›‘æ§æ­£å¸¸"
                        },
                        {
                            "id": "POST-MON-03",
                            "description": "é…ç½®ä¸šåŠ¡ç›‘æ§",
                            "details": "æ”¯ä»˜æˆåŠŸç‡ã€äº¤æ˜“é‡ã€é”™è¯¯ç‡",
                            "criticality": "medium",
                            "verification": "æ£€æŸ¥ä¸šåŠ¡ç›‘æ§ä»ªè¡¨æ¿",
                            "expected_result": "ä¸šåŠ¡ç›‘æ§æ­£å¸¸"
                        },
                        {
                            "id": "POST-MON-04",
                            "description": "é…ç½®å‘Šè­¦é€šçŸ¥",
                            "details": "è®¾ç½®å¼‚å¸¸å‘Šè­¦é€šçŸ¥æ–¹å¼",
                            "criticality": "medium",
                            "verification": "æµ‹è¯•å‘Šè­¦é€šçŸ¥",
                            "expected_result": "å‘Šè­¦é€šçŸ¥æ­£å¸¸"
                        }
                    ]
                },
                {
                    "section": "å¤‡ä»½éªŒè¯",
                    "items": [
                        {
                            "id": "POST-BAK-01",
                            "description": "éªŒè¯è‡ªåŠ¨å¤‡ä»½",
                            "details": "æµ‹è¯•æ•°æ®åº“è‡ªåŠ¨å¤‡ä»½",
                            "criticality": "high",
                            "verification": "æ£€æŸ¥å¤‡ä»½æ–‡ä»¶",
                            "expected_result": "è‡ªåŠ¨å¤‡ä»½æ­£å¸¸"
                        },
                        {
                            "id": "POST-BAK-02",
                            "description": "æµ‹è¯•å¤‡ä»½æ¢å¤",
                            "details": "ä»å¤‡ä»½æ¢å¤æµ‹è¯•",
                            "criticality": "high",
                            "verification": "æ¢å¤æµ‹è¯•ç¯å¢ƒ",
                            "expected_result": "å¤‡ä»½å¯æ¢å¤"
                        },
                        {
                            "id": "POST-BAK-03",
                            "description": "è®¾ç½®å¤‡ä»½ä¿ç•™ç­–ç•¥",
                            "details": "é…ç½®å¤‡ä»½ä¿ç•™æ—¶é—´å’Œæ•°é‡",
                            "criticality": "medium",
                            "verification": "æ£€æŸ¥å¤‡ä»½ç­–ç•¥",
                            "expected_result": "å¤‡ä»½ç­–ç•¥å·²è®¾ç½®"
                        },
                        {
                            "id": "POST-BAK-04",
                            "description": "é…ç½®å¼‚åœ°å¤‡ä»½",
                            "details": "è®¾ç½®é‡è¦æ•°æ®å¼‚åœ°å¤‡ä»½",
                            "criticality": "medium",
                            "verification": "æ£€æŸ¥å¼‚åœ°å¤‡ä»½é…ç½®",
                            "expected_result": "å¼‚åœ°å¤‡ä»½é…ç½®å®Œæˆ"
                        }
                    ]
                },
                {
                    "section": "æ–‡æ¡£æ•´ç†",
                    "items": [
                        {
                            "id": "POST-DOC-01",
                            "description": "æ•´ç†éƒ¨ç½²æ–‡æ¡£",
                            "details": "è®°å½•éƒ¨ç½²è¿‡ç¨‹å’Œé…ç½®",
                            "criticality": "medium",
                            "verification": "æ£€æŸ¥éƒ¨ç½²æ–‡æ¡£",
                            "expected_result": "éƒ¨ç½²æ–‡æ¡£å®Œæ•´"
                        },
                        {
                            "id": "POST-DOC-02",
                            "description": "æ›´æ–°é…ç½®æ¸…å•",
                            "details": "è®°å½•æ‰€æœ‰é…ç½®é¡¹å’Œå‚æ•°",
                            "criticality": "medium",
                            "verification": "æ£€æŸ¥é…ç½®æ¸…å•",
                            "expected_result": "é…ç½®æ¸…å•å®Œæ•´"
                        },
                        {
                            "id": "POST-DOC-03",
                            "description": "æ•´ç†é—®é¢˜è®°å½•",
                            "details": "è®°å½•éƒ¨ç½²è¿‡ç¨‹ä¸­çš„é—®é¢˜å’Œè§£å†³",
                            "criticality": "low",
                            "verification": "æ£€æŸ¥é—®é¢˜è®°å½•",
                            "expected_result": "é—®é¢˜è®°å½•å®Œæ•´"
                        },
                        {
                            "id": "POST-DOC-04",
                            "description": "åˆ¶ä½œè¿ç»´æ‰‹å†Œ",
                            "details": "åˆ¶ä½œç³»ç»Ÿè¿ç»´æ“ä½œæ‰‹å†Œ",
                            "criticality": "medium",
                            "verification": "æ£€æŸ¥è¿ç»´æ‰‹å†Œ",
                            "expected_result": "è¿ç»´æ‰‹å†Œå®Œæˆ"
                        }
                    ]
                },
                {
                    "section": "åŸ¹è®­äº¤æ¥",
                    "items": [
                        {
                            "id": "POST-TRN-01",
                            "description": "ç®¡ç†å‘˜åŸ¹è®­",
                            "details": "åŸ¹è®­ç³»ç»Ÿç®¡ç†å‘˜æ“ä½œ",
                            "criticality": "high",
                            "verification": "ç®¡ç†å‘˜æ“ä½œè€ƒæ ¸",
                            "expected_result": "ç®¡ç†å‘˜æŒæ¡æ“ä½œ"
                        },
                        {
                            "id": "POST-TRN-02",
                            "description": "ç”¨æˆ·åŸ¹è®­",
                            "details": "åŸ¹è®­ç»ˆç«¯ç”¨æˆ·ä½¿ç”¨",
                            "criticality": "medium",
                            "verification": "ç”¨æˆ·æ“ä½œæµ‹è¯•",
                            "expected_result": "ç”¨æˆ·æŒæ¡åŸºæœ¬æ“ä½œ"
                        },
                        {
                            "id": "POST-TRN-03",
                            "description": "å»ºç«‹æ”¯æŒæ¸ é“",
                            "details": "å»ºç«‹æŠ€æœ¯æ”¯æŒè”ç³»æ–¹å¼",
                            "criticality": "medium",
                            "verification": "æµ‹è¯•æ”¯æŒæ¸ é“",
                            "expected_result": "æ”¯æŒæ¸ é“ç•…é€š"
                        },
                        {
                            "id": "POST-TRN-04",
                            "description": "åˆ¶å®šç»´æŠ¤è®¡åˆ’",
                            "details": "åˆ¶å®šå®šæœŸç»´æŠ¤è®¡åˆ’",
                            "criticality": "medium",
                            "verification": "æ£€æŸ¥ç»´æŠ¤è®¡åˆ’",
                            "expected_result": "ç»´æŠ¤è®¡åˆ’åˆ¶å®šå®Œæˆ"
                        }
                    ]
                }
            ],
            
            "completion_criteria": [
                "ç›‘æ§ç³»ç»Ÿé…ç½®å®Œæˆ",
                "å¤‡ä»½æ¢å¤éªŒè¯é€šè¿‡",
                "æ–‡æ¡£æ•´ç†å®Œæˆ",
                "åŸ¹è®­äº¤æ¥å®Œæˆ"
            ],
            
            "notes": "éƒ¨ç½²åæ£€æŸ¥ç¡®ä¿ç³»ç»Ÿç¨³å®šè¿è¡Œå’Œå¯ç»´æŠ¤æ€§ã€‚"
        }
        
        self._save_checklist(checklist, "06_post_deployment")
        return checklist
    
    def _create_master_checklist(self, checklists):
        """åˆ›å»ºæ€»æ£€æŸ¥æ¸…å•"""
        master = {
            "project": "Odoo 19å¾®ä¿¡æ”¯ä»˜ä¸ç”Ÿæ€ç³»ç»Ÿé›†æˆé¡¹ç›®",
            "version": "1.0.0",
            "generated_date": datetime.now().isoformat(),
            "total_phases": len(checklists),
            "total_items": 0,
            
            "phases": [],
            "timeline": [],
            "roles": {},
            "critical_items": []
        }
        
        role_count = {}
        for checklist in checklists:
            # ç»Ÿè®¡æ¯ä¸ªé˜¶æ®µçš„é¡¹ç›®æ•°
            phase_items = sum(len(section["items"]) for section in checklist["sections"])
            master["total_items"] += phase_items
            
            # æ”¶é›†é˜¶æ®µä¿¡æ¯
            master["phases"].append({
                "id": checklist["id"],
                "title": checklist["title"],
                "phase": checklist["phase"],
                "target": checklist["target"],
                "estimated_time": checklist["estimated_time"],
                "item_count": phase_items,
                "criticality": self._calculate_criticality(checklist)
            })
            
            # æ”¶é›†æ—¶é—´çº¿
            master["timeline"].append({
                "phase": checklist["phase"],
                "title": checklist["title"],
                "time": checklist["estimated_time"],
                "depends_on": self._get_dependencies(checklist["phase"])
            })
            
            # ç»Ÿè®¡è§’è‰²
            targets = checklist["target"] if isinstance(checklist["target"], list) else [checklist["target"]]
            for target in targets:
                role_count[target] = role_count.get(target, 0) + phase_items
            
            # æ”¶é›†å…³é”®é¡¹ç›®
            for section in checklist["sections"]:
                for item in section["items"]:
                    if item["criticality"] == "high":
                        master["critical_items"].append({
                            "id": item["id"],
                            "phase": checklist["phase"],
                            "description": item["description"],
                            "details": item["details"]
                        })
        
        # è®¡ç®—è§’è‰²å·¥ä½œé‡
        for role, count in role_count.items():
            master["roles"][role] = {
                "item_count": count,
                "percentage": f"{(count / master['total_items'] * 100):.1f}%"
            }
        
        # ç”Ÿæˆä¸»æ¸…å•æ–‡æ¡£
        self._generate_master_document(master, checklists)
        
        print(f"ğŸ“Š æ€»æ£€æŸ¥é¡¹ç›®: {master['total_items']} ä¸ª")
        print(f"âš ï¸  å…³é”®é¡¹ç›®: {len(master['critical_items'])} ä¸ª")
    
    def _calculate_criticality(self, checklist):
        """è®¡ç®—é˜¶æ®µçš„ç´§æ€¥ç¨‹åº¦"""
        high_count = 0
        total = 0
        
        for section in checklist["sections"]:
            for item in section["items"]:
                total += 1
                if item["criticality"] == "high":
                    high_count += 1
        
        if high_count / total > 0.5:
            return "critical"
        elif high_count / total > 0.2:
            return "important"
        else:
            return "normal"
    
    def _get_dependencies(self, phase):
        """è·å–é˜¶æ®µä¾èµ–å…³ç³»"""
        dependencies = {
            "pre-deployment": [],
            "installation": ["pre-deployment"],
            "configuration": ["installation"],
            "security": ["configuration"],
            "testing": ["configuration", "security"],
            "post-deployment": ["installation", "configuration", "security", "testing"]
        }
        
        return dependencies.get(phase, [])
    
    def _generate_master_document(self, master, checklists):
        """ç”Ÿæˆä¸»æ¸…å•æ–‡æ¡£"""
        doc_path = self.output_dir / "MASTER_CHECKLIST.md"
        
        content = f"""# éƒ¨ç½²æ€»æ£€æŸ¥æ¸…å•

## é¡¹ç›®ä¿¡æ¯
- **é¡¹ç›®åç§°**: {master['project']}
- **ç‰ˆæœ¬**: {master['version']}
- **ç”Ÿæˆæ—¥æœŸ**: {master['generated_date']}
- **æ€»é˜¶æ®µæ•°**: {master['total_phases']}
- **æ€»æ£€æŸ¥é¡¹**: {master['total_items']}
- **å…³é”®é¡¹ç›®**: {len(master['critical_items'])} ä¸ª

## ğŸ“‹ é˜¶æ®µæ¦‚è§ˆ

| é˜¶æ®µ | æ ‡é¢˜ | ç›®æ ‡è§’è‰² | é¢„è®¡æ—¶é—´ | æ£€æŸ¥é¡¹ | ç´§æ€¥ç¨‹åº¦ |
|------|------|----------|----------|--------|----------|
"""
        
        for phase in master["phases"]:
            targets = ", ".join(phase["target"]) if isinstance(phase["target"], list) else phase["target"]
            urgency_icon = {
                "critical": "ğŸ”´",
                "important": "ğŸŸ¡", 
                "normal": "ğŸŸ¢"
            }.get(phase["criticality"], "âšª")
            
            content += f"| {phase['phase']} | {phase['title']} | {targets} | {phase['estimated_time']} | {phase['item_count']} | {urgency_icon} {phase['criticality']} |\n"
        
        content += f"""
## â±ï¸ æ—¶é—´çº¿è§„åˆ’

```
"""
        
        for timeline in master["timeline"]:
            depends = ", ".join(timeline["depends_on"]) if timeline["depends_on"] else "æ— "
            content += f"{timeline['phase']:20} {timeline['time']:10} ä¾èµ–: {depends}\n"
        
        content += """```

## ğŸ‘¥ è§’è‰²åˆ†å·¥

| è§’è‰² | æ£€æŸ¥é¡¹æ•° | å æ¯” | ä¸»è¦èŒè´£ |
|------|----------|------|----------|
"""
        
        for role, info in master["roles"].items():
            responsibilities = {
                "ç³»ç»Ÿç®¡ç†å‘˜": "ç¯å¢ƒå‡†å¤‡ã€ç³»ç»Ÿå®‰è£…ã€åŸºç¡€é…ç½®",
                "å®æ–½å·¥ç¨‹å¸ˆ": "æ¨¡å—å®‰è£…ã€åŠŸèƒ½é…ç½®ã€æµ‹è¯•éƒ¨ç½²",
                "æ”¯ä»˜ç®¡ç†å‘˜": "æ”¯ä»˜æ¸ é“é…ç½®ã€è¯ä¹¦ç®¡ç†ã€æ”¯ä»˜æµ‹è¯•", 
                "å®‰å…¨ç®¡ç†å‘˜": "å®‰å…¨é…ç½®ã€æ¼æ´æ£€æŸ¥ã€åˆè§„éªŒè¯",
                "æµ‹è¯•å·¥ç¨‹å¸ˆ": "åŠŸèƒ½æµ‹è¯•ã€æ€§èƒ½æµ‹è¯•ã€å®‰å…¨æµ‹è¯•",
                "è´¨é‡ä¿è¯": "æµ‹è¯•è®¡åˆ’ã€ç¼ºé™·ç®¡ç†ã€è´¨é‡æŠ¥å‘Š",
                "è¿ç»´å·¥ç¨‹å¸ˆ": "ç›‘æ§é…ç½®ã€å¤‡ä»½éªŒè¯ã€æ–‡æ¡£æ•´ç†"
            }.get(role, "æ ¹æ®å…·ä½“ä»»åŠ¡ç¡®å®š")
            
            content += f"| {role} | {info['item_count']} | {info['percentage']} | {responsibilities} |\n"
        
        content += f"""
## âš ï¸ å…³é”®æ£€æŸ¥é¡¹ç›®

ä»¥ä¸‹æ˜¯æ‰€æœ‰é˜¶æ®µä¸­çš„å…³é”®æ£€æŸ¥é¡¹ç›®ï¼ˆå…±{len(master['critical_items'])}ä¸ªï¼‰ï¼š
"""
        
        for item in master["critical_items"]:
            content += f"\n### {item['id']} - {item['description']}\n"
            content += f"- **é˜¶æ®µ**: {item['phase']}\n"
            content += f"- **è¯¦æƒ…**: {item['details']}\n"
        
        content += """
## ğŸ“ è¯¦ç»†æ¸…å•

æ¯ä¸ªé˜¶æ®µçš„è¯¦ç»†æ£€æŸ¥æ¸…å•ï¼š

"""
        
        for checklist in checklists:
            filename = checklist["id"].lower() + ".json"
            content += f"1. [{checklist['title']}]({filename}) - {checklist['estimated_time']}\n"
        
        content += """
## ğŸš¨ ç´§æ€¥æ³¨æ„äº‹é¡¹

### å¿…é¡»å®Œæˆçš„å…³é”®é¡¹ç›®
1. **ç¯å¢ƒæ£€æŸ¥**ï¼šç¡®ä¿ç¡¬ä»¶å’Œè½¯ä»¶æ»¡è¶³è¦æ±‚
2. **æ”¯ä»˜é…ç½®**ï¼šæ­£ç¡®é…ç½®æ”¯ä»˜æ¸ é“å’Œè¯ä¹¦  
3. **å®‰å…¨é…ç½®**ï¼šå¯ç”¨å¿…è¦çš„å®‰å…¨æªæ–½
4. **å¤‡ä»½éªŒè¯**ï¼šç¡®ä¿æ•°æ®å¯æ¢å¤

### å¸¸è§é£é™©
1. **è¯ä¹¦é”™è¯¯**ï¼šæ”¯ä»˜è¯ä¹¦é…ç½®é”™è¯¯å¯¼è‡´æ”¯ä»˜å¤±è´¥
2. **ç½‘ç»œé—®é¢˜**ï¼šå›è°ƒåœ°å€ä¸å¯è®¿é—®å¯¼è‡´æ”¯ä»˜çŠ¶æ€ä¸åŒæ­¥
3. **æƒé™é—®é¢˜**ï¼šæ–‡ä»¶æƒé™é”™è¯¯å¯¼è‡´æœåŠ¡æ— æ³•å¯åŠ¨
4. **é…ç½®é—æ¼**ï¼šé‡è¦é…ç½®é¡¹é—æ¼å¯¼è‡´åŠŸèƒ½å¼‚å¸¸

### åº”æ€¥é¢„æ¡ˆ
1. **éƒ¨ç½²å¤±è´¥**ï¼šæŒ‰ç…§å›æ»šè®¡åˆ’æ¢å¤
2. **æ”¯ä»˜æ•…éšœ**ï¼šåˆ‡æ¢å¤‡ç”¨æ”¯ä»˜æ¸ é“
3. **æ•°æ®ä¸¢å¤±**ï¼šä»å¤‡ä»½æ¢å¤æ•°æ®
4. **å®‰å…¨äº‹ä»¶**ï¼šæŒ‰ç…§å®‰å…¨åº”æ€¥é¢„æ¡ˆå¤„ç†

## ğŸ“ æ”¯æŒèµ„æº

### æ–‡æ¡£èµ„æº
- [éƒ¨ç½²è¿ç»´æ‰‹å†Œ](docs/æŠ€æœ¯æ–‡æ¡£/04-éƒ¨ç½²è¿ç»´æ‰‹å†Œ.md)
- [é…ç½®æŒ‡å—](docs/ç”¨æˆ·æ–‡æ¡£/01-ç³»ç»Ÿç®¡ç†å‘˜æ‰‹å†Œ.md)
- [æ•…éšœæ’é™¤](docs/FAQ.md)
- [è§†é¢‘æ•™ç¨‹](training_videos/)

### æŠ€æœ¯æ”¯æŒ
- **éƒ¨ç½²æ”¯æŒ**: deploy-support@example.com
- **æ”¯ä»˜æ”¯æŒ**: payment-support@example.com  
- **ç´§æ€¥è”ç³»**: 400-XXX-XXXX

### æ£€æŸ¥å·¥å…·
- ç¯å¢ƒæ£€æŸ¥è„šæœ¬: `scripts/check_environment.py`
- é…ç½®éªŒè¯å·¥å…·: `scripts/verify_config.py`
- æ€§èƒ½æµ‹è¯•å·¥å…·: `scripts/performance_test.py`

## ğŸ“ ä½¿ç”¨è¯´æ˜

### å¦‚ä½•ä½¿ç”¨æ£€æŸ¥æ¸…å•
1. **å‡†å¤‡é˜¶æ®µ**ï¼šé˜…è¯»æ•´ä¸ªæ¸…å•ï¼Œç†è§£å„é˜¶æ®µè¦æ±‚
2. **æ‰§è¡Œé˜¶æ®µ**ï¼šæŒ‰é˜¶æ®µé¡ºåºæ‰§è¡Œï¼Œé€é¡¹æ£€æŸ¥
3. **è®°å½•é˜¶æ®µ**ï¼šè®°å½•æ£€æŸ¥ç»“æœå’Œé—®é¢˜
4. **éªŒè¯é˜¶æ®µ**ï¼šéªŒè¯æ‰€æœ‰æ£€æŸ¥é¡¹é€šè¿‡

### æ£€æŸ¥è®°å½•è¦æ±‚
1. è®°å½•æ¯ä¸ªé¡¹ç›®çš„æ£€æŸ¥ç»“æœï¼ˆé€šè¿‡/å¤±è´¥ï¼‰
2. è®°å½•å¤±è´¥é¡¹ç›®çš„è¯¦ç»†ä¿¡æ¯å’Œè§£å†³æªæ–½
3. è®°å½•æ£€æŸ¥æ—¶é—´å’Œæ£€æŸ¥äººå‘˜
4. ä¿å­˜æ£€æŸ¥è®°å½•ä½œä¸ºéƒ¨ç½²æ–‡æ¡£

### è´¨é‡ä¿è¯
1. å…³é”®é¡¹ç›®å¿…é¡»ç”±ä¸¤äººæ£€æŸ¥
2. æ‰€æœ‰å¤±è´¥é¡¹ç›®å¿…é¡»è§£å†³åæ‰èƒ½è¿›å…¥ä¸‹ä¸€é˜¶æ®µ
3. æ£€æŸ¥è®°å½•éœ€è¦å®¡æ ¸ç¡®è®¤
4. éƒ¨ç½²å®Œæˆåå½’æ¡£æ‰€æœ‰æ£€æŸ¥è®°å½•

---

*æœ¬æ£€æŸ¥æ¸…å•å°†æ ¹æ®é¡¹ç›®ç»éªŒå’Œç”¨æˆ·åé¦ˆæŒç»­ä¼˜åŒ–ã€‚*
*æœ€åæ›´æ–°: {datetime.now().strftime('%Y-%m-%d')}*
"""
        
        with open(doc_path, "w", encoding="utf-8") as f:
            f.write(content)
        
        print(f"ğŸ“„ ä¸»æ£€æŸ¥æ¸…å•: {doc_path}")
    
    def _save_checklist(self, checklist, filename):
        """ä¿å­˜æ£€æŸ¥æ¸…å•"""
        checklist_dir = self.output_dir / "checklists"
        checklist_dir.mkdir(exist_ok=True)
        
        checklist_path = checklist_dir / f"{filename}.json"
        with open(checklist_path, "w", encoding="utf-8") as f:
            json.dump(checklist, f, indent=2, ensure_ascii=False)
        
        print(f"  ğŸ“‹ {checklist['title']}")
        
        # åŒæ—¶ç”ŸæˆMarkdownç‰ˆæœ¬
        self._generate_checklist_markdown(checklist, filename)

    def _generate_checklist_markdown(self, checklist, filename):
        """ç”Ÿæˆæ£€æŸ¥æ¸…å•çš„Markdownç‰ˆæœ¬"""
        md_path = self.output_dir / "checklists" / f"{filename}.md"
        
        content = f"""# {checklist['title']}

## åŸºæœ¬ä¿¡æ¯
- **é˜¶æ®µ**: {checklist['phase']}
- **ç›®æ ‡è§’è‰²**: {', '.join(checklist['target']) if isinstance(checklist['target'], list) else checklist['target']}
- **é¢„è®¡æ—¶é—´**: {checklist['estimated_time']}
- **æ¸…å•ID**: {checklist['id']}

## æ£€æŸ¥é¡¹ç›®

"""
        
        for section in checklist["sections"]:
            content += f"### {section['section']}\n\n"
            content += "| ID | æè¿° | è¯¦æƒ… | ç´§æ€¥ç¨‹åº¦ | éªŒè¯æ–¹æ³• | é¢„æœŸç»“æœ | ç»“æœ | å¤‡æ³¨ |\n"
            content += "|----|------|------|----------|----------|----------|------|------|\n"
            
            for item in section["items"]:
                criticality_icon = {
                    "high": "ğŸ”´",
                    "medium": "ğŸŸ¡",
                    "low": "ğŸŸ¢"
                }.get(item["criticality"], "âšª")
                
                content += f"| {item['id']} | {item['description']} | {item['details']} | {criticality_icon} {item['criticality']} | {item['verification']} | {item['expected_result']} | | |\n"
            
            content += "\n"
        
        content += f"""
## å®Œæˆæ ‡å‡†

{chr(10).join(f"- {criterion}" for criterion in checklist['completion_criteria'])}

## æ³¨æ„äº‹é¡¹

{checklist['notes']}

## æ£€æŸ¥è®°å½•

| æ£€æŸ¥æ—¶é—´ | æ£€æŸ¥äººå‘˜ | é€šè¿‡é¡¹æ•° | å¤±è´¥é¡¹æ•° | æ€»ä½“ç»“æœ | ç­¾å­— |
|----------|----------|----------|----------|----------|------|
| | | | | | |
| | | | | | |

## é—®é¢˜è®°å½•

| é—®é¢˜ID | é—®é¢˜æè¿° | è§£å†³æªæ–½ | è§£å†³äººå‘˜ | è§£å†³æ—¶é—´ | éªŒè¯ç»“æœ |
|--------|----------|----------|----------|----------|----------|
| | | | | | |
| | | | | | |

---

*æ£€æŸ¥æ¸…å•ç‰ˆæœ¬: 1.0*
*æœ€åæ›´æ–°: {datetime.now().strftime('%Y-%m-%d')}*
"""
        
        with open(md_path, "w", encoding="utf-8") as f:
            f.write(content)

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    generator = DeploymentChecklistGenerator()
    checklists = generator.generate_all_checklists()
    
    print("\nâœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•ç”Ÿæˆå®Œæˆï¼")
    print("ğŸ“‹ ä¸‹ä¸€æ­¥:")
    print("1. ä½¿ç”¨æ£€æŸ¥æ¸…å•æŒ‡å¯¼éƒ¨ç½²")
    print("2. è®°å½•æ£€æŸ¥ç»“æœå’Œé—®é¢˜")
    print("3. æ ¹æ®ç»éªŒä¼˜åŒ–æ¸…å•å†…å®¹")
    print(f"ğŸ“ è¾“å‡ºç›®å½•: {generator.output_dir}")
```

### **å®‰å…¨å®¡æŸ¥ä¸“å®¶å…·ä½“ä»»åŠ¡ï¼š**

#### **ä»»åŠ¡1ï¼šåŸ¹è®­ææ–™æ‰“åŒ…è„šæœ¬**
```python
# file: scripts/package_training_materials.py

#!/usr/bin/env python3
"""
åŸ¹è®­ææ–™æ‰“åŒ…è„šæœ¬
å°†æ‰€æœ‰åŸ¹è®­ææ–™æ‰“åŒ…æˆå®Œæ•´çš„åŸ¹è®­åŒ…
"""

import os
import shutil
import zipfile
import tarfile
from datetime import datetime
from pathlib import Path
import json

class TrainingMaterialPackager:
    """åŸ¹è®­ææ–™æ‰“åŒ…å™¨"""
    
    def __init__(self, project_root="."):
        self.project_root = Path(project_root).resolve()
        self.training_dir = self.project_root / "training_materials"
        self.output_dir = self.project_root / "dist_training"
        
    def create_training_structure(self):
        """åˆ›å»ºåŸ¹è®­ææ–™ç»“æ„"""
        print("ğŸ“š åˆ›å»ºåŸ¹è®­ææ–™ç»“æ„...")
        
        # åˆ›å»ºç›®å½•ç»“æ„
        structure = {
            "åŸ¹è®­è¯¾ä»¶": [
                "01_ç³»ç»Ÿæ¦‚è¿°.pptx",
                "02_å®‰è£…éƒ¨ç½².pptx", 
                "03_é…ç½®æŒ‡å—.pptx",
                "04_æ“ä½œåŸ¹è®­.pptx",
                "05_æ•…éšœæ’é™¤.pptx",
                "06_å®‰å…¨åˆè§„.pptx"
            ],
            "æ“ä½œæ‰‹å†Œ": [
                "ç³»ç»Ÿç®¡ç†å‘˜æ‰‹å†Œ.pdf",
                "ç»ˆç«¯ç”¨æˆ·æ“ä½œæŒ‡å—.pdf",
                "POSæ”¶é“¶å‘˜æ‰‹å†Œ.pdf",
                "å°ç¨‹åºä½¿ç”¨è¯´æ˜.pdf"
            ],
            "è§†é¢‘æ•™ç¨‹": {
                "01_å®‰è£…éƒ¨ç½²": [
                    "01_ç¯å¢ƒå‡†å¤‡.mp4",
                    "02_Dockerå®‰è£….mp4",
                    "03_æ¨¡å—å®‰è£….mp4"
                ],
                "02_é…ç½®æŒ‡å—": [
                    "01_å¾®ä¿¡æ”¯ä»˜é…ç½®.mp4",
                    "02_æ”¯ä»˜å®é…ç½®.mp4",
                    "03_å…¬ä¼—å·é…ç½®.mp4"
                ],
                "03_æ“ä½œåŸ¹è®­": [
                    "01_æ”¯ä»˜æ“ä½œ.mp4",
                    "02_POSæ”¶é“¶.mp4",
                    "03_å…¬ä¼—å·ç®¡ç†.mp4"
                ],
                "04_æ•…éšœæ’é™¤": [
                    "01_å¸¸è§é—®é¢˜.mp4",
                    "02_æ”¯ä»˜æ•…éšœ.mp4",
                    "03_ç³»ç»Ÿç»´æŠ¤.mp4"
                ]
            },
            "ç»ƒä¹ ææ–™": [
                "ç»ƒä¹ ç¯å¢ƒè¯´æ˜.txt",
                "ç»ƒä¹ ä»»åŠ¡æ¸…å•.xlsx",
                "ç»ƒä¹ æ•°æ®.sql",
                "ç»ƒä¹ ç­”æ¡ˆ.pdf"
            ],
            "è¯„ä¼°ææ–™": [
                "ç†è®ºçŸ¥è¯†æµ‹è¯•é¢˜.docx",
                "æ“ä½œæŠ€èƒ½è€ƒæ ¸è¡¨.xlsx",
                "åŸ¹è®­åé¦ˆé—®å·.docx",
                "åŸ¹è®­è¯ä¹¦æ¨¡æ¿.pptx"
            ],
            "å‚è€ƒèµ„æ–™": [
                "APIæ–‡æ¡£.pdf",
                "æŠ€æœ¯æ¶æ„å›¾.pdf",
                "æµç¨‹å›¾.pdf",
                "æœ¯è¯­è¡¨.xlsx"
            ]
        }
        
        # åˆ›å»ºç›®å½•å’Œå ä½æ–‡ä»¶
        self._create_structure(structure)
        
        # åˆ›å»ºåŸ¹è®­è®¡åˆ’
        self._create_training_plan()
        
        # åˆ›å»ºè®²å¸ˆæŒ‡å—
        self._create_instructor_guide()
        
        # åˆ›å»ºå­¦å‘˜æ‰‹å†Œ
        self._create_student_guide()
        
        print("âœ… åŸ¹è®­ææ–™ç»“æ„åˆ›å»ºå®Œæˆ")
        
    def _create_structure(self, structure, base_dir=None):
        """é€’å½’åˆ›å»ºç›®å½•ç»“æ„"""
        if base_dir is None:
            base_dir = self.training_dir
        
        base_dir.mkdir(parents=True, exist_ok=True)
        
        for key, value in structure.items():
            if isinstance(value, dict):
                # åˆ›å»ºå­ç›®å½•
                sub_dir = base_dir / key
                sub_dir.mkdir(exist_ok=True)
                self._create_structure(value, sub_dir)
            elif isinstance(value, list):
                # åˆ›å»ºæ–‡ä»¶
                for filename in value:
                    file_path = base_dir / filename
                    if not file_path.exists():
                        # åˆ›å»ºå ä½æ–‡ä»¶
                        if filename.endswith('.txt'):
                            content = f"è¿™æ˜¯ {filename} çš„å ä½æ–‡ä»¶\nè¯·åœ¨æ­¤æ·»åŠ å®é™…å†…å®¹\nåˆ›å»ºæ—¶é—´: {datetime.now()}"
                            file_path.write_text(content, encoding='utf-8')
                        elif filename.endswith('.md'):
                            content = f"# {filename}\n\nè¿™æ˜¯ {filename} çš„å ä½æ–‡ä»¶\n\nè¯·åœ¨æ­¤æ·»åŠ å®é™…å†…å®¹\n\nåˆ›å»ºæ—¶é—´: {datetime.now()}"
                            file_path.write_text(content, encoding='utf-8')
                        else:
                            # åˆ›å»ºç©ºæ–‡ä»¶
                            file_path.touch()
                        print(f"  ğŸ“„ åˆ›å»º: {file_path.relative_to(self.training_dir)}")
    
    def _create_training_plan(self):
        """åˆ›å»ºåŸ¹è®­è®¡åˆ’"""
        plan_content = f"""# Odoo 19å¾®ä¿¡æ”¯ä»˜é¡¹ç›®åŸ¹è®­è®¡åˆ’

## åŸ¹è®­æ¦‚è¿°

### åŸ¹è®­ç›®æ ‡
é€šè¿‡æœ¬æ¬¡åŸ¹è®­ï¼Œå­¦å‘˜èƒ½å¤Ÿï¼š
1. ç†è§£Odoo 19å¾®ä¿¡æ”¯ä»˜é¡¹ç›®çš„æ•´ä½“æ¶æ„å’ŒåŠŸèƒ½
2. æŒæ¡ç³»ç»Ÿçš„å®‰è£…ã€é…ç½®å’Œéƒ¨ç½²æ–¹æ³•
3. ç†Ÿç»ƒæ“ä½œå„ä¸ªåŠŸèƒ½æ¨¡å—
4. èƒ½å¤Ÿè¿›è¡Œæ—¥å¸¸ç»´æŠ¤å’Œæ•…éšœæ’é™¤
5. äº†è§£å®‰å…¨åˆè§„è¦æ±‚

### åŸ¹è®­å¯¹è±¡
1. **ç³»ç»Ÿç®¡ç†å‘˜**ï¼šè´Ÿè´£ç³»ç»Ÿéƒ¨ç½²å’Œç»´æŠ¤
2. **æ”¯ä»˜ç®¡ç†å‘˜**ï¼šè´Ÿè´£æ”¯ä»˜æ¸ é“é…ç½®å’Œç®¡ç†
3. **è¿è¥äººå‘˜**ï¼šè´Ÿè´£å…¬ä¼—å·å’Œå°ç¨‹åºè¿è¥
4. **æ”¶é“¶å‘˜**ï¼šè´Ÿè´£POSæ”¶é“¶æ“ä½œ
5. **æŠ€æœ¯æ”¯æŒ**ï¼šè´Ÿè´£ç”¨æˆ·æ”¯æŒå’ŒæŠ€æœ¯ç»´æŠ¤

### åŸ¹è®­æ—¶é•¿
- æ€»æ—¶é•¿ï¼š24å°æ—¶ï¼ˆ3å¤©ï¼‰
- ç†è®ºæˆè¯¾ï¼š12å°æ—¶
- å®è·µæ“ä½œï¼š10å°æ—¶
- è€ƒæ ¸è¯„ä¼°ï¼š2å°æ—¶

## åŸ¹è®­æ—¥ç¨‹

### ç¬¬ä¸€å¤©ï¼šç³»ç»Ÿæ¦‚è¿°ä¸å®‰è£…éƒ¨ç½²

#### ä¸Šåˆï¼šç†è®ºåŸ¹è®­ï¼ˆ3å°æ—¶ï¼‰
**æ—¶é—´**ï¼š9:00-12:00
**ä¸»é¢˜**ï¼šç³»ç»Ÿæ¦‚è¿°ä¸ç¯å¢ƒå‡†å¤‡
**å†…å®¹**ï¼š
1. é¡¹ç›®èƒŒæ™¯å’Œä¸šåŠ¡ä»·å€¼ï¼ˆ30åˆ†é’Ÿï¼‰
2. ç³»ç»Ÿæ¶æ„å’ŒæŠ€æœ¯æ ˆï¼ˆ45åˆ†é’Ÿï¼‰
3. åŠŸèƒ½æ¨¡å—ä»‹ç»ï¼ˆ45åˆ†é’Ÿï¼‰
4. ç¯å¢ƒè¦æ±‚å’Œå‡†å¤‡å·¥ä½œï¼ˆ60åˆ†é’Ÿï¼‰

**è®²å¸ˆ**ï¼šæŠ€æœ¯æ¶æ„å¸ˆ
**ææ–™**ï¼šç³»ç»Ÿæ¦‚è¿°è¯¾ä»¶ã€ç¯å¢ƒæ£€æŸ¥æ¸…å•

#### ä¸‹åˆï¼šå®è·µæ“ä½œï¼ˆ3å°æ—¶ï¼‰
**æ—¶é—´**ï¼š13:30-16:30
**ä¸»é¢˜**ï¼šç³»ç»Ÿå®‰è£…ä¸é…ç½®
**å†…å®¹**ï¼š
1. Dockerç¯å¢ƒéƒ¨ç½²ï¼ˆ60åˆ†é’Ÿï¼‰
2. æ¨¡å—å®‰è£…å’Œåˆå§‹åŒ–ï¼ˆ60åˆ†é’Ÿï¼‰
3. åŸºç¡€é…ç½®æ¼”ç¤ºï¼ˆ60åˆ†é’Ÿï¼‰

**è®²å¸ˆ**ï¼šå®æ–½å·¥ç¨‹å¸ˆ
**ææ–™**ï¼šå®‰è£…éƒ¨ç½²è¯¾ä»¶ã€æ“ä½œæ‰‹å†Œã€ç»ƒä¹ ç¯å¢ƒ

#### æ™šä¸Šï¼šè‡ªä¸»ç»ƒä¹ ï¼ˆ2å°æ—¶ï¼‰
**æ—¶é—´**ï¼š19:00-21:00
**ä¸»é¢˜**ï¼šå®‰è£…ç»ƒä¹ 
**å†…å®¹**ï¼š
1. ç‹¬ç«‹å®Œæˆç¯å¢ƒå‡†å¤‡
2. å®Œæˆç³»ç»Ÿå®‰è£…
3. è§£å†³å®‰è£…ä¸­çš„é—®é¢˜

**æŒ‡å¯¼**ï¼šåŠ©æ•™åœ¨çº¿æ”¯æŒ
**ææ–™**ï¼šç»ƒä¹ ä»»åŠ¡æ¸…å•ã€å¸¸è§é—®é¢˜è§£ç­”

### ç¬¬äºŒå¤©ï¼šåŠŸèƒ½é…ç½®ä¸æ“ä½œåŸ¹è®­

#### ä¸Šåˆï¼šç†è®ºåŸ¹è®­ï¼ˆ3å°æ—¶ï¼‰
**æ—¶é—´**ï¼š9:00-12:00
**ä¸»é¢˜**ï¼šæ”¯ä»˜åŠŸèƒ½é…ç½®
**å†…å®¹**ï¼š
1. å¾®ä¿¡æ”¯ä»˜é…ç½®è¯¦è§£ï¼ˆ60åˆ†é’Ÿï¼‰
2. æ”¯ä»˜å®é…ç½®è¯¦è§£ï¼ˆ60åˆ†é’Ÿï¼‰
3. æ”¯ä»˜å®‰å…¨å’Œåˆè§„è¦æ±‚ï¼ˆ60åˆ†é’Ÿï¼‰

**è®²å¸ˆ**ï¼šæ”¯ä»˜ä¸“å®¶
**ææ–™**ï¼šé…ç½®æŒ‡å—è¯¾ä»¶ã€APIæ–‡æ¡£

#### ä¸‹åˆï¼šå®è·µæ“ä½œï¼ˆ3å°æ—¶ï¼‰
**æ—¶é—´**ï¼š13:30-16:30
**ä¸»é¢˜**ï¼šç³»ç»Ÿæ“ä½œåŸ¹è®­
**å†…å®¹**ï¼š
1. æ”¯ä»˜æ“ä½œå®è·µï¼ˆ60åˆ†é’Ÿï¼‰
2. POSæ”¶é“¶æ“ä½œï¼ˆ60åˆ†é’Ÿï¼‰
3. å…¬ä¼—å·ç®¡ç†æ“ä½œï¼ˆ60åˆ†é’Ÿï¼‰

**è®²å¸ˆ**ï¼šäº§å“ä¸“å®¶
**ææ–™**ï¼šæ“ä½œåŸ¹è®­è¯¾ä»¶ã€æ“ä½œæ‰‹å†Œ

#### æ™šä¸Šï¼šè‡ªä¸»ç»ƒä¹ ï¼ˆ2å°æ—¶ï¼‰
**æ—¶é—´**ï¼š19:00-21:00
**ä¸»é¢˜**ï¼šé…ç½®å’Œæ“ä½œç»ƒä¹ 
**å†…å®¹**ï¼š
1. å®Œæˆæ”¯ä»˜æ¸ é“é…ç½®
2. æ¨¡æ‹Ÿå„ç§æ”¯ä»˜åœºæ™¯
3. ç»ƒä¹ å…¬ä¼—å·ç®¡ç†åŠŸèƒ½

**æŒ‡å¯¼**ï¼šåŠ©æ•™åœ¨çº¿æ”¯æŒ
**ææ–™**ï¼šç»ƒä¹ æ•°æ®ã€æ“ä½œæŒ‡å—

### ç¬¬ä¸‰å¤©ï¼šæ•…éšœæ’é™¤ä¸ç»¼åˆè€ƒæ ¸

#### ä¸Šåˆï¼šç†è®ºåŸ¹è®­ï¼ˆ3å°æ—¶ï¼‰
**æ—¶é—´**ï¼š9:00-12:00
**ä¸»é¢˜**ï¼šç»´æŠ¤ä¸æ•…éšœæ’é™¤
**å†…å®¹**ï¼š
1. ç³»ç»Ÿç›‘æ§å’Œç»´æŠ¤ï¼ˆ60åˆ†é’Ÿï¼‰
2. å¸¸è§æ•…éšœæ’é™¤ï¼ˆ60åˆ†é’Ÿï¼‰
3. å¤‡ä»½æ¢å¤ç­–ç•¥ï¼ˆ60åˆ†é’Ÿï¼‰

**è®²å¸ˆ**ï¼šè¿ç»´ä¸“å®¶
**ææ–™**ï¼šæ•…éšœæ’é™¤è¯¾ä»¶ã€è¿ç»´æ‰‹å†Œ

#### ä¸‹åˆï¼šç»¼åˆå®è·µï¼ˆ2å°æ—¶ï¼‰
**æ—¶é—´**ï¼š13:30-15:30
**ä¸»é¢˜**ï¼šç»¼åˆåœºæ™¯æ¼”ç»ƒ
**å†…å®¹**ï¼š
1. éƒ¨ç½²å®Œæ•´çš„æµ‹è¯•ç¯å¢ƒ
2. æ¨¡æ‹ŸçœŸå®ä¸šåŠ¡åœºæ™¯
3. è§£å†³é¢„è®¾çš„æŠ€æœ¯é—®é¢˜

**æŒ‡å¯¼**ï¼šå®æ–½å·¥ç¨‹å¸ˆå›¢é˜Ÿ
**ææ–™**ï¼šç»¼åˆç»ƒä¹ ä»»åŠ¡ã€æµ‹è¯•ç¯å¢ƒ

#### ä¸‹åˆï¼šè€ƒæ ¸è¯„ä¼°ï¼ˆ2å°æ—¶ï¼‰
**æ—¶é—´**ï¼š15:30-17:30
**ä¸»é¢˜**ï¼šåŸ¹è®­è€ƒæ ¸
**å†…å®¹**ï¼š
1. ç†è®ºçŸ¥è¯†æµ‹è¯•ï¼ˆ30åˆ†é’Ÿï¼‰
2. æ“ä½œæŠ€èƒ½è€ƒæ ¸ï¼ˆ60åˆ†é’Ÿï¼‰
3. åŸ¹è®­åé¦ˆæ”¶é›†ï¼ˆ30åˆ†é’Ÿï¼‰

**è¯„ä¼°**ï¼šåŸ¹è®­è®²å¸ˆå›¢é˜Ÿ
**ææ–™**ï¼šæµ‹è¯•é¢˜ã€è€ƒæ ¸è¡¨ã€åé¦ˆé—®å·

## åŸ¹è®­ææ–™

### è¯¾ä»¶ææ–™
1. **ç³»ç»Ÿæ¦‚è¿°è¯¾ä»¶**ï¼šé¡¹ç›®èƒŒæ™¯ã€æ¶æ„ã€åŠŸèƒ½
2. **å®‰è£…éƒ¨ç½²è¯¾ä»¶**ï¼šç¯å¢ƒå‡†å¤‡ã€å®‰è£…æ­¥éª¤
3. **é…ç½®æŒ‡å—è¯¾ä»¶**ï¼šæ”¯ä»˜é…ç½®ã€ç³»ç»Ÿé…ç½®
4. **æ“ä½œåŸ¹è®­è¯¾ä»¶**ï¼šå„æ¨¡å—æ“ä½œæŒ‡å—
5. **æ•…éšœæ’é™¤è¯¾ä»¶**ï¼šå¸¸è§é—®é¢˜è§£å†³æ–¹æ³•
6. **å®‰å…¨åˆè§„è¯¾ä»¶**ï¼šå®‰å…¨è¦æ±‚å’Œåˆè§„æ ‡å‡†

### æ“ä½œæ‰‹å†Œ
1. **ç³»ç»Ÿç®¡ç†å‘˜æ‰‹å†Œ**ï¼šå®‰è£…ã€é…ç½®ã€ç»´æŠ¤
2. **ç»ˆç«¯ç”¨æˆ·æ“ä½œæŒ‡å—**ï¼šæ—¥å¸¸æ“ä½œæŒ‡å—
3. **POSæ”¶é“¶å‘˜æ‰‹å†Œ**ï¼šæ”¶é“¶æ“ä½œæŒ‡å—
4. **å°ç¨‹åºä½¿ç”¨è¯´æ˜**ï¼šå°ç¨‹åºæ“ä½œæŒ‡å—

### è§†é¢‘æ•™ç¨‹
1. **å®‰è£…éƒ¨ç½²ç³»åˆ—**ï¼šç¯å¢ƒå‡†å¤‡åˆ°ç³»ç»Ÿå®‰è£…
2. **é…ç½®æŒ‡å—ç³»åˆ—**ï¼šå„é¡¹åŠŸèƒ½é…ç½®
3. **æ“ä½œåŸ¹è®­ç³»åˆ—**ï¼šå®é™…æ“ä½œæ¼”ç¤º
4. **æ•…éšœæ’é™¤ç³»åˆ—**ï¼šé—®é¢˜è§£å†³æ–¹æ³•

### ç»ƒä¹ ææ–™
1. **ç»ƒä¹ ç¯å¢ƒ**ï¼šç‹¬ç«‹çš„ç»ƒä¹ ç¯å¢ƒ
2. **ç»ƒä¹ ä»»åŠ¡**ï¼šåˆ†é˜¶æ®µçš„ç»ƒä¹ ä»»åŠ¡
3. **ç»ƒä¹ æ•°æ®**ï¼šæµ‹è¯•æ•°æ®å’Œåœºæ™¯
4. **ç»ƒä¹ ç­”æ¡ˆ**ï¼šç»ƒä¹ ä»»åŠ¡çš„å‚è€ƒç­”æ¡ˆ

### è¯„ä¼°ææ–™
1. **ç†è®ºçŸ¥è¯†æµ‹è¯•é¢˜**ï¼šé€‰æ‹©é¢˜ã€åˆ¤æ–­é¢˜ã€é—®ç­”é¢˜
2. **æ“ä½œæŠ€èƒ½è€ƒæ ¸è¡¨**ï¼šæ“ä½œæ­¥éª¤è¯„åˆ†è¡¨
3. **åŸ¹è®­åé¦ˆé—®å·**ï¼šåŸ¹è®­æ•ˆæœåé¦ˆ
4. **åŸ¹è®­è¯ä¹¦æ¨¡æ¿**ï¼šåŸ¹è®­å®Œæˆè¯ä¹¦

## åŸ¹è®­ç¯å¢ƒ

### ç¡¬ä»¶è¦æ±‚
1. **è®²å¸ˆç¯å¢ƒ**
   - æŠ•å½±è®¾å¤‡
   - æ¼”ç¤ºç”µè„‘
   - ç½‘ç»œè¿æ¥

2. **å­¦å‘˜ç¯å¢ƒ**
   - ä¸ªäººç”µè„‘ï¼ˆWindows/Mac/Linuxï¼‰
   - 8GB+å†…å­˜
   - 100GB+ç¡¬ç›˜ç©ºé—´
   - ç½‘ç»œè¿æ¥

### è½¯ä»¶è¦æ±‚
1. **åŸºç¡€è½¯ä»¶**
   - Docker Desktop
   - Gitå®¢æˆ·ç«¯
   - ä»£ç ç¼–è¾‘å™¨ï¼ˆVS Codeç­‰ï¼‰
   - åŠå…¬è½¯ä»¶ï¼ˆOffice/WPSï¼‰

2. **ç»ƒä¹ ç¯å¢ƒ**
   - é¢„é…ç½®çš„è™šæ‹Ÿæœºé•œåƒ
   - æœ¬åœ°Dockerç¯å¢ƒ
   - åœ¨çº¿ç»ƒä¹ å¹³å°ï¼ˆå¯é€‰ï¼‰

### ç½‘ç»œè¦æ±‚
1. ç¨³å®šçš„äº’è”ç½‘è¿æ¥
2. è®¿é—®GitHubç­‰ä»£ç ä»“åº“
3. è®¿é—®Docker Hub
4. å¾®ä¿¡/æ”¯ä»˜å®æµ‹è¯•ç¯å¢ƒè®¿é—®

## è®²å¸ˆå›¢é˜Ÿ

### æ ¸å¿ƒè®²å¸ˆ
| è§’è‰² | å§“å | ä¸“é•¿ | è”ç³»æ–¹å¼ |
|------|------|------|----------|
| æŠ€æœ¯æ¶æ„å¸ˆ | å¼ ä¸‰ | ç³»ç»Ÿæ¶æ„ã€æŠ€æœ¯æ–¹æ¡ˆ | zhangsan@example.com |
| æ”¯ä»˜ä¸“å®¶ | æå›› | æ”¯ä»˜ç³»ç»Ÿã€å®‰å…¨åˆè§„ | lisi@example.com |
| äº§å“ä¸“å®¶ | ç‹äº” | äº§å“åŠŸèƒ½ã€ç”¨æˆ·ä½“éªŒ | wangwu@example.com |
| è¿ç»´ä¸“å®¶ | èµµå…­ | ç³»ç»Ÿè¿ç»´ã€æ•…éšœæ’é™¤ | zhaoliu@example.com |

### åŠ©æ•™å›¢é˜Ÿ
| è§’è‰² | äººæ•° | èŒè´£ |
|------|------|------|
| æŠ€æœ¯åŠ©æ•™ | 2 | ç¯å¢ƒå‡†å¤‡ã€æŠ€æœ¯é—®é¢˜è§£ç­” |
| æ“ä½œåŠ©æ•™ | 2 | æ“ä½œæŒ‡å¯¼ã€ç»ƒä¹ è¾…å¯¼ |
| åå‹¤æ”¯æŒ | 1 | ææ–™å‡†å¤‡ã€åœºåœ°ç®¡ç† |

## åŸ¹è®­è¯„ä¼°

### è¯„ä¼°æ ‡å‡†
1. **ç†è®ºçŸ¥è¯†æŒæ¡**ï¼ˆ40%ï¼‰
   - ç³»ç»Ÿæ¶æ„ç†è§£
   - åŠŸèƒ½æ¨¡å—è®¤è¯†
   - é…ç½®åŸç†æŒæ¡

2. **æ“ä½œæŠ€èƒ½æŒæ¡**ï¼ˆ40%ï¼‰
   - å®‰è£…éƒ¨ç½²èƒ½åŠ›
   - é…ç½®æ“ä½œèƒ½åŠ›
   - æ•…éšœæ’é™¤èƒ½åŠ›

3. **å­¦ä¹ æ€åº¦**ï¼ˆ20%ï¼‰
   - è¯¾å ‚å‚ä¸åº¦
   - ç»ƒä¹ å®Œæˆåº¦
   - é—®é¢˜è§£å†³èƒ½åŠ›

### è¯„ä¼°æ–¹å¼
1. **ç†è®ºçŸ¥è¯†æµ‹è¯•**ï¼šé—­å·è€ƒè¯•ï¼Œæ»¡åˆ†100åˆ†ï¼Œ60åˆ†åˆæ ¼
2. **æ“ä½œæŠ€èƒ½è€ƒæ ¸**ï¼šå®é™…æ“ä½œè¯„ä¼°ï¼ŒæŒ‰è¯„åˆ†è¡¨æ‰“åˆ†
3. **ç»¼åˆè¡¨ç°è¯„ä»·**ï¼šè®²å¸ˆæ ¹æ®å­¦ä¹ è¡¨ç°è¯„ä»·

### è¯ä¹¦é¢å‘
1. **åˆæ ¼æ ‡å‡†**ï¼šç†è®ºçŸ¥è¯†60åˆ†ä»¥ä¸Šï¼Œæ“ä½œæŠ€èƒ½è€ƒæ ¸é€šè¿‡
2. **è¯ä¹¦ç±»å‹**ï¼š
   - ä¼˜ç§€è¯ä¹¦ï¼š90åˆ†ä»¥ä¸Š
   - åˆæ ¼è¯ä¹¦ï¼š60-89åˆ†
   - å‚ä¸è¯æ˜ï¼š60åˆ†ä»¥ä¸‹ä½†å…¨ç¨‹å‚ä¸

## åŸ¹è®­æ”¯æŒ

### åŸ¹è®­å‰æ”¯æŒ
1. **ç¯å¢ƒå‡†å¤‡æŒ‡å¯¼**ï¼šæå‰ä¸€å‘¨æä¾›ç¯å¢ƒå‡†å¤‡æŒ‡å—
2. **ææ–™é¢„è¯»**ï¼šæå‰å‘é€åŸ¹è®­ææ–™ä¾›é¢„è¯»
3. **é—®é¢˜æ”¶é›†**ï¼šæ”¶é›†å­¦å‘˜çš„é¢„åŸ¹è®­é—®é¢˜

### åŸ¹è®­ä¸­æ”¯æŒ
1. **ç°åœºæŠ€æœ¯æ”¯æŒ**ï¼šåŠ©æ•™å›¢é˜Ÿç°åœºæ”¯æŒ
2. **åœ¨çº¿é—®ç­”å¹³å°**ï¼šå»ºç«‹åŸ¹è®­ç¾¤ç»„å®æ—¶é—®ç­”
3. **ç»ƒä¹ ç¯å¢ƒæ”¯æŒ**ï¼šæä¾›ç¨³å®šçš„ç»ƒä¹ ç¯å¢ƒ

### åŸ¹è®­åæ”¯æŒ
1. **ææ–™æä¾›**ï¼šæä¾›å®Œæ•´çš„åŸ¹è®­ææ–™åŒ…
2. **é—®é¢˜è§£ç­”**ï¼šåŸ¹è®­åä¸€ä¸ªæœˆå†…é—®é¢˜è§£ç­”
3. **æŒç»­å­¦ä¹ **ï¼šæä¾›è¿›é˜¶å­¦ä¹ èµ„æº

## åŸ¹è®­åé¦ˆ

### åé¦ˆæ”¶é›†
1. **æ¯æ—¥åé¦ˆ**ï¼šæ¯å¤©ç»“æŸæ”¶é›†å½“æ—¥åé¦ˆ
2. **æ€»ä½“åé¦ˆ**ï¼šåŸ¹è®­ç»“æŸæ”¶é›†æ€»ä½“åé¦ˆ
3. **æ•ˆæœè¯„ä¼°**ï¼šåŸ¹è®­åä¸€ä¸ªæœˆæ•ˆæœè¯„ä¼°

### æ”¹è¿›æœºåˆ¶
1. **å³æ—¶æ”¹è¿›**ï¼šæ ¹æ®æ¯æ—¥åé¦ˆè°ƒæ•´åç»­åŸ¹è®­
2. **æŒç»­ä¼˜åŒ–**ï¼šæ¯æœŸåŸ¹è®­åä¼˜åŒ–åŸ¹è®­æ–¹æ¡ˆ
3. **ç‰ˆæœ¬æ›´æ–°**ï¼šç³»ç»Ÿæ›´æ–°æ—¶åŒæ­¥æ›´æ–°åŸ¹è®­ææ–™

## é™„å½•

### åŸ¹è®­æ£€æŸ¥æ¸…å•
1. [åŸ¹è®­å‰æ£€æŸ¥æ¸…å•](checklists/pre_training_checklist.md)
2. [åŸ¹è®­ä¸­æ£€æŸ¥æ¸…å•](checklists/training_checklist.md)
3. [åŸ¹è®­åæ£€æŸ¥æ¸…å•](checklists/post_training_checklist.md)

### è”ç³»ä¿¡æ¯
- åŸ¹è®­è´Ÿè´£äººï¼štraining@example.com
- æŠ€æœ¯æ”¯æŒï¼šsupport@example.com
- ç´§æ€¥è”ç³»ï¼š400-XXX-XXXX

### ç‰ˆæœ¬ä¿¡æ¯
- åŸ¹è®­è®¡åˆ’ç‰ˆæœ¬ï¼šv1.0
- æœ€åæ›´æ–°ï¼š{datetime.now().strftime('%Y-%m-%d')}
- é€‚ç”¨ç³»ç»Ÿç‰ˆæœ¬ï¼šOdoo 19å¾®ä¿¡æ”¯ä»˜ v1.0

---

*æœ¬åŸ¹è®­è®¡åˆ’å°†æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œè°ƒæ•´å’Œä¼˜åŒ–ã€‚*
"""
        
        plan_path = self.training_dir / "åŸ¹è®­è®¡åˆ’.md"
        plan_path.write_text(plan_content, encoding='utf-8')
        print(f"  ğŸ“… åˆ›å»ºåŸ¹è®­è®¡åˆ’")
    
    def _create_instructor_guide(self):
        """åˆ›å»ºè®²å¸ˆæŒ‡å—"""
        guide_content = f"""# è®²å¸ˆæŒ‡å—

## è®²å¸ˆå‡†å¤‡å·¥ä½œ

### è¯¾å‰å‡†å¤‡
1. **ç†Ÿæ‚‰ææ–™**ï¼šæå‰ç†Ÿæ‚‰æ‰€æœ‰åŸ¹è®­ææ–™
2. **ç¯å¢ƒæµ‹è¯•**ï¼šæµ‹è¯•æ¼”ç¤ºç¯å¢ƒå’Œç»ƒä¹ ç¯å¢ƒ
3. **è®¾å¤‡æ£€æŸ¥**ï¼šæ£€æŸ¥æŠ•å½±ã€éŸ³å“ç­‰è®¾å¤‡
4. **ææ–™å‡†å¤‡**ï¼šå‡†å¤‡æ‰€æœ‰è¯¾ä»¶å’Œææ–™
5. **å­¦å‘˜äº†è§£**ï¼šäº†è§£å­¦å‘˜èƒŒæ™¯å’ŒåŸºç¡€

### æ•™å­¦è®¾å¤‡
1. ç¬”è®°æœ¬ç”µè„‘ï¼ˆå®‰è£…æ‰€æœ‰å¿…è¦è½¯ä»¶ï¼‰
2. æŠ•å½±ä»ªå’Œè¿æ¥çº¿
3. éº¦å…‹é£å’ŒéŸ³å“
4. ç™½æ¿å’Œè®°å·ç¬”
5. è®¡æ—¶å™¨æˆ–æ‰‹è¡¨

### è½¯ä»¶ç¯å¢ƒ
1. Docker Desktop å·²å®‰è£…å¹¶è¿è¡Œ
2. æ¼”ç¤ºç¯å¢ƒå·²å‡†å¤‡å°±ç»ª
3. è¯¾ä»¶å’Œæ¼”ç¤ºææ–™å·²æ‰“å¼€
4. ç»ƒä¹ ç¯å¢ƒå¯è®¿é—®
5. ç½‘ç»œè¿æ¥ç¨³å®š

## æ•™å­¦è¦ç‚¹

### ç¬¬ä¸€å¤©ï¼šç³»ç»Ÿæ¦‚è¿°ä¸å®‰è£…éƒ¨ç½²

#### ä¸Šåˆï¼šç³»ç»Ÿæ¦‚è¿°ï¼ˆ3å°æ—¶ï¼‰
**é‡ç‚¹éš¾ç‚¹**ï¼š
1. ç³»ç»Ÿæ¶æ„çš„ç†è§£
2. å„æ¨¡å—åŠŸèƒ½çš„å…³è”
3. ç¯å¢ƒè¦æ±‚çš„ç»†èŠ‚

**æ•™å­¦æ–¹æ³•**ï¼š
1. ä½¿ç”¨æ¶æ„å›¾è®²è§£
2. ç»“åˆæ¡ˆä¾‹è¯´æ˜
3. äº’åŠ¨æé—®ç¡®ä¿ç†è§£

**æ—¶é—´åˆ†é…**ï¼š
- 9:00-9:30
